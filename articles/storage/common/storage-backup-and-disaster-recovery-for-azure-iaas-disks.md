---
title: "Azure IaaS ディスクのバックアップとディザスター リカバリー | Microsoft Docs"
description: "この記事では、Azure の IaaS 仮想マシン (VM) とディスクのバックアップおよびディザスター リカバリー (DR) を計画する方法について説明します。 このドキュメントでは、管理ディスクと非管理対象ディスクの両方について説明しています"
services: storage
cloud: Azure
documentationcenter: na
author: luywang
manager: kavithag
ms.assetid: 
ms.service: storage
ms.workload: storage
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/19/2017
ms.author: luywang
ms.translationtype: HT
ms.sourcegitcommit: cf381b43b174a104e5709ff7ce27d248a0dfdbea
ms.openlocfilehash: 03d38bc3383b5fd39eca5ca67c315b34b98f0c39
ms.contentlocale: ja-jp
ms.lasthandoff: 08/23/2017

---
# <a name="backup-and-disaster-recovery-for-azure-iaas-disks"></a>Azure IaaS ディスクのバックアップとディザスター リカバリー

この記事では、Azure の IaaS 仮想マシン (VM) とディスクのバックアップおよびディザスター リカバリー (DR) を計画する方法について説明します。 このドキュメントでは、管理ディスクと非管理対象ディスクの両方について説明しています。

最初に Azure プラットフォームに組み込まれているフォールト トレランス機能について説明します。この機能は、局所的な障害に対する保護となります。 次に、組み込みの機能では完全にはカバーされない障害のシナリオについて説明します。これは、このドキュメントで扱うメイン トピックです。 また、別のバックアップと DR の考慮事項が適用されるワークロード シナリオの例を複数紹介します。 そして、IaaS のディスクの DR に対して考えられる解決策を検討します。 

## <a name="introduction"></a>はじめに

Azure プラットフォームでは、発生する可能性のある局所的なハードウェア障害からお客様を保護するために、冗長性とフォールト トレランスに関するさまざまなメソッドが使用されています。 局所的な障害には、仮想ディスクのデータの一部を格納する Azure Storage サーバー マシンに関する問題や、これらのサーバー上の SSD または HDD の障害などが含まれます。 このような孤立したハードウェア コンポーネントの障害は通常の操作中に発生する可能性があり、このプラットフォームはこのような障害から復旧するように設計されています。 大規模災害によって、多数のストレージ サーバーまたはデータ センター全体に障害が発生する可能性や、それらにアクセスできなくなる可能性があります。 VM とディスクは通常、局所的な障害からは保護されていますが、VM とディスクに影響を与える可能性のある、地域全体にわたる致命的な障害 (大規模災害など) からワークロードを保護するためには、追加の手順が必要になります。

プラットフォームに障害が発生する可能性だけでなく、お客様のアプリケーションやデータに問題が発生する場合もあります。 たとえば、アプリケーションのバージョンを新しくしたことで、意図せずにデータに重大な変更が加えられるかもしれません。 その場合は、古いバージョンのうち、正常な状態であることが分かっている最新のバージョンに、アプリケーションやデータを戻したいと思うでしょう。 これには、定期的なバックアップを継続する必要があります。

リージョンのディザスター リカバリーについては、IaaS VM ディスクを別のリージョンにバックアップする必要があります。 

バックアップと DR のオプションについて考える前に、局所的な障害の処理に使用できるいくつかの方法を要約します。

### <a name="azure-iaas-resiliency"></a>Azure IaaS 回復性

*回復性*とは、ハードウェア コンポーネントで発生する通常の障害の許容範囲のことです。 回復性は、障害から回復して、機能を継続する能力です。 障害を回避することではなく、ダウンタイムまたはデータの損失を回避するように障害に対応することです。 回復性の目的は、障害後にアプリケーションを完全に機能している状態に戻すことです。 Azure Virtual Machines とディスクは、一般的なハードウェア障害から復旧するように設計されています。 Azure IaaS プラットフォームがどのようにこの回復性を提供するのか見てみましょう。

仮想マシンは、主に (1) コンピューティング サーバー、(2) 永続的なディスクの 2 つの部分で構成されています。 その両方が、仮想マシンのフォールト トレランスに影響します。

VM を格納する Azure のコンピューティング ホスト サーバーで、ハードウェア障害が発生する場合 (まれですが)、Azure が別のサーバー上で VM を自動的に復元するように設計されています。 この場合は、再起動が行われ、しばらくしてから VM のバックアップが取得されます。 Azure はこのようなハードウェア障害を自動的に検出して復旧し、VM をできるだけ早く使用可能にすることをお客様に保証します。

IaaS のディスクに関していえば、データの持続性は、永続的なストレージ プラットフォームにとって重要です。 Azure のお客様は、重要なビジネス アプリケーションを IaaS で実行し、データの持続性に依存しています。 Azure は、ローカルに格納されているデータの冗長コピーを 3 つ保持することで、IaaS ディスクを保護するように設計されており、それによって局所的な障害に対する高い持続性を提供しています。 ディスクを保持するハードウェア コンポーネントの 1 つが故障しても、ディスクの要求をサポートする別のコピーが 2 つあるため、VM は影響を受けません。 ディスクをサポートする別のハードウェア コンポーネントが 2 つ同時に故障した場合 (非常にまれ) でも、正常に動作します。 常に 3 つのレプリカを維持できるように、Azure Storage サービスでは、3 つのコピーのいずれかが使用できなくなった場合でも、データの新しいコピーをバック グラウンドで自動的に生成します。 そのため、フォールト トレランス用に Azure ディスクで RAID を使用する必要はありません。 大規模なボリュームの作成が必要な場合、ディスクのストライピングには、単純な RAID 0 構成で十分です。

このアーキテクチャにより、**Azure は IaaS ディスクのエンタープライズ レベルの持続性を、業界トップ レベルの[年間故障率 ](https://en.wikipedia.org/wiki/Annualized_failure_rate) 0% で一貫して提供できます。**

コンピューティング ホストまたはストレージ プラットフォームの局所的なハードウェア障害によって、VM の可用性に関する [Azure SLA](https://azure.microsoft.com/support/legal/sla/virtual-machines/) で保証対象となっている VM が一時的に使用できなくなる場合があります。 Azure では、Premium Storage のディスクを使用する単一の VM インスタンスを対象とする、業界トップ レベルの SLA も提供されています。

ディスクまたは VM が一時的に使用できないことによるダウンタイムからアプリケーション ワークロードを保護するために、お客様は[可用性セット](../../virtual-machines/windows/manage-availability.md) を活用できます。 可用性セット内にある複数の仮想マシンによって、アプリケーションの冗長性が確保されます。 Azure では、異なる電源、ネットワーク、サーバー コンポーネントを使用する別々の障害ドメインに、これらの VM とディスクが作成されます。 したがって、局所的なハードウェア障害は通常、セット内の複数の VM に同時に影響することはありません。そのため、アプリケーションの高可用性が実現します。 高可用性が要求される場合に、可用性セットを使用することは優れた選択であると考えられます。 詳細については、次に説明するディザスター リカバリーについてご確認ください。

### <a name="backup-and-disaster-recovery"></a>バックアップとディザスター リカバリー

ディザスター リカバリー (DR) は、まれに発生する大きなインシデント、すなわち地域全体に影響するサービス中断のように、一時的なものではない大規模な障害から回復する能力です。 ディザスター リカバリーには、データ バックアップやアーカイブの他に、バックアップからのデータベースの復元などの手動操作も含まれる場合があります。

局所的な障害に対する Azure プラットフォーム組み込みの保護機能は、大規模な障害が発生する可能性がある大きな災害の場合には、VM/ディスクを完全に保護できない場合があります。 これには、データ センターがハリケーン、地震、火災、または大規模なハードウェア ユニットの障害に襲われるような大惨事が含まれます。 さらに、アプリケーションやデータの問題による障害が発生する可能性もあります。

IaaS ワークロードを障害から保護するには、回復を可能にする冗長性とバックアップの計画を立てる必要があります。 ディザスター リカバリーのためには、プライマリ サイトから地理的に離れた別の場所で、冗長性を確保し、バックアップをとる計画を立てる必要があります。 これにより、VM またはディスクに最初に影響したものと同じ出来事がバックアップに影響することはなくなります。 詳細については、[Azure 上に構築されたアプリケーションのディザスター リカバリー](https://docs.microsoft.com/azure/architecture/resiliency/disaster-recovery-azure-applications)に関するページをご覧ください。

DR の考慮事項には、次の側面が含まれます。

1. 高可用性 (HA) は、大幅なダウンタイムなしに、正常な状態で実行を継続するアプリケーションの能力です。 "正常な状態" とは、アプリケーションが応答し、ユーザーがアプリケーションに接続して対話できるという意味です。 特定のミッション クリティカルなアプリケーションとデータベースは、プラットフォームに障害が発生した場合でも、常に使用可能であることが求められます。 これらのワークロードについては、データだけでなく、アプリケーションの冗長性を計画する必要があります。

2. データの持続性: 主な検討事項が、災害時にも確実にデータを保持することである場合もあります。 そのため、別のサイトでデータをバックアップする必要があるかもしれません。 このようなワークロードの場合、アプリケーションの完全な冗長性は必要ありませんが、ディスクの定期的なバックアップが必要となります。

## <a name="backup-and-dr-scenarios"></a>バックアップと DR シナリオ

アプリケーション ワークロードのシナリオの一般的ないくつかの例と、ディザスター リカバリー計画に関する検討事項について考えてみましょう。

### <a name="scenario-1-major-database-solutions"></a>シナリオ 1: 大規模なデータベースのソリューション

高可用性をサポートできる SQL Server または Oracle のような実稼働データベース サーバーについて考えてみます。 重要な実稼働アプリケーションとユーザーは、このデータベースに依存しています。 このシステムのディザスター リカバリー計画は、次の要件をサポートする必要があります。

1. データは保護され、かつ回復可能である必要があります。
2.  サーバーは使用可能である必要があります。

このためには、異なるリージョンにバックアップとしてデータベースのレプリカを維持する必要があります。 サーバーの可用性とデータ復旧の要件によっては、アクティブ/アクティブ レプリカ サイトまたはアクティブ/パッシブ レプリカ サイトから、データの定期的なオフライン バックアップまでに及ぶソリューションが考えられます。 SQL Server、Oracle などのリレーショナル データベースでは、レプリケーションに関するさまざまなオプションが提供されています。 SQL Server では、高可用性を実現するために、[SQL Server Always On 可用性グループ](https://msdn.microsoft.com/library/hh510230.aspx)を使用できます。

MongoDB のような NoSQL データベースでは、冗長性を実現するために[レプリカ](https://docs.mongodb.com/manual/replication/) もサポートされています。 高可用性向けのレプリカが使用できます。

### <a name="scenario-2-a-cluster-of-redundant-vms"></a>シナリオ 2: 冗長 VM のクラスター

冗長性と負荷分散を提供する VM クラスターによって処理されるワークロードを検討します。 一例として、リージョンに配置された Cassandra クラスターがあります。 このタイプのアーキテクチャは、リージョン内で高レベルの冗長性を既に提供しています。 ただし、リージョン レベルの障害からワークロードを保護するには、クラスターを 2 つのリージョンに分散させるか、別のリージョンに定期的なバックアップを実行することを検討する必要があります。

### <a name="scenario-3-iaas-application-workload"></a>シナリオ 3: IaaS アプリケーション ワークロード

これは、Azure VM で実行されている一般的な実稼働ワークロードが考えられます。 たとえば、あるサイトのコンテンツと他のリソースを保持している Web サーバーまたはファイル サーバーが考えられます。 また、データ、リソース、アプリケーションのステータスなどを VM ディスクに格納し、VM 上で動作するカスタムビルドのビジネス アプリケーションかもしれません。 この場合は、定期的なバックアップを確実に行うことが重要です。 バックアップの頻度は、VM のワークロードの特性に基づいている必要があります。 たとえば、アプリケーションが毎日実行されてデータを変更している場合は、1 時間ごとにバックアップをとる必要があります。

別の例は、他のソースからデータを取得して集計レポートを生成するレポート サーバーです。 この VM やディスクが失われると、レポートが失われます。 ただし、レポートの処理を再実行し、出力を再生成できる場合があります。 その場合は、レポート サーバーが災害に遭っても、実際にはデータは失われません。したがって、レポート サーバーのデータの部分的な損失については、許容範囲が大きくなります。 その場合は、バックアップの頻度を下げることが、コスト削減の方法の 1 つになります。

### <a name="scenario-4-iaas-application-data-issues"></a>シナリオ 4: IaaS アプリケーション データの問題

価格情報などの重要な取引データを、計算し、保守し、提供するアプリケーションをお客様が使用しているとします。 新しいバージョンのアプリケーションには、価格を誤って計算するソフトウェア バグがあり、プラットフォームによって提供される既存の商用データが破損しました。 ここでの最善策は、アプリケーションとデータをまず以前のバージョンに戻すことです。 これを可能にするには、定期的にシステムのバックアップをとります。

## <a name="disaster-recovery-solution-azure-backup-service"></a>ディザスター リカバリー ソリューション: Azure Backup サービス

[Azure Backup サービス](https://azure.microsoft.com/services/backup/)はバックアップとディザスター リカバリーに使用でき、[管理ディスク](../../virtual-machines/windows/managed-disks-overview.md)や[非管理対象ディスク](../../virtual-machines/windows/about-disks-and-vhds.md#unmanaged-disks)と連携します。 時間ベースのバックアップ、VM の簡易復元、バックアップの保持ポリシーを使用して、バックアップ ジョブを作成することができます。 

[Premium Storage のディスク](storage-premium-storage.md)、[管理ディスク](../../virtual-machines/windows/managed-disks-overview.md)、またはその他のディスクの種類を、[ローカル冗長ストレージ (LRS)](storage-redundancy.md#locally-redundant-storage) オプションと共に使用する場合は、定期的な DR バックアップを利用することが特に重要です。 Azure Backup は、長期的な保有期間の Recovery Services コンテナーにデータを格納します。 Backup の Recovery Services コンテナーには、[geo 冗長ストレージ (GRS)](storage-redundancy.md#geo-redundant-storage) オプションを選択します。 これで、バックアップが別の Azure リージョンにレプリケートされ、地域的な災害から保護されます。

[非管理対象ディスク](../../virtual-machines/windows/about-disks-and-vhds.md#unmanaged-disks)については、IaaS ディスクの場合は LRS ストレージ タイプを使用できますが、Recovery Services コンテナーの場合は、Azure Backup を GRS オプションで有効にしてください。

非管理対象ディスクに対して [GRS](storage-redundancy.md#geo-redundant-storage) / [RA-GRS](storage-redundancy.md#read-access-geo-redundant-storage) オプションを**使用する場合は、バックアップと DR の整合性スナップショットが必要です。** [Azure Backup サービス](https://azure.microsoft.com/services/backup/)または[整合性スナップショット](#alternative-solution-consistent-snapshots)のいずれかを使用する必要があります。

DR のソリューションの概要を次に示します。

| シナリオ | 自動レプリケーション | DR ソリューション |
| --- | --- | --- |
| *Premium Storage ディスク* | ローカル ([LRS](storage-redundancy.md#locally-redundant-storage)) | [Azure Backup](https://azure.microsoft.com/services/backup/) |
| *Managed Disks* | ローカル ([LRS](storage-redundancy.md#locally-redundant-storage)) | [Azure Backup](https://azure.microsoft.com/services/backup/) |
| *非管理対象 LRS ディスク* | ローカル ([LRS](storage-redundancy.md#locally-redundant-storage)) | [Azure Backup](https://azure.microsoft.com/services/backup/) |
| *非管理対象 GRS ディスク* | 地域間 ([GRS](storage-redundancy.md#geo-redundant-storage)) | [Azure Backup](https://azure.microsoft.com/services/backup/)<br/>[整合性スナップショット](#alternative-solution-consistent-snapshots) |
| *非管理対象 RA-GRS ディスク* | 地域間 ([RA-GRS](storage-redundancy.md#read-access-geo-redundant-storage)) | [Azure Backup](https://azure.microsoft.com/services/backup/)<br/>[整合性スナップショット](#alternative-solution-consistent-snapshots) |

高可用性は、可用性セット内の管理ディスクを Azure Backup と共に使用することで対応できます。 非管理対象ディスクを使用している場合は、DR 用 Azure Backup を使用できます。 Azure Backup を使用できない場合、後のセクションで説明するように、[整合性スナップショット](#alternative-solution-consistent-snapshots)を利用することがバックアップと DR の代替ソリューションとなります。

アプリケーションまたはインフラストラクチャ レベルでの高可用性、バックアップ、DRの選択は、次のように表すことができます。

| *Level* | 高可用性   | Backup / DR |
| --- | --- | --- |
| *アプリケーション* | SQL Always On | Azure Backup |
| *インフラストラクチャ*  | 可用性セット  | 整合性スナップショットと GRS |

### <a name="using-the-azure-backup-service"></a>Azure Backup サービスの使用

[Azure Backup](../../backup/backup-azure-vms-introduction.md) では、Azure Recovery Services コンテナーに Windows または Linux を実行する VM をバックアップできます。 業務に不可欠なデータのバックアップと復元は、その生成元となるアプリケーションの実行中にバックアップを行う必要があるため、簡単ではありません。 この課題に対処するために、Azure Backup は、Volume Shadow Copy Service (VSS) を使用してデータを正しくストレージに書き込むことにより、Microsoft のワークロードに対するアプリケーション整合性を確保しています。 Linux には VSS に相当する機能がないため、Linux VM についてはファイル整合バックアップのみが可能です。

![](./media/storage-backup-and-disaster-recovery-for-azure-iaas-disks/backup-and-disaster-recovery-for-azure-iaas-disks-1.png)   

Azure Backup がスケジュールされた時刻にバックアップ ジョブを開始すると、VM にインストールされたバックアップ拡張機能をトリガーして特定の時点のスナップショットを作成します。 スナップショットは VSS と連携して作成されるため、仮想マシンで使用されているディスクの一貫したスナップショットを、シャットダウンせずに取得できます。 VM のバックアップの拡張機能は、すべての書き込みをフラッシュした後に、すべてのディスクの整合性スナップショットを作成します。 スナップショットが作成されると、データは Azure Backup によってバックアップ コンテナーに転送されます。 バックアップ プロセスの効率を高めるために、前回のバックアップ以降に変更されたデータ ブロックが特定され、そのデータのみが転送されます。


復元するには、Azure Backup を使用して使用可能なバックアップを表示し、復元を開始します。 [Azure Portal](https://portal.azure.com/) 経由で、[PowerShell を使用して](../../backup/backup-azure-vms-automation.md )、または [Azure CLI](https://docs.microsoft.com/azure/xplat-cli-install) を使用して、Azure バックアップを作成および復元できます。 詳細については、Azure Backup に関するページをご覧ください。

### <a name="steps-to-enable-backup"></a>バックアップを有効にする手順

[Azure Portal](https://portal.azure.com/) を使用して VM のバックアップを有効にする一般的な手順は以下のとおりです。 実際のシナリオに応じて、いくつかのバリエーションがあります。 完全な詳細情報については、[Azure Backup](../../backup/backup-azure-vms-introduction.md)に関するドキュメントをご覧ください。 Azure Backup は [管理ディスクを使用する VM もサポートします](https://azure.microsoft.com/blog/azure-managed-disk-backup/)。

1.  次の手順を使用して、VM 用の Recovery Services コンテナーを作成します。

    a.  [Azure Portal](https://portal.azure.com/) を使用して、すべてのリソースを参照し、「Recovery Services コンテナー」を検索します。

    b.  Recovery Services コンテナー メニューで、[追加] をクリックし、VM と同じリージョンで新しいコンテナーを作成する手順に従います。 たとえば、VM が米国西部地域にある場合は、コンテナーに米国西部を選択します。

2.  新しく作成されたコンテナーのストレージ レプリケーションを確認します。 これを行うには、[Recovery Services コンテナー] ブレードからコンテナーにアクセスし、設定や [構成のバックアップ] に移動します。 GRS オプションが既定で選択されていることを確認します。 これによって、コンテナーがセカンダリ データ センターに自動的にレプリケートされます。 たとえば、米国西部のコンテナーは、米国東部に自動的にレプリケートされます。

3.  バックアップ ポリシーを構成し、同じ UI から VM を選択します。

4.  Backup エージェントが VM にインストールされていることを確認します。 VM が Azure ギャラリー イメージを使用して作成されている場合、Backup エージェントは既にインストールされています。 それ以外の場合は (つまりカスタム イメージを使用している場合)、[仮想マシンに VM エージェントをインストールする](../../backup/backup-azure-arm-vms-prepare.md#install-the-vm-agent-on-the-virtual-machine)手順を使用します。

5.  バックアップ サービスが動作するために、ネットワーク接続が VM によって許可されていることを確認します。 [ネットワーク接続](../../backup/backup-azure-arm-vms-prepare.md#network-connectivity)に関する手順に従ってください。

6.  上記の手順を完了すると、バックアップ ポリシーで指定されている通り、バックアップが定期的に実行されます。 必要に応じて、Azure Portal のコンテナー ダッシュボードから、最初のバックアップを手動でトリガーできます。

スクリプトを使用した Azure Backup の自動化については、[VM バックアップ用の PowerShell コマンドレット](../../backup/backup-azure-vms-automation.md)に関するページをご覧ください。

### <a name="steps-for-recovery"></a>回復の手順

VM を修復またはリビルドする必要がある場合は、コンテナーのバックアップ復旧ポイントのいずれかから VM を復元できます。 復旧の実施方法には 2 つのオプションがあります。

1.  特定の時点のバックアップ VM として、新しい VM を作成できます。

2.  ディスクを復元した後に VM のテンプレートを使用して、復元された VM をカスタマイズし、リビルドすることができます。 

「[Azure Portal を使用した仮想マシンの復元](../../backup/backup-azure-arm-restore-vms.md#restoring-a-vm-during-azure-datacenter-disaster)」の手順をご覧ください。 ドキュメントでは、プライマリ データ センターの災害の場合に、geo 冗長バックアップ コンテナーを使用して、対となるデータ センターに VM のバックアップを復元するための特定の手順も説明します。 その場合、Azure Backup では、セカンダリ リージョンからコンピューティング サービスを使用して、復元された仮想マシンを作成します。

また、[VM の復元](../../backup/backup-azure-vms-automation.md#restore-an-azure-vm)や[復元されたディスクからの新しい VM の作成](../../backup/backup-azure-vms-automation.md#create-a-vm-from-restored-disks) には、PowerShell を使用できます。

## <a name="alternative-solution-consistent-snapshots"></a>代替のソリューション: 整合性スナップショット

Azure Backup サービスを使用できない場合は、スナップショットを使用して、独自のバックアップ メカニズムを実装できます。 VM で使用されるすべてのディスクの整合性スナップショットを作成し、そのスナップショットを別のリージョンにレプリケートする方法は複雑です。 このため、Azure では、バックアップ サービスの活用はカスタム ソリューションの構築よりも良いオプションであると考えています。 ディスクの RA-GRS ストレージや GRS ストレージを使用する場合、スナップショットはセカンダリ データ センターに自動的にレプリケートされます。 ディスクの LRS ストレージを使用する場合は、自分でデータをレプリケートする必要があります。 詳細については、「[増分スナップショットを使用した Azure 非管理 VM ディスクのバックアップ](../../virtual-machines/windows/incremental-snapshots.md)」をご覧ください。

スナップショットは、特定の時点におけるオブジェクトを表現したものです。 スナップショットによって、保持しているデータのサイズの増分に対する請求が発生します。 詳細については、「[BLOB のスナップショットの作成](../blobs/storage-blob-snapshots.md)」をご覧ください。

### <a name="creating-snapshots-while-the-vm-is-running"></a>VM の実行中にスナップショットを作成する

スナップショットはいつでも取得可能ですが、VM を実行している場合は、ディスクに送信されている最中のデータが存在するため、スナップショットには実行中のオペレーションが部分的に含まれる場合があります。 また、複数のディスクが対象となっている場合は、それぞれのディスクのスナップショットが異なる時刻に取得された可能性があります。つまり、これらのスナップショットは連携していない可能性があるということです。 これは、バックアップ中に変更が行われた場合にファイルが破損する可能性があるストライプ ボリュームでは、特に問題です。

この状況を避けるために、バックアップ プロセスで次の手順を実施する必要があります。

1.  すべてのディスクを凍結する

2.  保留中のすべての書き込みをフラッシュする

3.  次に、すべてのディスクの [BLOB スナップショットを作成する](../blobs/storage-blob-snapshots.md)

SQL Server などの一部の Windows アプリケーションは、アプリケーション整合性バックアップを作成する VSS を通して、連携のとれたバックアップ メカニズムを提供します。 Linux では、ディスクを調整するために fsfreeze などのツールを使用できます。このツールはファイル整合性バックアップを提供していますが、アプリケーション整合性スナップショットは提供していません。 このプロセスは複雑なため、[Azure Backup](../../backup/backup-azure-vms-introduction.md) を使用するか、既にこれを実装しているサード パーティのバックアップ ソリューションを使用することを検討する必要があります。

上記のプロセスによって、すべての VM ディスクに対する連携のとれた一連のスナップショットが生成されます。これは、特定の時点の VM の状態を表します。 これが、VM のバックアップの復元ポイントです。 スケジュールされた間隔で処理を繰り返し、定期的にバックアップを作成できます。 DR のために[バックアップを別のリージョンにコピーする](#copy-the-snapshots-to-another-region)手順については、次をご覧ください。

### <a name="creating-snapshots-while-the-vm-is-offline"></a>VM がオフラインのときにスナップショットを作成する

整合性バックアップを作成する別のオプションは、VM をシャット ダウンし、各ディスクの BLOB スナップショットを作成することです。 これは、実行中の VM の連携スナップショットよりも簡単ですが、数分間のダウンタイムが必要です。 このプロセスでは、次の手順を実行します。

1. VM をシャット ダウンします。

2. 各 VHD BLOB スナップショットを作成します。これにはほんの数秒しかかかりません。

    スナップショットを作成するには、[PowerShell](storage-powershell-guide-full.md#how-to-manage-azure-blob-snapshots)、[Azure Storage Rest API](https://msdn.microsoft.com/library/azure/ee691971.aspx)、[Azure CLI](https://docs.microsoft.com/azure/xplat-cli-install)、または [.NET 用 ストレージ クライアント ライブラリ](https://msdn.microsoft.com/library/azure/hh488361.aspx) などの Azure Storage クライアント ライブラリのいずれかを使用できます。

3. VM を起動します。これによってダウンタイムが終了します。 通常、プロセス全体が数分以内に完了します。

このプロセスによって、すべてのディスクに対する一連の整合性スナップショットが生成され、VM のバックアップの復元ポイントが得られます。 DR のためにスナップショットを別のリージョンにコピーする手順については、次をご覧ください。

### <a name="copy-the-snapshots-to-another-region"></a>スナップショットを別のリージョンにコピーする

スナップショットを作成しただけでは、DR には不十分です。 別のリージョンにスナップショット バックアップをレプリケートする必要もあります。

GRS または RA-GRS をディスクに使用している場合、スナップショットはセカンダリ リージョンに自動的にレプリケートされます。 レプリケーション前に遅延の数分が発生する可能性があります。スナップショットの複製が完了する前に、プライマリ データ センターがダウンした場合は、セカンダリ データ センターからスナップショットにアクセスすることはできません。 この可能性は低いです。

> [!Note] 
> GRS アカウントまたは RA-GRS アカウントにディスクを持っているだけでは、VM は障害から保護されません。 ユーザーは、連携のとれたスナップショットを作成するか、Azure Backup を使用する必要もあります。 これは、VM を整合性のある状態に回復するために必要です。

LRS を使用している場合は、スナップショットを作成した後、別のストレージ アカウントにスナップショットをすぐにコピーする必要があります。 コピーのターゲットは、異なるリージョンの LRS ストレージ アカウントであり、結果的にリモート リージョンのコピーになります。 同じリージョン内の RA-GRS ストレージ アカウントに、スナップショットをコピーすることもできます。 この場合、スナップショットはリモート セカンダリ リージョンにゆっくりとレプリケートされます。 コピーとレプリケーションが完了すると、バックアップはプライマリ サイトの障害から保護されます。

DR 用の増分スナップショットを効率的にコピーするには、「[増分スナップショットを使用した Azure 非管理 VM ディスクのバックアップ](../../virtual-machines/windows/incremental-snapshots.md)」の手順を確認してください。

![](./media/storage-backup-and-disaster-recovery-for-azure-iaas-disks/backup-and-disaster-recovery-for-azure-iaas-disks-2.png)   

### <a name="recovery-from-snapshots"></a>スナップショットからの復旧

スナップショットを取得するには、スナップショットをコピーして新しい BLOB を作成します。 プライマリ アカウントからスナップショットをコピーする場合は、スナップショットをスナップショットのベース BLOB にコピーして、ディスクをスナップショットに戻すことができます。これは、スナップショットの昇格として知られています。 セカンダリ アカウント (RA-GRSの場合) からスナップショット バックアップをコピーする場合は、プライマリ アカウントにコピーする必要があります。 [PowerShell を使用して](storage-powershell-guide-full.md#how-to-copy-a-snapshot-of-a-blob)、または AzCopy ユーティリティを使用して、スナップショットをコピーすることができます。 詳細については、[AzCopy コマンド ライン ユーティリティを使用したデータの転送](storage-use-azcopy.md)に関するページをご覧ください。

複数のディスクを持つ VM の場合は、連携のとれた同じ復元ポイントの一部であるスナップショットをすべてコピーする必要があります。 書き込み可能な VHD BLOB にスナップショットをコピーしたら、BLOB を使用して、VM のテンプレートを利用して VM を再作成できます。

## <a name="other-options"></a>その他のオプション

### <a name="sql-server"></a>SQL Server

VM で動作している SQL Server には、SQL Server データベースを Azure Blob Storage やファイル共有にバックアップする独自の組み込み機能があります。 ストレージ アカウントが GRS または RA-GRS である場合は、障害発生時にストレージ アカウントのセカンダリ データ センターにあるバックアップにアクセスできます。前述したものと同じ制約があります。 詳細については、「[Azure Virtual Machines における SQL Server のバックアップと復元](../../virtual-machines/windows/sql/virtual-machines-windows-sql-backup-recovery.md)」を参照してください。 バックアップと復元に加えて、[SQL Server Always On 可用性グループ](../../virtual-machines/windows/sql/virtual-machines-windows-sql-high-availability-dr.md)ではデータベースのセカンダリ レプリカを管理でき、ディザスター リカバリーの時間が大幅に削減されます。

## <a name="other-considerations"></a>その他の考慮事項

この記事では、ディザスター リカバリーをサポートするために、VM とそのディスクのバックアップやスナップショットを取得する方法と、それらを使用して復元する方法について説明しました。 Azure Resource Manager モデルでは、多くのユーザーはテンプレートを使用して、Azure で各自の VM とその他のインフラストラクチャを作成します。 テンプレートを使用すると、毎回同じ構成を持つ VM を作成できます。 VM の作成にカスタム イメージを使用する場合は、イメージを格納する RA-GRS アカウントを使用することで、イメージが保護されていることも確認する必要があります。

そのため、バックアップ プロセスには次の 2 つの組み合わせがあります。

1. データ (ディスク) をバックアップする
2. 構成 (テンプレート、カスタム イメージ) をバックアップする

選択したバックアップ オプションに応じて、ユーザーがデータと構成の両方のバックアップを処理する必要があるか、バックアップ サービスがすべてを処理します。

## <a name="appendix---understanding-the-impact-of-lrs-grs-and-ra-grs"></a>付録 - LRS、GRS、RA-GRS の影響を理解する

Azure のストレージ アカウントについては、ディザスター リカバリーに関して考慮すべき 3 種類のデータの冗長性があります。すなわち、ローカル冗長 (LRS)、geo 冗長 (GRS)、読み取りアクセスを伴う geo 冗長 (RA-GRS) です。 

ローカル冗長ストレージ (LRS) には、同じデータ センター内のデータのコピーが 3 つ保持されています。 データを書き込むと、3 つのすべてのコピーが更新され、処理が成功したことが呼び出し元に返されるため、3 つが同じものであることが分かります。 3 つのすべてのコピーが同時に影響を受ける可能性は極めてまれであるため、ディスクは局所的な障害から保護されています。 LRS の場合は geo 冗長性がないため、データ センター全体またはストレージ ユニット全体に影響するような壊滅的な障害からは、ディスクは保護されていません。

GRS と RA-GRS では、データの 3 つのコピーはプライマリ リージョン (ユーザー側で選択) に保持され、さらに 3 つのコピーが対応するセカンダリ リージョン (Azure 側で設定) に保持されます。 たとえば、米国西部にデータを格納する場合、データは米国東部にレプリケートされます。 これは、非同期で行われ、プライマリとセカンダリの更新の間には小さな遅延が発生します。 セカンダリ サイト上のディスクのレプリカにはディスクごとに一貫性がありますが (遅延あり)、複数のアクティブなディスクのレプリカは、**互いに**同期していない可能性があります。 複数のディスクにわたって一貫性のあるレプリカを持つには、一貫性のあるスナップショットが必要です。

GRS と RA-GRS の主な違いは、RA-GRSを使えば、セカンダリ コピーをいつでも読み取ることができる点です。 プライマリ リージョンのデータにアクセスできない問題がある場合、Azure チームはデータへのアクセスを復旧させるために、あらゆる努力をします。 プライマリが停止中でも、RA-GRS を有効にした場合は、セカンダリ データ センターのデータにアクセスできます。 そのため、プライマリにアクセスできないときにレプリカから読み取る計画である場合は、RA-GRS を検討する必要があります。

重大な停止であることが判明した場合、Azure チームは geo フェールオーバーをトリガーし、プライマリ DNS エントリを変更してセカンダリ ストレージを指すようにすることができます。 この時点で GRS または RA-GRS が有効になっている場合は、セカンダリとして使用されていたリージョンのデータにアクセスできます。 つまり、ストレージ アカウントが GRS であり、かつ問題が発生する場合は、geo フェールオーバーを実行する場合にのみ、セカンダリ ストレージにアクセスできます。

詳細については、「[Azure Storage の停止が発生した場合の対処方法](storage-disaster-recovery-guidance.md)」をご覧ください。 

フェールオーバーを実行するかどうかを制御するのは Microsoft であることに注意してください。 フェールオーバーはストレージ アカウントごとに制御されるものではないため、個別のお客様が決定することはできません。 特定のストレージ アカウントまたは仮想マシンのディスクのディザスター リカバリーを実装するには、この記事で既に説明した手法を使用する必要があります。

