---
title: 'Azure ExpressRoute: 非対称ルーティング'
description: この記事では、送信先へのリンクが複数あるネットワーク内の非対称ルーティングに関して発生する可能性がある問題について説明します。
services: expressroute
author: duongau
ms.service: expressroute
ms.topic: article
ms.date: 10/10/2016
ms.author: duau
ms.openlocfilehash: aa3465940088d3a66f23dfd5d58a6ec3fd3053de
ms.sourcegitcommit: 5a3b9f35d47355d026ee39d398c614ca4dae51c6
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/02/2020
ms.locfileid: "89397714"
---
# <a name="asymmetric-routing-with-multiple-network-paths"></a>複数のネットワーク パスを使用した非対称ルーティング
この記事では、ネットワークの送信元と送信先の間で利用できるパスが複数存在する場合に、ネットワーク トラフィックが行きと戻りで異なるルートを取る場合がある理由について説明します。

非対称ルーティングについて理解するには、2 つの概念を理解することが重要です。 1 つは、複数のネットワーク パスの影響です。 もう 1 つは、ファイアウォールなどのデバイスが状態を維持する方法です。 これらの種類のデバイスはステートフル デバイスと呼ばれます。 これら 2 つの要素が組み合わさると、ステートフル デバイスで発信されたネットワーク トラフィックがデバイス自体によって検出されないために、そのトラフィックがデバイスによってドロップされることがあります。

## <a name="multiple-network-paths"></a>複数のネットワーク パス
インターネット サービス プロバイダーを介したインターネットへのリンクがエンタープライズ ネットワークに 1 つしかない場合、インターネットとの間のトラフィックの往来はすべて同じパスを経由して行われます。 多くの場合、企業は (冗長パスとして) 複数の回線を調達し、ネットワークのアップタイム向上を図ります。 これが行われた場合、ネットワークの外部のインターネットへと出て行くトラフィックはあるリンクを経由し、戻ってくるトラフィックは別のリンクを経由するということがあり得ます。 これは一般に非対称ルーティングと呼ばれます。 非対称ルーティングでは、逆方向のネットワーク トラフィックが元のフローとは異なるパスを経由します。

![Network with multiple paths](./media/expressroute-asymmetric-routing/AsymmetricRouting3.png)

これは主にインターネットで発生しますが、非対称ルーティングは複数のパスによる他の組み合わせにも当てはまります。 たとえば、同一の送信先に対してインターネット パスとプライベート パスがそれぞれ 1 つある場合と、同一の送信先に対してプライベート パスが複数ある場合の両方に当てはまります。

送信元から送信先の途上に位置する各ルーターは、送信先に到達するうえで最適なパスを計算します。 ルーターによる最適と思われるパスの決定は、主に 2 つの要因に基づきます。

* 外部ネットワーク間のルーティングは、ボーダー ゲートウェイ プロトコル (BGP) というルーティング プロトコルに基づきます。 BGP では、アドバタイズメントが近隣ノードから取得され、一連の段階を経てそれらが実行されることで、目的の送信先までの最適なパスが決定されます。 その後、最適なパスはルーティング テーブルに格納されます。
* ルートに関連付けられたサブネット マスクの長さは、ルーティング パスに影響します。 IP アドレスは同一であるがサブネット マスクは異なる複数のアドバタイズメントを受け取った場合、ルーターはサブネット マスクの長いアドバタイズメントを優先します。これは、サブネット マスクの長い方がより具体的なルートであると判断されるためです。

## <a name="stateful-devices"></a>ステートフル デバイス
ルーターは、ルーティングを行うためにパケットの IP ヘッダーを確認します。 いくつかのデバイスは、パケットをより詳細に確認します。 これらのデバイスは通常、レイヤー 4 (伝送制御プロトコル (TCP) またはユーザー データグラム プロトコル (UDP)) のヘッダー、またはレイヤー 7 (アプリケーション レイヤー) のヘッダーまで確認します。 この種のデバイスは、セキュリティ デバイスと帯域幅最適化デバイスのいずれかです。 

たとえば、一般的なステートフル デバイスとしてファイアウォールが挙げられます。 プロトコル、TCP/UDP ポート、URL ヘッダーなどの各点に基づいて、ファイアウォールはそのインターフェイスをパススルーするパケットを許可または拒否します。 このレベルのパケット インスペクションでは、デバイスに大きな処理負荷がかかります。 パフォーマンスを向上させるために、ファイアウォールではフローの最初のパケットが検査されます。 ファイアウォールによってパケットの通過が許可されると、その状態テーブルにフロー情報が保持されます。 このフローに関連する後続パケットはすべて、最初の決定に基づいて許可されます。 既存のフローに属するパケットがファイアウォールに届く場合があります。 パケットに関する事前の状態情報がない場合、このパケットはファイアウォールによってドロップされます。

## <a name="asymmetric-routing-with-expressroute"></a>ExpressRoute を使用した非対称ルーティング
Azure ExpressRoute 経由で Microsoft に接続すると、ネットワークは次のように変更されます。

* Microsoft へのリンクが複数になります。 1 つは既存のインターネット接続で、もう 1 つは ExpressRoute によるものです。 Microsoft に向かうトラフィックの一部がインターネットを経由して送信され、ExpressRoute を経由して戻ってくることがあります (その逆もあります)。
* ExpressRoute 経由で特定の IP アドレスを受け取ります。 このため、ExpressRoute によって提供されるサービスの場合、ユーザーのネットワークから Microsoft へのトラフィックについては常に、ルーターは ExpressRoute を優先して使用します。

これらの 2 つの変更がネットワークに与える影響を把握するために、いくつかのシナリオについて考えてみましょう。 たとえば、インターネットへの回線が 1 つのみであり、Microsoft のサービスをすべてインターネット経由で利用しているとします。 ユーザーのネットワークから Microsoft へと送信され戻ってくるトラフィックは、同じインターネット リンクを経由し、ファイアウォールを通過します。 ファイアウォールによって最初のパケットが確認され、フローが記録されます。状態テーブルにフローがあるため、戻りのパケットは許可されます。

![ExpressRoute を使用した非対称ルーティング](./media/expressroute-asymmetric-routing/AsymmetricRouting1.png)

次に ExpressRoute を有効にし、Microsoft から提供されるサービスを ExpressRoute を介して利用します。 Microsoft の他のサービスはすべてインターネットを介して利用します。 ExpressRoute に接続されている境界に別のファイアウォールをデプロイします。 特定のサービスについて、Microsoft によってより具体的なプレフィックスが ExpressRoute 経由でネットワークにアドバタイズされます。 ルーティング インフラストラクチャは、これらのプレフィックスの優先パスとして ExpressRoute を選択します。 パブリック IP アドレスが ExpressRoute 経由で Microsoft にアドバタイズされていない場合、Microsoft はインターネット経由でパブリック IP アドレスと通信します。 ユーザーのネットワークから Microsoft への送信トラフィックには ExpressRoute が使用され、Microsoft から戻ってくるトラフィックにはインターネットが使用されます。 境界のファイアウォールによって、状態テーブルにないフローの応答パケットが確認されると、戻りトラフィックがドロップされます。

ExpressRoute とインターネットに同一のネットワーク アドレス変換 (NAT) プールをアドバタイズする場合、プライベート IP アドレスのネットワーク内にあるクライアントについて同様の問題が発生します。 Windows Update などのサービスについては IP アドレスが ExpressRoute 経由でアドバタイズされていないため、これらのサービスに対する要求はインターネット経由で送信されます。 ただし、戻りトラフィックは ExpressRoute 経由になります。 インターネットと ExpressRoute から同じサブネット マスクの IP アドレスを受け取った場合、Microsoft はインターネットより ExpressRoute を優先します。 ネットワーク境界に位置し、ExpressRoute に接続しているファイアウォールまたは別のステートフル デバイスに、フローに関する事前情報がない場合、そのフローに属するパケットはドロップされます。

## <a name="asymmetric-routing-solutions"></a>非対称ルーティングの解決策
非対称ルーティングの問題を解決するには、主に 2 つの方法があります。 1 つはルーティングによるもので、もう 1 つは送信元ベースの NAT (SNAT) を使用するものです。

### <a name="routing"></a>ルーティング
パブリック IP アドレスは必ず、適切なワイド エリア ネットワーク (WAN) リンクにアドバタイズするようにしてください。 たとえば、認証トラフィックにはインターネット、電子メール トラフィックには ExpressRoute を使用するつもりであれば、Active Directory フェデレーション サービス (AD FS) パブリック IP アドレスを ExpressRoute 経由でアドバタイズしないようにしてください。 同様に、ルーターが ExpressRoute 経由で受け取る IP アドレスに、オンプレミスの AD FS サーバーを公開しないようにしてください。 ExpressRoute 経由で受け取ったルートはより具体的であるため、Microsoft への認証トラフィックのパスとして ExpressRoute が優先されます。 これにより、非対称ルーティングが発生します。

ExpressRoute を認証に使用したい場合は、NAT を使用せずに ExpressRoute 経由で AD FS パブリック IP アドレスをアドバタイズするようにしてください。 そうすることで、Microsoft から送信されオンプレミスの AD FS サーバーに向かうトラフィックは、ExpressRoute を経由します。 ユーザーから Microsoft に戻るトラフィックには ExpressRoute が使用されます。これは、ExpressRoute がインターネットよりも優先されるルートであるためです。

### <a name="source-based-nat"></a>送信元ベースの NAT
非対称ルーティングの問題を解決するもう 1 つの方法は、SNAT を使用することです。 たとえば、簡易メール転送プロトコル (SMTP) サーバーによる通信にインターネットを使用するため、オンプレミスの SMTP サーバーのパブリック IP アドレスを ExpressRoute 経由でアドバタイズしていないとします。 Microsoft によってオンプレミスの SMTP サーバーに送信される要求はインターネットを経由します。 SNAT を使用して受信要求を内部 IP アドレスに変換します。 SMTP サーバーからの逆方向トラフィックは、ExpressRoute を経由せず、(NAT に使用する) 境界ファイアウォールに届きます。 戻りトラフィックはインターネットを経由します。

![Source-based NAT network configuration](./media/expressroute-asymmetric-routing/AsymmetricRouting2.png)

## <a name="asymmetric-routing-detection"></a>非対称ルーティングの検出
traceroute は、ネットワーク トラフィックが予想されるパスを経由していることを確認するうえで、最善の手段です。 オンプレミスの SMTP サーバーから Microsoft に送信されるトラフィックがインターネット パスを経由することが予想される場合、予想される traceroute は SMTP サーバーから Office 365 までです。 その結果から、トラフィックが実際にユーザーのネットワークから (ExpressRoute ではなく) インターネットに向かって送信されていることが確認できます。

