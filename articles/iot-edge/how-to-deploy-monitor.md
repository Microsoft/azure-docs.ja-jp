---
title: Azure portal から自動展開を作成する - Azure IoT Edge | Microsoft Docs
description: Azure portal を使用して、一連の IoT Edge デバイスの自動展開を作成します
keywords: ''
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 02/19/2019
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.custom: seodec18
ms.openlocfilehash: 69ba0a882c0e52e7c0d063b8f77e7a0fe22526a1
ms.sourcegitcommit: 9aa9552c4ae8635e97bdec78fccbb989b1587548
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/20/2019
ms.locfileid: "56428779"
---
# <a name="deploy-and-monitor-iot-edge-modules-at-scale-using-the-azure-portal"></a>Azure Portal を使用した大規模な IoT Edge モジュールの展開と監視

[!INCLUDE [iot-edge-how-to-deploy-monitor-selector](../../includes/iot-edge-how-to-deploy-monitor-selector.md)]

Azure IoT Edge を使用することにより、分析をエッジに移動しクラウド インターフェイスを提供して、各 IoT Edge デバイスに物理的にアクセスしなくても、管理および監視することができます。 デバイスをリモート管理できる機能は、モノのインターネット ソリューションの規模と複雑性が増加している今、重要性が高まっています。 Azure IoT Edge は、追加するデバイスの数に関係なく、ビジネス目標を支援できるよう設計されています。

デバイスを個別に管理し、それらにモジュールを一括展開できます。 ただし、大規模な環境でのデバイスに変更を加える場合は、IoT Hub での自動デバイス管理の一環である、**IoT Edge の自動展開**を作成することができます。 デプロイは、一度に複数のモジュールを複数のデバイスに展開し、モジュールの状態と正常性を追跡し、必要に応じて変更できる動的プロセスです。 

## <a name="identify-devices-using-tags"></a>タグを使用したデバイスの識別

デプロイを作成する前に、影響を与えるデバイスを指定できる必要があります。 Azure IoT Edge では、デバイス ツイン内の**タグ**を使用してデバイスを識別します。 各デバイスには複数のタグを設定することができ、ソリューションに適した任意の方法で定義できます。 たとえば、スマート ビルのキャンパスを管理している場合は、デバイスに次のタグを追加できます。

```json
"tags":{
    "location":{
        "building": "20",
        "floor": "2"
    },
    "roomtype": "conference",
    "environment": "prod"
}
```

デバイス ツインとタグの詳細については、「[IoT Hub のデバイス ツインの理解と使用](../iot-hub/iot-hub-devguide-device-twins.md)」を参照してください。

## <a name="create-a-deployment"></a>デプロイの作成

1. [Azure portal](https://portal.azure.com) で IoT Hub に移動します。 
1. **[IoT Edge]** を選択します。
1. **[Add IoT Edge Deployment]\(IoT Edge の展開の追加\)** を選びます。

デプロイを作成するには、5 つの手順があります。 次のセクションで、手順ごとに説明します。 

### <a name="step-1-name-and-label"></a>手順 1:名前とラベル

1. デプロイに一意の名前を付けます。名前は最大 128 文字の英小文字で指定します。 スペースや、無効な文字は使用しないでください。`& ^ [ ] { } \ | " < > /`
1. デプロイの追跡に役立つよう、キーと値のペアとしてラベルを追加できます。 たとえば、**HostPlatform** と **Linux**、**Version** と **3.0.1** などです。
1. **[次へ]** を選択して手順 2 に進みます。 

### <a name="step-2-add-modules-optional"></a>手順 2:モジュールの追加 (省略可能)

デプロイに追加できるモジュールは 2 種類あります。 1 つめは、ストレージ アカウントや Stream Analytics など、Azure サービスに基づくモジュールです。 2 つめは、ユーザー独自のコードを使用するモジュールです。 各種類の複数のモジュールをデプロイに追加できます。 

モジュールを含まない展開を作成すると、デバイスから現在のモジュールが削除されます。 

>[!NOTE]
>Azure Functions では、自動化された Azure サービスのデプロイはまだサポートされていません。 デプロイにそれらのサービスを手動で追加するには、カスタム モジュールのデプロイを使用します。 

Azure Stream Analytics からモジュールを追加するには、次の手順を実行します。

1. ページの **[Deployment modules]\(デプロイ モジュール\)** セクションで、**[追加]** をクリックします。
1. **[Azure Stream Analytics モジュール]** を選択します。
1. ドロップダウン メニューから使用する**サブスクリプション**を選択します。
1. ドロップダウン メニューから使用する **Edge ジョブ**を選択します。
1. **[保存]** を選択してデプロイにモジュールを追加します。 

モジュールとしてカスタム コードを追加する、または Azure のサービス モジュールを手動で追加するには、次の手順を実行します。

1. ページの **[コンテナー レジストリの設定]** セクションで、このデプロイのモジュール イメージを含むプライベート コンテナー レジストリの名前と資格情報を指定します。 Docker イメージのコンテナー レジストリ資格情報が見つからないと、Edge エージェントは、エラー 500 を報告します。
1. ページの **[Deployment modules]\(デプロイ モジュール\)** セクションで、**[追加]** をクリックします。
1. **[IoT Edge モジュール]** を選択します。
1. モジュールに **[名前]** を付けます。
1. **[イメージの URI]** フィールドに、モジュールのコンテナー イメージを入力します。 
1. コンテナーに渡す **[Container Create Options]\(コンテナー作成オプション\)** を指定します。 詳細については、[Docker の作成](https://docs.docker.com/engine/reference/commandline/create/)に関するページを参照してください。
1. ドロップダウン メニューを使用して、**[再起動ポリシー]** を選択します。 次のオプションから選択します。 
   * **[Always]\(常時\)** - 何らかの理由でシャット ダウンした場合に必ずモジュールを再起動します。
   * **[Never]\(再起動しない\)** - 何らかの理由でシャット ダウンした場合でも、モジュールは再起動されません。
   * **[On-failed]\(障害時\)** - クリーンなシャットダウンではなく、クラッシュした場合に、モジュールを再起動します。 
   * **[On-unhealthy]\(異常時\)**-モジュールがクラッシュまたは異常な状態を返したときに再起動します。 正常性ステータス関数を実装するかどうかは、各モジュールによって異なります。 
1. ドロップダウン メニューを使用してモジュールの **[Desired Status]\(目的の状態\)** を選択します。 次のオプションから選択します。
   * **[実行中]** - これが既定のオプションです。 モジュールは、展開された後すぐに実行が開始されます。
   * **[停止]** - 展開された後、ユーザーまたは別のモジュールによって開始されるまで、モジュールはアイドル状態になります。
1. モジュール ツインにタグまたは他のプロパティを追加する場合は、**[モジュール ツインの必要なプロパティの設定]** を選択します。
1. このモジュールの **[環境変数]** を入力します。 環境変数は、構成プロセスを容易にするための補完情報を提供します。
1. **[保存]** を選択してデプロイにモジュールを追加します。 

展開するすべてのモジュールを構成したら、**[次へ]** を選択して手順 3 に進みます。

### <a name="step-3-specify-routes-optional"></a>手順 3:ルートの指定 (省略可能)

ルートは、デプロイ内のモジュール間の通信方法を定義します。 既定では、**FROM /\* INTO $upstream** として定義済みの **route** という名前のルートがウィザードから提供されます。つまり、モジュールによるメッセージ出力は IoT Hub に送信されます。  

[ルートの宣言](module-composition.md#declare-routes)の情報を使用してルートを追加または更新し、**[次へ]** を選択して確認のセクションに進みます。

### <a name="step-4-specify-metrics-optional"></a>手順 4:メトリックを指定する (省略可能)

メトリックは、構成のコンテンツを適用した結果としてデバイスから報告される、各種の状態の集計カウントを示すものです。

1. **[メトリック名]** に名前を入力します

1. **[メトリックの条件]** にクエリを入力します。 そのクエリは、IoT Edge ハブ モジュール ツインで[報告されるプロパティ](module-edgeagent-edgehub.md#edgehub-reported-properties)に基づいています。 メトリックは、クエリによって返された行の数を表します。

例: 

```sql
SELECT deviceId FROM devices
  WHERE properties.reported.lastDesiredStatus.code = 200
```

### <a name="step-5-target-devices"></a>手順 5:対象デバイス

このデプロイの対象となるデバイスを、デバイスからのタグ プロパティを使用して指定します。 

同じデバイスが複数のデプロイの対象となっている場合があるため、各デプロイに優先順位番号を付ける必要があります。 競合した場合は、優先度が高いデプロイが優先されます (値が大きい方が優先度が高いことを示します)。 2 つのデプロイの優先度が同じ場合は、作成された時期が最近のデプロイが優先されます。 

1. デプロイの **[優先度]** を正の整数で入力します。 同じデバイスで複数のデプロイがターゲットとなっている場合は、優先度の数値が最も大きいデプロイが適用されます。
1. どのデバイスがこのデプロイの対象となるかを指定する **[Target condition]\(対象の条件\)** を入力します。 条件は、デバイス ツイン タグか、デバイス ツインから報告されるプロパティに基づいて指定し、式の形式に一致させる必要があります。 たとえば、`tags.environment='test'` または `properties.reported.devicemodel='4000x'` です。 
1. **[次へ]** を選択して最後の手順に進みます。

### <a name="step-6-review-deployment"></a>手順 6:デプロイを確認する

デプロイ情報を確認し、**[送信]** を選択します。

## <a name="deploy-modules-from-azure-marketplace"></a>Azure Marketplace からモジュールをデプロイする

Azure Marketplace は、アプリケーションとサービスのオンライン マーケットプレースであり、[IoT Edge モジュール](https://azuremarketplace.microsoft.com/marketplace/apps/category/internet-of-things?page=1&subcategories=iot-edge-modules)など、Azure での実行を認定されてそれに最適化されている、さまざまなエンタープライズ アプリケーションとソリューションを参照できます。 Azure Marketplace には、Azure portal の **[リソースの作成]** からアクセスすることもできます。

Azure Marketplace または Azure portal のいずれかから、IoT Edge モジュールをインストールできます。

1. モジュールを見つけて、デプロイ プロセスを開始します。

   * Azure portal:モジュールを見つけて、**[作成]** を選択します。

   * Azure Marketplace:

     1. モジュールを見つけて、**[今すぐ入手する]** を選択します。
     1. **[続行]** を選択して、プロバイダーの使用条件とプライバシー ポリシーを確認します。

1. お使いのサブスクリプションと、ターゲット デバイスをアタッチする IoT ハブを選択します。

1. **[大規模にデプロイする]** を選択します。

1. 新しいデプロイまたは既存のデプロイの複製のどちらにモジュールを追加するかを選択します。複製する場合は、一覧から既存のデプロイを選択します。

1. **[作成]** を選択して、大規模なデプロイを作成するプロセスを続行します。 他のデプロイの場合と同じ詳細を指定することができます。

## <a name="monitor-a-deployment"></a>デプロイの監視

デプロイの詳細を確認し、それを実行するデバイスを監視するには、次の手順を実行します。

1. [Azure Portal](https://portal.azure.com) にサインインし、IoT Hub に移動します。 
1. **[IoT Edge]** を選択します。
1. **[IoT Edge deployments]\(IoT Edge デプロイ\)** を選択します。 

   ![IoT Edge デプロイの表示](./media/how-to-deploy-monitor/iot-edge-deployments.png)

1. デプロイの一覧を確認します。 デプロイごとに、次の詳細を表示できます。
   * **[ID]** - デプロイの名前。
   * **[Target condition]\(対象の条件\)** - 対象となるデバイスを定義するためのタグ。
   * **[優先度]** - デプロイに割り当てられた優先順位番号。
   * **[システム メトリック]** - **[Targeted]\(対象\)** は、対象の条件に一致する IoT Hub 内のデバイス ツインの数を指定します。**[適用済み]** は、IoT Hub 内のモジュール ツインに適用されるデプロイ コンテンツがあるデバイスの数を示します。 
   * **[デバイス メトリック]** - IoT Edge クライアント ランタイムから展開の完了/エラーを報告している Edge デバイスの数。
   * **[カスタム メトリック]** - デプロイに対して定義したメトリックのデータを報告しているデプロイ内の Edge デバイスの数。
   * **[作成時刻]** - デプロイが作成されたときからのタイムスタンプ。 2 つのデプロイの優先順位が同じ場合に、このタイムスタンプを使用して優先するデプロイを決定します。 
1. 監視するデプロイを選択します。  
1. デプロイの詳細を確認します。 タブを使用すると、デプロイの詳細を確認できます。

## <a name="modify-a-deployment"></a>デプロイの変更

デプロイを変更すると、変更はすべての対象デバイスにただちにレプリケートされます。 

対象の条件を更新すると、次の更新が実行されます。

* デバイスが古い対象条件を満たさないが、新しい対象条件を満たしており、このデプロイのそのデバイスに対する優先度が最も高い場合は、このデプロイは、このデバイスに適用されます。 
* このデプロイを現在実行しているデバイスが対象条件を満たさなくなった場合、このデプロイはアンインストールされ、次に優先度の高いデプロイが適用されます。 
* このデプロイを現在実行しているデバイスが対象条件を満たさなくなり、他のデプロイの対象条件を満たさない場合は、デバイスではなにも変更されません。 デバイスは現在の状態で現在のモジュールを実行し続けますが、このデプロイの一部としては管理されなくなります。 デバイスが他のデプロイの対象の条件を満たすと、このデプロイはアンインストールされ、新しいデプロイが適用されます。 

デプロイを変更するには、次の手順を実行します。 

1. [Azure Portal](https://portal.azure.com) にサインインし、IoT Hub に移動します。 
1. **[IoT Edge]** を選択します。
1. **[IoT Edge deployments]\(IoT Edge デプロイ\)** を選択します。 

   ![IoT Edge デプロイの表示](./media/how-to-deploy-monitor/iot-edge-deployments.png)

1. 変更するデプロイを選択します。 
1. 次のフィールドに変更を加えます。 
   * ターゲット条件
   * メトリック - 定義したメトリックを変更または削除するか、新しいメトリックを追加することができます。
   * ラベル
   * 優先順位
1. **[保存]** を選択します。
1. 「[デプロイの監視](#monitor-a-deployment)」に記載された手順に従って、変更が適用されることを確認します。 

## <a name="delete-a-deployment"></a>デプロイの削除

デプロイを削除すると、デバイスには、次に高い優先順位のデプロイが適用されます。 デバイスが他のいずれのデプロイの対象条件も満たさない場合、デプロイが削除されても、モジュールは削除されません。 

1. [Azure Portal](https://portal.azure.com) にサインインし、IoT Hub に移動します。 
1. **[IoT Edge]** を選択します。
1. **[IoT Edge deployments]\(IoT Edge デプロイ\)** を選択します。 

   ![IoT Edge デプロイの表示](./media/how-to-deploy-monitor/iot-edge-deployments.png)

1. チェックボックスを使用して、削除するデプロイを選択します。 
1. **[削除]** を選択します。
1. この操作によりこのデプロイが削除され、すべてのデバイスが以前の状態に戻されることを警告する、プロンプトが表示されます。  これにより、優先度の低いデプロイが適用されます。  対象となっているデプロイがない場合は、モジュールは削除されません。 デバイスからすべてのモジュールを削除するには、モジュールがまったく指定されてないデプロイを作成し、それを同じデバイスにデプロイします。  **[はい]** を選択して続行します。 

## <a name="next-steps"></a>次の手順

詳細については、[Edge デバイスへのモジュールの展開](module-deployment-monitoring.md)を参照してください。
