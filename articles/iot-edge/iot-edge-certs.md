---
title: デバイスのセキュリティのための証明書 - Azure IoT Edge | Microsoft Docs
description: Azure IoT Edge では、証明書を使用して、デバイス、モジュール、リーフ デバイスの検証が行われ、それらの間にセキュリティで保護された接続が確立されます。
author: stevebus
manager: philmea
ms.author: stevebus
ms.date: 09/13/2018
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: 1cf1411e227363e7dc9d54f04d0c630341f55a6e
ms.sourcegitcommit: 9fb6f44dbdaf9002ac4f411781bf1bd25c191e26
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 12/08/2018
ms.locfileid: "53099895"
---
# <a name="azure-iot-edge-certificate-usage-detail"></a>Azure IoT Edge 証明書の使用方法の詳細

IoT Edge 証明書は、モジュールおよびダウンストリーム IoT デバイスで、接続先の [Edge Hub](iot-edge-runtime.md#iot-edge-hub) ランタイム モジュールの ID と正当性を検証するために使用されます。 これらの検証によって、ランタイム、モジュール、および IoT デバイス間で TLS (トランスポート層セキュリティ) によるセキュアな接続が実現します。 IoT Hub 自体と同様に、IoT Edge では、IoT ダウンストリーム (リーフ) デバイスおよび IoT Edge モジュールからの、暗号化されたセキュアな接続が必要になります。 セキュアな TLS 接続を確立するために、Edge Hub モジュールでは、接続するクライアントにサーバー証明書のチェーンを提示して、それらのクライアントで ID を検証します。

IoT Edge での証明書の使用に関する混乱を解消するために、この記事では、開発やテストのシナリオだけでなく、多数のシナリオで IoT Edge 証明書が機能する仕組みについて説明します。 スクリプトが異なる (Powershell と bash) 場合でも、Linux と Windows での概念は同じです。

## <a name="iot-edge-certificates"></a>IoT Edge 証明書

ほとんどの場合、製造業者は、Edge デバイスのエンドユーザーから独立したエンティティです。 市販の Edge デバイスの購入時しか、製造業者と操作者の間に関係が発生しない場合があります。 それ以外に、操作者の代理として Edge デバイスを構築するために、契約の下で製造業者が作業を行う場合があります。 IoT Edge 証明書の設計では、両方のシナリオの考慮を試みています。

次の図は、IoT Edge での証明書の使用方法を示しています。 ルート CA 証明書とデバイス CA 証明書の間に 0 個、1 個、または多数の中間証明書が存在する可能性があります。 関連するエンティティの数に応じて変わりますが、ここでは、一例を示しています。

![典型的な証明書の関連図](./media/iot-edge-certs/edgeCerts-general.png)

### <a name="certificate-authority"></a>証明機関

証明機関 (略して 'CA') は、デジタル証明書を発行するエンティティです。 証明機関は、証明書の所有者および受信者間で信頼されたサード パーティとして機能します。 デジタル証明書では、証明書の受信者による公開キーの所有権を認定します。 最初に、証明機関によって発行されたすべての証明書の信頼の基盤となるルート証明書を発行することで、信頼の証明書チェーンが機能します。 その後、所有者はルート証明書を使用して、追加の中間証明書 ('リーフ' 証明書) を発行できます。

### <a name="root-ca-certificate"></a>ルート CA 証明書

ルート CA 証明書は、プロセス全体の信頼のルートです。 運用環境のシナリオの場合、これは通常、Baltimore、Verisign、DigiCert などの信頼された営利目的の証明機関から購入した CA 証明書になります。お使いの Edge デバイスに接続されているデバイスに対して完全な制御がある場合は、企業レベルの証明機関を使用することが可能です。 どちらの場合も、Edge Hub からの証明書チェーン全体がその証明機関に集約されるので、リーフの IoT デバイスがルート証明書を信頼している必要があります。 ルート CA 証明書を信頼されたルート証明機関のストアに格納するか、または、IoT クライアントが IoT Edge に接続されている場合は、コード内でルート CA 証明書の詳細を提供できます。

### <a name="intermediate-certificates"></a>中間証明書

セキュアなデバイスを生産する一般的な製造プロセスでは、主に漏洩や露出のリスクがあるために、ルート CA 証明書が直接使用されることは、ほとんどありません。 一般に、1 つまたは複数の中間 CA 証明書が作成され、ルート CA 証明書によってデジタル署名されます。 これらの中間証明書は、1 つのみの場合も、チェーンになっている場合もあります。 次に、中間証明書のチェーンが必要になるシナリオを示します。

* 製造業者の社内部門の階層。

* デバイスの生産時にシリアルに関連付けられた複数の企業。

* 顧客がルート CA を購入し、製造業者がその顧客の代わりにデバイスへの署名を行う署名証明書を取得している。

いずれの場合も、製造業者は、終端のデバイス上に配置されたデバイス CA 証明書に署名するために、このチェーンの末尾に中間 CA 証明書を使用します。 一般に、これらの中間証明書は、製造工場で厳重に保護されます。 製造業者が、証明書の使用方法に合わせて、物理および電子の両面で、厳密なプロセスを実施します。

### <a name="device-ca-certificate"></a>デバイス CA 証明書

デバイス CA 証明書は、プロセスの最後の中間 CA 証明書から生成され、この証明書で署名されます。 この証明書は、Edge デバイス自体 (可能であれば、ハードウェア セキュリティ モジュール (HSM) などの安全なストレージ) にインストールされます。 さらに、デバイス CA 証明書は IoT Edge デバイスを一意に識別します。 IoT Edge の場合、デバイス CA 証明書が他の証明書を発行する機能を備えます。 たとえば、デバイス CA 証明書は、[Azure IoT デバイス プロビジョニング サービス](../iot-dps/about-iot-dps.md)への認証デバイスに使用されるリーフ デバイス証明書を発行します。

### <a name="iot-edge-workload-ca"></a>IoT Edge ワークロード CA

プロセスの "操作者" の側で最初になるこの証明書は、IoT Edge が初めて起動されたときに、[IoT Edge セキュリティ マネージャー](iot-edge-security-manager.md)によって生成されます。 この証明書は、"デバイス CA 証明書" から生成され、署名されます。 もう 1 つの中間署名証明書に相当するこの証明書は、IoT Edge ランタイムで使用されるその他の証明書を生成して署名するために、使用されます。 現在は主に、次のセクションで説明している Edge Hub サーバー証明書ですが、将来は、IoT Edge コンポーネントを認証する他の証明書が含まれることがあります。

### <a name="edge-hub-server-certificate"></a>Edge Hub サーバー証明書

Edge Hub サーバー証明書は、IoT Edge で必要な TLS 接続の確立時に、ID 確認のためにリーフ デバイスとモジュールに提示される実際の証明書です。 この証明書は、ルート CA 証明書への証明書を生成するために使用される署名証明書チェーン全体を表します。リーフ IoT デバイスは必ず、これを信頼している必要があります。 IoT Edge セキュリティ マネージャーによって生成された場合、この Edge Hub 証明書の共通名 (CN) は、小文字に変換されてから、config.yaml ファイルの 'hostname' プロパティで指定された名前に設定されます。 これは、IoT Edge で混乱を招く一般的な要因になっています。

## <a name="production-implications"></a>運用環境への影響

「IoT Edge には、なぜ他に 'ワークロード CA' という証明書が必要になるのか」というのは、もっともな質問でしょう。 デバイス CA 証明書を使用して、Edge Hub サーバー証明書を直接生成することはできないのか。 これは、技術的には可能です。 しかし、この "ワークロード" の中間証明書の目的は、デバイス製造業者とデバイス操作者間での考慮事項を分離することです。 IoT Edge デバイスが 1 人の顧客から次の顧客へと販売されたり、転用されたりするシナリオを想像してください。 製造業者で指定されたデバイス CA 証明書は変更不可能にしたいと考えるでしょう。 ただし、デバイスの操作に固有の "ワークロード" 証明書は、新しいデプロイ時にワイプして、再作成する必要があります。

製造業者と操作者のプロセスが分離されるので、運用環境のデバイスに IoT Edge を公開する場合に関しては、ほとんどその影響を考慮する必要がなくなります。

* いずれの証明書ベースのプロセスでも、IoT Edge デバイスを公開するプロセス全体の期間中、ルート CA 証明書とすべての中間 CA 証明書が、セキュリティ保護され監視される必要があります。 IoT Edge デバイスの製造業者は、適切なストレージとその中間証明書の使用のために、強固なプロセスを適切に備えておく必要があります。 さらに、デバイス CA 証明書は、デバイス自体 (可能であれば、ハードウェア セキュリティ モジュール) の、できる限り安全なストレージに保管する必要があります。

* Edge Hub サーバー証明書は、接続するクライアント デバイスとモジュールに対して Edge Hub から提示されるので、デバイス CA 証明書の CN が、IoT Edge デバイスの config.yaml で使用される "ホスト名" と同じでは**いけません**。 IoT Edge に接続するためにクライアントで使用される名前 (接続文字列の GatewayHostName パラメーターや MQTT の CONNECT コマンド経由など) は、デバイス CA 証明書で使用される共通名と同じにすることは**できません**。 これは、Edge Hub が、クライアントによる検証のための証明書チェーン全体を表しているためです。 Edge Hub サーバー証明書とデバイス CA 証明書の両方に同じ CN がある場合、検証ループに陥り、証明書は無効になります。

* デバイス CA 証明書は、最後の IoT Edge 証明書を生成するために IoT Edge Security デーモンで使用されるので、それ自体が署名証明書、つまり、署名機能を備えた証明書になっている必要があります。 デバイス CA 証明書を署名機能を備えた CA 証明書にするには、基本的に "V3 Basic constraints CA:True"\(V3 の基本制約 CA: True\) をデバイスに適用すると、CA 証明書が自動的にキーの使用方法に関する必須プロパティを設定します。

>[!Tip]
> Microsoft の "便利なスクリプト" (次のセクションを参照) を使用して Dev/Test シナリオにおける透過的ゲートウェイとして IoT Edge を既に設定し終え、デバイス CA 証明書の作成時に config.yaml のホスト名と同じホスト名を使用していたら、なぜうまく動作したのか疑問に感じるかもしれません。 開発者のエクスペリエンスを簡素化するために、便利なスクリプトによって、スクリプトに渡す名前の末尾に ".ca" が付加されます。 つまり、たとえばスクリプト内のデバイス名と config.yaml 内のホスト名の両方に "mygateway" を使用していた場合、前者は、デバイス CA 証明書の CN として使用される前に、mygateway.ca に変更されます。

## <a name="devtest-implications"></a>Dev/Test の影響

Dev/Test のシナリオを簡素化するために、Microsoft では、透過的ゲートウェイのシナリオで IoT Edge に適した非運用環境の証明書を生成するための、一連の[便利なスクリプト](https://github.com/Azure/azure-iot-sdk-c/tree/master/tools/CACertificates)を提供しています。 スクリプトの機能の例については、「[透過的なゲートウェイとして機能するように IoT Edge デバイスを構成する](how-to-create-transparent-gateway.md)」をご覧ください。

これらのスクリプトによって、この記事で説明した証明書チェーン構造に沿った証明書が生成されます。 次のコマンドで "ルート CA 証明書" および単一の "中間 CA 証明書" を生成します。

```bash
./certGen.sh create_root_and_intermediate 
```

```Powershell
New-CACertsCertChain rsa 
```

同様に、次のコマンドは、"デバイス CA 証明書" を生成します。

```bash
./certGen.sh create_edge_device_certificate "<gateway device name>"
```

```Powershell
New-CACertsEdgeDevice "<gateway device name>"
```

* これらのスクリプトに渡される**\<ゲートウェイ デバイス名\>** は、config.yaml の "hostname" パラメーターと同じにしては**いけません**。 説明したとおり、スクリプトと config.yaml の両方で同じ名前を使用してユーザーが Edge を設定した場合に、名前の競合を避けるために、スクリプトは**\<ゲートウェイ デバイス名\>** に ".ca" 文字列を追加することで、問題を回避します。ただし、ベスト プラクティスは、同じ名前の使用を避けることです。

>[!Tip]
> IoT Edge 経由で IoT デバイス SDK を使用するデバイス IoT の "リーフ" デバイスとアプリケーションに接続するには、デバイスの接続文字列の末尾にオプションの GatewayHostName パラメーターを追加する必要があります。 Edge Hub サーバー証明書が生成されるときは、config.yaml からの小文字バージョンのホスト名に基づくため、名前が一致して TLS 証明書の検証を通過するように、GatewayHostName パラメーターを小文字で入力する必要があります。

## <a name="example-of-iot-edge-certificate-hierarchy"></a>IoT Edge 証明書の階層の例

この証明書のパスを例示すために、次のスクリーンショットは、透過的ゲートウェイとして稼働している IoT Edge デバイスの設定に基づいています。 OpenSSL は、Edge Hub に接続するために使用され、証明書を検証して、ダンプ出力しています。

![各レベルでの証明書階層のスクリーンショット](./media/iot-edge-certs/iotedge-cert-chain.png)

スクリーンショットに表示された証明書の階層の深さを確認できます。

| ルート CA 証明書         | Azure IoT Hub の CA 証明書テストのみ                                                                           |
|-----------------------------|-----------------------------------------------------------------------------------------------------------|
| 中間 CA 証明書 | Azure IoT Hub の中間証明書テストのみ                                                                 |
| デバイス CA 証明書       | iotgateway.ca ("iotgateway" は、< ゲートウェイ ホスト名> として、便利なスクリプトに渡されました)      |
| ワークロード CA 証明書     | iotedge のワークロード CA                                                                                       |
| Edge Hub サーバー証明書 | iotedgegw.local (config.yaml からの 'hostname' と一致する)                                                |

## <a name="next-steps"></a>次の手順

[Azure IoT Edge モジュールについて](iot-edge-modules.md)

[透過的なゲートウェイとして機能するように IoT Edge デバイスを構成](how-to-create-transparent-gateway.md)します。