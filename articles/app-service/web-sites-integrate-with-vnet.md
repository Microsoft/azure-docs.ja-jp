---
title: Azure Virtual Network とのアプリの統合
description: Azure App Service を Azure Virtual Network と統合する方法およびアプリを仮想ネットワークに接続する方法について説明します。
author: ccompy
ms.assetid: 90bc6ec6-133d-4d87-a867-fcf77da75f5a
ms.topic: article
ms.date: 08/21/2019
ms.author: ccompy
ms.custom: fasttrack-edit
ms.openlocfilehash: 472fe621fc7a95317f143ef96a1d7f8b5adfe581
ms.sourcegitcommit: 21e33a0f3fda25c91e7670666c601ae3d422fb9c
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/05/2020
ms.locfileid: "77016971"
---
# <a name="integrate-your-app-with-an-azure-virtual-network"></a>アプリを Azure 仮想ネットワークに統合する
このドキュメントでは、Azure App Service の仮想ネットワーク統合機能と、それを [Azure App Service](https://go.microsoft.com/fwlink/?LinkId=529714) のアプリで設定する方法について説明します。 [Azure Virtual Network][VNETOverview] (VNet) を使用すると、多くの Azure リソースをインターネットでルーティングできないネットワークに配置できます。  

Azure App Service には、次の 2 つのバリエーションがあります。 

1. Isolated を除くすべての価格プランをサポートするマルチテナント システム
2. VNet にデプロイされ、Isolated 価格プランのアプリをサポートする App Service Environment (ASE)

このドキュメントでは、マルチテナント App Service で使用される 2 つの VNet 統合機能について説明します。 アプリが [App Service Environment][ASEintro] 内にある場合、そのアプリは既に VNet 内に存在するため、同じ VNet 内のリソースに到達するために VNet 統合機能を使用する必要はありません。 App Service のすべてのネットワーク機能の詳細については、[App Service のネットワーク機能](networking-features.md)に関するページを参照してください。

VNet 統合機能には、次の 2 つの形式があります。

1. 1 つのバージョンでは、同じリージョン内の VNet との統合を有効にします。 この形式の機能では、同じリージョン内の VNet 内にサブネットが必要です。 この機能はまだプレビュー段階ですが、Windows アプリケーションの運用環境ワークロードではサポートされており、以下に注意点がいくつかあります。
2. もう 1 つのバージョンでは、他のリージョン内の VNet またはクラシック VNet との統合を有効にします。 このバージョンの機能では、VNet への Virtual Network ゲートウェイのデプロイが必要です。 これはポイント対サイト VPN ベースの機能であり、Windows アプリでのみサポートされています。

アプリが同時に使用できる VNet 統合機能の形式は 1 つだけです。 そのため、どちらの機能を使用すべきかが問題になります。 これらはどちらも多くの目的に使用できます。 ただし、明確な差別化要素を次に示します。

| 問題  | 解決策 | 
|----------|----------|
| 同じリージョン内の RFC 1918 アドレス (10.0.0.0/8、172.16.0.0/12、192.168.0.0/16) に到達する必要がある | リージョン Vnet 統合 |
| クラシック VNet または別のリージョン内の VNet にあるリソースに到達する必要がある | ゲートウェイが必要な Vnet 統合 |
| ExpressRoute にまたがる RFC 1918 エンドポイントに到達する必要がある | リージョン Vnet 統合 |
| サービス エンドポイントにまたがるリソースに到達する必要がある | リージョン Vnet 統合 |

どちらの機能を使用しても、ExpressRoute にまたがる RFC 1918 以外のアドレスに到達することはできません。 それを行うには、今のところ ASE を使用する必要があります。

リージョン Vnet 統合を使用しても、VNet がオンプレミスに接続されたり、サービス エンドポイントが構成されたりはしません。 それは別のネットワーク構成です。 リージョン Vnet 統合は単純に、アプリがこれらの接続の種類をまたがって呼び出しを行うことができるようにします。

使用されているバージョンには関係なく、Vnet 統合は Web アプリに仮想ネットワーク内のリソースへのアクセス権を付与しますが、仮想ネットワークから Web アプリへの受信プライベート アクセス権は付与しません。 プライベート サイト アクセスとは、Azure 仮想ネットワークなどプライベート ネットワークのみからアプリにアクセスできるようにすることです。 Vnet 統合は、アプリから VNet への送信呼び出しを行うためにのみ存在します。 

以下は、VNet 統合機能の特徴です。

* Standard、Premium、PremiumV2 いずれかの価格プランが必要 
* TCP と UDP をサポート
* App Service アプリや関数アプリで動作可能

以下に、VNet 統合でサポートされていないことの例を示します。

* ドライブのマウント
* AD 統合 
* NetBIOS

## <a name="regional-vnet-integration"></a>リージョン VNet 統合 

> [!NOTE]
> ピアリングは、Linux ベースの App Service ではまだ使用できません。
>

Vnet 統合がアプリと同じリージョン内の VNet で使用される場合は、少なくとも 32 個のアドレスを含む委任されたサブネットを使用する必要があります。 このサブネットは他のどの目的にも使用できません。 アプリから行われる送信呼び出しは、委任されたサブネット内のアドレスから行われます。 このバージョンの Vnet 統合を使用する場合、呼び出しは VNet 内のアドレスから行われます。 VNet 内のアドレスを使用すると、アプリは次のことが可能になります。

* サービス エンドポイントでセキュリティ保護されたサービスへの呼び出しを行う
* ExpressRoute 接続にまたがるリソースにアクセスする
* 接続されている VNet 内のリソースにアクセスする
* ExpressRoute 接続を含むピアリングされた接続にまたがるリソースにアクセスする

この機能はプレビュー段階にありますが、次の制限付きで、Windows アプリの運用ワークロードに対してサポートされます。

* RFC 1918 の範囲にあるアドレスにのみ到達できます。 これらは、10.0.0.0/8、172.16.0.0/12、192.168.0.0/16 アドレス ブロック内のアドレスです。
* グローバル ピアリング接続にまたがるリソースには到達できません。
* アプリから VNet に来るトラフィックに関するルートは設定できません。
* この機能は、PremiumV2 の App Service プランをサポートする新しい App Service スケール ユニットからのみ使用できます。 これは、アプリを PremiumV2 SKU で実行しなければならないということではなく、単に PremiumV2 オプションを使用できる App Service プランでアプリを実行する必要があるということに注意してください (これは、この VNet 統合機能も使用可能な新しいスケール ユニットであることを意味します)。
* 統合サブネットは、1 つの App Service プランでしか使用できません。
* この機能は、App Service Environment にある Isolated プランのアプリでは使用できません。
* この機能では、Resource Manager VNet 内に 32 個以上のアドレスを含む /27 である未使用のサブネットが必要です。
* アプリと VNet は同じリージョンに存在する必要があります。
* 統合アプリで VNet を削除することはできません。 まず、その統合を削除する必要があります。 
* App Service プランごとに 1 リージョンの VNet 統合のみを持つことができます。 同じ App Service プラン内の複数のアプリが同じ VNet を使用できます。 
* リージョン VNet 統合を使用しているアプリがあるときに、アプリまたは App Service プランのサブスクリプションを変更することはできません

App Service プランのインスタンスごとに 1 つのアドレスが使用されます。 アプリを 5 つのインスタンスにスケーリングした場合は、アドレスが 5 つ使用されます。 割り当てた後はサブネット サイズを変更できないため、アプリが到達する可能性のあるスケールに対応できるだけの十分な大きさを持つサブネットを使用する必要があります。 推奨されるサイズは、64 のアドレスを持つ /26 です。 App Service プランのサイズを変更していない場合、32 のアドレスを持つ /27 は Premium App Service プランの 20 個のインスタンスに対応します。 App Service プランをスケールアップまたはスケールダウンする場合は、短時間に 2 倍の数のアドレスが必要になります。 

別の App Service プランのアプリで、別の App Service プランのアプリから既に接続されている VNet に到達するようにしたい場合は、既存の VNet 統合によって使用されているものとは異なるサブネットを選択する必要があります。  

この機能は Linux でもプレビュー段階です。 同じリージョン内の Resource Manager VNet で VNet 統合機能を使用するには:

1. ポータルで [ネットワーク] の UI に移動します。 アプリが新機能を使用できる場合は、[VNet の追加 (プレビュー)] オプションが表示されます。  

   ![Vnet 統合を選択する][6]

1. **[Add VNet (preview)]\(VNet の追加 (プレビュー))** を選択します。  

1. 統合の対象にする Resource Manager VNet を選択し、新しいサブネットを作成するか、空の既存のサブネットを選択します。 統合は 1 分未満で完了します。 統合中にアプリは再起動されます。  統合が完了すると、統合対象の VNet に関する詳細と、この機能はプレビュー段階にあることを通らせる上部のバナーが表示されます。

   ![VNet とサブネットを選択する][7]

アプリが VNet に統合されると、そのアプリは VNet が構成されているのと同じ DNS サーバーを使用します。 

リージョン VNet 統合では、統合サブネットが Microsoft.Web に委任されている必要があります。  VNet 統合 UI では、Microsoft Web に対するサブネットが自動的に委任されます。 アカウントにこれを設定するための十分なネットワークのアクセス許可がない場合は、サブネットを委任するために、統合サブネットに属性を設定できるユーザーが必要になります。 統合サブネットを手動で委任するには、Azure Virtual Network サブネット UI にアクセスして、Microsoft.Web の委任を設定します。

VNet からアプリを切断するには、 **[切断]** を選択します。 これにより、Web アプリが再起動されます。 


#### <a name="web-app-for-containers"></a>Web App for Containers

Linux 上の App Service を組み込みイメージで使用する場合、リージョンの VNet 統合機能は追加の変更なしで機能します。 Web App for Containers を使用している場合は、VNet 統合を使用するために docker イメージを変更する必要があります。 docker イメージで、ハードコーディングされたポート番号を使用するのではなく、メイン Web サーバーのリスニング ポートとして PORT 環境変数を使用します。 PORT 環境変数は、コンテナーの起動時に App Service プラットフォームによって自動的に設定されます。 SSH を使用している場合は、リージョン VNet 統合を使用するときに SSH_PORT 環境変数で指定されたポート番号でリッスンするように SSH デーモンを構成する必要があります。

### <a name="service-endpoints"></a>サービス エンドポイント

新しい VNet 統合機能では、サービス エンドポイントを使用できます。  アプリでサービス エンドポイントを使用するには、新しい VNet 統合を使用し、選択した VNet に接続してから、統合に使用したサブネット上のサービス エンドポイントを構成します。 


### <a name="how-vnet-integration-works"></a>VNet 統合の動作

App Service 内のアプリは、worker ロールでホストされます。 Basic 以上の価格プランは、同じワーカー上で他の顧客のワークロードが実行されていない専用のホスティング プランです。 Vnet 統合は、委任されたサブネット内のアドレスで仮想インターフェイスをマウントすることによって機能します。 送信元アドレスは VNet 内に存在するため、VNet 内の VM と同様に、VNet 内または VNet 経由でほとんどの場所にアクセスできます。 ネットワークの実装は VNet 内の VM の実行とは異なるため、この機能の使用中に、一部のネットワーク機能はまだ使用できません。

![VNet 統合](media/web-sites-integrate-with-vnet/vnet-integration.png)

Vnet 統合が有効になっても、アプリは引き続き、通常と同じチャネル経由でインターネットへの送信呼び出しを行います。 アプリのプロパティ ポータルに一覧表示される送信アドレスは引き続き、そのアプリによって使用されるアドレスです。 アプリに関する変更は、サービス エンドポイントでセキュリティ保護されたサービスまたは RFC 1918 アドレスへの呼び出しが VNet に転送されることです。 

この機能は、ワーカーあたり 1 つの仮想インターフェイスのみをサポートします。  worker あたり 1 つの仮想インターフェイスは、App Service プランごとに 1 リージョンの VNet 統合があることを意味します。 同じ App Service プラン内のすべてのアプリが同じ Vnet 統合を使用できますが、アプリで追加の VNet に接続する必要がある場合は、別の App Service プランを作成する必要があります。 使用される仮想インターフェイスは、顧客が直接アクセスできるリソースではありません。

このテクノロジが動作する方法の性質のために、Vnet 統合で使用されるトラフィックは Network Watcher や NSG フロー ログには表示されません。  

## <a name="gateway-required-vnet-integration"></a>ゲートウェイが必要な VNet 統合 

ゲートウェイが必要な Vnet 統合機能の特徴は次のとおりです。

* Resource Manager またはクラシック VNet である場合は、任意のリージョン内の VNet に接続するために使用できます
* アプリは、一度に 1 つの VNet にのみ接続できます
* App Service プランでは、最大 5 つの VNet と統合できます 
* App Service プランで使用できる総数に影響を与えることなく、App Service プラン内の複数のアプリで同じ VNet を使用できます。  同じ App Service プラン内の同じ VNet を使用しているアプリが 6 つある場合、使用されている VNet は 1 つとしてカウントされます。 
* ポイント対サイト VPN を使用して構成されている Virtual Network ゲートウェイが必要です
* ゲートウェイに対する SLA により、99.9% の SLA をサポートします

この機能は、次のことをサポートしていません。
* Linux アプリでの使用
* ExpressRoute を越えてのリソースへのアクセス 
* サービス エンドポイントを越えてのリソースへのアクセス 

### <a name="getting-started"></a>作業の開始

ここでは、Web アプリを仮想ネットワークに接続する前に考慮する必要がある点について説明します。

* ターゲットの仮想ネットワークでは、アプリに接続するために、ルート ベースのゲートウェイによるポイント対サイト VPN が有効になっている必要があります。 
* VNet は、App Service プラン (ASP) と同じサブスクリプションにする必要があります。
* VNet と統合されるアプリケーションでは、その VNet に対して指定されている DNS を使用します。

### <a name="set-up-a-gateway-in-your-vnet"></a>VNet 内にゲートウェイを設定する ###

ポイント対サイトのアドレスを使用して構成されているゲートウェイが既にある場合は、VNet 統合とアプリとの構成を省略できます。  
ゲートウェイを作成するには:

1. VNet 内に[ゲートウェイ サブネットを作成][creategatewaysubnet]します。  

1. [VPN ゲートウェイを作成][creategateway]します。 VPN の種類はルート ベースを選択します。

1. [ポイント対サイト アドレスを設定][setp2saddresses]します。 ゲートウェイが Basic SKU 内にない場合は、ポイント対サイトの構成で IKEV2 を無効にする必要があり、SSTP を選択する必要があります。 アドレス空間は、RFC 1918 アドレス ブロック 10.0.0.0/8、172.16.0.0/12、192.168.0.0/16 内に存在する必要があります。

App Service の VNet 統合で使用するゲートウェイを作成しているだけの場合は、証明書をアップロードする必要はありません。 ゲートウェイの作成には 30 分かかることがあります。 ゲートウェイがプロビジョニングされるまで、アプリを VNet に統合することはできません。 

### <a name="configure-vnet-integration-with-your-app"></a>アプリで VNet 統合を構成する 

アプリで VNet 統合を有効にするには: 

1. Azure portal で目的のアプリに移動し、アプリの設定を開いて [ネットワーク] > [VNet 統合] と選択します。 どちらかの VNet 統合機能を使用するには、ASP が Standard SKU 以上に属している必要があります。 
 ![[VNet 統合] UI][1]

1. **[Add VNet]\(VNet の追加)** を選択します。 
 ![VNet 統合を追加する][2]

1. 目的の VNet を選択します。 
  ![目的の VNet を選択する][8]
  
この最後の手順の後にアプリが再起動されます。  

### <a name="how-the-gateway-required-vnet-integration-feature-works"></a>ゲートウェイが必要な Vnet 統合機能の動作

ゲートウェイが必要な Vnet 統合機能は、ポイント対サイト VPN テクノロジに基づいて構築されています。 ポイント対サイト テクノロジによって、ネットワーク アクセスを、アプリをホストしている仮想マシンのみに制限しています。 アプリは、ハイブリッド接続または VNet 統合を通してのみ、インターネットにトラフィックを送信するように制限されています。 

![VNet 統合の動作][3]

## <a name="managing-vnet-integration"></a>Vnet 統合の管理
VNet への接続と、VNet との接続の切断は、アプリ レベルの機能です。 複数のアプリをまたいで VNet 統合に影響する可能性がある操作は、App Service プラン レベルで行われます。 アプリ > [ネットワーク] > [Vnet 統合] ポータルから、VNet に関する詳細を取得できます。 特定の統合をその App Service プラン内のどのアプリが使用しているかを含め、同様の情報は ASP > [ネットワーク] > [Vnet 統合] ポータルの ASP レベルで確認できます。

 ![VNet の詳細][4]

Vnet 統合 UI で取得できる情報は、アプリと ASP ポータルの間で同じです。

* VNet 名 - 仮想ネットワーク UI へのリンク
* 場所 - VNet の場所が表示されます。 別の場所にある VNet と統合すると、アプリの待機時間の問題が発生する可能性があります。 
* 証明書の状態 - 証明書が App Service プランと VNet の間で同期しているかどうかが表示されます。
* ゲートウェイの状態 - ゲートウェイが必要な Vnet 統合を使用している場合は、ゲートウェイの状態を確認できます。
* VNet アドレス空間 - VNet の IP アドレス空間が表示されます。 
* ポイント対サイト アドレス空間 - VNet のポイント対サイト IP アドレス空間が表示されます。 ゲートウェイが必要な機能の使用中に VNet への呼び出しを行うと、アプリの送信元アドレスはこれらのアドレスのいずれかになります。 
* サイト対サイト アドレス空間 - サイト間 VPN を使用して、VNet をオンプレミスのリソースまたは他の VNet に接続できます。 その VPN 接続を使って定義されている IP 範囲は、ここに表示されます。
* DNS サーバー - ユーザーの VNet で構成されている DNS サーバーが表示されます。
* VNet にルーティングされる IP アドレス - VNet にトラフィックを誘導するためにルーティングされるアドレス ブロックが表示されます 

VNet 統合のアプリ ビューで実行できる操作は、現在接続されている VNet からアプリを切断する操作のみです。 VNet からアプリを切断するには、 **[切断]** を選択します。 VNet から切断すると、アプリは再起動されます。 切断によって VNet に変更は生じません。 サブネットやゲートウェイは削除されません。 その後で VNet を削除する場合は、まず VNet からアプリを切断し、ゲートウェイなどのそこに含まれているリソースを削除する必要があります。 

ASP VNet 統合 UI にアクセスするには、ASP UI を開き、 **[ネットワーク]** を選択します。  [VNet 統合] で、 **[Click here to configure]\(ここをクリックして構成)** を選択し、ネットワーク機能の状態 UI を開きます。

![ASP VNet 統合の情報][5]

ASP VNet 統合 UI には、ASP でアプリが使用しているすべての VNet が表示されます。 各 VNet の詳細を表示するには、目的の VNet をクリックします。 ここでは 2 つの操作を実行できます。

* **ネットワークを同期する**。 ネットワーク同期操作は、ゲートウェイに依存する VNet 統合機能のためにのみ存在します。 ネットワーク同期操作を実行すると、証明書とネットワークの情報が確実に同期されるようになります。VNet の DNS を変更する場合は、**ネットワークの同期**操作を実行する必要があります。 この操作によって、この VNet を使用しているすべてのアプリが再起動されます。
* **ルートを追加する** ルートを追加すると、送信トラフィックが VNet に誘導されます。

**ルーティング** VNet に定義されたルートは、アプリから VNet にトラフィックを転送するために使用されます。 VNet に追加の送信トラフィックを送信する必要がある場合は、ここでそれらのアドレス ブロックを追加できます。 この機能は、ゲートウェイが必要な Vnet 統合でのみ動作します。

**証明書** ゲートウェイが必要な Vnet 統合が有効になっている場合は、接続のセキュリティを確保するために証明書の交換が必要です。 証明書と共に、DNS の構成、ルート、ネットワークについて記述するその他の同様の情報があります。
証明書またはネットワーク情報が変更された場合は、[ネットワークの同期] をクリックする必要があります。 [ネットワークの同期] をクリックすると、アプリと VNet の間の接続が短時間途切れます。 アプリが再起動されていない間は、接続の途切れによって、サイトが正常に機能しなくなる可能性があります。 

## <a name="accessing-on-premises-resources"></a>オンプレミスのリソースへのアクセス
アプリは、サイト間接続がある Vnet と統合することで、オンプレミスのリソースにアクセスできます。 ゲートウェイが必要な Vnet 統合を使用している場合は、ポイント対サイト アドレス ブロックでオンプレミスの VPN ゲートウェイのルートを更新する必要があります。 サイト間 VPN が初めてセットアップされるときには、その構成に使用するスクリプトによって、ルートが正しくセットアップされるはずです。 サイト間 VPN を作成した後にポイント対サイト アドレスを追加する場合は、ルートを手動で更新する必要があります。 その詳しい手順はゲートウェイごとに異なるため、ここでは取り上げません。 BGP をサイト間 VPN 接続で構成することはできません。

VNet 経由でオンプレミスに到達するために、リージョン Vnet 統合機能に追加の構成は必要ありません。 必要なのは、単に ExpressRoute またはサイト間 VPN を使用して VNet をオンプレミスに接続することだけです。 

> [!NOTE]
> ゲートウェイが必要な Vnet 統合機能では、アプリは ExpressRoute ゲートウェイを含む VNet とは統合されません。 ExpressRoute ゲートウェイが[共存モード][VPNERCoex]で構成されている場合であっても、VNet 統合は機能しません。 ExpressRoute 接続経由でリソースにアクセスする必要がある場合は、VNet で実行されるリージョン VNet 統合機能または [App Service Environment][ASE] を使用できます。 
> 
> 

## <a name="peering"></a>ピアリング
リージョン Vnet 統合でピアリングを使用している場合、追加の構成を行う必要はありません。 

ゲートウェイが必要な Vnet 統合でピアリングを使用している場合は、いくつかの追加の項目を構成する必要があります。 アプリで動作するようにピアリングを構成するには:

1. アプリの接続先の VNet でピアリング接続を追加します。 ピアリング接続の追加時には、 **[仮想ネットワークアクセスを許可する]** を有効にして、 **[転送されたトラフィックを許可する]** チェック ボックスと **[ゲートウェイ転送を許可する]** チェック ボックスをオンにします。
1. 接続先の Vnet にピアリングされている VNet でピアリング接続を追加します。 対象の VNet でピアリング接続を追加するときには、 **[仮想ネットワークアクセスを許可する]** を有効にして、 **[転送されたトラフィックを許可する]** チェック ボックスと **[Allow remote gateways]\(リモート ゲートウェイを許可する)** チェック ボックスをオンにします。
1. ポータルで [App Service プラン] > [ネットワーク] > VNet 統合 UI と移動します。  アプリの接続先 VNet を選択します。 ルーティングのセクションで、アプリの接続先 VNet とピアリングされている VNet のアドレス範囲を追加します。  


## <a name="pricing-details"></a>価格の詳細
リージョン Vnet 統合機能には、ASP の価格レベルの料金を超える追加の使用料金はありません。

ゲートウェイが必要な Vnet 統合機能の使用に関連する料金には、次の 3 つがあります。

* ASP の価格レベルの料金 - アプリは Standard、Premium、または PremiumV2 の App Service プランに属している必要があります。 これらのコストの詳細については、「[App Service の価格][ASPricing]」を参照してください。 
* データ転送のコスト - VNet が同じデータ センター内に存在する場合でも、データ エグレスの料金が発生します。 これらの料金は、「[帯域幅の料金詳細][DataPricing]」で説明されています。 
* VPN Gateway のコスト - ポイント対サイト VPN に必要な VNet ゲートウェイに対してコストが発生します。 これらの詳細は、「[VPN Gateway の価格][VNETPricing]」のページに記載されています。


## <a name="troubleshooting"></a>トラブルシューティング
この機能は簡単にセットアップできるものの、問題が発生しないわけではありません。 目的のエンドポイントへのアクセスに関して問題が発生した場合は、アプリのコンソールからの接続テストに、いくつかのユーティリティを利用できます。 利用できるコンソールが 2 つあります。 1 つは Kudu コンソールで、もう 1 つは Azure portal 内のコンソールです。 アプリから Kudu コンソールにアクセスするには、[ツール]、[Kudu] の順に移動します。 [サイト名].scm.azurewebsites.net で Kudo コンソールにアクセスすることもできます。 Web サイトが読み込まれたら、[デバッグ コンソール] タブに移動します。Azure ポータルにホストされたコンソールにアクセスするには、アプリで [ツール]、[コンソール] の順に移動します。 

#### <a name="tools"></a>ツール
**ping**、**nslookup**、**tracert** の各ツールは、セキュリティの制約により、コンソールから使用することはできません。 それを補うために、2 つの独立したツールが追加されています。 DNS 機能のテスト用に、nameresolver.exe という名前のツールを追加しました。 の構文は次のとおりです。

    nameresolver.exe hostname [optional: DNS Server]

**nameresolver** を使用すると、アプリが依存しているホスト名を確認できます。 この方法で、DNS の構成に誤りがあるかどうかや、DNS サーバーへのアクセス権がないかどうかをテストできます。 環境変数 WEBSITE_DNS_SERVER と WEBSITE_DNS_ALT_SERVER を調べることによって、アプリが使用する DNS サーバーをコンソールで確認できます。

次のツールでは、ホストとポートを組み合わせたものへの TCP 接続をテストすることができます。 このツールは **tcpping** という名前で、構文は次のとおりです。

    tcpping.exe hostname [optional: port]

**tcpping** ユーティリティを使用すると、特定のホストとポートにアクセスできるかどうかがわかります。 成功として示されるのは、ホストとポートの組み合わせでリッスンしているアプリケーションがあり、アプリから指定のホストとポートへのネットワーク アクセスがある場合のみです。

#### <a name="debugging-access-to-vnet-hosted-resources"></a>VNet にホストされたリソースへのアクセスのデバッグ
アプリから特定のホストとポートへのアクセスは、さまざまな要因によって妨げられる可能性があります。 ほとんどの場合、次の 3 つのうちのいずれかです。

* **ファイアウォールがルートを塞いでいる。** ルートを塞いでいるファイアウォールがあると、TCP のタイムアウトに達します。 この場合の TCP タイムアウトは 21 秒です。 **tcpping** ツールを使用して接続をテストします。 TCP タイムアウトの原因は、ファイアウォール以外にさまざまなことが考えられますが、まずここから始めます。 
* **DNS にアクセスできない。** DNS タイムアウトは、DNS サーバーごとに 3 秒です。 2 つの DNS サーバーがある場合、タイムアウトは 6 秒です。 nameresolver を使用して、DNS が機能しているかどうかを確認します。 nslookup は使用できないことに注意してください。これは、nslookup が VNet の構成に使用されている DNS を使用しないためです。 アクセスできない場合は、ファイアウォールが存在するか、NSG が DNS へのアクセスをブロックしているか、または DNS が停止している可能性があります。

これらの項目が問題の回答になっていない場合は、まず次のような点を確認してください。 

**リージョン Vnet 統合**
* 送信先は RFC 1918 アドレスか。
* 統合サブネットからのエグレスをブロックしている NSG は存在するか。
* ExpressRoute または VPN をまたがって移動する場合は、オンプレミスのゲートウェイがトラフィック バックアップを Azure にルーティングするように構成されているか。 VNet 内のエンドポイントには到達できるが、オンプレミスに到達できない場合は、これを確認することをお勧めします。

**ゲートウェイが必要な Vnet 統合**
* ポイント対サイトのアドレス範囲が RFC 1918 の範囲 (10.0.0.0-10.255.255.255/172.16.0.0-172.31.255.255/192.168.0.0-192.168.255.255) にあるか。
* ゲートウェイはポータルに稼働中と表示されているか。 ゲートウェイがダウンしている場合は、再起動してください。
* 証明書は同期していると表示されているか。または、ネットワーク構成が変更されたことが疑われるか。  証明書が同期していないか、または ASP と同期していない VNet 構成への変更が行われたことが疑われる場合は、[ネットワークの同期] をクリックします。
* ExpressRoute または VPN をまたがって移動する場合は、オンプレミスのゲートウェイがトラフィック バックアップを Azure にルーティングするように構成されているか。 VNet 内のエンドポイントには到達できるが、オンプレミスに到達できない場合は、これを確認することをお勧めします。

ホストとポートの特定の組み合わせへのアクセスを何がブロックしているかを確認できないため、ネットワークに関する問題のデバッグは課題です。 以下に原因の例を示します。

* ホスト上で稼働しているファイアウォールが、ポイント対サイト IP の範囲からアプリケーション ポートへのアクセスを妨げている。 サブネットの境界を越えるには、多くの場合パブリック アクセスが必要になります。
* ターゲット ホストがダウンしている
* アプリケーションがダウンしている
* IP またはホスト名が誤っている
* アプリケーションが予期しないポートでリッスンしている。 エンドポイント ホストで "netstat-aon" を使用することで、プロセス ID と、リッスンしているポートを一致させることができます。 
* ネットワーク セキュリティ グループが、ポイント対サイト IP の範囲からアプリケーション ホストとポートへのアクセスをブロックするように構成されている

アプリが実際にどのようなアドレスを使用するかは認識できないことに注意してください。 統合サブネットまたはポイント対サイトのアドレス範囲内の任意のアドレスである可能性があるため、アドレス範囲全体からのアクセスを許可する必要があります。 

追加のデバッグ手順は次のとおりです。

* VNet 内の VM に接続し、そこからリソースのホスト:ポートへのアクセスを試します。 TCP アクセスのテストには、PowerShell コマンド **test-netconnection** を使用します。 の構文は次のとおりです。

      test-netconnection hostname [optional: -Port]

* VM 上でアプリケーションを起動し、**tcpping** を使用して、アプリのコンソールからそのホストとポートへのアクセスをテストします。

#### <a name="on-premises-resources"></a>オンプレミスのリソース ####

アプリがオンプレミスのリソースにアクセスできない場合は、VNet からリソースにアクセスできるかどうかを確認します。 TCP アクセスを確認するには、PowerShell コマンド **test-netconnection** を使用します。 VM がオンプレミス リソースに到達できない場合は、VPN または ExpressRoute 接続が正しく構成されていない可能性があります。

VNet でホストされている VM はオンプレミス システムにアクセスでき、アプリはアクセスできない場合、以下の理由のいずれかが原因と考えられます。

* オンプレミスのゲートウェイで、ルートがサブネットまたはポイント対サイトのアドレス範囲で構成されていない。
* ネットワーク セキュリティ グループが、ポイント対サイト IP 範囲へのアクセスをブロックしている。
* オンプレミスのファイアウォールが、ポイント対サイト IP 範囲からのトラフィックをブロックしている。
* リージョン Vnet 統合機能を使用して、RFC 1918 以外のアドレスに到達しようとしている。


## <a name="powershell-automation"></a>PowerShell オートメーション

App Service は、PowerShell を使用して Azure 仮想ネットワークと統合できます。 すぐに使用できるスクリプトについては、「[Connect an app in Azure App Service to an Azure Virtual Network (Azure App Service のアプリを Azure 仮想ネットワークに接続する)](https://gallery.technet.microsoft.com/scriptcenter/Connect-an-app-in-Azure-ab7527e3)」をご覧ください。


<!--Image references-->
[1]: ./media/web-sites-integrate-with-vnet/vnetint-app.png
[2]: ./media/web-sites-integrate-with-vnet/vnetint-addvnet.png
[3]: ./media/web-sites-integrate-with-vnet/vnetint-howitworks.png
[4]: ./media/web-sites-integrate-with-vnet/vnetint-details.png
[5]: ./media/web-sites-integrate-with-vnet/vnetint-aspdetails.png
[6]: ./media/web-sites-integrate-with-vnet/vnetint-newvnet.png
[7]: ./media/web-sites-integrate-with-vnet/vnetint-newvnetdetails.png
[8]: ./media/web-sites-integrate-with-vnet/vnetint-selectvnet.png

<!--Links-->
[VNETOverview]: https://azure.microsoft.com/documentation/articles/virtual-networks-overview/ 
[AzurePortal]: https://portal.azure.com/
[ASPricing]: https://azure.microsoft.com/pricing/details/app-service/
[VNETPricing]: https://azure.microsoft.com/pricing/details/vpn-gateway/
[DataPricing]: https://azure.microsoft.com/pricing/details/data-transfers/
[V2VNETP2S]: https://azure.microsoft.com/documentation/articles/vpn-gateway-howto-point-to-site-rm-ps/
[ASEintro]: environment/intro.md
[ILBASE]: environment/create-ilb-ase.md
[V2VNETPortal]: ../vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal.md
[VPNERCoex]: ../expressroute/expressroute-howto-coexist-resource-manager.md
[ASE]: environment/intro.md
[creategatewaysubnet]: ../vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal.md#creategw
[creategateway]: https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal#creategw
[setp2saddresses]: https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal#addresspool
