---
title: リモート デスクトップでグラフィックスのパフォーマンスの問題を診断する - Azure
description: この記事では、リモート デスクトップ プロトコル セッションで RemoteFX グラフィックス カウンターを使用して、Windows Virtual Desktop のグラフィックスに関するパフォーマンスの問題を診断する方法について説明します。
services: virtual-desktop
author: chjenk
ms.service: virtual-desktop
ms.topic: troubleshooting
ms.date: 05/23/2019
ms.author: v-chjenk
ms.openlocfilehash: a139542bf9272336784ac96d667d65caa1ed96ff
ms.sourcegitcommit: f10ae7078e477531af5b61a7fe64ab0e389830e8
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/05/2019
ms.locfileid: "67607331"
---
# <a name="diagnose-graphics-performance-issues-in-remote-desktop"></a>リモート デスクトップでグラフィックスのパフォーマンスの問題を診断する

システムが想定どおりに機能しない場合は、問題の原因を特定することが重要です。 この記事は、リモート デスクトップ プロトコル (RDP) セッション中のグラフィックス関連のパフォーマンスのボトルネックを特定し、解決するために役立ちます。

## <a name="find-your-remote-session-name"></a>リモート セッション名を確認する

グラフィックスのパフォーマンス カウンターを特定するにはリモート セッション名が必要です。 このセクションの指示に従って、Windows Virtual Desktop プレビューのリモート セッション名を特定します。

1. リモート セッションから Windows のコマンド プロンプトを開きます。
2. **qwinsta** コマンドを実行します。
    - セッションがマルチセッション仮想マシン (VM) でホストされている場合:各カウンター名のサフィックスは、"rdp-tcp 37" のように、セッション名と同じサフィックスです。
    - セッションが仮想グラフィックス処理装置 (vGPU) をサポートする VM でホストされている場合:カウンターは、VM ではなくサーバーに格納されます。 カウンター インスタンスには、"Win8 Enterprise VM" のように、セッション名の番号ではなく VM 名が含まれます。

>[!NOTE]
> カウンターの名前には RemoteFX がありますが、vGPU のシナリオにはリモート デスクトップ グラフィックスも含まれます。

## <a name="access-performance-counters"></a>パフォーマンス カウンターへのアクセス

RemoteFX グラフィックスのパフォーマンス カウンターは、フレームのエンコード時間やスキップされたフレームなどを追跡することで、ボトルネックを検出するために役立ちます。

リモート セッション名を決定したら、次の手順に従ってリモート セッションの RemoteFX Gグラフィックス パフォーマンス カウンターを収集します。

1. **[スタート]**  >  **[管理ツール]**  >  **[パフォーマンス モニター]** を選択します。
2. **[パフォーマンス モニター]** ダイアログ ボックスで **[監視ツール]** を展開し、 **[パフォーマンス モニター]** を選択してから **[追加]** を選択します。
3. **[カウンターの追加]** ダイアログ ボックスで、 **[使用可能なカウンター]** 一覧から、RemoteFX グラフィックスのパフォーマンス カウンター オブジェクトを展開します。
4. 監視するカウンターを選択します。
5. **[選択したオブジェクトのインスタンス]** 一覧で、選択されているカウンターについて監視する特定のインスタンスを選択してから、 **[追加]** を選択します。 使用できるすべてのカウンター インスタンスを選択するには、 **[すべてのインスタンス]** を選択します。
6. カウンターを追加したら、 **[OK]** を選択します。

選択したパフォーマンス カウンターが [パフォーマンス モニター] 画面に表示されます。

>[!NOTE]
>ホスト上の各アクティブ セッションには、各パフォーマンス カウンターの独自のインスタンスがあります。

## <a name="diagnosis"></a>診断

グラフィックス関連のパフォーマンスの問題は、通常 4 つのカテゴリに分類されます。

- 低フレーム レート
- ランダムな失速
- 長い入力の待機時間
- 低フレーム品質

まず、低フレーム レート、ランダムな失速、長い入力の待機時間への対処から始めます。 次のセクションでは、各カテゴリを測定しているパフォーマンス カウンターについて説明します。

### <a name="performance-counters"></a>パフォーマンス カウンター

このセクションは、ボトルネックを特定するために役立ちます。

まず [Output Frames/Second]\(出力フレーム/秒\) カウンターを確認します。 これによって、クライアントから使用できたフレーム数が測定されます。 この値が [Input Frames/Second]\(入力フレーム/秒\) カウンターよりも小さい場合、フレームはスキップされています。 ボトルネックを特定するには、[Frames Skipped/Second]\(スキップされたフレーム/秒\) カウンターを使用します。

[Frames Skipped/Second]\(スキップされたフレーム/秒\) カウンターには次の 3 つの種類があります。

- Frames Skipped/Second (Insufficient Network Resources) (スキップされたフレーム/秒 (ネットワーク リソース不足))
- Frames Skipped/Second (Insufficient Client Resources) (スキップされたフレーム/秒 (クライアント リソース不足))
- Frames Skipped/Second (Insufficient Server Resources) (スキップされたフレーム/秒 (サーバー リソース不足))

いずれかの [Frames Skipped/Second]\(スキップされたフレーム/秒\) カウンターが高い値の場合、カウンターが追跡するリソースに関連する問題であることを意味します。 たとえば、サーバーがフレームを提供するレートと同じレートでクライアントがフレームをデコードおよび表示していない場合、[Frames Skipped/Second (Insufficient Client Resources)]\(スキップされたフレーム/秒 (クライアント リソース不足)\) カウンターが高くなります。

[Frames Skipped/Second]\(スキップされたフレーム/秒\) カウンターが [Input Frames/Second]\(入力フレーム/秒\) カウンターと一致していても、異常な遅延や失速がある場合は、[Average Encoding Time]\(平均エンコード時間\) が問題になる可能性があります。 エンコードは、シングルセッション (vGPU) シナリオではサーバー上で、マルチセッション シナリオでは VM 上で発生する同期プロセスです。 [Average Encoding Time]\(平均エンコード時間\) は 33 ミリ秒未満になるようにします。 [Average Encoding Time]\(平均エンコード時間\) が 33 ミリ秒未満でも、パフォーマンスの問題がある場合は、使用しているアプリまたはオペレーティング システムに問題がある可能性があります。

アプリ関連の問題の診断の詳細については、[[User Input Delay]\(ユーザー入力の遅延\) パフォーマンス カウンター](https://docs.microsoft.com/windows-server/remote/remote-desktop-services/rds-rdsh-performance-counters)に関する記事を参照してください。

RDP は 33 ミリ秒の [Average Encoding Time]\(平均エンコード時間\) をサポートしているので、最大 30 フレーム/秒の入力フレーム レートをサポートします。 33 ミリ秒がサポートされる最大フレーム レートであることに注意してください。 多くの場合、ソースから RDP にフレームが提供される頻度に応じて、ユーザーが経験するフレーム レートは低くなります。 たとえば、ビデオ鑑賞などのタスクには 30 フレーム/秒の完全な入力フレーム レートが必要ですが、Word ドキュメントの編集頻度が低いなど、リソース使用量の少ないタスクでは、ユーザー エクスペリエンスを向上させるためにそれほど高い入力フレーム レートは必要ありません。

フレーム品質の問題を診断するには、[Frame Quality]\(フレーム品質\) カウンターを使用します。 このカウンターは、ソース フレームの品質に対する出力フレームの品質をパーセンテージで表します。 品質の低下は、RemoteFX が原因か、グラフィックス ソースに固有のものである可能性があります。 RemoteFX が品質の低下の原因である場合、問題は、より忠実度の高いコンテンツを送信できるネットワークまたはサーバー リソースの不足である可能性があります。

## <a name="mitigation"></a>対応策

サーバー リソースがボトルネックの原因である場合は、次のいずれかを試してパフォーマンスを向上させます。

- ホストあたりのセッション数を減らします。
- サーバー上のメモリとコンピューティング リソースを増やします。
- 接続の解像度を下げます。

ネットワーク リソースがボトルネックの原因である場合は、次のいずれかを試して、セッションあたりのネットワークの可用性を向上させます。

- ホストあたりのセッション数を減らします。
- 接続の解像度を下げます。
- より広い帯域幅のネットワークを使用します。

クライアント リソースがボトルネックの原因である場合は、次のいずれかまたは両方を実行してパフォーマンスを向上させます。

- 最新のリモート デスクトップ クライアントをインストールします。
- クライアント マシン上のメモリとコンピューティング リソースを増やします。

> [!NOTE]
> 現在、[Source Frames/Second]\(ソース フレーム/秒\) カウンターはサポートされていません。 現在のところ、[Source Frames/Second]\(ソース フレーム/秒\) カウンターは常に 0 に設定されます。

## <a name="next-steps"></a>次の手順

- GPU が最適化された Azure 仮想マシンを作成するには、「[Windows Virtual Desktop プレビュー用にグラフィックス処理装置 (GPU) のアクセラレーションを構成する](https://docs.microsoft.com/azure/virtual-desktop/configure-vm-gpu)」を参照してください。
- トラブルシューティングとエスカレーション トラックの概要については、「[トラブルシューティングの概要、フィードバック、サポート](https://docs.microsoft.com/azure/virtual-desktop/troubleshoot-set-up-overview)」を参照してください。
- プレビュー サービスの詳細については、「[Windows Virtual Desktop プレビュー環境](https://docs.microsoft.com/azure/virtual-desktop/environment-setup)」を参照してください。
