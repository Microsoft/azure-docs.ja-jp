---
title: Azure NetApp Files のスナップショットのしくみ | Microsoft Docs
description: スナップショットを作成する方法、スナップショットを復元する方法、リージョン間レプリケーション設定でスナップショットを使用する方法など、Azure NetApp Files のスナップショットのしくみについて説明します。
services: azure-netapp-files
documentationcenter: ''
author: b-juche
manager: ''
editor: ''
ms.assetid: ''
ms.service: azure-netapp-files
ms.workload: storage
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: conceptual
ms.date: 02/05/2021
ms.author: b-juche
ms.openlocfilehash: 526ef0af08833954aef4136716930cec0df40eea
ms.sourcegitcommit: 59cfed657839f41c36ccdf7dc2bee4535c920dd4
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/06/2021
ms.locfileid: "99625249"
---
# <a name="how-azure-netapp-files-snapshots-work"></a>Azure NetApp Files のスナップショットのしくみ

この記事では、Azure NetApp Files のスナップショットのしくみについて説明します。 Azure NetApp Files のスナップショット テクノロジにより、パフォーマンスに影響せずに安定性、スケーラビリティ、高速回復性が実現します。 Azure NetApp Files のスナップショット テクノロジは、1 つのファイルの復元、ボリュームの復元と複製、リージョン間のレプリケーションなど、データ保護ソリューションの基盤を提供します。 

ボリューム スナップショットの使用手順については、「[Azure NetApp Files を使用してスナップショットを管理する](azure-netapp-files-manage-snapshots.md)」を参照してください。 リージョン間レプリケーションでのスナップショット管理に関する考慮事項については、「[リージョン間レプリケーションを使用するための要件と考慮事項](cross-region-replication-requirements-considerations.md)」を参照してください。

## <a name="what-volume-snapshots-are"></a>ボリューム スナップショットとは  

Azure NetApp Files のスナップショットは、特定の時点のファイル システム (ボリューム) のイメージです。 これは、理想的なオンライン バックアップとして使用できます。 スナップショットを使用すると、[新しいボリュームの作成](azure-netapp-files-manage-snapshots.md#restore-a-snapshot-to-a-new-volume)、[ファイルの復元](azure-netapp-files-manage-snapshots.md#restore-a-file-from-a-snapshot-using-a-client)、[ボリュームを元に戻すこと](azure-netapp-files-manage-snapshots.md#revert-a-volume-using-snapshot-revert)が可能です。 Azure NetApp Files ボリュームに保存されている特定のアプリケーション データでは、アプリケーションの整合性を確保するために追加の手順が必要になることがあります。  

基盤となるボリューム仮想化テクノロジ (Azure NetApp Files の一部) の固有の機能によって、オーバーヘッドの少ないスナップショットを実現できます。 データベースと同様に、このレイヤーでは、ディスク上の実際のデータ ブロックへのポインターが使用されます。 ただし、データベースとは異なり、既存のブロックは書き換えられません。更新されたデータは新しいブロックに書き込まれ、ポインターが変更されます。 Azure NetApp Files のスナップショットでは、単にブロック ポインターが操作され、ボリュームの "固定された" 読み取り専用ビューが作成されます。これにより、アプリケーションは、特別なプログラミングなしで、古いバージョンのファイルやディレクトリ階層にアクセスできます。 実際のデータ ブロックはコピーされません。 そのため、スナップショットは、作成に必要な時間に関して効率的であり、ボリューム サイズに関係なく、ほぼ瞬時に完了します。 スナップショットは、記憶域スペースに関しても効率的です。 それら自体はスペースを消費せず、スナップショットとアクティブ ボリューム間の差分ブロックのみが保持されます。 

次の図は、その概念を示しています。  

![スナップショットの主要な概念を示す図](../media/azure-netapp-files/snapshot-concepts.png)

この図では、図 1a でスナップショットが作成されています。 図 1b では、変更されたデータが "*新しいブロック*" に書き込まれ、ポインターが更新されています。 ただし、スナップショット ポインターは引き続き "*以前に書き込まれたブロック*" を指すため、データのライブおよび履歴ビューが得られます。 図 1c では、別のスナップショットが作成されています。 これで、3 つの完全なコピーに必要なボリューム領域を占有することなく、3 世代のデータ (ライブ データ、スナップショット 2、およびスナップショット 1 (経過時間順)) にアクセスできます。 

スナップショットでは、ボリューム メタデータ ("*inode テーブル*") のコピーのみが作成されます。 ボリュームのサイズ、使用されている容量、ボリュームのアクティビティのレベルに関係なく、作成には数秒しかかかりません。 そのため、100-TiB のボリュームのスナップショットを作成するのにかかる時間は、100-GiB のボリュームのスナップショットを作成するのもかかる時間と同じ (ほぼゼロ) です。 スナップショットが作成された後、データ ファイルへの変更は、通常どおり、アクティブなバージョンのファイルに反映されます。

一方、スナップショットからポイントされているデータ ブロックは変更されません。 Azure NetApp Files ボリュームの "書き込み時のリダイレクト" の性質により、スナップショットではパフォーマンスのオーバーヘッドは発生せず、それ自体は領域を消費しません。 時間の経過に伴いボリュームごとに最大 255 のスナップショットを保存でき、そのすべてに読み取り専用およびオンライン バージョンのデータとしてアクセス可能であり、各スナップショット間で変更されたブロック数と同程度の容量しか消費されません。 変更されたブロックは、アクティブなボリュームに保存されます。 スナップショットでポイントされているブロックは、保護のためにボリュームに (読み取り専用として) 保持され、(アクティブなボリュームおよびスナップショットの) すべてのポインターがクリアされている場合にのみ再利用されます。 そのため、スナップショットで保持される新しいデータ ブロックまたは (変更された) データ ブロックにより、時間の経過に伴いボリューム使用率が増加します。

 次の図は、ボリュームのスナップショットと、時間の経過に伴い使用されるスペースを示しています。 

![ボリュームのスナップショットと、時間の経過に伴い使用されるスペースを示す図](../media/azure-netapp-files/snapshots-used-space-over-time.png)

ボリューム スナップショットでは、最新のスナップショット以降のブロックの変更のみが記録されるため、次のような主な利点があります。

* スナップショットは "***ストレージ効率に優れています***"。   
    スナップショットでは、ボリューム全体のデータ ブロックはコピーされないため、消費される記憶域スペースは最小限です。 順番に作成された 2 つのスナップショットの相違点は、2 つの間の時間間隔で追加または変更されたブロックのみです。 このブロック増分動作によって、関連するストレージ容量の消費を抑えることができます。 他の多くのスナップショットの実装では、アクティブなファイル システムと同等のストレージ ボリュームが消費されるため、ストレージ容量の要件が高くなります。 アプリケーションの毎日の "*ブロック レベル*" の変更率によっては、Azure NetApp Files スナップショットの消費容量は増減しますが、これは変更されたデータにのみ基づきます。 1 日あたりの平均スナップショット消費量の範囲は、多くのアプリケーション ボリュームで使用されるボリューム容量の 1% から 5% が下限で、SAP HANA データベース ボリュームなどのボリュームの 20 % から 30% が上限です。 必ず[ボリュームとスナップショットの使用量を監視して](azure-netapp-files-metrics.md#volumes)、作成され保持されているスナップショットの数と比較してスナップショットの容量消費を確認してください。   

* スナップショットは "***すばやく作成、レプリケート、復元、複製***" できます。   
    ボリュームのサイズとアクティビティのレベルに関係なく、スナップショットの作成、レプリケート、復元、複製には数秒しかかかりません。 ボリュームのスナップショットは[オンデマンド](azure-netapp-files-manage-snapshots.md#create-an-on-demand-snapshot-for-a-volume)で作成できます。 また、[スナップショット ポリシー](azure-netapp-files-manage-snapshots.md#manage-snapshot-policies)を使用して、Azure NetApp Files でスナップショットを自動的に作成するタイミングと、ボリュームに対して保持するスナップショットの数を指定できます。  アプリケーション層でスナップショットを調整することで、アプリケーションの整合性を維持できます。たとえば、SAP HANA には [AzAcSnap ツール](azacsnap-introduction.md)を使用します。

* スナップショットは、ボリュームの "***パフォーマンス***" には影響しません。   
    基盤テクノロジの "書き込み時のリダイレクト" の性質により、Azure NetApp Files スナップショットを保存または保持してもパフォーマンスには影響しません。これは、大量のデータ アクティビティがあっても同様です。 また、スナップショットを削除しても、多くの場合、パフォーマンスにはほとんど影響しません。 

* スナップショットは頻繁に作成でき、多く保持できるため、"***スケーラビリティ***" が提供されます。   
    Azure NetApp Files ボリュームでは、最大 255 個のスナップショットがサポートされます。 少ない影響で多数のスナップショットを頻繁に作成して保存できるため、必要なバージョンのデータを正常に回復できる可能性が高くなります。

* スナップショットでは、"**ユーザーの可視性**" と "_ファイルの回復性_" が提供されます。   
Azure NetApp Files スナップショット テクノロジはパフォーマンス、スケーラビリティ、安定性が高いため、ユーザー主導の回復のための最適なオンライン バックアップが提供されます。 スナップショットは、ファイル、ディレクトリ、またはボリュームの復元を目的として、ユーザーがアクセスできるようにすることができます。 追加のソリューションを使用すると、保持またはディザスター リカバリーの目的で、バックアップをオフライン ストレージにコピーすることや、[リージョン間でレプリケート](cross-region-replication-introduction.md)することができます。

## <a name="ways-to-create-snapshots"></a>スナップショットを作成する方法   

いくつかの方法を使用して、スナップショットを作成および管理できます。

* 手動 (オンデマンド)。次のものを使用:   
    * [Azure portal](azure-netapp-files-manage-snapshots.md#create-an-on-demand-snapshot-for-a-volume)、[REST API](/rest/api/netapp/snapshots)、[Azure CLI](/cli/azure/netappfiles/snapshot)、または [PowerShell](/powershell/module/az.netappfiles/new-aznetappfilessnapshot) ツール
    * スクリプト ([例](azure-netapp-files-solution-architectures.md#sap-tech-community-and-blog-posts)を参照)

* 自動。次のものを使用:
    * [Azure portal](azure-netapp-files-manage-snapshots.md#manage-snapshot-policies)、[REST API](/rest/api/netapp/snapshotpolicies)、[Azure CLI](/cli/azure/netappfiles/snapshot/policy)、または [PowerShell](/powershell/module/az.netappfiles/new-aznetappfilessnapshotpolicy) ツールによるスナップショット ポリシー
    * [AzAcSnap](azacsnap-introduction.md) などのアプリケーション整合性スナップショット ツール

## <a name="how-volumes-and-snapshots-are-replicated-cross-region-for-dr"></a>DR のためにボリュームとスナップショットをリージョン間でレプリケートする方法  

Azure NetApp Files は、ディザスター リカバリー (DR) の目的で[リージョン間レプリケーション](cross-region-replication-introduction.md)をサポートしています。 Azure NetApp Files のリージョン間レプリケーションでは、SnapMirror テクノロジが使用されます。 変更されたブロックだけが、圧縮された効率的な形式でネットワーク経由で送信されます。 ボリューム間でのリージョン間レプリケーションを開始すると、ボリュームの内容全体 (つまり、実際に保存されているデータ ブロック) が 1 回だけ転送されます。 この操作は "*ベースライン転送*" と呼ばれます。 初回の転送後は、変更されたブロック (スナップショットでキャプチャされたもの) のみが転送されます。 その結果、すべてのスナップショットを含む、ソース ボリュームの非同期の 1:1 のレプリカが生成されます。 この動作は、完全および増分の永続的なレプリケーション メカニズムに従います。 このテクノロジにより、リージョン間でのレプリケーションに必要なデータ量が最小限に抑えられるため、データ転送コストが削減されます。 また、レプリケーション時間も短縮されます。 回復ポイントの目標 (RPO) を小さくすることができます。これは、データ転送が制限された状況で、より頻繁により多くのスナップショットを作成して転送できるためです。 さらに、ホストベースのレプリケーション メカニズムが不要になり、仮想マシンとソフトウェアのライセンス コストをなくすことができます。

次の図は、リージョン間レプリケーション シナリオでのスナップショット トラフィックを示しています。 

![リージョン間レプリケーション シナリオでのスナップショット トラフィックを示す図](../media/azure-netapp-files/snapshot-traffic-cross-region-replication.png)

## <a name="ways-to-restore-data-from-snapshots"></a>スナップショットからデータを復元する方法  

Azure NetApp Files スナップショット テクノロジにより、バックアップの頻度と信頼性が大幅に向上します。 パフォーマンスのオーバーヘッドが最小限に抑えられ、アクティブなボリュームでの安全な作成が可能になります。 Azure NetApp Files スナップショットを使用すると、必要に応じて、ほぼ瞬時かつ安全にユーザー管理の復元を実行できます。 このセクションでは、Azure NetApp Files スナップショットからデータにアクセスしたり、データを復元したりするためのさまざまな方法について説明します。

### <a name="restoring-files-or-directories-from-snapshots"></a>スナップショットからファイルまたはディレクトリを復元する 

[[Snapshot Path visibility]\(スナップショット パスの表示\)](azure-netapp-files-manage-snapshots.md#edit-the-hide-snapshot-path-option) が `hidden` に設定されていない場合、ユーザーは、データの誤った削除、破損、変更から回復するために、スナップショットに直接アクセスできます。 ファイルとディレクトリのセキュリティはスナップショットでも維持されます。スナップショットは、設計上、読み取り専用です。 そのため、復元は安全かつ簡単です。 

次の図は、スナップショットへのファイルまたはディレクトリのアクセスを示しています。 

![スナップショットへのファイルまたはディレクトリのアクセスを示す図](../media/azure-netapp-files/snapshot-file-directory-access.png)

この図では、スナップショット 1 により、アクティブなボリュームとスナップショット作成時の間の差分ブロックのみ消費されています。 ただし、ボリューム スナップショット パスを使用してスナップショットにアクセスすると、スナップショットの作成時にボリュームの容量がいっぱいになっているかのようにデータが "*表示*" されます。 ユーザーは、スナップショット フォルダーにアクセスし、選択したスナップショットからファイルとディレクトリをコピーすることで、データを自己復元できます。

同様に、ターゲットのリージョン間レプリケーション ボリューム内のスナップショットには、DR リージョンのデータ復旧のために読み取り専用でアクセスできます。  

次の図は、リージョン間レプリケーション シナリオでのスナップショット アクセスを示しています。 

![リージョン間レプリケーションでのスナップショット アクセスを示す図](../media/azure-netapp-files/snapshot-access-cross-region-replication.png)

スナップショットから個々のファイルまたはディレクトリを復元する方法については、「[クライアントを使用してスナップショットからファイルを復元する](azure-netapp-files-manage-snapshots.md#restore-a-file-from-a-snapshot-using-a-client)」を参照してください。

### <a name="restoring-cloning-a-snapshot-to-a-new-volume"></a>新しいボリュームにスナップショットを復元 (複製) する

Azure NetApp Files のスナップショットを個別の独立したボリュームに復元できます。 この操作は、ボリュームのサイズと消費される容量に関係なく、ほぼ瞬時に実行されます。 実際のボリュームとスナップショットのデータ ブロックがコピーされている間、新しく作成されたボリュームはほぼ即座にアクセス可能になります。 ボリュームのサイズと容量によっては、このプロセスに相当な時間がかかる場合があり、その間は親ボリュームとスナップショットを削除することはできません。 ただし、コピー プロセスがバックグラウンドで実行されている間、ボリュームは、初めて作成された後にすぐにアクセスできます。 この機能により、データ回復のための迅速なボリューム作成や、テストおよび開発のためのボリューム複製が可能になります。 データ コピー プロセスの性質上、復元が完了するとストレージ容量プールの消費量が 2 倍になり、新しいボリュームに元のスナップショットの全アクティブ容量が表示されます。 このプロセスが完了すると、ボリュームは独立し、元のボリュームとの関連付けが解除され、ソース ボリュームとスナップショットを新しいボリュームとは別に管理または削除できます。

次の図は、スナップショットの復元 (複製) によって作成された新しいボリュームを示しています。   

![スナップショットの復元によって作成された新しいボリュームを示す図](../media/azure-netapp-files/snapshot-restore-clone-new-volume.png)

ディザスター リカバリー (DR) ボリュームにレプリケートされるスナップショットでも、同じ操作を実行できます。 リージョン間レプリケーションがアクティブまたは進行中であっても、すべてのスナップショットを新しいボリュームに復元できます。 この機能により、レプリケートされたボリュームが DR 目的でのみ使用される一方で、DR リージョンでテストおよび開発環境を中断なしで作成でき、データを使用できるようになります。 このユースケースでは、テストおよび開発環境を運用環境から分離でき、それにより運用環境への潜在的な影響を排除できます。  

次の図は、リージョン間レプリケーションが行われているときの、DR ターゲット ボリューム スナップショットを使用したボリュームの復元 (複製) を示しています。  

![DR ターゲット ボリューム スナップショットを使用したボリュームの復元を示す図](../media/azure-netapp-files/snapshot-restore-clone-target-volume.png)

ボリュームの復元操作については、「[スナップショットから新しいボリュームを復元する](azure-netapp-files-manage-snapshots.md#restore-a-snapshot-to-a-new-volume)」を参照してください。

### <a name="restoring-reverting-a-snapshot-in-place"></a>スナップショットをインプレース復元する (元に戻す)

場合によっては、新しいボリュームがストレージ容量を消費するため、スナップショットから新しいボリュームを作成することが不要な場合や適切でない場合があります。 データの破損 (たとえば、データベースの破損やランサムウェアの攻撃) から迅速に復旧するために、ボリューム自体にスナップショットを復元する方が適切な場合があります。 この操作は、Azure NetApp Files スナップショットを元に戻す機能を使用して実行できます。 この機能を使用すると、特定のスナップショットが作成されたときの状態にボリュームをすばやく戻すことができます。 ほとんどの場合、ボリュームを元に戻す方が、個々のファイルをスナップショットからアクティブなファイル システムに復元するよりもはるかに高速です (特に大規模なマルチ TiB ボリュームの場合)。 

ボリューム スナップショットを元に戻す操作はほぼ瞬時で、最大のボリュームであっても、完了するまでに数秒しかかかりません。 アクティブなボリューム メタデータ ("*inode テーブル*") は、スナップショットの作成時からスナップショット メタデータに置き換えられるため、その特定時点にボリュームがロールバックされます。 元に戻す操作を有効にするために、データ ブロックをコピーする必要はありません。 そのため、新しいボリュームにスナップショットを復元するよりも、より効率的にスペースを使用できます。 

次の図は、以前のスナップショットに戻されるボリュームを示しています。  

![以前のスナップショットに戻されるボリュームを示す図](../media/azure-netapp-files/snapshot-volume-revert.png)

> [!IMPORTANT]
> 選択したスナップショットよりも後に書き込まれたアクティブなファイル システム データと、作成されたスナップショットは失われます。 スナップショットの復元操作によって、ターゲット ボリューム内の "すべて" のデータが、選択したスナップショットのデータに置き換えられます。 スナップショットを選択するときは、スナップショットの内容と作成日に注意する必要があります。 スナップショットの復元操作を元に戻すことはできません。  

この機能の使用方法については、「[スナップショットの復元を使用してボリュームを元に戻す](azure-netapp-files-manage-snapshots.md#revert-a-volume-using-snapshot-revert)」を参照してください。

## <a name="how-snapshots-are-deleted"></a>スナップショットの削除方法 

スナップショットは、ストレージ容量を消費します。 そのため、通常は無期限に保持されることはありません。 データの保護、保持、回復性のために、通常、多くのスナップショット (さまざまな時点で作成されたもの) が、RPO、RTO、保持の SLA の要件に応じて、一定期間オンラインで保持されます。 ただし、古いスナップショットは、多くの場合、ストレージ サービスで保持する必要がなく、スペースを解放するために削除する必要がある場合があります。 管理者は、いつでもすべてのスナップショットを削除できます (作成順である必要はありません)。 

> [!IMPORTANT]
> スナップショットの削除操作を元に戻すことはできません。 データの保護と保持の目的で、ボリュームのオフライン コピーを保持する必要があります。 

スナップショットを削除すると、そのスナップショットから既存のデータ ブロックへのすべてのポインターが削除されます。 データ ブロックに、(アクティブなボリュームまたはボリューム内の他のスナップショットによって) それを指すポインターがなくなると、将来の使用のために、そのデータ ブロックはボリュームの空き領域に戻されます。 そのため、スナップショットを削除すると、通常、アクティブなボリュームからデータを削除するよりも、ボリュームの容量がより多く解放されます。これは、通常、データ ブロックが以前作成されたスナップショットでキャプチャされているためです。 

次の図は、ボリュームからスナップショット 3 を削除した場合のストレージ消費への影響を示しています。  

![スナップショットを削除した場合のストレージ消費への影響を示す図](../media/azure-netapp-files/snapshot-delete-storage-consumption.png)

必ず[ボリュームとスナップショットの消費量を監視して](azure-netapp-files-metrics.md#volumes)、アプリケーション、アクティブなボリューム、スナップショットの消費量がどのように関係しているか理解してください。 

スナップショットの削除を管理する方法については、「[スナップショットの削除](azure-netapp-files-manage-snapshots.md#delete-snapshots)」を参照してください。 このプロセスを自動化する方法については、「[スナップショット ポリシーを管理する](azure-netapp-files-manage-snapshots.md#manage-snapshot-policies)」を参照してください。

## <a name="next-steps"></a>次のステップ

* [Azure NetApp Files を使用してスナップショットを管理する](azure-netapp-files-manage-snapshots.md)
* [ボリュームとスナップショットのメトリックを監視する](azure-netapp-files-metrics.md#volumes)
* [スナップショット ポリシーのトラブルシューティング](troubleshoot-snapshot-policies.md)
* [Azure NetApp Files のリソース制限](azure-netapp-files-resource-limits.md)
* [Azure NetApp Files のスナップショット 101 ビデオ](https://www.youtube.com/watch?v=uxbTXhtXCkw)
* [Azure NetApp Files のスナップショットの概要](https://anfcommunity.com/2021/01/31/azure-netapp-files-snapshot-overview/)



