---
title: "Resource Manager のセキュリティに関する考慮事項 | Microsoft Docs"
description: "Azure リソース マネージャーでキーとシークレット、ロールベースのアクセス制御、ネットワーク セキュリティ グループを使用してリソースをセキュリティで保護するための推奨方法を示します。"
services: azure-resource-manager
documentationcenter: 
author: george-moore
manager: georgem
editor: tysonn
ms.assetid: c862e9c7-276b-46bf-bc0a-11868ac11459
ms.service: azure-resource-manager
ms.workload: multiple
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 08/01/2016
ms.author: georgem;tomfitz
translationtype: Human Translation
ms.sourcegitcommit: e841c21a15c47108cbea356172bffe766003a145
ms.openlocfilehash: 0113b745a1ee719108ca86cd5a05b11c67cc6599


---
# <a name="security-considerations-for-azure-resource-manager"></a>Azure リソース マネージャーのセキュリティに関する考慮事項
Azure リソース マネージャー テンプレートをセキュリティの側面から見た場合、考慮する必要がある項目として、キーとシークレット、ロールベースのアクセス制御、ネットワーク セキュリティ グループがあります。

このトピックは、Azure リソース マネージャーのロールベースの Access Control (RBAC) に精通している読者を対象にしています。 詳細については、[Azure のロールベースの Access Control](../active-directory/role-based-access-control-configure.md) に関するページを参照してください。

このトピックは大型のホワイト ペーパーの一部です。 すべてご覧になりたい場合は、ホワイト ペーパー『[World Class ARM Templates Considerations and Proven Practices (ワールド クラスの ARM テンプレートの考慮事項と実証済みプラクティス)](http://download.microsoft.com/download/8/E/1/8E1DBEFA-CECE-4DC9-A813-93520A5D7CFE/World Class ARM Templates - Considerations and Proven Practices.pdf)』をダウンロードしてください。

## <a name="secrets-and-certificates"></a>シークレットと証明書
Azure Virtual Machines、Azure リソース マネージャー、および Azure Key Vault は完全に統合されていて、VM にデプロイされる証明書のセキュリティで保護された処理をサポートします。  Azure Key Vault とリソース マネージャーを使用した VM シークレットと証明書の調整と格納は、次の利点を持つベスト プラクティスです。

* テンプレートにはシークレットへの URI 参照のみが含まれます。つまり、実際のシークレットは、コード リポジトリ、構成リポジトリ、ソース コード リポジトリには存在しません。 これにより、GitHub での収集ボットのような、内外のリポジトリへのキー フィッシング攻撃を防ぐことができます。
* Key Vault に格納されたシークレットは、厳密な RBAC により信頼されたオペレーターの手で制御されます。  信頼されたオペレーターが退職または異動すると、自身が Vault 内に作成したキーにアクセスできなくなります。
* 資産はすべて、完全に区分されます。
  * キーをデプロイするためのテンプレート
  * キーを参照して VM をデプロイするためのテンプレート
  * Vault 内の実際のキー マテリアル。  
    テンプレート (およびアクション) は、職務を完全に分離するため、担当の RBAC ロールをそれぞれ別にすることができます。
* デプロイ時の VM へのシークレットの読み込みは、Microsoft データセンターの範囲内での Azure ファブリックと Key Vault 間の直接チャネルを介して行われます。  キーが Key Vault に格納されたら、データセンター外の信頼されていないチャネルを経由してキーを見ることはできません。  
* Key Vault は常に局所的であるため、シークレットは常に VM と同じローカリティ (および主権) を持ちます。 グローバルの Key Vault はありません。

### <a name="separation-of-keys-from-deployments"></a>デプロイからのキーの分離
次のそれぞれに個別のテンプレートを維持することをお勧めします。

1. 資格情報コンテナー (キー マテリアルが格納されます) の作成
2. VM のデプロイ (資格情報コンテナーに格納されたキーへの URI 参照を含みます)

一般的な企業シナリオでは、デプロイされたワークロード内の重要なシークレットにアクセスできる少人数の信頼されたオペレーターのグループと、それよりも少し大きなグループとして VM のデプロイを作成または更新できる開発者/運用担当者のグループを作ります。  以下に、Azure Active Directory で現在認証されているユーザーの ID のコンテキストで新しい資格情報コンテナーを作成して構成する ARM テンプレートの例を示します。  このユーザーには、この新しい Key Vault 内のキーの作成、削除、一覧表示、更新、バックアップ、復元、公開部分の取得を行う既定のアクセス許可があります。

このテンプレートのほとんどのフィールドは見ればわかるようになっていますが、**enableVaultForDeployment** 設定には追加の背景情報が必要です。資格情報コンテナーには、他の Azure インフラストラクチャ コンポーネントによる既定の有効なアクセス許可がありません。 この値を設定することにより、Azure 計算インフラストラクチャ コンポーネントがこの特定の名前付き資格情報コンテナーに読み取り専用でアクセスできます。 したがって、企業の機密データを仮想マシンのシークレットとして同一の資格情報コンテナー内に混在させないことが推奨されます。

    {
        "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
        "contentVersion": "1.0.0.0",
        "parameters": {
            "keyVaultName": {
                "type": "string",
                "metadata": {
                    "description": "Name of the Vault"
                }
            },
            "location": {
                "type": "string",
                "allowedValues": ["East US", "West US", "West Europe", "East Asia", "South East Asia"],
                "metadata": {
                    "description": "Location of the Vault"
                }
            },
            "tenantId": {
                "type": "string",
                "metadata": {
                    "description": "Tenant Id of the subscription. Get using Get-AzureSubscription cmdlet or Get Subscription API"
                }
            },
            "objectId": {
                "type": "string",
                "metadata": {
                    "description": "Object Id of the AD user. Get using Get-AzureADUser cmdlet"
                }
            },
            "skuName": {
                "type": "string",
                "allowedValues": ["Standard", "Premium"],
                "metadata": {
                    "description": "SKU for the vault"
                }
            },
            "enableVaultForDeployment": {
                "type": "bool",
                "allowedValues": [true, false],
                "metadata": {
                    "description": "Specifies if the vault is enabled for a VM deployment"
                }
            }
        },
        "resources": [{
            "type": "Microsoft.KeyVault/vaults",
            "name": "[parameters('keyVaultName')]",
            "apiVersion": "2014-12-19-preview",
            "location": "[parameters('location')]",
            "properties": {
                "enabledForDeployment": "[parameters('enableVaultForDeployment')]",
                "tenantid": "[parameters('tenantId')]",
                "accessPolicies": [{
                    "tenantId": "[parameters('tenantId')]",
                    "objectId": "[parameters('objectId')]",
                    "permissions": {
                        "secrets": ["all"],
                        "keys": ["all"]
                    }
                }],
                "sku": {
                    "name": "[parameters('skuName')]",
                    "family": "A"
                }
            }
        }]
    }

資格情報コンテナーが作成されたら、次の手順は、新しい VM のデプロイ テンプレートでそのコンテナーを参照することです。  上で説明したように、異なる開発/運用グループが VM のデプロイを管理し、そのグループは資格情報コンテナーに格納されているキーに直接アクセスできないようにすることがベスト プラクティスです。

下に示すテンプレートの一部は、より高次のデプロイ コンストラクトを構成します。これらはそれぞれ、オペレーターが直接制御していない非常に重要なシークレットを安全に参照します。

    "vaultName": {
        "type": "string",
        "metadata": {
            "description": "Name of Key Vault that has a secret"
        }
    },
    {
        "apiVersion": "2015-05-01-preview",
        "type": "Microsoft.Compute/virtualMachines",
        "name": "[parameters('vmName')]",
        "location": "[parameters('location')]",
        "properties": {
            "osProfile": {
                "secrets": [{
                    "sourceVault": {
                        "id": "[resourceId('vaultrg', 'Microsoft.KeyVault/vaults', 'kayvault')]"
                    },
                    "vaultCertificates": [{
                        "certificateUrl": "[parameters('secretUrlWithVersion')]",
                        "certificateStore": "My"
                    }]
                }]
            }
        }
    }

テンプレートのデプロイ時に Key Vault の値をパラメーターとして渡す場合は、「 [デプロイメント時にセキュリティで保護された値を渡す](resource-manager-keyvault-parameter.md)」をご覧ください。

## <a name="service-principals-for-cross-subscription-interactions"></a>サブスクリプション間の対話のサービス プリンシパル
サービス ID は Active Directory 内でサービス プリンシパルによって表されます。 サービス プリンシパルは、企業の IT 組織、システム インテグレーター (SI)、クラウド サービス ベンダー (CSV) における主要なシナリオの有効化の中心になります。 具体的には、これらの組織のいずれかが、ある顧客のサブスクリプションとやり取りする必要があるユース ケースがあります。  

顧客の環境やサブスクリプションにデプロイされたソリューションを監視するサービスを提供できます。 この場合は、監視ソリューションで使用できるように、顧客のアカウント内のログやその他のデータへのアクセスを取得する必要があります。 企業の IT 組織やシステム インテグレーターの場合は、顧客独自のサブスクリプション内に、データ分析プラットフォームなどの機能をデプロイして管理するサービスを顧客に提供できます。

これらのユース ケースでは、顧客のサブスクリプションのコンテキスト内でこれらの操作を実行するためのアクセス許可を付与された ID が必要になります。  

これらのシナリオにより、顧客には次のような一連の考慮事項が発生します。

* セキュリティ上の理由から、アクセスの範囲を特定の種類の操作 (読み取り専用アクセスなど) に設定することが必要になる場合があります。
* デプロイされたリソースの提供にコストがかかるため、財務上の理由から、アクセスに対する同様の制約が必要になる場合があります。
* セキュリティ上の理由から、アクセスの範囲を特定のリソース (ストレージ アカウント、環境またはソリューションを含むリソース グループ) のみに設定することが必要になる場合があります。
* ベンダーとの関係が変わる可能性があるため、顧客は SI や CSV へのアクセスを有効または無効にする機能を希望します。
* このアカウントに対する操作は課金に影響するため、顧客は課金の監査機能と説明責任のサポートを希望します。
* コンプライアンスの観点から、顧客は自身の環境内でのシステム インテグレーターの動作を監査できることを希望します。

このような要件に対応するには、サービス プリンシパルと RBAC の組み合わせを使用します。

## <a name="network-security-groups"></a>ネットワーク セキュリティ グループ
多くのシナリオには、仮想ネットワーク内の 1 つ以上の VM インスタンスに対するトラフィックの制御方法を指定する要件があります。 ARM テンプレートのデプロイの一環として、ネットワーク セキュリティ グループ (NSG) を使用してこれを実現することができます。

ネットワーク セキュリティ グループは、サブスクリプションに関連付けられている最上位レベルのオブジェクトです。 NSG には、VM インスタンスへのトラフィックを許可または拒否するアクセス制御ルールが含まれています。 NSG のルールは、いつでも変更でき、変更は関連付けられているすべてのインスタンスに適用されます。 NSG を使用するには、リージョン (場所) に関連付けられている仮想ネットワークが必要です。 NSG は、アフィニティ グループに関連付けられている仮想ネットワークに対応していません。 リージョン仮想ネットワークがない場合に、エンドポイントへのトラフィックを制御するには、[ネットワーク アクセス制御リスト (ACL)](../virtual-network/virtual-networks-acl.md) に関するページを参照してください。

VM や仮想ネットワーク内のサブネットに NSG を関連付けることができます。 VM に関連付けた場合、NSG は、VM インスタンスで送受信されるすべてのトラフィックに適用されます。 仮想ネットワーク内のサブネットに適用した場合は、サブネット内のすべての VM インスタンスで送受信されるすべてのトラフィックに適用されます。 VM またはサブネットは、1 つの NSG のみに関連付けることができます。各 NSG には、最大 200 のルールを含めることができます。 サブスクリプションあたり 100 個の NSG を割り当てることができます。

> [!NOTE]
> エンドポイント ベースの ACL とネットワーク セキュリティ グループは、同じ VM インスタンスではサポートされません。 エンドポイントの ACL が既に導入されている場合に NSG を使用するには、初めにエンドポイントの ACL を削除します。 これを行う方法については、 [PowerShell を使用したエンドポイントのアクセス制御リスト (ACL) の管理](../virtual-network/virtual-networks-acl-powershell.md)を参照してください。
> 
> 

### <a name="how-network-security-groups-work"></a>ネットワーク セキュリティ グループのしくみ
ネットワーク セキュリティ グループは、エンドポイント ベースの ACL とは異なります。 エンドポイントの ACL は、入力エンドポイントによって公開されるパブリック ポートでのみ動作します。 NSG は 1 つまたは複数の VM インスタンスで動作し、VM 上の受信と送信のすべてのトラフィックを制御します。

ネットワーク セキュリティ グループには*名前*が割り当てられ、*リージョン* (サポートされている Azure の場所の 1 つ) に関連付けられ、わかりやすいラベルが付きます。 受信と送信の 2 つのルールが含まれています。 受信のルールは VM への受信パケットに適用され、送信のルールは、VM からの送信パケットに適用されます。
ルールは、VM が配置されているサーバー コンピューターで適用されます。 受信または送信パケットが許可されるためには、許可ルールに一致している必要があります。一致しない場合は、パケットは削除されます。

ルールは、優先順位に従って処理されます。 たとえば、優先順位の値が小さい (100 など) ルールは、優先順位の値が大きい (200 など) ルールより前に処理されます。 一致が見つかると、それ以上のルールは処理されません。

ルールでは、次のことを指定します。

* 名前: ルールの一意識別子
* 種類: 受信/送信
* 優先順位: 100 ～ 4096 の整数 (ルールは値が小さいものから値が大きいものの順に処理されます)
* 発信元 IP アドレス: 発信元 IP 範囲の CIDR
* 発信元ポート範囲: 0 ～ 65536 の整数 (範囲)
* 宛先 IP の範囲: 宛先 IP 範囲の CIDR
* 宛先ポートの範囲: 0 ～ 65536 の整数 (範囲)
* プロトコル: TCP、UDP、または "\*
* アクセス: 許可または拒否

### <a name="default-rules"></a>既定のルール
NSG には、既定のルールが含まれています。 既定のルールは削除できませんが、割り当てられている優先順位は最も低いため、ルールを作成することで上書きできます。 既定のルールでは、プラットフォームによって推奨される既定の設定が指定されています。 次の既定のルールが示すように、仮想ネットワーク内で発信および着信するトラフィックについては、受信方向と送信方向の両方で許可されます。

インターネットへの接続は送信方向で許可されていますが、既定で、受信方向はブロックされています。 既定のルールは、Azure Load Balancer が VM の正常性をプローブするのを許可します。 NSG の下の VM または一連の VM が負荷分散セットに参加しない場合は、このルールを上書きできます。

既定のルールを次の表に示します。

**受信の既定のルール**

| Name | 優先順位 | 発信元 IP | 発信元ポート | 宛先 IP | 宛先ポート | プロトコル | Access (アクセス) |
| --- | --- | --- | --- | --- | --- | --- | --- |
| ALLOW VNET INBOUND |65000 |VIRTUAL_NETWORK |\* |VIRTUAL_NETWORK |\* |\* |ALLOW |
| ALLOW AZURE LOAD BALANCER INBOUND |65001 |AZURE_LOADBALANCER |\* |\* |\* |\* |ALLOW |
| DENY ALL INBOUND |65500 |\* |\* |\* |\* |\* |DENY |

**送信の既定のルール**

| Name | 優先順位 | 発信元 IP | 発信元ポート | 宛先 IP | 宛先ポート | プロトコル | Access (アクセス) |
| --- | --- | --- | --- | --- | --- | --- | --- |
| ALLOW VNET OUTBOUND |65000 |VIRTUAL_NETWORK |\* |VIRTUAL_NETWORK |\* |\* |ALLOW |
| ALLOW INTERNET OUTBOUND |65001 |\* |\* |INTERNET |\* |\* |ALLOW |
| DENY ALL OUTBOUND |65500 |\* |\* |\* |\* |\* |DENY |

### <a name="special-infrastructure-rules"></a>インフラストラクチャの特別なルール
NSG ルールは、明示的です。 NSG ルールで指定されていない限り、いかなるトラフィックも許可または拒否されません。 ただし、ネットワーク セキュリティ グループの指定にかかわらず、常に許可される 2 種類のトラフィックがあります。 インフラストラクチャをサポートするために、このように事前設定されています。

* **ホスト ノードの仮想 IP:**DHCP、DNS、および正常性の監視などの基本的なインフラストラクチャ サービスは、仮想化されたホストの IP アドレス 168.63.129.16 を通じて提供されます。 このパブリック IP アドレスは Microsoft に属し、この目的のためにすべての地域で使用される唯一の仮想化 IP アドレスです。 この IP アドレスは、VM をホストしているサーバー コンピューター (ホスト ノード) の物理 IP アドレスにマッピングされます。 ホスト ノードは、DHCP リレー、DNS の再帰的リゾルバー、および Load Balancer の正常性プローブとマシンの正常性プローブのプローブ元として機能します。 この IP アドレスへの通信を攻撃と見なさないでください。
* **ライセンス (キー管理サービス):**VM で実行されている Windows イメージのライセンスを取得する必要があります。 このためには、要求を処理するキー管理サービスのホスト サーバーにライセンス要求を送信します。 これは、常に送信ポート 1688 上にあります。

### <a name="default-tags"></a>既定のタグ
既定のタグは、IP アドレスのカテゴリに対応するシステム指定の識別子です。 ユーザー定義のルールで、既定のタグを指定できます。

**NSG の既定のタグ**

| タグ | 説明 |
| --- | --- |
| VIRTUAL_NETWORK |ネットワーク アドレス空間のすべてを表します。 これには、仮想ネットワーク アドレス空間 (Azure での IP CIDR) だけでなく、すべての接続されているオンプレミス アドレス空間 (ローカル ネットワーク) が含まれます。 また、仮想ネットワーク間のアドレス空間も含まれています。 |
| AZURE_LOADBALANCER |Azure インフラストラクチャの Load Balancer を表し、Azure の正常性プローブが開始される Azure データ センター IP に変換されます。 これは、NSG に関連付けられている VM または一連の VM が、負荷分散セットに参加している場合にのみ必要です。 |
| INTERNET |パブリック インターネットによってアクセスできる仮想ネットワークの外部の IP アドレス空間を表します。 この範囲には、Azure に所有されているパブリック IP アドレス空間も含まれます。 |

### <a name="ports-and-port-ranges"></a>ポートおよびポート範囲
NSG のルールは、1 つの発信元/宛先ポートまたはポート範囲で指定できます。 この方法は、FTP などのアプリケーション用に広範囲のポートを開く場合に特に便利です。 範囲は連続的に指定する必要があり、個々のポートの指定と混在させることはできません。
ポートの範囲を指定するには、ハイフン (–) を使用します。 たとえば、 **100-500**のように指定します。

### <a name="icmp-traffic"></a>ICMP トラフィック
現在の NSG のルールでは、プロトコルとして TCP または UDP を指定できますが、ICMP は指定できません。 ただし、ICMP トラフィックは、仮想ネットワーク内で任意のポートおよびプロトコル間のトラフィックをサポートする (\*) 受信ルールによって、既定で仮想ネットワーク内で許可されます。

### <a name="associating-an-nsg-with-a-vm"></a>NSG と VM の関連付け
NSG と VM を直接関連付けた場合、NSG のネットワーク アクセス ルールは、その VM を宛先とするすべてのトラフィックに直接適用されます。 ルールの変更のために NSG が更新されると、その更新は数分のうちにトラフィックの処理に反映されます。 NSG と VM の関連付けが解除されると、状態は NSG 前の状態、つまり NSG が導入される前のシステムの既定値に戻ります。

### <a name="associating-an-nsg-with-a-subnet"></a>NSG とサブネットの関連付け
NSG をサブネットに関連付けた場合、NSG のネットワーク アクセス ルールは、サブネット内のすべての VM に適用されます。 NSG のアクセス ルールが更新されると、変更は数分でサブネット内のすべての VM に適用されます。

### <a name="associating-an-nsg-with-a-subnet-and-a-vm"></a>NSG とサブネットおよび VM の関連付け
1 つの NSG を VM に関連付け、別の NSG をその VM が存在するサブネットに関連付けることができます。 このシナリオは、2 つの保護レイヤーを持つ VM を提供するためにサポートされています。
受信トラフィックの場合、パケットは、VM 内のルールの次に、サブネットで指定されたアクセス ルールに従います。 送信の場合は、パケットは最初に VM で指定されたルールに従った後、次に示すように、サブネットで指定されたルールに従います。

![サブネットと VM に対する NSG の関連付け](./media/best-practices-resource-manager-security/nsg-subnet-vm.png)

VM またはサブネットに NSG を関連付ける場合、ネットワーク アクセス制御のルールは、きわめて明示的になります。 プラットフォームによって、特定のポートへのトラフィックを許可する暗黙のルールが挿入されることはありません。 この場合、VM 内にエンドポイントを作成するときには、インターネットからのトラフィックを許可するルールも作成する必要があります。 これを行わないと、外部から *VIP:{Port}* にアクセスできなくなります。

たとえば、新しい VM と新しい NSG を作成します。 NSG と VM を関連付けます。 この VM は、ALLOW VNET INBOUND ルールを使用して、仮想ネットワーク内の他の VM と通信できます。 VM は、ALLOW INTERNET OUTBOUND ルールを使用して、インターネットへの送信接続を確立することもできます。 後で、VM で動作している Web サイトへのトラフィックを受信するために、ポート 80 でエンドポイントを作成します。 VIP (パブリック仮想 IP アドレス) のポート 80 を宛先とするインターネットからのパケットは、次の表に示すようなルールを NSG に追加するまで、VM にアクセスできません。

**特定のポートにトラフィックを許可する明示的なルール**

| 名前 | 優先順位 | 発信元 IP | 発信元ポート | 宛先 IP | 宛先ポート | プロトコル | アクセス |
| --- | --- | --- | --- | --- | --- | --- | --- |
| WEB |100 |INTERNET |* |* |80 |TCP |ALLOW |

## <a name="user-defined-routes"></a>ユーザー定義のルート
Azure では、IP トラフィックを各パケットの宛先に基づいて転送する方法がルート テーブルを使用して決定されます。 Azure には、仮想ネットワークの設定に基づく既定のルート テーブルが備わっていますが、そのテーブルにカスタム ルートを追加しなければならないこともあります。

ルート テーブルにカスタム エントリが必要となる最も一般的な状況は、Azure 環境で仮想アプライアンスを使用するケースです。 以下の図のシナリオを考えてみます。 フロントエンドのサブネットから中間層とバックエンドのサブネットに向かうすべてのトラフィックに仮想ファイアウォール アプライアンスを経由させる必要があるとします。 そのアプライアンスを仮想ネットワークに追加して各サブネットに接続しただけでは、この機能を実現できません。
仮想ファイアウォール アプライアンスに対してパケットが確実に転送されるように、サブネットに適用されたルーティング テーブルにも変更を加える必要があります。

同じことは、Azure Virtual Network とインターネット間のトラフィックを制御する仮想 NAT アプライアンスが導入されている場合にも当てはまります。 確実に仮想アプライアンスを経由させるためには、インターネットに向かうすべてのトラフィックを仮想アプライアンスに転送するようにルートを作成しなければなりません。

### <a name="routing"></a>ルーティング
パケットは、物理ネットワーク上の各ノードに定義されているルート テーブルに基づき、TCP/IP ネットワークを介してルーティングされます。 ルート テーブルは、宛先 IP アドレスに基づいてパケットの転送先を決定する目的で使用される個々のルートの集まりです。 ルートの構成要素を次に示します。

* アドレス プレフィックス。 ルートの適用対象となる宛先の CIDR 表記 (例: 10.1.0.0/16)。
* 次ホップの種類。 パケットの送信先となる Azure ホップの種類。 次のいずれかの値になります。
  * Local。 ローカルの仮想ネットワークを表します。 たとえば、同じ仮想ネットワークに 10.1.0.0/16 と 10.2.0.0/16 の 2 つのサブネットがある場合、ルート テーブル内の各サブネットのルートは、次ホップの値が Local になります。
  * VPN Gateway。 Azure S2S VPN Gateway を表します。
  * Internet。 Azure インフラストラクチャによって提供される既定のインターネット ゲートウェイを表します。
  * Virtual Appliance。 Azure Virtual Network に追加した仮想アプライアンスを表します。
  * NULL。 ブラック ホールを表します。 ブラック ホールに転送されたパケットはまったく転送されません。
* 次ホップの値。 次ホップの値には、パケットの転送先となる IP アドレスが格納されます。 次ホップの値が使用できるのは、次ホップの種類が *Virtual Appliance*であるルートに限られます。 次ホップは、リモート サブネット上ではなくサブネット (ネットワーク ID にしたがった仮想アプライアンスのローカル インターフェイス) 上にある必要があります。

![ルーティング](./media/best-practices-resource-manager-security/routing.png)

### <a name="default-routes"></a>既定のルート
仮想ネットワークで作成されるすべてのサブネットは、次の既定のルート ルールを含むルート テーブルに自動的に関連付けられます。

* ローカル VNet ルール: このルールは、仮想ネットワーク内のすべてのサブネットに対して自動的に作成されます。 これは、VNet 内の VM 間に直接リンクがあり、中間次ホップがないことを指定します。 これにより、同じサブネット上の VM は、VM が存在するネットワーク ID に関係なく、既定のゲートウェイ アドレスを必要とせずに互いに通信できます。
* オンプレミス ルール: このルールは、オンプレミス アドレス範囲宛てのすべてのトラフィックに適用され、次ホップの宛先として VPN Gateway を使用します。
* インターネット ルール: このルールは、パブリック インターネット宛てのすべてのトラフィックを処理し、インターネット宛てのすべてのトラフィックの次ホップとしてインフラストラクチャ インターネット ゲートウェイを使用します。

### <a name="bgp-routes"></a>BGP のルート
この記事の執筆時には、[ExpressRoute](../expressroute/expressroute-introduction.md) は Azure Resource Manager 向け[ネットワーク リソース プロバイダー](../virtual-network/resource-groups-networking.md)ではまだサポートされていません。  NRP で ExpressRoute がサポートされたら、オンプレミス ネットワークと Azure との間に ExpressRoute 接続が存在する場合に、BGP を有効にして、オンプレミス ネットワークから Azure へとルートを伝達することができます。 これらの BGP ルートは、各 Azure サブネットで既定のルートやユーザー定義のルートと同じように使用されます。 詳細については、 [ExpressRoute の概要](../expressroute/expressroute-introduction.md)に関するページを参照してください。

> [!NOTE]
> NRP で ExpressRoute がサポートされている場合は、VPN Gateway を次ホップとする、サブネット 0.0.0.0/0 宛てのユーザー定義のルートを作成することで、オンプレミス ネットワークを介した強制トンネリングを使用するように Azure 環境を構成することができます。 ただし、この方法が利用できるのは、VPN Gateway を使用している場合に限られます。ExpressRoute では利用できません。 ExpressRoute の場合、強制トンネリングは BGP を介して構成します。
> 
> 

### <a name="user-defined-routes"></a>ユーザー定義のルート
以上、Azure 環境の既定のルートについて述べてきましたが、それらのルートを表示することはできません。また、実際に必要となるのは、ほとんどの環境では既定のルートだけです。
ただし、ある特定のケースにおいては、ルート テーブルを作成して独自にルートを追加する必要があります。その例を次に示します。

* インターネットへのオンプレミス ネットワークを介した強制トンネリング。
* Azure 環境での仮想アプライアンスの使用。

以上のシナリオでは、ルート テーブルを作成してユーザー定義のルートを追加する必要があります。 ルート テーブルは複数設定することができ、また、同じルート テーブルを 1 つまたは複数のサブネットに関連付けることができます。 ただし、関連付けることができるルート テーブルは各サブネットにつき 1 つだけです。 サブネット内のすべての VM および Cloud Services は、そのサブネットに関連付けられているルート テーブルを使用します。

サブネットにルート テーブルが関連付けられるまでは、既定のルートが使用されます。 いったん関連付けがなされると、ユーザー定義のルートと既定のルートとで、 [LPM (Longest Prefix Match)](https://en.wikipedia.org/wiki/Longest_prefix_match) に基づくルーティングが行われます。 同じ LPM マッチの複数のルートが存在する場合は、そのルートが検出された経緯に応じて次の順序でルートが選択されます。

1. ユーザーの定義ルート
2. BGP のルート (ExpressRoute を使用している場合)
3. 既定のルート

> [!NOTE]
> ユーザー定義のルートが適用されるのは、Azure VM と Cloud Services だけです。 たとえば、オンプレミス ネットワークと Azure との間にファイアウォール仮想アプライアンスを追加する場合、オンプレミスのアドレス空間に向かうすべてのトラフィックを仮想アプライアンスに転送するユーザー定義のルートを Azure ルート テーブルに作成する必要があります。 一方、オンプレミスのアドレス空間から入ってくるトラフィックは、VPN Gateway または ExpressRoute 回線を経由し、仮想アプライアンスを飛び越えて直接 Azure 環境に向かいます。
> 
> 

### <a name="ip-forwarding"></a>IP 転送
これまで説明してきたように、ユーザー定義のルートを作成する主な目的の 1 つは、トラフィックを仮想アプライアンスに転送することです。 仮想アプライアンスは、アプリケーションを実行する VM にすぎません。ファイアウォールや NAT デバイスなど、ネットワーク トラフィックを何らかの方法で処理するために使用されるアプリケーションが仮想アプライアンスで実行されます。

仮想アプライアンスとして機能するこの VM は、自分宛てではない着信トラフィックを受信できることが必要です。 VM が自分以外の宛先に向かうトラフィックを受信するためには、VM の IP 転送を有効にする必要があります。

## <a name="next-steps"></a>次のステップ
* 組織内のリソースに適切にアクセスして操作するセキュリティ プリンシパルの設定方法については、「 [Azure リソース マネージャーでのサービス プリンシパルの認証](resource-group-authenticate-service-principal.md)
* リソースへのアクセスをロックする必要がある場合は、管理ロックを使用できます。 「 [Azure リソース マネージャーによるリソースのロック](resource-group-lock-resources.md)
* ルーティングと IP 転送を構成する方法については、[テンプレートを使用して Resource Manager でユーザー定義ルート (UDR) を作成する](../virtual-network/virtual-network-create-udr-arm-template.md)方法に関するページを参照してください。
* ロールベースのアクセス制御の概要については、[Microsoft Azure Portal でのロールベースのアクセス制御](../active-directory/role-based-access-control-configure.md)に関するページを参照してください。




<!--HONumber=Nov16_HO3-->


