---
title: "複雑なソリューション向け Azure テンプレートの設計 | Microsoft Docs"
description: "複雑なソリューション向け Azure Resource Manager テンプレートを設計するためのベスト プラクティスを示します"
services: azure-resource-manager
documentationcenter: 
author: tfitzmac
manager: timlt
editor: tysonn
ms.assetid: ce1141d6-ece7-4976-acea-1db1f775409e
ms.service: azure-resource-manager
ms.workload: multiple
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 12/19/2016
ms.author: tomfitz
ms.translationtype: HT
ms.sourcegitcommit: 137671152878e6e1ee5ba398dd5267feefc435b7
ms.openlocfilehash: dcc31f7a8c85a8f7fbd554371a66fb1e348bca17
ms.contentlocale: ja-jp
ms.lasthandoff: 07/28/2017

---
# <a name="design-patterns-for-azure-resource-manager-templates-when-deploying-complex-solutions"></a>複雑なソリューションをデプロイするときの Azure Resource Manager テンプレートの設計パターン
Azure Resource Manager テンプレートを基にした柔軟な方法を使用すると、複雑なトポロジを一貫性のあるやり方で迅速にデプロイできます。 これらのデプロイは、主要な提供物が進化したり、特殊なシナリオや顧客のためのバリエーションに対応したりする場合に、簡単に調整できます。

このトピックは大型のホワイト ペーパーの一部です。 すべてご覧になりたい場合は、[ワールド クラスの Resource Manager テンプレートの考慮事項と実証済みプラクティス](http://download.microsoft.com/download/8/E/1/8E1DBEFA-CECE-4DC9-A813-93520A5D7CFE/World Class ARM Templates - Considerations and Proven Practices.pdf)に関するホワイト ペーパーをダウンロードしてください。

Azure リソース マネージャー テンプレートは、Azure リソース マネージャーそのものの利点に加えて、JavaScript Object Notation (JSON) の順応性と可読性を兼ね備えているのが特徴です。 以下に挙げたのは、テンプレートを使用してできることの例です。

* トポロジとそのワークロードのデプロイに一貫性を保つ。
* リソース グループを使用してアプリケーション内のすべてのリソースを管理する。
* ロールベースのアクセス制御 (RBAC) を適用し、ユーザー、グループ、サービスに適切なアクセス権を付与する。
* タグの関連付けによって、請求額の集計などの作業を省力化する。

この記事では、Microsoft の設計過程で明らかになった利用シナリオ、アーキテクチャ、実装パターンと、Azure Customer Advisory Team (AzureCAT) の顧客を対象とした実世界のテンプレートの実装について詳しく取り上げています。 決して学術的な内容ではありませんが、Linux をベースとする 12 個の代表的な OSS テクノロジ (Apache Kafka、Apache Spark、Cloudera、Couchbase、Hortonworks HDP、DataStax Enterprise (Apache Cassandra)、Elasticsearch、Jenkins、MongoDB、PostgreSQL、Redis、Nagios) を対象としたテンプレートの開発経験から得られた実績ある手法です。 

この記事で紹介するのは、そこで培われた手法です。高品質の Azure リソース マネージャー テンプレートを設計する一助となればさいわいです。  

私たちは、企業、システム インテグレーター (SI)、CSV など、さまざまな顧客と連携する中で、いくつかの Resource Manager テンプレートを活用してきました。 以降のセクションでは、顧客のタイプごとの一般的なシナリオとパターンを簡単に紹介していきます。

## <a name="enterprises-and-system-integrators"></a>大企業とシステム インテグレーター
大規模な組織では、Azure Resource Manager テンプレートの主な利用者は、社内ソフトウェア開発チームと社内 IT です。 SI のシナリオは企業のシナリオと対応しているため、同じ考慮事項が当てはまります。

### <a name="internal-software-development-teams"></a>社内ソフトウェア開発チーム
皆さんのチームが自社事業を支援するソフトウェアを開発する場合、テンプレートを使用することで、その事業のソリューションに必要なテクノロジを短時間で簡単にデプロイすることができます。 必要なスキルをチーム メンバーが身に付けるためのトレーニング環境も、テンプレートを使用すればすぐに作成できます。

テンプレートはそのまま使うこともできますが、必要に応じて拡張したり新たに作成することも可能です。 テンプレート内でタグを関連付けることにより、チーム、プロジェクト、個人、トレーニングなど、さまざまな角度から請求情報を得ることができます。

企業では、ソフトウェア開発チームに一貫したソリューションのデプロイメント向けのテンプレートの作成がよく求められます。 テンプレートは制約を容易にすることで、その環境内で特定の項目が固定され、オーバーライドできないようにします。 たとえば銀行の場合、個人のストレージ アカウントにデータを送信するバンキング ソリューションがプログラマによって変更されることのないよう、テンプレートに RBAC を含める必要があります。

### <a name="corporate-it"></a>社内 IT
通常、社内 IT 部門は、テンプレートを使用してクラウドの容量やクラウドでホストされる機能を提供します。

#### <a name="cloud-capacity"></a>クラウドの容量
社内 IT グループがチームに対してクラウドの容量を提供するとき、T シャツのサイズのような形式 (S、M、L など) が一般的に使用されています。 T シャツのサイズに基づく提供方法にさまざまなリソース タイプと数量を組み合わせる一方で、テンプレートを効果的に使用できるよう一定の基準を設けます。 テンプレートによる一貫した容量の提供方法を通じて社内のポリシーを徹底し、容量を消費している組織へのチャージバックをタグ付けによって行うことができます。

たとえば、開発環境、テスト環境、運用環境を用意し、そこにソフトウェア開発チームがソリューションをデプロイできるように環境を整える必要があるとします。 この環境には、定義済みのネットワーク トポロジと、ソフトウェア開発チームが変更することのできない要素 (パケット インスペクションやパブリック インターネットへのアクセスを統制するルールなど) が存在します。 これらの環境に使用する組織ごとのロールを設け、環境へのアクセス権を個別に設定することもできます。

#### <a name="cloud-hosted-capabilities"></a>クラウドでホストされる機能
個々のソフトウェア パッケージ、社内業務向けの複合的機能など、クラウドでホストされる機能は、テンプレートで対応できます。 そのような複合的機能の例として、Analytics-as-a-Service が挙げられます。分析や視覚化など、各種テクノロジが、あらかじめ定義されたネットワーク トポロジで最適化されて結び付いた構成で提供されます。

クラウドでホストされる機能は、その構築先となるクラウドの容量を提供する際に設定されたセキュリティとロールの影響下にあります。 これらの機能は、そのままの形で提供される場合と、管理されたサービスとして提供される場合とがあります。 後者の場合、管理目的で環境にアクセスできるようにするために、アクセス制限付きのロールが必要となります。

## <a name="cloud-service-vendors"></a>クラウド サービス ベンダー
私たちはさまざまな CSV から話を聞く中で、顧客向けのサービスやそれに関連した要件をデプロイするための、いくつかのアプローチを特定しました。

### <a name="csv-hosted-offering"></a>提供物を CSV 側でホスト
提供物を自社の Azure サブスクリプションでホストする場合、一般に 2 つのホスティング方法があります。顧客ごとにデプロイを区別する方法と、スケール ユニットをデプロイして全顧客共有のインフラストラクチャを補強する方法です。

* **顧客ごとに区別されたデプロイ。** 顧客ごとにデプロイを区別するには、既製の構成のひな形となる複数の固定トポロジが必要です。 これらのデプロイは、仮想マシン (VM) のサイズ、ノード数、関連付けるストレージの量にそれぞれ違いを設けることになります。 顧客ごとの請求額の集計には、デプロイのタグ付けが使用されます。 顧客がそのクラウド環境のさまざまな領域にアクセスできるようにするために、RBAC を有効にします。
* **共有マルチテナント環境でのスケール ユニット。** マルチテナント環境のスケール ユニットをテンプレートで表現することができます。 この場合、同じインフラストラクチャを使用して、すべての顧客に対応することになります。 デプロイは、提供物をホストするための一定の容量 (ユーザー数、トランザクション数など) を備えたリソースの集まりとなります。 需要に応じてこれらのスケール ユニットが増減されます。

### <a name="csv-offering-injected-into-customer-subscription"></a>CSV の提供物を顧客のサブスクリプションに注入
エンド カスタマーが所有するサブスクリプションに貴社のソフトウェアをデプロイします。 テンプレートを使用して、別個のデプロイを顧客の Azure アカウントにデプロイすることができます。

デプロイを顧客のアカウント内で更新、管理できるように、これらのデプロイには RBAC を使用します。

### <a name="azure-marketplace"></a>Azure Marketplace
Azure Marketplace などのマーケットプレースで提供物を宣伝、販売する場合、テンプレートを作成することで、さまざまな種類のデプロイを提供し、顧客の Azure アカウント内で実行することができます。 デプロイの種類は通常、T シャツ サイズ (S、M、L)、製品/利用者タイプ (コミュニティ、開発者、エンタープライズ)、機能タイプ (基本、高可用性) として表すことができます。  場合によっては、これらの種類で特定のデプロイ属性を指定することができます (VM タイプ、ディスク数など)。

## <a name="oss-projects"></a>OSS プロジェクト
オープン ソース プロジェクトでリソース マネージャー テンプレートを使用すると、コミュニティは、実績に裏付けられた手法でソリューションをすばやくデプロイできます。 いずれコミュニティが修正できるようにテンプレートを GitHub リポジトリに保存することが可能です。 ユーザーは、それぞれの Azure サブスクリプションでそれらのテンプレートをデプロイすることができます。

以降のセクションでは、ソリューションを設計する前に考慮する必要のある事柄を明らかにしていきます。

## <a name="identifying-what-is-outside-and-inside-a-vm"></a>VM の外側と内側を特定
テンプレートを設計する際は、仮想マシン (VM) の内側と外側の観点から要件に注目することをお勧めします。

* 外側とは、目的とするデプロイの VM やその他のリソースを意味します (ネットワーク トポロジ、タグ付け、証明書/シークレットへの参照、ロールベースのアクセス制御など)。 これらのリソースはすべて、テンプレートに組み込むことになります。
* 内側とは、インストールするソフトウェアと、望ましい状態にするための全体的な構成を意味します。 その他、VM 拡張機能やスクリプトなどの機構が全体で使用されるか、部分的に使用されます。 これらの機構がテンプレートで識別され実行される場合もありますが、テンプレートに組み込まれることはありません。

以下に示したのは、"内側" の作業の一般的な例です。  

* サーバーのロールや機能をインストールまたは削除する。
* ノード レベルまたはクラスター レベルでソフトウェアをインストールして構成する。
* Web サーバーに Websites をデプロイする。
* データベース スキーマをデプロイする。
* レジストリや各種の構成設定を管理する。
* ファイルとディレクトリを管理する。
* プロセスとサービスを開始、停止、管理する。
* ローカル グループとユーザー アカウントを管理する。
* パッケージをインストールして管理する (.msi、.exe、yum など)。
* 環境変数を管理する。
* ネイティブ スクリプトを実行する (Windows PowerShell、bash など)。

### <a name="desired-state-configuration-dsc"></a>望ましい状態への構成 (DSC: Desired state configuration)
デプロイだけでなく VM 内部の状態について考えながら、自分が定義してソース管理にチェックインした時点の構成からそのデプロイが逸脱することのないように配慮する必要があります。 十分な検討とテストを行わずソース管理にも記録されていないような場当たり的な変更を、開発者や運用スタッフが直接環境に対して行うことのないように徹底します。 手作業での変更はソース管理されないため、この管理は重要です。 また、標準的なデプロイから逸脱し、将来、ソフトウェアのデプロイを自動化するときの妨げになります。

望ましい状態への構成は、社内の従業員だけでなくセキュリティの観点からも重要となります。 ハッカーは絶えずソフトウェア システムの弱点を探し、攻略しようとしています。 それに成功すると、侵入したシステムにファイルをインストールしたり、システムの状態を変更したりするのが普通です。 望ましい状態に構成しておくことで、その状態と実際の状態との差分を特定し、既製の構成に戻すことができます。

DSC のメカニズムを備えたリソース拡張機能としては、PowerShell DSC、Chef、Puppet などが広く普及しています。 これらの拡張機能を使用して VM の初期状態をデプロイできるほか、望ましい状態が維持されていることを確認することができます。

## <a name="common-template-scopes"></a>一般的なテンプレートのスコープ
経験上、ソリューション テンプレートの主なスコープは 3 つあります。 容量と機能とエンド ツー エンドのソリューションです。以降のセクションでは、この 3 つのスコープについて詳しく説明します。

### <a name="capacity-scope"></a>容量スコープ
容量スコープでは、法令やポリシーに沿ってあらかじめ構成された標準トポロジで一連のリソースを提供することに主眼が置かれます。 代表的な例としては、大企業の IT や SI で標準的な開発環境をデプロイするシナリオが挙げられます。

### <a name="capability-scope"></a>機能スコープ
機能スコープで重視されるのは、特定のテクノロジに適したトポロジのデプロイと構成です。 一般的なシナリオとしては、SQL Server、Cassandra、Hadoop などのテクノロジが挙げられます。

### <a name="end-to-end-solution-scope"></a>エンド ツー エンド ソリューション スコープ
エンド ツー エンド ソリューション スコープは、単一の機能の枠を越えて、さまざまな機能から成るエンド ツー エンドのソリューションを提供することを目的とします。  

ソリューション スコープのテンプレートは、機能スコープのテンプレートの集まりに、そのソリューション固有のリソースやロジック、望ましい状態を併せたものとなります。 ソリューション スコープのテンプレートの例は、エンド ツー エンドのデータ パイプライン ソリューション テンプレートです。 そのテンプレートでは、ソリューション固有のトポロジと状態が、Kafka、Storm、Hadoop などの複数の機能スコープのソリューション テンプレートと一緒に使用されます。

## <a name="choosing-free-form-vs-known-configurations"></a>自由形式の構成と既製の構成
利用者の選択肢はできるだけ多い方がテンプレートとしては優れていると直感的には思うかもしれません。しかし自由形式の構成にするか、既製の構成にするかについては、さまざまな考慮事項が存在します。 このセクションでは、このドキュメントで紹介しているアプローチの前提となった顧客の主な要件と技術的考慮事項を取り上げます。

### <a name="free-form-configurations"></a>自由形式の構成
自由形式の構成は一見、理想的です。 利用者が VM タイプを選択し、ノード数やそれらのノードの接続ディスク数も自由に選ぶことができます。それらの選択は、テンプレートへのパラメーターとして実現します。 ただし、この方法はいくつかのシナリオで最適ではありません。

[仮想マシンのサイズ](../virtual-machines/windows/sizes.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)に関するページでは、さまざまな VM タイプと利用可能なサイズが、それぞれ接続可能なハード ディスクの台数 (2、4、8、16、32) と共に示されています。 1 台の接続ディスクの IO の上限は 500 IOPS です。複数のディスクをプールすることで 500 IOPS の倍数単位で処理能力を増やすことができます。 たとえば、16 台のディスクをプールすれば、処理能力は 8,000 IOPS となります。 プールは、オペレーティング システム内の設定で行います。Microsoft Windows では記憶域スペースが、Linux では RAID (Redundant Array of Inexpensive Disk) が使われます。

自由形式の構成では、さまざまな VM インスタンス、インスタンスの VM タイプとサイズ、VM タイプのディスク、VM の内容を構成するスクリプトを選択することができます。

デプロイに複数のノード タイプ (マスター ノードとデータ ノードなど) が存在する、というのはよくあることです。そのためノード タイプごとに同様の選択肢が存在することになります。

デプロイするクラスターがどのような規模であれ、それらの複雑なシナリオで作業が必要になります。 たとえば、8 つのマスター ノードと 200 のデータ ノードとから成る Hadoop クラスターをデプロイするとします。プールする接続ディスク数が、マスター ノードごとに 4 台、データ ノードごとに 16 台とした場合、208 の VM と 3,232 台ものディスクを管理する必要があります。

ストレージ アカウントは、その上限である 20,000 トランザクション/秒を超えると、要求を抑制し始めます。そのため、このトポロジの要件に沿うためには、ストレージ アカウントのパーティション分割を検討すると共に、適切なストレージ アカウント数を計算しなければなりません。 自由形式のアプローチではサポートされる組み合わせが多い分、適切なパーティションを求めるためにはデータの変動に対応した計算が必要となります。 現在、Azure リソース マネージャー テンプレート言語に数学的関数は用意されていないので、その計算はコードの中で独自に対応する必要があります。細かな点まで適切に考慮した独自のテンプレートをハードコーディングすることになります。

大企業の IT や SI のシナリオでは、だれかがテンプレートを管理し、デプロイしたトポロジのサポートを行う必要があります。サポート対象の組織も 1 つとは限りません。 このように、構成内容やテンプレートが顧客ごとに異なることで別途生じるオーバーヘッドは、決して望ましいものではありません。

これらのテンプレートを使用して顧客の Azure サブスクリプションに環境をデプロイすることもできますが、社内 IT チームも CSV も、デプロイ先は自らのサブスクリプションとし、顧客への請求にはチャージバック機能を使用するのが一般的です。 この場合、特定のサブスクリプションのプールに複数の顧客用の容量をデプロイし、それらのサブスクリプションにデプロイを密集させることが大切です。サブスクリプションの無秩序な増殖、つまり管理対象のサブスクリプションの増加を最小限に抑えるためです。 このような密集状態を形成し、デプロイの規模に高い自由度を持たせるためには、思慮深いプランニングと特別な開発工程を提供先の組織に代わって負担する必要があります。

加えて、サブスクリプションの作成は、API 呼び出しで行うことはできず、ポータルから手動で行う必要があります。 サブスクリプションの数が増えるにつれて、その管理に伴う人的負担が大きくなっていきます。それを自動化することはできません。 デプロイの規模には大きなばらつきがあるため、あらかじめ多数のサブスクリプションを手動でプロビジョニングしておく必要があります。サブスクリプションをいつでも利用できる状態にしておくためです。

これらの事情をすべて加味すると、自由度の高い構成というものは、その響きとは裏腹に、さほど魅力的ではないことがわかります。

### <a name="known-configurations--the-t-shirt-sizing-approach"></a>既製の構成 — T シャツ サイズ型のアプローチ
高い柔軟性と多様性に対応したテンプレートというのは、私たちの経験では決して一般的ではありません。一般的なパターンはむしろ、既製の構成を選べるようにすることで、事実、T シャツのような標準的なサイズ区分 (サンドボックス、S、M、L など) が多く使われています。 コミュニティ エディション、エンタープライズ エディションなど製品の提供形態も、T シャツのサイズと同様の区分といえます。  また、MapReduce、NoSQL など、テクノロジのワークロードに基づく構成で大中小を決める場合もあります。

大企業の IT 部門、OSS ベンダー、SI も、その多くがこの方法でソフトウェアを提供しており、大企業ではオンプレミスの仮想環境に、CSV や OSV では SaaS (Software-as-a-Service) にソフトウェアがデプロイされます。

このアプローチの特徴は、さまざまなサイズの構成を顧客向けにあらかじめ用意しておき、良質な既製の構成を提供できることです。 既製の構成が用意されていなければ、エンド カスタマー自身がクラスターの規模を決め、プラットフォーム リソースの制約を加味しながら、ストレージ アカウントや各種リソースの分割サイズを計算しなければなりません (クラスター サイズとリソースの制約のため)。 既製の構成を用いることによって、"T シャツの適切なサイズ"、つまり特定のデプロイを顧客が選びやすくなります。 顧客の利便性を高めることとは別に、既製の構成の数は少ない方がサポートしやすく、密集度も高めやすくなります。

既製の構成というサイズの標準化に主眼を置いたアプローチでも、特定のサイズ内のノードの数に幅を設けることはできます。 たとえば、S サイズのノード数を 3 ～ 10 とすることが考えられます。  サイズとしては 10 ノードにまで対応できるように設計されていますが、利用者は、その上限を上回らない範囲で自由にサイズを選ぶことができます。  

デプロイできるノード数の点では、ワークロードの種類に基づくサイズ区分の方が、本質的に自由度は高くなります。ただし割り当てられるノードのサイズおよびノード上のソフトウェアの構成を決めるのはワークロードです。

製品提供形態 (コミュニティ、エンタープライズなど) に基づくサイズ区分では、デプロイできる最大ノード数とリソースの種類に違いを設けます。提供形態ごとのライセンスの条件や機能の利用の可否でカテゴライズするのが一般的です。

特殊な変動要因を抱えた顧客には、JSON ベースのテンプレートを使用して要求に応えることもできます。 例外的状況に対処するときは、開発、サポート、原価計算を目的とした適切な計画と考慮事項を取り入れるようにしてください。

顧客のテンプレート利用シナリオや、このドキュメントの冒頭で紹介した要件に基づいて、テンプレートの分解パターンを特定しました。

## <a name="capacity-and-capability-scoped-solution-templates"></a>容量スコープと機能スコープのソリューション テンプレート
テンプレート作成において再利用、拡張性、テスト、ツール導入を促進するモジュール式のアプローチは、テンプレートを細かく分けることによって実現します。 このセクションでは、容量スコープまたは機能スコープのテンプレートに分解手法を適用する方法を詳しく説明します。

この分解手法では、メイン テンプレートがパラメーターの値をテンプレート利用者から受け取って、その下流の各種テンプレートとスクリプトに関連付けます。 関連付けられているテンプレートの内外には、パラメーターと静的変数、生成された変数を使用して値が渡されます。

![Template parameters](./media/best-practices-resource-manager-design-templates/template-parameters.png)

**メイン テンプレートに渡されたパラメーターが関連テンプレートに渡されるようす**

以降のセクションでは、単一のテンプレートの構成要素であるテンプレートとスクリプトの種類に注目します。 各セクションでは、テンプレート間で状態情報を受け渡しするための方法を示します。 図中の各タイプのテンプレートとスクリプトについて例を交えながら説明します。 具体的な例については、このドキュメントの最後に紹介している実装例を参照してください。

### <a name="template-metadata"></a>テンプレート メタデータ
テンプレート メタデータ (metadata.json ファイル) には、JSON 形式でテンプレートを表すキー/値のペアが記述されています。人間とソフトウェア システムが読み取れる形式となっています。

![テンプレート メタデータ](./media/best-practices-resource-manager-design-templates/template-metadata.png)

**テンプレート メタデータは metadata.json ファイルに記述される**

ソフトウェア エージェントは metadata.json ファイルを取得して、その情報とテンプレートへのリンクを Web ページまたはディレクトリに発行することができます。 *itemDisplayName*、*description*、*summary*、*githubUsername*、*dateUpdated* などの要素があります。

以下に示したのは、このファイル全体の例です。

    {
        "itemDisplayName": "PostgreSQL 9.3 on Ubuntu VMs",
        "description": "This template creates a PostgreSQL streaming-replication between a master and one or more slave servers each with 2 striped data disks. The database servers are deployed into a private-only subnet with one publicly accessible jumpbox VM in a DMZ subnet with public IP.",
        "summary": "PostgreSQL stream-replication with multiple slave servers and a publicly accessible jumpbox VM",
        "githubUsername": "arsenvlad",
        "dateUpdated": "2015-04-24"
    }

### <a name="main-template"></a>Main template
メイン テンプレートは、ユーザーからパラメーターを受け取り、その情報を使用して複雑なオブジェクト変数を設定し、リンクされたテンプレートを実行します。

![Main template](./media/best-practices-resource-manager-design-templates/main-template.png)

**メイン テンプレートはユーザーからパラメーターを受け取る**

このときに与えるパラメーターの一つに、既製の構成の種類があります。標準化されている (S、M、L など) ことから、T シャツ サイズ パラメーターと呼ばれることもあります。 実際には、このパラメーターはさまざまな使い方ができます。 詳細については、このドキュメントの「既製構成リソース テンプレート」を参照してください。

一部のリソースは、ユーザー パラメーターを通じて指定された既製の構成に関係なくデプロイされます。 これらのリソースは、単一の共有リソース テンプレートを使ってプロビジョニングされ、他のテンプレートと共有されます。そのため、共有リソース テンプレートは最初に実行されます。

指定された既製の構成に関係なく、オプションとしてデプロイされるリソースもあります。

### <a name="shared-resources-template"></a>共有リソース テンプレート
このテンプレートは、既製の構成すべてに共通のリソースを提供します。 仮想ネットワークや可用性セットなど、デプロイする既製構成テンプレートに関係なく必要となる各種のリソースが含まれます。

![Template resources](./media/best-practices-resource-manager-design-templates/template-resources.png)

**共有リソース テンプレート**

リソースの名前 (仮想ネットワーク名など) は、メイン テンプレートに基づきます。 メイン テンプレートの中で変数として指定するか、パラメーターとしてユーザーから受け取ることができます。どちらの方法を使用するかは、組織の要件によって異なります。

### <a name="optional-resources-template"></a>オプション リソース テンプレート
オプション リソース テンプレートには、パラメーターまたは変数の値に基づいてプログラム的にデプロイされるリソースが含まれます。

![Optional resources](./media/best-practices-resource-manager-design-templates/optional-resources.png)

**オプション リソース テンプレート**

たとえば、デプロイされた環境に公共のインターネットから間接的にアクセスできる Jumpbox は、オプション リソース テンプレートを使用して構成することができます。 Jumpbox を有効にするかどうかはパラメーターまたは変数で指定し、*concat* 関数を使用して目的のテンプレートの名前を構築します (*jumpbox_enabled.json* など)。 それによって得られた変数をテンプレートの関連付けで使用し、Jumpbox をインストールします。

オプション リソース テンプレートは、複数の場所から関連付けることができます。

* すべてのデプロイに適用できるときは、パラメーターによって決定されるリンクを共有リソース テンプレートから作成します。
* L サイズのデプロイにのみインストールするなど、限られた既製の構成にのみ適用できるときは、パラメーターによって決まるリンクまたは変数によって決まるリンクを既製構成テンプレートから作成します。

特定のリソースがオプションであるかどうかを決めるのはテンプレートの提供者であり、テンプレートの利用者側で決めることはできません。 たとえば、特定の製品の要件に準拠したり製品のアドオンをインストールしなければならないことや (一般に CSV)、ポリシーを強制的に適用しなければならないこと (一般に SI や大企業の IT 部門) があります。 そのような場合、変数を使って、リソースをデプロイすべきかどうかを判別することができます。

### <a name="known-configuration-resources-template"></a>既製構成リソース テンプレート
メイン テンプレートでパラメーターを公開すると、デプロイする既製の構成をテンプレートの利用者が指定できます。 多くの場合、この既製の構成には、固定構成サイズ (サンドボックス、S、M、L など) による T シャツ サイズ型のアプローチが使用されます。

![Known configuration resources](./media/best-practices-resource-manager-design-templates/known-config.png)

**既製構成リソース テンプレート**

T シャツ サイズ型は万人向けのアプローチですが、あらゆる既製構成をそのパラメーターで表すことができます。 たとえば、エンタープライズ アプリケーションであれば、Development、Test、Product など一連の環境を指定できます。 クラウド サービスであれば、パラメーターを使用して、Community、Developer、Enterprise などさまざまなスケール ユニット、製品バージョン、製品構成を表すことができます。

共有リソース テンプレートと同様、既製構成テンプレートには、次のいずれかの方法で変数が渡されます。

* エンド ユーザー — メイン テンプレートに与えられたパラメーターを受け取ります。
* 組織 — 社内の要件やポリシーを表す変数がメイン テンプレートに記述されます。

### <a name="member-resources-template"></a>メンバー リソース テンプレート
既製の構成に、各種のメンバー ノードが含まれていることは少なくありません。 たとえば、Hadoop では通常、マスター ノードとデータ ノードが必要です。 MongoDB をインストールするのであれば、データ ノードとアービターを含めることになります。 DataStax をデプロイする場合は、データ ノードに加え、OpsCenter がインストールされた VM が必要となります。

![Members resources](./media/best-practices-resource-manager-design-templates/member-resources.png)

**メンバー リソース テンプレート**

VM のサイズ、接続ディスク数、ノードのインストールとセットアップ用のスクリプト、VM のポート構成、インスタンス数など、細かな仕様はノードのタイプごとに異なることが考えられます。 メンバー リソース テンプレートには、インフラストラクチャをデプロイして構成する仕様のほか、その VM にソフトウェアをデプロイして構成するスクリプトを実行するための仕様が記述されており、ノードには、その種類に応じたメンバー リソース テンプレートが適用されることになります。

VM に関しては通常、2 種類のスクリプトが使用されます。広範囲に再利用できるスクリプトとカスタム スクリプトです。

### <a name="widely-reusable-scripts"></a>広範囲に再利用できるスクリプト
広範囲に再利用できるスクリプトとは、テンプレートの種類に関係なく使用できるスクリプトです。 Linux でディスクをプールしたり IOPS 性能を高めたりする目的で RAID をセットアップするためのスクリプトは、そのようなスクリプトの代表例といえます。 VM にインストールするソフトウェアに関係なく、共通の目的において実績のある手法を再利用することができます。

![Reusable scripts](./media/best-practices-resource-manager-design-templates/reusable-scripts.png)

**広範囲に再利用できるスクリプトはメンバー リソース テンプレートから呼び出すことが可能**

### <a name="custom-scripts"></a>カスタム スクリプト
VM 内にソフトウェアをインストールして構成するスクリプトは通常、テンプレートから呼び出されます。 メンバー タイプのインスタンスが複数デプロイされる大規模なトポロジには、共通のパターンが見られます。 並列実行できるインストール スクリプトが VM ごとに開始され、すべての VM (または特定のメンバー タイプのすべての VM) がデプロイされた後でセットアップ スクリプトが呼び出されます。

![カスタム スクリプト](./media/best-practices-resource-manager-design-templates/custom-scripts.png)

**メンバー リソース テンプレートは特定の目的 (VM の構成など) を持ったスクリプトを呼び出すことができる**

## <a name="capability-scoped-solution-template-example---redis"></a>機能スコープのソリューション テンプレートの例 - Redis
具体的な実装方法が理解しやすいように、SML サイズの Redis 環境をデプロイおよび構成するテンプレートの作成例を実際に見ていきましょう。  

このデプロイには、一連の共有リソース (仮想ネットワーク、ストレージ アカウント、可用性セット) とオプション リソース (Jumpbox) を使用します。 T シャツ サイズ (S、M、L) で表される既製の構成がいくつか存在しますが、いずれもノード タイプは 1 つです。 加えて、特定の目的を持ったスクリプトが 2 つ存在します (インストール、構成)。

### <a name="creating-the-template-files"></a>テンプレート ファイルの作成
azuredeploy.json という名前のメイン テンプレートを作成します。

shared-resources.json という名前の共有リソース テンプレートを作成します。

Jumpbox をデプロイするための、jumpbox_enabled.json という名前のオプション リソース テンプレートを作成します。

Redis で使用されるノード タイプは 1 つのみのため、ここでは node-resources.json という名前のメンバー リソース テンプレートを 1 つのみ作成することになります。

Redis では、個々のノードをインストールし、クラスターを設定します。  インストールと設定を支援するスクリプトとして、redis-cluster-install.sh と redis-cluster-setup.sh を使用します。

### <a name="linking-the-templates"></a>テンプレートの関連付け
テンプレートの関連付けを使用して、メイン テンプレートを (仮想ネットワークを構築する) 共有リソース テンプレートに接続します。

メイン テンプレートには、Jumpbox がデプロイされるかどうかをテンプレートの利用者が指定できるようにするためのロジックが追加されています。 *EnableJumpbox* パラメーターの値が *enabled* の場合、利用者が Jumpbox のデプロイを希望している、ということです。 この値が指定されると、Jumpbox 機能のベース テンプレート名にサフィックスとして *_enabled* が連結されます。

メイン テンプレートは、T シャツ サイズのベース テンプレート名にサフィックスとして *large* パラメーター値を適用し、その値をテンプレートの中で使用して、*technology_on_os_large.json* に接続します。

このトポロジの全体像は次の図のようになります。

![Redis template](./media/best-practices-resource-manager-design-templates/redis-template.png)

**Redis テンプレートの構造**

### <a name="configuring-state"></a>状態の構成
クラスター内のノードでは、状態を構成するための 2 つのステップが存在し、そのどちらも特定の目的を持ったスクリプトで表されます。  Redis のインストールは "redis-cluster-install.sh" が実行し、クラスターのセットアップは "redis-cluster-setup.sh" が実行します。

### <a name="supporting-different-size-deployments"></a>異なるサイズのデプロイのサポート
T シャツ サイズ テンプレートは、指定されたサイズ (*large*) でデプロイするノード タイプごとのノード数を変数として指定します。 次に、リソースをループしながら、その数の VM インスタンスをデプロイします。このときリソースには、ノード名と (*copyIndex()* から得られる) シーケンス番号を付け加えることで一意の名前が付けられます。 デプロイは、T シャツ名テンプレート内の定義に従い、ホット ゾーン VM とウォーム ゾーン VM の両方に対して行われます。

## <a name="decomposition-and-end-to-end-solution-scoped-templates"></a>分解とエンド ツー エンドのソリューション スコープのテンプレート
エンド ツー エンドのソリューション スコープを持ったソリューション テンプレートは、全体的なソリューションを提供することが主な役割です。  この方法は通常、機能スコープの複数のテンプレートに、付加的なリソース、ロジック、状態を組み合わせたものになります。

以下の画像で強調されている部分を見てください。機能スコープのテンプレートと同じモデルが、エンド ツー エンド ソリューション スコープのテンプレート用に拡張されていることがわかります。

共有リソース テンプレートおよびオプション リソース テンプレートが果たす役割は、容量スコープおよび機能スコープのテンプレートの場合と同じですが、エンド ツー エンドのソリューションに合わせてスコープが調整されています。

一般に、エンド ツー エンド ソリューションのスコープを持ったテンプレートでも、S、M、L などのサイズを与えることができるので、既製構成リソース テンプレートには、そのソリューションに対する特定の既製構成に求められる要件が反映されます。

既製構成リソース テンプレートは、そのエンド ツー エンド ソリューションに関係のある機能スコープのソリューション テンプレートに接続されるほか、エンド ツー エンド ソリューションに必要なメンバー リソース テンプレートに接続されます。

ソリューションの T シャツ サイズは、機能スコープの個々のテンプレートのサイズとは異なる場合があります。そこで、下流に位置する機能スコープのソリューション テンプレートには、既製構成リソース テンプレート内の変数を使用して適切な値を与えることにより、適切なサイズをデプロイすることになります。

![End-to-end](./media/best-practices-resource-manager-design-templates/end-to-end.png)

**容量スコープまたは機能スコープのソリューション テンプレートに使用されるモデルは、エンド ツー エンド ソリューション テンプレート スコープ用に簡単に拡張可能**

## <a name="preparing-templates-for-the-marketplace"></a>Marketplace を対象としたテンプレートの準備
これまでに挙げたアプローチは、大企業、SI、CSV がテンプレートをデプロイするシナリオや、その顧客側でデプロイできるようにするシナリオにもすぐに対応できます。

もう一つの選択肢となるシナリオは、Marketplace を経由してテンプレートをデプロイする方法です。  この分解手法は、少しの変更を加えるだけで、Marketplace にも応用できます。

先ほども少し触れましたが、テンプレートを使用すると、さまざまな種類のデプロイを提供し、Marketplace で販売することができます。 デプロイの種類はたとえば、T シャツ サイズ (S、M、L)、製品/利用者タイプ (コミュニティ、開発者、エンタープライズ)、機能タイプ (基本、高可用性) として表すことができます。

以下に示したように、エンド ツー エンド ソリューション スコープまたは機能スコープを持った既存のテンプレートを再利用して、さまざまな既製構成を Marketplace で公開することができます。

ここでは、メイン テンプレートの入力パラメーターのうち、tshirtSize というパラメーターが削除されています。

各種デプロイは、既製構成リソース テンプレートにマッピングされる一方で、共通のリソースや構成を必要とします。それらは、共有リソース テンプレートにまとめられているほか、オプション リソース テンプレートに存在する可能性もあります。

テンプレートを Marketplace に発行する場合、以前使用した入力パラメーター tshirtSize をメイン テンプレート内に埋め込まれた変数と置き換えた、メイン テンプレートのさまざまなデプロイを作成することができます。

![Marketplace](./media/best-practices-resource-manager-design-templates/marketplace.png)

**Marketplace 用に調整したソリューション スコープのテンプレート**

## <a name="next-steps"></a>次のステップ
* テンプレート内やテンプレート間での状態の共有方法については、「 [Azure リソース マネージャーのテンプレートでの状態の共有](best-practices-resource-manager-state.md)」を参照してください。
* 企業が Resource Manager を使用してサブスクリプションを効果的に管理する方法については、「[Azure enterprise scaffold - prescriptive subscription governance (Azure エンタープライズ スキャフォールディング - サブスクリプションの規範的な管理)](resource-manager-subscription-governance.md)」を参照してください。


