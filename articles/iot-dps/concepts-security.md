---
title: Azure IoT Hub Device Provisioning Service - セキュリティの概念
description: デバイス プロビジョニング サービス (DPS) と IoT Hub を備えたデバイスに固有のセキュリティ プロビジョニングの概念を説明します。
author: nberdy
ms.author: nberdy
ms.date: 04/04/2019
ms.topic: conceptual
ms.service: iot-dps
services: iot-dps
ms.openlocfilehash: 3191e9886604af9b2a26b71a89cee699197585c4
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/02/2020
ms.locfileid: "84705391"
---
# <a name="iot-hub-device-provisioning-service-security-concepts"></a>IoT Hub デバイス プロビジョニング サービスのセキュリティの概念 

Azure IoT Hub Device Provisioning サービスは IoT Hub のヘルパー サービスです。このサービスは、指定された IoT Hub にプロビジョニングするゼロタッチ デバイスの構成に使用されます。 デバイス プロビジョニング サービスを利用すると、セキュリティで保護されたスケーラブルな方法でいくつものデバイスを[自動プロビジョニング](concepts-auto-provisioning.md)できます。 この記事では、デバイス プロビジョニングに関連付けられた*セキュリティ*の概念の概要を説明します。 この記事は、デプロイのために準備されたデバイスの取得に関わるすべてのユーザーに最も役立ちます。

## <a name="attestation-mechanism"></a>構成証明メカニズム

構成証明書メカニズムは、デバイスの ID の確認に使用される方法です。 また、構成証明メカニズムは、指定されたデバイスで使用する構成証明の方法をプロビジョニング サービスに伝えるための加入契約リストと関係があります。

> [!NOTE]
> IoT Hub は、そのサービスでの同様の概念として "認証スキーム" を使用します。

デバイス プロビジョニング サービスでは、次の形式の構成証明がサポートされます。
* 標準の X.509 証明書の認証フローに基づく**X.509 証明書**。
* nonce チャレンジに基づく**トラステッド プラットフォーム モジュール (TPM)** 。キーの TPM 標準を使用し、署名された Shared Access Signature (SAS) トークンを提示します。 この形式の構成証明では、デバイス上の物理 TPM は必須ではありませんが、[TPM 仕様](https://trustedcomputinggroup.org/work-groups/trusted-platform-module/)に従って保証キーを使用して証明するために、サービスからは物理 TPM が期待されます。
* 共有アクセス署名 (SAS) の[セキュリティ トークン](../iot-hub/iot-hub-devguide-security.md#security-tokens)に基づく**対称キー**。ハッシュ処理された署名と埋め込みの有効期限が含まれています。 詳細については、「[対称キーの構成証明](concepts-symmetric-key-attestation.md)」を参照してください。


## <a name="hardware-security-module"></a>ハードウェア セキュリティ モジュール

ハードウェア セキュリティ モジュール (HSM) は、デバイス シークレットの安全なハードウェア ベースのストレージに使用されます。これは、最も安全な形式のシークレット ストレージです。 X.509 証明書と SAS トークンの両方を HSM に格納できます。 HSM は、プロビジョニングがサポートする両方の構成証明メカニズムで使用できます。

> [!TIP]
> デバイス上に安全にシークレットを保管するために、デバイスに HSM を使用することを強くお勧めします。

デバイス シークレットもソフトウェア (メモリ) に保存できますが、HSM よりも安全性の低い形式のストレージです。

## <a name="trusted-platform-module"></a>トラステッド プラットフォーム モジュール

TPM は、プラットフォームの認証に使用される安全に保管されたキーの標準を参照できます。または、標準を実装しているモジュールとの対話に使用される I/O インターフェイスを参照できます。 TPM は個別ハードウェア、統合ハードウェア、ファームウェアベース、またはソフトウェアベースとして存在する場合があります。 詳細については、[TPM の構成証明](/windows-server/identity/ad-ds/manage/component-updates/tpm-key-attestation)に関する記事をご覧ください。 デバイス プロビジョニング サービスでは、TPM 2.0 のみをサポートします。

TPM の証明書は、nonce チャレンジに基づいています。nonce チャレンジは、保証キーとストレージ ルート キーを使用して署名された Shared Access Signature (SAS) トークンを使用します。

### <a name="endorsement-key"></a>保証キー

保証キーとは、内部で生成された、または製造時に挿入された TPM 内に含まれる非対称キーであり、TPM ごとに一意です。 保証キーは、変更または削除できません。 保証キーの公開部分が正規 TPM の認識に使用されるのに対して、保証キーの秘密部分が TPM の外部に解放されることはありません。 詳細については、[保証キー](https://technet.microsoft.com/library/cc770443(v=ws.11).aspx)に関する記事をご覧ください。

### <a name="storage-root-key"></a>ストレージ ルート キー

ストレージ ルート キーは TPM に格納され、アプリケーションで作成された TPM キーの保護に使用されます。TPM なしでは、これらのキーを使用できません。 ストレージ ルート キーは、TPM の所有権の取得時に生成されます。TPM をクリアすると、新しいユーザーが所有権を取得できるので、新しいストレージ ルート キーが生成されます。 詳細については、[ストレージ ルート キー](https://technet.microsoft.com/library/cc753560(v=ws.11).aspx)に関する記事をご覧ください。

## <a name="x509-certificates"></a>X.509 証明書

X.509 証明書を構成証明メカニズムとして使用することは、実稼働環境を拡張し、デバイスのプロビジョニングを簡素化するための優れた方法です。 X.509 証明書は通常、信頼する証明書チェーンに配置されます。証明書チェーンでは、チェーン内の各証明書が次の上位証明書の秘密キーによって署名され、最後は自己署名ルート証明書で終わります。 この配置により、信頼されたルート証明機関 (CA) によって生成されるルート証明書から、各中間 CA 証明書やデバイスにインストールされたエンドエンティティ "リーフ" 証明書に至る、信頼する委任チェーンが確立されます。 詳細については、「[X.509 CA 証明書を使用したデバイス認証](/azure/iot-hub/iot-hub-x509ca-overview)」をご覧ください。 

証明書チェーンは、多くの場合、デバイスに関連付けられている論理的または物理的階層を表します。 たとえば、製造元は次の事項ができます。
- 自己署名のルート CA 証明書を発行する
- 発行されたルート証明書を使用してファクトリごとに一意の中間 CA 証明書を生成する
- 各ファクトリの証明書を使用して工場の生産ラインごとに一意の中間 CA 証明書を生成する
- 最後に生産ラインの証明書を使用して生産ラインで製造されるデバイスごとに一意のデバイス (エンドエンティティ) 証明書を生成する 

詳細については、「[IoT 業界における X.509 CA 証明書の概念理解](/azure/iot-hub/iot-hub-x509ca-concept)」をご覧ください。 

### <a name="root-certificate"></a>ルート証明書

ルート証明書は、証明機関 (CA) を表す自己署名の X.509 証明書です。 証明書チェーンの終端、つまりトラスト アンカーになります。 ルート証明書は組織が自ら発行することも、ルート証明機関から購入することもできます。 詳細については、「[X.509 CA 証明書を入手する](/azure/iot-hub/iot-hub-security-x509-get-started#get-x509-ca-certificates)」をご覧ください。 ルート証明書は、ルート CA 証明書とも呼ばれます。

### <a name="intermediate-certificate"></a>中間証明機関の証明書

中間証明書は、ルート証明書 (または、証明書チェーン内のルート証明書を使用する別の中間証明書) によって署名された X.509 証明書です。 チェーン内の最後の中間証明書は、リーフ証明書の署名に使用されます。 中間証明書は、中間 CA 証明書とも呼ばれます。

### <a name="end-entity-leaf-certificate"></a>エンド エンティティ "リーフ" 証明書

リーフ証明書、つまりエンドエンティティ証明書は、証明書の所有者を識別します。 リーフ証明書には、証明書チェーン内のルート証明書と 0 個以上の中間証明書が含まれます。 リーフ証明書は、他の証明書の署名には使用されません。 プロビジョニング サービスに対してデバイスを一意に識別し、デバイス証明書と呼ばれることもあります。 デバイスは認証時に、この証明書に関連付けられた秘密キーを使用して、サービスからの所有証明チャレンジに応答します。

[個別の登録](./concepts-service.md#individual-enrollment)エントリで使用されるリーフ証明書には、**サブジェクト名**を個別の登録エントリの登録 ID に設定しなければならないという要件があります。 [登録グループ](./concepts-service.md#enrollment-group)エントリで使用されるリーフ証明書では、**サブジェクト名**が、登録グループ内にある認証済みデバイスの**登録レコード**に表示されているご希望のデバイス ID に設定される必要があります。

詳細については、「[X.509 CA 証明書で署名されたデバイスを認証する](/azure/iot-hub/iot-hub-x509ca-overview#authenticating-devices-signed-with-x509-ca-certificates)」をご覧ください。

## <a name="controlling-device-access-to-the-provisioning-service-with-x509-certificates"></a>X.509 証明書を使用してプロビジョニング サービスへのデバイスのアクセスを制御する

プロビジョニング サービスでは、X.509 構成証明メカニズムを使用するデバイスのアクセス制御に使用できる、次の 2 種類の登録エントリが公開されています。  

- [個別登録](./concepts-service.md#individual-enrollment)エントリは、特定のデバイスに関連付けられたデバイス証明書を使用して構成されます。 これらのエントリは、特定のデバイスの登録を制御します。
- [登録グループ](./concepts-service.md#enrollment-group) エントリは、特定の中間 CA 証明書やルート CA 証明書に関連付けられます。 これらのエントリは、証明書チェーン内にその中間証明書やルート証明書を持つすべてのデバイスの登録を制御します。 

デバイスからプロビジョニング サービスへの接続時には、サービスは具体性の高い登録エントリを、具体性の低いエントリよりも優先します。 つまり、デバイスに個別登録がある場合、プロビジョニング サービスでは個別登録のエントリが適用されます。 デバイスに個別登録がなく、デバイスの証明書チェーン内の最初の中間証明書に登録グループが存在する場合、サービスはこの登録グループ エントリを適用します。これが証明書チェーンのルートまで同様に行われます。 サービスは次のようにして、最初に見つけた適用可能なエントリを適用します。

- 最初に見つけた登録エントリが有効な場合、サービスはデバイスをプロビジョニングします。
- 最初に見つけた登録エントリが無効な場合、サービスはデバイスをプロビジョニングしません。  
- デバイスの証明書チェーン内のどの証明書にも登録エントリが見つからない場合、サービスはデバイスをプロビジョニングしません。 

このメカニズムと証明書チェーン階層構造により、個別のデバイスやデバイス グループへのアクセスを柔軟に制御できます。 たとえば、次の証明書チェーンを持つ 5 つのデバイスがあるとします。 

- *デバイス 1*: ルート証明書 -> 証明書 A -> デバイス 1 の証明書
- *デバイス 2*: ルート証明書 -> 証明書 A -> デバイス 2 の証明書
- *デバイス 3*: ルート証明書 -> 証明書 A -> デバイス 3 の証明書
- *デバイス 4*: ルート証明書 -> 証明書 B -> デバイス 4 の証明書
- *デバイス 5*: ルート証明書 -> 証明書 B -> デバイス 5 の証明書

最初に、5 つすべてのデバイスのアクセスを有効にする、ルート証明書の有効なグループ登録エントリを 1 つ作成します。 後で証明書 B が侵害された場合には、証明書 B に無効な登録グループ エントリを作成して、*デバイス 4* と*デバイス 5* が登録されるのを防ぐことができます。 さらにその後、*デバイス 3* が侵害された場合には、デバイス 3 の証明書に無効な個別登録エントリを作成できます。 これにより*デバイス 3* へのアクセスが取り消されますが、*デバイス 1* と*デバイス 2* ではまだ登録が可能です。