---
title: Azure Cosmos DB インデックス作成ポリシー
description: Azure Cosmos DB でのインデックス作成の自動化とパフォーマンス向上のために、既定のインデックス作成ポリシーを構成および変更する方法について説明します。
author: thomasweiss
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 06/14/2019
ms.author: thweiss
ms.openlocfilehash: 3f19668cc4fb4f4f4a900c157aa79de83ad1b79b
ms.sourcegitcommit: 3e98da33c41a7bbd724f644ce7dedee169eb5028
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/17/2019
ms.locfileid: "67163724"
---
# <a name="indexing-policies-in-azure-cosmos-db"></a>Azure Cosmos DB でのインデックス作成ポリシー

Azure Cosmos DB では、すべてのコンテナーに、コンテナーの項目のインデックスを作成する方法を指示するインデックス作成ポリシーがあります。 新しく作成したコンテナーの既定のインデックス作成ポリシーでは、すべての項目のプロパティに対してインデックスが作成され、文字列または数値には範囲インデックスが、Point 型の GeoJSON オブジェクトには空間インデックスが適用されます。 これにより、インデックス作成とインデックス管理を事前に考慮することなく、高いクエリ パフォーマンスを得ることができます。

状況によっては、この自動動作を、自分の要件にさらに適合するようにオーバーライドできます。 "*インデックス作成モード*" を設定し、"*プロパティ パス*" を含めるか除外することで、コンテナーのインデックス作成ポリシーをカスタマイズできます。

> [!NOTE]
> この記事で説明するインデックス作成ポリシーの更新方法は、Azure Cosmos DB の SQL (Core) API にのみ適用されます。

## <a name="indexing-mode"></a>インデックス作成モード

Azure Cosmos DB では 2 つのインデックス作成モードがサポートされます。

- **同期**: コンテナーのインデックス作成ポリシーが [同期] に設定されている場合、項目を作成、更新、または削除したときにインデックスが同期的に更新されます。 つまり、読み取りクエリの一貫性は、[アカウント用に構成された整合性](consistency-levels.md)になります。

- **なし**:コンテナーのインデックス作成ポリシーが [なし] に設定されている場合、そのコンテナーのインデックス作成は実質的に無効になります。 これは、コンテナーがセカンダリ インデックスを必要としない純粋なキー値ストアとして使用される場合に一般的に使用されます。 それは、一括挿入操作を高速化するためにも役立ちます。

## <a name="including-and-excluding-property-paths"></a>プロパティ パスを含めるか除外する

カスタム インデックス作成ポリシーには、明示的にインデックス作成に含めるかインデックス作成から除外するプロパティ パスを指定できます。 インデックスが作成されるパスの数を最適化することによって、コンテナーによって使用されるストレージの量を削減し、書き込み操作の待機時間を短縮できます。 これらのパスは、[インデックス作成の概要内のセクションで説明されている方法](index-overview.md#from-trees-to-property-paths)に従って定義され、以下のように追加されます。

- スカラー値 (文字列または数値) へのパスは `/?` で終わる
- 配列の要素は、(`/0` や `/1` ではなく) `/[]` 表記でまとめて処理される
- `/*` ワイルドカードを使用してノードの下の任意の要素を一致させることができる

同じ例をもう一度使用します。

    {
        "locations": [
            { "country": "Germany", "city": "Berlin" },
            { "country": "France", "city": "Paris" }
        ],
        "headquarters": { "country": "Belgium", "employees": 250 }
        "exports": [
            { "city": "Moscow" },
            { "city": "Athens" }
        ]
    }

- `headquarters` の `employees` パスは `/headquarters/employees/?`
- `locations` の `country` パスは `/locations/[]/country/?`
- `headquarters` の下にあるもののパスは `/headquarters/*`

インデックス作成ポリシーにパスが明示的に含まれている場合は、そのパスに適用するインデックスの種類と、インデックスの種類ごとにそのインデックスを適用するデータ型も定義する必要があります。

| インデックスの種類 | 可能なターゲット データ型 |
| --- | --- |
| Range | 文字列または数値 |
| Spatial | Point、LineString、または Polygon |

たとえば、`/headquarters/employees/?` パスを含め、そのパスの `String` 値と `Number` 値の両方に `Range` インデックスを適用するように指定できます。

### <a name="includeexclude-strategy"></a>包含/除外戦略

すべてのインデックス作成ポリシーには、含まれるパスまたは除外されるパスのいずれかとしてルート パス `/*` を指定する必要があります。

- インデックスを作成する必要がないパスを選択的に除外するためにルート パスを指定する。 モデルに追加される可能性がある新しいプロパティのインデックスを Azure Cosmos DB で先を見越して作成できるため、これが推奨される方法です。
- インデックスを作成する必要があるパスを選択的に含めるためにルート パスを除外する。

- 英数字や _ (アンダースコア) を含む通常文字から成るパスの場合は、パス文字列を二重引用符で囲んでエスケープする必要はありません ("/path/?" など)。 他の特殊文字を含むパスの場合は、パス文字列を二重引用符で囲んでエスケープする必要があります ("/\"path-abc\"/?" など)。 パスの中に特殊文字が予測される場合は、安全のために、すべてのパスをエスケープすることができます。 機能的には、すべてのパスをエスケープしても、特殊文字を含むパスだけをエスケープしても何も違いはありません。

インデックス作成ポリシーの例については、[こちらのセクション](how-to-manage-indexing-policy.md#indexing-policy-examples)を参照してください。

## <a name="composite-indexes"></a>複合インデックス

2 つ以上のプロパティについて `ORDER BY` を実行するクエリには複合インデックスが必要です。 現在、複合インデックスは複数 `ORDER BY` クエリでのみ利用されます。 既定では、複合インデックスは定義されないため、必要に応じて[複合インデックスを追加する](how-to-manage-indexing-policy.md#composite-indexing-policy-examples)必要があります。

複合インデックスを定義する場合は、次のものを指定します。

- 2 つ以上のプロパティ パス。 プロパティ パスが定義されるシーケンスが重要です。
- 順序 (昇順または降順)。

複合インデックスを使用する場合は、次の考慮事項を使用します。

- 複合インデックスのパスが ORDER BY 句の中のプロパティのシーケンスに一致しない場合、その複合インデックスはクエリをサポートできません

- 複合インデックスのパスの順序 (昇順または降順) も ORDER BY 句の中の順序に一致する必要があります。

- 複合インデックスはまた、すべてのパスで反対の順序を持つ ORDER BY 句もサポートします。

複合インデックスがプロパティ a、b、および c に対して定義されている次の例を考えてみます。

| **複合インデックス**     | **サンプルの `ORDER BY` クエリ**      | **インデックスでサポートされるか?** |
| ----------------------- | -------------------------------- | -------------- |
| ```(a asc, b asc)```         | ```ORDER BY  a asc, b asc```        | ```Yes```            |
| ```(a asc, b asc)```          | ```ORDER BY  b asc, a asc```        | ```No```             |
| ```(a asc, b asc)```          | ```ORDER BY  a desc, b desc```      | ```Yes```            |
| ```(a asc, b asc)```          | ```ORDER BY  a asc, b desc```       | ```No```             |
| ```(a asc, b asc, c asc)``` | ```ORDER BY  a asc, b asc, c asc``` | ```Yes```            |
| ```(a asc, b asc, c asc)``` | ```ORDER BY  a asc, b asc```        | ```No```            |

すべての必要な `ORDER BY` クエリに対応できるように、インデックス作成ポリシーをカスタマイズする必要があります。

## <a name="modifying-the-indexing-policy"></a>インデックス作成ポリシーの変更

コンテナーのインデックス作成ポリシーは、[Azure portal またはサポートされている SDK のいずれかを使用して](how-to-manage-indexing-policy.md)いつでも更新できます。 インデックス作成ポリシーを更新すると、古いインデックスから新しいインデックスへの変換がトリガーされ、オンラインでその場で実行されます (そのため、この操作中に記憶域が追加で消費されることはありません)。 古いポリシーのインデックスは新しいポリシーに効率的に変換され、コンテナー上での書き込み可用性やプロビジョニングされたスループットが影響を受けることはありません。 インデックス変換は非同期操作であり、完了までにかかる時間は、プロビジョニングされたスループット、項目の数、およびそれらのサイズによって決まります。 

> [!NOTE]
> インデックスの再作成の進行中は、一致するすべての結果がクエリで返らない場合があり、その際にエラーが返されることはありません。 つまり、クエリの結果は、インデックス変換が完了するまでは一貫性がない可能性があります。 [いずれかの SDK を使用して](how-to-manage-indexing-policy.md)、インデックス変換の進行状況を追跡できます。

新しいインデックス作成ポリシーのモードが [同期] に設定されている場合、インデックス変換の進行中は、他のインデックス作成ポリシーの変更を適用することはできません。 実行中のインデックス変換は、インデックス作成ポリシーのモードを [なし] に設定することでキャンセルできます (インデックスがただちにドロップされます)。

## <a name="indexing-policies-and-ttl"></a>インデックス作成ポリシーと TTL

[Time-to-live (TTL) 機能](time-to-live.md)がオンになっているコンテナーでは、インデックス作成がアクティブになっている必要があります。 これは、次のことを意味します。

- インデックス作成モードが [なし] に設定されているコンテナーで TTL をアクティブにすることはできません。
- TTL がアクティブになっているコンテナーで、インデックス作成モードを [なし] に設定することはできません。

インデックス作成が必要なプロパティ パスはないが、TTL が必要なシナリオでは、次のようなインデックス作成ポリシーを使用できます。

- インデックス作成モードが [同期] に設定されている
- パスが含まれていない
- 唯一の除外パスとして `/*` が指定されている

## <a name="obsolete-attributes"></a>古い属性

インデックス作成ポリシーの操作時に、現在は古くなっている次の属性が見つかることがあります。

- `automatic` は、インデックス作成ポリシーのルートで定義されたブール値です。 それは現在は無視され、使用しているツールで要求したときに `true` に設定できます。
- `precision` は、含まれるパスのインデックス レベルで定義された数値です。 それは現在は無視され、使用しているツールで要求したときに `-1` に設定できます。
- `hash` は、インデックスの種類であり、現在は Range に置き換わっています。

## <a name="next-steps"></a>次の手順

以下の記事で、インデックス作成についての詳細を参照してください。

- [インデックス作成の概要](index-overview.md)
- [インデックス作成ポリシーを管理する方法](how-to-manage-indexing-policy.md)
