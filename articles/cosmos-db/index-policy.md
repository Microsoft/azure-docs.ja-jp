---
title: Azure Cosmos DB インデックス作成ポリシー
description: Azure Cosmos DB のインデックス作成のしくみを説明します。 インデックス作成の自動化とパフォーマンス向上のために、インデックス作成ポリシーを構成および変更する方法について説明します。
author: markjbrown
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 11/10/2018
ms.author: mjbrown
ms.openlocfilehash: 0fb2c3daf19ce07d9641cbc5504cb3b598ad5b0d
ms.sourcegitcommit: 8330a262abaddaafd4acb04016b68486fba5835b
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/04/2019
ms.locfileid: "54034457"
---
# <a name="indexing-policy-in-azure-cosmos-db"></a>Azure Cosmos DB でのインデックス作成ポリシー

Azure Cosmos コンテナー上の既定のインデックス作成ポリシーは、次のパラメーターを構成することでオーバーライドできます。

* **インデックスに項目とパスを含める、またはインデックスから項目とパスを除外する**: コンテナーへの項目の挿入またはコンテナー内の項目の置換を行うとき、インデックスから特定の項目を除外したり、インデックスに特定の項目を含めたりすることができます。 また、複数のコンテナーにわたってインデックスが作成される特定のパス/プロパティを含めたり除外したりすることもできます。 パスにはアスタリスク (*) のようなワイルドカードのパターンが含まれている場合があります。

* **インデックスの種類を構成する**: インデックスを作成するパスの範囲を設定することに加えて、空間インデックスなど、他の種類のインデックスを追加できます。

* **インデックス作成モードを構成する**: コンテナー上でインデックス作成ポリシーを使用することで、"*同期*" や "*なし*" などの各種インデックス作成モードを構成することができます。

## <a name="indexing-modes"></a>インデックス作成モード 

Azure Cosmos DB では、Azure Cosmos コンテナー上で構成可能なインデックス作成モードとして 2 つがサポートされています。 インデックス作成ポリシーを通して次の 2 つのインデックス作成モードを構成することができます。 

* **同期**: Azure Cosmos コンテナーのポリシーが "同期" に設定されている場合、特定のコンテナーに対するクエリは、ポイントの読み取りに指定されたのと同じ整合性レベル (強固、有界整合性制約、セッション、最終的など) に従います。 

  項目を更新すると、それに同期してインデックスも更新されます。 たとえば、挿入、置換、更新、削除の各操作を項目に対して行うと、そのインデックスが更新されます。 "同期" インデックス作成では、一貫性のあるクエリがサポートされています。しかし、書き込みスループットに影響が及びます。 書き込みスループットの低下は、"インデックス作成の対象となるパス" と "整合性レベル" によって異なります。 "同期" インデックス作成モードは、すばやく書き込み、即座にクエリするワークロード向けに設計されています。

* **なし**: インデックス モードが [なし] に構成されたコンテナーには、インデックスが関連付けられていません。 これは、Azure Cosmos データベースがキー値のストレージとして使用されていて、項目がその ID プロパティによってのみアクセスされる場合によく使用されます。

  > [!NOTE]
  > インデックス作成モードを "なし" で構成すると、既存のインデックスを削除してしまうという副作用があります。 ご利用のアクセス パターンに ID またはセルフ リンクしか必要ない場合に、このオプションを使用してください。

通常の読み取り操作と同様に、クエリの整合性レベルは維持されます。 インデックス作成モードが "なし" に構成されているコンテナーに対してクエリを実行すると、Azure Cosmos データベースからエラーが返されます。 REST API の明示的な  **x-ms-documentdb-enable-scan**  ヘッダーを使用して、または .NET SDK で  **EnableScanInQuery** 要求オプションを使用して、スキャンとしてクエリを実行することができます。 ORDER BY のような一部のクエリ機能は **EnableScanInQuery** で現在サポートされていません。対応するインデックスが必須であることがその理由です。

## <a name="modifying-the-indexing-policy"></a>インデックス作成ポリシーの変更

Azure Cosmos DB では、コンテナーのインデックス作成ポリシーをいつでも更新することができます。 Azure Cosmos コンテナー上でインデックス作成ポリシーを変更すると、インデックスの構造が変わる可能性があります。 この変更は、インデックスを作成できるパス、その有効桁数、およびインデックス自体の整合性モデルに影響します。 インデックス作成ポリシーを変更するには、以前のインデックスを新しいインデックスに変換する必要があります。

### <a name="index-transformations"></a>インデックスの変換

インデックスの変換はすべてオンラインで実行されます。 古いポリシーに従ってインデックス作成された項目は新しいポリシーに従って効率的に変換され、書き込み可用性またはコンテナーにプロビジョニングされたスループットがこの影響を受けることはありません。 SDK または REST API を使用して実行するか、またはストアド プロシージャとトリガーによって実行する読み取り操作と書き込み操作の整合性が、インデックスの変換中に影響を受けることはありません。

インデックス作成ポリシーを変更することは非同期操作であるので、操作の完了までにかかる時間は項目の数、プロビジョニングされたスループット、および項目のサイズによって異なります。 インデックスの再作成中に、変更中のインデックスがご利用のクエリによってたまたま使用された場合、一致するすべての結果がクエリから返されないことがあります。その場合、クエリからエラーは返されません。 インデックスの再作成中は、インデックス作成モードの構成に関係なく、最終的にクエリの一貫性が保たれます。 インデックス変換の完了後も、引き続き一貫性のある結果が表示されます。 これは、REST API、SDK、またはストアド プロシージャとトリガーなどのインターフェイスによって発行されたクエリに適用されます。 インデックスの変換は、特定のレプリカで利用可能なスペア リソースを使用して、レプリカのバックグラウンドで非同期的に行われます。

すべてのインデックス変換が適切に行われます。 Azure Cosmos DB では、インデックスの 2 つのコピーは維持されません。 そのため、インデックス変換の実行中に、追加のディスク領域が必要となることも、ご利用のコンテナー内で使用されることもありません。

インデックス作成ポリシーを変更すると、以前のインデックスから新しいインデックスに移行するために、主にインデックス作成モードの構成に基づく変更が適用されます。 インデックス作成モードの構成は、含めるパスや除外するパス、インデックスの種類、有効桁数などの他のプロパティと比べて、大きな役割を果たします。

以前のインデックス作成ポリシーと新しいインデックス作成ポリシーの両方で **同期** インデックス作成を使用する場合、Azure Cosmos DB ではオンラインでインデックス変換が実行されます。 変換の進行中は、同期 (Consistent) インデックス作成モードで別のインデックス作成ポリシーの変更を適用することはできません。 "なし" インデックス作成に移行すると、インデックスはすぐに削除されます。 "なし" への移行は、進行中の変換を中止して別のインデックス作成ポリシーを最初から開始する場合に便利です。

インデックス変換が正常に完了するように、コンテナーのストレージ スペースが十分であることを確認します。 コンテナーがそのストレージ クォータに到達すると、インデックス変換が一時停止します。 ストレージ スペースが利用可能になると (たとえば、項目をいくつか削除したとき)、インデックス変換は自動的に再開します。

## <a name="modifying-the-indexing-policy---examples"></a>インデックス作成ポリシーの変更 - 例

インデックス作成ポリシーを更新する最も一般的なユース ケースを以下に示します。

* 通常の操作時には一貫した結果が必要だが、データの一括インポート時には**なし**インデックス作成モードに戻す場合。

* 現在ご利用の Azure Cosmos DB コンテナーでインデックス作成機能を使い始める場合。 たとえば、空間インデックスの種類が必要な地理空間クエリや、文字列の範囲インデックスの種類が必要な ORDER BY/文字列の範囲クエリを使用できます。

* 手動で、インデックスを作成するプロパティを選択し、それらを経過と共にご利用のワークロードに合わせて変更する場合。

* インデックス作成時の有効桁数を調整してクエリのパフォーマンスを向上するか、消費されているストレージを減らす場合。

## <a name="next-steps"></a>次の手順

以下の記事で、インデックス作成についての詳細を参照してください。

* [インデックス作成の概要](index-overview.md)
* [インデックスの種類](index-types.md)
* [インデックスのパス](index-paths.md)
* [インデックス作成ポリシーを管理する方法](how-to-manage-indexing-policy.md)
