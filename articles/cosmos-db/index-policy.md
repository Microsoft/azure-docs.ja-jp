---
title: Azure Cosmos DB インデックス作成ポリシー
description: Azure Cosmos DB のインデックス作成のしくみを説明します。 インデックス作成の自動化とパフォーマンス向上のために、インデックス作成ポリシーを構成および変更する方法について説明します。
author: rimman
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 04/08/2019
ms.author: rimman
ms.openlocfilehash: 6998db1679e67f8ac4bf7c81ea9373c66a9618ee
ms.sourcegitcommit: 62d3a040280e83946d1a9548f352da83ef852085
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/08/2019
ms.locfileid: "59278566"
---
# <a name="index-policy-in-azure-cosmos-db"></a>Azure Cosmos DB でのインデックス作成ポリシー

Azure Cosmos コンテナー上の既定のインデックス作成ポリシーは、次のパラメーターを構成することでオーバーライドできます。

* **インデックスに項目とパスを含める、またはインデックスから項目とパスを除外する**: コンテナー内で項目の挿入または置換を行う場合、インデックスでは特定の項目を除外したり含めたりすることが可能です。 また、複数のコンテナーにわたってインデックスが作成される特定のパス/プロパティを含めたり除外したりすることもできます。 パスにはアスタリスク (*) のようなワイルドカードのパターンが含まれている場合があります。

* **インデックスの種類を構成する**:インデックスを作成するパスの範囲設定に加えて、空間インデックスなど、他の種類のインデックスを追加できます。

* **インデックス作成モードを構成する**: コンテナー上でインデックス作成ポリシーを使用することで、"*同期*" や "*なし*" などの各種インデックス作成モードを構成することができます。

## <a name="indexing-modes"></a>インデックス作成モード

Azure Cosmos DB では、インデックス作成ポリシーを利用して Azure Cosmos コンテナー上で構成可能な 2 つのインデックス作成モードをサポートしています。

* **同期**: Azure Cosmos コンテナーのポリシーが "*同期*" に設定されている場合、特定のコンテナーに対するクエリは、ポイントの読み取りに指定されたのと同じ整合性レベル (強固、有界整合性制約、セッション、最終的など) に従います。 

  項目を更新すると、それに同期してインデックスも更新されます。 たとえば、挿入、置換、更新、削除の各操作を項目に対して行うと、そのインデックスが更新されます。 "同期" インデックス作成では、一貫性のあるクエリがサポートされています。しかし、書き込みスループットに影響が及びます。 書き込みスループットの低下は、"インデックスに含まれるパス" と "整合性レベル" に依存します。 "同期" インデックス作成モードは、すべての更新を取り込んでインデックスを最新に保ち、ただちにクエリを提供するように設計されています。

* **なし**:インデックス モードが [なし] に構成されたコンテナーには、インデックスが関連付けられていません。 これは、Azure Cosmos データベースがキー値のストレージとして使用されていて、項目がその ID プロパティによってのみアクセスされる場合によく使用されます。

  > [!NOTE]
  > インデックス作成モードを "*なし*" に構成すると、既存のインデックスを削除してしまうという副作用があります。 ご利用のアクセス パターンに ID またはセルフ リンクしか必要ない場合に、このオプションを使用してください。

通常の読み取り操作と同様に、クエリの整合性レベルは維持されます。 インデックス作成モードが "*なし*" に指定されているコンテナーにクエリを実行すると、Azure Cosmos データベースからエラーが返されます。 REST API にある明示的な **x-ms-documentdb-enable-scan** ヘッダーや、.NET SDK を利用して **EnableScanInQuery** 要求オプションを使用することで、クエリをスキャンとして実行できます。 ORDER BY のような一部のクエリ機能は **EnableScanInQuery** で現在サポートされていません。対応するインデックスが必須であることがその理由です。

## <a name="modifying-the-indexing-policy"></a>インデックス作成ポリシーの変更

Azure Cosmos DB では、コンテナーのインデックス作成ポリシーをいつでも更新することができます。 Azure Cosmos コンテナー上でインデックス作成ポリシーを変更すると、インデックスの構造が変わってしまう可能性があります。 この変更は、インデックスを作成できるパス、その有効桁数、およびインデックス自体の整合性モデルに影響します。 インデックス作成ポリシーを変更するには、以前のインデックスを新しいインデックスに変換する必要があります。

### <a name="index-transformations"></a>インデックスの変換

インデックスの変換はすべてオンラインで実行されます。 古いポリシーに従ってインデックス作成された項目は新しいポリシーに従って効率的に変換され、コンテナー上での書き込み可用性やプロビジョニングされたスループットがこの影響を受けることはありません。 REST API または SDK を使用して実行されるか、あるいはストアド プロシージャとトリガーを使用して実行される読み取り操作と書き込み操作の整合性が、インデックスの変換中に影響を受けることはありません。

インデックス作成ポリシーの変更は非同期操作なので、操作の完了までにかかる時間は項目の数、プロビジョニングされたスループット、および項目のサイズに依存します。 インデックスの再作成中に、変更中のインデックスがクエリによって偶然使用された場合、一致するすべての結果がクエリから返されないことがあります。その場合、クエリからエラーは返されません。 インデックスの再作成中は、インデックス作成モードの構成に関係なく、最終的にクエリの一貫性が保たれます。 インデックス変換の完了後も、引き続き一貫性のある結果が表示されます。 これは、REST API、SDK、またはストアド プロシージャとトリガーなどのインターフェイスによって発行されたクエリに適用されます。 インデックスの変換は、特定のレプリカで利用可能なスペア リソースを使用して、レプリカ上のバックグラウンドで非同期に実行されます。

すべてのインデックス変換が適切に行われます。 Azure Cosmos DB では、インデックスの 2 つのコピーは維持されません。 そのため、インデックス変換の実行中に、追加のディスク領域が必要となることも、ご利用のコンテナー内で使用されることもありません。

インデックス作成ポリシーを変更すると、以前のインデックスから新しいインデックスに移行するために、主にインデックス作成モードの構成に基づいて変更が適用されます。 インデックス作成モードの構成は、含めるパスや除外するパス、インデックスの種類、有効桁数などの他のプロパティと比べて、大きな役割を果たします。

以前のインデックス作成ポリシーと新しいインデックス作成ポリシーの両方で **同期** インデックス作成を使用する場合、Azure Cosmos DB ではオンラインでインデックス変換が実行されます。 変換の進行中は、同期 (Consistent) インデックス作成モードで別のインデックス作成ポリシーの変更を適用することはできません。 "なし" インデックス作成に移行すると、インデックスはすぐに削除されます。 "なし" への移行は、進行中の変換を中止して別のインデックス作成ポリシーを最初から開始する場合に便利です。

## <a name="modifying-the-indexing-policy---examples"></a>インデックス作成ポリシーの変更 - 例

インデックス作成ポリシーを更新する場合の最も一般的なユース ケースを以下に示します。

* 通常の操作時には一貫した結果が必要だが、データの一括インポート時には**なし**のインデックス作成モードに戻す場合。

* 現在ご利用の Azure Cosmos DB コンテナーでインデックス作成機能を使い始める場合。 たとえば、空間インデックスの種類が必要な地理空間クエリや、文字列の範囲インデックスの種類が必要な ORDER BY/文字列の範囲クエリを使用できます。

* 手動で、インデックスを作成するプロパティを選択し、それらを経過と共にご利用のワークロードに合わせて変更する場合。

* インデックス作成時の有効桁数を調整してクエリのパフォーマンスを向上するか、消費されているストレージを減らす場合。

## <a name="next-steps"></a>次の手順

以下の記事で、インデックス作成についての詳細を参照してください。

* [インデックス作成の概要](index-overview.md)
* [インデックスの種類](index-types.md)
* [インデックスのパス](index-paths.md)
* [インデックス作成ポリシーを管理する方法](how-to-manage-indexing-policy.md)
