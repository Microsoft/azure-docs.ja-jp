---
title: Azure Cosmos DB の整合性レベル
description: Azure Cosmos DB には、結果的な一貫性、可用性、待機時間のトレードオフを調整できる 5 つの一貫性レベルがあります。
author: markjbrown
ms.author: mjbrown
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 04/06/2020
ms.openlocfilehash: 5ba3fc70a2ccfbe342e222dbb475658629ec60a4
ms.sourcegitcommit: cec9676ec235ff798d2a5cad6ee45f98a421837b
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/02/2020
ms.locfileid: "85851699"
---
# <a name="consistency-levels-in-azure-cosmos-db"></a>Azure Cosmos DB の整合性レベル

分散型データベースでは高可用性もしくは待機時間の短縮、またはその両方がレプリケーションに依存するため、読み取りの整合性、可用性、待機時間、スループットとの間に基本的なトレードオフが生じます。 市販のほとんどの分散型データベースでは、開発者は 2 つの極端な整合性モデル (*厳密*な整合性と*最終的*な整合性) のどちらかを選ぶことを求められます。 厳密な整合性モデルの線形化可能性は、データ プログラミングの標準基準です。 しかし、(安定状態での) 書き込み待機時間が長く、(障害発生時の) 可用性が低いという代償があります。 その一方で、最終的な整合性は、可用性が高くパフォーマンスに優れていますが、アプリケーションのプログラミングが難しくなります。

Azure Cosmos DB では、2 つの両極端ではなく、幅広い選択肢を利用できるデータ整合性に対応しています。 開発者は、これらの整合性オプションを使用して、最適な選択を行い、高可用性とパフォーマンスに関して詳細なトレードオフを決定できます。

Azure Cosmos DB では、開発者は、整合性の程度に応じて明確に定義された 5 種類の整合性レベルから選択することができます。 これらの整合性レベルは、*強固*、*有界整合性制約*、*セッション*、*一貫性のあるプレフィックス*、および*最終的*です。 これらのレベルは適切に定義されていて直感的であり、具体的な実際のシナリオに使用することができます。 どのレベルにも[可用性とパフォーマンスのトレードオフ](consistency-levels-tradeoffs.md)があり、SLA によって支えられています。 次の図では、さまざまな整合性レベルの範囲内での位置づけを示します。

:::image type="content" source="./media/consistency-levels/five-consistency-levels.png" alt-text="範囲としての整合性" border="false" :::

読み取りと書き込みが行われるリージョン、Azure Cosmos アカウントに関連付けられているリージョン数、またはアカウントの構成に使用されている書き込みリージョンが 1 つか複数かには関係なく、Azure Cosmos アカウントの整合性レベルはリージョンに依存せず、すべての操作で保証されています。

## <a name="scope-of-the-read-consistency"></a>読み取り整合性のスコープ

読み取り整合性は、論理パーティション内をスコープとする 1 つの読み取り操作に適用されます。 読み取り操作はリモート クライアントまたはストアド プロシージャが発行できます。

## <a name="configure-the-default-consistency-level"></a>既定の整合性レベルを構成する

Azure Cosmos アカウントの既定の整合性レベルはいつでも構成できます。 自分のアカウントに構成されている既定の整合性レベルは、そのアカウントのすべての Azure Cosmos データベースおよびコンテナーに適用されます。 コンテナーまたはデータベースに対して発行されるすべての読み取りとクエリでは、指定された整合性レベルが既定で使用されます。 詳しくは、[既定の整合性レベルを構成する](how-to-manage-consistency.md#configure-the-default-consistency-level)方法についての記事をご覧ください。 また、特定の要求に対して既定の整合性レベルをオーバーライドすることもできます。詳細については、「[既定の整合性レベルをオーバーライドする](how-to-manage-consistency.md?#override-the-default-consistency-level)」を参照してください。

## <a name="guarantees-associated-with-consistency-levels"></a>整合性レベルに関連付けられた保証

Azure Cosmos DB によって提供される包括的 SLA では、読み取り要求の 100 パーセントが、選択した任意の整合性レベルについて整合性の保証を満たすことが保証されます。 整合性レベルに関連付けられている整合性の保証がすべて満たされていれば、読み取り要求は整合性の SLA を満たします。 TLA+ 仕様言語を使用した Azure Cosmos DB での 5 つの整合性レベルの正確な定義は、[azure-cosmos-tla](https://github.com/Azure/azure-cosmos-tla) GitHub リポジトリで提供されています。

5 つの整合性レベルのセマンティクスを以下で説明します。

- **厳密**強力な一貫性は、線形化可能性保証を与えます。 線形化可能性は、要求に同時にサービスを提供することを意味します。 読み取りでは、アイテムの最後にコミットされたバージョンが返ることが保証されています。 クライアントが、コミットされていない書き込みや部分的な書き込みを見ることは決してありません。 ユーザーが最新のコミット済みの書き込みを読み取ることが常に保証されます。

  次のグラフィックでは、音符の厳密な一貫性を図解しています。 データが "米国西部 2" リージョンに書き込まれると、他のリージョンからデータを読み取るとき、最新の値が取得されます。

  :::image type="content" source="media/consistency-levels/strong-consistency.gif" alt-text="video":::

- **有界整合性制約**:読み取りでは、整合性のあるプレフィックスの優先が保証されます。 読み取りは、最大でアイテムの *"K"* 個のバージョン (更新)、あるいは期間 *"T"* のどちらか早く達した方の分だけ書き込みよりも遅れる場合があります。 つまり、有界整合性制約を選択する場合、"整合性制約" は 2 つの方法で構成できます。

- アイテムのバージョンの数 (*K*)
- 書き込みに対して読み取りが遅れる期間 (*T*)

有界整合性制約では、「整合性制約期間」外でトータルなグローバル順序が実現されます。 書き込みを受け入れるリージョン内でクライアントが読み取り操作を実行するとき、有界整合性制約整合性で提供される保証は、厳密な整合性の場合と同じです。

整合性制約期間内では、有界整合性制約は次の一貫性の保証を提供します。

- シングルマスター アカウントで同じリージョンにあるクライアントの一貫性 = 強固
- シングルマスター アカウントで様々なリージョンにあるクライアントの一貫性 = 一貫性のあるプレフィックス
- マルチマスター アカウントで単一のリージョンに書き込むクライアントの一貫性 = 一貫性のあるプレフィックス
- マルチマスター アカウントで様々なリージョンに書き込むクライアントの一貫性 = 最終的

  世界中に分散されているアプリケーションで、書き込み時の待ち時間が短く、全体のグローバルな順序保証が求められるとき、有界整合性制約が頻繁に選ばれています。 有界整合性制約は、グループの共同作業と共有、株式相場表示器、発行とサブスクライブまたはキューなどを特徴とするアプリケーションに最適です。次のグラフィックでは、音符の有界整合性制約整合性を図解しています。 データが "米国西部 2" リージョンに書き込まれた後、"米国東部 2" リージョンと "オーストラリア東部" リージョンでは、構成された最大遅延時間または最大操作に基づき、書き込まれた値を読み取ります。

  :::image type="content" source="media/consistency-levels/bounded-staleness-consistency.gif" alt-text="video":::

- **セッション**:単一のクライアント セッション内の読み取りでは、整合性のあるプレフィックス、単調読み取り、単調書き込み、自己書き込みの読み取り、読み取り後の書き込みの優先が保証されます。 これは、単一の「ライター」セッションを使用するか、複数のライターのセッション トークンを共有することを前提としています。

書き込みを実行しているセッションの外部のクライアントは、以下の保証を確認できます。

- シングルマスター アカウントで同じリージョンにあるクライアントの一貫性 = 一貫性のあるプレフィックス
- シングルマスター アカウントで様々なリージョンにあるクライアントの一貫性 = 一貫性のあるプレフィックス
- マルチマスター アカウントで単一のリージョンに書き込むクライアントの一貫性 = 一貫性のあるプレフィックス
- マルチマスター アカウントで複数のリージョンに書き込むクライアントの一貫性 = 最終的

  セッション整合性は、1 つのリージョンのアプリケーションと世界中に分散されたアプリケーションの両方で最も広く使用されている整合性レベルです。 書き込みの待機時間、可用性、読み取りスループットは最終的整合性レベルと同等ですが、ユーザーのコンテキスト内で動作するよう作成されたアプリケーションのニーズに適した整合性保証が提供されます。 次のグラフィックでは、音符のセッション整合性を図解しています。 「米国西部 2 ライター」と「米国東部 2 リーダー」は同じセッション (セッション A) を使用しているため、どちらも同時に同じデータを読み取ります。 一方、"オーストラリア東部" リージョンでは "セッション B" が使用されているため、後でデータを受け取るとき、書き込みと同じ順序になります。

  :::image type="content" source="media/consistency-levels/session-consistency.gif" alt-text="video":::

- **整合性のあるプレフィックス**:返される更新には、それ以外の全更新の一部のプレフィックスが含まれます (ギャップなし)。 整合性のあるプレフィックスの整合性レベルでは、読み取りの際、書き込みを順序どおりに参照することが保証されます。

書き込みが `A, B, C` の順で実行された場合、クライアントでは `A`、`A,B`、または `A,B,C` が確認されますが、`A,C` または `B,A,C` などの順不同の順列が確認されることはありません。 整合性のあるプレフィックスでは、書き込み待機時間、可用性、読み取りスループットは最終的整合性と同等ですが、順序が重要となるシナリオのニーズに合わせて順序も保証されます。 

一貫性のあるプレフィックスの整合性の保証は次のとおりです。

- シングルマスター アカウントで同じリージョンにあるクライアントの一貫性 = 一貫性のあるプレフィックス
- シングルマスター アカウントで様々なリージョンにあるクライアントの一貫性 = 一貫性のあるプレフィックス
- マルチマスター アカウントで単一のリージョンに書き込むクライアントの一貫性 = 一貫性のあるプレフィックス
- マルチマスター アカウントで複数のリージョンに書き込むクライアントの一貫性 = 最終的

次のグラフィックでは、音符の整合性のあるプレフィックスの整合性を図解しています。 すべてのリージョンで、読み取りで順序が乱れた書き込みに遭遇することはありません。

  :::image type="content" source="media/consistency-levels/consistent-prefix.gif" alt-text="video":::

- **Eventual**:読み取りの順序の保証はありません。 さらに書き込みがない場合、レプリカが最終的に収束します。  
クライアントが以前に読み取ったものより古い値を読み取ることがあるため、最終的整合性は最も弱い形態の整合性です。 最終的整合性は、順序保証がアプリケーションで要求されないときに最適です。 たとえば、リツイート、いいね、スレッド化されていないコメントなどです。 次のグラフィックでは、音符の最終的整合性を図解しています。

  :::image type="content" source="media/consistency-levels/eventual-consistency.gif" alt-text="video":::

## <a name="additional-reading"></a>その他の情報

整合性の概念について詳しくは、以下の記事をご覧ください。

- 「[High-level TLA+ specifications for the five consistency levels offered by Azure Cosmos DB (Azure Cosmos DB によって提供される 5 つの整合性レベルのための高レベル TLA+ 仕様)](https://github.com/Azure/azure-cosmos-tla)」
- [レプリケート データの整合性を野球にたとえると (Doug Terry によるビデオ)](https://www.youtube.com/watch?v=gluIh8zd26I)
- [レプリケート データの整合性を野球にたとえると (Doug Terry によるホワイトペーパー)](https://www.microsoft.com/research/publication/replicated-data-consistency-explained-through-baseball/)
- [整合性の低いレプリケート データのためのセッション保証](https://dl.acm.org/citation.cfm?id=383631)
- [先進的な分散データベース システム設計における整合性のトレードオフ:CAP 以外の考慮事項について](https://www.computer.org/csdl/magazine/co/2012/02/mco2012020037/13rRUxjyX7k)
- 「[Probabilistic Bounded Staleness (PBS) for Practical Partial Quorums (現実的なパーシャル クォーラムのための Probabilistic Bounded Staleness (PBS))](https://vldb.org/pvldb/vol5/p776_peterbailis_vldb2012.pdf)」
- 「[Eventually Consistent - Revisited (最終的な整合性 - 改訂版)](https://www.allthingsdistributed.com/2008/12/eventually_consistent.html)」

## <a name="next-steps"></a>次のステップ

Azure Cosmos DB の整合性レベルの概念の詳細については、以下の記事をご覧ください。

- [アプリケーションのための適切な整合性レベルを選択する](consistency-levels-choosing.md)
- [Azure Cosmos DB API における整合性レベル](consistency-levels-across-apis.md)
- [さまざまな整合性レベルでの可用性およびパフォーマンスのトレードオフ](consistency-levels-tradeoffs.md)
- [既定の一貫性レベルを構成する](how-to-manage-consistency.md#configure-the-default-consistency-level)
- [既定の整合性レベルをオーバーライドする](how-to-manage-consistency.md#override-the-default-consistency-level)
