---
title: Azure Cosmos DB で一意なキーを使用する
description: Azure Cosmos DB データベースで一意なキーを使用する方法について説明します
author: aliuy
ms.author: andrl
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 10/30/2018
ms.reviewer: sngun
ms.openlocfilehash: 20e5c96110f07d8eaec218ed167c87a48fd65782
ms.sourcegitcommit: 8330a262abaddaafd4acb04016b68486fba5835b
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/04/2019
ms.locfileid: "54037380"
---
# <a name="unique-keys-in-azure-cosmos-db"></a>Azure Cosmos DB における一意なキー

一意なキーを使用すると、Cosmos コンテナーにデータ整合性のレイヤーを追加できます。 一意キー ポリシーは、Cosmos コンテナーの作成時に作成します。 一意キーを使用することで、論理パーティション内にある 1 つ以上の値の一意性を確保することができます (一意性は[パーティション キー](partition-data.md)ごとに確保できます)。 一意キー ポリシーを使用したコンテナーを作成すると、論理パーティション内に新しい重複項目を作成することができなくなります (一意キー制約で指定されているため)。 パーティション キーと一意キーを組み合わせることで、コンテナーのスコープ内にある項目の一意性が確保されます。

たとえば、電子メール アドレスを一意キー制約にし、`CompanyID` をパーティション キーにして Cosmos コンテナーを作成したとします。 その場合、ユーザーの電子メール アドレスを一意キーとして構成することで、各項目が特定の `CompanyID` 内で一意の電子メール アドレスを持つようにすることができます。 重複する電子メール アドレスを同じパーティション キー値と組み合わせて、2 つの項目を作成することはできません。  

同じメール アドレス (ただし、姓、名、メール アドレスの組み合わせが異なる) を使って複数の項目を作成できるようにするには、一意キー ポリシーに追加のパスを追加します。 つまり、メール アドレスだけに基づいて一意なキーを作成するのではなく、姓、名、メール アドレスの組み合わせを使用して、一意なキーを作成することができます。 その場合、指定した `CompanyID` 内では、3 つの値の一意な組み合わせだけが使用できるようになります。 たとえば、コンテナーには次の値を使った項目を含めることができます。これらの各項目は、一意キー制約に従っています。

|CompanyID|名|姓|電子メール アドレス|
|---|---|---|---|
|Contoso|Gaby|Duperre|gaby@contoso.com |
|Contoso|Gaby|Duperre|gaby@fabrikam.com|
|Fabrikam|Gaby|Duperre|gaby@fabrikam.com|
|Fabrikam|Ivan|Duperre|gaby@fabrikam.com|
|Fabrkam|   |Duperre|gaby@fabraikam.com|
|Fabrkam|   |   |gaby@fabraikam.com|

上記の表に掲載されている組み合わせの項目をもう 1 つ書き込もうとすると、一意キー制約を満たしていないことを示すエラーが返されます。 返されるメッセージは、「Resource with specified ID or name already exists (指定された ID または名前のリソースは既に存在します)」か、「Resource with specified ID, name, or unique index already exists (指定された ID、名前、または一意インデックスのリソースは既に存在します)」のいずれかです。  

## <a name="defining-a-unique-key"></a>一意キーの定義

一意キーは、Cosmos コンテナーの作成時にのみ定義できます。 一意キーは論理パーティションに対してスコープ指定されます。 上記の例の場合、郵便番号に基づいてコンテナーをパーティション分割すると、各論理パーティションに項目の重複が生じる結果になります。 一意キーを作成する際には、次の特性を考慮してください。

* 既存のコンテナーを更新して、異なる一意キーを使用することはできません。 つまり、一意キー ポリシーを持つコンテナーを作成した後に、ポリシーを変更することはできません。

* 既存のコンテナーに一意キーを設定する場合は、一意キー制約を持つコンテナーを新たに作成し、適切なデータ移行ツールを使用して、既存のコンテナーから新しいコンテナーにデータを移動する必要があります。 SQL コンテナーの場合は、[データ移行ツール](import-data.md)を使用してデータを移動します。 MongoDB コンテナーの場合は、[mongoimport.exe または mongorestore.exe](mongodb-migrate.md) を使用してデータを移動します。

* 一意キー ポリシーには、最大 16 個のパス値を含めることができます (たとえば /firstName、/lastName、/address/zipCode など)。 各一意キー ポリシーには、最大で 10 個の一意キー制約または組み合わせを含めることができ、各一意インデックス制約に対する結合パスは 60 バイトを超えないようにする必要があります。 上記の例では、姓、名、メール アドレスの組み合わせで 1 つの制約となっており、含めうる 16 個のパスのうち 3 個が使用されています。

* コンテナーに一意キー ポリシーがある場合、項目を作成、更新、削除するための要求ユニット (RU) 料金が若干高くなります。

* スパースな一意キーはサポートされていません。 一意パスの値が一部不足している場合、それらの値は null 値として扱われます。これは一意性制約に含まれているため、 制約を満たすには、null 値を持つ項目を 1 つまでとする必要があります。

* 一意キー名では大文字と小文字が区別されます。 たとえば、あるコンテナーの一意キー制約が /address/zipcode に設定されているとします。 その場合、データに ZipCode というフィールドがあると、Cosmos DB は一意キーとして "null" を挿入します。これは、"zipcode" と "ZipCode" が同じではないためです。 大文字と小文字が区別されるので、ZipCode を含んでいるその他のレコードは一切挿入できません。"null" の重複は一意キー制約に違反するからです。

## <a name="next-steps"></a>次の手順

* [論理パーティション](partition-data.md)の詳細を確認する
