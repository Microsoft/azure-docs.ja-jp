---
title: Azure Cosmos DB でのパーティション分割
description: Azure Cosmos DB でのパーティション分割、パーティション キーを選択する際のベスト プラクティス、および論理パーティションの管理方法について説明します。
author: deborahc
ms.author: dech
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 05/06/2020
ms.openlocfilehash: aa7d67cd6bd1bd422bd257b75ac5bde3bd534d7e
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/02/2020
ms.locfileid: "85481835"
---
# <a name="partitioning-in-azure-cosmos-db"></a>Azure Cosmos DB でのパーティション分割

Azure Cosmos DB では、パーティション分割を使用して、データベースの個別のコンテナーをスケーリングし、アプリケーションのパフォーマンスのニーズを満たします。 パーティション分割では、コンテナー内の項目が、"*論理パーティション*" と呼ばれる特定のサブセットに分割されます。 論理パーティションは、コンテナー内の各項目に関連付けられている "*パーティション キー*" の値に基づいて形成されます。 1 つの論理パーティション内のすべての項目のパーティション キーの値は同じです。

たとえば、あるコンテナーに項目が保持されているとします。 各項目の `UserID` プロパティには一意の値があります。 `UserID` がそのコンテナー内の項目のパーティション キーであり、1,000 個の一意の `UserID` 値がある場合、1,000 個の論理パーティションがそのコンテナー内に作成されます。

項目の論理パーティションを決めるパーティション キーに加えて、コンテナー内の各項目には "*項目 ID*" (論理パーティション内で一意) があります。 パーティション キーと*項目 ID* を組み合わせて、項目の*インデックス*が作成されます。インデックスによって、項目が一意に識別されます。

[パーティション キーを選択する](partitioning-overview.md#choose-partitionkey)ことは、アプリケーションのパフォーマンスに影響する重要な決定事項です。

## <a name="managing-logical-partitions"></a>論理パーティションの管理

Azure Cosmos DB では、論理パーティションの物理パーティションへの配置が透過的かつ自動的に管理され、コンテナーのスケーラビリティとパフォーマンスのニーズが効率的に満たされます。 アプリケーションのスループットとストレージの要件が上がると、Azure Cosmos DB は論理パーティションを移動し、より多くの物理パーティションに負荷を自動的に分散します。 [物理パーティション](partition-data.md#physical-partitions)の詳細を参照できます。

Azure Cosmos DB は、ハッシュベースのパーティション分割を使用して、論理パーティションを物理パーティションに分散します。 Azure Cosmos DB では、項目のパーティション キー値をハッシュします。 ハッシュの結果で、物理パーティションが決定します。 次に、Azure Cosmos DB が物理パーティションに対し、パーティション キー ハッシュのキー空間を均等に割り当てます。

ストアド プロシージャまたはトリガー内のトランザクションは、1 つの論理パーティション内の項目に対してのみ使用できます。

[Azure Cosmos DB でパーティションを管理する方法](partition-data.md)の詳細を参照できます。 (アプリケーションをビルドまたは実行するために内部の詳細を理解する必要はありませんが、興味がある方のためにここに追加されています。)

## <a name="choosing-a-partition-key"></a><a id="choose-partitionkey"></a>パーティション キーを使用する場合

パーティション キーには、**パーティション キーのパス**と**パーティション キーの値**の 2 つのコンポーネントがあります。 例として、項目 { "userId" :"Andrew", "worksFor":"Microsoft" } について考えてみます。パーティション キーとして "userId" を選択した場合、パーティション キーの 2 つのコンポーネントは次のようになります。

* パーティション キーのパス (例: "/userId")。 パーティション キーのパスには、英数字とアンダースコア (_) 文字を使用できます。 また、標準パス表記 (/) を使用して、入れ子になったオブジェクトを使用することもできます。

* パーティション キーの値 (例:"Andrew")。 パーティション キーの値には、文字列型または数値型を使用できます。

パーティション キーのスループット、ストレージ、および長さの制限については、記事「[Azure Cosmos DB サービスのクォータ](concepts-limits.md)」を参照してください。

パーティション キーの選択はシンプルですが、Azure Cosmos DB での設計上の重要な選択です。 パーティション キーを選択した後は、その場で変更することはできません。 パーティション キーを変更する必要がある場合は、新しい必要なパーティション キーを使用して、新しいコンテナーにデータを移動する必要があります。

**すべての**コンテナーで、パーティション キーが次のようになっている必要があります。

* 値が変更されないプロパティであること。 プロパティがパーティション キーの場合、そのプロパティの値を更新することはできません。
* 高いカーディナリティがあること。 言い換えると、プロパティには、有効な値が広範囲に及ぶことが必要です。
* 要求ユニット (RU) の消費量とデータ ストレージをすべての論理パーティションに均等に分散すること。 これにより、物理パーティション全体でも RU の消費とストレージの分散が保証されます。

Azure Cosmos DB で[複数項目の ACID トランザクション](database-transactions-optimistic-concurrency.md#multi-item-transactions)が必要な場合は、[ストアド プロシージャまたはトリガー](how-to-write-stored-procedures-triggers-udfs.md#stored-procedures)を使用する必要があります。 すべての JavaScript ベースのストアド プロシージャとトリガーのスコープは、1 つの論理パーティションに限定されます。

## <a name="partition-keys-for-read-heavy-containers"></a>読み取り負荷の高いコンテナーのパーティション キー

ほとんどのコンテナーでは、パーティション キーを選択するときに考慮する必要があるのは、上記の条件だけです。 ただし、大規模な読み取り負荷の高いコンテナーの場合は、クエリでフィルターとして頻繁に表示されるパーティション キーを選択することができます。 フィルターの述語にパーティション キーを含めることで、クエリ呼び出しを[関係する物理パーティションにだけ効率的にルーティング](how-to-query-container.md#in-partition-query)できます。

ワークロードの要求のほとんどがクエリで、ほとんどのクエリが同じプロパティに対する等値フィルターを適用している場合、このプロパティが適切なパーティション キーの選択になりえます。 たとえば、`UserID` に対してフィルター処理を行うクエリを頻繁に実行する場合、パーティション キーとして `UserID` を選択すると[クロスパーティション クエリ](how-to-query-container.md#avoiding-cross-partition-queries)の数が減少します。

ただし、コンテナーが小さい場合は、恐らくクロスパーティション クエリのパフォーマンスへの影響について心配するような量の物理パーティションがありません。 Azure Cosmos DB 内の小さなコンテナーのほとんどは、1 つまたは 2 つの物理パーティションのみを必要とします。

コンテナーがいくつかの物理パーティションに拡張される可能性がある場合は、クロスパーティション クエリを最小化するパーティション キーを選択する必要があります。 次のいずれかに該当する場合、コンテナーにはいくつかの物理パーティションが必要になります。

* コンテナーは 30,000 RU を超えてプロビジョニングされる
* コンテナーが 100 GB を超えるデータを格納する

## <a name="using-item-id-as-the-partition-key"></a>パーティション キーとして項目 ID を使用する

コンテナーに、有効な値が広範囲にわたるプロパティがある場合は、パーティション キーの選択肢として優れたものがあります。 このようなプロパティの 1 つの例として、*項目 ID* があります。 サイズが小さく読み取り負荷の高いコンテナー、または、あらゆるサイズの書き込みの多いコンテナーの場合、*項目 ID* は、必然的にパーティション キーに適しています。

*項目 ID* システム プロパティは、Cosmos コンテナー内のすべての項目に存在することが保証されています。 項目の論理 ID を表す他のプロパティがある場合があります。 多くの場合、これらは*項目 ID* と同じ理由で、パーティション キーとして選択することに適しています。

*項目 ID* は、次のような理由でパーティション キーの選択肢として適しています。

* 有効な値の範囲が幅広い (項目ごとに 1 つの一意の *項目 ID*)。
* 項目ごとに一意の *項目 ID* があるので、*項目 ID* は、RU の消費量とデータ ストレージを均等に分散するため。
* *項目 ID* がわかっている場合は、項目のパーティション キーが常にわかっているため、効率的なポイント読み取りを簡単に行うことができます。

*項目 ID* をパーティション キーとして選択する場合は、次の点に注意してください。

* *項目 ID* がパーティション キーの場合は、コンテナー全体を通じての一意識別子になります。 *項目 ID* が重複している項目は存在できません。
* 大量の[物理パーティション](partition-data.md#physical-partitions)を含む読み取り負荷の高いコンテナーがある場合、*項目 ID*を持つ等値フィルターを使用するクエリの方が効率的になります。
* 複数の論理パーティションでストアド プロシージャまたはトリガーを実行することはできません。

## <a name="next-steps"></a>次のステップ

* [Azure Cosmos DB でのパーティション分割と水平スケーリング](partition-data.md)について理解します。
* [Azure Cosmos DB におけるスループットのプロビジョニング](request-units.md)について理解します。
* [Azure Cosmos DB の世界規模での分散](distribute-data-globally.md)について理解します。
