---
title: Azure Cosmos DB で適切なスループット オファーを選択する方法
description: ワークロードに対して、標準 (手動) のプロビジョニング スループットと自動スケーリングのプロビジョニング スループットから選択する方法について説明します。
author: deborahc
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 08/19/2020
ms.author: dech
ms.openlocfilehash: fbe17d75ad809c54939624b1409e281b2f62a037
ms.sourcegitcommit: d661149f8db075800242bef070ea30f82448981e
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/19/2020
ms.locfileid: "88605215"
---
# <a name="how-to-choose-between-standard-manual-and-autoscale-provisioned-throughput"></a>標準 (手動) および自動スケーリングのプロビジョニング スループットから選択する方法 

Azure Cosmos DB では、標準 (手動) と自動スケーリングの 2 つのプロビジョニング スループットの種類 (プラン) がサポートされています。 どちらのスループットの種類も、ハイ パフォーマンスとスケールを必要とするミッション クリティカルなワークロードに適しており、スループット、可用性、待機時間、および整合性に関する同じ Azure Cosmos DB SLA によって支えられています。

この記事では、ワークロードに対して標準 (手動) と自動スケーリングのプロビジョニング スループットから選択する方法について説明します。 

## <a name="overview-of-provisioned-throughput-types"></a>プロビジョニング スループットの種類の概要
標準 (手動) と自動スケーリングの違いに進む前に、まず、プロビジョニング スループットが Azure Cosmos DB でどのように動作するかを理解しておくことが重要です。 

プロビジョニング スループットを使用する場合は、ワークロードに必要な 1 秒あたりの要求ユニット数 (RU/秒) で測定されるスループットを設定します。 サービスによって、スループット要件をサポートするために必要な容量がプロビジョニングされます。 読み取り、書き込み、クエリなどのサービスに対するデータベース操作では、一定量の要求ユニット (RU) が消費されます。 詳細については、[要求ユニット](request-units.md)に関する記事を参照してください。

次の表は、標準 (手動) と自動スケーリング間の大まかな比較を示しています。

|説明|標準 (手動)|自動スケール|
|-------------|------|-------|
|最も適しているデータ|ワークロードのトラフィックが安定しているか、または予測できる|ワークロードのトラフィックが変動するか、または予測できない。 「[自動スケーリングのユース ケース](provision-throughput-autoscale.md#use-cases-of-autoscale)」を参照してください。|
|しくみ|手動で変更しない限り、静的な一定の RU/秒 `T` を経時的にプロビジョニングします。 1 秒あたり、最大 `T` RU/秒のスループットを使用できます。 <br/><br/>たとえば、標準 (手動) の 400 RU/秒を設定した場合、スループットは 400 RU/秒のままになります。|システム上で超えてはいけない最高 (最大) RU/秒 `Tmax` を設定します。 システムでは、`0.1* Tmax <= T <= Tmax` のように、スループット `T` が自動的にスケーリングされます。 <br/><br/>たとえば、自動スケーリングの最大 RU/秒を 4000 RU/秒に設定した場合、システムでは 400 から 4000 RU/秒の間でスケーリングが行われます。|
|いつ使用するか|スループット容量 (RU/秒) を手動で管理し、自分でスケーリングしたいと考えている。<br/><br/>プロビジョニングされた RU/秒の使用率が一貫して高い。 プロビジョニングされた RU/秒 `T` を設定しており、1 か月の全時間数のうち、全容量を使用している時間が 66% 以上の場合、標準 (手動) のプロビジョニングされた RU/秒によって節約できると推定されます。<br/><br/>これは、標準 (手動) で `T` を設定した場合と、自動スケーリングで同じ量の `Tmax` を設定した場合の比較に基づいています。 |Azure Cosmos DB によって、使用率に基づいてスループット容量 (RU/秒) とスケールを管理したいと考えている。<br/><br/>RU/秒の使用率が変動するか、予測が難しい。 自動スケーリングの最大 RU/秒 `Tmax` を設定しており、1 か月の全時間数のうち、全 `Tmax` 量を使用している時間が 66% 以下の場合、自動スケーリングによって節約できると推定されます。<br/><br/>これは、自動スケーリングの `Tmax` を設定した場合と、標準 (手動) スループットで同じ量の `T` を設定した場合の比較に基づいています。|
|課金モデル|消費された RU 数に関係なく、プロビジョニングされた RU/ 秒に対して 1 時間ごとに課金が行われます。<br/><br/>例: <li>400 RU/秒をプロビジョニングする</li><li>時間 1: 要求なし</li><li>時間 2:400 RU/秒に相当する要求</li><br/><br/>時間 1 と 2 の両方について、どちらの時間に対しても[標準 (手動) のレート](https://azure.microsoft.com/pricing/details/cosmos-db/)で 400 RU/秒の料金が請求されます。|その時間内にシステム上でスケーリングされた最高の RU/秒に対して、1 時間ごとに課金が行われます。 <br/><br/>例: <li>4000 RU/秒の自動スケーリングの最大 RU/秒をプロビジョニングする (400 から 4000 RU/秒の間でスケーリングされる)</li><li>時間 1: システムによって最大値 3500 RU/秒までスケールアップされた</li><li>時間 2: 使用されていないため、システムが最小の 400 RU/秒にスケールダウンされた (常に `Tmax` の 10%)</li><br/><br/>[自動スケーリングのプロビジョニング スループット レート](https://azure.microsoft.com/pricing/details/cosmos-db/)では、時間 1 での 3500 RU/秒、時間 2 での 400 RU/秒に対して料金が請求されます。 RU/秒あたりの自動スケーリング レートは、1.5 * 標準 (手動) レートです。
|プロビジョニングされた RU/秒を超えた場合の動作|プロビジョニング対象に対して、RU/秒は静的なままです。 プロビジョニングされた RU を超えて瞬時に消費する要求では、レートが制限され、再試行までの待機時間を推奨する応答が返されます。 必要に応じて、RU/秒を手動で増減できます。| システムによって、RU/秒が自動スケーリングの最大 RU/秒にスケールアップされます。 自動スケーリングの最大 RU/秒を超えて瞬時に消費する要求では、レートが制限され、再試行までの待機時間を推奨する応答が返されます。|

## <a name="understand-your-traffic-patterns"></a>トラフィック パターンを理解する

### <a name="new-applications"></a>新しいアプリケーション ###

新しいアプリケーションを構築しており、トラフィック パターンをまだ把握していない場合は、最初にプロビジョニングの過多を避けるために、エントリ ポイント RU/秒 (最小 RU/秒) から始めることができます。 また、高いスケールを必要としない小規模なアプリケーションの場合は、コストを最適化するために最低限のエントリ ポイント RU/秒だけをプロビジョニングしてもかまいません。 予想されるトラフィックが少ない小規模なアプリケーションの場合は、[サーバーレス](throughput-serverless.md)容量モードを検討することもできます。

標準 (手動) と自動スケーリングのどちらを使用するかにかかわらず、次の点を考慮する必要があります。

400 RU/秒のエントリ ポイントで標準 (手動) RU/秒をプロビジョニングした場合、手動でスループットを変更しない限り、400 RU/秒を超えて消費することはできません。 料金は、標準 (手動) のプロビジョニング スループット レートで、1 時間あたり 400 RU/秒に対して請求されます。

最大 RU/秒である 4000 RU/秒のエントリ ポイントで自動スケーリングのスループットをプロビジョニングした場合、リソースは 400 から 4000 RU/秒の間でスケーリングされます。 自動スケーリングのスループットでは RU/秒あたりの課金レートが標準 (手動) レートの 1.5 倍になるため、システムが最小の 400 RU/秒までスケールダウンされた時間数に対する請求額は、400 RU/秒を手動でプロビジョニングした場合よりも高くなります。 ただし、自動スケーリングでは、アプリケーション トラフィックが急増した場合、ユーザーの操作を必要とせずに最大 4000 RU/秒まで消費することができます。 一般的には、自動スケーリングでは 1.5 倍のレートで最大の RU/秒までいつでも消費できるというメリットを重視する必要があります。

スループットの要件を見積もるには、Azure Cosmos DB の[容量計算ツール](estimate-ru-with-capacity-planner.md)を使用します。 

### <a name="existing-applications"></a>既存のアプリケーション ###

既存のアプリケーション上で標準 (手動) のプロビジョニング スループットを使用している場合は、[Azure Monitor のメトリック](../azure-monitor/insights/cosmosdb-insights-overview.md)を使用して、トラフィック パターンが自動スケーリングに適しているかどうかを判断できます。 

まず、データベースまたはコンテナーの[正規化された要求ユニット消費量メトリック](monitor-normalized-request-units.md#view-the-normalized-request-unit-consumption-metric)を調べます。 正規化された使用率は、現在、標準 (手動) のプロビジョニング スループットをどの程度の量まで使用しているかを示す尺度です。 この数値が 100% に近いほど、プロビジョニングされた RU/秒をほぼすべて使用しています。 メトリックに関する[詳細を確認してください](monitor-normalized-request-units.md#view-the-normalized-request-unit-consumption-metric)。

次に、正規化された使用率が経時的にどのように変化するかを見極めます。 正規化された使用率が変動するか、または予測できないと判断した場合は、データベースまたはコンテナー上で自動スケーリングを有効にすることを検討してください。 逆に、安定しており予測可能な場合は、標準 (手動) のプロビジョニング スループットのままにしておくことを検討してください。 

> [!TIP]
> 標準 (手動) のスループットでは、正規化された使用率メトリックを使用して、自動スケーリングに切り替えた場合に使用できる実際の RU/秒を見積もることができます。 特定の時点での正規化された使用率に、現在プロビジョニングされている標準 (手動) の RU/秒を乗算します。 たとえば、5000 RU/秒をプロビジョニングしており、正規化された使用率が 90% の場合、RU/秒の使用率は 0.9 * 5000 = 4500 RU/秒になります。 トラフィック パターンが変動するのに、プロビジョニングは過多または過少になっていると判断した場合は、自動スケーリングを有効にし、状況に応じて自動スケーリングの最大 RU/秒の設定を変更することができます。

## <a name="measure-and-monitor-your-usage"></a>使用率を測定して監視する
スループットの種類を選択した後は、経時的にアプリケーションを監視し、必要に応じて調整を行う必要があります。 

自動スケーリングを利用している場合は、Azure Monitor を使用して、プロビジョニングされた自動スケーリングの最大 RU/秒 (**自動スケーリングの最大スループット**) と、システム上で現在スケーリングされている RU/秒 (**プロビジョニングされているスループット**) を確認します。 以下に示す例は、ワークロードが変動するかまたは予測できず、自動スケーリングを使用している場合です。 トラフィックが存在しないときは、システム上で RU/秒が最大 RU/秒のうちの最小 10% までスケーリングされることに注意してください (ここでは、それぞれ 50,000 RU/秒と 5,000 RU/秒です)。 

:::image type="content" source="media/how-to-choose-offer/autoscale-metrics-azure-monitor.png" alt-text="自動スケーリングを使用したワークロードの例":::

> [!NOTE]
> 標準 (手動) のプロビジョニング スループットを使用する場合、**プロビジョニングされたスループット**のメトリックとは、ユーザーが設定した値のことを言います。 自動スケーリングのスループットを使用する場合、このメトリックは、システム上で現在スケーリングされている RU/秒のことです。

## <a name="next-steps"></a>次のステップ
* [RU 計算ツール](https://cosmos.azure.com/capacitycalculator/)を使用して、新しいワークロードのスループットを見積もる。
* [Azure Monitor](monitor-cosmos-db.md#view-operation-level-metrics-for-azure-cosmos-db) を使用して、既存のワークロードを監視する。
* [Azure Cosmos のデータベースまたはコンテナー上で自動スケーリングのスループットをプロビジョニングする](how-to-provision-autoscale-throughput.md)方法を確認する。
* [自動スケーリングに関する FAQ](autoscale-faq.md) を確認する。