---
title: Azure Cosmos のコンテナーとデータベースでスループットをプロビジョニングする
description: Azure Cosmos のコンテナーとデータベースにプロビジョニング済みスループットを設定する方法について説明します。
author: markjbrown
ms.author: mjbrown
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 08/19/2020
ms.openlocfilehash: 00ed8f6ff9839c227f3d8a929a071834c5559226
ms.sourcegitcommit: d661149f8db075800242bef070ea30f82448981e
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/19/2020
ms.locfileid: "88605735"
---
# <a name="introduction-to-provisioned-throughput-in-azure-cosmos-db"></a>Azure Cosmos DB におけるスループットのプロビジョニングの概要

Azure Cosmos DB では、データベースとコンテナーでプロビジョニング済みのスループットを設定できます。 プロビジョニング済みスループットには、標準 (手動) と自動スケールの 2 種類があります。 この記事では、プロビジョニング済みスループットのしくみについて概説します。 

Azure Cosmos データベースは、一連のコンテナーの管理の単位です。 データベースは、スキーマに依存しない一連のコンテナーで構成されます。 Azure Cosmos コンテナーは、スループットとストレージの両方のスケーラビリティの単位です。 コンテナーは、Azure リージョン内の一連のマシン全体で水平方向にパーティション分割され、Azure Cosmos アカウントに関連付けられているすべての Azure リージョンに分散されます。

Azure Cosmos DB では、2 つの細分性でスループットをプロビジョニングできます。
 
- Azure Cosmos コンテナー
- Azure Cosmos データベース

## <a name="set-throughput-on-a-container"></a>コンテナーでスループットを設定する  

Azure Cosmos コンテナーに対してプロビジョニングされたスループットは、そのコンテナー専用に予約されます。 コンテナーは、常にプロビジョニング済みスループットを受け取ります。 コンテナーのプロビジョニング済みスループットは、SLA によって料金が保証されます。 コンテナーで標準 (手動) スループットを構成する方法については、「[Azure Cosmos コンテナー上でのスループットをプロビジョニングする](how-to-provision-container-throughput.md)」を参照してください。 コンテナーで自動スケール スループットを構成する方法については、「[自動スケーリングのスループットをプロビジョニングする](how-to-provision-autoscale-throughput.md)」を参照してください。

コンテナー上にプロビジョニング済みのスループットに関する設定は、最も頻繁に使用されるオプションです。 [要求ユニット (RU)](request-units.md) を使用して任意の量のスループットをプロビジョニングすることにより、コンテナーのスループットをエラスティックにスケーリングできます。 

コンテナーに対してプロビジョニングされたスループットは、物理パーティション間に均等に分散されます。また、パーティション キーが適切で、論理パーティションが物理パーティションに均等に分散されているとすると、スループットはコンテナーのすべての論理パーティション間にも均等に分散されます。 論理パーティションのスループットを選択的に指定することはできません。 コンテナーの 1 つ以上の論理パーティションが物理パーティションによってホストされているため、物理パーティションはそのコンテナーにのみ属し、そのコンテナーにプロビジョニングされたスループットをサポートします。 

論理パーティションで実行されているワークロードの消費量が、基になる物理パーティションに割り当てられているスループットより多い場合、ユーザーの操作がレート制限される可能性があります。 1 つの論理パーティションの要求数が、他のパーティション キー値よりも不釣り合いに多い場合は、_ホット パーティション_と呼ばれるものが発生します。

レートの制限が発生した場合は、コンテナー全体のプロビジョニング済みスループットを増やすか、操作を再試行することができます。 また、ストレージと要求の量を均等に配布するパーティション キーを選択したことを確認する必要があります。 パーティション分割の詳細については、「[Azure Cosmos DB でのパーティション分割と水平スケーリング](partition-data.md)」を参照してください。

コンテナーのパフォーマンスを保証する必要がある場合は、コンテナーの単位でスループットを構成することをお勧めします。

次のイメージは、物理パーティションによって、コンテナーの 1 つ以上の論理パーティションをホストする方法を示しています。

:::image type="content" source="./media/set-throughput/resource-partition.png" alt-text="物理パーティション" border="false":::

## <a name="set-throughput-on-a-database"></a>データベースでスループットを設定する

> [!NOTE]
> 現在のところ、[カスタマーマネージド キー](how-to-setup-cmk.md)が有効なアカウントでは、Azure Cosmos データベースでのスループットのプロビジョニングを使用できません。

Azure Cosmos データベースでスループットをプロビジョニングすると、スループットはデータベースのすべてのコンテナー (共有データベース コンテナーと呼ばれます) で共有されます。 例外は、データベース内の特定のコンテナーでプロビジョニング済みスループットを指定した場合です。 データベースレベルのプロビジョニング済みスループットを複数のコンテナーで共有することは、マシンのクラスター上でデータベースをホストすることと似ています。 データベース内のすべてのコンテナーによって、コンピューターで使用可能なリソースが共有されるため、必然的に、特定のコンテナーで予想どおりのパフォーマンスを得ることはできません。 データベース上のプロビジョニング済みスループットを構成する方法については、[Azure Cosmos データベース上のプロビジョニング済みスループットの構成](how-to-provision-database-throughput.md)に関するページを参照してください。 データベースで自動スケール スループットを構成する方法については、「[自動スケーリングのスループットをプロビジョニングする](how-to-provision-autoscale-throughput.md)」を参照してください。

Azure Cosmos データベースにスループットを設定することで、そのデータベースに対してプロビジョニング済みのスループットを常時利用できることが保証されます。 データベース内のすべてのコンテナーによってプロビジョニング済みスループットが共有されるため、Azure Cosmos DB データベースでは、そのデータベース内の特定のコンテナーに対して、予測可能なスループットは保証されません。 特定のコンテナーが受け取ることができるスループットの部分は、次に依存します。

* コンテナーの数。
* さまざまなコンテナーのパーティション キーの選択。
* コンテナーのさまざまな論理パーティション間のワークロードの分散。 

複数のコンテナーでスループットを共有するが、スループットを特定のコンテナー専用にしたくない場合は、データベースでスループットを構成することをお勧めします。 

次に、データベース レベルでスループットをプロビジョニングすることが望ましい例を示します。

* データベースのプロビジョニング済みスループットを一連のコンテナーで共有することは、マルチテナント アプリケーションに便利です。 各ユーザーを、個別の Azure Cosmos コンテナーによって表すことができます。

* 一連のコンテナーでデータベースのプロビジョニング済みスループットを共有することは、ホストされている NoSQL データベース (MongoDB、Cassandra など) を、VM のクラスターやオンプレミスの物理サーバーから、Azure Cosmos DB へ移行する場合に便利です。 Azure Cosmos データベースで構成されているプロビジョニング済みスループットは、MongoDB や Cassandra クラスターのコンピューティング キャパシティと論理的に同等のものである (ただしコスト効率や柔軟性が高い) と考えてください。  

スループットがプロビジョニング済みのデータベース内に作成されるコンテナーはすべて、[パーティション キー](partition-data.md)を使用して作成する必要があります。 特定の時点で、データベース内のコンテナーに割り当てられているスループットは、そのコンテナーのすべての論理パーティションに分散されます。 データベースに対して構成されたプロビジョニング済みスループットを共有するコンテナーがある場合は、特定のコンテナーや論理パーティションにスループットを選択して適用することはできません。 

論理パーティションのワークロードによって、特定の論理パーティションに割り当てられている量より多くのスループットが消費されている場合、ユーザーの操作のレートが制限されます。 レートの制限が発生した場合は、データベース全体のスループットを増やすか、または操作を再試行することができます。 パーティション分割の詳細については、[論理パーティション](partition-data.md)に関するページをご覧ください。

共有スループット データベース内のコンテナーは、そのデータベースに割り当てられたスループット (RU/秒) を共有します。 データベースには、最大 4 つのコンテナーを最小の 400 RU/秒で含めることができます。 標準 (手動) のプロビジョニング済みスループットでは、最初の 4 つの後の新しい各コンテナーに、少なくとも追加の 100 RU/秒が必要です。 たとえば、8 つのコンテナーを持つ共有スループット データベースがある場合、データベースの最小 RU/秒は 800 RU/秒になります。 自動スケールのプロビジョニング済みスループットでは、自動スケールの最大値を 4000 RU/秒 (400 ～ 4000 RU/秒の間でスケール可能) にして、1 つのデータベース内に最大 25 個のコンテナーを作成できます。

> [!NOTE]
> 2020 年 2 月に、共有スループット データベースに最大 25 個のコンテナーを含めることを可能にする変更が導入されました。これにより、コンテナー全体のスループットの共有が向上しています。 最初の 25 個のコンテナーの後は、[専用スループットでプロビジョニング](#set-throughput-on-a-database-and-a-container)されている場合に限り、さらにコンテナーを追加できます。これは、データベースの共有スループットとは異なります。<br>
Azure Cosmos DB アカウントに 25 個以上のコンテナーを持つ共有スループット データベースが既に含まれている場合、そのアカウントおよび同じ Azure サブスクリプション内の他のすべてのアカウントは、この変更から除外されます。 フィードバックや質問がある場合は、[製品サポートにお問い合わせ](https://portal.azure.com/?#blade/Microsoft_Azure_Support/HelpAndSupportBlade)ください。 

ワークロードでデータベース内のすべてのコレクションを削除および再作成する必要がある場合は、空のデータベースを削除し、コレクションの作成前に新しいデータベースを再作成することをお勧めします。 次の図は、物理パーティションで、データベース内のさまざまなコンテナーに属する 1 つ以上の論理パーティションをホストできる方法を示しています。

:::image type="content" source="./media/set-throughput/resource-partition2.png" alt-text="物理パーティション" border="false":::

## <a name="set-throughput-on-a-database-and-a-container"></a>データベースとコンテナーでスループットを設定する

2 つのモデルを組み合わせることができます。 データベースとコンテナーの両方でスループットをプロビジョニングできます。 次に示すのは、Azure Cosmos データベースとコンテナーで標準 (手動) のプロビジョニング済みスループットをプロビジョニングする方法の例です。

* *K* RU の標準 (手動) プロビジョニング済みスループットで、*Z* という名前の Azure Cosmos データベースを作成できます。 
* 次に、データベース内に *A*、*B*、*C*、*D*、*E* という名前の 5 つのコンテナーを作成します。 コンテナー B を作成するときに、必ず **[Provision dedicated throughput for this container]\(このコンテナーの専用スループットをプロビジョニングする\)** オプションを有効にし、このコンテナーにプロビジョニングされているスループットの "*P*" RU を明示的に構成します。 共有および専用のスループットを構成できるのは、データベースとコンテナーを作成する場合のみであることに注意してください。 

   :::image type="content" source="./media/set-throughput/coll-level-throughput.png" alt-text="コンテナー レベルでのスループットの設定":::

* *K* RU のスループットは、*A*、*C*、*D*、*E* の 4 つのコンテナーにわたって共有されます。使用可能なスループットの正確な量は、*A*、*C*、*D*、*E* のそれぞれで異なります。 個々のコンテナーのスループットに対する SLA はありません。
* コンテナー *B* は常に *P* RU のスループットを取得することが保証されます。 それは SLA によって裏付けられます。

> [!NOTE]
> プロビジョニングされたスループットがあるコンテナーを共有データベース コンテナーに変換することはできません。 逆に、共有データベース コンテナーを専用のスループットを持つように変換することはできません。

## <a name="update-throughput-on-a-database-or-a-container"></a>データベースまたはコンテナーのスループットを更新する

Azure Cosmos コンテナーまたはデータベースを作成した後に、プロビジョニング済みのスループットを更新できます。 データベースまたはコンテナーで構成できる最大のプロビジョニング済みスループットに制限はありません。 

データベースまたはコンテナーの[プロビジョニングされた最小スループット](concepts-limits.md#storage-and-database-operations)を評価するには、以下の項目の最大値を確認します。

* 400 RU/秒 
* 現在のストレージ (GB 単位) × 10 RU/秒
* データベースまたはコンテナーでプロビジョニングされた最高 RU ÷ 100
* コンテナー数 × 100 RU/秒 (共有スループットのデータベースのみ)

実際の最小 RU/秒は、アカウントの構成によって異なる場合があります。 [Azure Monitor メトリック](monitor-cosmos-db.md#view-operation-level-metrics-for-azure-cosmos-db)を使用して、プロビジョニングされたスループット (RU/秒) とリソース上のストレージの履歴を表示できます。

コンテナーまたはデータベースの最小スループットは、SDK を使用してプログラムで取得するか、Azure portal でその値を表示することができます。 .NET SDK を使用する場合、[DocumentClient.ReplaceOfferAsync](https://docs.microsoft.com/dotnet/api/microsoft.azure.documents.client.documentclient.replaceofferasync?view=azure-dotnet) メソッドで、プロビジョニング済みスループット値をスケールできます。 Java SDK を使用する場合、[RequestOptions.setOfferThroughput](sql-api-java-sdk-samples.md) メソッドを使用して、プロビジョニング済みスループット値をスケールできます。 

.NET SDK を使用する場合、[DocumentClient.ReadOfferAsync](https://docs.microsoft.com/dotnet/api/microsoft.azure.documents.client.documentclient.readofferasync?view=azure-dotnet) メソッドを使用して、コンテナーまたはデータベースの最小スループットを取得できます。 

コンテナーまたはデータベースのプロビジョニング済みスループットはいつでもスケールできます。 スループットを向上させるためにスケール操作を実行すると、必要なリソースをプロビジョニングするためのシステム タスクが原因で、より長い時間がかかる場合があります。 スケール操作の状態は、Azure portal で、または SDK を使用してプログラムで確認できます。 .NET SDK を使用する場合は、`DocumentClient.ReadOfferAsync` メソッドを使用して、スケール操作の状態を取得できます。

## <a name="comparison-of-models"></a>モデルの比較
次の表は、標準 (手動) のスループットをデータベースでプロビジョニングする場合と、コンテナーでプロビジョニングする場合とでの比較を示したものです。 

|**パラメーター**  |**データベースでの標準 (手動) スループット**  |**コンテナーでの標準 (手動) スループット**|**データベースでの自動スケール スループット** | **コンテナーでの自動スケール スループット**|
|---------|---------|---------|---------|---------|
|エントリ ポイント (最小 RU/秒) |400 RU/秒。 最初の 4 個のコンテナーの後は、コンテナーを追加するごとに少なくとも 100 RU/秒が必要になります</li> |400| 400 ～ 4000 RU/秒の間で自動スケール。 コンテナーあたりの最小 RU/秒が設定されない状態で、最大 25 個のコンテナーを使用できます</li> | 400 ～ 4000 RU/秒の間で自動スケール。|
|コンテナーあたりの最小 RU/秒|100|400|--|400 ～ 4000 RU/秒の間で自動スケール|
|最大 RU|無制限、データベース上。|無制限、コンテナー上。|無制限、データベース上。|無制限、コンテナー上。
|特定のコンテナーに割り当てられた、または使用可能な RU|保証はありません。 特定のコンテナーに割り当てられる RU は、プロパティに依存します。 スループットを共有するコンテナーのパーティション キーの選択、ワークロードの分散、コンテナーの数などのプロパティです。 |コンテナー上に構成されるすべての RU は、そのコンテナー専用に予約されます。|保証はありません。 特定のコンテナーに割り当てられる RU は、プロパティに依存します。 スループットを共有するコンテナーのパーティション キーの選択、ワークロードの分散、コンテナーの数などのプロパティです。 |コンテナー上に構成されるすべての RU は、そのコンテナー専用に予約されます。|
|コンテナーの最大ストレージ|無制限。|無制限|無制限|無制限|
|コンテナーの論理パーティションあたりの最大スループット|10,000 RU/秒|10,000 RU/秒|10,000 RU/秒|10,000 RU/秒|
|コンテナーの論理パーティションあたりの最大ストレージ (データ + インデックス)|20 GB|20 GB|20 GB|20 GB|

## <a name="next-steps"></a>次のステップ

* [論理パーティション](partition-data.md)の詳細を確認する。
* [Azure Cosmos コンテナーで標準 (手動) のスループットをプロビジョニングする](how-to-provision-container-throughput.md)方法について学習する。
* [Azure Cosmos データベースで標準 (手動) のスループットをプロビジョニングする](how-to-provision-database-throughput.md)方法について学習する。
* [Azure Cosmos データベースまたはコンテナー上で自動スケーリングのスループットをプロビジョニングする](how-to-provision-autoscale-throughput.md)方法を確認する。
