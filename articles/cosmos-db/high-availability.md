---
title: Azure Cosmos DB での高可用性
description: この記事では、Azure Cosmos DB で高可用性を実現する方法について説明します
author: markjbrown
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 10/15/2018
ms.author: mjbrown
ms.reviewer: sngun
ms.openlocfilehash: 4fc17daf640e95ab028150cec029471a0c7bc565
ms.sourcegitcommit: 3ab534773c4decd755c1e433b89a15f7634e088a
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/07/2019
ms.locfileid: "54062997"
---
# <a name="high-availability-with-azure-cosmos-db"></a>Azure Cosmos DB での高可用性

Azure Cosmos DB では、Cosmos アカウントに関連付けられているすべての Azure リージョンにデータが透過的にレプリケートされます。 Cosmos DB では、次の図のように、複数層のデータ冗長性が採用されています。

![物理的パーティション分割](./media/high-availability/cosmosdb-data-redundancy.png)

- Cosmos コンテナー内のデータは、水平方向にパーティション分割されます。

- 各リージョン内のすべてのパーティションは、すべての書き込みがレプリケートされ、レプリカの大多数によって永続的にコミットされたレプリカ セットによって保護されます。 レプリカは、最大で 10 ~ 20 個の障害ドメインに分散されます。

- すべてのリージョンで、各パーティションがレプリケートされます。 各リージョンには Cosmos コンテナーのすべてのデータ パーティションが含まれており、書き込みを受け入れて読み取りに対応できます。  

Cosmos アカウントが N 個の Azure リージョンに分散している場合、すべてのデータの少なくとも N x 4 個のコピーがあります。 データ アクセスの待ち時間を低くし、Cosmos アカウントに関連付けられているリージョン全体で書き込み/読み取りのスループットをスケーリングすることに加えて、リージョンを増やす (N を増やす) ことによっても可用性は向上します。  

## <a name="slas-for-availability"></a>可用性に関する SLA

グローバル分散型データベースとしての Cosmos DB は、スループット、99 パーセンタイルの待ち時間、一貫性、および高可用性を含む包括的な SLA を提供します。 次の表では、単一リージョンおよび複数リージョンのアカウントについて Cosmos DB によって提供される高可用性の保証について説明します。 高可用性を確保するため、Cosmos アカウントには複数の書き込みリージョンを構成してください。

|操作の種類  | 単一リージョン |複数リージョン (単一リージョンの書き込み)|複数リージョン (複数リージョンの書き込み) |
|---------|---------|---------|-------|
|書き込み    | 99.99    |99.99   |99.999|
|読み取り     | 99.99    |99.999  |99.999|

> [!NOTE]
> 実際には、有界整合性制約、セッション、一貫性のあるプレフィックス、および最終的の整合性モデルについての実際の書き込み可用性は、公開された SLA よりもずっと高くなります。 すべての整合性レベルについての実際の読み取り可用性は、公開された SLA よりもずっと高くなります。

## <a name="high-availability-with-cosmos-db-in-the-face-of-regional-outages"></a>リージョン障害における Cosmos DB の高可用性

リージョン障害は珍しいことではなく、Azure Cosmos DB は、データベースが常に利用できるように確保します。 以下の記述は、Cosmos アカウントの構成による、Cosmos DB の障害発生時の動作を説明したものです。

- Cosmos DB では、クライアントに対して書き込み操作が承認される前に、書き込み操作を受け入れるリージョン内のレプリカのクォーラムによってデータが永続的にコミットされます。

- 複数書き込みリージョンで構成された複数リージョン アカウントは、書き込みと読み取りの両方について高可用性を実現します。 リージョン間フェールオーバーは瞬間的であるため、アプリケーションからの変更は必要ありません。

- 単一書き込みリージョンで構成された複数リージョン アカウント:これらのアカウントでは、書き込みリージョンの障害発生時に読み取りの高可用性が維持されます。 ただし書き込みについては、影響を受けたリージョンを、関連付けられた別のリージョンにフェールオーバーするために、Cosmos アカウントで「自動フェールオーバーを有効にする」必要があります。 フェールオーバーは、指定したリージョンの優先順位に従って実行されます。 最終的に、影響を受けたリージョンがオンラインに戻ったとき、障害発生中に影響を受けた書き込みリージョン内に存在するレプリケート済みでないデータは、競合フィードを通じて利用できるようになります。 アプリケーションは競合フィードを読み取って、アプリケーション固有のロジックに基づき競合を解決し、必要に応じて更新したデータを Cosmos コンテナーに書き戻すことができます。 以前影響を受けた書き込みリージョンが復旧すると、自動的に読み取りリージョンとして利用可能になります。 手動フェールオーバーを呼び出し、影響を受けたリージョンを書き込みリージョンとして構成できます。 [Azure CLI または Azure portal](how-to-manage-database-account.md#manual-failover) を使用して手動フェールオーバーを行うことができます。  

- 単一書き込みリージョンで構成された複数リージョン アカウント:これらのアカウントでは、読み取りリージョンの障害発生時に読み取りおよび書き込みの高可用性が維持されます。 影響を受けたリージョンは自動的に書き込みリージョンから切断され、オフラインとしてマークされます。 Cosmos DB SDK は、優先リージョンの一覧で次に使用可能なリージョンに読み取りの呼び出しをリダイレクトします。 優先リージョンの一覧にあるいずれのリージョンも使用可能でない場合、呼び出しは自動的に現在の書き込みリージョンに戻ります。 読み取りリージョン障害を処理するアプリケーション コードは、変更する必要はありません。 最終的に、影響を受けたリージョンがオンラインに戻ったとき、以前影響を受けた読み取りリージョンは現在の書き込みリージョンと自動的に同期され、読み取り要求に再び対応できるようになります。 それ以降の読み取りは、アプリケーション コードを変更しなくても、回復したリージョンにリダイレクトされます。 フェールオーバーと、以前障害が発生したリージョンの再参加中に、読み取り一貫性の保証は Cosmos DB によって引き続き受け付けられます。

- 単一リージョンのアカウントは、リージョンの障害の後で可用性を失う場合があります。 常に高可用性を確保するために、Cosmos アカウントで少なくとも 2 つのリージョン (可能であれば、少なくとも 2 つの書き込みリージョン) をセットアップすることをお勧めします。

- Azure リージョンが永久に回復できないという非常にまれで残念なケースでも、複数リージョンの Cosmos アカウントが既定の強固な整合性レベルで構成されていれば、データが失われる潜在的な可能性はありません。 書き込みリージョンが永久に回復できないとき、有界整合性制約が構成された複数リージョンの Cosmos アカウントの場合、潜在的なデータ損失の期間は遅延期間に制限されます。セッション、一貫性のあるプレフィックス、最終的な整合性の各レベルの場合、潜在的なデータ損失期間は最大 5 秒間に制約されます。

## <a name="building-highly-available-applications"></a>高可用性アプリケーションの構築

- 書き込みと読み込みの高可用性を確保するために、複数書き込みリージョンを持つ少なくとも 2 つのリージョンにまたがるように Cosmos アカウントを構成します。 この構成により、SLA で裏付けられた、読み取りと書き込みの両方についての可用性、最も低い待機時間、およびスケーラビリティが提供されます。 詳しくは、[複数書き込みリージョンで Cosmos アカウントを構成する](tutorial-global-distribution-sql-api.md)方法をご覧ください。

- 単一書き込みリージョンで構成されている複数リー ジョンの Cosmos アカウントでは、[Azure CLI または Azure portal を使用して自動フェールオーバーを有効にします](how-to-manage-database-account.md#automatic-failover)。 自動フェールオーバーを有効にすると、リージョンで災害が発生するたびに Cosmos DB はアカウントを自動的にフェールオーバーします。  

- Cosmos アカウントの可用性が高くても、アプリケーションが高可用性を維持するよう正しく設計できていないこともあります。 アプリケーションのエンド ツー エンドの高可用性をテストするには、アプリケーションのテストまたはディザスター リカバリー (DR) の訓練の一部として、[Azure CLI または Azure portal を使用して手動フェールオーバー](how-to-manage-database-account.md#manual-failover)を定期的に呼び出してください。

## <a name="next-steps"></a>次の手順

次に、次の記事でスループットのスケーリングについて学習できます。

* [さまざまな整合性レベルでの可用性およびパフォーマンスのトレードオフ](consistency-levels-tradeoffs.md)
* [プロビジョニング スループットのグローバルなスケーリング](scaling-throughput.md)
* [グローバル分散 - 内部のしくみ](global-dist-under-the-hood.md)
* [Azure Cosmos DB の整合性レベル](consistency-levels.md)
