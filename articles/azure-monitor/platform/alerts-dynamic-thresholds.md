---
title: Azure Monitor で動的なしきい値を使用したアラートを作成する
description: 機械学習ベースの動的なしきい値を使用したアラートを作成します。
author: yanivlavi
services: azure-monitor
ms.service: azure-monitor
ms.topic: conceptual
ms.date: 11/29/2018
ms.author: yalavi
ms.reviewer: mbullwin
ms.openlocfilehash: 30f853bd65c83b922faf008fbb5279c28f197f68
ms.sourcegitcommit: 02d17ef9aff49423bef5b322a9315f7eab86d8ff
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/21/2019
ms.locfileid: "58339008"
---
# <a name="metric-alerts-with-dynamic-thresholds-in-azure-monitor-public-preview"></a>Azure Monitor の動的しきい値を使用したメトリック アラート (パブリック プレビュー)

動的しきい値を使用したメトリック アラートでは、高度な機械学習 (ML) を活用して、メトリックの動きの履歴を学び、パターンや、サービスの問題の可能性を示す異常を識別します。 ユーザーが Azure Resource Manager API でアラート ルールを構成でき、完全に自動化された方法で、単純な UI と規模に応じた操作の両方がサポートされます。

アラート ルールが作成された後、調整されたしきい値に基づいて、監視対象のメトリックが予期したとおりに動作しない場合のみルールが実行されます。

ご意見、ご感想がある場合は、<azurealertsfeedback@microsoft.com> までお寄せください。

## <a name="why-and-when-is-using-dynamic-condition-type-recommended"></a>動的な条件タイプが推奨される理由とその状況

1. **スケーラブル アラート** – 動的しきい値のアラート ルールにより、一度に数百のメトリック系列に対して調整済みのしきい値を作成できます。 ただし、1 つのメトリックにアラート ルールを定義するのと同じように簡単です。 UI または Azure Resource Manager API を使用すると、管理するアラート ルールが少なくなります。 スケーラブルな方法が特に役立つのは、メトリックのディメンションを処理するとき、またはすべてのサブスクリプションのリソースのように複数のリソースに適用する場合です。 これにより、アラート ルールの管理と作成にかかる時間を大幅に節約できます。 [動的しきい値を使用したメトリック アラートを構成するためにテンプレートを使用する方法はこちらをご覧ください](alerts-metric-create-templates.md)。

1. **スマート メトリック パターン認識** – 独自の ML テクノロジを使用すると、メトリック パターンを自動的に検出して、時間経過に伴うメトリックの変化に対応できます。これには多くの場合、季節性 (毎時/毎日/毎週) が含まれます。 時間経過に伴うメトリックの動きに合わせて、パターンからの偏差に基づいてアラートを生成することにより、各メトリックの "正しい" しきい値を知っておくという負担が軽減されます。 動的しきい値で使用される ML アルゴリズムは、予期されるパターンを含まない、ノイズの多い (低精度) しきい値またはワイドな (低再現率) しきい値を抑制するように設計されています。

1. **直感的な構成** – 動的しきい値を使用すると、高度な概念を使用したメトリック アラートを設定でき、メトリックについて広範なドメイン知識を持つ必要が少なくなります。

## <a name="how-to-configure-alerts-rules-with-dynamic-thresholds"></a>動的しきい値を使用したアラート ルールの構成方法

動的しきい値を使用したアラートは、Azure Monitor の [メトリック アラート] で設定できます。 [メトリック アラートの構成方法はこちらをご覧ください](alerts-metric.md)。

## <a name="how-are-the-thresholds-calculated"></a>しきい値の計算方法

動的しきい値は、メトリックの系列のデータを学習し続け、一連のアルゴリズムとメソッドを使用してモデル化しようとします。 季節性 (毎時/毎日/毎週) のようなデータのパターンを検出し、ノイズの多いメトリック (マシンの CPU またはメモリなど) と分散性が低いメトリック (可用性やエラー率など) を処理できるようになります。

しきい値からの偏差がメトリックの動作の異常を示すように、しきい値を選択します。

## <a name="what-does-sensitivity-setting-in-dynamic-thresholds-mean"></a>動的しきい値の "秘密度" 設定とは

アラートしきい値の秘密度は、アラートをトリガーするために必要なメトリックの動作からの偏差の量を制御する高度な概念です。
この方法では、静的しきい値のようにメトリックに関するドメインの知識は不要です。 次の方法を使用できます。

- 高 – しきい値は、メトリックの系列パターンに近い値になります。 最小の偏差でアラート ルールがトリガーされるため、アラート数が多くなります。
- 中 – ゆとりがあるバランスの取れたしきい値です。高秘密度 (既定) よりもアラート数が少なくなります。
- 低 – メトリックの系列パターンから離れます。 アラート ルールは偏差が大きいときのみトリガーされるため、アラート数は少なくなります。

## <a name="what-are-the-operator-setting-options-in-dynamic-thresholds"></a>動的しきい値の "演算子" 設定オプションとは

動的しきい値のアラート ルールは、同じアラート ルールを使用して上限と下限について、メトリックの動作に基づいて調整したしきい値を作成できます。
次の 3 つの条件のいずれかを基にアラートをトリガーするよう選択できます。

- 上限しきい値より大きいか、下限しきい値より小さい (既定値)
- 上限しきい値より大きい
- 下限しきい値より小さい

## <a name="what-do-the-advanced-settings-in-dynamic-thresholds-mean"></a>動的しきい値の高度な設定の意味

**失敗期間** - 動的しきい値では、[Number violations to trigger the alert]\(アラートをトリガーする違反の数\) も構成できます。これは、システムがアラートを発生させるために特定の時間ウィンドウ内で必要な偏差の最小数です (既定の時間ウィンドウは 20 分間に 4 回の偏差)。 ユーザーは、失敗期間を構成し、失敗期間と時間ウィンドウを変更してアラートの対象を選択できます。 この機能により、一時的なスパイクによって生成されるアラートのノイズが軽減されます。 例: 

20 分間問題が継続するとき、つまり所定の 5 分ごとの区切りで 4 回連続してしきい値を超えた場合にアラートをトリガーするには、次の設定を使用します。

![問題の継続が 20 分間 (所定の 5 分間の区切りで連続 4 回) の失敗期間の設定](media/alerts-dynamic-thresholds/0008.png)

5 分ごとの区切りで過去 30 分間のうち 20 分間で動的しきい値を超えた状態が続いた場合に、アラートをトリガーするには、次の設定を使用します。

![過去 30 分 (5 分ごとの区切り) のうち 20 分間問題がある失敗期間の設定](media/alerts-dynamic-thresholds/0009.png)

**以前のデータを無視** - ユーザーは必要に応じて、システムによるしきい値の計算の開始日付を定義することもできます。 一般的なユース ケースとしては、リソースがテスト モードで実行していたが、運用環境のワークロードを処理するように昇格された場合があります。このとき、テスト フェーズでのメトリックの動作は無視する必要があります。

## <a name="will-slow-behavior-change-in-the-metric-trigger-an-alert"></a>メトリックの動作の変化が遅いとアラートがトリガーされるか

答えはおそらく「いいえ」でしょう。 動的しきい値は、緩やかに変化する問題ではなく、大きな偏差を検出する場合に有効です。

## <a name="how-much-data-is-used-to-preview-and-then-calculate-thresholds"></a>しきい値のプレビューと計算に使用されるデータの量

メトリックのアラート ルールが作成される前に、チャートに表示されるしきい値は、時間単位または日単位の季節性パターン (10日間) を計算するのに十分な履歴データに基づき計算されます。 [Display weekly pattern (週単位のパターンを表示する)] を押すと、週単位の季節性パターン (28日間) を計算するのに十分な履歴データを取得します。 アラート ルールが作成されると、動的しきい値は、利用可能な履歴データをすべて使用し、しきい値の精度を向上するために新しいデータを基に学習し、熟練し続けます。

## <a name="how-much-data-is-needed-to-trigger-an-alert"></a>アラートをトリガーするためにどれくらいのデータが必要ですか。

新しいリソースがある、またはメトリック データが不足している場合、しきい値の精度を保つため、データが利用可能になる 3 日前まで動的しきい値ではアラートがトリガーされません。

## <a name="dynamic-thresholds-best-practices"></a>動的しきい値のベスト プラクティス

動的しきい値は、任意のプラットフォームまたは Azure Monitor のカスタム メトリックに適用できます。さらに、一般的なアプリケーションとインフラストラクチャのメトリック用に調整されてきました。
次の項目は、動的しきい値を使用するこれらのメトリックのいくつかにアラートを構成する方法に関するベスト プラクティスです。

### <a name="dynamic-thresholds-on-virtual-machine-cpu-percentage-metrics"></a>仮想マシンの CPU 割合メトリックの動的しきい値

1. [Azure portal](https://portal.azure.com) で、**[モニター]** をクリックします。 [モニター] ビューでは、すべての監視設定とデータが 1 つのビューにまとめられています。

2. **[アラート]** をクリックして、**[+ 新しいアラート ルール]** をクリックします。

    > [!TIP]
    > ほとんどのリソース ブレードにも **[監視]** のリソース メニューに **[アラート]** があり、そこからもアラートを作成できます。

3. **[ターゲットの選択]** をクリックし、読み込まれるコンテキスト ウィンドウで、アラートを設定するターゲット リソースを選択します。 **サブスクリプション**と **[リソースの種類] の [Virtual Machines]** ドロップダウンを使用して、監視するリソースを検索します。 検索バーを使用して、リソースを検索することもできます。

4. ターゲット リソースを選択した後、**[条件の追加]** をクリックします。

5. **[CPU の割合]** を選択します。

6. 必要に応じて、**[期間]** と **[集計]** を調整して、メトリックを設定し直します。 このメトリックの種類で、集計の種類として [最大] を使用することはお勧めしません。理由は、動きの表現力が低いためです。 [最大] という集計の種類では、静的しきい値のほうが適切である可能性があります。

7. 過去 6 時間のメトリックのグラフが表示されます。 アラートのパラメーターを定義します。
    1. **[条件の種類]**: [動的] オプションを選択します。
    1. **[感度]**: アラートのノイズを減らすために、[中] または [低] を選択します。
    1. **[演算子]**: 動きがアプリケーションの使用状況を表す場合を除き、[より大きい] を選択します。
    1. **[頻度]**: アラートのビジネスへの影響に基づいて低くすることを検討してください。
    1. **[失敗期間]**: (高度なオプション) ルックバック期間は 15 分以上にする必要があります。 たとえば、[期間] が 5 分に設定されている場合、[失敗期間] は 3 以上にする必要があります。

8. メトリック グラフに、最新のデータに基づいて計算されたしきい値が表示されます。

9. **[Done]** をクリックします。

10. **[アラート ルール名]**、**[説明]**、**[重大度]** などの **[アラートの詳細]** を指定します。

11. 既存のアクション グループを選択するか、新しいアクション グループを作成して、アラートにアクション グループを追加します。

12. **[完了]** をクリックして、メトリック アラート ルールを保存します。

> [!NOTE]
> ポータルで作成したメトリック アラート ルールは、ターゲット リソースと同じリソース グループに作成されます。

### <a name="dynamic-thresholds-on-application-insights-http-request-execution-time"></a>Application Insights での HTTP 要求の実行時間の動的しきい値

1. [Azure portal](https://portal.azure.com) で、**[モニター]** をクリックします。 [モニター] ビューでは、すべての監視設定とデータが 1 つのビューにまとめられています。

2. **[アラート]** をクリックして、**[+ 新しいアラート ルール]** をクリックします。

    > [!TIP]
    > ほとんどのリソース ブレードにも **[監視]** のリソース メニューに **[アラート]** があり、そこからもアラートを作成できます。

3. **[ターゲットの選択]** をクリックし、読み込まれるコンテキスト ウィンドウで、アラートを設定するターゲット リソースを選択します。 **サブスクリプション**と **[リソースの種類] の [Application Insights]** ドロップダウンを使用して、監視するリソースを検索します。 検索バーを使用して、リソースを検索することもできます。

4. ターゲット リソースを選択した後、**[条件の追加]** をクリックします。

5. **[HTTP 要求の実行時間]** を選択します。

6. 必要に応じて、**[期間]** と **[集計]** を調整して、メトリックを設定し直します。 このメトリックの種類で、集計の種類として [最大] を使用することはお勧めしません。理由は、動きの表現力が低いためです。 [最大] という集計の種類では、静的しきい値のほうが適切である可能性があります。

7. 過去 6 時間のメトリックのグラフが表示されます。 アラートのパラメーターを定義します。
    1. **[条件の種類]**: [動的] オプションを選択します。
    1. **[演算子]**: 持続時間が改善されたときに発生するアラートを減らすために、[より大きい] を選択します。
    1. **[頻度]**: アラートのビジネスへの影響に基づいて低くすることを検討してください。

8. メトリック グラフに、最新のデータに基づいて計算されたしきい値が表示されます。

9. **[Done]** をクリックします。

10. **[アラート ルール名]**、**[説明]**、**[重大度]** などの **[アラートの詳細]** を指定します。

11. 既存のアクション グループを選択するか、新しいアクション グループを作成して、アラートにアクション グループを追加します。

12. **[完了]** をクリックして、メトリック アラート ルールを保存します。

> [!NOTE]
> ポータルで作成したメトリック アラート ルールは、ターゲット リソースと同じリソース グループに作成されます。
