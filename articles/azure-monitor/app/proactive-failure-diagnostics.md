---
title: スマート検出 - Application Insights での失敗の異常 |Microsoft Docs
description: Web アプリに対する要求の失敗率の異常な変化を通知し、診断分析を行います。 構成は必要ありません。
services: application-insights
documentationcenter: ''
author: mrbullwinkle
manager: carmonm
ms.assetid: ea2a28ed-4cd9-4006-bd5a-d4c76f4ec20b
ms.service: application-insights
ms.workload: tbd
ms.tgt_pltfrm: ibiza
ms.topic: conceptual
ms.date: 12/18/2018
ms.reviewer: yossiy
ms.author: mbullwin
ms.openlocfilehash: 46944603fdf45a2a7a14641086959bf61b3f773e
ms.sourcegitcommit: c63e5031aed4992d5adf45639addcef07c166224
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/28/2019
ms.locfileid: "67465877"
---
# <a name="smart-detection---failure-anomalies"></a>スマート検出 - 失敗の異常
[Application Insights](../../azure-monitor/app/app-insights-overview.md) では、Web アプリで要求失敗率が異常に増加すると、ほぼリアルタイムで自動的にユーザーに通知します。 具体的には、失敗として報告された HTTP 要求または依存関係の呼び出しの割合が異常に上昇すると、それが検出されます。 要求の場合、失敗した要求の応答コードは、通常、400 以上です。 通知には、問題のトリアージと診断に役立つよう、失敗の特性および関連するテレメトリの分析結果が記載されています。 また、より詳しい診断を行うために、Application Insights ポータルへのリンクも含まれています。 この機能は、機械学習アルゴリズムを使用して通常のエラー率を予測するため、セットアップや構成は不要です。

この機能は、クラウドまたは独自サーバーでホストされ、要求または依存関係のテレメトリを生成するあらゆる Web アプリで利用できます。たとえば、[TrackRequest()](../../azure-monitor/app/api-custom-events-metrics.md#trackrequest) または [TrackDependency()](../../azure-monitor/app/api-custom-events-metrics.md#trackdependency) を呼び出す worker ロールがある場合などです。

[プロジェクト用に Application Insights](../../azure-monitor/app/app-insights-overview.md)を設定し、アプリケーションで特定の最少限のテレメトリを生成する場合、失敗の異常のスマート検出は、オンに切り替わり、アプリケーションの通常の動作を学習するため、アラートを送信できるようになるまでに 24 時間かかります。

アラートの例を次に示します。

![失敗箇所周辺のクラスター分析を示すスマート検出のアラートのサンプル](./media/proactive-failure-diagnostics/013.png)

> [!NOTE]
> 既定では、この例よりも短い形式のメールが返されますが、 この[詳細な形式に切り替える](#configure-alerts)ことができます。
>
>

次の指標が提示されます。

* 通常のアプリケーションの動作と比較したエラー率。
* 影響を受けるユーザーの数 - アラートの重要度がわかります。
* エラーに関連付けられている特徴的パターン。 この例では、特定の応答コード、要求名 (操作)、およびアプリのバージョンがあります。 これにより、コードのどこから探すべきかすぐにわかります。 他には特定のブラウザーやクライアント オペレーティング システムなどが想定されます。
* 特徴付けられた失敗に関連するように見える例外、ログ トレース、依存関係エラー (データベースやその他の外部コンポーネント)。
* Application Insights の製品利用統計情報の関連検索に直接リンクします。

## <a name="failure-anomalies-v2"></a>失敗の異常 v2
失敗の異常アラート ルールの新しいバージョンが利用できるようになりました。 この新しいバージョンは、新しい Azure アラート プラットフォームで実行され、既存のバージョンに対するさまざまな改善を導入します。

### <a name="whats-new-in-this-version"></a>このバージョンの新機能
- 問題をより高速に検出
- 豊富なアクション セット - アラート ルールは、電子メールと Webhook のアクションが含まれる "Application Insights スマート検出" という名前の関連する[アクション グループ](https://docs.microsoft.com/azure/azure-monitor/platform/action-groups)とともに作成され、アラート発生時に追加のアクションをトリガーするように拡張できます。
- より焦点を絞った通知 - このアラート ルールから送信される電子メール通知が、サブスクリプションの監視閲覧者ロールおよび監視共同作業者ロールに関連付けられているユーザーに既定で送信されるようになりました。 この詳細については、[こちら](https://docs.microsoft.com/azure/azure-monitor/app/proactive-email-notification)を参照してください。
- ARM テンプレートによる簡単な構成 - [こちら](https://docs.microsoft.com/azure/azure-monitor/app/proactive-arm-config)の例を参照してください。
- 共通アラート スキーマのサポート - このアラート ルールから送信される通知は、[共通アラート スキーマ](https://docs.microsoft.com/azure/azure-monitor/platform/alerts-common-schema)に準拠します。
- 統合された電子メール テンプレート - このアラート ルールから送信される電子メール通知は、他のアラートの種類と外観と動作が整合しています。 この変更により、詳細な診断情報を含む失敗の異常アラートを取得するオプションは利用できなくなりました。

### <a name="how-do-i-get-the-new-version"></a>新しいバージョンの入手方法
- 新しく作成された Application Insights リソースが、新しいバージョンの失敗の異常アラート ルールでプロビジョニングされるようになりました。
- 失敗の異常アラート ルールの従来のバージョンを含む既存の Application Insights リソースは、[従来のアラートの提供終了プロセス](https://docs.microsoft.com/azure/azure-monitor/platform/monitoring-classic-retirement)の一環として、ホストしているサブスクリプションが新しいアラート プラットフォームに移行されると新しいバージョンを取得します。

> [!NOTE]
> 新しいバージョの失敗の異常アラート ルールは引き続き無料です。 さらに、関連する "Application Insights スマート検出" アクション グループによってトリガーされる電子メール アクションと Webhook アクションも無料です。
> 
> 

## <a name="benefits-of-smart-detection"></a>スマート検出の利点
通常の [メトリック アラート](../../azure-monitor/app/alerts.md) から、問題がある可能性がわかります。 ただし、スマート検出が自動的に診断作業を開始し、ユーザーの代わりにさまざまな分析を実行します。 結果はわかりやすくまとめられるので、問題の原因をすぐに把握できます。

## <a name="how-it-works"></a>動作のしくみ
スマート検出は、アプリから受け取ったテレメトリ (特に失敗率) を監視します。 このルールは、`Successful request` プロパティが false である要求の数と、`Successful call` プロパティが false である依存関係の呼び出しの数をカウントします。 要求の場合、既定では、`Successful request == (resultCode < 400)` です ([フィルター](../../azure-monitor/app/api-filtering-sampling.md#filtering)にカスタム コードを記述した場合、または独自の [TrackRequest](../../azure-monitor/app/api-custom-events-metrics.md#trackrequest) 呼び出しを生成する場合を除きます)。 

アプリのパフォーマンスには、一般的な動作パターンがあります。 他よりもエラーが発生しやすい要求または依存関係があります。負荷が増えると、全体的なエラー率が上がります。 スマート検出は機械学習を使用し、これらの異常を検出します。

テレメトリが Web アプリから Application Insights に送られると同時に、スマート検出は現在の動作と過去数日間に見られたパターンを比較します。 以前のパフォーマンスと比べて失敗率の異常な上昇が検出された場合に、分析がトリガーされます。

分析がトリガーされると、サービスは失敗した要求のクラスター分析を実行して、失敗を特徴づける値のパターンの特定を試みます。 上の例では、分析により、ほとんどの失敗が特定の結果コード、要求名、サーバー URL ホスト、およびロール インスタンスに関係していることが検出されました。 これに対し、分析により、クライアント オペレーティング システムのプロパティが複数の値に分散していることが検出されたため、それはリストに表示されていません。

サービスがこれらの製品利用統計情報の呼び出しでインストルメント化される場合、アナライザーは特定されたクラスター内の要求に関連する例外と依存関係エラーに加え、それらの要求に関連するすべてのトレース ログの例も検出します。

分析結果は、アラートとして電子メールで送信されます (送信しないように構成している場合を除きます)。

[手動で設定したアラート](../../azure-monitor/app/alerts.md)と同じように、Application Insights リソースの [アラート] ブレードでアラートの状態を検査し、構成できます。 ただし、その他のアラートとは異なり、スマート検出を設定したり、構成したりする必要はありません。 必要に応じて、無効にすることや、送信先の電子メール アドレスを変更することもできます。

### <a name="alert-logic-details"></a>アラート ロジックの詳細

アラートは Microsoft 独自の機械学習アルゴリズムによってトリガーされるため、正確な実装の詳細を共有することはできません。 そうは言っても、ときにはユーザーが基になるロジックのしくみを詳しく把握する必要があることも理解しています。 アラートをトリガーする必要があるかどうかを判断するために評価される主な要素を次に示します。 

* 20 分のローリング時間枠における要求/依存関係のエラー率の分析。
* 過去 20 分間のエラー率を過去 40 分間および過去 7 日間の率と比較して、標準偏差の X 倍を超える有意な偏差を見つけます。
* 最小エラー率の適応限界の使用。これは、アプリの要求/依存関係の量によって異なります。

## <a name="configure-alerts"></a>アラートを構成する
スマート検出の無効化、電子メール受信者の変更、webhook の作成、詳細なアラート メッセージの選択を実行できます。

[アラート] ページを開きます。 失敗の異常が、手動で設定したすべてのアラートと共に含まれており、現在アラート状態にあるかどうかを確認できます。

![On the Overview page, click Alerts tile. Or on any Metrics page, click Alerts button.](./media/proactive-failure-diagnostics/021.png)

アラートをクリックして構成します。

![構成](./media/proactive-failure-diagnostics/032.png)

スマート検出は無効にできますが、削除 (および別の診断を作成) することはできません。

#### <a name="detailed-alerts"></a>詳細なアラート
[Get more detailed diagnostics (詳細な診断を取得する)] を選択すると、電子メールに多くの診断情報が記載されます。 電子メール内のデータから問題を診断できる場合もあります。

詳細なアラートには例外やトレース メッセージが含まれるため、機密情報が記載されるというリスクがわずかながらあります。 ただし、このような状況が生じるのは、コードによってそれらのメッセージに機密情報を含めることが許可されている場合のみです。

## <a name="triaging-and-diagnosing-an-alert"></a>アラートのトリアージと診断
アラートは、要求失敗率の異常な上昇が検出されたことを示します。 アプリやその環境に何らかの問題があることが考えられます。

要求の割合と影響を受けるユーザーの数から、問題の緊急度を判断できます。 上の例では、22.5% という失敗率が通常の失敗率である 1% と比較され、異常事態が発生していることを示しています。 一方、影響を受けたユーザー数は 11 人のみです。 それが自分のアプリであれば、その深刻度を評価できます。

多くの場合は、提供された要求名、例外、依存関係の失敗、トレース データからすばやく問題を診断することができます。

その他にもヒントがあります。 たとえば、この例では依存関係のエラー率が例外率 (89.3%) と同じです。 これが示すところは、例外が依存関係のエラーから直接発生しているということです。それにより、コードのどこから探すべきかわかります。

さらに詳しく調査する場合は、関連する要求、例外、依存関係、トレースで絞り込まれた [検索ページ](../../azure-monitor/app/diagnostic-search.md) に、各セクションのリンクから直接移動できます。 また、 [Azure ポータル](https://portal.azure.com)を開き、アプリケーションの Application Insights リソースに移動して、[エラー] ブレードを開くという方法もあります。

この例では、"依存関係エラーの詳細を表示する" リンクをクリックすると、Application Insights の検索ブレードが開き、 SQL ステートメントについての、根本原因の例 (必須フィールドにNULL が指定されており、保存操作時に検証に合格しなかった) が表示されます。

![診断検索](./media/proactive-failure-diagnostics/051.png)

## <a name="review-recent-alerts"></a>最新のアラートを確認する

**[スマート検出]** をクリックして、最新のアラートにアクセスします。

![Alerts summary](./media/proactive-failure-diagnostics/070.png)


## <a name="whats-the-difference-"></a>違い...
失敗の異常のスマート検出は、Application Insights の類似しているが異なる他の機能を補完します。

* [メトリック アラート](../../azure-monitor/app/alerts.md)は、ユーザーが設定するアラートであり、CPU 占有率、要求率、ページの読み込み時間など、広範なメトリックを監視できます。 このアラートを使用すると、リソースを追加する必要がある場合などに自分に警告することができます。 これに対し、失敗の異常のスマート検出は、重要な少数のメトリック (現在は要求失敗率のみ) を対象としており、Web アプリの要求失敗率が Web アプリの通常の動作と比較して大幅に増加すると、ほぼリアルタイムでユーザーに通知するよう設計されています。

    スマート検出は、優勢な状態に合わせてそのしきい値を自動調整します。

    診断作業はスマート検出によって開始されます。
* [パフォーマンスの異常のスマート検出](proactive-performance-diagnostics.md)では、マシン インテリジェンスを使用してメトリックの異常なパターンを検出します。ユーザーが構成する必要はありません。 ただし、失敗の異常のスマート検出とは異なり、パフォーマンスの異常のスマート検出の目的は、(たとえば、特定の種類のブラウザーの特定のページで) 適切に処理されない可能性のあるさまざまな使用量のセグメントを検出することです。 分析は毎日実行され、見つかった結果はアラートよりも緊急度が大幅に低い可能性があります。 これに対し、失敗の異常の分析は、受け取ったテレメトリに対して継続的に実行され、サーバーのエラー率が予想を超えると数分以内にユーザーに通知します。

## <a name="if-you-receive-a-smart-detection-alert"></a>スマート検出アラートを受け取った場合
*このアラートを受け取った理由*

* 先行する期間の正常な基準値と比較し、要求失敗率の異常な上昇が検出されました。 エラーと関連する製品利用統計情報を分析したところ、調査する必要のある問題があると思われます。

*この通知は、明らかに問題があることを意味していますか。*

* アプリの中断や劣化に対してアラートを出すように試みますが、セマンティックスとアプリまたはユーザーに与える影響を完全に理解できるのは当人だけです。

*私のデータはマイクロソフトからも見られるのですか。*

* いいえ。 サービスは完全に自動化されています。 通知を受け取るだけです。 ユーザーのデータは [プライベート](../../azure-monitor/app/data-retention-privacy.md)です。

*このアラートをサブスクライブする必要はありますか。*

* いいえ。 要求テレメトリを送信するすべてのアプリケーションには、スマート検出アラート ルールがあります。

*登録を解除できますか。または、代わりに同僚に通知が送信されるように設定できますか。*

* はい。[アラート ルール] で、スマート検出ルールをクリックし、設定します。 アラートを無効にしたり、アラートの受信者を変更したりできます。

*メールが消えました。どうしたらポータルで通知を見つけられますか。*

* アクティビティ ログにあります。 Azure で、アプリの Application Insights リソースを開き、[アクティビティ ログ] を選択します。

*一部のアラートは既知の問題に関するものであるため、受信を停止したいのですが。*

* バックログでアラートを非表示にできます。

## <a name="next-steps"></a>次の手順
これらの診断ツールを使用すると、アプリからテレメトリを調査できます。

* [メトリックス エクスプローラー](../../azure-monitor/app/metrics-explorer.md)
* [Search エクスプローラー](../../azure-monitor/app/diagnostic-search.md)
* [Analytics - 強力なクエリ言語](../../azure-monitor/log-query/get-started-portal.md)

スマート検出は、すべて自動化されています。 ただし、アラートを追加で設定する機能が用意されています。

* [手動で構成するメトリックのアラート](../../azure-monitor/app/alerts.md)
* [可用性 Web テスト](../../azure-monitor/app/monitor-web-app-availability.md)
