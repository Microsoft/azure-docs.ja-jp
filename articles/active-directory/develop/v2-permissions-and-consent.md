---
title: Microsoft ID プラットフォームのスコープ、アクセス許可、および同意
description: スコープ、アクセス許可、同意など、Microsoft ID プラットフォーム エンドポイントでの承認について説明します。
services: active-directory
author: rwike77
manager: CelesteDG
ms.service: active-directory
ms.subservice: develop
ms.workload: identity
ms.topic: conceptual
ms.date: 09/23/2020
ms.author: ryanwi
ms.reviewer: hirsin, jesakowi, jmprieur, marsma
ms.custom: aaddev, fasttrack-edit, contperf-fy21q1, identityplatformtop40
ms.openlocfilehash: 2658c088304eba457b25bb3dc421b356ba70b57f
ms.sourcegitcommit: 126ee1e8e8f2cb5dc35465b23d23a4e3f747949c
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/10/2021
ms.locfileid: "100102480"
---
# <a name="permissions-and-consent-in-the-microsoft-identity-platform"></a>Microsoft ID プラットフォームでのアクセス許可と同意

Microsoft ID プラットフォームと統合するアプリケーションは、データにアクセスする方法をユーザーと管理者が制御できるようにする承認モデルに従います。 Microsoft ID プラットフォームで、承認モデルの実装が更新されました。 アプリが Microsoft ID プラットフォームと対話する方法が変更されています。 この記事では、スコープ、アクセス許可、同意など、この承認モデルの基本的な概念について説明します。

## <a name="scopes-and-permissions"></a>スコープとアクセス許可

Microsoft ID プラットフォームでは、[OAuth 2.0](active-directory-v2-protocols.md) 承認プロトコルが実装されています。 OAuth 2.0 は、ユーザーに代わってサードパーティのアプリが Web でホストされるリソースにアクセスできる方法です。 Microsoft ID プラットフォームと統合される、Web でホストされるすべてのリソースは、リソース識別子つまり "*アプリケーション ID URI*" を持っています。 

Microsoft の Web でホストされるリソースの例をいくつか次に示します。

* Microsoft Graph: `https://graph.microsoft.com`
* Microsoft 365 メール API: `https://outlook.office.com`
* Azure Key Vault: `https://vault.azure.net`

Microsoft ID プラットフォームと統合されたサードパーティのリソースも同様です。 これらのリソースのいずれでも、機能をより小さいまとまりに分割するために使用できるアクセス許可のセットを定義できます。 たとえば、[Microsoft Graph](https://graph.microsoft.com) では、特に次のタスクを実行するアクセス許可が定義されています。

* ユーザーの予定表の読み取り
* ユーザーの予定表への書き込み
* ユーザーとしてのメールの送信

これらの種類のアクセス許可が定義されていることで、リソースでは、データと、API 機能を公開する方法を、きめ細かく制御できます。 サード パーティのアプリでは、ユーザーや管理者にこれらのアクセス許可を要求でき、ユーザーや管理者が承認してからでなければ、アプリはデータにアクセスしたり、ユーザーの代理として動作したりできません。 

リソースの機能を細かいアクセス許可セットにまとめると、サードパーティのアプリを、その機能を実行するために必要なアクセス許可のみを要求するように構築できます。 ユーザーと管理者は、アプリによってアクセスできるデータを把握できます。 また、アプリが悪意のある目的を持って動作していないことも確信できます。 開発者は常に最小限の特権の原則に従って、アプリケーションが機能するために必要なアクセス許可のみを要求する必要があります。

OAuth 2.0 では、これらの種類のアクセス許可セットは "*スコープ*" と呼ばれます。 "*アクセス許可*" と呼ばれることもよくあります。 Microsoft ID プラットフォームでは、アクセス許可は文字列値として表現されます。 Microsoft Graph の例では、各アクセス許可の文字列値は次のようになります。

* `Calendars.Read` を使用したユーザーの予定表の読み取り
* `Calendars.ReadWrite` を使用したユーザーの予定表への書き込み
* `Mail.Send` を使用したユーザーとしてのメールの送信

アプリでは、通常、Microsoft ID プラットフォーム承認エンドポイントへの要求でスコープを指定することにより、これらのアクセス許可を要求します。 ただし、一部の高い特権のアクセス許可は、管理者の同意によってのみ許可することができます。 これらは、[管理者の同意エンドポイント](#admin-restricted-permissions)を使用して要求または付与できます。 詳細については、この後の説明を参照してください。

## <a name="permission-types"></a>アクセス許可の種類

Microsoft ID プラットフォームでは、 "*委任されたアクセス許可*" と "*アプリケーションのアクセス許可*" という 2 種類のアクセス許可がサポートされています。

* **委任されたアクセス許可** は、サインインしているユーザーが存在するアプリで使用されます。 これらのアプリでは、アプリが要求するアクセス許可にユーザーまたは管理者が同意します。 アプリはアクセス許可を委任され、ターゲット リソースへの呼び出しを行うときに、サインインしているユーザーとして動作します。 

    一部の委任されたアクセス許可には、管理者以外のユーザーが同意できます。 ただし、高い特権のアクセス許可には[管理者の同意](#admin-restricted-permissions)が必要です。 委任されたアクセス許可に同意できる管理者ロールについては、[Azure Active Directory (Azure AD) での管理者ロールのアクセス許可](../roles/permissions-reference.md)に関する記事を参照してください。

* **アプリケーションのアクセス許可** は、サインインしているユーザーが存在しない状態で実行されるアプリ (バックグラウンド サービスまたはデーモンとして実行されるアプリなど) で使用されます。 アプリケーションのアクセス許可に[同意できるのは管理者](#requesting-consent-for-an-entire-tenant)だけです。

"_有効なアクセス許可_" は、アプリがターゲット リソースに要求を行うときに持っているアクセス許可です。 アプリに付与される委任されたアクセス許可とアプリケーションのアクセス許可の違い、およびアプリがターゲット リソースへの呼び出しを行うときに付与される有効なアクセス許可について理解しておくことが重要です。

- 委任されたアクセス許可の場合、アプリの "_有効なアクセス許可_" は、(同意によって) アプリに付与されている委任されたアクセス許可と現在サインインしているユーザーの特権に共通する部分の最小特権です。 サインインしているユーザーよりも多くの特権をアプリに付与することはできません。 

   組織内では、サインインしているユーザーの特権は、ポリシーによって決定することも、1 つ以上の管理者ロールのメンバーシップによって決定することもできます。 委任されたアクセス許可に同意できる管理者ロールについては、「[Azure AD での管理者ロールのアクセス許可](../roles/permissions-reference.md)」を参照してください。

   たとえば、委任されたアクセス許可として _User.ReadWrite.All_ がアプリに付与されているものとします。 通常、このアクセス許可は、組織内のすべてのユーザーのプロファイルを読み取り、更新する権限をアプリに付与します。 サインインしているユーザーが全体管理者の場合、アプリは組織内のすべてのユーザーのプロファイルを更新できます。 ただし、サインインしているユーザーに管理者ロールがない場合、アプリが更新できるのは、サインインしているユーザーのプロファイルだけです。 アプリにはユーザーの代理で動作するためのアクセス許可が付与されていますが、そのユーザーに組織内の他のユーザーのプロファイルを更新する権限がないため、アプリがこれを実行することはできません。

- アプリケーションのアクセス許可の場合、アプリの "_有効なアクセス許可_" は、そのアクセス許可が暗示する完全なレベルの権限になります。 たとえば、アプリケーションのアクセス許可として _User.ReadWrite.All_ が付与されているアプリは、組織内のすべてのユーザーのプロファイルを更新できます。

## <a name="openid-connect-scopes"></a>OpenID Connect のスコープ

OpenID Connect の Microsoft ID プラットフォーム実装には、Microsoft Graph でもホストされている適切に定義されたスコープ `openid`、`email`、`profile`、`offline_access` があります。 `address` と `phone` の OpenID Connect スコープはサポートされていません。

OpenID Connect スコープとトークンを要求すると、[UserInfo エンドポイント](userinfo.md)を呼び出すためのトークンを取得します。

### <a name="openid"></a>openid

アプリは、[OpenID Connect](active-directory-v2-protocols.md) を使用してサインインする場合、`openid` スコープを要求する必要があります。 `openid` スコープは、職場アカウントの同意ページでは **サインイン** アクセス許可として表示されます。 個人用 Microsoft アカウントの同意ページでは、**プロフィールの表示と、Microsoft アカウントを使うアプリとサービスへの接続** アクセス許可として表示されます。 

このアクセス許可を使用して、`sub` 要求の形式でユーザーの一意の識別子をアプリが受け取ることができます。 このアクセス許可により、アプリは UserInfo エンドポイントにもアクセスできます。 `openid` スコープは、Microsoft ID プラットフォーム トークン エンドポイントで ID トークンを取得するために使用できます。 これらのトークンは、アプリが認証に使用できます。

### <a name="email"></a>email

`email` スコープは `openid` スコープやその他のスコープと共に使用できます。 これにより、アプリがユーザーのプライマリ電子メール アドレスに `email` 要求の形式でアクセスできます。 

電子メール アドレスがユーザー アカウントと関連付けられている場合のみ (常にではありません)、`email` 要求はトークンに含まれます。 アプリは、`email` スコープを使用する場合は、トークン内に `email` 要求が存在しない状況に対応できる必要があります。

### <a name="profile"></a>プロファイル

`profile` スコープは `openid` スコープやその他のスコープと共に使用できます。 これにより、アプリはユーザーの多くの情報にアクセスできます。 アプリがアクセスできる情報には、ユーザーの名、姓、希望するユーザー名、オブジェクト ID などがありますが、これらに限定されるものではありません。 

特定のユーザーに対して `id_tokens` パラメーターで使用できる `profile` 要求の完全な一覧については、[`id_tokens` のリファレンス](id-tokens.md)をご覧ください。

### <a name="offline_access"></a>offline_access

[`offline_access`スコープ](https://openid.net/specs/openid-connect-core-1_0.html#OfflineAccess)を使用すると、アプリはユーザーの代わりに、長期間にわたってリソースにアクセスできます。 同意ページで、このスコープは、**アクセス権を与えたデータへのアクセスを管理する** アクセス許可として表示されます。 

ユーザーが `offline_access` スコープを承認すると、アプリは Microsoft ID プラットフォーム トークン エンドポイントから更新トークンを取得できます。 更新トークンの有効期間は長期です。 アプリは、古いアクセス トークンの有効期限が切れると、新しいアクセス トークンを取得できます。

> [!NOTE]
> このアクセス許可は、更新トークンを提供しないフロー ([暗黙的フロー](v2-oauth2-implicit-grant-flow.md)など) も含め、現在すべての同意ページに表示されます。 この設定は、クライアントが暗黙的フロー内で開始した後、更新トークンが予測されるコード フローに移行することができるシナリオに対応します。

Microsoft ID プラットフォーム (要求は v2.0 エンドポイントに対して行われます) では、更新トークンを受信するには、アプリが `offline_access` スコープを明示的に要求する必要があります。 そのため、[OAuth 2.0 承認コード フロー](active-directory-v2-protocols.md)の承認コードを使用すると、`/token` エンドポイントからアクセス トークンだけが取得されます。 

アクセス トークンの有効期間は短期です。 通常は、1 時間以内に期限切れとなります。 その時点で、アプリはユーザーを `/authorize` エンドポイントにリダイレクトして、新しい承認コードを取得する必要があります。 このリダイレクト中に、アプリの種類によっては、ユーザーが資格情報を再入力したり、アクセス許可に再同意したりする必要がある場合もあります。

更新トークンの取得方法と使用方法の詳細については、[Microsoft ID プラットフォーム プロトコルのリファレンス](active-directory-v2-protocols.md)を参照してください。

## <a name="requesting-individual-user-consent"></a>個々のユーザーの同意を要求する

[OpenID Connect または OAuth 2.0](active-directory-v2-protocols.md) 承認要求では、アプリは `scope` クエリ パラメーターを使用して、必要なアクセス許可を要求できます。 たとえば、ユーザーがアプリにサインインするときに、アプリは次の例のような要求を送信します。 (読みやすくするために改行が追加されています。)

```HTTP
GET https://login.microsoftonline.com/common/oauth2/v2.0/authorize?
client_id=6731de76-14a6-49ae-97bc-6eba6914391e
&response_type=code
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F
&response_mode=query
&scope=
https%3A%2F%2Fgraph.microsoft.com%2Fcalendars.read%20
https%3A%2F%2Fgraph.microsoft.com%2Fmail.send
&state=12345
```

`scope` パラメーターは、アプリが要求している委任されたアクセス許可の、空白文字で区切られた一覧です。 各アクセス許可は、リソースの識別子 (アプリケーション ID URI) にアクセス許可の値を追加して示されます。 上の要求では、ユーザーの予定表を読み取り、ユーザーとしてメールを送信するためのアクセス許可をアプリが必要としています。

ユーザーが資格情報を入力すると、Microsoft ID プラットフォームは、"*ユーザーの同意*" の一致するレコードがないか確認します。 ユーザーが過去に要求されたどのアクセス許可にも同意しておらず、管理者も組織全体の代わりにそれらのアクセス許可に同意していない場合、Microsoft ID プラットフォームは、要求されたアクセス許可を付与するようにユーザーに求めます。

この時点で、`offline_access` ("アクセス権を与えたデータへのアクセスを管理する") アクセス許可と `user.read` ("サインインとプロファイルの読み取り") アクセス許可が、アプリケーションへの初期同意に自動的に組み込まれます。  これらのアクセス許可は通常、アプリが適切に機能するために必要です。 `offline_access` アクセス許可により、アプリはネイティブ アプリと Web アプリで重要な更新トークンにアクセスできます。 `user.read` アクセス許可により、`sub` 要求にアクセスできます。 これによって、クライアントまたはアプリは、時間の経過と共にユーザーを正しく識別し、基本的なユーザー情報にアクセスできるようになります。

![職場アカウントの同意を示すスクリーンショットの例。](./media/v2-permissions-and-consent/work_account_consent.png)

ユーザーがアクセス許可要求を承認すると、同意が記録されます。 ユーザーは、後でアプリケーションにサインインするときに再度同意する必要はありません。

## <a name="requesting-consent-for-an-entire-tenant"></a>テナント全体の同意を要求する

組織は、アプリケーションのライセンスまたはサブスクリプションを購入する際に、多くの場合、組織のすべてのメンバーが使用できるようにアプリケーションを事前にセットアップすることを希望します。 このプロセスの一環として、管理者は、テナントのユーザーの代理としてアプリケーションへの同意を与えることができます。 管理者がテナント全体に対する同意を与えると、組織のユーザーにはアプリケーションの同意ページは表示されません。

テナントのユーザー全員に対して委任されたアクセス許可の同意を要求するには、アプリで管理者の同意エンドポイントを使用できます。

さらに、アプリケーションでは、管理者の同意エンドポイントを使用してアプリケーションのアクセス許可を要求する必要があります。

## <a name="admin-restricted-permissions"></a>管理者によって制限されるアクセス許可

Microsoft のリソースにおける高い特権のアクセス許可には、"*管理者によって制限されている*" に設定できるものがあります。 これらの種類のアクセス許可の例をいくつか、次に示します。

* `User.Read.All` を使用してすべてのユーザーの完全なプロファイルを読み取る
* `Directory.ReadWrite.All` を使用した組織のディレクトリへのデータの書き込み
* `Groups.Read.All` を使用して組織のディレクトリ内の全グループを読み取る

コンシューマー ユーザーがこの種類のデータへのアプリケーション アクセスを許可する場合がありますが、組織のユーザーは会社の同じ機密データへのアクセスを許可することはできません。 アプリケーションが組織のユーザーにこれらのアクセス許可のいずれかへのアクセスを要求すると、ユーザーは、アプリのアクセス許可に同意する権限がないという内容のエラー メッセージを受け取ります。

アプリが管理者によって制限されたアクセス許可のスコープを必要とする場合、組織の管理者は、組織のユーザーの代わりにこれらのスコープに同意する必要があります。 許可できないアクセス許可の同意を要求するプロンプトがユーザーに表示されないようにする場合、アプリでは管理者の同意エンドポイントを使用できます。 管理者の同意エンドポイントについては、次のセクションで説明します。

アプリケーションが高い特権の委任されたアクセス許可を要求していて、管理者の同意エンドポイントを介して管理者がこれらのアクセス許可を付与すると、テナントのユーザー全員に対して同意が付与されます。

アプリケーションがアプリケーションのアクセス許可を要求していて、管理者が管理者の同意エンドポイントを介してこれらのアクセス許可を付与する場合、この許可は特定のユーザーに代わっては行われません。 代わりに、クライアント アプリケーションはアクセス許可を "*直接*" 付与されます。 これらの種類のアクセス許可は、バックグラウンドで実行されるデーモン サービスと他の非対話型アプリケーションでのみ使用されます。

## <a name="using-the-admin-consent-endpoint"></a>管理者の同意エンドポイントを使用する

管理者の同意エンドポイントを使用して管理者の同意を付与したら、それで終了です。 ユーザーはそれ以上の操作を行う必要はありません。 管理者の同意が付与されると、ユーザーは一般的な認証フローを使用してアクセス トークンを取得できます。 結果として得られたアクセス トークンには、同意済みのアクセス許可が含まれています。

全体管理者がアプリケーションを使用していて、承認エンドポイントに送られると、Microsoft ID プラットフォームによってユーザーのロールが検出されます。 全体管理者がテナント全体に代わり、要求されたアクセス許可に対して同意するかどうかが尋ねられます。 その代わりに、専用の管理者の同意エンドポイントを使用して、テナント全体に代わってアクセス許可を付与するように管理者に事前に要求することもできます。 このエンドポイントは、アプリケーションのアクセス許可を要求する場合にも必要です。 アプリケーションのアクセス許可は、承認エンドポイントを使用して要求することはできません。

これから説明する手順に従うと、管理者に制限されているスコープを含むテナントのユーザー全員のアクセス許可をアプリで要求できます。 この操作には高い特権があります。 この操作は、ご自身のシナリオに必要な場合にだけ使用してください。

手順を実装するコード サンプルについては、GitHub の[管理者に制限されているスコープのサンプル](https://github.com/Azure-Samples/active-directory-dotnet-admin-restricted-scopes-v2)を参照してください。

### <a name="request-the-permissions-in-the-app-registration-portal"></a>アプリケーション登録ポータルでアクセス許可を要求する

アプリ登録ポータルでは、アプリケーションによってそれに必要なアクセス許可を、委任されたアクセス許可とアプリケーションのアクセス許可の両方を含め、一覧表示できます。 この設定により、`/.default` スコープと Azure portal の **[管理者の同意を与える]** オプションを使用できるようになります。  

通常、アクセス許可は、特定のアプリケーションに対して静的に定義する必要があります。 これらは、アプリが動的または増分的に要求するアクセス許可のスーパーセットであることが必要です。

> [!NOTE]
>アプリケーションのアクセス許可は、[`/.default`](#the-default-scope) を使用することによってのみ要求できます。 そのため、アプリにアプリケーションのアクセス許可が必要な場合は、アプリ登録ポータルにそららが一覧表示されていることを確認してください。

アプリケーションに対して静的に要求されるアクセス許可のリストを構成するには:

1. <a href="https://go.microsoft.com/fwlink/?linkid=2083908" target="_blank">Azure portal の [アプリの登録]</a> クイックスタート エクスペリエンス内のアプリケーションに移動します。
1. アプリケーションを選択するか、まだ作成していない場合は[アプリを作成](quickstart-register-app.md)します。
1. アプリケーションの **[概要]** ページの **[管理]** で、 **[API のアクセス許可]**  >  **[アクセス許可の追加]** の順に選択します。
1. 利用可能な API の一覧から **[Microsoft Graph]** を選択します。 次に、アプリに必要なアクセス許可を追加します。
1. **[アクセス許可の追加]** を選択します。

### <a name="recommended-sign-the-user-in-to-your-app"></a>推奨: アプリへのユーザーのサインイン

通常、管理者の同意エンドポイントを使用するアプリケーションを構築する場合は、アプリ側に管理者がアプリのアクセス許可を承認できるページやビューが必要です。 このページとして以下が考えられます。

* アプリのサインアップ フローの一部。
* アプリの設定の一部。
* 専用の "接続" フロー。 

多くの場合、職場の Microsoft アカウントまたは学校の Microsoft アカウントでユーザーがサインインした後にのみ、アプリでこの ”接続" ビューが表示されます。

ユーザーをアプリにサインインさせると、必要なアクセス許可の承認をユーザーに依頼する前に、管理者が所属する組織を識別できます。 この手順は必須ではありませんが、組織のユーザーに向けたより直観的なエクスペリエンスの作成に役立ちます。 

ユーザーをサインインさせるには、[Microsoft ID プラットフォーム プロトコルのチュートリアル](active-directory-v2-protocols.md)に従ってください。

### <a name="request-the-permissions-from-a-directory-admin"></a>ディレクトリ管理者にアクセス許可を要求する

組織の管理者にアクセス許可を要求する準備ができたら、Microsoft ID プラットフォームの管理者の同意エンドポイントにユーザーをリダイレクトできます。

```HTTP
// Line breaks are for legibility only.
GET https://login.microsoftonline.com/{tenant}/v2.0/adminconsent?
client_id=6731de76-14a6-49ae-97bc-6eba6914391e
&state=12345
&redirect_uri=http://localhost/myapp/permissions
&scope=
https://graph.microsoft.com/calendars.read
https://graph.microsoft.com/mail.send
```


| パラメーター        | 条件        | 説明                                                                                |
|:--------------|:--------------|:-----------------------------------------------------------------------------------------|
| `tenant` | 必須 | アクセス許可を要求するディレクトリ テナント。 これは GUID またはフレンドリ名の形式で指定できます。 または、例に示すように、組織で汎用的に参照することもできます。 "common" は使用しないでください。個人のアカウントでは、テナントのコンテキスト以外で管理者の同意を提供できないためです。 テナントを管理する個人用アカウントとの最善の互換性を確保するには、可能であればテナント ID を使用します。 |
| `client_id` | 必須 | [Azure portal の [アプリの登録]](https://go.microsoft.com/fwlink/?linkid=2083908) エクスペリエンスでアプリに割り当てられたアプリケーション (クライアント) ID。 |
| `redirect_uri` | 必須 |処理するアプリの応答の送信先となるリダイレクト URI。 アプリケーション登録ポータルで登録したリダイレクト URI のいずれかと完全に一致させる必要があります。 |
| `state` | 推奨 | 要求に含まれ、かつトークンの応答として返される値。 任意のコンテンツの文字列を指定することができます。 この状態は、認証要求の前にアプリ内でユーザーの状態 (表示中のページやビューなど) に関する情報をエンコードする目的に使用します。 |
|`scope`        | 必須        | アプリケーションによって要求されるアクセス許可のセットを定義します。 スコープは静的 ([`/.default`](#the-default-scope) を使用) または動的です。  このセットには、OpenID Connect スコープ (`openid`、`profile`、`email`) を含めることができます。 アプリケーションのアクセス許可が必要な場合は、`/.default` を使用して、静的に構成されたアクセス許可の一覧を要求する必要があります。  |


現在 Azure AD では、テナント管理者がサインインして、要求を完了する必要があります。 管理者は、ユーザーが `scope` パラメーターで要求したすべてのアクセス許可を承認するように求められます。  静的な (`/.default`) 値を使用した場合、それは v1.0 管理者の同意エンドポイントのように機能し、アプリに必要なアクセス許可で見つかったすべてのスコープに対する同意を要求します。

#### <a name="successful-response"></a>成功応答

管理者がアプリにアクセス許可を承認すると、成功応答は次のようになります。

```HTTP
GET http://localhost/myapp/permissions?tenant=a8990e1f-ff32-408a-9f8e-78d3b9139b95&state=state=12345&admin_consent=True
```

| パラメーター | 説明 |
| --- | --- |
| `tenant` | アプリケーションが要求したアクセス許可を GUID 形式で付与するディレクトリ テナント。 |
| `state` | 要求に含まれ、かつトークンの応答として返される値。 任意のコンテンツの文字列を指定することができます。 この状態は、認証要求の前にアプリ内でユーザーの状態 (表示中のページやビューなど) に関する情報をエンコードする目的に使用されます。 |
| `admin_consent` | `True` に設定されます。 |

#### <a name="error-response"></a>エラー応答

管理者がアプリにアクセス許可を承認しない場合、失敗した応答は次のようになります。

```HTTP
GET http://localhost/myapp/permissions?error=permission_denied&error_description=The+admin+canceled+the+request
```

| パラメーター | [説明] |
| --- | --- |
| `error` | 発生したエラーの種類を分類するために使用できるエラー コード文字列。 これはエラーへの対応にも使用できます。 |
| `error_description` | エラーの根本的な原因を開発者が特定しやすいように記述した具体的なエラー メッセージ。 |

管理者の同意エンドポイントから成功応答を受信した後で、アプリは要求したアクセス許可を獲得しています。 次に、必要なリソースのトークンを要求できます。

## <a name="using-permissions"></a>アクセス許可の使用

ユーザーがアプリのアクセス許可に同意したら、アプリは一定範囲でリソースにアクセスするためのアプリのアクセス許可を表すアクセス トークンを取得できます。 アクセス トークンは、1 つのリソースでのみ使用できます。 ただし、アクセス トークンの内部には、そのリソースに関してアプリに付与されたすべてのアクセス許可がエンコードされます。 アクセス トークンを取得するために、アプリは Microsoft ID プラットフォーム トークン エンドポイントに対して、次のような要求を行うことができます。

```HTTP
POST common/oauth2/v2.0/token HTTP/1.1
Host: https://login.microsoftonline.com
Content-Type: application/json

{
    "grant_type": "authorization_code",
    "client_id": "6731de76-14a6-49ae-97bc-6eba6914391e",
    "scope": "https://outlook.office.com/mail.read https://outlook.office.com/mail.send",
    "code": "AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq..."
    "redirect_uri": "https://localhost/myapp",
    "client_secret": "zc53fwe80980293klaj9823"  // NOTE: Only required for web apps
}
```

リソースへの HTTP 要求では、取得したアクセス トークンを使用できます。 アクセス トークンはリソースに対して、特定のタスクを行う適切なアクセス許可がアプリにあることを確実に示すことができます。

OAuth 2.0 プロトコルとアクセス トークンの取得方法の詳細については、[Microsoft ID プラットフォーム エンドポイント プロトコルのリファレンス](active-directory-v2-protocols.md)を参照してください。

## <a name="the-default-scope"></a>/.default スコープ

`/.default` スコープを使用すると、v1.0 エンドポイントから Microsoft ID プラットフォーム エンドポイントにアプリを移行するのに役立ちます。 `/.default` スコープは、アプリケーション登録で構成されたアクセス許可の静的一覧を参照するすべてのアプリケーションに組み込まれています。 

`https://graph.microsoft.com/.default` の `scope` 値は、機能的に v1.0 エンドポイントの `resource=https://graph.microsoft.com` と同じです。 アプリケーションは、その要求に `https://graph.microsoft.com/.default` スコープを指定することで、アプリ登録ポータルでアプリに対して選択されたすべての Microsoft Graph アクセス許可のスコープを含むアクセス トークンを要求します。 スコープは、リソース URI と `/.default` を使用して作成されます。 そのため、リソース URI が `https://contosoApp.com` である場合、要求されるスコープは `https://contosoApp.com/.default` になります。  トークンを正しく要求するために 2 つ目のスラッシュを含める必要がある場合は、[末尾のスラッシュに関するセクション](#trailing-slash-and-default)を参照してください。

`/.default` スコープは、任意の OAuth 2.0 フローで使用できます。 ただし、[On-Behalf-Of フロー](v2-oauth2-on-behalf-of-flow.md)と[クライアント資格情報フロー](v2-oauth2-client-creds-grant-flow.md)では必須です。 また、v2 管理者の同意エンドポイントを使用してアプリケーションのアクセス許可を要求する場合にも必要です。

クライアントは、静的 (`/.default`) な同意と動的な同意を 1 つの要求に結合することはできません。 そのため、`scope=https://graph.microsoft.com/.default+mail.read` を指定すると、スコープの種類が結合されるため、エラーになります。

### <a name="default-and-consent"></a>/.default と同意

`/.default` スコープは、`prompt=consent` に対しても v1.0 エンドポイントの動作をトリガーします。 リソースに関係なく、アプリケーションによって登録されたすべてのアクセス許可に対して同意が要求されます。 要求の一部として含まれている場合、`/.default` スコープは、要求されたリソースのスコープを含むトークンを返します。

### <a name="default-when-the-user-has-already-given-consent"></a>ユーザーが既に同意している場合の /.default

`/.default` スコープは機能的に、`resource` 中心の v1.0 エンドポイントの動作と同じです。 また、v1.0 エンドポイントの同意動作も備えています。 つまり、`/.default` では、ユーザーがクライアントとリソース間のアクセス許可を付与していない場合にのみ、同意プロンプトがトリガーされます。 

このような同意が存在する場合、返されるトークンには、そのリソースに関してユーザーが付与したすべてのスコープが含まれます。 ただし、アクセス許可が付与されていない場合や `prompt=consent` パラメーターが指定されている場合は、クライアント アプリケーションによって登録されたすべてのスコープに対して同意プロンプトが表示されます。

#### <a name="example-1-the-user-or-tenant-admin-has-granted-permissions"></a>例 1:ユーザーまたはテナント管理者がアクセス許可を付与している

この例では、ユーザーまたはテナント管理者が `mail.read` と `user.read` の Microsoft Graph アクセス許可をクライアントに付与しています。 

クライアントが `scope=https://graph.microsoft.com/.default` を要求すると、Microsoft Graph に対するクライアント アプリケーションの登録済みアクセス許可の内容に関係なく、同意プロンプトは表示されません。 返されるトークンにはスコープ `mail.read` と `user.read` が含まれます。

#### <a name="example-2-the-user-hasnt-granted-permissions-between-the-client-and-the-resource"></a>例 2:ユーザーがクライアントとリソース間のアクセス許可を付与していない

この例では、ユーザーがクライアントと Microsoft Graph 間の同意を付与していません。 クライアントは、アクセス許可 `user.read` と `contacts.read` に登録されています。 また、Azure Key Vault スコープ `https://vault.azure.net/user_impersonation` にも登録されています。 

クライアントが `scope=https://graph.microsoft.com/.default` のトークンを要求すると、`user.read` スコープ、`contacts.read` スコープ、Key Vault `user_impersonation` スコープの同意ページがユーザーに表示されます。 返されるトークンには `user.read` と `contacts.read` のスコープだけが含まれます。 これは、Microsoft Graph に対してのみ使用できます。

#### <a name="example-3-the-user-has-consented-and-the-client-requests-more-scopes"></a>例 3: ユーザーは同意済みで、クライアントが追加のスコープを要求する

この例では、ユーザーは、クライアントの `mail.read` に既に同意しています。 クライアントは、`contacts.read` スコープに登録されています。 

クライアントが `scope=https://graph.microsoft.com/.default` を使用してトークンを要求し、`prompt=consent` を介して同意を要求すると、アプリケーションによって登録されたすべて (かつ唯一) のアクセス許可の同意ページがユーザーに表示されます。 `contacts.read` スコープは同意ページにありますが、`mail.read` はありません。 返されるトークンは Microsoft Graph に対するものです。 これには `mail.read` と `contacts.read` が含まれます。

### <a name="using-the-default-scope-with-the-client"></a>クライアントで /.default スコープを使用する

場合によっては、クライアントが独自の `/.default` スコープを要求できることがあります。 このシナリオを以下の例で説明します。

```HTTP
// Line breaks are for legibility only.

GET https://login.microsoftonline.com/{tenant}/oauth2/v2.0/authorize?
response_type=token            //Code or a hybrid flow is also possible here
&client_id=9ada6f8a-6d83-41bc-b169-a306c21527a5
&scope=9ada6f8a-6d83-41bc-b169-a306c21527a5/.default
&redirect_uri=https%3A%2F%2Flocalhost
&state=1234
```

同意と `/.default` の前述の説明がこのシナリオに適用される場合、このコード例では登録済みのすべてのアクセス許可の同意ページが生成されます。 この場合、コードによってアクセス トークンではなく `id_token` が返されます。  

この動作は、Azure AD Authentication Library (ADAL) から Microsoft Authentication Library (MSAL) に移行している一部のレガシ クライアントに対応しています。 この設定は、Microsoft ID プラットフォームを対象とする新しいクライアントでは使用 "*できません*"。

### <a name="client-credentials-grant-flow-and-default"></a>クライアント資格情報付与フローと /.default  

`/.default` のもう 1 つの用途は、Web API を呼び出すための [クライアント資格情報](v2-oauth2-client-creds-grant-flow.md)付与フローを使用するデーモン アプリのような非対話型アプリケーションで、アプリケーションのアクセス許可 (または "*ロール*") を要求することです。

Web API についてのアプリケーションのアクセス許可 (ロール) を作成するには、[アプリケーションへのアプリ ロールの追加](howto-add-app-roles-in-azure-ad-apps.md)に関する記事を参照してください。

クライアント アプリ内のクライアント資格情報要求には `scope={resource}/.default` を含める "*必要があります*"。 ここでは `{resource}` が、アプリが呼び出そうとしている Web API です。 個々のアプリケーションのアクセス許可 (ロール) を使用したクライアント資格情報要求の発行は、サポートされて "*いません*"。 返されるアクセス トークンには、その Web API に付与されているすべてのアプリケーションのアクセス許可 (ロール) が含まれます。

アプリケーション向けの管理者の同意の付与など、定義するアプリケーションのアクセス許可にアクセス権を付与するには、「[Web API にアクセスするようにクライアント アプリケーションを構成する](quickstart-configure-app-access-web-apis.md)」を参照してください。

### <a name="trailing-slash-and-default"></a>末尾のスラッシュと /.default

一部のリソース URI には末尾にスラッシュが付いています。たとえば、`https://contoso.com` ではなく `https://contoso.com/` のようになります。 末尾にスラッシュがあると、トークンの検証で問題が発生する場合があります。 主に、Azure Resource Manager (`https://management.azure.com/`) のトークンが要求されたときに問題が発生します。 この場合、リソース URI の末尾のスラッシュは、トークンの要求時にスラッシュが必要であることを意味します。  そのため、`https://management.azure.com/` のトークンを要求し、`/.default` を使用する場合は、`https://management.azure.com//.default` を要求する必要があります (二重スラッシュに注意してください)。 一般的に、トークンが発行されていることを検証していて、それを受け入れるべき API がトークンを拒否している場合は、2 番目のスラッシュを追加して再試行することを検討してください。 

## <a name="troubleshooting-permissions-and-consent"></a>アクセス許可と同意のトラブルシューティング

トラブルシューティング手順については、「[アプリケーションに同意すると、予期しないエラーが発生する](../manage-apps/application-sign-in-unexpected-user-consent-error.md)」を参照してください。

## <a name="next-steps"></a>次の手順

* [Microsoft ID プラットフォームの ID トークン](id-tokens.md)
* [Microsoft ID プラットフォームのアクセス トークン](access-tokens.md)
