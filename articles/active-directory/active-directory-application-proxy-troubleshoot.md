
---
title: "アプリケーション プロキシのトラブルシューティング | Microsoft Docs"
description: "Azure AD アプリケーション プロキシのエラーのトラブルシューティングを行う方法について説明します。"
services: active-directory
documentationcenter: 
author: kgremban
manager: femila
editor: harshja
ms.assetid: 970caafb-40b8-483c-bb46-c8b032a4fb74
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 03/07/2017
ms.author: kgremban
ms.custom: H1Hack27Feb2017
translationtype: Human Translation
ms.sourcegitcommit: a087df444c5c88ee1dbcf8eb18abf883549a9024
ms.openlocfilehash: 0051bbeaac458e8df07e5c7aa186fbefb526f50e
ms.lasthandoff: 03/15/2017

---


# <a name="troubleshoot-application-proxy-problems-and-error-messages"></a>アプリケーション プロキシの問題とエラー メッセージのトラブルシューティング | Microsoft Docs
発行されたアプリケーションへのアクセス中、またはアプリケーションの発行中にエラーが発生する場合は、Microsoft Azure AD アプリケーション プロキシが正しく機能しているかどうかを次のオプションで確認します。

* Windows サービス コンソールを開き、**Microsoft AAD アプリケーション プロキシ コネクタ** サービスが有効で実行されていることを確認します。 次の図のように、アプリケーション プロキシ サービスのプロパティ ページで確認することもできます。  
  ![Microsoft AAD アプリケーション プロキシ コネクタのプロパティのスクリーンショット](./media/active-directory-application-proxy-troubleshoot/connectorproperties.png)
* イベント ビューアーを開き、**[アプリケーションとサービス ログ]** > **[Microsoft]** > **[AadApplicationProxy]** > **[コネクタ]** > **[Admin]** の順に移動して、[Admin] の下にあるアプリケーション プロキシ コネクタ イベントを探します。
* 必要に応じて、分析およびデバッグ ログを有効にし、サービス アプリケーション プロキシ コネクタのセッション ログを有効にすることで、より詳細なログを使用できます。

Azure AD のトラブルシューティング ツールについて詳しくは、「[Troubleshooting tool to validate connector networking prerequisites (コネクタのネットワークの前提条件を検証するためのトラブルシューティング ツール)](https://blogs.technet.microsoft.com/applicationproxyblog/2015/09/03/troubleshooting-tool-to-validate-connector-networking-prerequisites)」をご覧ください。

## <a name="the-page-is-not-rendered-correctly"></a>ページが正しく表示されない
特定のエラー メッセージが表示されない場合でも、アプリケーションが正しくレンダリングまたは機能しないことがあります。 これは、記事のパスを発行した場合に発生することがありますが、アプリケーションは、そのパスの外部に存在するコンテンツを必要とします。

たとえば、https://yourapp/app というパスを発行しても、アプリケーションが https://yourapp/media 内のイメージを呼び出した場合、イメージは表示されません。 アプリケーションの発行には、関連するコンテンツをすべて含めるために必要な最上位のパスを使用するようにしてください。 この例では、http://yourapp/ となります。

参照するコンテンツを含めるようにパスを変更しても、ユーザーにそのパスのさらに深いリンクにアクセスしてもらう必要がある場合は、ブログ記事「 [Setting the right link for Application Proxy applications in the Azure AD access panel and Office 365 app launcher (Azure AD アクセス パネルと Office 365 アプリ起動ツールでのアプリケーション プロキシ アプリケーションの適切なリンクの設定)](https://blogs.technet.microsoft.com/applicationproxyblog/2016/04/06/setting-the-right-link-for-application-proxy-applications-in-the-azure-ad-access-panel-and-office-365-app-launcher/)」を参照してください。

## <a name="connector-errors"></a>コネクタのエラー

[Azure AD アプリケーション プロキシ コネクタ ポート テスト ツール](https://aadap-portcheck.connectorporttest.msappproxy.net/)を使用して、コネクタがアプリケーション プロキシ サービスにアクセスできることを確認します。 少なくとも、米国中部リージョンと自分に最も近いリージョンにすべて緑色のチェックマークが表示されていることを確認します。 その他の場合は、緑色のチェックマークが多いほど、リカバリ性が高いことを意味します。 

コネクタ ウィザードのインストール中に登録に失敗した場合は、2 とおりの方法でエラーの原因を確認できます。 **Applications and Services Logs\Microsoft\AadApplicationProxy\Connector\Admin** にあるイベント ログを確認するか、次の Windows PowerShell コマンドを実行してください。

    Get-EventLog application –source “Microsoft AAD Application Proxy Connector” –EntryType “Error” –Newest 1

イベント ログでコネクタのエラーが確認された場合は、以下に示す一般的なエラーの一覧を参考に問題を解決してください。

- **コネクタ登録に失敗しました: Microsoft Azure 管理ポータルでアプリケーション プロキシを有効化したことと、Active Directory ユーザー名とパスワードを正しく入力したことを確認してください。エラー: '1 つ以上のエラーが発生しました。'**

  Azure AD にサインインせずに登録ウィンドウを閉じた場合は、コネクタ ウィザードを再実行してコネクタを登録します。

  登録ウィンドウが開き、ログインを許さずにすぐに閉じてしまった場合は、通常、このエラーが発生します。 このエラーは、ネットワーク エラーがシステムで起きた場合に発生します。 ブラウザーから一般 Web サイトに接続できることと、「 [アプリケーション プロキシの前提条件](active-directory-application-proxy-enable.md)」で指定されているようにポートが開かれていることを確認してください。

- **コネクタの登録に失敗しました: コンピューターがインターネットに接続されていることを確認してください。エラー: 'メッセージを受信できる https://connector.msappproxy.net:9090/register/RegisterConnector でリッスンしているエンドポイントがありませんでした。これは一般に、アドレスまたは SOAP アクションが正しくない場合に発生します。詳細については、InnerException を参照してください (ある場合)。'**

  Azure AD のユーザー名とパスワードを使用してサインインしてもこのエラーが発生する場合は、8081 より上のすべてのポートがブロックされている可能性があります。 必要なポートが開かれていることを確認します。 詳細については、「 [アプリケーション プロキシの前提条件](active-directory-application-proxy-enable.md)」を参照してください。

- **登録ウィンドウに明確なエラーが表示されています。続行できません。**

  このエラーが表示されてウィンドウが閉じた場合は、入力したユーザー名かパスワードが間違っています。 やり直してください。 

- **コネクタ登録に失敗しました: Microsoft Azure 管理ポータルでアプリケーション プロキシを有効化したことと、Active Directory ユーザー名とパスワードを正しく入力したことを確認してください。エラー: 'AADSTS50059: テナントを識別する情報が要求内に見つからず、指定されたどの資格情報でも暗黙的に示されなかったため、サービス プリンシパル URI による検索が失敗しました。** 

  Microsoft アカウントと、アクセスしようとしているディレクトリの組織 ID の一部であるドメイン以外を使用して、サインインしようとしています。 admin がテナント ドメインと同じドメイン名の一部であることを確認します。たとえば、Azure AD ドメインが contoso.com である場合、admin は admin@contoso.com である必要があります。 

- **PowerShell スクリプトを実行するための現在の実行ポリシーを取得できませんでした。** 

  コネクタのインストールに失敗した場合は、PowerShell 実行ポリシーが無効になっていないことを確認します。 

  1. グループ ポリシー エディターを開きます。 
  2. **[コンピューターの構成]** > **[管理用テンプレート]** > **[Windows コンポーネント]** > **[Windows PowerShell]** の順に移動して、**[スクリプトの実行を有効にする]** をダブルクリックします。 
  3. 実行ポリシーは、**[未構成]** または **[有効]** に設定できます。 **[有効]** に設定した場合は、[オプション] で実行ポリシーが **[ローカル スクリプトおよびリモートの署名済みスクリプトを許可する]** または **[すべてのスクリプトを許可する]** に設定されていることを確認します。 

- **コネクタが構成のダウンロードに失敗しました。** 

  認証に使用される、コネクタのクライアント証明書が期限切れです。 このエラーは、コネクタをプロキシの背後にインストールした場合にも発生することがあります。 その場合、コネクタはインターネットにアクセスできず、リモート ユーザーにアプリケーションを提供できません。 Windows PowerShell で `Register-AppProxyConnector` コマンドレットを使用して、手動で信頼を更新します。 コネクタがプロキシの背後にある場合は、コネクタ アカウントの "ネットワーク サービス" および "ローカル システム" にインターネットへのアクセスを許可する必要があります。 そうするには、プロキシへのアクセスを許可するか、プロキシをバイパスするように設定します。 

- **コネクタの登録に失敗しました: コネクタを登録する Active Directory のグローバル管理者であることを確認してください。エラー: '登録要求が拒否されました。'** 

  ログインに使用しようとしているエイリアスは、このドメインの管理者ではありません。 コネクタは必ず、ユーザーのドメインを所有しているディレクトリ用にインストールされます。 サインインに使用している管理者アカウントが、Azure AD テナントに対するグローバル アクセス許可を持っていることを確認してください。 

## <a name="kerberos-errors"></a>Kerberos のエラー

ここでは、Kerberos のセットアップと構成に関連する一般的なエラーと、推奨される解決策を示します。

- **PowerShell スクリプトを実行するための現在の実行ポリシーを取得できませんでした。** 

  コネクタのインストールに失敗した場合は、PowerShell 実行ポリシーが無効になっていないことを確認します。 

  1. グループ ポリシー エディターを開きます。 
  2. **[コンピューターの構成]** > **[管理用テンプレート]** > **[Windows コンポーネント]** > **[Windows PowerShell]** の順に移動して、**[スクリプトの実行を有効にする]** をダブルクリックします。 
  3. 実行ポリシーは、**[未構成]** または **[有効]** に設定できます。 **[有効]** に設定した場合は、[オプション] で実行ポリシーが **[ローカル スクリプトおよびリモートの署名済みスクリプトを許可する]** または **[すべてのスクリプトを許可する]** に設定されていることを確認します。 

- **12008 - Azure AD が、バックエンド サーバーに対する Kerberos 認証の試行で、許可されている最大数を超えました。** 

  このエラーは、Azure AD とバックエンド アプリケーション サーバー間の構成が正しくないことや、両方のコンピューターに日付と時刻の構成の問題があることを示している場合があります。 バックエンド サーバーが、Azure AD によって作成された Kerberos チケットを拒否しました。 Azure AD とバックエンド アプリケーション サーバーが正しく構成されていることを確認してください。 Azure AD とバックエンド アプリケーション サーバーの日付と時刻の構成が同期されていることを確認してください。 

- **13016 - Azure AD が、エッジ トークンまたはアクセス Cookie に UPN がないため、ユーザーに代わって Kerberos チケットを取得できません。** 

  STS 構成の問題があります。 STS の UPN 要求の構成を修正してください。 

- **13019 - Azure AD が、次の一般 API エラーのため、ユーザーに代わって Kerberos チケットを取得できません。** 

  このイベントは、Azure AD とドメイン コントローラー サーバー間の構成が正しくないことや、両方のコンピューターに日付と時刻の構成の問題があることを示している場合があります。 ドメイン コントローラーが、Azure AD によって作成された Kerberos チケットを拒否しました。 Azure AD とバックエンド アプリケーション サーバーが正しく構成されていることを確認してください (特に SPN 構成)。 ドメイン コントローラーが Azure AD との信頼関係を確立できるように、Azure AD がドメイン コントローラーと同じドメインに参加しているドメインであることを確認してください。 Azure AD とドメイン コントローラーの日付と時刻の構成が同期されていることを確認してください。 

- **13020 - バックエンド サーバー SPN が定義されていないため、Azure AD がユーザーに代わって Kerberos チケットを取得できません。** 

  このイベントは、Azure AD とドメイン コントローラー サーバー間の構成が正しくないことや、両方のコンピューターに日付と時刻の構成の問題があることを示している場合があります。 ドメイン コントローラーが、Azure AD によって作成された Kerberos チケットを拒否しました。 Azure AD とバックエンド アプリケーション サーバーが正しく構成されていることを確認してください (特に SPN 構成)。 ドメイン コントローラーが Azure AD との信頼関係を確立できるように、Azure AD がドメイン コントローラーと同じドメインに参加しているドメインであることを確認してください。 Azure AD とドメイン コントローラーの日付と時刻の構成が同期されていることを確認してください。 

- **13022 - バックエンド サーバーが Kerberos 認証の試行に対して HTTP 401 エラーを返すため、Azure AD がユーザーを認証できません。** 

  このイベントは、Azure AD とバックエンド アプリケーション サーバー間の構成が正しくないことや、両方のコンピューターに日付と時刻の構成の問題があることを示している場合があります。 バックエンド サーバーが、Azure AD によって作成された Kerberos チケットを拒否しました。 Azure AD とバックエンド アプリケーション サーバーが正しく構成されていることを確認してください。 Azure AD とバックエンド アプリケーション サーバーの日付と時刻の構成が同期されていることを確認してください。 

## <a name="end-user-errors"></a>エンド ユーザー側のエラー

ここでは、エンド ユーザーがアプリにアクセスしようとして失敗たときに表示される可能性のあるエラーについて説明します。 

- **Web サイトはページを表示できません** 

  アプリケーションが IWA アプリケーションである場合、発行したアプリにユーザーがアクセスしようとしたときに、このエラーが表示されることがあります。 このアプリケーションのために定義された SPN が正しくない可能性があります。 IWA アプリの場合: このアプリケーションのために構成された SPN が正しいことを確認してください。 

- **Web サイトはページを表示できません** 

  アプリケーションが OWA アプリケーションである場合、発行したアプリにユーザーがアクセスしようとしたときに、このエラーが表示されることがあります。 この場合は、次のいずれかの原因が考えられます。 
  - このアプリケーションのために定義された SPN が正しくありません。 このアプリケーションのために構成された SPN が正しいことを確認します。
  - アプリケーションにアクセスしようとしたユーザーが、サインインするための適切な企業アカウントではなく Microsoft アカウントを使用しているか、ユーザーがゲスト ユーザーです。 ユーザーが、発行されたアプリケーションのドメインに一致する企業アカウントを使用してサインインするようにします。 Microsoft アカウントのユーザーとゲストが、IWA アプリケーションにアクセスできません。
  - アプリケーションにアクセスしようとしたユーザーが、オンプレミス側で、このアプリケーション用に適切に定義されていません。 このユーザーが、オンプレミス コンピューターでこのバックエンド アプリケーションに対して定義されているような適切なアクセス許可を持っていることを確認します。

- **この企業のアプリにはアクセスできません。このアプリケーションにアクセスする権限がありません。承認に失敗しました。このアプリケーションへのアクセス権をユーザーに割り当ててください。** 

  サインインに企業アカウントではなく Microsoft アカウントを使用しているユーザーが、発行済みのアプリにアクセスしようとしたときに、このエラーが表示されることがあります。 このエラーはゲスト ユーザーにも表示されることがあります。 Microsoft アカウントのユーザーとゲスト ユーザーは IWA アプリケーションにはアクセスできません。 ユーザーが、発行されたアプリケーションのドメインに一致する企業アカウントを使用してサインインするようにします。 

  このアプリケーションにユーザーを割り当てていない可能性があります。 **[アプリケーション]** タブに移動し、**[ユーザーとグループ]** でこのユーザーまたはユーザー グループをこのアプリケーションに割り当てます。

- **この企業アプリには、現在、アクセスできません。後でもう一度やり直してください。コネクタがタイムアウトになりました。** 

  オンプレミス側でこのアプリケーション向けに適切に定義されていないユーザーが、発行済みのアプリにアクセスしようとしたときに、このエラーが表示されることがあります。 ユーザーが、オンプレミス コンピューターでこのバックエンド アプリケーションに対して定義されている適切なアクセス許可を持っていることを確認してください。 

- **この企業のアプリにはアクセスできません。このアプリケーションにアクセスする権限がありません。承認に失敗しました。ユーザーが Azure Active Directory Premium または Basic のライセンスを持っていることを確認します。**

  サブスクライバーの管理者によってユーザーに対して Premium/Basic ライセンスが明示的に割り当てられていない場合、発行されたアプリにそのユーザーがアクセスしようとすると、このエラーが発生することがあります。 サブスクライバーの Active Directory **[ライセンス]** タブに移動し、このユーザーまたはユーザー グループに Premium または Basic ライセンスが割り当てられていることを確認します。

## <a name="my-error-wasnt-listed-here"></a>上記に記載のないエラー

Azure AD アプリケーション プロキシでこのトラブルシューティング ガイドの一覧にないエラーまたは問題が発生した場合は、 発生したエラーの詳細を記した電子メールを[フィードバック チーム](mailto:aadapfeedback@microsoft.com)までお送りください。

## <a name="see-also"></a>関連項目
* [Azure Active Directory のアプリケーション プロキシを有効にする](active-directory-application-proxy-enable.md)
* [アプリケーション プロキシを使用してアプリケーションを発行する](active-directory-application-proxy-publish.md)
* [シングル サインオンの有効化](active-directory-application-proxy-sso-using-kcd.md)
* [条件付きアクセスを有効にする](active-directory-application-proxy-conditional-access.md)


<!--Image references-->
[1]: ./media/active-directory-application-proxy-troubleshoot/connectorproperties.png
[2]: ./media/active-directory-application-proxy-troubleshoot/sessionlog.png

