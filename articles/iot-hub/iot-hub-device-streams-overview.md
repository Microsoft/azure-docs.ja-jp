---
title: Azure IoT Hub デバイス ストリーム | Microsoft Docs
description: さまざまな cloud-to-device 通信シナリオのセキュリティで保護された双方向 TCP トンネルを支援する、Azure IoT Hub デバイス ストリームの概要について説明します。
author: robinsh
services: iot-hub
ms.service: iot-hub
ms.topic: conceptual
ms.date: 01/15/2019
ms.author: robinsh
ms.custom:
- 'Role: Cloud Development'
- 'Role: IoT Device'
- 'Role: Technical Support'
ms.openlocfilehash: 4a13d1ff030a63d3ccf33297f215909f5920e16a
ms.sourcegitcommit: a76ff927bd57d2fcc122fa36f7cb21eb22154cfa
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/28/2020
ms.locfileid: "87327686"
---
# <a name="iot-hub-device-streams-preview"></a>IoT Hub デバイス ストリーム (プレビュー)

Azure IoT Hub *デバイス ストリーム*によって、さまざまな cloud-to-device 通信シナリオのセキュリティで保護された双方向 TCP トンネルの作成が容易になります。 デバイス ストリームは、デバイスとサービス エンドポイント間のプロキシとして機能する、IoT Hub *ストリーミング エンドポイント*によって仲介されます。 下の図に示されているこのセットアップは、デバイスがネットワーク ファイアウォールの背後にある場合や、プライベート ネットワーク内にある場合に特に便利です。 そのため、IoT Hub デバイス ストリームは、ファイアウォール フレンドリな方法で、着信または発信ネットワーク ファイアウォール ポートを広範に開くことなく、IoT デバイスにアクセスしたいという、お客様のニーズに応えるのに役立ちます。

!["IoT Hub デバイス ストリームの概要"](./media/iot-hub-device-streams-overview/iot-hub-device-streams-overview.png )

IoT Hub デバイス ストリームを使用することで、デバイスは安全に保たれます。デバイスでは、ポート 443 経由で IoT ハブのストリーミング エンドポイントへのアウトバウンド TCP 接続を開くだけで済みます。 ストリームが確立されると、サービス側とデバイス側のアプリケーションはそれぞれ、WebSocket クライアント オブジェクトにプログラムでアクセスし、RAW 型バイトに対する送受信を行うことができます。 このトンネルによって提供される信頼性と順序の保証は、TCP の場合と同様です。

## <a name="benefits"></a>メリット

IoT Hub デバイス ストリームには次の利点があります。

* **ファイアウォール フレンドリなセキュア接続:** デバイスまたはネットワーク境界でインバウンド ファイアウォール ポートを開かずに、サービス エンドポイントから IoT デバイスにアクセスできます (ポート 443 を経由する必要があるのは、IoT Hub へのアウトバウンド接続のみです)。

* **認証:** トンネルのデバイス側とサービス側の両方で、対応する資格情報を使って、IoT Hub を認証する必要があります。

* **暗号化:** 既定では、IoT Hub デバイス ストリームで TLS 対応の接続が使用されます。 そのため、アプリケーションで暗号化を使用するかどうかに関係なく、トラフィックは常に暗号化されます。

* **接続の簡素化:** 多くの場合、デバイス ストリームを使うことによって、IoT デバイスに接続できるようにするための仮想プライベート ネットワークの複雑なセットアップの必要がなくなります。

* **TCP/IP スタックとの互換性:** IoT Hub デバイス ストリームでは、TCP/IP アプリケーション トラフィックに対応できます。 つまり、広範な専用プロトコルおよび標準ベースのプロトコルで、この機能を利用できます。

* **プライベート ネットワーク セットアップの簡単な使用:** サービスは、デバイスの IP アドレスではなく、デバイス ID を参照することで、デバイスと通信できます。 これは、デバイスがプライベート ネットワーク内にあり、プライベート IP アドレスを持っているか、その IP アドレスが動的に割り当てられており、サービス側に認識されていない場合に便利です。

## <a name="device-stream-workflows"></a>デバイス ストリームのワークフロー

デバイス ID を提供してデバイスに接続するように、サービスによって要求されたときに、デバイス ストリームが開始されます。 このワークフローは特に、ユーザーが SSH または RDP クライアント プログラムを使用して、デバイス上で実行されている SSH または RDP サーバーにリモートで接続しようとしている (SSH および RDP を含む) クライアント/サーバー通信モデルに適しています。

デバイス ストリームの作成プロセスには、デバイス、サービス、IoT ハブのメインおよびストリーミング エンドポイントの間のネゴシエーションが含まれます。 IoT ハブのメイン エンドポイントでデバイス ストリームの作成が調整されている間に、ストリーミング エンドポイントでは、サービスとデバイスの間を流れるトラフィックが処理されます。

### <a name="device-stream-creation-flow"></a>デバイス ストリームの作成フロー

SDK を使用するデバイス ストリームのプログラムによる作成には、下の図にも示されている、次の手順が含まれます。

!["デバイス ストリームのハンドシェイク プロセス"](./media/iot-hub-device-streams-overview/iot-hub-device-streams-handshake.png)

1. デバイス アプリケーションでは、デバイスに対して新しいデバイス ストリームが開始されたときに通知されるように、事前にコールバックが登録されます。 この手順は、通常、デバイスが起動し、IoT Hub に接続されたときに行われます。

2. サービス側のプログラムでは、(IP アドレス _ではなく_) デバイス ID を提供することで、必要なときにデバイス ストリームを開始します。

3. IoT ハブでは、手順 1 で登録したコールバックを呼び出して、デバイス側のプログラムに通知します。 デバイスでは、ストリームの開始要求を受け入れるか拒否する場合があります。 このロジックは、アプリケーションのシナリオに固有である可能性があります。 ストリーム要求がデバイスによって拒否された場合、IoT Hub で適宜、サービスに通知します。それ以外の場合は、以下の手順が続きます。

4. デバイスでは、ポート 443 経由のストリーミング エンドポイントへの安全なアウトバウンド TCP 接続が作成され、接続が WebSocket にアップグレードされます。 ストリーミング エンドポイントの URL と、認証に使用する資格情報は両方とも、手順 3 で送信された要求の一部として IoT Hub によってデバイスに提供されます。

5. サービスは、ストリームを受け入れるデバイスの結果の通知を受け取り、ストリーミング エンドポイントへの独自の WebSocket クライアントの作成に進みます。 同様に、IoT Hub からのストリーミング エンドポイントの URL と認証情報を受信します。

上記のハンドシェイク プロセスの場合:

* ハンドシェイク プロセスは 60 秒以内に完了する必要があります (手順 2 から 5)。そうしないと、ハンドシェイクがタイムアウトになって失敗し、適宜、サービスに通知されます。

* 上記のストリームの作成フローの完了後、ストリーミング エンドポイントはプロキシとして機能し、サービスとデバイス間のトラフィックをそれぞれの WebSocket 経由で転送します。

* デバイスとサービスの両方に、ポート 443 経由のストリーミング エンドポイントと IoT Hub のメイン エンドポイントへのアウトバウンド接続が必要です。 これらのエンドポイントの URL は、IoT Hub のポータルの *[概要]* タブで確認できます。

* 確立されたストリームの信頼性と順序の保証は、TCP の場合と同様です。

* IoT Hub とストリーミング エンドポイントへのすべての接続では TLS が使用され、これらの接続は暗号化されます。

### <a name="termination-flow"></a>終了フロー

ゲートウェイへの TCP 接続のいずれかが (サービスまたはデバイスによって) 切断されたときに、確立されたストリームが終了します。 これは、デバイスまたはサービスのプログラムで WebSocket を閉じることで自発的に、あるいはネットワーク接続がタイムアウトになったか、プロセスが失敗した場合に非自発的に行われる可能性があります。 ストリーミング エンドポイントへのデバイスまたはサービスの接続の終了時に、他の TCP 接続も (強制的に) 終了され、サービスとデバイスでは、必要に応じて、ストリームを再作成することになります。

## <a name="connectivity-requirements"></a>接続の要件

デバイス ストリームのデバイス側とサービス側の両方で、IoT Hub とそのストリーミング エンドポイントへの TLS 対応の接続を確立できる必要があります。 これには、これらのエンドポイントへのポート 443 経由でのアウトバウンド接続が必要です。 これらのエンドポイントに関連付けられているホスト名は、下の図のように、IoT Hub の *[概要]* タブで確認できます。

!["デバイス ストリーム エンドポイント"](./media/iot-hub-device-streams-overview/device-stream-in-portal.png)

または、`property.hostname` および `property.deviceStreams` キーなど、ハブのプロパティ セクションの下にある Azure CLI を使用して、エンドポイント情報を取得することができます。

```azurecli-interactive
az iot hub devicestream show --name <YourIoTHubName>
```

出力は、ハブのデバイスとサービスが、状況によってはデバイス ストリームを確立するために接続する必要があるすべてのエンドポイントの JSON オブジェクトです。

```json
{
  "streamingEndpoints": [
    "https://<YourIoTHubName>.<region-stamp>.streams.azure-devices.net"
  ]
}
```

> [!NOTE]
> Azure CLI バージョン 2.0.57 以降がインストールされていることを確認してください。 最新バージョンは、「[Azure CLI のインストール](https://docs.microsoft.com/cli/azure/install-azure-cli?view=azure-cli-latest)」ページからダウンロードできます。
>

## <a name="allow-outbound-connectivity-to-the-device-streaming-endpoints"></a>デバイス ストリーミング エンドポイントへの送信接続を許可する

この記事の先頭で説明したように、デバイスでは、デバイス ストリームの開始プロセス中に IoT Hub ストリーミング エンドポイントへのアウトバウンド接続が作成されます。 デバイスまたはそのネットワーク上のファイアウォールでは、ポート 443 経由のストリーミング ゲートウェイへのアウトバウンド接続 (TLS を使用して暗号化される WebSocket 接続によって通信が行われることに注意してください) を許可する必要があります。

デバイス ストリーミング エンドポイントのホスト名は、Azure IoT Hub ポータルの [概要] タブで確認できます。!["デバイス ストリーム エンドポイント"](./media/iot-hub-device-streams-overview/device-stream-in-portal.png)

または、Azure CLI を使用して、この情報を見つけることができます。

```azurecli-interactive
az iot hub devicestream show --name <YourIoTHubName>
```

> [!NOTE]
> Azure CLI バージョン 2.0.57 以降がインストールされていることを確認してください。 最新バージョンは、「[Azure CLI のインストール](https://docs.microsoft.com/cli/azure/install-azure-cli?view=azure-cli-latest)」ページからダウンロードできます。
>

## <a name="troubleshoot-via-device-streams-activity-logs"></a>デバイス ストリーム アクティビティ ログを使用してトラブルシューティングを行う

IoT ハブでデバイス ストリームのアクティビティ ログを収集するように、Azure Monitor ログを設定できます。 これは、トラブルシューティング シナリオで非常に役立つ場合があります。

IoT Hub のデバイス ストリーム アクティビティのために Azure Monitor ログを構成するには、以下の手順に従います。

1. IoT Hub の *[診断設定]* タブに移動し、 *[診断をオンにする]* リンクをクリックします。

   !["診断ログの有効化"](./media/iot-hub-device-streams-overview/device-streams-diagnostics-settings-pane.png)

2. 診断設定の名前を指定し、 *[Log Analytics への送信]* オプションを選びます。 既存の Log Analytics ワークスペース リソースを選ぶか、新しいものを作成するよう指示されます。 さらに、リストの *[DeviceStreams]* を確認します。

    !["デバイス ストリーム ログを有効にする"](./media/iot-hub-device-streams-overview/device-streams-configure-diagnostics.png)

3. これで、IoT Hub のポータルの *[ログ]* タブにあるデバイス ストリーム ログにアクセスできるようになりました。 デバイス ストリーム アクティビティ ログは、`AzureDiagnostics` テーブルに表示されます。ログには `Category=DeviceStreams` が含まれます。

   以下のように、ターゲット デバイスの ID と操作の結果もログで確認できます。

   !["デバイス ストリーム ログにアクセスする"](./media/iot-hub-device-streams-overview/device-streams-view-logs.png)

## <a name="regional-availability"></a>リージョン別の提供状況

パブリック プレビュー中は、米国中部、米国中部 EUAP、北ヨーロッパ、東南アジア リージョンで IoT Hub デバイス ストリームを利用できます。 これらのリージョンのいずれかでハブを作成するようにしてください。

## <a name="sdk-availability"></a>SDK の可用性

(デバイス側とサービス側の) 各ストリームの 2 つの側で IoT Hub SDK を使用して、トンネルを確立します。 パブリック プレビュー中は、お客様は次の SDK 言語から選ぶことができます。

* C および C# の SDK では、デバイス側のデバイス ストリームがサポートされます。

* NodeJS および C# の SDK では、サービス側のデバイス ストリームがサポートされます。

## <a name="iot-hub-device-stream-samples"></a>IoT Hub デバイス ストリームのサンプル

IoT Hub のページでは、2 つの[クイックスタート サンプル](/azure/iot-hub)を利用できます。 これらでは、アプリケーションでのデバイス ストリームの使用が示されています。

* "*エコー*" サンプルでは、(SDK API を直接呼び出すことによって) プログラムでデバイス ストリームを使用する方法を示しています。

* *ローカル プロキシ* サンプルでは、デバイス ストリームを使用して (SSH、RDP、Web などの) 既存のアプリケーションのトラフィックをトンネリングする方法を示しています。

これらのサンプルについて、以下で詳しく説明します。

### <a name="echo-sample"></a>エコー サンプル

エコー サンプルでは、サービス アプリケーションとデバイス アプリケーション間でバイトを送受信するために、プログラムでデバイス ストリームを使用する方法を示します。 さまざまな言語でサービスとデバイスのプログラムを使用できることに注意してください。 たとえば、C# のサービス プログラムで C のデバイス プログラムを使用できます。

echo サンプルを次に示します。

* [C# サービスとサービス プログラム](quickstart-device-streams-echo-csharp.md)

* [Node.js サービス プログラム](quickstart-device-streams-echo-nodejs.md)

* [C デバイス プログラム](quickstart-device-streams-echo-c.md)

### <a name="local-proxy-sample-for-ssh-or-rdp"></a>ローカル プロキシのサンプル (SSH または RDP の場合)

ローカル プロキシのサンプルでは、クライアントおよびサーバー プログラム間の通信を含む、既存のアプリケーションのトラフィックのトンネリングを有効にする方法を示します。 このセットアップは SSH や RDP などのクライアント/サーバー プロトコルで動作します。その場合、サービス側は (SSH または RDP クライアント プログラムを実行している) クライアントとして機能し、デバイス側は (SSH デーモンまたは RDP サーバー プログラムを実行している) サーバーとして機能します。

このセクションでは、ユーザーがデバイス ストリーム経由でデバイスに SSH 接続できるようにするための、デバイス ストリームの使用方法について説明します (RDP またはその他のクライアント/サーバー アプリケーションのケースは、プロトコルの対応するポートを使用する点で似ています)。

セットアップでは、下の図に示されている、2 つの*ローカル プロキシ* プログラム (つまり、*デバイス ローカル プロキシ*と*サービス ローカル プロキシ*) が利用されます。 ローカル プロキシ プログラムは、IoT Hub による[デバイス ストリームの開始ハンドシェイク](#device-stream-creation-flow)を実行し、通常のクライアント/サーバー ソケットを使用して SSH クライアントおよび SSH デーモンとやりとりします。

!["SSH/RDP のためのデバイス ストリーム プロキシ セットアップ"](./media/iot-hub-device-streams-overview/iot-hub-device-streams-ssh.png)

1. ユーザーはサービス ローカル プロキシを実行して、デバイスへのデバイス ストリームを開始します。

2. デバイス ローカル プロキシがストリームの開始要求を受け入れ、IoT Hub のストリーミング エンドポイントへのトンネルが確立されます (上の説明を参照)。

3. デバイス ローカル プロキシは、デバイス上のポート 22 をリッスンする SSH デーモン エンドポイントに接続されます。

4. サービス ローカル プロキシは、ユーザーからの新しい SSH 接続を待機している指定されたポートをリッスンします (このサンプルではポート 2222 を使用していますが、それ以外の利用可能なポートに構成することもできます)。 ユーザーは SSH クライアントを、localhost 上のサービス ローカル プロキシ ポートにポイントします。

### <a name="notes"></a>Notes

* 上記の手順では、SSH クライアント (右側) から SSH デーモン (左側) の間のエンド ツー エンド トンネルを完了します。 このエンド ツー エンド接続の一部として、デバイス ストリーム経由の IoT Hub への送信トラフィックが含まれます。

* 図の矢印は、エンドポイント間で確立される接続の方向を示しています。 具体的には、デバイスに向かうインバウンド接続はないことに注意してください (これは多くの場合、ファイアウォールでブロックされます)。

* サービス ローカル プロキシ上でポート 2222 を使用する選択は任意です。 他の利用可能なポートを使用するように、プロキシを構成できます。

* ポート 22 の選択はプロトコルに依存しており、この場合、SSH に固有のものです。 RDP の場合は、ポート 3389 を使用する必要があります。 これは、提供されているサンプル プログラムで構成できます。

以下のリンクを使用して、選択した言語でローカル プロキシ プログラムを実行する方法を確認してください。 [エコー サンプル](#echo-sample)と同様、デバイス ローカル プロキシ プログラムとサービス ローカル プロキシ プログラムは完全に相互運用可能であるため、さまざまな言語で実行できます。

* [C# サービスとサービス プログラム](quickstart-device-streams-proxy-csharp.md)

* [Node.js サービス プログラム](quickstart-device-streams-proxy-nodejs.md)

* [C デバイス プログラム](quickstart-device-streams-proxy-c.md)

## <a name="next-steps"></a>次のステップ

以下のリンクを使用して、デバイス ストリームについてさらに詳しく学習します。

> [!div class="nextstepaction"]
> [IoT でのデバイス ストリームのショー (Channel 9)](https://nam06.safelinks.protection.outlook.com/?url=https%3A%2F%2Fchannel9.msdn.com%2FShows%2FInternet-of-Things-Show%2FAzure-IoT-Hub-Device-Streams&data=02%7C01%7Crezas%40microsoft.com%7Cc3486254a89a43edea7c08d67a88bcea%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C636831125031268909&sdata=S6u9qiehBN4tmgII637uJeVubUll0IZ4p2ddtG5pDBc%3D&reserved=0)
