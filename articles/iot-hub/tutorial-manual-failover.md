---
title: Azure IoT ハブの手動フェールオーバー | Microsoft Docs
description: 別のリージョンへの IoT ハブの手動フェールオーバーを実行し、それが動作していることを確認してから、元のリージョンに戻して再確認する方法について説明します。
author: robinsh
manager: timlt
ms.service: iot-hub
services: iot-hub
ms.topic: tutorial
ms.date: 07/24/2019
ms.author: robinsh
ms.custom:
- mvc
- mqtt
ms.openlocfilehash: 69a0795b9c299b5113c39ce2c4556573f730e4b7
ms.sourcegitcommit: 419cf179f9597936378ed5098ef77437dbf16295
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/27/2020
ms.locfileid: "89013947"
---
# <a name="tutorial-perform-manual-failover-for-an-iot-hub"></a>チュートリアル:IoT ハブの手動フェールオーバーを実行する

手動フェールオーバーとは、お客様がハブの運用をプライマリ リージョンから Azure の geo でペアとなっているリージョンに[フェールオーバー](https://en.wikipedia.org/wiki/Failover)できるようにする、IoT Hub サービスの機能です。 手動フェールオーバーは、リージョンの障害が発生した場合や、サービスが長時間にわたって停止した場合に実行できます。 また、ディザスター リカバリーの機能をテストするために、計画的なフェールオーバーを実行することもできます (ただし、実稼働環境で実行している IoT ハブではなく、テスト用の IoT ハブを使用することをお勧めします)。 2017 年 5 月 18 日以降に作成された IoT ハブについては、追加コストなしで手動フェールオーバー機能をお使いいただけます。

このチュートリアルでは、以下のタスクを実行します。

> [!div class="checklist"]
> * Azure portal を使用して IoT ハブを作成する。 
> * フェールオーバーを実行する。 
> * ハブがセカンダリ ロケーションで実行されていることを確認する。
> * フェールバックを実行して、プライマリ ロケーションに IoT ハブの運用を戻す。 
> * ハブが正しい場所で正しく実行されていることを確認する。

IoT Hub での手動フェールオーバーと Microsoft によって開始されるフェールオーバーの詳細については、[リージョン間のディザスター リカバリー](iot-hub-ha-dr.md#cross-region-dr)に関する記事を参照してください。

## <a name="prerequisites"></a>前提条件

* Azure サブスクリプション。 Azure サブスクリプションをお持ちでない場合は、開始する前に [無料アカウント](https://azure.microsoft.com/free/?WT.mc_id=A261C142F) を作成してください。

* ポート 8883 がファイアウォールで開放されていることを確認してください。 このチュートリアルのデバイス サンプルでは、ポート 8883 を介して通信する MQTT プロトコルを使用しています。 このポートは、企業や教育用のネットワーク環境によってはブロックされている場合があります。 この問題の詳細と対処方法については、「[IoT Hub への接続 (MQTT)](iot-hub-mqtt-support.md#connecting-to-iot-hub)」を参照してください。

## <a name="create-an-iot-hub"></a>IoT Hub の作成

1. [Azure Portal](https://portal.azure.com) にログインします。 

2. **[+ Create a resource]\(+ リソースの作成\)** をクリックし、 **[モノのインターネット]** 、 **[IoT Hub]** の順に選択します。

   ![IoT Hub の作成を示すスクリーンショット](./media/tutorial-manual-failover/create-hub-01.png)

3. **[基本]** タブを選択します。次のフィールドに入力します。

    **[サブスクリプション]** : 使用する Azure サブスクリプションを選択します。

    **[リソース グループ]** : で、 **[新規作成]** をクリックし、リソース グループ名として **[ManlFailRG]** を指定します。

    **[リージョン]** : 近くのリージョンを選択します。 このチュートリアルでは `West US 2` を使用します。 フェールオーバーは Azure の geo ペア リージョン間でのみ実行できます。 米国西部 2 の geo ペア リージョンは WestCentralUS です。
    
   **[IoT Hub 名]** : Iot ハブの名前を指定します。 このハブ名はグローバルに一意である必要があります。 

   ![IoT ハブを作成するための [基本] ウィンドウを示すスクリーンショット](./media/tutorial-manual-failover/create-hub-02-basics.png)

   **[Review + create]\(レビュー + 作成\)** をクリックします。 (サイズとスケールには既定値を使用します。) 

4. 情報を確認し、 **[作成]** をクリックして IoT ハブを作成します。 

   ![IoT ハブを作成するための最後のステップを示すスクリーンショット](./media/tutorial-manual-failover/create-hub-03-create.png)

## <a name="perform-a-manual-failover"></a>手動フェールオーバーの実行

1 つの IoT ハブに対して、1 日あたり 2 回のフェールオーバーと 2 回のフェールバックまでに制限されていることに注意してください。

1. **[リソース グループ]** をクリックして、リソース グループ **[ManlFailRG]** を選択します。 リソースの一覧で、対象のハブをクリックします。 

1. IoT Hub ウィンドウの **[設定]** の下で、 **[フェールオーバー]** をクリックします。

   ![IoT Hub のプロパティ ウィンドウを示すスクリーンショット](./media/tutorial-manual-failover/trigger-failover-01.png)

1. [手動フェールオーバー] ウィンドウに、 **[現在の場所]** と **[Failover location]\(フェールオーバーの場所\)** が表示されます。 現在の場所は常に、ハブが現在アクティブになっている場所を示します。 フェールオーバーの場所は、現在の場所とペアになっている標準の [Azure geo ペア リージョン](../best-practices-availability-paired-regions.md)です。 ロケーションの値は変更できません。 このチュートリアルでは、現在の場所は `West US 2` で、フェールオーバーの場所は `West Central US` です。

   ![[手動フェールオーバー] ウィンドウを示すスクリーンショット](./media/tutorial-manual-failover/trigger-failover-02.png)

1. [手動フェールオーバー] ウィンドウの上部で、 **[フェールオーバーの開始]** をクリックします。 

1. 確認ウィンドウで IoT ハブの名前を入力して、フェールオーバーを実行する IoT ハブであることを確認します。 その後、 **[フェールオーバー]** をクリックしてフェールオーバーを開始します。

   手動フェールオーバーの実行にかかる時間は、ハブに登録されているデバイスの数に比例します。 たとえば、デバイスが 10 万台の場合は 15 分ですが、500 万台の場合は 1 時間以上かかる可能性があります。

   ![手動フェールオーバーの確認ペインを示すスクリーンショット](./media/tutorial-manual-failover/trigger-failover-03-confirm.png)

   手動フェールオーバー プロセスの実行中は、手動フェールオーバーが進行中であることを示すバナーが表示されます。 

   ![手動フェールオーバーが進行中であることを示すスクリーンショット](./media/tutorial-manual-failover/trigger-failover-04-in-progress.png)

   [IoT Hub] ウィンドウを閉じた後に、[リソース グループ] ウィンドウでクリックして再び開くと、ハブが手動フェールオーバーの実行中であることを示すバナーが表示されます。 

   ![IoT Hub フェールオーバーが進行中であることを示すスクリーンショット](./media/tutorial-manual-failover/trigger-failover-05-hub-inactive.png)

   完了すると、[手動フェールオーバー] ページ上の現在のリージョンとフェールオーバーのリージョンが逆になり、ハブが再度アクティブになります。 この例では、現在の場所が `WestCentralUS` に、フェールオーバーの場所が `West US 2` になります。 

   ![フェールオーバーが完了したことを示すスクリーンショット](./media/tutorial-manual-failover/trigger-failover-06-finished.png)

   また、概要ページには、フェールオーバーが完了し、IoT Hub が `West Central US` で実行されていることを示すバナーも表示されます。

   ![フェールオーバーが完了したことを示す概要ページのスクリーンショット](./media/tutorial-manual-failover/trigger-failover-06-finished-overview.png)


## <a name="perform-a-failback"></a>フェールバックの実行 

手動フェールオーバーを実行した後で、ハブのうン用を元のプライマリ リージョンに切り替えることができます。これをフェールバックと呼びます。 フェールオーバーを実行した直後の場合は、約 1 時間待ってからフェールバックを要求する必要があります。 それより前にフェールバックを実行しようとすると、エラー メッセージが表示されます。

フェールバックは、手動フェールオーバーと同じように実行されます。 手順は次のとおりです。 

1. フェールバックを実行するには、IoT ハブの [Iot Hub] ウィンドウに戻ります。

2. IoT Hub ウィンドウの **[設定]** の下で、 **[フェールオーバー]** をクリックします。 

3. [手動フェールオーバー] ウィンドウの上部で、 **[フェールオーバーの開始]** をクリックします。 

4. 確認ウィンドウで IoT ハブの名前を入力して、フェールバックを実行する IoT ハブであることを確認します。 その後、[OK] をクリックしてフェールバックを開始します。 

   ![手動フェールバックの要求のスクリーン ショット](./media/tutorial-manual-failover/trigger-failover-03-confirm.png)

   フェールオーバーの実行に関するセクションで説明したように、バナーが表示されます。 フェールバックが完了すると、最初に設定されたように、再度 `West US 2` が現在の場所、`West Central US` がフェールオーバーの場所として表示されます。

## <a name="clean-up-resources"></a>リソースをクリーンアップする 

このチュートリアル用に作成したリソースを削除するには、リソース グループを削除します。 これにより、そのグループ内に含まれているすべてのリソースも削除されます。 この場合は、IoT ハブとリソース グループ自体が削除されます。 

1. **[リソース グループ]** をクリックします。 

2. **ManlFailRG** リソース グループを見つけて選択します。 そのストレージ アカウントをクリックして開きます。 

3. **[リソース グループの削除]** をクリックします。 プロンプトが表示されたら、確認のためにリソース グループの名前を入力し、 **[削除]** をクリックします。 

## <a name="next-steps"></a>次のステップ

このチュートリアルでは、以下のタスクを実行して、手動フェールオーバーの構成とフェールバックの要求を行う方法について学習しました。

> [!div class="checklist"]
> * Azure portal を使用して IoT ハブを作成する。 
> * フェールオーバーを実行する。 
> * ハブがセカンダリ ロケーションで実行されていることを確認する。
> * フェールバックを実行して、プライマリ ロケーションに IoT ハブの運用を戻す。 
> * ハブが正しい場所で正しく実行されていることを確認する。

次のチュートリアルに進み、IoT デバイスの状態を管理する方法を学習してください。 

> [!div class="nextstepaction"]
> [IoT デバイスの状態を管理する](tutorial-device-twins.md)
