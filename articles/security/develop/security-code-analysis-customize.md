---
title: Microsoft Azure Security Code Analysis タスク カスタマイズ ガイド
description: この記事では、Security Code Analysis 拡張機能におけるタスクのカスタマイズについて取り上げます
author: vharindra
manager: sukhans
ms.author: terrylan
ms.date: 07/31/2019
ms.topic: article
ms.service: security
services: azure
ms.assetid: 521180dc-2cc9-43f1-ae87-2701de7ca6b8
ms.devlang: na
ms.tgt_pltfrm: na
ms.workload: na
ms.openlocfilehash: ab219b71eb8cd6f6172b7d02a639301c67811b49
ms.sourcegitcommit: a52f17307cc36640426dac20b92136a163c799d0
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/01/2019
ms.locfileid: "68718190"
---
# <a name="how-to-configure--customize-the-build-tasks"></a>方法:ビルド タスクの構成とカスタマイズ

このページでは、各ビルド タスクで利用できる構成オプションについて詳しく取り上げます。まず、セキュリティ コード分析ツールのタスクについて説明し、続けて後処理タスクについて説明します。

## <a name="anti-malware-scanner-task"></a>マルウェア対策スキャナー タスク

> [!NOTE]
> マルウェア対策ビルド タスクには、Windows Defender が有効になったビルド エージェントが必要です。Windows Defender は、"Hosted VS2017" 以降のビルド エージェントで有効になります (従来または VS2015 の "Hosted" エージェントでは動作しません)。これらのエージェントでシグネチャを更新することはできませんが、シグネチャは必ず、比較的新しいもの (3 時間以上経過していないもの) である必要があります。

以下、構成に関するスクリーンショットと詳細を示します。

![マルウェア対策スキャナー ビルド タスクをカスタマイズする](./media/security-tools/5-add-anti-malware-task600.png) 

- [タイプ] の設定 = **[基本]**
- [タイプ] を **[カスタム]** にすると、コマンド ライン引数を指定してスキャンをカスタマイズできます。

Windows Defender は、Windows Update クライアントを使用してシグネチャをダウンロードし、インストールします。 ビルド エージェントでシグネチャの更新に失敗した場合、Windows Update から HRESULT エラー コードが返される可能性があります。 Windows Update のエラーと軽減策の詳細については、[こちらのページ](https://docs.microsoft.com/windows/deployment/update/windows-update-error-reference)と、この [TechNet ページ](https://social.technet.microsoft.com/wiki/contents/articles/15260.windows-update-agent-error-codes.aspx)を参照してください。

## <a name="binskim-task"></a>BinSkim タスク

> [!NOTE]
> BinSkim タスクを実行するための前提条件として、対象のビルドは、次のいずれかの条件を満たす必要があります。
>    - ビルドによってマネージド コードからバイナリ成果物が生成される。
>    - BinSkim で分析するバイナリ成果物がコミット済みである。

以下、構成に関するスクリーンショットと詳細を示します。 

![BinSkim の設定](./media/security-tools/7-binskim-task-details.png)  
1. * **.pdb** デバッグ ファイルを生成するために、ビルド構成を [デバッグ] に設定します。 これらは、出力されたバイナリに見つかった問題を元のソース コードにマップする目的で BinSkim によって使用されます。 
2. 独自のコマンド ラインを調査、作成しないようにするために、[タイプ] に **[基本]** を選択し、[機能] に **[分析]** を選択します。 
3. **[ターゲット]** には、分析対象として、特定のファイルまたはディレクトリの指定子を入力するか、1 つ以上のバイナリに解決されるフィルター パターンの指定子を入力します。指定子は複数入力することもできます。 
    - 複数のターゲットは、**セミコロン (;)** で区切って入力する必要があります。 
    - 単一のファイルを入力できるほか、ワイルドカードを使用することもできます。
    - ディレクトリは、末尾を \* にする必要があります。
    - 次に例を示します。

           *.dll;*.exe
           $(BUILD_STAGINGDIRECTORY)\*
           $(BUILD_STAGINGDIRECTORY)\*.dll;$(BUILD_STAGINGDIRECTORY)\*.exe;
4. [タイプ] に **[コマンド ライン]** を選択した場合: 
     - **BinSkim.exe** の第 1 引数が **analyze** という動詞で、完全なパスまたはソース ディレクトリを基準とした相対パスが使用されていることを確認します。
     - **コマンド ライン**入力の場合、複数のターゲットをスペースで区切る必要があります。
     - ファイル パラメーター **/o** または **/output** は省略できます。省略した場合は、自動的に追加されるか、置き換えられます。 
     - **標準的なコマンド ラインの構成** 

           analyze $(Build.StagingDirectory)\* --recurse --verbose
           analyze *.dll *.exe --recurse --verbose
          > [!NOTE]
          > ディレクトリをターゲットに指定するときは、後続の \* がきわめて重要となります。 

BinSkim のコマンド ライン引数、ID ごとのルール、終了コードについて詳しくは、[BinSkim ユーザー ガイド](https://github.com/Microsoft/binskim/blob/master/docs/UserGuide.md)を参照してください。

## <a name="credential-scanner-task"></a>資格情報スキャナー タスク
以下、構成に関するスクリーンショットと詳細を示します。
 
![資格情報スキャナーのカスタマイズ](./media/security-tools/3-taskdetails.png)

利用可能なオプションは、次のとおりです。 
  - **[出力形式]** – TSV、CSV、SARIF、PREfast
  - **[ツールのバージョン]** (推奨: [最新])
  - **[Scan Folder]\(スキャン フォルダー\)** - スキャンするリポジトリ内のフォルダー
  - **[Searchers File Type]\(検索ツールのファイルの種類\)** - スキャンに使用する検索ツールのファイルを特定するためのオプション。
  - **[Suppressions File]\(抑制ファイル\)** - 出力ログにおける問題の抑制には [JSON](https://json.org/) ファイルを使用できます (詳細については「リソース」セクションを参照してください)。 
  - **[詳細出力]** - 文字どおりの機能です。 
  - **[バッチ サイズ]** - 資格情報スキャナーの並列実行に使用するコンカレント スレッドの数。 既定値は 20 です。1 から 2,147,483,647 の範囲の値を指定する必要があります。
  - **[Match Timeout]\(照合タイムアウト\)** - 検索ツールが照合に費やす時間。この時間を超えると、チェックが中止されます。 
  - **[File Scan Read Buffer Size]\(ファイル スキャン読み取りバッファー サイズ\)** - コンテンツの読み取り中のバッファー サイズ (バイト単位)。 既定値は 524288 です。 
  - **[Maximum File Scan Read Bytes]\(ファイル スキャンの最大読み取りバイト数\)** - コンテンツの分析中に特定のファイルから読み取る最大バイト数。 既定値は 104,857,600 です。 
  - **[このタスクを実行]** ( **[管理オプション]** の下) - このタスクをいつ実行するかを指定します。 さらに複雑な条件を指定するには、[カスタム条件] を選択してください。 
  - **[バージョン]** - Azure DevOps 内のビルド タスクのバージョン。 使用頻度は低めです。 

## <a name="microsoft-security-risk-detection-task"></a>Microsoft Security Risk Detection タスク
> [!NOTE]
> このタスクを使用するための前提条件として、Risk Detection サービスにアカウントを作成して構成する必要があります。 このサービスには、別途オンボーディング プロセスが必要となります。この拡張機能に備わっている他の多くのタスクとは違って "プラグ アンド プレイ" ではありません。 その手順については、[Microsoft Security Risk Detection](https://aka.ms/msrddocs) に関するページと [Microsoft Security Risk Detection の使い方](https://docs.microsoft.com/security-risk-detection/how-to/)に関するページを参照してください。

以下、構成について詳しく説明します。

必要なデータを入力してください。各オプションにはホバー テキスト ヘルプが用意されています。
   - **[Azure DevOps Service Endpoint Name for MSRD]\(MSRD 用 Azure DevOps サービス エンドポイント名\)** : (自分がオンボードした) MSRD インスタンスの URL と REST API のアクセス トークンの保存先として汎用タイプの Azure DevOps サービス エンドポイントを作成した場合は、そのサービス エンドポイントを選択できます。 それ以外の場合は、[管理] リンクをクリックして、この MSRD タスクに使用する新しいサービス エンドポイントを作成および構成します。 
   - **[アカウント ID]** : MSRD アカウントの URL から取得できる GUID です。
   - **[URLs to Binaries]\(バイナリの URL\)** : パブリックに使用可能な URL をセミコロンで区切ったリスト (ファジー テスト マシンがバイナリをダウンロードする際に使用)。
   - **[URLs of the Seed Files]\(シード ファイルの URL\)** : パブリックに使用可能な URL をセミコロンで区切ったリスト (ファジー テスト マシンがシードをダウンロードする際に使用)。 シード ファイルがバイナリと一緒にダウンロードされる場合、このフィールドは省略可能です。
   - **[OS Platform Type]\(OS プラットフォーム タイプ\)** : ファジー テスト ジョブが実行されるマシンの OS プラットフォーム タイプ (Windows または Linux)。
   - **[Windows Edition / Linux Edition]\(Windows エディション/Linux エディション\)** : ファジー テスト ジョブが実行されるマシンの OS エディション。 マシンの OS エディションが既定値と異なる場合は、既定値を上書きできます。
   - **[Package Installation Script]\(パッケージ インストール スクリプト\)** : ファジー テスト ジョブの送信前にテスト対象プログラムとその依存関係をインストールするためにテスト マシン上で実行するスクリプトを指定します。
   - **[Job Submission Parameters]\(ジョブ送信パラメーター\)** :
       - **[Seed Directory]\(シード ディレクトリ\)** : シードが格納されるファジー テスト マシン上のディレクトリのパス。
       - **[Seed Extension]\(シード拡張子\)** : シードのファイル拡張子。
       - **[Test Driver Executable]\(テスト ドライバー実行可能ファイル\)** : ファジー テスト マシン上のターゲット実行可能ファイルのパス。
       - **[Test Driver Executable Architecture]\(テスト ドライバー実行可能ファイル アーキテクチャ\)** : ターゲット実行可能ファイルのアーキテクチャ (x86 または amd64)。
       - **[Test Driver Arguments]\(テスト ドライバー引数\)** : テスト対象の実行可能ファイルに渡されるコマンド ライン引数。 "%testfile%" という記号 (二重引用符を含む) は、テスト ドライバーで解析することになるターゲット ファイルの完全なパスに自動的に置き換えられることに注意してください (必須)。
       - **[Test Driver Process Exits Upon Test Completion]\(テストの完了時にテスト ドライバー プロセスを終了する\)** : テスト ドライバーを完了時に終了する場合は、チェック ボックスをオンにします。テスト ドライバーを強制的に閉じる必要がある場合は、チェック ボックスをオフにします。
       - **[Maximum Duration (in seconds)]\(最大継続期間 (秒)\)** : ターゲット プログラムが入力ファイルを解析するのに必要であると考えられる最大推定時間を指定します。 この推定の精度が高いほど、ファジー テストの実行効率が上がります。
       - **[Test Driver Can Be Run Repeatedly]\(テスト ドライバーは繰り返し実行可能\)** : 永続化 (または共有) されたグローバルな状態に依存することなくテスト ドライバーを繰り返し実行できる場合は、チェック ボックスをオンにします。
       - **[Test Driver Can Be Renamed]\(テスト ドライバーは名前の変更が可能\)** : テスト ドライバー実行可能ファイルがその名前を変更しても正しく動作する場合は、チェック ボックスをオンにします。
       - **[The Fuzzing Application Runs as a Single OS Process]\(ファジー テスト アプリケーションが単一の OS プロセスとして動作する\)** : テスト ドライバーが単一の OS プロセスで動作する場合はチェック ボックスをオンにします。テスト ドライバーによって追加のプロセスが生成される場合は、チェック ボックスをオフにします。


## <a name="roslyn-analyzers-task"></a>Roslyn アナライザー タスク
> [!NOTE]
> Roslyn アナライザー タスクを実行するための前提条件として、対象のビルドは次の条件を満たす必要があります。
>  - C# (または VB) コードをコンパイルするビルトインの MSBuild または VSBuild ビルド タスクがビルド定義に含まれる。 このタスクは、Roslyn アナライザーが有効な状態で MSBuild コンパイルを再実行するために、特定のビルド タスクの入力と出力に依存します。
>  - このビルド タスクを実行するビルド エージェントに Visual Studio 2017 v15.5 以降がインストールされている (コンパイラ バージョン 2.6.x)。
>

以下、構成について詳しく説明します。

利用可能なオプションは、次のとおりです。 
- **[Ruleset]\(ルールセット\)** - [SDL Required]\(SDL 必須\)、[SDL Recommended]\(SDL 推奨\)、または自分独自のカスタム ルールセットを使用できます。
- **[Analyzers Version]\(アナライザーのバージョン\)** (推奨: [最新])
- **[Compiler Warnings Suppressions File]\(コンパイラ警告抑制ファイル\)** - 抑制すべき警告 ID がリストされたテキスト ファイル。 
- **[このタスクを実行]** ( **[管理オプション]** の下) - このタスクをいつ実行するかを指定します。 さらに複雑な条件を指定するには、 **[カスタム条件]** を選択してください。 

> [!NOTE]
> - Roslyn アナライザーはコンパイラに統合されており、CSC.exe コンパイルの一部としてのみ実行できます。 したがって、このタスクでは、既にビルドで実行されたコンパイラ コマンドを再生 (再実行) することが必要となります。 これは、VSTS に MSBuild ビルド タスクのログを照会することによって行われます (このタスクで MSBuild のコンパイル コマンド ラインをビルド定義から確実に取得する方法は他にありません。ユーザーが独自にコマンド ラインを入力できるフリーフォームのテキストボックスを追加することも検討しましたが、それらを最新の状態に保つこと、またメイン ビルドと同期させることは困難と考えられます)。 カスタム ビルドでは、コンパイラのコマンドに限らず、コマンド一式をすべて再生する必要がありますが、こうしたケースで Roslyn アナライザーを有効にすることは簡単ではなく、信頼性も高くありません。 
> - Roslyn アナライザーはコンパイラに統合されているため、コンパイルの呼び出しが必要となります。 このビルド タスクは、MSBuild または VSBuild のビルド タスクのみを使用して既にビルドされた C# プロジェクトを、同じビルド (ビルド定義) で、なおかつ、このケースではアナライザーを有効にして再コンパイルすることによって実装されます。 このビルド タスクが元のビルド タスクと同じエージェント上で実行された場合、"s" ソース フォルダーにある元の MSBuild または VSBuild ビルド タスクの出力は、このビルド タスクの出力で上書きされます。 ビルド出力は同じものになりますが、MSBuild を実行し、成果物のステージング ディレクトリに出力をコピーしてから、Roslyn を実行することをお勧めします。
>

Roslyn アナライザー タスクに関するその他のリソースについては、[Microsoft Docs の Roslyn アナライザー](https://docs.microsoft.com/dotnet/standard/analyzers/)に関するページを参照してください。

このビルド タスクでインストールおよび使用されるアナライザー パッケージは、[こちら](https://www.nuget.org/packages/Microsoft.CodeAnalysis.FxCopAnalyzers)にあります。 

## <a name="tslint-task"></a>TSLint タスク

TSLint の詳細については、[TSLint GitHub リポジトリ](https://github.com/palantir/tslint)を参照してください。
>[!NOTE] 
>ご存じの方もいらっしゃるかもしれませんが、TSLint は 2019 年内に非推奨化されます (出典: [TSLint GitHub リポジトリ](https://github.com/palantir/tslint))。その代替手段として同チームは現在、[ESLint](https://github.com/eslint/eslint) の調査を進めており、ロードマップには、ESLint 用の新しいタスクの作成が含まれています。

## <a name="publish-security-analysis-logs-task"></a>セキュリティ分析ログの発行タスク
以下、構成に関するスクリーンショットと詳細を示します。

![セキュリティ分析の発行をカスタマイズする](./media/security-tools/9-publish-security-analsis-logs600.png)  

- **[成果物名]** - 任意の文字列識別子を指定できます。
- **[成果物の種類]** - ビルド エージェントからアクセスできるファイル共有または Azure-DevOps サーバーにログを発行できます。 
- **[ツール]** - 個々の (特定の) ツールのログを保持できるほか、 **[All Tools]\(すべてのツール\)** を選択すれば、すべてのログを保持できます。 

## <a name="security-report-task"></a>セキュリティ レポート タスク
以下、構成に関するスクリーンショットと詳細を示します。  
![分析後タスクを設定する](./media/security-tools/4-createsecurityanalysisreport600.png) 
- **[レポート]** - 作成するレポート ファイルを選択します。レポート ファイルは、**Console**、**TSV**、**HTML** の各形式で作成されます。 
- **[ツール]** - 検出された問題のサマリーを希望するビルド定義内のツールを選択します。 選択した各ツールには、レポートにエラーのみを表示するか、エラーと警告の両方を表示するかを選択するためのオプションが存在する場合もあります。 
- **[詳細オプション]** - 選択したいずれかのツールのログが存在しない場合に、警告またはエラーをログする (さらに、タスクを失敗させる) ことができます。
ログの格納先となるベース ログ フォルダーはカスタマイズできますが、あまり一般的なシナリオではありません。 

## <a name="post-analysis-task"></a>分析後タスク
以下、構成に関するスクリーンショットと詳細を示します。

![分析後タスクをカスタマイズする](./media/security-tools/a-post-analysis600.png) 
- **[ツール]** - 調査結果に基づいてビルドの中断を挿入するビルド定義内のツールを選択します。 選択した各ツールには、エラーでのみ中断するか、エラーと警告の両方を表示するかを選択するためのオプションが存在する場合もあります。 
- **[レポート]** - 検出されてビルドの中断を引き起こす結果を、Azure DevOps のコンソール ウィンドウおよびログ ファイルに必要に応じて書き込むことができます。 
- **[詳細オプション]** - 選択したいずれかのツールのログが存在しない場合に、警告またはエラーをログする (さらに、タスクを失敗させる) ことができます。

## <a name="next-steps"></a>次の手順

この拡張機能と提供されるツールについてご不明な点がある場合は、[FAQ ページを参照](security-code-analysis-faq.md)してください。


