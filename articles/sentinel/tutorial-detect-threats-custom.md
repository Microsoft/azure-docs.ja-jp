---
title: 脅威を検出するためのカスタム分析ルールを Azure Sentinel を使用して作成する | Microsoft Docs
description: このチュートリアルでは、セキュリティ上の脅威を検出するカスタム分析ルールを、Azure Sentinel を使用して作成する方法について説明します。
services: sentinel
documentationcenter: na
author: yelevin
manager: rkarlin
editor: ''
ms.service: azure-sentinel
ms.subservice: azure-sentinel
ms.devlang: na
ms.topic: conceptual
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 07/06/2020
ms.author: yelevin
ms.openlocfilehash: 0e5989490603e22745a8bc972b16ed016c894893
ms.sourcegitcommit: d661149f8db075800242bef070ea30f82448981e
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/19/2020
ms.locfileid: "88605900"
---
# <a name="tutorial-create-custom-analytics-rules-to-detect-threats"></a>チュートリアル:脅威を検出するためのカスタム分析規則を作成する

Azure Sentinel に[データ ソースを接続](quickstart-onboard.md) したら、環境全体にわたって特定の条件を検索し、条件が一致したときにインシデントを生成するカスタム ルールを作成できます。そのようにすることで、インシデントについて調査できるようになります。 このチュートリアルは、Azure Sentinel で脅威を検出するカスタム ルールを作成するために役立ちます。

このチュートリアルは、Azure Sentinel で脅威を検出するためのものです。
> [!div class="checklist"]
> * 分析ルールを作成する
> * 脅威への対応を自動化する

## <a name="create-custom-analytics-rules"></a>カスタム分析ルールを作成する

カスタム分析ルールを作成すると、環境内で疑わしい種類の脅威や異常を探すのに役立てることができます。 このルールによって直ちに通知されるので、脅威のトリアージ、調査、および修復を行うことができます。

1. Azure portal の Azure Sentinel の下で **[Analytics]** を選択します。

1. 上部のメニュー バーで、 **[+ 作成]** を選択し、 **[スケジュール済みクエリ ルール]** を選択します。 **分析ルール ウィザード**が開きます。

    :::image type="content" source="media/tutorial-detect-threats-custom/create-scheduled-query.png" alt-text="スケジュール済みクエリを作成する":::

1. **[全般]** タブで、一意の **[名前]** と **[説明]** を指定します。 **[方針]** フィールドでは、ルールを分類する攻撃のカテゴリを選択できます。 必要に応じて、アラートの **[重大度]** を設定します。 ルールを作成すると、その **[状態]** は既定で **[有効]** になります。これは、作成が終わるとすぐに実行されることを意味します。 すぐに実行したくない場合は、 **[無効]** を選択します。ルールは **[アクティブな規則]** タブに追加され、必要に応じてそこから有効にすることができます。

    ![カスタム分析ルールの作成を開始する](media/tutorial-detect-threats-custom/general-tab.png)

1. **[ルールのロジックを設定]** タブでは、 **[ルールのクエリ]** フィールドにクエリを直接入力するか、または Log Analytics でクエリを作成し、コピーしてフィールドに貼り付けることができます。
 
   ![Azure Sentinel でクエリを作成する](media/tutorial-detect-threats-custom/settings-tab.png)

   - 右側にある **[結果のプレビュー]** 領域には、クエリによって生成される結果 (ログ イベント) の数を示され、クエリの記述と構成に合わせてリアルタイムに変更されます。 グラフには、定義された期間における結果の数が表示されます。これは、 **[クエリのスケジュール設定]** セクションの設定によって決まります。
    - クエリによってトリガーされるアラートが多すぎたり、頻繁すぎたりする場合は、 **[アラートのしきい値]** セクションでベースラインを設定できます。

      異常な数のリソースが Azure アクティビティで作成されたときにアラートを発するサンプル クエリを次に示します。

      `AzureActivity
     \| where OperationName == "Create or Update Virtual Machine" or OperationName =="Create Deployment"
     \| where ActivityStatus == "Succeeded"
     \| make-series dcount(ResourceId)  default=0 on EventSubmissionTimestamp in range(ago(7d), now(), 1d) by Caller`

      > [!NOTE]
      > クエリの長さは 1 から 10,000 文字にする必要があります。また、"search \*" または "union \*" を含めることはできません。

    1. クエリ結果のパラメーターを Azure Sentinel で認識されるエンティティにリンクするには、 **[エンティティのマップ]** セクションを使用します。 これらのエンティティにより、 **[Incident settings]\(インシデントの設定\)** タブでのインシデントへのアラートのグループ化など、詳細な分析のための基礎が形成されます。
  
    1. **[クエリのスケジュール設定]** セクションで、次のパラメーターを設定します。

       1. **[クエリの実行間隔]** の設定では、クエリが実行される頻度 (頻繁な 5 分間隔、または 1 日に 1 回程度の低い頻度) を制御します。

       1. **[次の時間分の過去のデータを参照します]** の設定では、クエリの対象となるデータの期間を決定します。たとえば、過去 10 分間や過去 6 時間のデータのクエリを実行できます。

       > [!NOTE]
       > これら 2 つの設定は、ある程度まで互いに独立しています。 間隔より長い期間をカバーする短い間隔でクエリを実行できますが (重複するクエリがある場合)、カバレッジ期間を超える間隔でクエリを実行することはできません。そうしないと、クエリ カバレッジ全体にギャップが生じることになります。

    1. ベースラインを定義するには、 **[アラートのしきい値]** セクションを使用します。 たとえば、クエリが実行されるたびに 1,000 件を超える結果が返される場合にのみアラートを生成するルールが必要な場合は、 **[クエリ結果件数でアラートを生成する]** を **[次の値より大きい]** に設定し、数値の 1,000 を入力します。 これは必須フィールドなので、ベースラインを設定しない場合、つまりアラートですべてのイベントを登録する場合は、数値のフィールドに「0」を入力します。
    
    1. **[イベントのグループ化]** で、**イベント**の**アラート**へのグループ化を処理する 2 つの方法のうち、いずれかを選択します。 

       - **[すべてのイベントを単一のアラートにグループ化する]** (既定の設定)。 このルールでは、クエリで前記の**アラートのしきい値**よりも多くの結果が返される限り、実行されるたびに 1 つのアラートが生成されます。 このアラートには、結果で返されたすべてのイベントの概要が含まれています。 

       - **[各イベントに対するアラートをトリガーする]** 。 このルールでは、クエリによって返されるイベントごとに独自のアラートが生成されます。 これは、イベントを個々に表示する場合や、ユーザーやホスト名など、特定のパラメーター別にイベントをグループ化する場合に便利です。 これらのパラメーターはクエリ内で定義できます。
    
       現在のところ、1 つのルールで生成できるアラートの数は 20 に制限されています。 特定のルールで、 **[イベントのグループ化]** が **[各イベントに対するアラートをトリガーする]** に設定されていて、ルールのクエリから 20 を超えるイベントが返された場合、最初の 19 件のイベントについてはそれぞれに独自のアラートが生成され、20 番目のアラートでは、返された一連のイベント全体がまとめられます。 言い換えると、20 番目のアラートは、 **[すべてのイベントを単一のアラートにグループ化する]** オプションによって生成されたであろうアラートです。

       > [!NOTE]
       > **イベント**と**アラート**の違いは何でしょうか。
       >
       > - **イベント**は、1 回の出現を表します。 たとえば、ログ ファイル内の 1 つのエントリは、1 つのイベントとしてカウントされる可能性があります。 このコンテキストでは、1 つのイベントは、分析ルールのクエリによって返された単一の結果を指します。
       >
       > - **アラート**は、一緒にまとめられるイベントのコレクションで、セキュリティの観点からは重要なものです。 イベントにセキュリティ上の重要な意味がある場合は、1 つのアラートに 1 つのイベントが含まれる場合があります。たとえば、勤務時間外に外国からの管理ログインがあったなどです。
       >
       > - では、**インシデント**とは何でしょうか。 Azure Sentinel の内部ロジックでは、**アラート**またはアラートのグループから**インシデント**が作成されます。 インシデント キューは、トリアージ、調査、修復といったアナリストの作業の中心です。
       > 
       > Azure Sentinel は、いくつかのデータ ソースから未加工のイベントを取り込み、他のデータ ソースから処理済みのアラートを取り込みます。 ある時点で、どちらを扱っているかに注目することが重要です。

       > [!IMPORTANT]
       > イベントのグループ化は、現在、パブリック プレビューの段階にあります。 この機能は、サービス レベル アグリーメントなしで提供されており、運用環境のワークロード用には推奨されていません。 詳しくは、[Microsoft Azure プレビューの追加使用条件](https://azure.microsoft.com/support/legal/preview-supplemental-terms/)に関するページをご覧ください。
    
    1. アラートが生成された後、クエリ間隔を超える期間だけこのルールの操作を中断する場合は、 **[抑制]** セクションで、 **[アラートの生成後にクエリの実行を停止する]** の設定を **[オン]** にすることができます。 これをオンにする場合は、 **[クエリの実行を停止する]** をクエリの実行を停止する時間 (最大 24 時間) に設定する必要があります。

1. **[Incident Settings]\(インシデントの設定\)** タブでは、アラートをアクションにつながるインシデントに変換するかどうか、およびその方法を選択できます。 このタブを設定しないと、すべてのアラートに対して個別に 1 つのインシデントが作成されます。 このタブの設定を変更することで、インシデントを作成しないようにしたり、複数のアラートを 1 つのインシデントにグループ化したりすることができます。

   > [!IMPORTANT]
   > インシデントの設定のタブは、現在、パブリック プレビューの段階にあります。 この機能は、サービス レベル アグリーメントなしで提供されており、運用環境のワークロード用には推奨されていません。 詳しくは、[Microsoft Azure プレビューの追加使用条件](https://azure.microsoft.com/support/legal/preview-supplemental-terms/)に関するページをご覧ください。
    
    1. **[Incident Settings]\(インシデントの設定\)** セクションでは、 **[この分析ルールによってトリガーされるアラートからインシデントを作成する]** が既定で **[有効]** に設定されています。つまり、ルールによってトリガーされるすべての個々のアラートから、1 つの個別のインシデントが作成されます。
       - このルールによってインシデントが作成されないようにする場合は (たとえば、このルールが後続の分析のために情報を収集するだけの場合)、これを **[無効]** に設定します。

    1. 最大 150 件の類似したアラートまたは繰り返し発生するアラートのグループから単一のインシデントを生成する場合 (注を参照) は、 **[アラートのグループ化]** セクションで、 **[この分析ルールによってトリガーされる関連アラートをインシデントにグループ化する]** を **[有効]** に設定し、以下のパラメーターを設定します。

    - **[選択した期間内に作成されたアラートのみにグループを制限する]** :似たアラートまたは繰り返し発生するアラートをグループ化する期間を決定します。 この期間内の対応するすべてのアラートでは、1 つのインシデントまたはインシデントのセットがまとめて生成されます (以下のグループ化の設定に依存します)。 この期間外のアラートでは、個別のインシデントまたはインシデントのセットが生成されます。

    - **[この分析ルールによってトリガーされるアラートを次の方法で単一のインシデントにグループ化する]** :アラートをグループ化する基準を選択します。

        - **[すべてのエンティティが一致した場合にアラートを 1 つのインシデントにグループ化する]** :マップされている各エンティティ (上の [ルールのロジックを設定] タブで定義したもの) の値が同じ場合、アラートはグループ化されます。 これは推奨される設定です。

        - **[このルールによってトリガーされるすべてのアラートを 1 つのインシデントにグループ化する]** :値が同じではない場合でも、このルールによって生成されるすべてのアラートをグループ化します。

        - **[選択したエンティティが一致する場合にアラートを 1 つのインシデントにグループ化する]** :マップされたエンティティの一部 (ドロップダウン リストから選択可能) の値が同じ場合、アラートをグループ化します。 たとえば、ソースまたはターゲットの IP アドレスに基づいて個別のインシデントを作成する場合に、この設定を使用できます。

    - **[Re-open closed matching incidents]\(クローズされた一致するインシデントを再度開く\)** :あるインシデントが解決されて閉じられたとします。後でそのインシデントに属するはずの別のアラートが生成されたときに、閉じられたインシデントを再び開きたい場合は、この設定を **[有効]** に設定します。別のアラートで新しいインシデントを作成する場合は **[無効]** のままにします。
    
        > [!NOTE]
        > 最大 150 件のアラートを 1 つのインシデントにグループ化できます。 アラートを 1 つのインシデントにグループ化するルールによって生成されたアラートが 150 件を超える場合は、最初と同じインシデントの詳細を含む新しいインシデントが生成され、超過したアラートは新しいインシデントにグループ化されます。

1. **[Automated responses]\(対応の自動化\)** タブでは、カスタム ルールによってアラートが生成されたときに自動的に実行するプレイブックを選択します。 プレイブックの作成と自動化の詳細については、 [脅威への対応](tutorial-respond-threats-playbook.md)に関する記事を参照してください。

1. **[確認と作成]** を選択して新しいアラート ルールのすべての設定を確認し、 **[Create to initialize your alert rule]\(アラート ルールを作成して初期化\)** を選択します。
  
1. アラートが作成されると、**[Active rules]\(アクティブなルール\)** のテーブルにカスタム ルールが作成されます。 この一覧から、各ルールを有効にしたり、無効にしたり、削除したりできます。

1. 作成したアラート ルールの結果を表示するには、**[インシデント]** ページに移動します。ここでは、トリアージ、 [インシデントの調査](tutorial-investigate-cases.md)、脅威の修復を行うことができます。


> [!NOTE]
> Azure Sentinel で生成されたアラートは、 [Microsoft Graph Security](https://aka.ms/securitygraphdocs) を通じて使用できます。 詳細については、 [Microsoft Graph のセキュリティ アラートのドキュメント](https://aka.ms/graphsecurityreferencebetadocs)を参照してください。

## <a name="next-steps"></a>次のステップ

このチュートリアルでは、Azure Sentinel を使用して、脅威の検出を開始する方法について説明しました。

脅威への対応を自動化する方法については、「 [Azure Sentinel で脅威への自動対応を設定する](tutorial-respond-threats-playbook.md)」を参照してください。

