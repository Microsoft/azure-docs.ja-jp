---
title: ブループリント リソース ロックを使用した新しいリソースの保護
description: Azure Blueprints のリソース ロックの読み取り専用と削除禁止を使用して、新しくデプロイされるリソースを保護する方法を学習します。
author: DCtheGeek
ms.author: dacoulte
ms.date: 03/28/2019
ms.topic: tutorial
ms.service: blueprints
manager: carmonm
ms.openlocfilehash: d315fb5fe3ce7844946e6a9405a9a5f6a0be8b9d
ms.sourcegitcommit: c174d408a5522b58160e17a87d2b6ef4482a6694
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/18/2019
ms.locfileid: "59791611"
---
# <a name="protect-new-resources-with-azure-blueprints-resource-locks"></a>Azure Blueprints のリソース ロックを使用して新しいリソースを保護する

Azure Blueprints の[リソース ロック](../concepts/resource-locking.md)を使用すると、新しくデプロイされたリソースが改ざんされるのを、たとえそれが "_所有者_" ロールによる行為であっても、保護することができます。 この保護は、ブループリント定義の Resource Manager テンプレート成果物によって作成されたリソースに追加できます。

ここで示す手順は次のとおりです。

> [!div class="checklist"]
> - 新しいブループリント定義を作成する
> - ブループリント定義を**発行済み**としてマークする
> - ブループリント定義を既存のサブスクリプションに割り当てる
> - 新しいリソース グループを調べる
> - ブループリントの割り当てを解除してロックを削除する

## <a name="prerequisites"></a>前提条件

このチュートリアルを完了するには、Azure サブスクリプションが必要です。 Azure サブスクリプションをお持ちでない場合は、開始する前に [無料アカウント](https://azure.microsoft.com/free/) を作成してください。

## <a name="create-new-blueprint-definition"></a>新しいブループリント定義を作成する

最初に、新しいブループリント定義を作成します。

1. 左側のウィンドウにある **[すべてのサービス]** を選択します。 **[ブループリント]** を探して選択します。

1. 左側の **[はじめに]** ページで、_[ブループリントの作成]_ の下にある **[作成]** ボタンを選択します。

1. ページの上部にある **[空白のブループリント]** ブループリント サンプルを探し、**[空白のブループリントで始める]** を選択します。

1. ブループリント サンプルの _[基本]_ を入力します。

   - **[ブループリントの名前]**: ブループリント サンプルのコピーの名前を指定します。 このチュートリアルでは、_locked-storageaccount_ という名前を使用します。
   - **[ブループリントの説明]**: ブループリント定義について説明します。 「デプロイされたリソースでのブループリント リソース ロックのテスト用」を使用します。
   - **[定義の場所]**: 省略記号を使用して、ブループリント定義を保存する管理グループまたはサブスクリプションを選択します。

1. ページの上部にある _[成果物]_ タブまたはページの下部にある **[次へ: 成果物]** を選択します。

1. サブスクリプションでリソース グループを追加します。**[サブスクリプション]** の下にある **[+ 成果物の追加...]** 行を選択します。
   _[成果物の種類]_ に 'リソース グループ' を選択します。 _[成果物の表示名]_ を **RGtoLock** に設定します。
   _[リソース グループ名]_ と _[場所]_ フィールドは空白のままにしておきますが、各プロパティがそれらを**動的パラメーター**とするようにチェックボックスはオンになっていることを確認します。 **[追加]** をクリックして、この成果物をブループリントに追加します。

1. リソース グループにテンプレートを追加します。**[+ 成果物の追加...]** 行を選択します  (**RGtoLock** エントリの下)。 _[成果物の種類]_ に 'Azure Resource Manager テンプレート' を選択し、_[成果物の表示名]_ は 'StorageAccount' に設定し、_[説明]_ は空白のままにします。 エディター ボックスの **[テンプレート]** タブで、次の Resource Manager テンプレートを貼り付けます。 テンプレートを貼り付けた後、**[追加]** を選択してこの成果物をブループリントに追加します。

   ```json
   {
       "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
       "contentVersion": "1.0.0.0",
       "parameters": {
           "storageAccountType": {
               "type": "string",
               "defaultValue": "Standard_LRS",
               "allowedValues": [
                   "Standard_LRS",
                   "Standard_GRS",
                   "Standard_ZRS",
                   "Premium_LRS"
               ],
               "metadata": {
                   "description": "Storage Account type"
               }
           }
       },
       "variables": {
           "storageAccountName": "[concat('store', uniquestring(resourceGroup().id))]"
       },
       "resources": [{
           "type": "Microsoft.Storage/storageAccounts",
           "name": "[variables('storageAccountName')]",
           "location": "[resourceGroup().location]",
           "apiVersion": "2018-07-01",
           "sku": {
               "name": "[parameters('storageAccountType')]"
           },
           "kind": "StorageV2",
           "properties": {}
       }],
       "outputs": {
           "storageAccountName": {
               "type": "string",
               "value": "[variables('storageAccountName')]"
           }
       }
   }
   ```

1. ページの下部にある **[下書きの保存]** を選択します。

この手順では、選択した管理グループまたはサブスクリプションにブループリントの定義を作成します。

"**ブループリント定義の保存に成功しました**" というポータルの通知が表示されたら、次の手順に移ります。

## <a name="publish-the-blueprint-definition"></a>ブループリントの定義を発行する

環境にブループリントの定義が作成されました。 これは**下書き**モードで作成されており、割り当ておよびデプロイの前に**発行**する必要があります。

1. 左側のウィンドウにある **[すべてのサービス]** を選択します。 **[ブループリント]** を探して選択します。

1. 左側の **[ブループリントの定義]** ページを選択します。 フィルターを使用してブループリント定義 _locked-storageaccount_ を検索し、選択します。

1. ページの上部にある **[ブループリントを発行する]** を選択します。 右側の新しいウィンドウで、**[バージョン]** として _1.0_ を指定します。 このプロパティは、後で変更を加える場合に役立ちます。 **[変更に関するメモ]** (例: "ブループリントでデプロイされたリソースをロックするために発行する最初のバージョン") を指定します。 次に、ページの下部にある **[発行]** を選択します。

この手順では、ブループリントをサブスクリプションに割り当てることができます。 発行後に変更を行うことも可能です。 追加の変更の際は、同じブループリント定義のバージョン間の違いを追跡するために、**[バージョン]** の新しい値を使用して発行を行う必要があります。

"**ブループリント定義が正常に発行されました**" というポータルの通知が表示されたら、次の手順に移ります。

## <a name="assign-the-blueprint-definition"></a>ブループリントの定義を割り当てる

ブループリントの定義が正常に**発行**されたら、保存先の管理グループ内のサブスクリプションに割り当てることができます。 この手順では、ブループリントの定義の各デプロイを一意にするためのパラメーターを指定します。

1. 左側のウィンドウにある **[すべてのサービス]** を選択します。 **[ブループリント]** を探して選択します。

1. 左側の **[ブループリントの定義]** ページを選択します。 フィルターを使用してブループリント定義 _locked-storageaccount_ を検索し、選択します。

1. ブループリント定義ページの上部にある **[ブループリントの割り当て]** を選択します。

1. ブループリント割り当て用のパラメーター値を指定します。

   - 基本

     - **サブスクリプション**:ブループリントの定義を保存した管理グループ内の 1 つ以上のサブスクリプションを選択します。 複数のサブスクリプションを選択すると、入力したパラメーターを使用して、それぞれに対して割り当てが作成されます。
     - **割り当て名**: 名前は、ブループリント定義の名前に基づいてあらかじめ設定されています。 この割り当てでは、新しいリソース グループのロックを表したいので、割り当て名を _assignment-locked-storageaccount-TestingBPLocks_ に変更します。
     - **[場所]**:マネージド ID を作成するリージョンを選択します。 Azure Blueprint は、この管理対象 ID を使用して、割り当てられたブループリント内にすべての成果物をデプロイします。 詳細については、[Azure リソースの管理対象 ID の概要](../../../active-directory/managed-identities-azure-resources/overview.md)に関するページをご覧ください。
       このチュートリアルでは、_[米国東部 2]_ を選択します。
     - **ブループリント定義ラベル**: ブループリント定義の **[発行済み]** バージョン _[1.0]_ を選択します。

   - ロックの割り当て

     _[読み取り専用]_ のブループリントのロック モードを選択します。 詳細については、[ブループリント リソースのロック](../concepts/resource-locking.md)に関するページを参照してください。

   - マネージド ID

     既定の _[システム割り当て済み]_ オプションのままにします。 詳細については、[マネージド ID](../../../active-directory/managed-identities-azure-resources/overview.md) に関するページを参照してください。

   - アーティファクトのパラメーター

     このセクションで定義するパラメーターは、定義対象のアーティファクトに適用されます。 これらのパラメーターはブループリントの割り当て時に定義されるので、[動的パラメーター](../concepts/parameters.md#dynamic-parameters)です。 各成果物に対して、パラメーター値を **[値]** 列に定義されている内容に設定してください。

     |成果物名|アーティファクトの種類|パラメーター名|値|説明|
     |-|-|-|-|-|
     |RGtoLock リソース グループ|リソース グループ|Name|TestingBPLocks|ブループリントのロックを適用する新しいリソース グループの名前を定義します。|
     |RGtoLock リソース グループ|リソース グループ|Location|米国西部 2|ブループリントのロックを適用する新しいリソース グループの場所を定義します。|
     |StorageAccount|Resource Manager テンプレート|storageAccountType (StorageAccount)|Standard_GRS|ストレージの SKU を選択します。 既定値は _Standard_LRS_ です。|

1. すべてのパラメーターの入力が完了したら、ページの下部にある **[割り当て]** を選択します。

この手順では、定義されたリソースをデプロイし、選択した**ロックの割り当て**を構成します。 ブループリントのロックの適用には最長 30 分かかる場合があります。

"**ブループリント定義の割り当て完了**" というポータルの通知が表示されたら、次の手順に移ります。

## <a name="inspect-resources-deployed-by-the-assignment"></a>割り当てによってデプロイされたリソースを調べる

割り当てによって、リソース グループ _TestingBPLocks_ と、Resource Manager テンプレート成果物によってデプロイされるストレージ アカウントが作成されました。 新しいリソース グループと選択したロックの状態が、割り当ての詳細ページに表示されます。

1. 左側のウィンドウにある **[すべてのサービス]** を選択します。 **[ブループリント]** を探して選択します。

1. 左側の **[割り当てられたブループリント]** ページを選択します。 フィルターを使用してブループリントの割り当て _assignment-locked-storageaccount-TestingBPLocks_ を検索し、選択します。

   このページから、割り当てが成功したこと、および新しいブループリント ロック状態でリソースがデプロイされたことがわかります。 割り当てが更新された場合は、各定義のバージョンのデプロイに関する詳細が **[割り当ての操作]** ドロップダウンに表示されます。 リソース グループをクリックして、プロパティ ページを直接開くことができます。

1. **TestingBPLocks** リソース グループを選択します。

1. 左側の **[アクセス制御 (IAM)]** ページを選択し、**[ロール割り当て]** タブを選択します。

   ここでは、リソース グループのデプロイとロックに使用された _assignment-locked-storageaccount-TestingBPLocks_ ブループリント割り当てが、"_所有者_" ロールであることがわかります。

1. **[拒否割り当て]** タブを選択します。

   ブループリントの割り当てでは、デプロイされたリソース グループに対して[拒否割り当て](../../../role-based-access-control/deny-assignments.md)が作成され、_[読み取り専用]_ のブループリントのロック モードが適用されました。 拒否割り当てにより、_[ロール割り当て]_ タブに表示されている適切な権限を持つユーザーが特定のアクションを実行できなくなります。 拒否割り当ては "_すべてのプリンシパル_" に適用されます。

   プリンシパルを拒否割り当てから除外する方法については、[ブループリント リソースのロック](../concepts/resource-locking.md#exclude-a-principal-from-a-deny-assignment)に関するページを参照してください。

1. 拒否割り当てを選択し、左側の **[拒否されたアクセス許可]** ページを選択します。

   拒否割り当てでは、**\*** と **Action** 構成を使用してすべての操作を禁止しますが、**NotActions** を使用して **\*/read** を除外することで読み取りアクセスを許可します。

1. Azure portal の階層リンクで、**[TestingBPLocks - アクセス制御 (IAM)]** を選択します。 次に、左側の **[概要]** ページを選択し、**[リソース グループの削除]** ボタンをクリックします。 「_TestingBPLocks_」という名前を入力して削除を確定し、ウィンドウの下部にある **[削除]** を選択します。

   "**リソース グループ TestingBPLocks の削除に失敗しました**" というポータルの通知が表示されます。 このエラーは、アカウントにリソース グループを削除するアクセス許可はあるが、ブループリントの割り当てによってアクセスが拒否されたことを示しています。 ブループリントの割り当て時にブループリントのロック モードとして _[読み取り専用]_ を選択したことを思い出してください。 ブループリントのロックにより、アクセス許可を持つアカウントは (_所有者_ であっても) リソースを削除できなくなります。 詳細については、[ブループリント リソースのロック](../concepts/resource-locking.md)に関するページを参照してください。

以上の手順により、デプロイされたリソースは、不必要な削除 (アクセス許可を持つアカウントが行った操作であっても) を禁止するブループリントのロックで保護されるようになりました。

## <a name="unassign-the-blueprint"></a>ブループリントの割り当てを解除する

最後の手順では、ブループリントの定義の割り当てを削除します。 割り当てを削除しても、操作された成果物は削除されません。

1. 左側のウィンドウにある **[すべてのサービス]** を選択します。 **[ブループリント]** を探して選択します。

1. 左側の **[割り当てられたブループリント]** ページを選択します。 フィルターを使用してブループリントの割り当て _assignment-locked-storageaccount-TestingBPLocks_ を検索し、選択します。

1. ページの上部にある **[ブループリントの割り当て解除]** ボタンを選択します。 確認ダイアログ内の警告を読んでから、**[OK]** を選択します。

   ブループリントの割り当てを削除すると、ブループリントのロックも削除されます。 作成されたリソースは、アクセス許可を持つアカウントによってもう一度削除できます。

1. Azure メニューから **[リソース グループ]** を選択し、**TestingBPLocks** を選択します。

1. 左側の **[アクセス制御 (IAM)]** ページを選択し、**[ロール割り当て]** タブを選択します。

リソース グループのセキュリティでは、ブループリントの割り当てに "_所有者_" アクセス権がなくなったことが示されています。

"**ブループリント割り当ての削除完了**" というポータルの通知が表示されたら、次の手順に移ります。

## <a name="clean-up-resources"></a>リソースのクリーンアップ

このチュートリアルを完了したら、次のリソースを削除してください。

- リソース グループ _TestingBPLocks_
- ブループリント定義 _locked-storageaccount_

## <a name="next-steps"></a>次の手順

- [ブループリントのライフサイクル](../concepts/lifecycle.md)を参照する。
- [静的および動的パラメーター](../concepts/parameters.md)の使用方法を理解する。
- [ブループリントのリソース ロック](../concepts/resource-locking.md)の使用方法を調べる。
- [ブループリントの優先順位](../concepts/sequencing-order.md)のカスタマイズを参照する。
- [既存の割り当ての更新](../how-to/update-existing-assignments.md)方法を参照する。
- ブループリントの割り当て時の問題を[一般的なトラブルシューティング](../troubleshoot/general.md)で解決する。