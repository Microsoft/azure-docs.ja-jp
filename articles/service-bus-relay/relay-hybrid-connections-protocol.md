---
title: "Azure Relay ハイブリッド接続プロトコル ガイド | Microsoft Docs"
description: "Azure Relay ハイブリッド接続プロトコル ガイド。"
services: service-bus-relay
documentationcenter: na
author: clemensv
manager: timlt
editor: 
ms.assetid: 149f980c-3702-4805-8069-5321275bc3e8
ms.service: service-bus-relay
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 07/03/2017
ms.author: sethm;clemensv
ms.translationtype: Human Translation
ms.sourcegitcommit: b1d56fcfb472e5eae9d2f01a820f72f8eab9ef08
ms.openlocfilehash: 6b76403ba5fc4d00a625057549c85db59a473898
ms.contentlocale: ja-jp
ms.lasthandoff: 07/06/2017


---
# Azure Relay ハイブリッド接続プロトコル
Azure Relay は、Azure Service Bus プラットフォームの柱となる重要な機能の 1 つです。 Relay の新しい*ハイブリッド接続*は、HTTP と WebSocket をベースにして進化を遂げた、安全でオープンなプロトコルです。 従来の *BizTalk Services* には、独自技術のプロトコル基盤をベースに構築された同じ名前の機能がありますが、その機能の後継となります。 Azure App Services に統合されたハイブリッド接続は、引き続き現状のままご利用いただけます。

ハイブリッド接続を使用すると、ネットワークで結ばれた 2 つのアプリケーション間に双方向のバイナリ ストリーム通信を確立できます。アプリケーションは、自分側または相手側にある NAT やファイアウォールを越えて相手に接続することができます。 この記事では、リスナーのクライアントとセンダーのロールを接続するためのハイブリッド接続リレーでのクライアント側の対話と、リスナーが新しい接続を受け入れる方法について説明します。

## 対話モデル
ハイブリッド接続リレーは、通信に関係する二者がそれぞれのネットワークの範囲から検出して接続できる待ち合わせ場所 (ランデブー ポイント) を Azure クラウド内に設けることによって両者を接続します。 本記事を含む各種ドキュメントや API、Azure Portal でそのランデブー ポイントを "ハイブリッド接続" と呼んでいます。 この記事ではこれ以降、ハイブリッド接続のサービス エンドポイントを "サービス" と呼ぶことにします。 この対話モデルには、他の多くのネットワーク API で確立されてきた用語体系が使用されています。

この対話モデルにはリスナーが存在します。リスナーはまず、受信接続を処理する準備が整っていることを表明し、その後相手からの接続を受け入れます。 リスナーの相手側に存在するのが接続クライアントです。接続クライアントは、接続が受け入れられて双方向の通信経路が確立されることを期待します。
"接続"、"リッスン"、"受け入れ" という言葉は、ほとんどのソケット API で使用されています。

リレー通信モデルでは、どちらの当事者もサービス エンドポイントに対して送信接続を作成します。その意味では "リスナー" も "クライアント" です。普通にそのように呼ばれているケースもあれば、特別な用語が使用されるケースもあります。 そこでハイブリッド接続に関して、ここでは厳密に次の言葉を使うことにします。

接続の両側に存在するプログラムは、どちらもサービスに対するクライアントであることから、"クライアント" と呼びます。 接続を待機して受け入れるクライアントは "リスナー" です。"リスナー ロール" のクライアントという表現を使用することもあります。 サービスを介してリスナーに対する新しい接続を開始するクライアントは、"センダー" または "センダー ロール" のクライアントと呼びます。

### リスナー側の対話
リスナーとサービスとの間には 4 つの対話通信が存在します。具体的な通信の内容については、後述のリファレンス セクションで詳しく説明します。

#### リッスン
リスナーは、接続を受け入れる準備が整っていることをサービスに対して表明するために、送信 WebSocket 接続を作成します。 Relay 名前空間内に構成されているハイブリッド接続の名前や、それに対する "リッスン" 権限を付与するセキュリティ トークンは、接続ハンドシェイクで伝達されます。
この WebSocket がサービスによって許可されると、登録が完了し、確立された WebSocket が "コントロール チャネル" として待機状態になり、以後すべての対話処理が可能となります。 このサービスでは、1 つのハイブリッド接続に対して最大 25 のリスナーを同時に設定することができます。 アクティブなリスナーが複数存在する場合、それらのリスナー間で受信接続が負荷分散されます。使用されるリスナーの順序は無作為に決まり、必ずしも均等に負荷分散されるわけではありません。

#### Accept
センダーがサービスに対して新しい接続を開くと、サービスは、ハイブリッド接続上のいずれかのアクティブなリスナーを選んで通知を送ります。 この通知は、開いているコントロール チャネルを介し、JSON メッセージとしてリスナーに送信されます。JSON メッセージには、接続を受け入れる場合にリスナーが接続すべき WebSocket エンドポイントの URL が格納されます。

この URL は、特別な処理を施さずに直接リスナーが使用できます。つまり、リスナーはその URL をそのまま使用する必要があります。
エンコードされた情報の有効期間は限られています。基本的には、エンド ツー エンドで接続が確立されるまでにセンダー側で許容される待機時間に依存しますが、30 秒が上限です。 この URL を使って接続を確立できるのは 1 回のみです。 ランデブー URL との間で WebSocket 接続が確立されると、以後センダーとの間でやり取りされるすべてのアクティビティがその WebSocket で中継されます。サービスによる介入や中間処理は一切不要です。

#### 更新
リスナーの登録とコントロール チャネルの維持に必要なセキュリティ トークンは、リスナーがアクティブである間に有効期限が切れる可能性もあります。 トークンの期限切れは進行中の接続には影響しませんが、コントロール チャネルは期限切れの瞬間 (または直後) にサービスによって破棄されます。 "更新" 操作には、JSON メッセージが使用されます。リスナーはこのメッセージを送信し、コントロール チャネルに関連付けられているトークンを差し替えることで、コントロール チャネルが維持される期間を延長することができます。

#### ping
コントロール チャネルがアイドル状態で長時間経過した場合、その途中に存在するロード バランサーや NAT が TCP 接続を失う可能性があります。 これは "ping" 操作によって防ぐことができます。チャネル上に少量のデータを送信することで、その接続がまだ使用中であることをネットワーク ルート上のすべての当事者に伝えます。これは、リスナーの "存続性" テストとしての機能も果たしています。 ping が失敗した場合、コントロール チャネルは使用不可と考えられるので、リスナーは再接続する必要があります。

### 送信側の対話
サービスとの間でセンダー側が行う対話処理は 1 つ (接続) だけです。

#### 接続
サービス上の WebSocket は、"接続" 操作によって開かれます。その際、ハイブリッド接続の名前のほか、必要に応じて (ただし既定では必須) "送信" アクセス許可を付与するセキュリティ トークンをクエリ文字列で指定します。 その後、サービスが前述した方法でリスナーと対話し、その WebSocket につながるランデブー接続の作成をリスナーに要求します。 WebSocket が受け入れられると、以後 WebSocket 上のすべての対話は、接続先のリスナーとの間で行われるようになります。

### 対話の概要
この対話モデルで最終的にセンダー クライアントは、"クリーン" な WebSocket とのハンドシェイクが済んでいることになります。WebSocket はリスナーに接続されており、それ以降、プリアンブル データや接続のための準備は必要ありません。 したがってこのモデルでは、既存の WebSocket クライアントはどのような実装であれ、正しく構築された URL をその WebSocket クライアント レイヤーに渡すだけで、ハイブリッド接続サービスを簡単に利用することができます。

リスナーが受け入れ段階の対話を通じて取得するランデブー接続の WebSocket もクリーンであり、ごくわずかな抽象化処理 (自己のフレームワークのローカル ネットワーク リスナーにおける "受け入れ" 操作とハイブリッド接続のリモート "受け入れ" 操作を識別するための処理) を加えるだけで、既存の WebSocket サーバーの実装に渡すことができます。

## プロトコル リファレンス

このセクションでは、これまでに説明したプロトコルの対話について詳しく説明します。

HTTPS 1.1 からの改良点として、すべての WebSocket 接続はポート 443 上に作成されます。これは一部の WebSocket フレームワークや API で一般的に抽象化されています。 実装の中立性を維持するために、ここでは特定のフレームワークを推奨することはしません。

### リスナーのプロトコル
リスナーのプロトコルは、2 つの接続ジェスチャと 3 つのメッセージ操作とで構成されます。

#### リスナーのコントロール チャネル接続
コントロール チャネルは、次のアドレスに対する WebSocket 接続を作成することによって開かれます。

```
wss://{namespace-address}/$hc/{path}?sb-hc-action=...[&sb-hc-id=...]&sb-hc-token=...
```

`namespace-address` は、ハイブリッド接続のホストとなる Azure Relay 名前空間の完全修飾ドメイン名です。通常、`{myname}.servicebus.windows.net` の形式で指定します。

クエリ文字列パラメーターのオプションは次のとおりです。

| パラメーター | 必須 | Description |
| --- | --- | --- |
| `sb-hc-action` |あり |リスナー ロールの場合、このパラメーターには **sb-hc-action=listen** を指定する必要があります。 |
| `{path}` |あり |このリスナーを登録するあらかじめ構成されたハイブリッド接続の名前空間パスを URL エンコードしたもの。 この式がパスの固定部分 `$hc/` に付加されます。 |
| `sb-hc-token` |はい\* |リスナーは、名前空間またはハイブリッド接続の**リッスン**権限を付与する有効な Service Bus 共有アクセス トークンを URL エンコードして指定する必要があります。 |
| `sb-hc-id` |いいえ |クライアント側から任意で指定される ID です。この ID によってエンド ツー エンドの診断トレースが可能となります。 |

何らかのエラー (ハイブリッド接続パスが登録されていない、トークンが無効、トークンが欠落しているなど) が原因で WebSocket 接続に失敗した場合、通常の HTTP 1.1 ステータス フィードバック モデルを使用してエラー フィードバックが返されます。 Azure サポートには、この状態の説明に記述されているエラー追跡 ID を伝えることができます。

| コード | エラー | Description |
| --- | --- | --- |
| 404 |見つかりません |ハイブリッド接続のパスが無効か、ベース URL の形式に誤りがあります。 |
| 401 |権限がありません |セキュリティ トークンが欠落しているか、形式に誤りがあるか、無効です。 |
| 403 |許可されていません |このパスと操作の組み合わせに対してセキュリティ トークンが無効です。 |
| 500 |内部エラー |サービス内で何らかの問題が発生しました。 |

WebSocket 接続が最初にセットアップされた後、サービスによって意図的にシャットダウンされた場合は、その理由が、WebSocket プロトコルの適切なエラー コードを使用して、エラー メッセージと共に伝達されます。エラー メッセージには追跡 ID も記述されます。 エラー状態が発生していなければ、コントロール チャネルがサービスによってシャットダウンされることはありません。 正常な終了処理によるシャットダウンはすべてクライアント側の制御となります。

| Web ソケットの状態 | Description |
| --- | --- |
| 1001 |ハイブリッド接続のパスが削除されたか無効です。 |
| 1008 |セキュリティ トークンが有効期限切れとなり、承認ポリシーに違反した状態です。 |
| 1011 |サービス内で何らかの問題が発生しました。 |

### 受け入れのハンドシェイク
"受け入れ" 通知は、WebSocket のテキスト フレームに JSON メッセージとして格納され、既に確立されているコントロール チャネルを介してサービスからリスナーに送信されます。 このメッセージに対する応答はありません。

このメッセージには、"accept" という名前の JSON オブジェクトが含まれています。このオブジェクトには現時点で、次のプロパティが定義されています。

* **address** - URL 文字列。受信接続を受け入れるための WebSocket をサービスに対して確立する目的で使用されます。
* **id** - この接続の一意の識別子。 センダー クライアントによって ID が指定された場合は、その値になります。それ以外の場合は、システムによって生成された値が使用されます。
* **connectHeaders** - センダーから Relay エンドポイントに提供されたすべての HTTP ヘッダー。Sec-WebSocket-Protocol ヘッダーと Sec-WebSocket-Extensions ヘッダーも含まれています。

#### 受け入れメッセージ

```json
{                                                           
    "accept" : {
        "address" : "wss://168.61.148.205:443/$hc/{path}?..."    
        "id" : "4cb542c3-047a-4d40-a19f-bdc66441e736",  
        "connectHeaders" : {                                         
            "Host" : "...",                                                
            "Sec-WebSocket-Protocol" : "...",                              
            "Sec-WebSocket-Extensions" : "..."                             
        }                                                            
     }                                                         
}
```

リスナーは、JSON メッセージとして提供されたアドレスの URL を使用して、センダー ソケットを許可または拒否するための WebSocket を確立します。

#### ソケットの受け入れ
リスナーは、ソケットを受け入れるために、指定されたアドレスに対して WebSocket 接続を確立します。

"受け入れ" メッセージに`Sec-WebSocket-Protocol` ヘッダーがある場合、リスナーは WebSocket のみを受け入れます (リスナーがこのプロトコルをサポートしている場合)。 次いで、リスナーは WebSocket が確立されたものとしてヘッダーを設定します。

`Sec-WebSocket-Extensions` ヘッダーも同様です。 フレームワークが拡張機能をサポートしている場合、拡張機能に必要な `Sec-WebSocket-Extensions` ハンドシェイクの、"サーバー" 側の応答に対してヘッダーを設定する必要があります。

受け入れソケットを確立するためには URL をそのまま使用してください。ただし、次のパラメーターを含める必要があります。

| パラメーター | 必須 | Description |
| --- | --- | --- |
| `sb-hc-action` |あり |ソケットを受け入れるためには、このパラメーターを `sb-hc-action=accept` とする必要がある |
| `{path}` |あり |(次の段落を参照) |
| `sb-hc-id` |いいえ |**id** のこれまでの説明を参照してください。 |

`{path}` は、このリスナーを登録するあらかじめ構成されたハイブリッド接続の名前空間パスを URL エンコードしたものです。 この式がパスの固定部分 `$hc/` に付加されます。 

`path` 式は、サフィックスおよびクエリ文字列式、区切り文字スラッシュ、登録されている名前を使って、拡張することができます。 これにより、センダー クライアントは、HTTP ヘッダーを含めることができない場合に、ディスパッチ引数を受け入れ側リスナーに渡すことができます。 リスナー フレームワークは、パスから固定パス部分と登録名を解析し、おそらくプレフィックス `sb-` が付いたクエリ文字列引数を除いて、残りの部分をアプリケーションが接続可否決定に使用できるようにするものと想定されます。

詳細については、後の「センダーのプロトコル」セクションを参照してください。

エラーが発生した場合、サービスから次のような応答が返されます。

| コード | エラー | Description |
| --- | --- | --- |
| 403 |許可されていません |URL が無効です。 |
| 500 |内部エラー |サービス内で何らかの問題が発生しました。 |

接続が確立された後、センダーの WebSocket がシャットダウンするか、次の状態に該当した場合、WebSocket はサーバーによってシャットダウンされます。

| Web ソケットの状態 | Description |
| --- | --- |
| 1001 |センダー クライアントによって接続がシャットダウンされています。 |
| 1001 |ハイブリッド接続のパスが削除されたか無効です。 |
| 1008 |セキュリティ トークンが有効期限切れとなり、承認ポリシーに違反した状態です。 |
| 1011 |サービス内で何らかの問題が発生しました。 |

#### ソケットの拒否
"accept" メッセージを検査したうえでソケットを拒否する場合、拒否の理由を伝える状態コードと状態の説明をセンダーに送り返すために同様のハンドシェイクが必要となります。

ここでは、プロトコル デザインの選択肢として、WebSocket ハンドシェイク (つまり、決まったエラー状態となるように設計されているハンドシェイク) を使用することにします。そうすればリスナー クライアントの実装で引き続き WebSocket クライアントを使用でき、素の HTTP クライアントを別途採用する必要はありません。

ソケットを拒否する場合、クライアントは、"受け入れ" メッセージからアドレス URI を取得し、次の 2 つのクエリ文字列パラメーターを追加します。

| Param | 必須 | 説明 |
| --- | --- | --- |
| StatusCode |あり |HTTP 状態コード (数値) |
| statusDescription |あり |人が判読できる形式で記述された拒否の理由。 |

最終的に構築された URI を使用して WebSocket 接続が確立されます。

正しく完了するとき、このハンドシェイクは、意図的に HTTP エラー コード 410 で失敗します。これは WebSocket がまだ確立されていないためです。 問題が生じた場合は、次のコードがエラーについての説明となります。

| コード | エラー | Description |
| --- | --- | --- |
| 403 |許可されていません |URL が無効です。 |
| 500 |内部エラー |サービス内で何らかの問題が発生しました。 |

### リスナーのトークン更新
リスナーのトークンの有効期限が切れそうになったときは、確立済みのコントロール チャネルを介してリスナーからサービスにテキスト フレーム メッセージを送信すれば、トークンを差し替えることができます。 このメッセージには、`renewToken` という名前の JSON オブジェクトが含まれています。このオブジェクトには現時点で、次のプロパティが定義されています。

* **token** – 名前空間またはハイブリッド接続の**リッスン**権限を付与する有効な Service Bus 共有アクセス トークンを URL エンコードして指定する必要があります。

#### renewToken メッセージ

```json
{                                                                                                                                                                        
    "renewToken" : {                                                                                                                                                      
        "token" : "SharedAccessSignature sr=http%3a%2f%2fcontoso.servicebus.windows.net%2fhyco%2f&amp;sig=XXXXXXXXXX%3d&amp;se=1471633754&amp;skn=SasKeyName"  
    }                                                                                                                                                                     
}
```

トークンの検証に失敗した場合、アクセスは拒否され、コントロール チャネルの WebSocket は、クラウド サービスによってエラーと共にクローズされます。 それ以外の場合、応答は返されません。

| Web ソケットの状態 | Description |
| --- | --- |
| 1008 |セキュリティ トークンが有効期限切れとなり、承認ポリシーに違反した状態です。 |

## センダーのプロトコル
センダーのプロトコルは、リスナーの確立方法とほぼ同じです。
エンド ツー エンドで WebSocket の存在をできるだけ目立たなくすることが目的となります。 接続先のアドレスはリスナーの場合と同じですが、"action" が異なるほか、トークンに必要なアクセス許可が異なります。

```
wss://{namespace-address}/$hc/{path}?sb-hc-action=...&sb-hc-id=...&sbc-hc-token=...
```

*namespace-address* は、ハイブリッド接続のホストとなる Azure Relay 名前空間の完全修飾ドメイン名です。通常、`{myname}.servicebus.windows.net` の形式で指定します。

要求には、追加の HTTP ヘッダー (アプリケーション定義のヘッダーなど) を含めることができます。 指定したヘッダーはすべてリスナーに渡され、**accept** 制御メッセージの `connectHeader` オブジェクトで確認できます。

クエリ文字列パラメーターのオプションは次のとおりです。

| Param | 必須 | Description |
| --- | --- | --- |
| `sb-hc-action` |あり |センダー ロールの場合、このパラメーターには `action=connect` を指定する必要があります。 |
| `{path}` |あり |(次の段落を参照) |
| `sb-hc-token` |はい\* |リスナーは、名前空間またはハイブリッド接続の**送信**権限を付与する有効な Service Bus 共有アクセス トークンを URL エンコードして指定する必要があります。 |
| `sb-hc-id` |いいえ |ID の指定は任意です。指定した場合、エンド ツー エンドの診断トレースが可能になるほか、受け入れハンドシェイク時にリスナーに伝えられます。 |

`{path}` は、このリスナーを登録するあらかじめ構成されたハイブリッド接続の名前空間パスを URL エンコードしたものです。 さらに通信するために、サフィックスとクエリ文字列式で `path` 式を拡張できます。 たとえば、ハイブリッド接続がパス `hyco` で登録されている場合、`hyco/suffix?param=value&...` の後にここで定義したクエリ文字列パラメーターを付けて `path` 式にできます。 完全な式は次のようなものになります。

```
wss://{namespace-address}/$hc/hyco/suffix?param=value&sb-hc-action=...[&sb-hc-id=...&]sbc-hc-token=...
```

`path` 式は、"受け入れ" 制御メッセージに含まれるアドレス URI でリスナーに渡されます。

何らかのエラー (ハイブリッド接続パスが登録されていない、トークンが無効、トークンが欠落しているなど) が原因で WebSocket 接続に失敗した場合、通常の HTTP 1.1 ステータス フィードバック モデルを使用してエラー フィードバックが返されます。 Azure サポートには、この状態の説明に記述されているエラー追跡 ID を伝えることができます。

| コード | エラー | Description |
| --- | --- | --- |
| 404 |見つかりません |ハイブリッド接続のパスが無効か、ベース URL の形式に誤りがあります。 |
| 401 |権限がありません |セキュリティ トークンが欠落しているか、形式に誤りがあるか、無効です。 |
| 403 |許可されていません |このパスと操作の組み合わせに対してセキュリティ トークンが無効です。 |
| 500 |内部エラー |サービス内で何らかの問題が発生しました。 |

WebSocket 接続が最初にセットアップされた後、サービスによって意図的にシャットダウンされた場合は、その理由が、WebSocket プロトコルの適切なエラー コードを使用して、エラー メッセージと共に伝達されます。エラー メッセージには追跡 ID も記述されます。

| Web ソケットの状態 | Description |
| --- | --- |
| 1,000 |ソケットは、リスナーによってシャットダウンされています。 |
| 1001 |ハイブリッド接続のパスが削除されたか無効です。 |
| 1008 |セキュリティ トークンが有効期限切れとなり、承認ポリシーに違反した状態です。 |
| 1011 |サービス内で何らかの問題が発生しました。 |

## 次のステップ
* [Relay に関する FAQ](relay-faq.md)
* [名前空間を作成する](relay-create-namespace-portal.md)
* [.NET を使って作業を開始する](relay-hybrid-connections-dotnet-get-started.md)
* [Node を使って作業を開始する](relay-hybrid-connections-node-get-started.md)


