---
title: Azure HPC Cache NFS ストレージ ターゲットのトラブルシューティング
description: NFS ストレージ ターゲットの作成時にエラーを引き起こす可能性がある、構成エラーやその他の問題を回避および修正するためのヒント
author: ekpgh
ms.service: hpc-cache
ms.topic: troubleshooting
ms.date: 03/18/2020
ms.author: v-erkel
ms.openlocfilehash: efa163a2c10a7dc93bf5d26865a0e7eb43f11dea
ms.sourcegitcommit: 3d79f737ff34708b48dd2ae45100e2516af9ed78
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/23/2020
ms.locfileid: "87082768"
---
# <a name="troubleshoot-nas-configuration-and-nfs-storage-target-issues"></a>NAS 構成および NFS ストレージ ターゲットに関する問題のトラブルシューティング

この記事では、Azure HPC Cache でストレージ ターゲットとして NFS ストレージ システムを追加することを妨げる可能性がある、いくつかの一般的な構成エラーとその他の問題について、解決策を提供します。

この記事では、ポートを確認する方法および NAS システムへのルート アクセスを有効にする方法の詳細を説明します。 また、NFS ストレージ ターゲットの作成が失敗する原因となることがある、あまり一般的でない問題に関する詳細情報も含まれています。

> [!TIP]
> このガイドを使用する前に、[NFS ストレージ ターゲットの前提条件](hpc-cache-prerequisites.md#nfs-storage-requirements)に関するページを参照してください。

ご自分の問題に対する解決策がここに記載されていない場合は、[サポート チケットを開いてください](hpc-cache-support-ticket.md)。そうすれば、Microsoft サービスおよびサポートがお客様と協力して問題を調査し、解決することができます。

## <a name="check-port-settings"></a>ポート設定を確認する

Azure HPC Cache では、バックエンド NAS ストレージ システム上のいくつかの UDP/TCP ポートに対して読み取り/書き込みアクセスが必要です。 NAS システム上でこれらのポートにアクセスできること、さらにストレージ システムとキャッシュ サブネット間のファイアウォールを経由したこれらのポートへのトラフィックが許可されていることを確認してください。 この構成を確認するために、データ センターのファイアウォール管理者およびネットワーク管理者と協力することが必要な場合があります。

これらのポートは、ベンダーが異なるストレージ システムではそれぞれ異なるため、ストレージ ターゲットを設定するときにご利用のシステムの要件を確認してください。

一般に、キャッシュには次のポートへのアクセスが必要です。

| Protocol | Port  | サービス  |
|----------|-------|----------|
| TCP/UDP  | 111   | rpcbind  |
| TCP/UDP  | 2049  | NFS      |
| TCP/UDP  | 4045  | nlockmgr |
| TCP/UDP  | 4046  | mountd   |
| TCP/UDP  | 4047  | status   |

ご利用のシステムに必要な特定のポートを調べるには、次の ``rpcinfo`` コマンドを使用します。 次のコマンドを使用すると、ポートが一覧表示され、表内の関連する結果が書式設定されます  ( *<storage_IP>* という表現の部分にはシステムの IP アドレスを使用してください)。

このコマンドは、NFS インフラストラクチャがインストールされている任意の Linux クライアントから発行できます。 クラスター サブネット内のクライアントを使用する場合は、サブネットとストレージ システム間の接続を検証するためにも役立ちます。

```bash
rpcinfo -p <storage_IP> |egrep "100000\s+4\s+tcp|100005\s+3\s+tcp|100003\s+3\s+tcp|100024\s+1\s+tcp|100021\s+4\s+tcp"| awk '{print $4 "/" $3 " " $5}'|column -t
```

``rpcinfo`` クエリによって返されるすべてのポートで、Azure HPC Cache のサブネットからの無制限のトラフィックが許可されていることを確認します。

これらの設定の確認は、NAS 自体においてだけでなく、ストレージ システムとキャッシュ サブネット間のファイアウォールでも行ってください。

## <a name="check-root-access"></a>ルート アクセスを確認する

ストレージ ターゲットを作成するために、Azure HPC Cache では、ご利用のストレージ システムのエクスポートへのアクセスが必要です。 具体的には、エクスポートはユーザー ID 0 としてマウントされています。

各種のストレージ システムでは、それぞれ異なる方法を使用してこのアクセスが有効にされます。

* Linux サーバーでは、通常、``/etc/exports`` 内のエクスポートされたパスに ``no_root_squash`` が追加されます。
* NetApp および EMC システムでは、通常、特定の IP アドレスまたはネットワークに関連付けられたエクスポート ルールを使用してアクセスが制御されます。

エクスポート ルールを使用する場合は、キャッシュではキャッシュ サブネットからの複数の異なる IP アドレスを使用できることに注意してください。 すべての使用可能なサブネット IP アドレスからのアクセスを許可します。

> [!NOTE]
> 既定では、Azure HPC Cache はルート アクセスを許可します。 詳細については、[追加のキャッシュ設定の構成](configuration.md#configure-root-squash)に関する記事を参照してください。

NAS ストレージ ベンダーと協力して、適切なレベルのアクセスをキャッシュに対して有効にしてください。

### <a name="allow-root-access-on-directory-paths"></a>ディレクトリ パスに対するルート アクセスを許可する
<!-- linked in prereqs article -->

階層ディレクトリをエクスポートする NAS システムの場合、Azure HPC Cache では各エクスポート レベルへのルート アクセスが必要です。

たとえば、次のような 3 つのエクスポートがシステムによって表示されるとします。

* ``/ifs``
* ``/ifs/accounting``
* ``/ifs/accounting/payroll``

エクスポート ``/ifs/accounting/payroll`` は ``/ifs/accounting`` の子であり、``/ifs/accounting`` 自体は ``/ifs`` の子です。

``payroll`` エクスポートを HPC キャッシュ ストレージ ターゲットとして追加した場合、キャッシュでは実際には ``/ifs/`` がマウントされ、そこから payroll ディレクトリへのアクセスが行われます。 よって、Azure HPC Cache では、``/ifs/accounting/payroll`` エクスポートにアクセスするために、``/ifs`` へのルート アクセスが必要です。

この要件は、ストレージ システムから提供されるファイル ハンドルを使用して、キャッシュでファイルにインデックスを付け、ファイルの競合を回避する方法に関連しています。

階層化されたエクスポートを含む NAS システムでは、同じファイルが別のエクスポートから取得された場合、そのファイルに対して異なるファイル ハンドルが与えられます。 たとえば、クライアントでは ``/ifs/accounting`` がマウントされ、ファイル ``payroll/2011.txt``へのアクセスが行われるとします。 別のクライアントでは ``/ifs/accounting/payroll`` がマウントされ、ファイル ``2011.txt``へのアクセスが行われます。 ストレージ システムによるファイル ハンドルの割り当て方法に応じて、この 2 つのクライアントでは、異なるファイル ハンドル (``<mount2>/payroll/2011.txt`` 用と ``<mount3>/2011.txt`` 用) を持つ同じファイルを受信する可能性があります。

バックエンド ストレージ システムでは、ファイル ハンドル用の内部エイリアスが保持されますが、Azure HPC Cache では、インデックス内のどのファイル ハンドルが同じ項目を参照しているを判断することはできません。 そのため、キャッシュでは、同じファイルであることが認識されないために、同じファイルに対して異なる書き込みがキャッシュされ、変更が誤って適用される可能性があります。

複数のエクスポートでのファイルについて考えられるこのようなファイルの競合を回避するために、Azure HPC Cache ではパス内の使用可能な最も浅いエクスポートが自動的にマウントされ (例では ``/ifs``)、そのエクスポートから与えられたファイル ハンドルが使用されます。 複数のエクスポートで同じベース パスが使用される場合、Azure HPC Cache ではそのパスへのルート アクセスが必要です。

## <a name="enable-export-listing"></a>エクスポートの一覧表示を有効にする
<!-- link in prereqs article -->

NAS では、そのエクスポートが Azure HPC Cache によってクエリされた場合、一覧表示する必要があります。

ほとんどの NFS ストレージ システムでは、Linux クライアントから次のクエリを送信することで、これをテストできます: ``showmount -e <storage IP address>``

可能な場合は、ご利用のキャッシュと同じ仮想ネットワークから Linux クライアントを使用します。

このコマンドを実行してもエクスポートが表示されない場合、そのキャッシュではご利用のストレージ システムへの接続時に問題が発生しています。 NAS ベンダーと協力して、エクスポートの一覧表示を有効にしてください。

## <a name="adjust-vpn-packet-size-restrictions"></a>VPN パケット サイズの制限を調整する
<!-- link in prereqs article and configuration article -->

キャッシュとご利用の NAS デバイスとの間に VPN がある場合、その VPN によって、フルサイズの 1500 バイト イーサネット パケットがブロックされる可能性があります。 NAS と Azure HPC Cache インスタンスの間で大規模なやりとりはが完了しないが、より小さな更新プログラムは想定どおりに動作する場合、この問題が発生する可能性があります。

VPN 構成の詳細がわからなければ、ご利用のシステムにこの問題があるかどうかを簡単に判断する方法はありません。 この問題があるかどうかを確認するのに役立ついくつかの方法を次に示します。

* VPN の両側でパケット スニッファを使用して、正常に転送されるパケットを検出します。
* ご利用の VPN で ping コマンドが許可されている場合は、フルサイズのパケットの送信をテストできます。

  これらのオプションを使用して、VPN 経由で NAS に対して ping コマンドを実行します  ( *<storage_IP>* 値の部分にはご利用のストレージ システムの IP アドレスを使用します)。

   ```bash
   ping -M do -s 1472 -c 1 <storage_IP>
   ```

  コマンドのオプションは次のとおりです。

  * ``-M do`` - フラグメントしない
  * ``-c 1`` - パケットを 1 個だけ送信する
  * ``-s 1472`` - ペイロードのサイズを 1472 バイトに設定する。 これは、イーサネット オーバーヘッドを考慮した後の 1500 バイト パケットの最大サイズのペイロードです。

  成功応答は次のようになります。

  ```bash
  PING 10.54.54.11 (10.54.54.11) 1472(1500) bytes of data.
  1480 bytes from 10.54.54.11: icmp_seq=1 ttl=64 time=2.06 ms
  ```

  ping が 1472 バイトで失敗した場合、パケット サイズに問題がある可能性があります。

この問題を修正するには、リモート システムで最大フレーム サイズが正しく検出されるように、VPN に MSS クランプを構成することが必要になる場合があります。 詳細については、[VPN Gateway IPsec/IKE パラメーターのドキュメント](../vpn-gateway/vpn-gateway-about-vpn-devices.md#ipsec)を参照してください。

場合によっては、Azure HPC Cache の MTU 設定を 1400 に変更すると役立つことがあります。 ただし、キャッシュの MTU を制限する場合は、キャッシュと対話するクライアントとバックエンド ストレージ システムの MTU 設定も制限する必要があります。 詳細については、「[Azure HPC Cache の追加設定を構成する](configuration.md#adjust-mtu-value)」を参照してください。

## <a name="check-for-acl-security-style"></a>ACL セキュリティス タイルを確認する

一部の NAS システムでは、アクセス制御リスト (ACL) と従来の POSIX または UNIX セキュリティを組み合わせたハイブリッド セキュリティ スタイルが使用されます。

ご利用のシステムから、そのセキュリティ スタイルが頭字語 "ACL" を含まない UNIX または POSIX としてレポートされた場合、この問題はお客様に影響ありません。

ACL が使用されたシステムの場合、Azure HPC Cache では、ファイル アクセスを制御するために、追加のユーザー固有の値を追跡する必要があります。 これを行うには、アクセス キャッシュを有効にします。 アクセス キャッシュを有効にするユーザー向けのコントロールはありませんが、サポート チケットを開いて、ご利用のキャッシュ システム上で影響を受けるストレージ ターゲットに対してそれを有効にするように要求することができます。

## <a name="next-steps"></a>次のステップ

この記事で説明されていない問題が発生した場合は、[サポート チケットを開いて](hpc-cache-support-ticket.md)、専門家の支援を受けてください。
