---
title: OPC Vault のアーキテクチャ - Azure | Microsoft Docs
description: OPC Vault 証明書管理サービスのアーキテクチャ
author: mregen
ms.author: mregen
ms.date: 08/16/2019
ms.topic: overview
ms.service: industrial-iot
services: iot-industrialiot
manager: philmea
ms.openlocfilehash: 9331473402ddd22180df3b404824969360d48164
ms.sourcegitcommit: 4b8a69b920ade815d095236c16175124a6a34996
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/23/2019
ms.locfileid: "69995816"
---
# <a name="opc-vault-architecture"></a>OPC Vault のアーキテクチャ

この記事では、**OPC Vault マイクロサービス**および **OPC Vault IoT Edge モジュール**について概説します。

## <a name="overview"></a>概要

OPC UA アプリケーションは、アプリケーション インスタンス証明書を使用して、アプリケーション レベルのセキュリティを提供します。 アプリケーション証明書によって公開キーと秘密キーの組が提供される非対称暗号化を使用して、セキュリティで保護された接続が確立されます。 証明書は、自己署名されたものでも、証明機関 (CA) によって署名されたものでもかまいません。

OPC UA アプリケーションには、信頼しているアプリケーションを表す、信頼された証明書のリストがあります。 これらの証明書は、自己署名されたものでも、CA によって署名されたものでもかまいません。また、ルート CA またはサブ CA そのものでもかまいません。 信頼された証明書がより大規模な証明書チェーンの一部である場合、アプリケーションは、証明書チェーン全体を検証できる限り、信頼リスト内のその証明書までチェーンされているすべての証明書を信頼します。

自己署名証明書を信頼する場合と CA 証明書を信頼する場合の大きな違いは、信頼のデプロイと維持に必要なインストール作業と、会社固有の CA をホストするための追加作業にあります。 

1 つのクライアント アプリケーションを使用する n 台のサーバーに自己署名証明書の信頼を分散するには、n 個すべてのサーバー アプリケーション証明書をクライアント アプリケーションの信頼リストにインストールする必要があり、クライアント アプリケーション証明書をすべてのサーバー アプリケーションの信頼リストにインストールする必要があります。 この管理作業は非常に負担であり、証明書の有効期間を考慮する必要がある場合や証明書を更新する場合はさらに負担が増えます。

会社固有の CA を使用すると、複数のサーバーおよびクライアントでの信頼の管理が大幅に簡素化されます。 この場合、管理者は、使用されるクライアントやサーバーごとに、CA 署名済みのアプリケーション インスタンス証明書を 1 回生成します。 さらに、CA 証明書を、すべてのサーバーとクライアント上の各アプリケーション信頼リストにインストールされます。 このアプローチでは、有効期限が切れた証明書のみを更新して、影響を受けるアプリケーション用に置き換えます。

Azure Industrial IoT OPC UA 証明書管理サービスは、OPC Vault マイクロサービスをベースとした、OPC UA アプリケーション用の会社固有の CA を管理するための Microsoft のソリューションです。

OPC Vault は、Azure AD のセキュリティで保護されたサービス (ハードウェア セキュリティ モジュールを備えた Azure Key Vault、Cosmos DB、およびオプションでアプリケーション ストアとしての IoT Hub) によってサポートされる、セキュアなクラウドで会社固有の CA をホストするためのマイクロサービスを提供します。

OPC Vault マイクロサービスは、OT スタッフが署名済みのアプリケーション証明書を要求し、Azure Key Vault の署名権限を持つセキュリティ管理者や承認者がこれらの要求を承認または拒否する、ロールベースのワークフローをサポートするように設計されています。

既存の OPC UA GDS ベースの OT ソリューションとの互換性を確保するため、このサービスには、仕様の第 12 部に従って証明書と信頼リストを配布するための *OPC UA Global Discovery Server and Certificate Management* インターフェイスを実装する、OPC Vault マイクロサービスによって支えられるエッジ モジュールのサポートが含まれます。 ただし、私たちの知る限り、この GDS サーバー インターフェイスはまだ広く使用されておらず、機能が制限されています (閲覧者ロール)。 [Microsoft では、お客様からの要求に応じてエクスペリエンスを改善していきます (*)](#yet-unsupported-features)。

## <a name="architecture"></a>アーキテクチャ

このアーキテクチャは、OPC Vault マイクロサービスをベースとしており、工場のネットワーク用に OPC Vault IoT Edge モジュール、ワークフローを制御するための Web サンプル UX が用意されています。

![OPC Vault のアーキテクチャ](media/overview-opc-vault-architecture/opc-vault.png)

## <a name="opc-vault-microservice"></a>OPC Vault マイクロサービス

OPC Vault マイクロサービスは、OPC UA アプリケーション用の会社固有の CA を分散および管理するためのワークフローを実装する、次のインターフェイスで構成されています。

### <a name="application"></a>Application 
- "OPC UA アプリケーション" は、サーバー、クライアント、またはその両方にすることができます。 この場合、OPC Vault はアプリケーション登録機関として機能します。 
- アプリケーションの登録、更新、登録解除の基本的な操作のほかに、検索式を使用してアプリケーションを検索および照会するためのインターフェイスもあります。 
- 証明書の要求では、要求を処理し、OPC UA 固有のすべての拡張機能を含む署名済み証明書を発行するために、有効なアプリケーションを参照する必要があります。 
- アプリケーション サービスは、顧客の構成に応じて、CosmosDB データベースまたは [OpcTwin デバイス レジストリ (*)](#yet-unsupported-features) によってサポートされます。

### <a name="certificate-group"></a>証明書グループ
- 証明書グループは、証明書に署名するための秘密キーを含むルート CA またはサブ CA 証明書を格納するエンティティです。 
- RSA キーの長さ、SHA-2 ハッシュの長さ、有効期間は、発行元 CA と署名済みアプリケーション証明書のどちらでも構成できます。 
- 複数のグループを単一のサービスでホストすることができます。これにより、https、ユーザー、または ECC アルゴリズム証明書グループを使用した今後の拡張機能が可能になります [(*)](#yet-unsupported-features)。 
- CA 証明書は、FIPS 140-2 レベル 2 ハードウェア セキュリティ モジュール (HSM) で使用された Azure Key Vault に格納されます。 署名は Azure AD で保護された Key Vault 操作によって行われるため、秘密キーがセキュリティで保護されたストレージの外部に移動されることはありません。 
- CA 証明書は、時間の経過と共に更新することができ、Key Vault 履歴によって安全なストレージに保持されます。 
- 各 CA 証明書の失効リストも Key Vault にシークレットとして格納されます。 アプリケーションの登録が解除されると、アプリケーション証明書も管理者によって CRL 内で取り消されます。
- 一括および単独の証明書失効がサポートされています。

### <a name="certificate-request"></a>証明書の要求
証明書の要求では、OPC UA アプリケーションに対して "証明書署名要求" (CSR) を使用して新しいキーの組または署名済み証明書を生成するワークフローを実装します。 
- この要求は、サブジェクトや CSR などの付随情報と OPC UA アプリケーションへの参照と共にデータベースに格納されます。 
- サービスのビジネス ロジックによって、アプリケーション データベースに格納されている情報に対して要求が検証されます。 たとえば、データベース内のアプリケーション URI は CSR 内のアプリケーション URI と一致する必要があります。
- 署名権限 (承認者ロール) を持つセキュリティ管理者によって、この要求は承認または拒否されます。 要求が承認されると、新しいキーの組または署名済み証明書が生成されます。 新しい秘密キーは KeyVault で安全に保存されるのに対し、新しい署名済み公開証明書は証明書要求データベースに格納されます。
- 要求者は、要求が承認または取り消されるまで要求状態をポーリングできます。 要求が承認された場合は、秘密キーと証明書をダウンロードして、OPC UA アプリケーションの証明書ストアにインストールできます。
- これで、要求者は、要求を受理して、要求データベースから不要な情報を削除することができるようになります。 

署名済み証明書の有効期間を通じて、アプリケーションが削除されたり、キーが侵害されたりする可能性があります。 そのような場合、CA マネージャーは次のことが可能です。
- アプリケーションを削除します。同時に、アプリの保留中および承認済みの証明書の要求もすべて削除されます。 
- また、キーのみが更新または侵害された場合に 1 つの証明書の要求のみを削除できます。
- 侵害された承認済みおよび受理済みの証明書の要求が削除済みとしてマークされます。
- マネージャーは、発行者の CA CRL の更新を定期的に実行することができます。 更新時には、削除された証明書の要求すべてが取り消され、証明書のシリアル番号が CRL 失効リストに追加されます。 取り消された証明書の要求は取り消し済みとしてマークされます。
- 緊急時には、1 つの証明書の要求を取り消すこともできます。
- 最後に、更新された CRL を、参加している OPC UA クライアントおよびサーバーに分散できます。

OPC Vault マイクロサービス API の詳細については、マイクロサービスの swagger ドキュメントを参照してください。

## <a name="opc-vault-iot-edge-module"></a>OPC Vault IoT Edge モジュール
工場のネットワークの Global Discovery Server をサポートするために、OPC Vault モジュールをエッジにデプロイしたり、ローカルの .Net Core アプリケーションとして実行したり、Docker コンテナーで起動したりできます。 現在の OPC UA .Net Standard スタックでは Auth2 認証がサポートされていないため、OPC Vault エッジ モジュールの機能は閲覧者ロールに制限されています。これは、OPC UA GDS 標準インターフェイスを使用してエッジ モジュールからマイクロサービスにユーザーを偽装することができないためです。 この時点では、ライター、管理者、または承認者のロールを必要としない操作のみが許可されます [(*)](#yet-unsupported-features)。 

## <a name="yet-unsupported-features"></a>未サポートの機能

**(*)** まだサポートされていません。

## <a name="next-steps"></a>次の手順

ここでは OPC Vault アーキテクチャについて学習しました。次に以下の記事を読むことをお勧めします。

> [!div class="nextstepaction"]
> [OPC Vault を構築してデプロイする](howto-opc-vault-deploy.md)
