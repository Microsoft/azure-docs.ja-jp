---
title: "Azure Service Fabric でのメトリックの最適化 | Microsoft Docs"
description: "Service Fabric でのメトリック向け戦略としての最適化またはパッキングの使用の概要"
services: service-fabric
documentationcenter: .net
author: masnider
manager: timlt
editor: 
ms.assetid: e5ebfae5-c8f7-4d6c-9173-3e22a9730552
ms.service: Service-Fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 01/05/2017
ms.author: masnider
translationtype: Human Translation
ms.sourcegitcommit: dafaf29b6827a6f1c043af3d6bfe62d480d31ad5
ms.openlocfilehash: 5ef6381f7d182c818171eca3e3d32a00bc30268e
ms.lasthandoff: 02/17/2017


---
# <a name="defragmentation-of-metrics-and-load-in-service-fabric"></a>Service Fabric のメトリックと負荷の最適化
Service Fabric クラスター リソース マネージャーは主に、負荷分散の面から均衡化の機能を果たします。これにより、クラスター内のノードが均等に活用されるようにします。 ワークロードの分散化は、障害対応の観点から見て最も安全なレイアウトです。障害が発生しても、ワークロードの大部分が消費される事態を回避できるからです。 Service Fabric クラスター リソース マネージャーは、最適化と呼ばれる別の戦略もサポートしています。 最適化は一般に、クラスター全体にメトリックの使用を分散させようとするのではなく、実際にはその統合を試みる必要があることを意味します。 この統合化のアプローチは、通常の戦略とは逆転的な発想によるものです。メトリック負荷の平均標準偏差を最小化するのではなく、クラスター リソース マネージャーで偏差を大きくしようとするのです。 しかし、なぜこのような戦略が必要なのでしょうか。

クラスター内のノード間に負荷を均等に分散させた場合、ノードが提供する必要のあるリソースの一部がすべて消費されます。 しかし、一部のワークロードのために非常に大きなサービスが作成され、ノードの大部分が消費されてしまうこともあるでしょう。 そのような場合には、ノードのリソースの 75 ～ 95% が 1 つのサービス オブジェクトだけに占有されてしまうことも考えられます。 ただし、ワークロードが大きいこと自体が問題というわけではありません。 クラスター リソース マネージャーは、その大きなワークロードを処理するためにクラスターの再構成が必要かどうかを、サービスの作成時に決定します。 しかしその間、そのワークロードはクラスター内でスケジュールされるのを待機しなければなりません。

移動するサービスや状態の数が多い場合には、大きなワークロードがクラスター内に配置されるまでに、長い時間がかかる可能性があります。 他にも大きいワークロードがクラスター内に存在する場合は、特にこれが起こりやすく、移動にかかる時間が長くなります。 Service Fabric チームでは、このシナリオをシミュレートして作成時間を測定しました。 その結果、サービスの規模がある程度大きくて、クラスターの使用率が高い場合、それらのサービスの作成が低速になることが確認されました。 そしてこのシナリオに対応するために、均衡化戦略としての最適化が導入されました。 ワークロードが大きい場合 (特に作成時間が重要である場合) には、最適化を使用することで、それらの新しいワークロードをクラスター内で効果的にスケジュールできます。

最適化メトリックを構成すると、クラスター リソース マネージャーはサービスの負荷をより少ないノードに集約しようとします。 これにより、大きなサービスに対しても (ほぼ) 常に十分なリソースを確保することができます。 その結果、それらのサービスを必要に応じてすばやく作成できるようになります。

ほとんどの場合、最適化が必要になることはありません。 通常、サービスの規模は小さいので、クラスター内で十分なリソースを確保することは難しくありません。 ただし、サービスの規模が大きく、それらをすばやく作成する必要がある場合 (かつ、その他のトレードオフを許容できる場合) には、最適化が最適な戦略と言えます。

それでは、具体的にどのようなトレードオフがあるのでしょうか。 第一に、最適化を行うと障害の影響範囲が広くなります (障害が発生したノードで実行されているサービスの数が多くなるため)。 また、最適化を行った場合、クラスター内の一部のリソースは、ワークローがスケジュールされるまでの間、使用できません。

次の図は、2 つの異なるクラスターを視覚的に表現したものです。一方は最適化され、もう一方は最適化されていません。 分散化されたほうのクラスターでは、大きなサービス オブジェクトを配置するために、多くの移動が必要になることがわかります。 一方、最適化されたほうのクラスターでは、ノード&4; かノード&5; に大きなワークロードをすぐに配置できます。

<center>
![分散および最適化されたクラスターの比較][Image1]
</center>

## <a name="defragmentation-pros-and-cons"></a>最適化の長所と短所
他の概念的トレードオフとはどのようなものでしょうか。 最適化メトリックを有効にする前に、ワークロードを詳細に測定することをお勧めします。 次の表は考慮すべきことを簡単にまとめたものです。

| 最適化の長所 | 最適化の短所 |
| --- | --- |
| 大きいサービスを短時間で作成できる |少数のノードに負荷をまとめるので、競合が増える |
| 作成の間のデータ移動が減る |障害の影響を受けるサービスが増え、混乱が増す |
| 要件の記述を増やし領域を再利用できる |全体的なリソース管理構成が複雑になる |

最適化と通常のメトリックを、同じクラスター内に混在させることもできます。 クラスター リソース マネージャーは、最適化メトリックを可能な限り統合しようとしながら、その他のメトリックを分散化します。 これらのメトリックスを共有するサービスがない場合は、良好な結果が得られる可能性があります。 実際の結果は、分散メトリックの数と最適化メトリックの数の比率や、それらの重複、比重、現在の負荷など、複数の要因によって左右されます。 厳密な構成が必要かどうかを判断するには、実験を行う必要があります。

## <a name="configuring-defragmentation-metrics"></a>最適化メトリックを構成する
最適化メトリックの構成はクラスターでのグローバルな決定であり、最適化対象としてメトリックを個別に選択できます。

ClusterManifest.xml:

```xml
<Section Name="DefragmentationMetrics">
    <Parameter Name="Disk" Value="true" />
    <Parameter Name="CPU" Value="false" />
</Section>
```

スタンドアロン デプロイの ClusterConfig.json 経由または Azure でホストされたクラスターの Template.json 経由:

```json
"fabricSettings": [
  {
    "name": "DefragmentationMetrics",
    "parameters": [
      {
          "name": "Disk",
          "value": "true"
      },
      {
          "name": "CPU",
          "value": "false"
      }
    ]
  }
]
```


## <a name="next-steps"></a>次のステップ
* クラスター リソース マネージャーには、クラスターを記述するためのさまざまなオプションがあります。 オプションについて詳しくは、[Service Fabric クラスターの記述](service-fabric-cluster-resource-manager-cluster-description.md)に関する記事をご覧ください
* メトリックは、Service Fabric クラスター リソース マネージャーが管理するクラスターの利用量と容量を表します。 メトリックの詳細とその構成方法については、[この記事](service-fabric-cluster-resource-manager-metrics.md)をご覧ください

[Image1]:./media/service-fabric-cluster-resource-manager-defragmentation-metrics/balancing-defrag-compared.png

