---
title: "Azure から VMware にフェールバックする方法 | Microsoft Docs"
description: "仮想マシンを Azure にフェールオーバーした後に、フェールバックを開始して仮想マシンをオンプレミスに戻すことができます。 フェールバック方法の手順について説明します。"
services: site-recovery
documentationcenter: 
author: ruturaj
manager: gauravd
editor: 
ms.assetid: 44813a48-c680-4581-a92e-cecc57cc3b1e
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 06/05/2017
ms.author: ruturajd
ms.translationtype: Human Translation
ms.sourcegitcommit: ef1e603ea7759af76db595d95171cdbe1c995598
ms.openlocfilehash: 622604dc3ce69085feff6705168d58ad9938c429
ms.contentlocale: ja-jp
ms.lasthandoff: 06/16/2017


---
# <a name="fail-back-from-azure-to-an-on-premises-site"></a>Azure からオンプレミス サイトへのフェールバック

この記事では、Azure Virtual Machines からオンプレミス サイトに仮想マシンをフェールバックする方法について説明します。 チュートリアル「[Azure Site Recovery を使用して VMware 仮想マシンと物理サーバーを Azure にレプリケートする](site-recovery-vmware-to-azure-classic.md)」を使用して、VMware 仮想マシンまたは Windows/Linux 物理サーバーをオンプレミス サイトから Azure にフェールオーバーした後で、この記事の手順に従ってください。

> [!WARNING]
> 既に[移行が完了](site-recovery-migrate-to-azure.md#what-do-we-mean-by-migration)している場合や、仮想マシンを別のリソース グループに移動した場合、または Azure 仮想マシンを削除した場合、その後フェールバックを実行することはできません。

> [!NOTE]
> VMware 仮想マシンをフェールオーバー済みである場合、Hyper-V ホストにフェールバックすることはできません。

## <a name="overview-of-failback"></a>フェールバックの概要
フェールバックのしくみは次のとおりです。 Azure にフェールオーバー後、オンプレミス サイトへのフェールバックはいくつかの段階で実施します。

1. オンプレミス サイトの VMware 仮想マシンへのレプリケートを開始するために、Azure の仮想マシンを[再保護](site-recovery-how-to-reprotect.md)します。 このプロセスでは、次の手順も実行する必要があります。
    1. オンプレミスのマスター ターゲットを設定する (Windows 仮想マシン用の Windows マスター ターゲットと Linux 仮想マシン用の [Linux マスター ターゲット](site-recovery-how-to-install-linux-master-target.md))。
    2. [プロセス サーバー](site-recovery-vmware-setup-azure-ps-resource-manager.md)をセットアップする。
    3. [再保護](site-recovery-how-to-reprotect.md)を開始する。 これによりオンプレミスの仮想マシンがオフとなり、Azure 仮想マシンのデータがオンプレミスのディスクと同期されます。
5. Azure の仮想マシンからオンプレミス サイトへのレプリケーションが開始されたら、Azure からオンプレミス サイトへのフェールオーバーを開始します。

データがフェールバックされたら、フェールバック先のオンプレミスの仮想マシンを再保護します。これにより、オンプレミスの仮想マシンは Azure へのレプリケートを開始できるようになります。

概要を簡単に把握するために、Azure からオンプレミス サイトへのフェールオーバー方法に関する次の動画をご覧ください。
> [!VIDEO https://channel9.msdn.com/Series/Azure-Site-Recovery/VMware-to-Azure-with-ASR-Video5-Failback-from-Azure-to-On-premises/player]

### <a name="fail-back-to-the-original-or-alternate-location"></a>元の場所または別の場所へのフェールバック

オンプレミスにソース仮想マシンが残っているようであれば、VMware 仮想マシンをフェールオーバーする際に、元の仮想マシンにフェールバックできます。 このシナリオでは、変更部分のみがレプリケートされます。 このシナリオは、元の場所の復旧と呼ばれます。 オンプレミスの仮想マシンがない場合、別の場所への復旧を行うことになります。

> [!NOTE]
> 元の vCenter と構成サーバーにのみフェールバックすることができます。 新しい構成サーバーをデプロイし、それを使ってフェールバックすることはできません。 また、新しい vCenter を既存の構成サーバーに追加し、新しい vCenter にフェールバックすることもできません。

#### <a name="original-location-recovery"></a>元の場所の復旧

元の仮想マシンにフェールバックする場合、次の条件が必要です。
* vCenter サーバーで仮想マシンが管理されている場合は、マスター ターゲットの ESX ホストが仮想マシンのデータストアにアクセスできる必要があります。
* 仮想マシンが ESX ホスト上にあるものの、vCenter で管理されていない場合、仮想マシンのハード ディスクは、マスター ターゲットのホストがアクセスできるデータストア内にある必要があります。
* 仮想マシンが ESX ホスト上にあり、vCenter が使用されない場合、再保護する前に、マスター ターゲットの ESX ホストの検出を完了する必要があります。 これは、物理サーバーにフェールバックする場合も同様です。
* 仮想記憶域ネットワーク (vSAN) のほか、RAW デバイス マッピング (RDM) ベースのディスクにもフェールバックできますが、事前にそのディスクが存在し、オンプレミスの仮想マシンに接続されている場合に限られます。

#### <a name="alternate-location-recovery"></a>別の場所の復旧
仮想マシンを再保護する前にオンプレミスの仮想マシンが存在しない場合のシナリオは、別の場所への復旧と呼ばれます。 再保護のワークフローでオンプレミスの仮想マシンをもう一度作成します。 また、データはすべてダウンロードされます。

* 別の場所にフェールバックすると、仮想マシンは、マスター ターゲット サーバーがデプロイされたのと同じ ESX ホストに復元されます。 ディスクを作成するために使用したデータストアは、仮想マシンの再保護時に選択したのと同じデータストアになります。
* フェールバック先として使用できるのは、仮想マシン ファイル システム (VMFS) データストアのみです。 vSAN または RDM の場合、再保護とフェールバックは機能しません。
* 再保護には、大規模な初期データ転送と、その後の変更が必要になります。 このプロセスが行われるのは、オンプレミスに仮想マシンがないためです。 完全なデータをレプリケートする必要があります。 さらに、この再保護は元の場所への復旧よりも時間がかかります。
* vSAN ベースまたは RDM ベースのディスクにフェールバックすることはできません。 VMFS データストアに作成できるのは新しい仮想マシン ディスク (VMDK) のみです。

物理マシンは Azure にフェールオーバーした場合、VMware 仮想マシンとしてのみフェールバックできます (P2A2V とも呼ばれます)。 このフローは、別の場所の復旧に該当します。

* Windows Server 2008 R2 SP1 の物理サーバーが保護されていて、Azure にフェールオーバーした場合、これをフェールバックすることはできません。
* 1 つ以上のマスター ターゲット サーバーと、フェールバック先として必要な ESX/ESXi ホストを必ず検出します。

## <a name="have-you-completed-reprotection"></a>再保護の完了の確認
仮想マシンのレプリケート状態を確保したうえでオンプレミス サイトへのフェールバックを開始するために、再保護の操作を事前に行っておく必要があります。 詳細については、[Azure からオンプレミスへの再保護の方法](site-recovery-how-to-reprotect.md)に関するページを参照してください。

## <a name="prerequisites"></a>前提条件

* フェールバックを実行するときは、構成サーバーがオンプレミスに存在している必要があります。 フェールバック中、仮想マシンが構成サーバー データベースに存在している必要があります。存在していない場合、フェールバックは成功しません。 そのため、サーバーを定期的にバックアップするようスケジュールを設定してください。 万一障害が発生した場合は、フェールバックが機能するように、同じ IP アドレスでサーバーを復元する必要があります。
* マスター ターゲット サーバーには、フェールバックのトリガー前にスナップショットが一切存在していないことが必要です。

## <a name="steps-to-fail-back"></a>フェールバックの手順

> [!IMPORTANT]
> フェールバックを開始する前に、必ず仮想マシンの再保護を完了しておいてください。 仮想マシンが保護された状態であり、正常性に**問題がない**ことが必須です。 仮想マシンを再保護するには、[再保護の方法](site-recovery-how-to-reprotect.md)に関するページを参照してください。

1. [レプリケートされたアイテム] ページで仮想マシンを選択し、右クリックして **[計画されていないフェールオーバー]** をクリックします。
2. **[フェールオーバーの確認]** で、フェールオーバーの方向 (Azure から) を確認し、フェールオーバーに使用する最新の復旧ポイント (最新のアプリケーション整合性ポイント) を選択します。 アプリケーション整合性ポイントは最新の時点よりも過去になるため、一部のデータが失われます。
3. フェールオーバー中に、Site Recovery によって Azure の仮想マシンがシャットダウンされます。 フェールバックが期待どおりに完了したことを確認したら、Azure の仮想マシンがシャットダウンされたこと確認します。

### <a name="to-what-recovery-point-can-i-fail-back-the-virtual-machines"></a>仮想マシンをフェールバックできる復旧ポイント

仮想マシン/復旧計画をフェールバックする場合、2 つの選択肢があります。

"最後に処理が行われた時点" を選択した場合、すべての仮想マシンが、候補として考えられる最新の時点までフェールオーバーされます。 復旧計画内にレプリケーション グループが存在する場合は、レプリケーション グループの個々の仮想マシンが、それぞれの最新の時点までフェールオーバーされます。

仮想マシンをフェールバックするには、その仮想マシンに少なくとも 1 つの復旧ポイントが必要です。 復旧計画をフェールバックするには、復旧計画に含まれるすべての仮想マシンに復旧ポイントが少なくとも 1 つ存在する必要があります。

> [!NOTE]
> 最新の復旧ポイントは、クラッシュ整合性の復旧ポイントです。

"アプリケーション整合性" の復旧ポイントを選択した場合は、1 回の仮想マシン フェールバックで、候補として考えられる最新のアプリケーション整合性復旧ポイントまで復元されます。 レプリケーション グループを含んだ復旧計画の場合、それぞれのレプリケーション グループが、その共通の復旧ポイントまで復元されます。
アプリケーション整合性の復旧ポイントは時間差を伴うことがあり、データの損失につながる場合があるので注意が必要です。

### <a name="what-happens-to-vmware-tools-post-failback"></a>フェールバック後の VMware ツールの動作

Azure へのフェールオーバー時は、VMware ツールを Azure 仮想マシンで実行することはできません。 Windows 仮想マシンの場合、フェールオーバー時に ASR によって VMware ツールが無効になります。 Linux 仮想マシンの場合、フェールオーバー時に ASR によって VMware ツールがアンインストールされます。

Windows 仮想マシンのフェールバック時に、フェールバックと同時に VMware ツールが再有効化されます。 同様に、Linux 仮想マシンの場合も、フェールバック時に VMware ツールがマシンに再インストールされます。

## <a name="next-steps"></a>次のステップ

フェールバックが完了したら、Azure に復旧された仮想マシンが確実に削除されるように、仮想マシンをコミットする必要があります。

### <a name="commit"></a>コミット
フェールオーバーされた仮想マシンを Azure から削除するには、コミットする必要があります。
保護された項目を右クリックし、**[コミット]** をクリックします。 ジョブが実行されて、Azure にフェールオーバーされた仮想マシンが削除されます。

### <a name="reprotect-from-on-premises-to-azure"></a>オンプレミスから Azure への再保護

コミットが完了したら、仮想マシンはオンプレミス サイトに戻りますが、保護はされていません。 Azure へのレプリケートを再び開始するには、次を実行します。

1. **[コンテナー]** > **[設定]** > **[レプリケートされたアイテム]** の順に移動して、フェールバックした仮想マシンを選択し、**[再保護]** をクリックします。
2. Azure にデータを送信する際に使用する必要があるプロセス サーバーの値を指定します。
3. **[OK]** をクリックすると、再保護ジョブが開始されます。

> [!NOTE]
> オンプレミスの仮想マシンが起動した後、エージェントが構成サーバーに再度登録されるまでにしばらく時間がかかります (最大 15 分)。 この間は再保護が失敗し、エージェントがインストールされていないというエラー メッセージが返されます。 数分待ってから再保護操作をやり直してください。

再保護ジョブが完了すると、仮想マシンが Azure にレプリケートされるので、フェールオーバーを実行できます。

## <a name="common-issues"></a>一般的な問題
フェールバックを実行する前に、必ず vCenter を接続された状態にしてください。 接続されていない場合、ディスクの切断と仮想マシンへの接続は失敗します。

