---
title: "Azure からオンプレミス サイトに再保護する | Microsoft Docs"
description: "VM を Azure にフェールオーバーした後に、フェールバックを開始して VM をオンプレミスに戻すことができます。 フェールバックの前に再保護する方法について説明します。"
services: site-recovery
documentationcenter: 
author: ruturaj
manager: gauravd
editor: 
ms.assetid: 44813a48-c680-4581-a92e-cecc57cc3b1e
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 06/05/2017
ms.author: ruturajd
ms.translationtype: HT
ms.sourcegitcommit: 540180e7d6cd02dfa1f3cac8ccd343e965ded91b
ms.openlocfilehash: 181ed544ae4697753490642fea8eef636322a114
ms.contentlocale: ja-jp
ms.lasthandoff: 08/16/2017

---
# <a name="reprotect-from-azure-to-an-on-premises-site"></a>Azure からオンプレミス サイトへの再保護



## <a name="overview"></a>概要
この記事では、Azure 仮想マシンを Azure からオンプレミス サイトに再保護する方法について説明します。 VMware 仮想マシンまたは Windows/Linux 物理サーバーが (「[Replicate VMware virtual machines and physical servers to Azure with Azure Site Recovery (Azure Site Recovery を使用して VMware 仮想マシンおよび物理サーバーを Azure にレプリケートする)](site-recovery-failover.md)」の説明に従って) オンプレミス サイトから Azure にフェールオーバーされた後にそれらをフェールバックする準備ができたら、この記事の手順に従ってください。

> [!WARNING]
> [移行を完了](site-recovery-migrate-to-azure.md#what-do-we-mean-by-migration)したり、仮想マシンを別のリソース グループに移動したり、Azure 仮想マシンを削除したりした後にフェールバックすることはできません。


再保護が完了し、保護された仮想マシンがレプリケートされた後、仮想マシン上でフェールバックを開始してそのマシンをオンプレミス サイトに移動できます。

コメントや質問はこの記事の末尾、または [Azure Recovery Services フォーラム](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr)で投稿してください。

概要を簡単に把握するために、Azure からオンプレミス サイトへのフェールオーバー方法に関する次の動画をご覧ください。
> [!VIDEO https://channel9.msdn.com/Series/Azure-Site-Recovery/VMware-to-Azure-with-ASR-Video5-Failback-from-Azure-to-On-premises/player]


## <a name="prerequisites"></a>前提条件
仮想マシンを再保護する準備ができたら、次の前提条件のアクション実行するか、または検討してください。

* vCenter サーバーがフェールバック先の仮想マシンを管理している場合は、vCenter サーバー上の仮想マシンの検出に[必要なアクセス許可](site-recovery-vmware-to-azure-classic.md)があることを確認してください。

  > [!WARNING]
  > スナップショットがオンプレミスのマスター ターゲットまたは仮想マシン上に存在する場合、再保護は失敗します。 マスター ターゲット上のスナップショットを削除してから再保護に進むことができます。 仮想マシン上のスナップショットは、再保護ジョブ中に自動的にマージされます。

* フェールバックする前に、次の 2 つの追加コンポーネントを作成します。

  * **プロセス サーバー**: [プロセス サーバー](site-recovery-vmware-setup-azure-ps-resource-manager.md)は Azure 内の保護された仮想マシンからデータを受信し、そのデータをオンプレミス サイトに送信します。 プロセス サーバーと保護された仮想マシンとの間には、待ち時間が短いネットワークが必要です。 そのため、Azure ExpressRoute 接続を使用している場合はオンプレミスのプロセス サーバーを、または Azure ベースのプロセス サーバーと VPN を使用できます。
  
  * **マスター ターゲット サーバー**: マスター ターゲット サーバーは、フェールバック データを受信します。 作成したオンプレミスの管理サーバーには、既定でマスター ターゲット サーバーがインストールされています。 ただし、フェールバック トラフィックの量によっては、フェールバック用に別のマスター ターゲット サーバーを作成する必要があります。
    * [Linux 仮想マシンには、Linux マスター ターゲット サーバーが必要です](site-recovery-how-to-install-linux-master-target.md)。
    * Windows 仮想マシンには、Windows マスター ターゲット サーバーが必要です。 オンプレミスのプロセス サーバーとマスター ターゲット コンピューターを再利用できます。

    マスター ターゲットには、「[Common things to check on a master target before reprotect (再保護の前にマスター ターゲット上で確認すべき一般的な事項)](site-recovery-how-to-reprotect.md#common-things-to-check-after-completing-installation-of-the-master-target-server)」に一覧表示されているその他の前提条件があります。

* フェールバックするときは、構成サーバーがオンプレミスに必要です。 フェールバック中、仮想マシンが構成サーバー データベースに存在している必要があります。 それ以外の場合、フェールバックは失敗します。 

> [!IMPORTANT]
> 必ず、構成サーバーを定期的にバックアップするようスケジュールを設定します。 障害が発生した場合は、フェールバックが機能するように、同じ IP アドレスを持つサーバーを復元します。

* VMware でマスター ターゲット仮想マシンの構成パラメーターに `disk.EnableUUID=true` を設定します。 この行が存在しない場合は追加してください。 この設定は、一貫性のある UUID を仮想マシン ディスク (VMDK) に提供することでマウントが適切に実行されるようにするために必要です。

* *マスター ターゲット サーバー上で Storage vMotion を使用することはできません*。 そのようにした場合、フェールバックが失敗する可能性があります。 ディスクが使用できないため、この仮想マシンは起動できません。 この問題を防ぐには、vMotion の一覧からマスター ターゲット サーバーを除外します。

* マスター ターゲット サーバーに新しいドライブ (リテンション ドライブ) を追加します。 新しいディスクを追加し、ドライブをフォーマットします。


### <a name="frequently-asked-questions"></a>よく寄せられる質問

#### <a name="why-do-i-need-a-s2s-vpn-or-an-expressroute-connection-to-replicate-data-back-to-the-on-premises-site"></a>オンプレミス サイトにデータをレプリケート バックするために S2S VPN または ExpressRoute 接続が必要な理由
オンプレミスから Azure へのレプリケーションはインターネット経由、またはパブリック ピアリングが存在する ExpressRoute 接続経由で実行できるのに対して、再保護およびフェールバックにはデータをレプリケートするためのサイト間 (S2S) VPN が必要です。 Azure 内のフェールオーバーされた仮想マシンがオンプレミスの構成サーバーに到達 (ping を発行) できるようにネットワークを提供します。 フェールオーバーされた仮想マシンの Azure ネットワークにプロセス サーバーをデプロイすることもできます。 このプロセス サーバーも、オンプレミスの構成サーバーと通信できる必要があります。

#### <a name="when-should-i-install-a-process-server-in-azure"></a>Azure にプロセス サーバーをインストールするタイミング


再保護の対象となる Azure 上の仮想マシンは、レプリケーション データをプロセス サーバーに送信します。 Azure 上の仮想マシンがプロセス サーバーに到達できるようにネットワークを設定します。

Azure でプロセス サーバーをデプロイしたり、フェールオーバーの際に使用した既存のプロセス サーバーを使用したりできます。 考慮すべき重要な点は、Azure 上の仮想マシンからプロセス サーバーにデータを送信するときの待ち時間です。

ExpressRoute 接続が設定されている場合は、仮想マシンとプロセス サーバーの間の待ち時間が短いため、オンプレミスのプロセス サーバーを使用してデータを送信できます。

 ![Expressroute のアーキテクチャ ダイアグラム](./media/site-recovery-failback-azure-to-vmware-classic/architecture.png)



ただし、S2S VPN しか使用していない場合は、Azure にプロセス サーバーをデプロイすることをお勧めします。

 ![VPN のアーキテクチャ ダイアグラム](./media/site-recovery-failback-azure-to-vmware-classic/architecture2.png)


レプリケーションは S2S VPN 経由、または ExpressRoute ネットワークのプライベート ピアリング経由でのみ実行されることに注意してください。 そのネットワーク チャネルで十分な帯域幅を使用できることを確認してください。

Azure ベースのプロセス サーバーのインストールについては、「[Manage a process server running in Azure (Azure で実行されているプロセス サーバーを管理する)](site-recovery-vmware-setup-azure-ps-resource-manager.md)」を参照してください。

> [!TIP]
> フェールバック中は Azure ベースのプロセス サーバーを使用することをお勧めします。 レプリケーションのパフォーマンスは、プロセス サーバーが、レプリケートしている仮想マシン (Azure 内のフェールオーバーされたマシン) に近いほど高くなります。 ただし、概念実証 (POC) やデモンストレーション中は、オンプレミスのプロセス サーバーをプライベート ピアリングの ExpressRoute と共に使用して POC をより高速に完了できます。



#### <a name="what-ports-should-i-open-on-different-components-so-that-reprotection-can-work"></a>再保護が機能できるようにするために各コンポーネントで開くべきポート

![フェールオーバーおよびフェールバック用のポート](./media/site-recovery-failback-azure-to-vmware-classic/Failover-Failback.png)

#### <a name="which-master-target-server-should-i-use-for-reprotection"></a>再保護に使用すべきマスター ターゲット サーバー
オンプレミスのマスター ターゲット サーバーは、プロセス サーバーからデータを受信してオンプレミスの仮想マシンの VMDK に書き込むために必要です。 Windows 仮想マシンを保護する場合、Windows マスター ターゲット サーバーが必要になります。 オンプレミスのプロセス サーバーおよびマスター ターゲットを再利用できます<!-- !todo component -->。 Linux 仮想マシンの場合は、追加のオンプレミスの Linux マスター ターゲットを設定する必要があります。


マスター ターゲット サーバーのインストールについては、次を参照してください。

* [Windows マスター ターゲット サーバーをインストールする方法](site-recovery-vmware-to-azure.md)
* [Linux マスター ターゲット サーバーをインストールする方法](site-recovery-how-to-install-linux-master-target.md)


#### <a name="what-datastore-types-are-supported-on-the-on-premises-esxi-host-during-failback"></a>フェールバック中にオンプレミスの ESXi ホストでサポートされるデータストアの種類

現在、Azure Site Recovery は、仮想マシン ファイル システム (VMFS) または vSAN データストアへのフェールバックのみをサポートしています。 NFS データストアはサポートされていません。 この制限のために、再保護画面上のデータストア選択の入力は NFS データストアの場合は空です。または、vSAN データストアが表示されますが、ジョブ中に失敗します。 フェールバックする予定がある場合は、VMFS データストアをオンプレミスに作成し、それにフェールバックできます。 このフェールバックによって、VMDK の完全なダウンロードが実行されます。

### <a name="common-things-to-check-after-completing-installation-of-the-master-target-server"></a>マスター ターゲット サーバーのインストール完了後の一般的なチェック事項

* 仮想マシンが vCenter サーバー上にオンプレミスに存在する場合、マスター ターゲット サーバーにはオンプレミスの仮想マシンの VMDK へのアクセス権が必要です。 アクセス権は、レプリケートされたデータを仮想マシンのディスクに書き込むために必要です。 オンプレミスの仮想マシンのデータ ストアが、読み取りと書き込みアクセス権のあるマスター ターゲットのホストにマウントされていることを確認します。

* 仮想マシンが vCenter サーバー上にオンプレミスに存在しない場合、Site Recovery サービスは、再保護中に新しい仮想マシンを作成する必要があります。 この仮想マシンは、マスター ターゲットを作成する ESX ホスト上に作成されます。 そのため、希望するホストにフェールバック仮想マシンが作成されるように、ESX ホストは慎重に選択します。

* *マスター ターゲット サーバーにストレージ vMotion を使用することはできません*。 そのようにした場合、フェールバックが失敗する可能性があります。 ディスクが使用できないため、この仮想マシンは起動できません。

  > [!WARNING]
  > マスター ターゲットで再保護の後に Storage vMotion タスクが実行される場合、そのマスター ターゲットに接続されている保護された仮想マシン ディスクは vMotion タスクのターゲットに移行されます。 この後にフェールバックしようとすると、ディスクが見つからないため、ディスクの取り外しは失敗します。 その後、ストレージ アカウントでディスクを見つけることは困難になります。 手動でディスクを見つけ、それを仮想マシンに接続する必要があります。 その後に、オンプレミスの仮想マシンを起動できます。

* 既存の Windows マスター ターゲット サーバーにリテンション ドライブを追加します。 新しいディスクを追加し、ドライブをフォーマットします。 リテンション ドライブは、仮想マシンがオンプレミス サイトにレプリケートされたときの特定の時点で停止するために使用します。 リテンション ドライブのいくつかの条件を次に示します。 これらの条件が存在しない場合、そのドライブはマスター ターゲット サーバーに一覧表示されません。

   * ボリュームが他のどの目的 (レプリケーションのターゲットなど) にも使用されていない。

   * ボリュームがロック モードではない。

   * ボリュームがキャッシュ ボリュームではない。 そのボリュームにマスター ターゲット インストールが存在してはいけません。 プロセス サーバーとマスター ターゲットのカスタム インストール ボリュームは、リテンション ボリュームになる資格がありません。 プロセス サーバーとマスター ターゲットがボリュームにインストールされている場合、そのボリュームがマスター ターゲットのキャッシュ ボリュームになります。

   * ボリュームのファイル システムの種類が FAT または FAT32 ではない。

   * ボリュームの容量がゼロ以外である。

   * Windows の既定のリテンション ボリュームは R ボリュームです。

   * Linux の既定のリテンション ボリュームは /mnt/retention/ です。

  > [!IMPORTANT]
  > 既存のプロセス サーバー/構成サーバー マシン、スケール、またはプロセス サーバー/マスター ターゲット サーバー マシンを使用している場合は、新しいドライブを追加する必要があります。 新しいドライブは、前の要件を満たしている必要があります。 リテンション ドライブが存在しない場合、そのドライブは、ポータル上の選択ドロップダウン リストに表示されません。 オンプレミスのマスター ターゲットにドライブを追加した後、そのドライブがポータル上の選択リストに表示されるまでに最大 15 分かかります。 15 分経ってもドライブが表示されない場合は、構成サーバーを更新することもできます。

* フェールオーバーされた Linux 仮想マシンには、Linux マスター ターゲット サーバーが必要です。 フェールオーバーした Windows 仮想マシンには、Windows マスター ターゲット サーバーが必要になります。

* VMware ツールをマスター ターゲット サーバーにインストールします。 VMware ツールがない場合、マスター ターゲットの ESXi ホスト上のデータストアを検出できません。

* vCenter プロパティを使用して、マスター ターゲット仮想マシン上で `disk.EnableUUID=true` パラメーターを有効にします。 <!-- !todo Needs link. -->

* マスター ターゲットには、少なくとも 1 つの VMFS データストアが接続されている必要があります。 1 つも存在しない場合、再保護ページ上の **[Datastore] \(データストア)** 入力は空になり、処理を続行できません。

* マスター ターゲット サーバーのディスクにはスナップショットが存在してはいけません。 スナップショットが存在する場合、再保護およびフェールバックは失敗します。

* 準仮想化 SCSI コントローラーをマスター ターゲットに割り当てることはできません。 LSI Logic コントローラー以外は使用できません。 LSI Logic コントローラがない場合、再保護は失敗します。

<!--
### Failback policy
To replicate back to on-premises, you will need a failback policy. This policy get automatically created when you create a forward direction policy. Note that

1. This policy gets auto associated with the configuration server during creation.
2. This policy is not editable.
3. The set values of the policy are (RPO Threshold = 15 Mins, Recovery Point Retention = 24 Hours, App Consistency Snapshot Frequency = 60 Mins)
   ![](./media/site-recovery-failback-azure-to-vmware-new/failback-policy.png)

-->

## <a name="steps-to-reprotect"></a>再保護の手順

> [!NOTE]
> Azure 内の仮想マシンが起動した後、エージェントが構成サーバーに再度登録されるまでにある程度の時間 (最大 15 分) かかります。 この間、再保護は失敗し、エージェントがインストールされていないことがエラー メッセージに示されます。 数分待ってから、再保護を再試行してください。



1. **[コンテナー]** > **[レプリケートされたアイテム]** で、フェールオーバーされた仮想マシンを右クリックして **[再保護]** をクリックします。 マシンをクリックし、コマンド ボタンから **[再保護]** を選択することもできます。
2. ブレードで、保護の方向として **[Azure からオンプレミスへ]** が既に選択されていることを確認します。
3. **[マスター ターゲット サーバー]** と **[プロセス サーバー]** で、オンプレミスのマスター ターゲット サーバーとプロセス サーバーを選択します。
4. **[Datastore] \(データストア)** では、オンプレミスのディスクの復旧先のデータストアを選択します。 このオプションは、オンプレミスの仮想マシンを削除し、新しいディスクを作成する必要がある場合に使用します。 ディスクが既に存在する場合、このオプションは無視されますが、値は指定しておく必要があります。
5. リテンション ドライブを選択します。
6. フェールバック ポリシーは自動的に選択されます。
7. **[OK]** をクリックして再保護を開始します。 仮想マシンを Azure からオンプレミス サイトにレプリケートするジョブが開始されます。 進行状況は **[ジョブ]** タブで追跡できます。

代わりの場所に復旧する (オンプレミスの仮想マシンが削除されている) 場合は、マスター ターゲット サーバー用に構成されているリテンション ドライブとデータストアを選択します。 オンプレミス サイトにフェールバックした場合、フェールバック保護計画の VMware 仮想マシンはマスター ターゲット サーバーと同じデータストアを使用します。 その後、新しい仮想マシンが vCenter に作成されます。

Azure 上の仮想マシンを既存のオンプレミスの仮想マシン復旧する場合は、マスター ターゲット サーバーの ESXi ホストに対する読み取り/書き込みアクセス権を持つオンプレミスの仮想マシンのデータストアをマウントします。
    ![[再保護] ダイアログ ボックス](./media/site-recovery-failback-azure-to-vmware-new/reprotectinputs.png)

また、復旧計画のレベルで再保護を実行することもできます。 レプリケーション グループは、復旧計画を使用してのみ再保護できます。 復旧計画を使用してを再保護する場合は、すべての保護されたマシンの値を指定する必要があります。

> [!NOTE]
> レプリケーション グループを再保護するには、同じマスター ターゲット サーバーを使用します。 異なるマスター ターゲット サーバーを使用してレプリケーション グループを再保護すると、サーバーは共通の時点を提供できません。

> [!NOTE]
> 再保護の間、オンプレミスの仮想マシンは無効になります。 これは、レプリケーション中のデータの整合性を確保するのに役立ちます。 再保護が完了した後、仮想マシンを有効にしないでください。

再保護が成功した後、仮想マシンは保護された状態に入ります。

## <a name="next-steps"></a>次のステップ

仮想マシンが保護された状態に入ったら、[フェールバックを開始](site-recovery-how-to-failback-azure-to-vmware.md#steps-to-fail-back)できます。 

フェールバックによって Azure の仮想マシンがシャットダウンされ、オンプレミスの仮想マシンが起動されます。 アプリケーションのある程度のダウンタイムをみておいてください。 アプリケーションがダウンタイムを許容できるフェールバック用の時間を選択します。

## <a name="common-problems"></a>一般的な問題

* テンプレートを使用して仮想マシンを作成する場合は、各仮想マシンのディスクに独自の UUID が割り当てられていることを確認してください。 オンプレミスの仮想マシンとマスター ターゲットが同じテンプレートから作成されたためにその両方の UUID が衝突すると、再保護は失敗します。 同じテンプレートから作成されていない別のマスター ターゲットをデプロイします。

* 読み取り専用ユーザー vCenter の検出を実行し、仮想マシンを保護すると、適切に保護され、フェールオーバーが機能します。 再保護中は、データストアが検出できないため、フェールオーバーは失敗します。 再保護中はデータストアが一覧表示されないという現象が発生します。 この問題を解決するには、アクセス許可を持つ適切なアカウントで vCenter 資格情報を更新し、ジョブを再試行できます。 詳細については、「[Azure Site Recovery を使用して VMware 仮想マシンと物理サーバーを Azure にレプリケートする](site-recovery-vmware-to-azure-classic.md)」を参照してください。

* Linux 仮想マシンをフェールバックし、それをオンプレミスで実行すると、ネットワーク マネージャー パッケージがマシンからアンインストールされていることを確認できます。 このアンインストールは、Azure で仮想マシンが復旧されるときに、ネットワーク マネージャー パッケージが削除されるために発生します。

* Linux 仮想マシンが静的 IP アドレスで構成されているときに Azure にフェールオーバーされると、IP アドレスは DHCP から取得されます。 オンプレミスにフェールオーバーすると、仮想マシンは、引き続き DHCP を使用して IP アドレスを取得します。 必要であれば、手動でコンピューターにサインインし、IP アドレスを静的アドレスに設定し直します。 Windows 仮想マシンは、同じ静的 IP を再度取得できます。

* ESXi 5.5 Free エディションまたは vSphere 6 Hypervisor Free エディションを使用すると、フェールオーバーは成功しますが、フェールバックが失敗します。 フェールバックを有効にするには、いずれかのプログラムの評価ライセンスにアップグレードしてください。

* プロセス サーバーから構成サーバーにアクセスできない場合は、Telnet を使用して、構成サーバー コンピューターのポート 443 への接続を確認します。 プロセス サーバーから構成サーバーに対して ping を試すこともできます。 プロセス サーバーが構成サーバーに接続されるときは、ハートビートも必要です。

* 代替の vCenter にフェールバックしようとしている場合は、新しい vCenter とマスター ターゲット サーバーが検出されることを確認してください。 典型的な症状は、データストアにアクセスできないか、**[再保護]** ダイアログに表示されないことです。

* 物理オンプレミス サーバーとして保護されている Windows Server 2008 R2 SP1 サーバーは、Azure からオンプレミス サイトにフェールバックすることができません。

