---
title: "Azure からオンプレミス サイトに再保護する方法 | Microsoft Docs"
description: "VM を Azure にフェールオーバーした後に、フェールバックを開始して VM をオンプレミスに戻すことができます。 フェールバックの前に再保護する方法の手順を説明します。"
services: site-recovery
documentationcenter: 
author: ruturaj
manager: gauravd
editor: 
ms.assetid: 44813a48-c680-4581-a92e-cecc57cc3b1e
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: 
ms.date: 02/13/2017
ms.author: ruturajd
translationtype: Human Translation
ms.sourcegitcommit: 0bec803e4b49f3ae53f2cc3be6b9cb2d256fe5ea
ms.openlocfilehash: 7b7177faa9fa571d3a62ee15b4a0fbfdab3a097f
ms.lasthandoff: 03/24/2017


---
# <a name="reprotect-from-azure-to-an-on-premises-site"></a>Azure からオンプレミス サイトへの再保護

## <a name="overview"></a>概要
この記事では、Azure からオンプレミス サイトへ Azure Virtual Machines を再保護する方法について説明します。 [Azure Site Recovery を使用して VMware 仮想マシンと物理サーバーを Azure にレプリケートする](site-recovery-failover.md)方法を使用して、VMware 仮想マシンまたは Windows/Linux 物理サーバーをオンプレミス サイトから Azure にフェールオーバーした後に、それらをフェールバックする準備ができたときに、この記事の手順に従ってください。

再保護が完了し、保護された仮想マシンがレプリケートされた後に、仮想マシンのフェールバックを開始してオンプレミス サイトに戻すことができます。

コメントや質問はこの記事の末尾、または [Azure Recovery Services フォーラム](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr)で投稿してください。

概要を簡単に把握するために、Azure からオンプレミス サイトへのフェールオーバー方法に関する次の動画をご覧ください。
> [!VIDEO https://channel9.msdn.com/Series/Azure-Site-Recovery/VMware-to-Azure-with-ASR-Video5-Failback-from-Azure-to-On-premises/player]


## <a name="prerequisites"></a>前提条件
再保護を準備する際に対応または考慮する必要がある前提条件の手順を次に示します。

* フェールバックする仮想マシンが vCenter サーバーによって管理されている場合、vCenter サーバー上の仮想マシンの検出に必要な権限があることを確認する必要があります。 詳細については、[こちら](site-recovery-vmware-to-azure-classic.md#vmware-permissions-for-vcenter-access)を参照してください。
* オンプレミスの仮想マシン上にスナップショットがある場合、再保護は失敗します。 スナップショットを削除してから再保護に進むことができます。
* フェールバックを開始する前に、さらに 2 つのコンポーネントを作成する必要があります。
  * **プロセス サーバーを作成する**:  プロセス サーバーは、Azure の保護された仮想マシンからデータを受け取り、オンプレミス サイトにデータを送信します。 プロセス サーバーと保護された仮想マシンとの間には、待ち時間が短いネットワークが必要です。 したがって、Azure ExpressRoute 接続を使用している場合はオンプレミスのプロセス サーバーを、VPN を使用している場合は Azure のプロセス サーバーを使用できます。
  * **マスター ターゲット サーバーを作成する**: マスター ターゲット サーバーは、フェールバック データを受信します。 作成したオンプレミスの管理サーバーには、既定でマスター ターゲット サーバーがインストールされています。 ただし、フェールバック トラフィックの量によっては、フェールバック用に別のマスター ターゲット サーバーを作成する必要があります。
        * [Linux 仮想マシンには、Linux マスター ターゲット サーバーが必要です](site-recovery-how-to-install-linux-master-target.md)。
        * Windows 仮想マシンには、Windows マスター ターゲット サーバーが必要です。 オンプレミスのプロセス サーバーとマスター ターゲット コンピューターを再利用できます。
* フェールバックを実行するときは、構成サーバーがオンプレミスに存在している必要があります。 フェールバック中、仮想マシンが構成サーバー データベースに存在している必要があります。 それ以外の場合、フェールバックは失敗します。 必ず、サーバーを定期的にバックアップするようスケジュールを設定します。 障害が発生した場合は、フェールバックが正常に機能するように、同じ IP アドレスでサーバーを復元する必要があります。
* VMware でマスター ターゲット仮想マシンの構成パラメーターに disk.EnableUUID=true が設定されていることを確認します。 この行が存在しない場合は追加してください。 この設定は、一貫性のある UUID を仮想マシン ディスク (VMDK) に提供することでマウントが適切に実行されるようにするために必要です。
* *マスター ターゲット サーバーにストレージ vMaster を使用することはできません*。 そのようにした場合、フェールバックが失敗する可能性があります。 ディスクが利用可能にならないため、この仮想マシンは起動しません。
* マスター ターゲット サーバーに新しいドライブを追加する必要があります。 このドライブはリテンション ドライブと呼ばれます。 新しいディスクを追加し、ドライブをフォーマットします。
* マスター ターゲットには他にも、[再保護の前に行うマスター ターゲットの一般的なチェック事項](site-recovery-how-to-reprotect.md#common-things-to-check-after-completing-installation-of-the-master-target-server)に記載されている前提条件があります。


### <a name="why-do-i-need-a-s2s-vpn-or-an-expressroute-connection-to-replicate-data-back-to-the-on-premises-site"></a>オンプレミス サイトにデータをレプリケート バックするために S2S VPN または ExpressRoute 接続が必要な理由
オンプレミスから Azure へのレプリケーションを、インターネット、またはパブリック ピアリングを使用した ExpressRoute 接続経由で実行できる場合、再保護とフェールバックには、データをレプリケートするためにサイト間 (S2S) VPN が必要です。 ネットワークは、Azure のフェールオーバーされた仮想マシンからオンプレミスの構成サーバーにアクセス (ping) できるように指定する必要があります。 フェールオーバーされた仮想マシンの Azure ネットワークにプロセス サーバーをデプロイすることもできます。 このプロセス サーバーも、オンプレミスの構成サーバーと通信できる必要があります。

### <a name="when-should-i-install-a-process-server-in-azure"></a>Azure にプロセス サーバーをインストールするタイミング


再保護の対象となる Azure 上の仮想マシンは、レプリケーション データをプロセス サーバーに送信します。 Azure 上の仮想マシンからプロセス サーバーにアクセスできるようにネットワークを設定する必要があります。

Azure でプロセス サーバーをデプロイしたり、フェールオーバーの際に使用した既存のプロセス サーバーを使用したりできます。 考慮すべき重要な点は、Azure 上の仮想マシンからプロセス サーバーにデータを送信するときの待ち時間です。

ExpressRoute 接続を設定した場合は、仮想マシンとプロセス サーバー間の待ち時間が短いため、オンプレミスのプロセス サーバーを使用してデータを送信できます。

 ![Expressroute のアーキテクチャ ダイアグラム](./media/site-recovery-failback-azure-to-vmware-classic/architecture.png)



ただし、使用できるのが S2S VPN のみの場合は、Azure でプロセス サーバーをデプロイすることをお勧めします。

 ![VPN のアーキテクチャ ダイアグラム](./media/site-recovery-failback-azure-to-vmware-classic/architecture2.png)


レプリケーションは、S2S VPN または、ExpressRoute ネットワークのプライベート ピアリングを介してのみ実行されることに注意してください。 そのネットワーク チャネルで十分な帯域幅を使用できることを確認してください。

Azure のプロセス サーバーのインストール方法について詳しくは、[こちら](site-recovery-vmware-setup-azure-ps-resource-manager.md)をご覧ください。

### <a name="what-are-the-ports-to-be-open-on-different-components-so-that-reprotect-can-work"></a>再保護が正常に機能するために各コンポーネントで開放されているべきポート

![すべてのポートのフェールオーバー/フェールバック](./media/site-recovery-failback-azure-to-vmware-classic/Failover-Failback.png)

### <a name="which-master-target-server-should-be-used-for-reprotect"></a>再保護に使用するマスター ターゲット サーバー
オンプレミスのマスター ターゲット サーバーは、プロセス サーバーからデータを受信してオンプレミスの仮想マシンの VMDK に書き込むために必要です。 Windows 仮想マシンを保護する場合、Windows マスター ターゲット サーバーが必要になります。 オンプレミスのプロセス サーバーとマスター ターゲットを再利用できます<!-- !todo component -->。 Linux 仮想マシンの場合は、追加のオンプレミスの Linux マスター ターゲットを設定する必要があります。


次のリンクをクリックして、マスター ターゲット サーバーをインストールする方法を確認してください。

* [Windows マスター ターゲット サーバーをインストールする方法](site-recovery-vmware-to-azure.md#run-site-recovery-unified-setup)
* [Linux マスター ターゲット サーバーをインストールする方法](site-recovery-how-to-install-linux-master-target.md)


#### <a name="common-things-to-check-after-completing-installation-of-the-master-target-server"></a>マスター ターゲット サーバーのインストール完了後の一般的なチェック事項

* 仮想マシンが vCenter サーバー上でオンプレミスに存在する場合、マスター ターゲット サーバーには、オンプレミスの仮想マシンの VMDK へのアクセス権が必要になります。 アクセス権は、レプリケートされたデータを仮想マシンのディスクに書き込むために必要です。 オンプレミスの仮想マシンのデータ ストアが、読み取りと書き込みアクセス権のあるマスター ターゲットのホストにマウントされていることを確認します。

* 仮想マシンが vCenter サーバー上でオンプレミスに存在しない場合、再保護時に新しい仮想マシンを作成する必要があります。 マスター ターゲットを作成する ESX ホストでこの仮想マシンは作成されます。 そのため、希望するホストにフェールバック仮想マシンが作成されるように、ESX ホストは慎重に選択します。

* *マスター ターゲット サーバーにストレージ vMotion を使用することはできません*。 そのようにした場合、フェールバックが失敗する可能性があります。 ディスクが利用可能にならないため、この仮想マシンは起動しません。

* 既存の Windows マスター ターゲット サーバーに新しいドライブを追加する必要があります。 このドライブはリテンション ドライブと呼ばれます。 新しいディスクを追加し、ドライブをフォーマットします。 リテンション ドライブは、仮想マシンがオンプレミス サイトにレプリケートされたときの特定の時点で停止するために使用します。 リテンション ドライブの条件の一部を以下に示します。これらの条件を満たしていない場合、このドライブはマスター ターゲット サーバーに表示されません。

   * ボリュームを他の目的 (レプリケーションのターゲットなど) に使用することはできません。

   * ボリュームをロック モードにすることはできません。

   * ボリュームをキャッシュ ボリュームにすることはできません。 そのボリュームにマスター ターゲット インストールが存在してはいけません。 プロセス サーバーとマスター ターゲットのカスタム インストール ボリュームは、リテンション ボリュームになる資格はありません。 プロセス サーバーとマスター ターゲットがボリュームにインストールされている場合、そのボリュームがマスター ターゲットのキャッシュ ボリュームになります。

   * ボリュームのファイル システムの種類として、FAT および FAT32 は使用できません。

   * ボリュームの容量は 0 以外である必要があります。

   * Windows の既定のリテンション ボリュームは R ボリュームです。

   * Linux の既定のリテンション ボリュームは /mnt/retention/ です。

* フェールオーバーした Linux 仮想マシンには、Linux マスター ターゲット サーバーが必要になります。 フェールオーバーした Windows 仮想マシンには、Windows マスター ターゲット サーバーが必要になります。

* VMware ツールをマスター ターゲット サーバーにインストールします。 VMware ツールがない場合、マスター ターゲットの ESXi ホスト上のデータストアを検出できません。

* vCenter プロパティを使用してマスター ターゲット仮想マシンの disk.EnableUUID=true パラメーターを有効にします。 <!-- !todo Needs link. -->

* マスター ターゲットには、仮想マシン ファイル システム (VMFS) データストアが少なくとも 1 つ接続されている必要があります。 まったく存在しない場合、再保護ページに入力する**データストア**が空となり先に進めません。

* マスター ターゲット サーバーのディスクにはスナップショットが存在してはいけません。 スナップショットが存在すると、再保護とフェールバックが失敗します。

* 準仮想化 SCSI コントローラーをマスター ターゲットに割り当てることはできません。 LSI Logic コントローラー以外は使用できません。 LSI Logic コントローラーがないと再保護は失敗します。

<!--
### Failback policy
To replicate back to on-premises, you will need a failback policy. This policy get automatically created when you create a forward direction policy. Note that

1. This policy gets auto associated with the configuration server during creation.
2. This policy is not editable.
3. The set values of the policy are (RPO Threshold = 15 Mins, Recovery Point Retention = 24 Hours, App Consistency Snapshot Frequency = 60 Mins)
   ![](./media/site-recovery-failback-azure-to-vmware-new/failback-policy.png)

-->

## <a name="steps-to-reprotect"></a>再保護の手順

オンプレミスのマスター ターゲット (Windows または [Linux](site-recovery-how-to-install-linux-master-target.md)) と Azure に[プロセス サーバー](site-recovery-vmware-setup-azure-ps-resource-manager.md)がインストールされていることを再保護の前に確認してください。

> [!NOTE]
> Azure の仮想マシンが起動した後、エージェントが構成サーバーに再度登録されるまでにしばらく時間がかかります (最大 15 分)。 この間は再保護が失敗し、エージェントがインストールされていないというエラー メッセージが表示されます。 数分待ってから再保護操作をやり直してください。



1. **[コンテナー]** > **[レプリケートされたアイテム]** で、フェールオーバーされた仮想マシンを右クリックして **[再保護]** をクリックします。 マシンをクリックし、コマンド ボタンから **[再保護]** を選択することもできます。
2. ブレードで、保護の方向として **[Azure からオンプレミスへ]** が既に選択されていることを確認します。
3. **[マスター ターゲット サーバー]** と **[プロセス サーバー]** で、オンプレミスのマスター ターゲット サーバーとプロセス サーバーを選択します。
4. オンプレミスのディスクの復旧先となる**データストア**を選択します。 このオプションは、オンプレミスの仮想マシンを削除し、新しいディスクを作成する必要がある場合に使用します。 ディスクが既に存在する場合、このオプションは無視されますが、値は指定しておく必要があります。
5. リテンション ドライブを選択します。
6. フェールバック ポリシーが自動的に選択されます。
7. **[OK]** をクリックして再保護を開始すると、Azure からオンプレミス サイトに仮想マシンをレプリケートするジョブが開始されます。 進行状況は **[ジョブ]** タブで追跡できます。

別の場所に復元する場合 (オンプレミスの仮想マシンが削除されているとき) は、マスター ターゲット サーバー用に構成したリテンション ドライブとデータストアを選択します。 オンプレミス サイトにフェールバックした場合、フェールバック保護計画の VMware 仮想マシンはマスター ターゲット サーバーと同じデータストアを使用します。 vCenter に新しい仮想マシンが作成されます。
Azure 上の仮想マシンを既存のオンプレミスの仮想マシンに復旧する場合、マスター ターゲット サーバーの ESXi ホストに対する読み取り/書き込みアクセス権のあるオンプレミスの仮想マシンのデータストアをマウントする必要があります。
    ![[再保護] ダイアログ ボックス](./media/site-recovery-failback-azure-to-vmware-new/reprotectinputs.png)

また、復旧計画のレベルで再保護を実行することもできます。 レプリケーション グループを再保護するには、復旧計画を使用する必要があります。 復旧計画を使用して再保護するときは、すべての保護対象コンピューターに値を指定する必要があります。

> [!NOTE]
> レプリケーション グループは、同じマスター ターゲットを使用して保護する必要があります。 別のマスター ターゲット サーバーを使用して保護されている場合、共通の時点を提供できません。


正常に再保護できると、仮想マシンは保護された状態になります。

## <a name="next-steps"></a>次のステップ

仮想マシンが保護された状態になると、フェールバックを開始できます。 フェールバックによって Azure の仮想マシンがシャットダウンされ、オンプレミスの仮想マシンが起動されます。 そのため、アプリケーションに短時間のダウンタイムが発生します。 したがって、アプリケーションがダウンタイムを許容できるように、フェールバックの時刻を選択します。

[仮想マシンのフェールバックを開始する手順](site-recovery-how-to-failback-azure-to-vmware.md#steps-to-fail-back)

## <a name="common-issues"></a>一般的な問題

* テンプレートを使用して仮想マシンを作成した場合、各仮想マシンのディスクに一意の UUID が割り当てられていることを確認してください。 オンプレミスの仮想マシンとマスター ターゲットを同じテンプレートから作成したために、それぞれの UUID が衝突した場合、再保護が失敗します。 同じテンプレートから作成したものではない別のマスター ターゲットをデプロイする必要があります。
* 読み取り専用ユーザー vCenter の検出を実行し、仮想マシンを保護すると、適切に保護され、フェールオーバーが機能します。 再保護中は、データストアが検出できないため、フェールオーバーは失敗します。 症状としては、再保護中はデータストアの一覧が表示されません。 この問題を解決するには、適切な権限を持つアカウントを使用して vCenter 資格情報を更新し、ジョブを再試行します。 詳細については、「[Azure Site Recovery を使用して VMware 仮想マシンと物理サーバーを Azure にレプリケートする](site-recovery-vmware-to-azure-classic.md#vmware-permissions-for-vcenter-access)」を参照してください。
* Linux 仮想マシンをフェールバックしてオンプレミスで実行すると、ネットワーク マネージャー パッケージがマシンからアンインストールされていることを確認できます。 このアンインストールは、Azure で仮想マシンが復旧されるときに、ネットワーク マネージャー パッケージが削除されるために発生します。
* Linux 仮想マシンが静的 IP アドレスで構成されているときに Azure にフェールオーバーされると、IP アドレスは DHCP から取得されます。 オンプレミスにフェールオーバーすると、仮想マシンは引き続き DHCP を使用して、IP アドレスを取得します。 必要であれば、手動でコンピューターにサインインし、IP アドレスを静的アドレスに設定し直します。 Windows 仮想マシンは、同じ静的 IP を再度取得できます。
* ESXi 5.5 Free エディションまたは vSphere 6 Hypervisor Free エディションを使用すると、フェールオーバーは成功しますが、フェールバックが失敗します。 フェールバックを有効にするには、いずれかのプログラムの評価ライセンスにアップグレードしてください。
* プロセス サーバーから構成サーバーにアクセスできない場合は、Telnet を使用して、構成サーバー コンピューターのポート 443 への接続を確認します。 プロセス サーバーから構成サーバーに対して ping を試すこともできます。 プロセス サーバーが構成サーバーに接続されるときは、ハートビートも必要です。
* 代替の vCenter にフェールバックする場合は、新しい vCenter が検出されること、またマスター ターゲット サーバーも検出されることを確認してください。 典型的な症状は、データストアにアクセスできないか、**[再保護]** ダイアログに表示されないことです。
* 物理オンプレミス サーバーとして保護されている Windows Server 2008 R2 SP1 サーバーは、Azure からオンプレミス サイトにフェールバックすることができません。

