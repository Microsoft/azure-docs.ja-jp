---
title: Azure Disk Encryption (ADE) が有効な VM のレプリケーションを Azure Site Recovery で構成する | Microsoft Docs
description: この記事では、Site Recovery を使用して、1 つの Azure リージョンから別のリージョンへの ADE VM のレプリケーションを構成する方法について説明します。
services: site-recovery
author: sujayt
manager: rochakm
ms.service: site-recovery
ms.topic: article
ms.date: 04/08/2019
ms.author: sutalasi
ms.openlocfilehash: b3e997a37bb5d030d559b6771b2c0e2f74cc62ab
ms.sourcegitcommit: 62d3a040280e83946d1a9548f352da83ef852085
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/08/2019
ms.locfileid: "59277693"
---
# <a name="replicate-azure-disk-encryption-ade-enabled-virtual-machines-to-another-azure-region"></a>Azure Disk Encryption (ADE) が有効な仮想マシンを別の Azure リージョンにレプリケートする

この記事では、1 つの Azure リージョンから別のリージョンへの、Azure Disk Encryption (ADE) が有効な VM のレプリケーションを有効にする方法について説明します。

>[!NOTE]
>現在、Azure Site Recovery では、Windows OS を実行していて、[Azure AD アプリでの暗号化が有効にされている](https://aka.ms/ade-aad-app) Azure VM のみがサポートされています。
>

## <a name="required-user-permissions"></a>必要なユーザー アクセス許可
Azure Site Recovery では、ターゲット リージョンにキー コンテナーを作成し、キーをそのリージョンにコピーするためのアクセス許可を、ユーザーが持っている必要があります。

ポータルで ADE VM のレプリケーションを有効にするには、ユーザーに以下のアクセス許可が必要です。
- Key Vault のアクセス許可
    - list
    - Create
    - 取得

-   Key Vault シークレットのアクセス許可
    - List
    - Create
    - 取得

- Key Vault キーのアクセス許可 (ディスク暗号化キーを暗号化するために VM でキー暗号化キーが使用される場合にのみ必須)
    - List
    - 取得
    - Create
    - 暗号化
    - 復号化

ポータルの Key Vault リソースに移動して、必要なアクセス許可をユーザーに追加することで、アクセス許可を管理できます。 例: 以下のステップ バイ ステップ ガイドでは、ソース リージョンにあるキー コンテナー "ContosoWeb2Keyvault" に対してそれを有効にする方法を示します。


-  [ホーム] > [キー コンテナー] > ContosoWeb2KeyVault > [アクセス ポリシー] の順に移動します

![キー コンテナーのアクセス許可](./media/azure-to-azure-how-to-enable-replication-ade-vms/key-vault-permission-1.png)



- ユーザー アクセス許可が何もないのがわかるので、[新規追加] をクリックし、ユーザーとアクセス許可を選択して、上記のアクセスを追加します

![キー コンテナーのアクセス許可](./media/azure-to-azure-how-to-enable-replication-ade-vms/key-vault-permission-2.png)

ディザスター リカバリー (DR) を有効にしているユーザーに、キーをコピーするために必要なアクセス許可がない場合は、適切なアクセス許可を持つセキュリティ管理者に以下のスクリプトを提供し、暗号化シークレットおよび暗号化キーをターゲット リージョンにコピーできます。

アクセス許可の問題のトラブルシューティングについては、[こちらの記事](#trusted-root-certificates-error-code-151066)をご覧ください。
>[!NOTE]
>ポータルで ADE VM のレプリケーションを有効にするには、少なくともキー コンテナー、シークレット、キーに対する "一覧表示" アクセス許可が必要です
>

## <a name="copy-ade-keys-to-dr-region-using-powershell-script"></a>PowerShell スクリプトを使用して ADE キーを DR リージョンにコピーする

1. [このリンク](https://aka.ms/ade-asr-copy-keys-code)をクリックして、ブラウザー ウィンドウで未加工の "CopyKeys" スクリプト コードを開きます。
2. スクリプトをファイルにコピーして、そのファイルの名前を "Copy-keys.ps1" にします。
2. Windows PowerShell アプリケーションを開いて、ファイルが存在するフォルダーの場所に移動します。
3. "Copy-keys.ps1" を起動します。
4. Azure のログイン資格情報を入力します。
5. お客様の VM の **Azure サブスクリプション**を選択します。
6. リソース グループが読み込まれるのを待ってから、VM の**リソース グループ**を選択します。
7. 表示された VM の一覧から VM を選択します。 Azure Disk Encryption が有効な VM のみが一覧に表示されます。
8. **ターゲットの場所**を選択します。
9. **[ディスクの暗号化のキー コンテナー]**:既定では、Azure Site Recovery によって、ソース VM ディスク暗号化キーに基づく "asr" というサフィックスが付いた名前の新しいキー コンテナーが、ターゲット リージョン内に作成されます。 Azure Site Recovery によって作成されたキー コンテナーが既に存在する場合は、それが再利用されます。 必要な場合は一覧から別のキー コンテナーを選択できます。
10. **[キー暗号化キー コンテナー]**:既定では、Azure Site Recovery によって、ソース VM キー暗号化キーに基づく "asr" というサフィックスが付いた名前の新しいキー コンテナーが、ターゲット リージョン内に作成されます。 Azure Site Recovery によって作成されたキー コンテナーが既に存在する場合は、それが再利用されます。 必要な場合は一覧から別のキー コンテナーを選択できます。

## <a name="enable-replication"></a>レプリケーションを有効にする

この手順では、プライマリ Azure リージョンが東アジアで、セカンダリ リージョンが東南アジアであることを前提としています。

1. コンテナーで、**[+レプリケート]** をクリックします。
2. 以下のフィールドに注意してください。
    - **ソース**:VM の起点。この例では **Azure** です。
    - **ソースの場所**:仮想マシンの保護を行う Azure リージョン。 ここでは、ソースの場所は "東アジア" です
    - **デプロイ モデル**:ソース マシンの Azure デプロイ モデル。
    - **ソース サブスクリプション**:ソース仮想マシンが属しているサブスクリプション。 これは、Recovery Services コンテナーが存在する同じ Azure Active Directory テナント内のどのサブスクリプションでもかまいません。
    - **リソース グループ**:ソース仮想マシンが属しているリソース グループ。 選択したリソース グループのすべての VM が、次の手順で保護対象として表示されます。

3. **[仮想マシン]、[仮想マシンの選択]** の順に移動し、レプリケートする各 VM をクリックして選択します。 選択できるのは、レプリケーションを有効にできるマシンのみです。 次に、 **[OK]** をクリックします

4. **[設定]** では、オプションで、以下のターゲット サイトの設定を構成できます。

    - **ターゲットの場所**:ソース仮想マシンのデータがレプリケートされる場所。 選択したマシンの場所に応じて、適切なターゲット リージョンの一覧が表示されます。 ターゲットの場所は、Recovery Services コンテナーと同じ場所にすることをお勧めします。
    - **ターゲット サブスクリプション**:ディザスター リカバリーに使用されるターゲット サブスクリプション。 既定では、ターゲット サブスクリプションはソース サブスクリプションと同じになります。
    - **ターゲット リソース グループ**:レプリケートされたすべての仮想マシンが属するリソース グループ。 既定では、Azure Site Recovery によって、名前に "asr" サフィックスが付いた新しいリソース グループがターゲット リージョンに作成されます。 Azure Site Recovery によって作成されるリソース グループが既に存在する場合は、そのグループが再利用されます。 以下のセクションで示すように、それをカスタマイズすることもできます。 ターゲット リソース グループの場所は、ソース仮想マシンがホストされているリージョンを除き、どの Azure リージョンでも構いません。
    - **ターゲット仮想ネットワーク**:既定では、名前に "asr" サフィックスが付いた新しい仮想ネットワークが、Site Recovery によってターゲット リージョンに作成されます。 これはソース ネットワークにマップされ、今後の保護で使用されます。 ネットワーク マッピングの詳細については、[こちら](site-recovery-network-mapping-azure-to-azure.md)を参照してください。
    - **ターゲット ストレージ アカウント (ソース VM でマネージド ディスクが使用されていない場合)**:既定では、Site Recovery によって、ソース VM ストレージと同じ構成で新しいターゲット ストレージ アカウントが作成されます。 ストレージ アカウントが既に存在する場合は、再利用されます。
    - **レプリカ マネージド ディスク (ソース VM でマネージド ディスクが使用されている場合)**:Site Recovery によってターゲット リージョンに新しいレプリカ マネージド ディスクが作成され、ソース VM のマネージド ディスクと同じストレージ タイプ (Standard または Premium) でソース VM のマネージド ディスクがミラーリングされます。
    - **キャッシュ ストレージ アカウント**:Site Recovery では、キャッシュ ストレージと呼ばれる追加のストレージ アカウントがソース リージョンに必要です。 ソース VM で行われてた変更はすべて追跡され、キャッシュ ストレージ アカウントに送信されてから、ターゲットの場所にレプリケートされます。
    - **可用性セット**:既定では、名前に "asr" サフィックスが付いた新しい可用性セットが、Azure Site Recovery によってターゲット リージョンに作成されます。 Azure Site Recovery によって作成された可用性セットが既に存在する場合は、それが再利用されます。
    - **[ディスクの暗号化のキー コンテナー]**:既定では、Azure Site Recovery によって、ソース VM ディスク暗号化キーに基づく "asr" というサフィックスが付いた名前の新しいキー コンテナーが、ターゲット リージョン内に作成されます。 Azure Site Recovery によって作成されたキー コンテナーが既に存在する場合は、それが再利用されます。
    - **[キー暗号化キー コンテナー]**:既定では、Azure Site Recovery によって、ソース VM キー暗号化キーに基づく "asr" というサフィックスが付いた名前の新しいキー コンテナーが、ターゲット リージョン内に作成されます。 Azure Site Recovery によって作成されたキー コンテナーが既に存在する場合は、それが再利用されます。
    - **レプリケーション ポリシー**:復旧ポイントのリテンション履歴と、アプリ整合性スナップショットの頻度の設定を定義します。 既定では、Azure Site Recovery によって、既定の設定 (復旧ポイントのリテンション期間が "24 時間"、アプリ整合性スナップショットの頻度が "60 分") で新しいレプリケーション ポリシーが作成されます。



## <a name="customize-target-resources"></a>ターゲット リソースのカスタマイズ

Site Recovery によって使用される既定のターゲット設定を変更することができます。


1. [ターゲット サブスクリプション] の横にある **[カスタマイズ]** をクリックして、既定のターゲット サブスクリプションを変更します。 同じ Azure Active Directory (AAD) テナントで使用できるすべてのサブスクリプションの一覧からサブスクリプションを選択します。

2. [リソース グループ、ネットワーク、ストレージ、可用性セット] の横にある **[カスタマイズ]** をクリックして、以下の既定の設定を変更します。
    - **ターゲット リソース グループ**で、サブスクリプションのターゲットの場所にあるすべてのリソース グループの一覧から、リソース グループを選択します。
    - **ターゲット仮想ネットワーク**で、ターゲットの場所にあるすべての仮想ネットワークの一覧から、ネットワークを選択します。
    - **可用性セット**では、可用性セットの設定を、それらがソース リージョンの可用性セットの一部であれば、VM に追加できます。
    - **ターゲット ストレージ アカウント**で、使用するアカウントを選択します。


2. [暗号化設定] の横にある **[カスタマイズ]** をクリックして、以下の既定の設定を変更します。
   - **[ターゲットのディスク暗号化キー コンテナー]** で、サブスクリプションのターゲットの場所にあるすべてのキー コンテナーの一覧から、ターゲットのディスク暗号化キー コンテナーを選択します。
     - **[ターゲットのキー暗号化キー コンテナー]** で、サブスクリプションのターゲットの場所にあるすべてのキー コンテナーの一覧から、ターゲットのキー暗号化キー コンテナーを選択します。

3. **[Create target resource]\(ターゲット リソースを作成する\)** > **[レプリケーションを有効にする]** の順にクリックします。
4. VM のレプリケーションが有効になったら、**[レプリケートされたアイテム]** で VM の正常性の状態を確認できます。

>[!NOTE]
>初期レプリケーションの間は、状態の更新に少し時間がかかり、進捗が見られない場合があります。 **[更新]** ボタンをクリックして、最新の状態を取得します。
>

## <a name="update-target-vm-encryption-settings"></a>ターゲット VM の暗号化設定を更新する
以下のシナリオでは、ターゲット VM の暗号化設定の更新が必要になります。
  - VM で Site Recovery レプリケーションを有効にして、後日、ソース VM で Azure Disk Encryption (ADE) を有効にした
  - VM で Site Recovery レプリケーションを有効にして、後日、ソース VM でディスク暗号化キー、キー暗号化キーまたはその両方を変更した

[こちらのスクリプト](#copy-ade-keys-to-dr-region-using-powershell-script)を使用して暗号化キーをターゲット リージョンにコピーしたうえで、**[Recovery Services コンテナー]、[レプリケートされたアイテム]、[プロパティ]、[コンピューティングとネットワーク]** の順に移動してターゲットの暗号化設定を更新できます。

![update-ade-settings](./media/azure-to-azure-how-to-enable-replication-ade-vms/update-ade-settings.png)

## <a name="trusted-root-certificates-error-code-151066"></a>Azure 間 VM レプリケーションの間のキー コンテナーのアクセス許可の問題のトラブルシューティング

**原因 1:** ターゲット リージョンから選択した作成済みのキー コンテナーに、必要なアクセス許可がない可能性があります。
Azure Site Recovery で作成するのではなく、ターゲット リージョンに既に作成されているキー コンテナーを選択する場合は、 キー コンテナーに前述の必要なアクセス許可があることを確認します。</br>
*例*: ユーザーがレプリケートしようとしている VM には、ソース リージョン上に "ContososourceKeyvault" というキー コンテナーがあります。
ユーザーは、ソース リージョンのキー コンテナーに対するすべてのアクセス許可を持っていますが、保護の間に選択した作成済みのキー コンテナー "ContosotargetKeyvault" に対してはアクセス許可がないため、保護でエラーがスローされます。</br>
**修正方法:** [ホーム] > [キー コンテナー] > ContososourceKeyvault > [アクセス ポリシー] に移動し、上記のようにアクセス許可を追加します。

**原因 2:** ターゲット リージョンから選択した作成済みのキー コンテナーに、解読 - 暗号化アクセス許可がない可能性があります。
Azure Site Recovery で作成するのではなく、ターゲット リージョンに既に作成されているキー コンテナーを選択する場合は、 ソース リージョンでもキーを暗号化している場合は、ユーザーに解読 - 暗号化アクセス許可があることを確認します。</br>
*例*: ユーザーがレプリケートしようとしている VM には、ソース リージョン上に "ContososourceKeyvault" というキー コンテナーがあります。
ユーザーは、ソース リージョンのキー コンテナーに対するすべてのアクセス許可を持っていますが、保護の間に選択した作成済みのキー コンテナー "ContosotargetKeyvault" に対しては、解読と暗号化のためのアクセス許可がありません。</br>
**修正方法:** [ホーム] > [キー コンテナー] > ContososourceKeyvault > [アクセス ポリシー] に移動し、[キーのアクセス許可] > [暗号化操作] でアクセス許可を追加します。

## <a name="next-steps"></a>次の手順

テスト フェールオーバーの実行に関する[詳細を確認](site-recovery-test-failover-to-azure.md)する。
