---
title: Azure Site Recovery を使用して再保護とフェールバックのために VMware VM を準備する
description: Azure Site Recovery を使用してフェールオーバー後に VMware VM のフェールバックの準備をする
ms.topic: conceptual
ms.date: 12/24/2019
ms.openlocfilehash: 5a330f8cba31640d0116ca3d5ccab352ce5b3509
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/02/2020
ms.locfileid: "85847745"
---
# <a name="prepare-for-reprotection-and-failback-of-vmware-vms"></a>VMware VM の再保護とフェールバックの準備をする

オンプレミスの VMware VM または物理サーバーを Azure に[フェールオーバー](site-recovery-failover.md)した後、フェールオーバー後に作成された Azure VM が、オンプレミスサイトにレプリケートされるように再保護します。 Azure からオンプレミスへのレプリケーションを設定したら、準備ができたときに Azure からオンプレミスへのフェールオーバーを実行することでフェールバックできます。

続行する前に、Azure からオンプレミスのサイトにフェールバックする方法について、このビデオで簡単な概要をご確認ください。<br /><br />
> [!VIDEO https://channel9.msdn.com/Series/Azure-Site-Recovery/VMware-to-Azure-with-ASR-Video5-Failback-from-Azure-to-On-premises/player]

## <a name="reprotectionfailback-components"></a>再保護とフェールバック コンポーネント

再保護および Azure からフェールバックするには、複数のコンポーネントと設定を準備する必要があります。

**コンポーネント**| **詳細**
--- | ---
**オンプレミスの構成サーバー** | オンプレミスの構成サーバーが実行されていて、Azure に接続されている必要があります。<br/><br/> フェールバック先の VM が、構成サーバー データベースに存在している必要があります。 障害が構成サーバーに影響する場合は、フェールバックが正常に機能するように、同じ IP アドレスを使用して復元します。<br/><br/>  レプリケートされたマシンの IP アドレスがフェールオーバー時に保持されていた場合は、Azure VM マシンと構成サーバーのフェールバック NIC の間にサイト間接続 (または ExpressRoute 接続) を確立する必要があります。 保持された IP アドレスに対し、構成サーバーでは 2 つの NIC が必要です。1 つはソース マシン接続用で、もう 1 つは Azure フェールバック接続用です。 これにより、ソースとフェールオーバーされた VM のサブネット アドレス範囲が重複するのが回避されます。
**Azure のプロセス サーバー** | オンプレミスのサイトにフェールバックするには、Azure 内にプロセス サーバーが必要です。<br/><br/> プロセス サーバーでは、保護された Azure VM からデータを受け取り、そのデータがオンプレミス サイトに送信されます。<br/><br/> プロセス サーバーと保護された VM の間には、待機時間の短いネットワークが必要なため、レプリケーションのパフォーマンスを向上させるために、Azure にプロセス サーバーをデプロイすることをお勧めします。<br/><br/> 概念実証の場合、オンプレミスのプロセス サーバーと、プライベート ピアリングを使用した ExpressRoute を利用できます。<br/><br/> プロセス サーバーは、フェールオーバーされた VM が配置されている Azure ネットワーク内に存在している必要があります。 プロセス サーバーでは、オンプレミスの構成サーバーおよびマスター ターゲット サーバーと通信できる必要もあります。
**独立したマスター ターゲット サーバー** | マスター ターゲット サーバーでは、フェールバック データを受信します。既定では、Windows マスター ターゲット サーバーは、オンプレミスの構成サーバーで実行されます。<br/><br/> マスター ターゲット サーバーには、最大 60 のディスクを接続できます。 フェールバックされる VM に合計で 60 を超えるディスクが含まれているか、大量のトラフィックをフェールバックしている場合は、フェールバック用に別のマスター ターゲット サーバーを作成します。<br/><br/> マルチ VM の整合性のためにマシンがレプリケーション グループにまとめられている場合は、VM をすべて Windows にするか、すべて Linux にする必要があります。 なぜですか? レプリケーション グループ内のすべての VM が同じマスター ターゲット サーバーを使用する必要があり、マスター ターゲット サーバーには、レプリケートされたマシンと同じ (またはより新しいバージョンの) オペレーティング システムが必要です。<br/><br/> マスター ターゲット サーバーのディスクにはスナップショットを含めないでください。そうしないと、再保護とフェールバックが機能しません。<br/><br/> 準仮想化 SCSI コントローラーをマスター ターゲットに割り当てることはできません。 LSI Logic コントローラー以外は使用できません。 LSI Logic コントローラがない場合、再保護は失敗します。
**フェールバック レプリケーション ポリシー** | オンプレミス サイトにもう一度レプリケートするには、フェールバック ポリシーが必要です。 このポリシーは、Azure へのレプリケーション ポリシーを作成するときに自動的に作成されます。<br/><br/> このポリシーは自動的に構成サーバーに関連付けられます。 RPO しきい値は 15 分、復旧ポイントのリテンション期間は 24 時間、アプリ整合性スナップショットの頻度は 60 分に設定されています。 このポリシーは編集できません。 
**サイト間 VPN または ExpressRoute プライベート ピアリング** | 再保護とフェールバックには、データをレプリケートするためのサイト間 VPN 接続または ExpressRoute プライベート ピアリングが必要です。 


## <a name="ports-for-reprotectionfailback"></a>再保護とフェールバックのポート

再保護とフェールバックには、複数のポートが開いている必要があります。 次の図は、ポートと、再保護およびフェールバックのフローを示しています。

![フェールオーバーおよびフェールバック用のポート](./media/vmware-azure-reprotect/failover-failback.png)


## <a name="deploy-a-process-server-in-azure"></a>Azure でプロセス サーバーをデプロイする

1. フェールバックのために Azure で[プロセス サーバーを設定](vmware-azure-set-up-process-server-azure.md)します。
2. Azure VM がプロセス サーバーに到達できることを確認します。 
3. サイト間 VPN 接続または ExpressRoute プライベート ピアリング ネットワークに、プロセス サーバーからオンプレミス サイトにデータを送信するのに十分な帯域幅があることを確認します。

## <a name="deploy-a-separate-master-target-server"></a>別のマスター ターゲット サーバーをデプロイする

1. マスター ターゲット サーバーの[要件と制限事項](#reprotectionfailback-components)をメモします。
2. 再保護してフェールバックする VM のオペレーティング システムと一致するように、[Windows](site-recovery-plan-capacity-vmware.md#deploy-additional-master-target-servers) または [Linux](vmware-azure-install-linux-master-target.md) のマスター ターゲット サーバーを作成します。
3. マスター ターゲット サーバーに Storage vMotion を使用しないようにしてください。使用すると、フェールバックが失敗する可能性があります。 ディスクが VM マシンで使用できないため、その VM マシンが起動できません。
    - これを回避するには、vMotion の一覧からマスター ターゲット サーバーを除外します。
    - マスター ターゲットで再保護の後に Storage vMotion タスクが実行される場合、そのマスター ターゲット サーバーに接続されている保護された VM ディスクは vMotion タスクのターゲットに移行されます。 この後にフェールバックしようとすると、ディスクが見つからないため、ディスクの取り外しは失敗します。 その後、ストレージ アカウントでディスクを見つけるのは困難です。 この問題が発生した場合は、それらを手動で検索し、VM に接続します。 その後に、オンプレミスの VM を起動できます。

4. 既存の Windows マスター ターゲット サーバーにリテンション ドライブを追加します。 新しいディスクを追加し、ドライブをフォーマットします。 リテンション ドライブは、VM がオンプレミス サイトにレプリケートされたときの特定の時点で停止するために使用します。 次の条件に注意してください。 これらを満たしていない場合、ドライブはマスター ターゲット サーバーに表示されません。
    - ボリュームが他のどの目的 (レプリケーションのターゲットなど) にも使用されず、ロック モードになっていない。
    - ボリュームがキャッシュ ボリュームではない。 プロセス サーバーとマスター ターゲットのカスタム インストール ボリュームは、リテンション ボリュームになる資格がありません。 プロセス サーバーとマスター ターゲットがボリュームにインストールされている場合、そのボリュームがマスター ターゲットのキャッシュ ボリュームになります。
    - ボリュームのファイル システムの種類が FAT および FAT32 ではない。
    - ボリュームの容量がゼロ以外である。
    - Windows の既定のリテンション ボリュームは R ボリュームです。
    - Linux の既定のリテンション ボリュームは /mnt/retention/ です。

5. 既存のプロセス サーバーを使用している場合は、ドライブを追加します。 新しいドライブは、前の手順の要件を満たしている必要があります。 リテンション ドライブが存在しない場合、そのドライブは、ポータル上の選択ドロップダウン リストに表示されません。 オンプレミスのマスター ターゲットにドライブを追加した後、そのドライブがポータル上の選択リストに表示されるまでに最大 15 分かかります。 15 分経ってもドライブが表示されない場合は、構成サーバーを更新することができます。
6. マスター ターゲット サーバーに VMware ツールまたは open-vm-tools をインストールします。 ツールがない場合、マスター ターゲットの ESXi ホスト上のデータストアを検出できません。
7. VMware でマスター ターゲット VM の構成パラメーターに disk.EnableUUID=true を設定します。 この行が存在しない場合は追加してください。 この設定は、一貫性のある UUID を VMDK に提供することで適切なマウントが実行されるようにするために必要です。
8. vCenter Server のアクセス要件を確認します。
    - フェールバック先の VM が VMware vCenter Server によって管理される ESXi ホスト上にある場合、レプリケートされたデータを仮想マシンのディスクに書き込むには、マスター ターゲット サーバーにオンプレミスの VM 仮想マシン ディスク (VMDK) ファイルへのアクセス権が必要です。 オンプレミスの VM データストアが、読み取りと書き込みアクセス権のあるマスター ターゲットのホストにマウントされていることを確認します。
    - VM が VMware vCenter Server で管理されている ESXi ホスト上にない場合、再保護時に Site Recovery サービスによって新しい VM が作成されます。 この VM は、マスター ターゲット サーバー VM を作成する ESXi ホスト上に作成されます。 ESXi ホストを慎重に選択して、必要なホスト上に VM を作成します。 VM のハード ディスクは、マスター ターゲット サーバーが実行されているホストからアクセスできるデータストア内に配置されている必要があります。
    - オンプレミス VM がフェールバックのために既に存在している場合、フェールバックを実行する前に削除するという選択肢もあります。 このようにすると、フェールバックにより、マスター ターゲット ESXi ホストと同じホストに新しい VM が作成されます。 別の場所にフェールバックすると、オンプレミスのマスター ターゲット サーバーによって使用されるのと同じデータ ストアおよび同じ ESXi ホストにデータは復元されます。
9. VMware VM にフェールバックする物理マシンについては、マシンを再保護する前に、マスター ターゲット サーバーが実行されているホストの検出を完了する必要があります。
10. マスター ターゲット VM がある ESXi ホストに、少なくとも 1 つの仮想マシン ファイル システム (VMFS) データストアが接続されていることを確認します。 VMFS データストアが接続されていない場合、再保護設定のデータストア入力が空になり、処理を続行できません。


## <a name="next-steps"></a>次のステップ

VM を[再保護](vmware-azure-reprotect.md)します。
