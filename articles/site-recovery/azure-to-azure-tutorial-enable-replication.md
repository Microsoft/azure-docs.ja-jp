---
title: Azure Site Recovery を使用して Azure VM のディザスター リカバリーを設定する
description: Azure Site Recovery サービスを使用して、別の Azure リージョンへの Azure VM のディザスター リカバリーを設定する方法について説明します。
ms.topic: tutorial
ms.date: 1/24/2020
ms.author: raynew
ms.custom: mvc
ms.openlocfilehash: 50bf1ec7f21ccbc3a3fa8feaea02e45bd08a158a
ms.sourcegitcommit: e71da24cc108efc2c194007f976f74dd596ab013
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/29/2020
ms.locfileid: "87421418"
---
# <a name="set-up-disaster-recovery-for-azure-vms"></a>Azure VM のディザスター リカバリーを設定する

[Azure Site Recovery](site-recovery-overview.md) サービスは、オンプレミスのマシンと Azure 仮想マシン (VM) のレプリケーション、フェールオーバー、およびフェールバックの管理と調整を行うことでディザスター リカバリー戦略に貢献します。

このチュートリアルでは、Azure VM を Azure リージョン間でレプリケートすることで Azure VM のディザスター リカバリーを設定する方法について説明します。 このチュートリアルでは、以下の内容を学習します。

> [!div class="checklist"]
> * Recovery Services コンテナーを作成する
> * ターゲット リソースの設定を確認する
> * VM の発信ネットワーク接続を設定する
> * VM のレプリケーションを有効にする

> [!NOTE]
> この記事では、ごく単純な設定でディザスター リカバリーをデプロイする手順について説明します。 設定のカスタマイズについては、[ハウツー ガイドのセクション](azure-to-azure-how-to-enable-replication.md)にある各記事を参照してください。

## <a name="prerequisites"></a>前提条件

このチュートリアルを完了するには、以下が必要です。

- [シナリオのアーキテクチャとコンポーネント](./azure-to-azure-architecture.md)を確認する。
- 開始する前に、[サポート要件](./azure-to-azure-support-matrix.md)を確認する。

## <a name="create-a-recovery-services-vault"></a>Recovery Services コンテナーを作成する

任意のリージョン (ソース リージョンを除く) にコンテナーを作成します。

1. [Azure portal](https://portal.azure.com) にサインインします。
1. Azure portal メニュー上または **[ホーム]** ページから **[リソースの作成]** を選択します。 次に、 **[IT & Management Tools]\(IT と管理ツール\)**  >  **[Backup and Site Recovery]\(バックアップおよびサイトの回復\)** の順に選択します。
1. **[名前]** に、コンテナーを識別するフレンドリ名を入力します。 複数のサブスクリプションがある場合は、適切なものを選択します。
1. リソース グループを作成するか、既存のリソース グループを選択します。 Azure リージョンを指定します。 サポートされているリージョンを確認するには、[Azure Site Recovery の価格の詳細](https://azure.microsoft.com/pricing/details/site-recovery/)に関するページでご利用可能な地域をご覧ください。
1. ダッシュボードからコンテナーにアクセスするには、 **[ダッシュボードにピン留めする]** 、 **[作成]** の順に選択します。

   ![新しいコンテナー](./media/azure-to-azure-tutorial-enable-replication/new-vault-settings.png)

新しいコンテナーは、 **[ダッシュボード]** の **[すべてのリソース]** と、メインの **[Recovery Services コンテナー]** ページに追加されます。

## <a name="verify-target-resource-settings"></a>ターゲット リソースの設定を確認する

ターゲット リージョンについては、Azure サブスクリプションを確認してください。

- Azure サブスクリプションによって、ターゲット リージョンに VM を作成できることを確認します。 サポートに連絡して、必要なクォータを有効にしてください。
- サブスクリプションに、ソース VM と一致するサイズの VM をサポートするための十分なリソースがあることを確認します。 Site Recovery によって、ターゲット VM に対して同じサイズまたは最も近いサイズが選択されます。

## <a name="set-up-outbound-network-connectivity-for-vms"></a>VM の発信ネットワーク接続を設定する

Site Recovery が期待どおりに動作するには、レプリケートする VM からのアウトバウンド ネットワーク接続に変更を加える必要があります。

> [!NOTE]
> Site Recovery では、ネットワーク接続を制御するための認証プロキシの使用をサポートしていません。

### <a name="outbound-connectivity-for-urls"></a>URL に対する送信接続

アウトバウンド接続を制御するために URL ベースのファイアウォール プロキシを使用している場合、以下の URL へのアクセスを許可してください。

| **名前**                  | **商用**                               | **政府**                                 | **説明** |
| ------------------------- | -------------------------------------------- | ---------------------------------------------- | ----------- |
| ストレージ                   | `*.blob.core.windows.net`                  | `*.blob.core.usgovcloudapi.net`              | ソース リージョンのキャッシュ ストレージ アカウントに、VM からデータが書き込まれるよう許可します。 |
| Azure Active Directory    | `login.microsoftonline.com`                | `login.microsoftonline.us`                   | Site Recovery サービス URL に対する承認と認証を提供します。 |
| レプリケーション               | `*.hypervrecoverymanager.windowsazure.com` | `*.hypervrecoverymanager.windowsazure.com`   | VM と Site Recovery サービスの通信を許可します。 |
| Service Bus               | `*.servicebus.windows.net`                 | `*.servicebus.usgovcloudapi.net`             | VM による Site Recovery の監視および診断データの書き込みを許可します。 |

### <a name="outbound-connectivity-for-ip-address-ranges"></a>IP アドレス範囲に対する送信接続

ネットワーク セキュリティ グループ (NSG) を使用している場合、Azure Storage、Azure Active Directory、Site Recovery サービス、Site Recovery 監視を利用するための、サービスタグ ベースの NSG ルールを作成します。 [詳細については、こちらを参照してください](azure-to-azure-about-networking.md#outbound-connectivity-using-service-tags)。

## <a name="verify-azure-vm-certificates"></a>Azure VM の証明書の確認

レプリケートする VM に最新のルート証明書が存在することを確認します。 存在しない場合、セキュリティの制約上、その VM を Site Recovery に登録することはできません。

- Windows VM については、最新のすべての Windows 更新プログラムを VM にインストールして、すべての信頼されたルート証明書をマシンに用意します。 接続されていない環境の場合は、組織の標準の Windows Update プロセスおよび証明書更新プロセスに従ってください。
- Linux VM の場合は、Linux ディストリビューターから提供されるガイダンスに従って、VM で最新の信頼されたルート証明書と証明書失効リストを取得します。

## <a name="set-permissions-on-the-account"></a>アカウントのアクセス許可の設定

Azure Site Recovery には、Site Recovery の管理操作を制御するための組み込みロールが 3 つ用意されています。

- **Site Recovery 共同作成者** - このロールには、Recovery Services コンテナーでの Azure Site Recovery の操作の管理に必要なすべてのアクセス許可があります。 ただし、このロールを持つユーザーは、Recovery Services コンテナーの作成や削除、または他のユーザーへのアクセス権の割り当てを行うことはできません。 このロールは、アプリケーションまたは組織全体のディザスター リカバリーを有効にして管理できる、ディザスター リカバリー管理者に最も適しています。

- **Site Recovery オペレーター** - この役割には、フェールオーバーとフェールバックの操作を実行して管理するアクセス許可があります。 このロールのユーザーは、レプリケーションの有効化または無効化、コンテナーの作成または削除、新しいインフラストラクチャの登録、他のユーザーへのアクセス権の割り当てを行うことはできません。 このロールは、アプリケーション所有者および IT 管理者から指示されて、仮想マシンまたはアプリケーションをフェールオーバーできる、ディザスター リカバリー オペレーターに最も適しています。 障害が解決された後、ディザスター リカバリー オペレーターは仮想マシンを再び保護してフェールバックを行うことができます。

- **Site Recovery 閲覧者** - このロールには、すべての Site Recovery 管理操作を見るアクセス許可があります。 このロールは、保護の現在の状態を監視し、サポート チケットを発行できる、IT 監視担当役員に最も適しています。

[Azure 組み込みロール](../role-based-access-control/built-in-roles.md)の詳細をご覧ください。

## <a name="enable-replication-for-a-vm"></a>VM のレプリケーションを有効にする

レプリケーションを有効にする方法については、以下のセクションで説明します。

### <a name="select-the-source"></a>ソースを選択する

レプリケーションの設定を開始するには、Azure VM が実行されているソースを選択します。

1. **[Recovery Services コンテナー]** に移動し、コンテナー名、 **[+Replicate]\(+レプリケート\)** の順に選択します。
1. **[ソース]** で **[Azure]** を選択します。
1. **[ソースの場所]** で、現在 VM が実行されているソースの Azure リージョンを選択します。
1. 仮想マシンが実行されている**ソース サブスクリプション**を選択します。 これは、Recovery Services コンテナーが存在する同じ Azure Active Directory テナント内のどのサブスクリプションでもかまいません。
1. **[ソース リソース グループ]** を選択し、 **[OK]** を選択して設定を保存します。

   ![Set up source](./media/azure-to-azure-tutorial-enable-replication/source.png)

### <a name="select-the-vms"></a>VM を選択する

Site Recovery は、サブスクリプションとリソース グループ/クラウド サービスに関連付けられている VM の一覧を取得します。

1. **[仮想マシン]** で、レプリケートする VM を選択します。
1. **[OK]** を選択します。

### <a name="configure-replication-settings"></a>レプリケーションの設定を構成する

Site Recovery では、ターゲット リージョンの既定の設定とレプリケーション ポリシーが作成されます。 必要に応じて、これらの設定には変更を加えることができます。

1. **[設定]** を選択してターゲットおよびレプリケーションの設定を表示します。

1. 既定のターゲット設定をオーバーライドするには、 **[リソース グループ、ネットワーク、ストレージ、可用性セット]** の横にある **[カスタマイズ]** を選択します。

   ![設定の構成](./media/azure-to-azure-tutorial-enable-replication/settings.png)

1. 表にまとめたようにターゲット設定をカスタマイズします。

   | **設定** | **詳細** |
   | --- | --- |
   | **ターゲット サブスクリプション** | 既定では、ターゲット サブスクリプションはソース サブスクリプションと同じです。 同じ Azure Active Directory テナント内の別のターゲット サブスクリプションを選択するには、 **[カスタマイズ]** を選択します。 |
   | **ターゲットの場所** | ディザスター リカバリーに使用するターゲット リージョン。<br/><br/> ターゲットの場所が Site Recovery コンテナーの場所と一致していることをお勧めします。 |
   | **ターゲット リソース グループ** | フェールオーバー後、Azure VM を保持する、ターゲット リージョンのリソース グループ。<br/><br/> 既定では、Site Recovery は `asr` というサフィックスを持つターゲット リージョンに、新しいリソース グループを作成します。 ターゲット リソース グループの場所は、ソース仮想マシンがホストされているリージョンを除き、どのリージョンでも構いません。 |
   | **ターゲット仮想ネットワーク** | フェールオーバー後、VM が配置される、ターゲット リージョンのネットワーク。<br/><br/> 既定では、Site Recovery は `asr` というサフィックスを持つターゲット リージョンに、新しい仮想ネットワーク (およびサブネット) を作成します。 |
   | **キャッシュ ストレージ アカウント** | Site Recovery では、ソース リージョンにストレージ アカウントが使用されます。 ソース VM への変更は、ターゲットの場所にレプリケートする前に、このアカウントに送信されます。<br/><br/> ファイアウォールが有効なキャッシュ ストレージ アカウントを使用している場合は必ず、 **[信頼された Microsoft サービスを許可]** を有効にしてください。 [詳細については、こちらを参照してください](../storage/common/storage-network-security.md#exceptions)。 また、ソース VNet の少なくとも 1 つのサブネットにアクセスできることを確認してください。 |
   | **ターゲット ストレージ アカウント (ソース VM で非マネージド ディスクを使用)** | 既定では、Site Recovery によってターゲット リージョンに新しいストレージ アカウントが作成されて、ソース VM のストレージ アカウントがミラーリングされます。<br/><br/> ファイアウォールが有効なキャッシュ ストレージ アカウントを使用している場合は必ず、 **[信頼された Microsoft サービスを許可]** を有効にします。 |
   | **レプリカ マネージド ディスク (ソース VM でマネージド ディスクが使用されている場合)** | 既定では、Site Recovery によってターゲット リージョンにレプリカ マネージド ディスクが作成され、ソース VM のマネージド ディスクと同じストレージ タイプ (Standard または Premium) でソース VM のマネージド ディスクがミラーリングされます。 カスタマイズできるのはディスクの種類だけです。 |
   | **ターゲット可用性セット** | 既定では、Azure Site Recovery によって、新しい可用性セットがターゲット リージョンに作成されます。その名前は、ソース リージョン内の可用性セットの VM 部分に `asr` サフィックスを付けたものになります。 Azure Site Recovery によって作成された可用性セットが既に存在する場合は、それが再利用されます。 |
   | **ターゲット可用性ゾーン** | 既定では、ターゲット リージョン内で可用性ゾーンがサポートされている場合は、ソース リージョンと同じゾーン数が Site Recovery によってターゲット リージョンに割り当てられます。<br/><br/> ターゲット リージョンで可用性ゾーンがサポートされていない場合、既定ではターゲット VM が単一のインスタンスとして構成されます。<br/><br/> **[カスタマイズ]** を選択して、VM をターゲット リージョンの可用性セットの一部として構成します。<br/><br/> レプリケーションを有効にした後は、可用性の種類 (単一インスタンス、可用性セット、または可用性ゾーン) を変更できません。 可用性の種類を変更するには、レプリケーションを無効にしてから有効にします。 |

1. レプリケーション ポリシー設定をカスタマイズするには、 **[レプリケーション ポリシー]** の横の **[カスタマイズ]** を選択し、必要に応じて設定を変更します。

   | **設定** | **詳細** |
   | --- | --- |
   | **レプリケーション ポリシー名** | ポリシーの名前。 |
   | **復旧ポイントの保持期間** | 既定では、Site Recovery では 24 時間分の復旧ポイントが保持されます。 1 ～ 72 時間の値を構成できます。 |
   | **アプリ整合性スナップショットの頻度** | 既定では、Site Recovery によってアプリ整合性スナップショットが 4 時間ごとに取得されます。 1 ～ 12 時間の任意の値を構成できます。<br/><br/> アプリ整合性スナップショットは、VM 内のアプリケーション データのポイントインタイム スナップショットです。 ボリューム シャドウ コピー サービス (VSS) によって、スナップショットの作成時、VM 上のアプリの整合性が維持されます。 |
   | **レプリケーション グループ** | VM 間のマルチ VM 整合性がアプリケーションで必要な場合は、それらの VM のレプリケーション グループを作成できます。 既定では、選択された VM は、どのレプリケーション グループにも属していません。 |

1. 新しいレプリケーション グループまたは既存のレプリケーション グループに VM を追加する場合は、 **[カスタマイズ]** の [マルチ VM 整合性] で **[はい]** を選択します。 **[OK]** をクリックします。

   > [!NOTE]
   > - レプリケーション グループのすべてのマシンが、フェールオーバー時に共有のクラッシュ整合性復旧ポイントとアプリ整合性復旧ポイントを持ちます。
   > - マルチ VM 整合性を有効にすると、ワークロードのパフォーマンス (CPU 集中度) に影響する場合があります。 これは、複数のマシンが同じワークロードを実行していて、複数のマシン間に整合性を持たせる必要がある場合にのみ使用してください。
   > - レプリケーション グループには、最大 16 台の VM を含めることができます。
   > - マルチ VM 整合性を有効にすると、レプリケーション グループ内のマシンは、ポート 20004 を介して相互に通信します。 このポート経由での VM 間の内部通信をブロックするファイアウォールがないことを確認します。
   > - レプリケーション グループ内の Linux VM の場合は、ポート 20004 上の送信トラフィックが、Linux バージョンのガイダンスに従って手動で開かれていることを確認します。

### <a name="configure-encryption-settings"></a>暗号化の設定を構成する

ソース VM で Azure Disk Encryption (ADE) が有効になっている場合は、設定を確認します。

1. 設定を確認します。
   1. **[ディスクの暗号化のキー コンテナー]** :既定では、`asr` というサフィックスを含む新しいキー コンテナーが Site Recovery によってソース VM ディスク暗号化キーに作成されます。 キー コンテナーが既に存在する場合は、それが再利用されます。
   1. **[キー暗号化キー コンテナー]** :既定では、Site Recovery によってターゲット リージョンに新しいキー コンテナーが作成されます。 名前は `asr` サフィックスを含み、ソース VM キー暗号化キーに基づきます。 Site Recovery によって作成されたキー コンテナーが既に存在する場合は、それが再利用されます。
1. **[カスタマイズ]** を選択して独自のキー コンテナーを選択します。

>[!NOTE]
> Site Recovery は現在、Windows オペレーティング システムを実行している VM について、Azure Active Directory (AAD) がある場合とない場合の両方の ADE をサポートしています。 Linux オペレーティング システムでは、AAD なしの ADE のみがサポートされます。 さらに、ADE 1.1 (AAD なし) を実行しているマシンでは、VM によってマネージド ディスクが使用されている必要があります。 アンマネージド ディスクを使用する VM はサポートされません。 ADE 0.1 (AAD あり) から 1.1 に切り替える場合は、レプリケーションを無効にし、1.1 を有効にした後で、VM のレプリケーションを有効にする必要があります。

### <a name="track-replication-status"></a>レプリケーションの状態を追跡する

レプリケーションが有効になったら、ジョブの状態を追跡できます。

1. **[設定]** で、 **[更新]** を選択して最新の状態を取得します。
1. 次の手順で進行状況と状態を追跡します。
   1. **保護の有効化**ジョブの進行状況を、 **[設定]**  >  **[ジョブ]**  >  **[Site Recovery ジョブ]** で追跡します。
   1. **[設定]**  >  **[レプリケートされたアイテム]** では、VM の状態と初期レプリケーションの進行状況を確認できます。 設定をドリルダウンするには、その VM を選択します。

## <a name="next-steps"></a>次のステップ

このチュートリアルでは、Azure VM のディザスター リカバリーを構成しました。 これで、ディザスター リカバリーのテストを実行して、フェールオーバーが正しく機能していることを確認できます。

> [!div class="nextstepaction"]
> [ディザスター リカバリーのテストを実行する](azure-to-azure-tutorial-dr-drill.md)
