---
title: Azure Site Recovery で Azure VM のレプリケーションを構成する
description: Site Recovery を使用して、Azure VM の別のリージョンへのレプリケーションを構成する方法について説明します。
author: sideeksh
manager: rochakm
ms.topic: how-to
ms.date: 04/29/2018
ms.openlocfilehash: 3a1ac6dd940ea5d31adae45a435c5425497362b1
ms.sourcegitcommit: e995f770a0182a93c4e664e60c025e5ba66d6a45
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/08/2020
ms.locfileid: "86135773"
---
# <a name="replicate-azure-vms-to-another-azure-region"></a>Azure VM を別の Azure リージョンにレプリケートする


この記事では、1 つの Azure リージョンから別のリージョンへの Azure VM のレプリケーションを有効にする方法について説明します。

## <a name="before-you-start"></a>開始する前に

この記事は、[Azure から Azure へのディザスター リカバリーのチュートリアル](azure-to-azure-tutorial-enable-replication.md)の説明に従って Site Recovery のデプロイの準備が完了していることを前提としています。

前提条件を満たし、Recovery Services コンテナーの作成が完了しているはずです。


## <a name="enable-replication"></a>レプリケーションを有効にする

レプリケーションを有効にします。 この手順では、プライマリ Azure リージョンが東アジアで、セカンダリ リージョンが東南アジアであることを前提としています。

1. コンテナーで、 **[+レプリケート]** をクリックします。
2. 以下のフィールドに注意してください。
   - **ソース**:VM の起点。この例では **Azure** です。
   - **ソースの場所**:VM を保護する Azure リージョン。 ここでは、ソースの場所は "東アジア" です
   - **デプロイ モデル**:ソース マシンの Azure デプロイ モデル。
   - **ソース サブスクリプション**:ソース VM が属するサブスクリプション。 これは、Recovery Services コンテナーが存在する同じ Azure Active Directory テナント内のどのサブスクリプションでもかまいません。
   - **リソース グループ**:ソース仮想マシンが属しているリソース グループ。 選択したリソース グループのすべての VM が、次の手順で保護対象として表示されます。

     ![レプリケーションを有効にする](./media/site-recovery-replicate-azure-to-azure/enabledrwizard1.png)

3. **[仮想マシン] > [仮想マシンの選択]** で、レプリケートする各 VM をクリックして選択します。 選択できるのは、レプリケーションを有効にできるマシンのみです。 次に、 **[OK]** をクリックします
    ![Enable replication](./media/site-recovery-replicate-azure-to-azure/virtualmachine_selection.png)

4. **[設定]** では、オプションで、以下のターゲット サイトの設定を構成できます。

   - **ターゲットの場所**:ソース仮想マシンのデータがレプリケートされる場所。 選択したマシンの場所に応じて、適切なターゲット リージョンの一覧が表示されます。 ターゲットの場所は、Recovery Services コンテナーと同じ場所にすることをお勧めします。
   - **ターゲット サブスクリプション**:ディザスター リカバリーに使用されるターゲット サブスクリプション。 既定では、ターゲット サブスクリプションはソース サブスクリプションと同じになります。
   - **ターゲット リソース グループ**:レプリケートされたすべての仮想マシンが属するリソース グループ。
       - 既定では、名前に "asr" というサフィックスが付いた新しいリソース グループが、Site Recovery によってターゲット リージョンに作成されます。
       - Site Recovery によって作成されたリソース グループが既に存在する場合は、それが再利用されます。
       - リソース グループ設定はカスタマイズできます。
       - ターゲット リソース グループの場所は、ソース VM がホストされているリージョンを除き、どの Azure リージョンでもかまいません。
   - **ターゲット仮想ネットワーク**:既定では、名前に "asr" というサフィックスが付いた新しい仮想ネットワークが、Site Recovery によってターゲット リージョンに作成されます。 これはソース ネットワークにマップされ、今後の保護で使用されます。 ネットワーク マッピングの詳細については、[こちら](./azure-to-azure-network-mapping.md)を参照してください。
   - **ターゲット ストレージ アカウント (ソース VM でマネージド ディスクが使用されていない)** :既定では、Site Recovery によって、ソース VM ストレージと同じ構成で新しいターゲット ストレージ アカウントが作成されます。 ストレージ アカウントが既に存在する場合は、再利用されます。
   - **レプリカマネージド ディスク (ソース VM でマネージド ディスクが使用されている)** :Site Recovery によってターゲット リージョンに新しいレプリカマネージド ディスクが作成され、ソース VM のマネージド ディスクと同じストレージ タイプ (Standard または Premium) でソース VM のマネージド ディスクがミラーリングされます。
   - **キャッシュ ストレージ アカウント**:Site Recovery では、キャッシュ ストレージと呼ばれる追加のストレージ アカウントがソース リージョンに必要です。 ソース VM で行われてた変更はすべて追跡され、キャッシュ ストレージ アカウントに送信されてから、ターゲットの場所にレプリケートされます。 このストレージ アカウントは、Standard である必要があります。
   - **ターゲット可用性セット**:ソース リージョンの可用性セットの一部である VM の場合、既定では、名前に "asr" というサフィックスが付いた新しい可用性セットが、Site Recovery によってターゲット リージョンに作成されます。 Site Recovery によって作成された可用性セットが既に存在する場合は、それが再利用されます。
   - **ターゲット可用性ゾーン**:既定では、ターゲット リージョン内で可用性ゾーンがサポートされている場合は、ソース リージョンと同じゾーン数が Site Recovery によってターゲット リージョンに割り当てられます。

     ターゲット リージョンで可用性ゾーンがサポートされていない場合、既定ではターゲット VM が単一のインスタンスとして構成されます。 必要な場合は、[カスタマイズ] をクリックして、このような VM をターゲット リージョン内の可用性セットの一部になるように構成できます。

     >[!NOTE]
     >レプリケーションを有効にした後は、可用性の種類 (単一インスタンス、可用性セット、または可用性ゾーン) を変更できません。 可用性の種類を変更するには、レプリケーションを無効にし、有効にする必要があります。
     >

   - **レプリケーション ポリシー**:復旧ポイントのリテンション履歴と、アプリ整合性スナップショットの頻度の設定を定義します。 既定では、Azure Site Recovery によって、既定の設定 (復旧ポイントのリテンション期間が "24 時間"、アプリ整合性スナップショットの頻度が "4 時間") で新しいレプリケーション ポリシーが作成されます。

     ![レプリケーションを有効にする](./media/site-recovery-replicate-azure-to-azure/enabledrwizard3.PNG)

### <a name="enable-replication-for-added-disks"></a>追加されたディスクのレプリケーションを有効にする

レプリケーションが有効な Azure VM にディスクを追加すると、以下の処理が行われます。
-   VM のレプリケーションの正常性に、警告と、1 つ以上のディスクを保護対象にすることができるという注意が表示されます。
-   追加されたディスクの保護を有効にすると、ディスクの初回のレプリケーション後に警告は表示されなくなります。
-   ディスクのレプリケートを有効にしないことを選択した場合は、この警告の無視を選択できます。


    ![新しいディスクの追加](./media/azure-to-azure-how-to-enable-replication/newdisk.png)

追加されたディスクのレプリケーションを有効にするには、次の手順を実行します。

1.  コンテナーの **[レプリケートされたアイテム]** で、ディスクを追加した VM をクリックします。
2.  **[ディスク]** をクリックし、レプリケーションを有効にするデータ ディスクを選択します (これらのディスクの状態は**未保護**です。)。
3.  **[ディスクの詳細]** で、 **[レプリケーションを有効にする]** をクリックします。

    ![追加されたディスクのレプリケーションを有効にする](./media/azure-to-azure-how-to-enable-replication/enabled-added.png)

レプリケーションの有効化ジョブが実行され、初回のレプリケーションが完了すると、ディスクの問題に関するレプリケーションの正常性の警告は削除されます。



## <a name="customize-target-resources"></a>ターゲット リソースのカスタマイズ

Site Recovery によって使用される既定のターゲット設定を変更することができます。

1. [ターゲット サブスクリプション] の横にある **[カスタマイズ]** をクリックして、既定のターゲット サブスクリプションを変更します。 同じ Azure Active Directory (AAD) テナントで使用できるすべてのサブスクリプションの一覧からサブスクリプションを選択します。

2. **[カスタマイズ]** をクリックして、既定の設定を次のように変更します。
    - **ターゲット リソース グループ**で、サブスクリプションのターゲットの場所にあるすべてのリソース グループの一覧から、リソース グループを選択します。
    - **ターゲット仮想ネットワーク**で、ターゲットの場所にあるすべての仮想ネットワークの一覧から、ネットワークを選択します。
    - **可用性セット**では、可用性セットの設定を、それらがソース リージョンの可用性セットの一部であれば、VM に追加できます。
    - **ターゲット ストレージ アカウント**で、使用するアカウントを選択します。

        ![レプリケーションを有効にする](./media/site-recovery-replicate-azure-to-azure/customize.PNG)
3. **[カスタマイズ]** をクリックして、アプリケーションの設定を変更します。
4. **[マルチ VM 整合性]** では、一緒にレプリケートする VM を選択します
    - レプリケーション グループのすべてのマシンが、フェールオーバー時に共有のクラッシュ整合性復旧ポイントとアプリ整合性復旧ポイントを持ちます。
    - マルチ VM 整合性を有効にすると、ワークロードのパフォーマンスに影響する場合があります (CPU 集中型のため)。 これは、複数のマシンが同じワークロードを実行していて、複数のマシン間に整合性を持たせる必要がある場合にのみ有効にしてください。
    - たとえば、アプリケーションに 2 つの SQL Server 仮想マシンと 2 つの Web サーバーがある場合は、SQL Server VM のみをレプリケーション グループに追加するようにします。
    - レプリケーション グループには、最大 16 台の VM を含めることができます。
    - マルチ VM 整合性を有効にすると、レプリケーション グループ内のマシンは、ポート 20004 を介して相互に通信します。
    - ポート 20004 経由での VM 間の内部通信をブロックするファイアウォール アプライアンスがないことを確認します。
    - Linux VM をレプリケーション グループに含めるには、ポート 20004 の送信トラフィックが、特定の Linux バージョンのガイダンスに従って手動で開かれていることを確認します。
![Enable replication](./media/site-recovery-replicate-azure-to-azure/multivmsettings.PNG)

5. **[Create target resource]\(ターゲット リソースを作成する\)**  >  **[レプリケーションを有効にする]** の順にクリックします。
6. VM のレプリケーションが有効になったら、 **[レプリケートされたアイテム]** で VM の正常性の状態を確認できます。

>[!NOTE]
>
> - 初期レプリケーションの間は、状態の更新に少し時間がかかり、進捗が見られない場合があります。 **[更新]** ボタンをクリックして、最新の状態を取得します。
> - 過去 60 分以内に復旧ポイントが生成されていない場合、仮想マシンのレプリケーションの正常性が重大になります。

## <a name="next-steps"></a>次のステップ

テスト フェールオーバーの実行に関する[詳細を確認](site-recovery-test-failover-to-azure.md)する。
