---
title: Azure Site Recovery における VMware VM ディザスター リカバリー アーキテクチャ
description: この記事では、Azure Site Recovery を使ってオンプレミスの VMware VM から Azure へのディザスター リカバリーを設定するときに使われるコンポーネントとアーキテクチャの概要を説明します
author: rayne-wiselman
ms.service: site-recovery
services: site-recovery
ms.topic: conceptual
ms.date: 11/06/2019
ms.author: raynew
ms.openlocfilehash: 4b1b8a0cfa98d48d7cb92474c1572f17c79ffd0d
ms.sourcegitcommit: 11e2521679415f05d3d2c4c49858940677c57900
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/31/2020
ms.locfileid: "87498954"
---
# <a name="vmware-to-azure-disaster-recovery-architecture"></a>VMware から Azure へのディザスター リカバリー アーキテクチャ

この記事では、[Azure Site Recovery](site-recovery-overview.md) サービスを使用して、オンプレミスの VMware サイトと Azure の間の VMware 仮想マシン (VM) のディザスター リカバリー レプリケーション、フェールオーバー、および復旧をデプロイする場合に使用するアーキテクチャとプロセスについて説明します。


## <a name="architectural-components"></a>アーキテクチャ コンポーネント

次の表と図は、Azure への VMware ディザスター リカバリーに使用するコンポーネントの概要を示したものです。

**コンポーネント** | **要件** | **詳細**
--- | --- | ---
**Azure** | Azure サブスクリプション、キャッシュの Azure Storage アカウント、マネージド ディスク、Azure ネットワーク。 | オンプレミスの VM からレプリケートされたデータは、Azure ストレージに格納されます。 オンプレミスから Azure へのフェールオーバーを実行すると、そのレプリケートされたデータで Azure VM が作成されます。 Azure VM は、作成時に Azure 仮想ネットワークに接続します。
**構成サーバー マシン** | 単一のオンプレミス マシン。 ダウンロードした OVF テンプレートからデプロイできる VMware VM として実行することをお勧めします。<br/><br/> マシンは、構成サーバー、プロセス サーバー、マスター ターゲット サーバーなど、オンプレミスのすべての Site Recovery コンポーネントを実行します。 | **構成サーバー**: オンプレミスと Azure の間の通信を調整し、データのレプリケーションを管理します。<br/><br/> **プロセス サーバー**:構成サーバーに既定でインストールされます。 レプリケーション データを受信し、そのデータをキャッシュ、圧縮、暗号化によって最適化して、Azure Storage に送信します。 また、プロセス サーバーは、レプリケートする VM への Azure Site Recovery モビリティ サービスのインストールや、オンプレミスのマシンの自動検出も行います。 デプロイの拡大に合わせて、増大するレプリケーション トラフィックの処理を実行する独立したプロセス サーバーを追加できます。<br/><br/> **マスター ターゲット サーバー**:構成サーバーに既定でインストールされます。 Azure からのフェールバック中にレプリケーション データを処理します。 大規模なデプロイでは、フェールバック用に別のマスター ターゲット サーバーを追加できます。
**VMware サーバー** | VMware VM は、オンプレミス vSphere ESXi サーバーでホストされています。 ホストの管理には vCenter サーバーをお勧めします。 | Site Recovery のデプロイ中には、VMware サーバーを Recovery Services コンテナーに追加します。
**レプリケートされたマシン** | レプリケートする各 VMware VM にモビリティ サービスがインストールされます。 | プロセス サーバーから自動的にインストールできるようにすることをお勧めします。 また、サービスを手動でインストールしたり、Configuration Manager などの自動デプロイ方法を使用したりすることができます。

![VMware から Azure へのレプリケーション アーキテクチャの関係を示す図。](./media/vmware-azure-architecture/arch-enhanced.png)

## <a name="set-up-outbound-network-connectivity"></a>送信ネットワーク接続を設定する

Site Recovery を期待どおりに動作させるためには、環境でレプリケートが可能になるように、送信ネットワーク接続を変更する必要があります。

> [!NOTE]
> Site Recovery では、ネットワーク接続を制御するための認証プロキシの使用をサポートしていません。

### <a name="outbound-connectivity-for-urls"></a>URL に対する送信接続

アウトバウンド接続を制御するために URL ベースのファイアウォール プロキシを使用している場合、以下の URL へのアクセスを許可してください。

| **名前**                  | **商用**                               | **政府**                                 | **説明** |
| ------------------------- | -------------------------------------------- | ---------------------------------------------- | ----------- |
| ストレージ                   | `*.blob.core.windows.net`                  | `*.blob.core.usgovcloudapi.net`              | ソース リージョンのキャッシュ ストレージ アカウントに、VM からデータが書き込まれるよう許可します。 |
| Azure Active Directory    | `login.microsoftonline.com`                | `login.microsoftonline.us`                   | Site Recovery サービス URL に対する承認と認証を提供します。 |
| レプリケーション               | `*.hypervrecoverymanager.windowsazure.com` | `*.hypervrecoverymanager.windowsazure.com`   | VM と Site Recovery サービスの通信を許可します。 |
| Service Bus               | `*.servicebus.windows.net`                 | `*.servicebus.usgovcloudapi.net`             | VM による Site Recovery の監視および診断データの書き込みを許可します。 |

## <a name="replication-process"></a>レプリケーション プロセス

1. VM に対してレプリケーションを有効にした場合、指定したレプリケーション ポリシーを使用して、Azure Storage への最初のレプリケーションが開始されます。 次のことを考慮してください。
    - VMware VM の場合、レプリケーションは、VM 上で実行されているモビリティ サービス エージェントを使用しているブロックレベル (ほぼ連続的) です。
    - 任意のレプリケーション ポリシー設定が適用されます。
        - **[RPO しきい値]** 。 この設定は、レプリケーションには影響しません。 これは監視に役立ちます。 現在の RPO が指定したしきい値の上限を超えた場合、イベントが発生し、必要に応じて電子メールが送信されます。
        - **[復旧ポイントのリテンション期間]** 。 この設定は、中断が発生したときに、どこまで戻るかを時間で指定します。 Premium Storage の最大リテンション期間は 24 時間です。 Standard Storage では 72 時間です。 
        - **[App-consistent snapshots]\(アプリ整合性スナップショット\)** 。 アプリ整合性スナップショットは、アプリのニーズに応じて 1 から 12 時間ごとに取得できます。 スナップショットは標準の Azure BLOB スナップショットです。 VM 上で実行されているモビリティ エージェントでは、この設定に従って VSS スナップショットが要求され、レプリケーション ストリームのアプリケーション整合性ポイントとして特定の時点がブックマークされます。

2. トラフィックは、インターネット経由で Azure Storage のパブリック エンドポイントにレプリケートされます。 別の方法として、Azure ExpressRoute と [Microsoft ピアリング](../expressroute/expressroute-circuit-peerings.md#microsoftpeering)を使用できます。 オンプレミス サイトから Azure へのサイト間仮想プライベート ネットワーク (VPN) を介したトラフィックのレプリケートはサポートされていません。
3. 初期レプリケーション操作により、レプリケーションを有効にした時点のマシン上のデータ全体が確実に Azure に送信されます。 初回のレプリケーションの終了後、Azure への差分変更のレプリケーションが開始されます。 マシンに対する追跡された変更は、プロセス サーバーに送信されます。
4. 通信は、次のように行われます。

    - VM は、レプリケーション管理のために、受信ポート HTTPS 443 でオンプレミスの構成サーバーと通信します。
    - 構成サーバーは、送信ポート HTTPS 443 経由で Azure によるレプリケーションを調整します。
    - VM は、受信ポート HTTPS 9443 でレプリケーション データを (構成サーバー マシン上で実行されている) プロセス サーバーに送信します。 このポートは変更可能です。
    - プロセス サーバーは、レプリケーション データを受信し、データを最適化して暗号化し、アウトバウンド ポート 443 経由で Azure ストレージに送信します。
5. レプリケーション データ ログは、まず Azure のキャッシュ ストレージ アカウントに記録されます。 これらのログは処理され、データは Azure マネージド ディスク (asr シード ディスクと呼ばれます) に格納されます。 復旧ポイントはこのディスク上に作成されます。

![VMware から Azure へのレプリケーション プロセスを示す図。](./media/vmware-azure-architecture/v2a-architecture-henry.png)

## <a name="resynchronization-process"></a>再同期プロセス

1. 初期レプリケーション中または差分変更の転送中に、ソース マシンとプロセス サーバーの間か、またはプロセス サーバーと Azure の間でネットワーク接続の問題が発生する場合があります。 どちらの場合も、直ちに Azure へのデータ転送の失敗につながることがあります。
2. データ整合性の問題を回避し、データ転送コストを最小限に抑えるために、Site Recovery はマシンを再同期としてマークします。
3. マシンはまた、ソース マシンと Azure に格納されているデータの間の整合性を維持するために、次のような状況でも再同期としてマークされる場合があります。
    - マシンで強制シャットダウンが実行された場合
    - マシンでディスクのサイズ変更 (ディスク サイズの 2 TB から 4 TB への変更) などの構成変更が実行された場合
4. 再同期では、Azure に差分データのみを送信します。 オンプレミスと Azure の間のデータ転送は、ソース マシンと Azure に格納されているデータの間のデータのチェックサムを計算することによって最小限に抑えられます。
5. 既定では再同期は業務時間外に自動的に実行するようにスケジュールされます。 既定の業務時間外の再同期を待ちたくない場合は、VM を手動で再同期できます。 これを行うには、Azure portal に移動し、[VM] > **[再同期]** を選択します。
6. 既定の再同期が業務時間外に失敗し、手動介入が必要になった場合、エラーは Azure portal の特定のマシンで生成されます。 エラーを解決し、手動で再同期をトリガーできます。
7. 再同期が完了した後、差分変更のレプリケーションが再開されます。

## <a name="failover-and-failback-process"></a>フェールオーバーとフェールバックのプロセス

レプリケーションがセットアップされ、ディザスター リカバリーの訓練 (フェールオーバーのテスト) を実行してすべてが期待どおりに動作することを確認したら、必要に応じて、フェールオーバーとフェールバックを実行できます。

1. 単一のマシンをフェールオーバーするか、復旧計画を作成して複数の VM を同時にフェールオーバーします。 単一のマシンのフェールオーバーと比較した復旧計画の利点を次に示します。
    - アプリのすべての VM を 1 つの復旧プランに含めることで、アプリの依存関係をモデル化できます。
    - スクリプト、Azure Runbook、手動操作を行うための一時停止を追加できます。
2. 最初のフェールオーバーをトリガーするには、Azure VM から、ワークロードへのアクセスを開始するようコミットします。
3. プライマリ オンプレミス サイトが再び使用可能になったら、フェールバックを実行する準備を行うことができます。 フェールバックするためには、次のものを含むインフラストラクチャをセットアップする必要があります。

    * **Azure 上の一時的なプロセス サーバー**:Azure からフェールバックするには、Azure からのレプリケーションを処理するプロセス サーバーとして機能する Azure VM を設定します。 この VM は、フェールバックの完了後に削除できます。
    * **VPN 接続**:フェールバックするには、Azure ネットワークからオンプレミス サイトへの VPN 接続 (または ExpressRoute) が必要です。
    * **独立したマスター ターゲット サーバー**:既定では、構成サーバーと共にオンプレミスの VMware VM にインストールされたマスター ターゲット サーバーによって、フェールバックが処理されます。 大量のトラフィックをフェールバックする必要がある場合は、その目的を果たすための独立したオンプレミスのマスター ターゲット サーバーをセットアップします。
    * **フェールバック ポリシー**:ご利用のオンプレミスにもう一度レプリケートするには、フェールバック ポリシーが必要です。 このポリシーは、オンプレミスから Azure へのレプリケーション ポリシーを作成したときに自動的に作成されます。
4. コンポーネントが配置された後、フェールバックは、次の 3 つのアクションを実行します。

    - ステージ 1:Azure VM が Azure からオンプレミスの VMware VM へのレプリケートを開始するように、Azure VM を再保護します。
    -  ステージ 2:オンプレミス サイトでフェールオーバーを実行します。
    - ステージ 3:ワークロードがフェールバックしたら、オンプレミス VM のレプリケーションを再び有効にします。
    
 

![Azure からの VMware フェールバックを示す図。](./media/vmware-azure-architecture/enhanced-failback.png)


## <a name="next-steps"></a>次のステップ

VMware から Azure へのレプリケーションを有効にするには、[このチュートリアル](vmware-azure-tutorial.md)に従ってください。
