---
title: Azure Load Balancer のリソース正常性、フロントエンド、およびバックエンドの可用性に関する問題のトラブルシューティング
description: 使用可能なメトリックを使用して、機能低下または使用できない Azure Standard Load Balancer を診断します。
services: load-balancer
documentationcenter: na
author: erichrt
ms.service: load-balancer
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 08/14/2020
ms.author: errobin
ms.openlocfilehash: 1af3ce7125d30ed0cb9b8ca6b3cb9322dc14c520
ms.sourcegitcommit: b33c9ad17598d7e4d66fe11d511daa78b4b8b330
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/25/2020
ms.locfileid: "88855244"
---
# <a name="troubleshoot-resource-health-frontend-and-backend-availability-issues"></a>リソース正常性、フロントエンド、およびバックエンドの可用性に関する問題のトラブルシューティング 

この記事は、ロードバランサーのフロントエンド IP とバックエンド リソースの可用性に影響を与える問題を調査するためのガイドです。 

## <a name="about-the-metrics-well-use"></a>使用するメトリックについて
使用する 2 つのメトリックは、"*データ パスの可用性*" と "*正常性プローブの状態*" で、適切な洞察を得るためにはこれらの意味を理解しておくことが重要です。 

## <a name="data-path-availability"></a>データ パスの可用性
データ パスの可用性メトリックは、負荷分散規則とインバウンド NAT 規則が構成されているすべてのフロントエンド ポートで 25 秒ごとに TCP ping によって生成されます。 この TCP ping は、正常な (プローブ対象の) バックエンド インスタンスのいずれかにルーティングされます。 ping に対する応答をサービスが受信した場合は成功と見なされ、メトリックの合計は 1 回繰り返され、失敗した場合は実行されません。 このメトリックのカウントは、サンプル期間あたりの TCP ping 総数の 1/100 です。 そのため、平均を考慮する必要があり、これによって期間の合計/カウントの平均が表示されます。 したがって、平均で集計されたデータ パスの可用性メトリックでは、各負荷分散規則とインバウンド NAT 規則についてのフロントエンド IP: ポートでの TCP ping の成功率がパーセントで示されます。

## <a name="health-probe-status"></a>正常性プローブの状態
正常性プローブの状態メトリックは、正常性プローブで定義されたプロトコルの ping によって生成されます。 この ping は、正常性プローブで定義されているバックエンド プールとポートの各インスタンスに送信されます。 HTTP および HTTPS プローブの場合、ping を成功させるには HTTP 200 OK の応答が必要ですが、TCP プローブでは、すべての応答が成功と見なされます。 各プローブの連続する成功または失敗により、バックエンド インスタンスが正常であるかどうか、およびバックエンド プールが割り当てられている負荷分散規則のトラフィックを受信できるかどうかが判断されます。 データ パスの可用性と同様に、平均集計を使用します。これにより、サンプリング間隔中の合計 ping に占める成功の平均が示されます。 この正常性プローブの状態の値は、フロントエンド経由でトラフィックを送信することなくバックエンド インスタンスを調査することにより、ロード バランサーとは無関係のバックエンドの正常性を示します。

>[!IMPORTANT]
>正常性プローブの状態は、1 分ごとにサンプリングされます。 これにより、通常だと安定した値なのに軽微な変動が生じることがあります。 たとえば、2 つのバックエンド インスタンスがあり、1 つがプローブ対象、もう 1 つがプローブ対象外の場合、正常性プローブ サービスは正常なインスタンスのサンプルを 7 個、異常なインスタンスを 6 個キャプチャすることがあります。 これにより、1 分間の間隔で、以前の安定した値 50 が 46.15 として表示されます。 

## <a name="diagnose-degraded-and-unavailable-load-balancers"></a>機能低下および使用できないロード バランサーを診断する
[リソース正常性の記事](load-balancer-standard-diagnostics.md#resource-health-status)で概要を説明したように、機能低下したロード バランサーはデータパスの可用性が 25% ~ 90% のもので、使用できないロード バランサーはデータ パスの可用性が 25% 未満のものです (期間は 2 分間)。 これらの同じ手順を実行して、構成した正常性プローブの状態またはデータ パスの可用性に関するアラートに表示されるエラーを調べることもできます。 ここでは、リソースの正常性を検査し、データ パスの可用性が 0% のためロードバランサーが利用できない (サービスが停止している) 場合について説明します。

まず、ロード バランサーの Insights ブレードの詳細なメトリック ビューに移ります。 これを行うには、ロード バランサーのリソース ブレードまたはリソース正常性メッセージのリンクを使用します。  次に、[Frontend and Backend availability]\(フロントエンドとバックエンドの可用性\) タブに移動し、機能低下または使用できない状態が発生した 30 分間の時間ウィンドウを確認します。 データ パスの可用性が 0% であることが判明した場合、すべての負荷分散規則とインバウンド NAT 規則のトラフィックを妨げている問題があることがわかり、この影響が継続している期間を確認することができます。 

次に調べる必要があるのは正常性プローブの状態メトリックです。これにより、データ パスが使用できない理由が、トラフィックを処理する正常なバックエンド インスタンスがないことであるかどうかを判断します。 すべての負荷分散規則とインバウンド規則に対して正常なバックエンド インスタンスが少なくとも 1 つある場合、構成が原因でデータ パスが使用できなくなっているわけではないことがわかります。 このシナリオは Azure プラットフォームに問題が発生していることを示していますが、これらの問題が見つかっても、すべてのプラットフォームの問題を迅速に解決するための自動アラートが Microsoft のチームに送信されるため、心配はありません。

## <a name="diagnose-health-probe-failures"></a>正常性プローブの失敗を診断する
たとえば、正常性プローブの状態を確認し、すべてのインスタンスが異常と表示されているとします。 ここでは、データ パスが使用できないのは、トラフィックの行き場がないためであることが説明されています。 次に、次のチェックリストを参照して、一般的な構成エラーを除外します。
* リソースの CPU 使用率を確認して、インスタンスが実際に正常であるかどうかを確認します
  * これは確認できます 
* HTTP または HTTPS プローブを使用している場合、アプリケーションが正常で応答性があるかどうかを確認します
  * これが機能していることを確認するには、バックエンド インスタンスに関連付けられているプライベート IP アドレスまたはインスタンスレベルのパブリック IP アドレスを使用して、アプリケーションに直接アクセスします
* バックエンド リソースに適用されているネットワーク セキュリティ グループを確認します。 正常性プローブをブロックする AllowAzureLoadBalancerInBound よりも優先順位の高い規則がないことを確認します
  * これを行うには、バックエンド VM または Virtual Machine Scale Sets の [ネットワーク] ブレードにアクセスします
  * この NSG の問題が見つかった場合は、既存の許可規則を移動するか、優先度の高い新しい規則を作成して AzureLoadBalancer トラフィックを許可します
* OS を確認します。 VM がプローブ ポートでリッスンしていることを確認し、OS のファイアウォール規則を確認して、IP アドレス 168.63.129.16 から送信されるプローブ トラフィックをブロックしていないことを確認します
  * Windows コマンド プロンプトで netstat -a を実行するか、Linux ターミナルで netstat -l を実行することで、リスニング ポートを確認できます
* ファイアウォール NVA VM をロード バランサーのバックエンド プールに配置しないでください。[ユーザー定義ルート](https://docs.microsoft.com/azure/virtual-network/virtual-networks-udr-overview#user-defined)を使用して、ファイアウォール経由でバックエンド インスタンスにトラフィックをルーティングします
* 適切なプロトコルを使用していることを確認します。HTTP を使用して、HTTP 以外のアプリケーションをリッスンしているポートをプローブする場合、プローブは失敗します

このチェックリストを使用しても正常性プローブの障害がまだ検出される場合は、インスタンスのプローブ サービスに影響を与える珍しいプラットフォームの問題が発生している可能性があります。 この場合では Azure のサポートを受けられ、すべてのプラットフォームの問題を迅速に解決するための自動アラートが Microsoft のチームに送信されます。

## <a name="next-steps"></a>次のステップ

* [Azure Load Balancer の正常性プローブの詳細について学習する](load-balancer-custom-probe-overview.md)
* [Azure Load Balancer のメトリックの詳細について学習する](load-balancer-standard-diagnostics.md)


