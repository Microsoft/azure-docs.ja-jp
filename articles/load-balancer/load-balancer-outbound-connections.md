---
title: アウトバウンド接続での SNAT
description: Azure Load Balancer を使用してアウトバウンド インターネット接続で SNAT を実行する方法について説明します
services: load-balancer
author: asudbring
ms.service: load-balancer
ms.topic: conceptual
ms.custom: contperf-fy21q1
ms.date: 10/13/2020
ms.author: allensu
ms.openlocfilehash: d1632c66791dd5e697b95a2c5aaaddea81629abf
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/19/2021
ms.locfileid: "99052824"
---
# <a name="using-snat-for-outbound-connections"></a>アウトバウンド接続での SNAT の使用

Azure パブリック ロード バランサーのフロントエンド IP を使用して、インターネットへのアウトバウンド接続をバックエンド インスタンスに提供できます。 この構成では、**ソース ネットワーク アドレス変換 (SNAT)** を使用します。 SNAT を使用して、バックエンドの IP アドレスをロード バランサーのパブリック IP アドレスに書き換えます。 

SNAT を使用すると、バックエンド インスタンスの **IP マスカレード** が可能になります。 このマスカレードによって、外部ソースはバックエンド インスタンスへの直接アドレスを取得できなくなります。 バックエンド インスタンス間で 1 つの IP アドレスを共有すると、静的パブリック IP のコストが削減され、既知のパブリック IP からのトラフィックを含む IP 許可リストを簡略化するなどのシナリオがサポートされます。 

>[!Note]
> 多数のアウトバウンド接続を必要とするアプリケーションや、特定の仮想ネットワークから単一の IP セットを使用する必要がある企業のお客様の場合は、[Virtual Network NAT](../virtual-network/nat-overview.md) がお勧めのソリューションです。 その動的割り当てを使用すると、単純な構成が可能になり、各 IP アドレスから SNAT ポートを最も効率的に使用できます。 また、仮想ネットワーク内のすべてのリソースが一連の IP アドレスを共有できるようになります。これにより、ロード バランサーを共有する必要がなくなります。

>[!Important]
> アウトバウンド SNAT が構成されていない場合でも、同じリージョン内の Azure ストレージ アカウントには引き続きアクセスでき、バックエンドのリソースは引き続き Windows Update などの Microsoft サービスにアクセスできます。

>[!NOTE] 
>この記事では、Azure Resource Manager のデプロイのみを対象としています。 Azure のすべてのクラシック デプロイメント シナリオについては、「[送信接続 (クラシック)](/previous-versions/azure/load-balancer/load-balancer-outbound-connections-classic)」をご覧ください。

## <a name="sharing-frontend-ip-address-across-backend-resources"></a><a name ="snat"></a> バックエンド リソース間でフロントエンド IP アドレスを共有する

ロード バランサーのバックエンド リソースにインスタンスレベルのパブリック IP (ILPIP) アドレスがない場合、パブリック ロード バランサーのフロントエンド IP を介して送信接続が確立されます。 ポートは、個別のフローを維持するために使用される一意の識別子を生成するために使用されます。 インターネットには、この区別を実現するために 5 タプルが使用されます。

5 タプルの構成は次のとおりです。

* 宛先 IP
* 宛先ポート
* 発信元 IP
* この区別を実現するための送信元ポートとプロトコル。

受信接続にポートを使用する場合、そのポートでの受信接続要求には **リスナー** が使用されます。これは送信接続には使用できません。 送信接続を確立するには、**エフェメラル ポート** を使用して、通信と個別のトラフィック フローの維持に使用するポートを宛先に提供する必要があります。 これらの一時ポートを使用して SNAT を実行する場合、これらは **SNAT ポート** と呼ばれます。 

定義上、すべての IP アドレスには 65,535 個のポートがあります。 各ポートは、TCP (伝送制御プロトコル) および UDP (ユーザー データグラム プロトコル) のインバウンドまたはアウトバウンドの接続のいずれかに使用できます。 パブリック IP アドレスがフロントエンド IP としてロード バランサーに追加されると、Azure によって 64,000 個が SNAT ポートとして使用できるようになります。 

>[!NOTE]
> 負荷分散またはインバウンド NAT 規則に使用される各ポートにより、これらの 64,000 のポートから 8 つのポートの範囲が消費され、SNAT の対象となるポートの数が減ります。 負荷分散または NAT 規則が、別のものと同じ 8 個の範囲内にある場合は、追加のポートは使用されません。 

[アウトバウンド規則](./outbound-rules.md)と負荷分散の規則を使用すると、これらの SNAT ポートをバックエンド インスタンスに分散し、アウトバウンド接続用のロード バランサーのパブリック IP を共有できるようになります。

下の[シナリオ 2](#scenario2) を構成すると、各バックエンド インスタンスのホストによって、アウトバウンド接続の一部であるパケットに対して SNAT が実行されます。 バックエンド インスタンスからのアウトバウンド接続で SNAT を実行すると、ホストによりソース IP がフロントエンド IP のいずれかに書き換えられます。 一意のフローを維持するために、ホストは、各アウトバウンド パケットの送信元ポートを、バックエンド インスタンスに割り当てられた SNAT ポートの 1 つに書き換えます。

## <a name="outbound-connection-behavior-for-different-scenarios"></a>さまざまなシナリオでのアウトバウンド接続の動作
  * パブリック IP を持つ仮想マシン。
  * パブリック IP を持たない仮想マシン。
  * パブリック IP および標準のロード バランサーを持たない仮想マシン。
        

 ### <a name="scenario-1-virtual-machine-with-public-ip"></a><a name="scenario1"></a> シナリオ 1:パブリック IP を持つ仮想マシン。


 | Associations | Method | IP プロトコル |
 | ---------- | ------ | ------------ |
 | パブリック ロード バランサーまたはスタンドアロン | [SNAT (送信元ネットワーク アドレス変換)](#snat) </br> は使用されません。 | TCP (伝送制御プロトコル) </br> UDP (ユーザー データグラム プロトコル) </br> ICMP (インターネット制御メッセージ プロトコル) </br> ESP (カプセル化セキュリティ ペイロード) |


 #### <a name="description"></a>説明


 すべてのアウトバウンド フローについて、インスタンスの NIC の IP 構成に割り当てられたパブリック IP が Azure によって使用されます。 インスタンスには、使用可能なすべてのエフェメラル ポートがあります。 VM が負荷分散されているかどうかは関係ありません。 このシナリオは他のシナリオよりも優先されます。 


 VM に割り当てられたパブリック IP は (1 対多ではなく) 1 対 1 の関係であり、1 対 1 のステートレス NAT として実装されます。


 ### <a name="scenario-2-virtual-machine-without-public-ip-and-behind-standard-public-load-balancer"></a><a name="scenario2"></a>シナリオ 2:パブリック IP を持たず Standard パブリック Load Balancer の背後にある仮想マシン


 | Associations | Method | IP プロトコル |
 | ------------ | ------ | ------------ |
 | Standard パブリック Load Balancer | [SNAT](#snat) 用のロード バランサー フロントエンド IP の使用。| TCP </br> UDP |


 #### <a name="description"></a>説明


 ロード バランサー リソースは、既定の SNAT を有効にするアウトバウンド規則または負荷分散規則を使用して構成されます。 この規則は、パブリック IP フロントエンドとバックエンド プールとの間にリンクを作成するために使用されます。 


 この規則の構成を完了しない場合の動作は、シナリオ 3 で説明されたとおりになります。 


 正常性プローブを成功させるために、リスナーを使用した規則は必要ありません。


 VM がアウトバウンド フローを作成すると、Azure により、送信元 IP アドレスがパブリック ロード バランサー フロントエンドのパブリック IP アドレスに変換されます。 この変換は [SNAT](#snat) を介して行われます。 


 ロード バランサーのフロントエンド パブリック IP アドレスのエフェメラル ポートを使用して、VM から送信される個々のフローが区別されます。 送信フローが作成されると、[事前に割り当てられたエフェメラル ポート](#preallocatedports)が SNAT によって動的に使用されます。 


 ここでは、SNAT で使用されるエフェメラル ポートを SNAT ポートと呼びます。 [アウトバウンド規則](./outbound-rules.md)を明示的に構成することを強くお勧めします。 負荷分散規則に従って既定の SNAT を使用している場合は、[既定の SNAT ポート割り当てテーブル](#snatporttable)に記載されているように、SNAT ポートが事前に割り当てられます。

 ### <a name="scenario-3-virtual-machine-without-public-ip-and-behind-standard-internal-load-balancer"></a><a name="scenario3"></a>シナリオ 3:パブリック IP を持たず Standard 内部 Load Balancer の背後にある仮想マシン


 | Associations | Method | IP プロトコル |
 | ------------ | ------ | ------------ |
 | Standard 内部 Load Balancer | インターネット接続なし。| なし |

 #### <a name="description"></a>説明
 
Standard 内部 Load Balancer を使用する場合、SNAT のために一時 IP アドレスは使用されません。 これは、既定でセキュリティをサポートするため、リソースで使用されるすべての IP アドレスを構成および予約できるようにするためです。 Standard 内部 Load Balancer の使用時にインターネットへのアウトバウンド接続を実現するには、インスタンス レベルのパブリック IP アドレスを構成して、(シナリオ 1) [#scenario1] の動作に従います。または、内部 Load Balancer に加えて、アウトバウンド規則が構成された Standard パブリック Load Balancer にバックエンド インスタンスを追加して、(シナリオ 2)[#scenario2] の動作に従います。 

 ### <a name="scenario-4-virtual-machine-without-public-ip-and-behind-basic-load-balancer"></a><a name="scenario4"></a>シナリオ 4:パブリック IP を持たず Basic Load Balancer の背後にある仮想マシン


 | Associations | Method | IP プロトコル |
 | ------------ | ------ | ------------ |
 |なし </br> Basic ロード バランサー | インスタンスレベルの動的 IP アドレスを使用する [SNAT](#snat)| TCP </br> UDP | 

 #### <a name="description"></a>説明


 VM がアウトバウンド フローを作成すると、Azure が、送信元 IP アドレスを動的に割り当てられたパブリック送信元 IP アドレスに変換します。 このパブリック IP アドレスは **構成することができず**、予約することもできません。 このアドレスは、サブスクリプションのパブリック IP リソースの制限に対してカウントされません。 


 次のものを再デプロイすると、パブリック IP アドレスは解放され、新しいパブリック IP が要求されます。 


 * 仮想マシン
 * 可用性セット
 * 仮想マシン スケール セット 


 許可リストに IP を追加するためにこのシナリオを使用しないでください。 アウトバウンド動作を明示的に宣言するシナリオ 1 または 2 を使用してください。 [SNAT](#snat) ポートは、[既定の SNAT ポート割り当て表](#snatporttable)の説明のとおり事前に割り当てられます。

## <a name="exhausting-ports"></a><a name="scenarios"></a> ポートの枯渇

同じ宛先 IP および宛先ポートへのすべての接続には 1 つの SNAT ポートが使用されます。 この接続を使用して、バックエンド インスタンスまたは **クライアント** から **サーバー** に対する個別の **トラフィック フロー** が維持されます。 このプロセスにより、トラフィックを処理できる個別のポートがサーバーに提供されます。 このプロセスがないと、クライアント コンピューターでは、パケットがどのフローに属するかが認識されません。

複数のブラウザーを使用して、次のような https://www.microsoft.com にアクセスする場合について考えてみましょう。

* 宛先 IP = 23.53.254.142
* 宛先ポート = 443
* プロトコル = TCP

リターン トラフィック用の異なる宛先ポート (接続の確立に使用される SNAT ポート) がないと、クライアントでは 1 つのクエリ結果を別のクエリ結果と区別できません。

送信接続はバーストする可能性があります。 バックエンド インスタンスに不十分な数のポートが割り当てられる可能性があります。 **接続の再使用** が有効になっていないと、SNAT **ポートの枯渇** が発生するリスクが高まります。

ポートの枯渇が発生すると、宛先 IP への新しい送信接続は失敗します。 ポートが使用可能になると、接続は成功します。 この枯渇は、IP アドレスからの 64,000 個のポートが多数のバックエンド インスタンスにわたってまばらに分散されている場合に発生します。 SNAT ポートの枯渇を軽減するためのガイダンスについては、[トラブルシューティング ガイド](./troubleshoot-outbound-connection.md)のページを参照してください。  

TCP 接続の場合、ロード バランサーにはすべての宛先 IP とポートに 1 つの SNAT ポートが使用されます。 この複数使用により、同じ SNAT ポートを使用した同じ宛先 IP への複数の接続が可能になります。 接続が別の宛先ポートに接続されていない場合、この複数使用は制限されます。

UDP 接続の場合、ロード バランサーには **ポート制限コーン NAT** アルゴリズムが使用されます。この場合、宛先ポートに関係なく、宛先 IP ごとに 1 つの SNAT ポートが使用されます。 

無制限の接続数に対して 1 つのポートが再利用されます。 ポートは、宛先 IP またはポートが異なる場合にのみ再利用されます。

## <a name="default-port-allocation"></a><a name="preallocatedports"></a> 既定のポート割り当て

ロード バランサーのフロントエンド IP として割り当てられた各パブリック IP には、バックエンド プール メンバー用に 64,000 個の SNAT ポートが割り当てられています。 ポートをバックエンド プール メンバーと共有することはできません。 リターン パケットが正しくルーティングされるようにするために、SNAT ポートの範囲は 1 つのバックエンド インスタンスでのみ使用できます。 

明示的なアウトバウンド規則を使用して SNAT ポートの割り当てを構成することをお勧めします。 この規則を使用して、各バックエンド インスタンスが送信接続に使用できる SNAT ポート数を最大限にします。 

負荷分散規則を介した送信 SNAT の自動割り当てを使用する場合、割り当てテーブルによってポートの割り当てが定義されます。

<a name="snatporttable"></a>次の表は、バックエンド プール サイズのレベルに対する SNAT ポートの事前割り当てを示しています。

| プール サイズ (VM インスタンス) | IP 構成あたりの事前に割り当てられる SNAT ポート |
| --- | --- |
| 1-50 | 1,024 |
| 51-100 | 512 |
| 101-200 | 256 |
| 201-400 | 128 |
| 401-800 | 64 |
| 801-1,000 | 32 | 

>[!NOTE]
> 最大サイズが 10 のバックエンド プールがある場合、明示的なアウトバウンド規則を定義すると、各インスタンスには 64,000/10 = 6,400 個のポートを割り当てることができます。 上の表によると、自動割り当てを選択した場合、それぞれに 1,024 個しかありません。

## <a name="outbound-rules-and-virtual-network-nat"></a><a name="outboundrules"></a> アウトバウンド規則と Virtual Network NAT

Azure Load Balancer のアウトバウンド規則と Virtual Network NAT は、仮想ネットワークからのエグレスに使用できるオプションです。

アウトバウンド規則の詳細については、[アウトバウンド規則](outbound-rules.md)に関するページを参照してください。

Azure Virtual Network NAT の詳細については、「[Azure Virtual Network NAT とは](../virtual-network/nat-overview.md)」を参照してください。

## <a name="constraints"></a>制約

*   新しいパケットが送信されず、接続がアイドル状態の場合、ポートは 4 から 120 分後に解放されます。
  * このしきい値は、アウトバウンド規則を使用して構成できます。
*   各 IP アドレスには、SNAT に使用できる 64,000 個のポートが用意されています。
*   各ポートは、宛先 IP アドレスへの TCP 接続と UDP 接続の両方に使用できます
  * 宛先ポートが一意であるかどうかに関係なく、UDP SNAT ポートが必要です。 宛先 IP への UDP 接続ごとに、1 つの UDP SNAT ポートが使用されます。
  * 宛先ポートが異なる場合、1 つの TCP SNAT ポートを同じ宛先 IP への複数の接続に使用できます。
*   SNAT の枯渇は、バックエンド インスタンスが特定の SNAT ポートによって使い果たされたときに発生します。 この場合も、ロード バランサーには未使用の SNAT ポートを使用することができます。 バックエンド インスタンスに使用されている SNAT ポート数が指定された SNAT ポート数を超えると、新しい送信接続を確立できなくなります。

## <a name="next-steps"></a>次のステップ

*   [SNAT の枯渇による送信接続エラーのトラブルシューティング](./troubleshoot-outbound-connection.md)
*   [SNAT メトリックを確認](./load-balancer-standard-diagnostics.md#how-do-i-check-my-snat-port-usage-and-allocation)し、それらをフィルター処理、分割、および表示する正しい方法を理解します。
