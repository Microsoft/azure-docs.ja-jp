---
title: ベスト プラクティス - Azure Batch
description: Azure Batch ソリューションを開発するためのベスト プラクティスと役立つヒントについて説明します。
author: LauraBrenner
ms.author: labrenne
ms.date: 11/22/2019
ms.service: batch
ms.topic: article
manager: evansma
ms.openlocfilehash: 16fb2786f180b1e28b76d9246d599a871278d00d
ms.sourcegitcommit: 21e33a0f3fda25c91e7670666c601ae3d422fb9c
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/05/2020
ms.locfileid: "77022734"
---
# <a name="azure-batch-best-practices"></a>Azure Batch のベスト プラクティス

この記事では、Azure Batch サービスを効果的かつ効率的に使用するための一連のベスト プラクティスについて説明します。 これらのベスト プラクティスは、Batch に関して Microsoft が蓄積してきたノウハウと、Batch ユーザーの皆様の経験に基づいています。 Batch の開発および使用中に設計上の落とし穴やパフォーマンスの潜在的な問題を回避し、アンチパターンに陥らないようにするために、この記事を理解することが重要です。

この記事では、次の内容について説明します。

> [!div class="checklist"]
> - ベスト プラクティスとは
> - ベストプラクティスを使用すべき理由
> - ベスト プラクティスに従わなかった場合に何が起こりうるか
> - ベスト プラクティスに従う方法

## <a name="pools"></a>プール

Batch プールは、Batch サービスでジョブを実行するためのコンピューティング リソースです。 以下のセクションでは、Batch プールを使用する際の優れたベスト プラクティスに関するガイダンスを提供します。

### <a name="pool-configuration-and-naming"></a>プールの構成と名前指定

- **プール割り当てモード**  
    Batch アカウントの作成時には、**Batch サービス**または**ユーザー サブスクリプション**の 2 つのプール割り当てモードのいずれかを選択できます。 ほとんどの場合、既定の Batch サービス モードを選択することになります。このモードでは、Batch で管理されているサブスクリプションにバックグラウンドでプールが割り当てられます。 もう一方のユーザー サブスクリプション モードでは、プールの作成時に Batch VM などのリソースがサブスクリプションに直接作成されます。 ユーザー サブスクリプション アカウントは主に、重要であるが小規模なシナリオのサブセットを有効にするために使用されます。 ユーザー サブスクリプション モードの詳細については、「[ユーザー サブスクリプション モードのための追加構成](batch-account-create-portal.md#additional-configuration-for-user-subscription-mode)」を参照してください。

- **ジョブからプールへのマッピングを決定するときに、ジョブとタスクの実行時間を考慮します。**  
    ジョブが主に実行時間の短いタスクで構成されていて、かつ予想されるタスクの総数が少ないため、ジョブで予想される全体的な実行時間が長くない場合は、ジョブごとに新しいプールを割り当てないでください。 ノードの割り当て時間により、ジョブの実行時間が減少します。

- **プールには複数の計算ノードが必要です。**  
    個々のノードが常に使用可能な状態であるとは限りません。 まれなケースですが、ハードウェア障害、オペレーティング システムの更新、その他の多くの問題によって、個々のノードがオフラインになることがあります。 Batch ワークロードの進捗が確実で保証されている必要がある場合、複数のノードでプールを割り当てる必要があります。

- **リソース名は再利用しないでください。**  
    多くの場合、Batch リソース (ジョブ、プールなど) は、時間の経過と共に作成されたり削除されたりします。 たとえば、月曜日にプールを作成し、火曜日に削除した後、木曜日に別のプールを作成することがあります。 新しく作成した各リソースには、以前に使用したことのない一意の名前を付ける必要があります。 一意の名前を付けるには、GUID を使用するか (リソース名全体、またはその一部として)、リソースが作成された時間をリソース名に埋め込みます。 Batch では [DisplayName](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.jobspecification.displayname?view=azure-dotnet) がサポートされています。これを使用すると、実際のリソース ID が人間にとってわかりやすいものではない場合でも、人が判読できる名前をリソースに付けることができます。 一意の名前を使用すると、ログとメトリックで何らかの処理を行った特定のリソースを簡単に識別できます。 また、リソースのサポート ケースを提出する必要がある場合にも、あいまいさが解消されます。

- **プールのメンテナンスおよび障害時の継続性。**  
    ジョブではプールを動的に使用することをお勧めします。 ジョブですべてのものに同じプールを使用する場合、プールで問題が発生した場合にジョブが実行されない可能性があります。 これは、時間の制約のあるワークロードでは特に重要です。 この問題を解決するには、各ジョブをスケジュールするときにプールを動的に選択または作成するか、異常なプールをバイパスできるようにプール名をオーバーライドする方法を用意しておきます。

- **プールのメンテナンスおよび障害時のビジネス継続性。**  
    プールが必要なサイズまで拡大するのを防ぐ原因として、内部エラーや容量の制約など、多くのことが考えられます。このため、必要に応じて、別のプールでジョブを再ターゲットできる状態にしておく必要があります (別の VM サイズが使用される可能性がありますが、これは [UpdateJob](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.protocol.joboperationsextensions.update?view=azure-dotnet) を介して Batch でサポートされます)。 削除や変更が行われないことを前提にして静的プール ID を使用することは避けてください。

### <a name="pool-lifetime-and-billing"></a>プールの有効期間と課金

プールの有効期間は、割り当ての方法とプール構成に適用されるオプションによって異なります。 プールには、任意の有効期間と、プール内の計算ノードのさまざまな数をいつでも指定できます。 プール内の計算ノードを明示的、またはサービスによって提供される機能 (自動スケーリングまたは自動プール) を介して管理するのはユーザーの責任です。

- **プールを最新の状態に保ちます。**  
    数か月ごとにプールのサイズをゼロに変更して、最新のノード エージェントの更新とバグ修正を確実に取得する必要があります。 プールは、再作成されない限り、または計算ノードのサイズが 0 に変更されない限り、ノード エージェントの更新を受け取りません。 プールを再作成またはサイズ変更する前に、デバッグ目的でノード エージェント ログをダウンロードすることをお勧めします (「[ノード](#nodes)」セクションを参照)。

- **プールの再作成**  
    同様に、プールを毎日削除して再作成することはお勧めしません。 代わりに、新しいプールを作成し、その新規プールを指すように既存のジョブを更新します。 すべてのタスクを新しいプールに移動したら、古いプールを削除します。

- **プールの効率と課金**  
    Batch 自体では追加料金は発生しませんが、使用されるコンピューティング リソースに対して料金が発生します。 プール内のすべての計算ノードに対して、その状態に関係なく課金されます。 これには、ストレージやネットワーク コストなど、ノードを実行するために必要な料金がすべて含まれます。 ベスト プラクティスの詳細については、「[Azure Batch のコスト分析と予算](budget.md)」を参照してください。

### <a name="pool-allocation-failures"></a>プール割り当ての失敗

プール割り当ての失敗は、最初の割り当て中またはその後のサイズ変更中の任意の時点で発生する可能性があります。 これは、リージョン内の一時的な容量不足や、Batch が使用している他の Azure サービスの障害が原因で発生する可能性があります。 コア クォータは保証ではなく、制限です。

### <a name="unplanned-downtime"></a>計画外のダウンタイム

Batch プールでは、Azure のダウンタイム イベントが発生する可能性があります。 Batch のシナリオまたはワークフローの計画および開発時には、この点に留意することが重要です。

ノードで障害が発生した場合、Batch は自動的にそれらの計算ノードを回復しようとします。 これにより、回復されたノードで実行中のタスクの再スケジュールがトリガーされることがあります。 中断されたタスクの詳細については、[再試行のための設計](#designing-for-retries-and-re-execution)に関するセクションを参照してください。

- **Azure リージョンの依存関係**  
    時間の制約のあるワークロードまたは運用ワークロードがある場合は、単一の Azure リージョンに依存しないようにすることをお勧めします。 まれに、リージョン全体に影響する可能性がある問題が発生することがあります。 たとえば、特定の時刻に処理を開始する必要がある場合は、*開始時刻の十分前に*、プライマリ リージョンでプールをスケールアップすることを検討してください。 プールのスケーリングに失敗した場合は、バックアップ リージョン (複数可) のプールのスケールアップにフォールバックできます。 さまざまなリージョンの複数のアカウントにまたがるプールには、他のプールで問題が発生した場合に、簡単にアクセスできるバックアップが用意されています。 詳細については、「[高可用性を実現するようにアプリケーションを設計する](high-availability-disaster-recovery.md)」を参照してください。

## <a name="jobs"></a>ジョブ

ジョブは、数百、数千、あるいは数百万ものタスクを含むように設計されたコンテナーです。

- **ジョブに多数のタスクを含めます**  
    1 つのジョブを使用して 1 つのタスクを実行するのは効率的ではありません。 たとえば、10 個のタスクをそれぞれ含む 100 個のジョブを作成するのではなく、1000 個のタスクを含む 1 つのジョブを使用する方が効率的です。 それぞれが 1 つのタスクを持つ 1000 個のジョブを実行することは、最も非効率的かつ低速で、最もコストがかかる方法です。  

    数千個のアクティブなジョブを同時に必要とする Batch ソリューションは設計しないでください。 タスクにはクォータがないため、できるだけ少ないジョブでできるだけ多くのタスクを実行すると、[ジョブとジョブ スケジュールのクォータ](batch-quota-limit.md#resource-quotas)が効率的に使用されます。

- **ジョブの有効期間**  
    Batch ジョブは、システムから削除されるまで無期限の有効期限を持っています。 ジョブの状態は、スケジューリングの際にさらに多くのタスクを受け入れることができるかどうかを示します。 明示的に終了されない限り、ジョブは自動的に完了状態に移行しません。 これは、[onAllTasksComplete](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.common.onalltaskscomplete?view=azure-dotnet) プロパティまたは [maxWallClockTime](https://docs.microsoft.com/rest/api/batchservice/job/add#jobconstraints) を使用して自動的にトリガーできます。

既定の[アクティブ ジョブおよびジョブ スケジュールのクォータ](batch-quota-limit.md#resource-quotas)があります。 完了状態のジョブおよびジョブ スケジュールは、このクォータにはカウントされません。

## <a name="tasks"></a>処理手順

タスクは、ジョブを構成する個々の作業単位です。 タスクはユーザーによって送信され、Batch によって計算ノードに対してスケジュールされます。 タスクを作成および実行する際には、いくつかの設計上の考慮事項があります。 以下のセクションでは、一般的なシナリオと、問題を処理して効率的に実行するためのタスクの設計方法について説明します。

- **タスク データをタスクの一部として保存します。**  
    計算ノードはその性質上、短い期間しか存在しません。 Batch には、自動プールや自動スケールなど、ノードの消失が容易に行われる多くの機能があります。 ノードが (サイズ変更やプールの削除により) プールを離れると、それらのノード上のすべてのファイルも削除されます。 このため、タスクが完了する前に、タスクの出力をタスクが実行されているノードから永続ストアに移動することをお勧めします。同様に、タスクが失敗した場合に、障害の診断に必要なログを永続ストアに移動することも推奨されます。 Batch には、[OutputFiles](batch-task-output-files.md) およびさまざまな共有ファイル システムを介してデータをアップロードするための Azure Storage サポートが統合されています。あるいは、タスクでのアップロードをユーザー自身で実行することもできます。

### <a name="task-lifetime"></a>タスクの有効期間

- **タスクが完了したら削除します。**  
    不要になったタスクを削除するか、[retentionTime](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.taskconstraints.retentiontime?view=azure-dotnet) タスク制約を設定します。 `retentionTime` が設定されている場合、`retentionTime` の有効期限が切れると、Batch はタスクによって使用されているディスク領域を自動的にクリーンアップします。  

    タスクを削除すると、次の 2 つのことが行われます。 ジョブ内にタスクが蓄積されなくなり、目的のタスクのクエリ/検索が容易にできなくなります (完了したタスクをフィルター処理する必要があるため)。 また、ノード上の対応するタスク データがクリーンアップされます (`retentionTime` にまだ達していない場合)。 これにより、ノードがタスク データでいっぱいにならず、ディスク領域が不足することがなくなります。

### <a name="task-submission"></a>タスクの送信

- **コレクション内で多数のタスクを送信します。**  
    タスクは、個別にまたはコレクションとして送信できます。 オーバーヘッドと送信時間を削減するためにタスクを一括送信する際に、一度に最大 100 個のタスクの[コレクション](https://docs.microsoft.com/rest/api/batchservice/task/addcollection)としてタスクを送信します。

### <a name="task-execution"></a>タスクの実行

- **ノードごとの最大タスク数の選択**  
    Batch では、ノードでのタスクのオーバーサブスクライブ (ノードが持つコアの数よりも多くのタスクを実行) をサポートしています。 プール内のノードにタスクが "適合する" ようにするのはユーザーの責任です。 たとえば、1 つのノードでそれぞれ 25% の CPU 使用量を消費する 8 個のタスクを (`maxTasksPerNode = 8` のプール内に) スケジュールしようとすると、ユーザー エクスペリエンスが低下する可能性があります。

### <a name="designing-for-retries-and-re-execution"></a>再試行と再実行のための設計

タスクは、Batch によって自動的に再試行できます。 再試行には、ユーザー制御と内部の 2 種類があります。 ユーザー制御の再試行は、タスクの [maxTaskRetryCount](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.taskconstraints.maxtaskretrycount?view=azure-dotnet) で指定されます。 タスクで指定されたプログラムがゼロ以外の終了コードで終了した場合、タスクは `maxTaskRetryCount` の値まで再試行されます。

まれなケースですが、計算ノードでの障害 (たとえば、内部状態を更新できない、タスクの実行中にノードで障害が発生したなど) によってタスクが内部的に再試行されることがあります。 タスクは、可能であれば、同じ計算ノード上で内部限度に達するまで再試行されます。その後、タスクの実行が中断されて、Batch で再スケジュール (別の計算ノード上の可能性があります) するためにタスクが延期されます。

- **持続的なタスクの構築**  
    タスクは、耐障害性があり、再試行に対応できるように設計する必要があります。 このことは、長時間実行されるタスクにとって特に重要です。 これを行うには、タスクが複数回実行されている場合でも、タスクによって同じ単一の結果が生成されるようにします。 これを達成する 1 つの方法は、タスクを "ゴール シーク" にすることです。 もう 1 つの方法は、タスクがべき等になるようにすることです (タスクの実行回数に関係なく、同じ結果が得られます)。

    一般的な例として、計算ノードにファイルをコピーするタスクが挙げられます。 単純な方法は、実行されるたびに、指定されたすべてのファイルをコピーするタスクを作成することですが、これは非効率的で、障害に耐えるように構築されていません。 代わりに、ファイルが計算ノードにあることを確認するタスク、つまり、既に存在するファイルを再度コピーしないタスクを作成します。 このようにして、タスクは中断された場合に、中断された場所から処理を再開します。

- **低優先度ノード**  
    タスクを専用ノードで実行する場合も低優先度ノードで実行する場合も、設計上の違いはありません。 タスクが低優先度ノードでの実行中に割り込まれた場合も、専用ノードでの障害によって中断された場合も、障害に耐えるようにタスクを設計することで両方の状況が緩和されます。

- **タスクの実行時間**  
    実行時間の短いタスクを作成しないようにしてください。 実行時間が 1 秒から 2 秒間のみのタスクは理想的ではありません。 個々のタスクでかなりの量の作業を行うようにする必要があります (10 秒以上、最大で数時間または数日)。 各タスクが1分間 (またはそれ以上) 実行されている場合、全体的な計算時間の割合としてのスケジュールのオーバーヘッドはわずかです。

## <a name="nodes"></a>Nodes

- **開始タスクはべき等にする必要があります**  
    他のタスクと同様に、ノードの開始タスクはノードが起動するたびに再実行されるため、べき等である必要があります。 べき等タスクとは、複数回実行したときに一貫した結果が得られる単純なタスクのことです。

- **オペレーティング システム サービスのインターフェイスを使用して、実行時間の長いサービスを管理します。**  
    たとえば、ノードからデータを収集して報告するために、ノード内の Batch エージェントと一緒に別のエージェントを実行する必要がある場合があります。 これらのエージェントは、Windows サービスや Linux `systemd` サービスなどの OS サービスとしてデプロイすることをお勧めします。  

    これらのサービスを実行する場合、ノード上の Batch 管理ディレクトリ内のどのファイルに対してもファイル ロックを取得してはなりません。ファイル ロックを取得すると、ファイル ロックが原因でこれらのディレクトリを Batch で削除できなくなるためです。 たとえば、Windows サービスを開始タスクにインストールする場合、開始タスクの作業ディレクトリから直接サービスを起動するのではなく、ファイルを別の場所にコピーします (ファイルが存在する場合は、コピーをスキップします)。 その場所からサービスをインストールします。 バッチが開始タスクを再実行すると、開始タスクの作業ディレクトリが削除され、再度作成されます。 これは、サービスが開始タスクの作業ディレクトリではなく、他のディレクトリに対してファイル ロックを持っているために機能します。

- **Windows ではディレクトリ ジャンクションの作成は避けます**  
    ディレクトリ ジャンクション (ディレクトリのハードリンクと呼ばれることもあります) は、タスクおよびジョブのクリーンアップ時の処理が困難です。 ハードリンクではなく、シンボリックリンク (ソフトリンク) を使用します。

- **問題が発生した場合に Batch エージェントログを収集します**  
    ノードまたはノードで実行されているタスクの動作に関連する問題が発生した場合は、該当するノードの割り当てを解除する前に、Batch エージェント ログを収集することをお勧めします。 Batch エージェント ログは、Batch サービス ログのアップロード API を使用して収集できます。 これらのログは、サポート チケットの一部として Microsoft に提供することができ、問題のトラブルシューティングと解決に役立ちます。

## <a name="security"></a>Security

### <a name="security-isolation"></a>セキュリティ分離

分離のために、シナリオでジョブを相互に分離する必要がある場合は、それらのジョブを別々のプールに配置して分離する必要があります。 プールは、Batch のセキュリティ分離の境界であり、既定では、2つのプールは表示されないか、相互に通信できません。 分離の手段として、別個の Batch アカウントを使用しないでください。

## <a name="moving"></a>移動

### <a name="move-batch-account-across-regions"></a>リージョン間で Batch アカウントを移動する 

既存の Batch アカウントをリージョン間で移動することが必要になるさまざまなシナリオがあります。 たとえば、ディザスター リカバリー計画の一部として、別のリージョンに移動することが必要な場合があります。

Azure Batch アカウントをリージョン間で移動することはできません。 ただし、Azure Resource Manager テンプレートを使用して、Batch アカウントの既存の構成をエクスポートすることはできます。  その後、Batch アカウントをテンプレートにエクスポートすることで別のリージョンにリソースをステージし、移動先リージョンに合わせてパラメーターを変更してから、新しいリージョンにテンプレートをデプロイできます。 テンプレートを新しいリージョンにアップロードした後、証明書、ジョブ スケジュール、アプリケーション パッケージを再作成する必要があります。 変更をコミットして、Batch アカウントの移動を完了するには、元の Batch アカウントまたはリソース グループを忘れずに削除してください。  

Resource Manager とテンプレートの詳細については、「[クイック スタート: Azure portal を使用した Azure Resource Manager テンプレートの作成とデプロイ](https://docs.microsoft.com/azure/azure-resource-manager/resource-manager-quickstart-create-templates-use-the-portal)」を参照してください。


