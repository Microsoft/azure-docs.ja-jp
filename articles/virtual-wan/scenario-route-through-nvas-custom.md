---
title: カスタム設定を使用して NVA 経由でトラフィックをルーティングする
titleSuffix: Azure Virtual WAN
description: このシナリオでは、インターネットへのトラフィックに別の NVA を使用することで、NVA 経由でトラフィックをルーティングできます。
services: virtual-wan
author: cherylmc
ms.service: virtual-wan
ms.topic: conceptual
ms.date: 09/22/2020
ms.author: cherylmc
ms.custom: fasttrack-edit
ms.openlocfilehash: 8e51d7d00120f6facb0fb53a8e379d157ae79ea4
ms.sourcegitcommit: 2f9f306fa5224595fa5f8ec6af498a0df4de08a8
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/28/2021
ms.locfileid: "98938573"
---
# <a name="scenario-route-traffic-through-nvas-by-using-custom-settings"></a>シナリオ:カスタム設定を使用して NVA 経由でトラフィックをルーティングする

Azure Virtual WAN 仮想ハブのルーティングを使用している場合は、いくつかのオプションを使用できます。 この記事では、仮想ネットワークとブランチの間の通信に対してネットワーク仮想アプライアンス (NVA) 経由でトラフィックをルーティングし、インターネットへのトラフィックに対して別の NVA を使用することに焦点を当てます。 詳細については、「[仮想ハブ ルーティングについて](about-virtual-hub-routing.md)」を参照してください。

## <a name="design"></a>デザイン

* **スポーク** - 仮想ハブに接続されている仮想ネットワーク (例については、この記事の後出の図の VNet 1、VNet 2、VNet 3 をご覧ください)。
* **サービス VNet** - ユーザーがインターネット以外のトラフィックを検査するために NVA をデプロイした仮想ネットワーク。スポークによってアクセスされる一般的なサービスが提供される場合もあります (例については、この記事の後出の図の VNet 4 をご覧ください)。 
* **境界 VNet** - ユーザーがインターネットにバインドされたトラフィックを検査するために使用する NVA をデプロイした仮想ネットワーク (例については、この記事の後出の図の VNet 5 をご覧ください)。
* **ハブ** - Microsoft が管理する Virtual WAN ハブ。

次の表に、このシナリオでサポートされる接続の概要を示します。

| ソース          | 終了|スポーク|サービス VNet|ブランチ|インターネット|
|---|---|:---:|:---:|:---:|:---:|:---:|
| **スポーク**| ->| 直接 |直接 | サービス VNet 経由 |境界 VNet 経由 |
| **サービス VNet**| ->| 直接 |該当なし| 直接 | |
| **ブランチ** | ->| サービス VNet 経由 |直接| 直接 |  |

接続マトリックスの各セルは、接続が Virtual WAN 経由で直接送信されるか、または NVA を使用するいずれかの仮想ネットワーク経由で送信されるかを示します。 

次の詳細に注意します。
* スポーク:
  * スポークは、Virtual WAN ハブ経由で他のスポークに直接接続します。
  * スポークは、サービス VNet を指す静的ルート経由でブランチに接続します。 ブランチから特定のプレフィックスを学習することはありません。これらはより具体的で、概要をオーバーライドするためです。
  * スポークは、直接 VNet ピアリングを使用して、インターネット トラフィックを境界 VNet に送信します。
* ブランチは、サービス VNet を指す静的ルーティングを使用してスポークにアクセスします。 概要の静的ルートをオーバーライドする特定のプレフィックスを仮想ネットワークから学習することはありません。
* サービス VNet は、すべての仮想ネットワークとすべてのブランチから到達可能である必要がある共有サービス VNet に似ています。
* 境界 VNet は、Virtual WAN 経由の接続を必要としません。これは、サポートされるトラフィックのみが直接仮想ネットワーク ピアリングを経由するためです。 ただし、構成を簡略化するために、境界 VNet と同じ接続モデルを使用します。

異なる接続パターンが 3 つあり、3 つのルーティング テーブルに変換されます。 異なる仮想ネットワークへの関連付けは次のとおりです。

* スポーク:
  * 関連付けられたルーティング テーブル:**RT_V2B**
  * ルーティング テーブルへの伝達:**RT_V2B** と **RT_SHARED**
* NVA VNet (サービス VNet と DMZ VNet):
  * 関連付けられたルーティング テーブル:**RT_SHARED**
  * ルーティング テーブルへの伝達:**RT_SHARED**
* ブランチ:
  * 関連付けられたルート テーブル: **[Default]**
  * ルート テーブルへの伝達:**RT_SHARED** と **Default**

> [!NOTE] 
> スポーク VNet が既定のラベルに反映されていないことを確認してください。 これにより、ブランチからスポーク VNet へのトラフィックは、NVA に転送されます。

これらの静的ルートにより、仮想ネットワークとブランチとの間のトラフィックは、サービス VNet (VNet 4) の NVA を経由するようになります。

| Description | ルート テーブル | 静的ルート              |
| ----------- | ----------- | ------------------------- |
| ブランチ    | RT_V2B      | 10.2.0.0/16 -> vnet4conn  |
| NVA スポーク  | Default     | 10.1.0.0/16 -> vnet4conn  |

これで、Virtual WAN を使用して、パケットを送信するための適切な接続を選択できるようになりました。 また、Virtual WAN を使用して、これらのパケットを受信するときに実行する適切な操作を選択する必要があります。 このためには、次のように接続ルート テーブルを使用します。

| Description | Connection | 静的ルート            |
| ----------- | ---------- | ----------------------- |
| VNet2Branch | vnet4conn  | 10.2.0.0/16 -> 10.4.0.5 |
| Branch2VNet | vnet4conn  | 10.1.0.0/16 -> 10.4.0.5 |

詳細については、「[仮想ハブ ルーティングについて](about-virtual-hub-routing.md)」を参照してください。

## <a name="architecture"></a>アーキテクチャ

この記事で既に説明したアーキテクチャの図を次に示します。

**Hub 1** と呼ばれるハブが 1 つあります。

* **Hub 1** は、NVA VNet の **VNet 4** および **VNet 5** に直接接続されています。

* VNet 1、2、3、およびブランチ間のトラフィックは、**VNet 4 NVA** 10.4.0.5 経由で送信されることが想定されています。

* VNet 1、2、3 からインターネットへのトラフィックは、すべて **VNet 5 NVA** 10.5.0.5 経由で送信されることが想定されています。

:::image type="content" source="./media/routing-scenarios/nva-custom/figure-1.png" alt-text="ネットワーク アーキテクチャの図。":::

## <a name="workflow"></a>ワークフロー

NVA 経由のルーティングを設定するには、次のような手順を検討します。

1. インターネットへのトラフィックが VNet 5 経由で送信されるようにするために、VNet 1、2、3 を仮想ネットワーク ピアリング経由で VNet 5 に直接接続する必要があります。 また、仮想ネットワーク内に 0.0.0.0/0 および次ホップ 10.5.0.5 に対してユーザー定義ルートを設定する必要があります。 現在、Virtual WAN では、0.0.0.0/0 に対して仮想ハブで次ホップの NVA を設定することは許可されていません。

1. Azure portal で仮想ハブにアクセスし、**RT_Shared** という名前のカスタム ルート テーブルを作成します。 このテーブルは、すべての仮想ネットワークとブランチ接続からの伝達によるルートを学習します。 この空のテーブルを、次の図に示します。

   * **[ルート]:** 静的ルートを追加する必要はありません。

   * **[関連付け]:** VNet 4 と 5 を選択します。これは、これらの仮想ネットワークの接続がルート テーブル **RT_Shared** に関連付けられていることを意味します。

   * **[伝達]:** すべてのブランチと仮想ネットワークの接続からこのルート テーブルに対して動的にルートが伝達されるようにする必要があるため、ブランチとすべての仮想ネットワークを選択します。

1. VNet 1、2、3 からブランチにトラフィックを転送するために、**RT_V2B** という名前のカスタム ルート テーブルを作成します。

   * **[ルート]:** ブランチに対する集約静的ルート エントリを追加し、次ホップを VNet 4 接続として指定します。 ブランチのプレフィックスに対して VNet 4 の接続で静的ルートを構成し、次ホップが VNet 4 の NVA の特定の IP になるように指定します。

   * **[関連付け]:** VNet 1、2、3 をすべて選択します。 これは、VNet 接続 1、2、および 3 がこのルート テーブルに関連付けられ、このルート テーブルで (静的および伝達によって動的) ルートを学習できるようになるという意味です。

   * **[伝達]:** 接続からルート テーブルにルートが伝達されます。 VNet 1、2、3 を選択すると、VNet 1、2、3 からこのルート テーブルにルートを伝達できるようになります。 ブランチ接続から **RT_V2B** にルートを伝達する必要はありません。ブランチ仮想ネットワークのトラフィックは VNet 4 の NVA 経由で送信されるためです。
  
1. 既定のルート テーブル **DefaultRouteTable** を編集します。

   すべての VPN、Azure ExpressRoute、およびユーザー VPN 接続は、既定のルート テーブルに関連付けられます。 すべての VPN、ExpressRoute、およびユーザー VPN 接続では、同じルート テーブルのセットにルートが伝達されます。

   * **[ルート]:** VNet 1、2、3 に対する集約静的ルート エントリを追加し、次ホップを VNet 4 接続として指定します。 VNet 1、2、3 の集約プレフィックスに対して VNet 4 の接続で静的ルートを構成し、次ホップが VNet 4 の NVA の特定の IP になるように指定します。

   * **[関連付け]:** ブランチ (VPN/ER/P2S) のオプションが選択されていることを確認し、オンプレミス ブランチ接続が既定のルート テーブルに関連付けられるようにします。

   * **[Propagation from]\(伝達元\):** ブランチ (VPN/ER/P2S) のオプションが選択されていることを確認し、オンプレミス接続が既定のルート テーブルにルートを伝達するようにします。

:::image type="content" source="./media/routing-scenarios/nva-custom/figure-2.png" alt-text="ワークフローの図。" lightbox="./media/routing-scenarios/nva-custom/figure-2.png":::

## <a name="next-steps"></a>次のステップ

* Virtual WAN の詳細については、[FAQ](virtual-wan-faq.md) を参照してください。
* 仮想ハブ ルーティングの詳細については、「[仮想ハブのルーティングについて](about-virtual-hub-routing.md)」を参照してください。
