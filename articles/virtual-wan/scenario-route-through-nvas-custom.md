---
title: シナリオ:カスタム設定を使用して NVA 経由でトラフィックをルーティングする
titleSuffix: Azure Virtual WAN
description: このシナリオでは、NVA 経由でトラフィックをルーティングし、インターネットへのトラフィックには別の NVA を使用することができます。
services: virtual-wan
author: cherylmc
ms.service: virtual-wan
ms.topic: conceptual
ms.date: 08/06/2020
ms.author: cherylmc
ms.custom: fasttrack-edit
ms.openlocfilehash: 5546fc63b01d1da6b4033e071ac071574ab9699a
ms.sourcegitcommit: 25bb515efe62bfb8a8377293b56c3163f46122bf
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/07/2020
ms.locfileid: "87987208"
---
# <a name="scenario-route-traffic-through-nvas---custom-preview"></a>シナリオ:NVA 経由でトラフィックをルーティングする - カスタム (プレビュー)

Virtual WAN の仮想ハブ ルーティングを使用する場合、多くのシナリオを利用できます。 この NVA (ネットワーク仮想アプライアンス) シナリオでは、VNet とブランチの間の通信に対して NVA 経由でトラフィックをルーティングし、インターネットへのトラフィックに対して別の NVA を使用することが目標です。 仮想ハブ ルーティングの詳細については、「[仮想ハブのルーティングについて](about-virtual-hub-routing.md)」を参照してください。

## <a name="design"></a><a name="design"></a>デザイン

このシナリオでは、次の名前付け規則を使用します。

* "サービス VNet" - ユーザーがインターネット以外のトラフィックを検査するために NVA (**図 1** の VNet 4) をデプロイした仮想ネットワーク。
* "DMZ VNet" - ユーザーがインターネットにバインドされたトラフィックを検査するために使用する NVA をデプロイした仮想ネットワーク (**図 1** の VNet 5 )。
* "NVA スポーク" - NVA VNet に接続されている仮想ネットワーク (**図 1** の VNet 1、VNet 2、および VNet 3 )。
* "ハブ" - Microsoft が管理する Virtual WAN ハブ。

次の接続マトリックスは、このシナリオでサポートされるフローの概要を示しています。

**接続マトリックス**

| ソース          | 移動先:|*NVA スポーク*|*サービス VNet*|*DMZ VNet*|*静的ブランチ*|
|---|---|---|---|---|---|
| **NVA スポーク**| &#8594;|      X |            X |   ピアリング |    静的    |
| **サービス VNet**| &#8594;|    X |            X |      X    |      X       |
| **DMZ VNet** | &#8594;|       X |            X |      X    |      X       |
| **ブランチ** | &#8594;|  静的 |            X |      X    |      X       |

接続マトリックスの各セルは、特定のトラフィック フローについて、Virtual WAN 接続 (フローの "ソース" 側、行ヘッダー) が宛先プレフィックス (フローの "ターゲット" 側、斜体の列ヘッダー) を学習するかどうかを説明しています。 各行について詳しく説明します。

* NVA スポーク:
  * スポークは、Virtual WAN ハブ経由で他のスポークに直接接続します。
  * スポークは、サービス VNet を指す静的ルート経由でブランチに接続します。 ブランチから特定のプレフィックスを学習しないようにする必要があります (そうしないと、より固有なものになり、この概要がオーバーライドされます)。
  * スポークは、直接 VNet ピアリングを使用して、インターネット トラフィックを DMZ VNet に送信します。
* ブランチ:
  * ブランチは、サービス VNet を指す静的ルーティングを使用してスポークにアクセスします。 概要の静的ルートをオーバーライドする特定のプレフィックスを Vnet から学習しないようにする必要があります。
* サービス VNet は、すべての VNet とすべてのブランチから到達可能である必要がある共有サービス VNet に似ています。
* DMZ VNet は、Virtual WAN 経由の接続を実際には必要としません。これは、サポートするトラフィックを直接 VNet ピアリング経由で受信するためです。 ただし、DMZ VNet と同じ接続モデルを使用して、構成を簡略化します。

このため、この接続マトリックスには 3 つの異なる接続パターンがあり、3 つのルーティング テーブルに変換されます。 異なる Vnet への関連付けは、次のようになります。

* NVA スポーク:
  * 関連付けられたルーティング テーブル:**RT_V2B**
  * ルーティング テーブルへの伝達:**RT_V2B** と **RT_SHARED**
* NVA Vnet (内部およびインターネット):
  * 関連付けられたルーティング テーブル:**RT_SHARED**
  * ルーティング テーブルへの伝達:**RT_SHARED**
* ブランチ:
  * 関連付けられたルーティング テーブル: **[Default]**
  * ルーティング テーブルへの伝達:**RT_SHARED** と **Default**

これらの静的ルートは、VNet からブランチおよびブランチから VNet へのトラフィックがサービス VNet (VNet 4) の NVA を通過するようにするために必要となります。

| Description | ルート テーブル | 静的ルート              |
| ----------- | ----------- | ------------------------- |
| ブランチ    | RT_V2B      | 10.2.0.0/16 -> vnet4conn  |
| NVA スポーク  | Default     | 10.1.0.0/16 -> vnet4conn  |

これで、パケットを送信する接続を Virtual WAN が認識するようになりましたが、接続はこれらのパケットを受信したときに行う処理を認識している必要があります。ここで、接続ルーティング テーブルが使用されます。

| 説明 | Connection | 静的ルート            |
| ----------- | ---------- | ----------------------- |
| VNet2Branch | vnet4conn  | 10.2.0.0/16 -> 10.4.0.5 |
| Branch2VNet | vnet4conn  | 10.1.0.0/16 -> 10.4.0.5 |

この時点で、すべての準備が整いました。

仮想ハブ ルーティングの詳細については、「[仮想ハブのルーティングについて](about-virtual-hub-routing.md)」を参照してください。

## <a name="architecture"></a><a name="architecture"></a>アーキテクチャ

**図 1** には、1 つのハブ (**Hub 1**) があります。

* **Hub 1** は、NVA VNet の **VNet 4** および **VNet 5** に直接接続されています。

* VNet 1、2、3、およびブランチ (VPN/ER/P2S) 間のトラフィックは、**VNet 4 NVA** 10.4.0.5 経由で送信されることが想定されています。

* VNet 1、2、3 からインターネットへのトラフィックは、すべて **VNet 5 NVA** 10.5.0.5 経由で送信されることが想定されています。

**図 1**

:::image type="content" source="./media/routing-scenarios/nva-custom/figure-1.png" alt-text="図 1":::

## <a name="workflow"></a><a name="workflow"></a>ワークフロー

NVA 経由のルーティングを設定するには、次のような手順を検討します。

1. インターネットへのトラフィックが VNet 5 経由で送信されるようにするために、VNet 1、2、3 を VNet ピアリング経由で VNet 5 に直接接続する必要があります。 また、0.0.0.0/0 と次ホップ 10.5.0.5 に対して VNet の UDR を設定する必要もあります。 現在、Virtual WAN では、0.0.0.0/0 に対して仮想ハブで次ホップの NVA を設定することは許可されていません。

1. Azure portal で仮想ハブに移動し、すべての VNet およびブランチ接続からの伝達を通じてルートを学習するカスタム ルート テーブル **RT_Shared** を作成します。 **図 2** では、空のカスタム ルート テーブル **RT_Shared** として表されています。

   * **[ルート]:** 静的ルートを追加する必要はありません。

   * **[関連付け]:** VNet 4 と 5 を選択します。VNet 4 と 5 の接続がルーティング テーブル **RT_Shared** に関連付けられるという意味です。

   * **[伝達]:** すべてのブランチと VNet の接続からこのルート テーブルに対して動的にルートが伝達されるようにする必要があるため、ブランチとすべての VNet を選択します。

1. VNet 1、2、3 からブランチにトラフィックを転送するためのカスタム ルーティング テーブル **RT_V2B** を作成します。

   * **[ルート]:** ブランチ (VPN/ER/P2S) に対する集約静的ルート エントリ (**図 2** の 10.2.0.0/16) を追加し、次ホップを VNet 4 接続として指定します。 また、ブランチのプレフィックスに対して VNet 4 の接続で静的ルートを構成し、次ホップが VNet 4 の NVA の特定の IP になるように指定する必要もあります。

   * **[関連付け]:** VNet 1、2、3 をすべて選択します。 これは、VNet 接続 1、2、および 3 がこのルート テーブルに関連付けられ、このルート テーブルで (静的および伝達によって動的) ルートを学習できるようになるという意味です。

   * **[伝達]:** 接続からルート テーブルにルートが伝達されます。 VNet 1、2、3 を選択すると、VNet 1、2、3 からこのルーティング テーブルにルートを伝達できるようになります。 ブランチ接続から RT_V2B にルートを伝達する必要はありません。ブランチ VNet のトラフィックは VNet 4 の NVA 経由で送信されるためです。
  
1. 既定のルート テーブル **DefaultRouteTable** を編集します。

   すべての VPN、ExpressRoute、およびユーザー VPN 接続は、既定のルート テーブルに関連付けられます。 すべての VPN、ExpressRoute、およびユーザー VPN 接続からは、同じルート テーブルのセットにルートが伝達されます。

   * **[ルート]:** VNet 1、2、3 に対する集約静的ルート エントリ (**図 2** の 10.1.0.0/16) を追加し、次ホップを VNet 4 接続として指定します。 また、VNet 1、2、3 の集約プレフィックスに対して VNet 4 の接続で静的ルートを構成し、次ホップが VNet 4 の NVA の特定の IP になるように指定する必要もあります。

   * **[関連付け]:** ブランチ (VPN/ER/P2S) のオプションが選択されていることを確認し、オンプレミス ブランチ接続が *defaultroutetable* に関連付けられるようにします。

   * **[Propagation from]\(伝達元\):** ブランチ (VPN/ER/P2S) のオプションが選択されていることを確認し、オンプレミス接続から *defaultroutetable* にルートが伝達されるようにします。

**図 2**

:::image type="content" source="./media/routing-scenarios/nva-custom/figure-2.png" alt-text="図 2" lightbox="./media/routing-scenarios/nva-custom/figure-2.png":::

## <a name="next-steps"></a>次のステップ

* Virtual WAN の詳細については、[FAQ](virtual-wan-faq.md) を参照してください。
* 仮想ハブ ルーティングの詳細については、「[仮想ハブのルーティングについて](about-virtual-hub-routing.md)」を参照してください。
