---
title: Azure VM バックアップについて
description: Azure VM バックアップについて、また、いくつかのベスト プラクティスについて説明します。
services: backup
author: rayne-wiselman
manager: carmonm
ms.service: backup
ms.topic: conceptual
ms.date: 12/11/2018
ms.author: raynew
ms.openlocfilehash: 9a80671a72f059e24a8cebc5de803af9261ad829
ms.sourcegitcommit: 21466e845ceab74aff3ebfd541e020e0313e43d9
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 12/21/2018
ms.locfileid: "53743954"
---
# <a name="about-azure-vm-backup"></a>Azure VM バックアップについて

この記事では、[Azure Backup サービス](backup-introduction-to-azure-backup.md)が Azure VM をどのようにバックアップするかについて説明します。

## <a name="backup-process"></a>バックアップ プロセス

Azure Backup が Azure VM のバックアップを完了する方法を説明します。

1. バックアップの対象として選択されている Azure VM に対して、Azure Backup サービスはユーザーが指定したバックアップ スケジュールに従ってバックアップ ジョブを開始します。
2. サービスはバックアップの拡張機能をトリガーします。
    - Windows VM は _VMSnapshot_ 拡張機能を使用します。
    - Linux VM は _VMSnapshotLinux_ 拡張機能を使用します。
    - 拡張機能は、最初の VM バックアップ中にインストールされます。
    - 拡張機能をインストールするには、VM が実行されている必要があります。
    - VM が実行されていない場合、Backup サービスは基盤となるストレージのスナップショットを取ります (VM が停止している間はアプリケーション書き込みが行われないため)。
4. バックアップ拡張機能によってストレージレベルのアプリ整合性スナップショットが作成されます。
5. スナップショットが作成されると、データはバックアップ コンテナーに転送されます。 効率を最大に高めるために、前回のバックアップ以降に変更されたデータ ブロック (差分) が特定され、そのデータのみが転送されます。
5. データ転送が完了すると、スナップショットが削除され、回復ポイントが作成されます。

![Azure 仮想マシンのバックアップ アーキテクチャ](./media/backup-azure-vms-introduction/vmbackup-architecture.png)

## <a name="data-encryption"></a>データの暗号化

Azure Backup では、データはバックアップ プロセスの一部として暗号化されません。 Azure Backup では、Azure Disk Encryption を使用して暗号化された Azure VM のバックアップがサポートされています。

- マネージドおよびアンマネージド Azure VM については、Bitlocker 暗号化キー (BEK) のみで暗号化された VM、およびキー暗号化キー (KEK) で暗号化された BEK がサポートされています。
- 認証されたユーザーによってキー コンテナーに復元される場合のみ読み取りと使用が可能となるように、BEK (シークレット) と KEK (キー) バックアップがバックアップされます。
- BEK もバックアップされるため、BEK が失われた場合、認証されたユーザーは BEK を KeyVault に復元し、暗号化された VM を回復できます。 暗号化された VM のキーとシークレットは、暗号化形式でバックアップされるため、認証されていないユーザーや Azure はいずれもバックアップされたキーやシークレットを読み取ったり使用したりすることはできません。 正しいレベルの権限を持つユーザーのみが暗号化された VM、およびキーとシークレットをバックアップして復元できます。

## <a name="snapshot-consistency"></a>スナップショットの整合性

アプリの実行中にスナップショットを作成するために、Azure Backup ではアプリ整合性スナップショットを作成します。

- **Windows VM**:Windows VM については、Backup サービスはボリューム シャドウ コピー サービス (VSS) と連携して VM のディスクの一貫したスナップショットを取得します。
    - 既定では、Azure Backup は完全 VSS バックアップを取得します。 [詳細情報](http://blogs.technet.com/b/filecab/archive/2008/05/21/what-is-the-difference-between-vss-full-backup-and-vss-copy-backup-in-windows-server-2008.aspx)。
    - Azure Backup が VSS コピー バックアップを作成するように設定を変更する場合は、以下のレジストリ キーを設定してください。
        ```
        [HKEY_LOCAL_MACHINE\SOFTWARE\MICROSOFT\BCDRAGENT]
        ""USEVSSCOPYBACKUP"="TRUE"
        ```
- **Linux VM**:Azure Backup がスナップショットを作成する場合に Linux VM にアプリケーション整合性を持たせるには、Linux 事前/事後スクリプト フレームワークを使用します。 VM スナップショットを取るときの整合性を確保できるよう自分のカスタム スクリプトを記述することができます。
    -  Azure Backup は、ユーザーが書き込んだ事前スクリプトと事後スクリプトだけを呼び出します。
    - 事前スクリプトと事後スクリプトが正常に実行されると、Azure Backup は復旧ポイントをアプリケーション整合性としてマークします。 ただし、カスタム スクリプトを使用したときのアプリケーション整合性の最終的な責任はユーザーが担います。
    - スクリプトの構成の[詳細](backup-azure-linux-app-consistent.md)を確認します。


#### <a name="consistency-types"></a>整合性の種類

次の表で、整合性の種類について説明します。

**スナップショット** | **VSS ベース** | **詳細** | **復旧**
--- | --- | --- | ---
**アプリケーションの整合性** | あり (Windows のみ) | アプリ整合性バックアップでは、メモリの内容と保留中の I/O 操作がキャプチャされます。 アプリ整合性スナップショットでは、バックアップが発生する前にアプリ データの整合性を保証する VSS ライター (または Linux の事前/事後スクリプト) を使用します。 | アプリ整合性スナップショットで復旧する場合、VM が起動します。 データの損失や破損はありません。 アプリは整合性が確保された状態で開始します。
**ファイル システム整合性** | あり (Windows のみ) |  ファイル整合性バックアップでは、同時にすべてのファイルのスナップショットを作成することでディスク ファイルの整合性バックアップを提供します。<br/><br/> Azure Backup の復旧ポイントは次についてのファイル整合性です。<br/><br/> - 事前/事後スクリプトのない、または失敗したスクリプのある Linux VM のバックアップ。<br/><br/> - VSS が失敗した Windows VM のバックアップ。 | ファイル整合性スナップショットによる復旧では、VM が起動します。 データの損失や破損はありません。 復元されたデータに一貫性が保たれるようにするために、アプリは独自の "修正" メカニズムを実装する必要があります。
**クラッシュ整合性** | いいえ  | クラッシュ整合性は多くの場合、バックアップ時に Azure VM がシャットダウンされるときに発生します。  バックアップ時にディスクに既に存在していたデータのみが、キャプチャされバックアップされます。<br/><br/> クラッシュ整合性の復旧ポイントは、オペレーティング システムやアプリのデータ整合性を保証しません。 | 保証はありませんが、通常、VM が起動します。その後、ディスク検査が実行されて、破損エラーが修正されます。 メモリ内にあったデータやディスクに転送されなかった書き込みは、すべて失われます。 アプリは独自のデータ検証を実装しています。 たとえば、データベース アプリの場合、トランザクション ログにデータベース内に存在しないエントリが含まれている場合、データベース ソフトウェアはデータの整合性が得られるまでロールします。


## <a name="service-and-subscription-limits"></a>サービスとサブスクリプションの制限

Azure Backup にはサブスクリプションとコンテナーについてさまざまな制限があります。

[!INCLUDE [azure-backup-limits](../../includes/azure-backup-limits.md)]


## <a name="backup-performance"></a>バックアップ パフォーマンス

### <a name="disk-considerations"></a>ディスクに関する考慮事項

バックアップでは、可能な限り早く完了しようとして、可能なだけ多くのリソースを消費します。

- 速度を最大にするため、バックアップ プロセスは各 VM のディスクを 「並列」でバックアップしようとします。
- たとえば、VM にディスクが 4 つある場合、サービスは 4 つすべてのディスクを並列でバックアップしようとします。
- バックアップしているディスクの数は、ストレージ アカウント バックアップ トラフィックを決定する際に最も重要な要因です。
- すべての I/O 操作には 1 秒あたり 60 MB の 「*単一 BLOB のターゲット スループット*」の制限があります。
- バックアップ対象の各ディスクは、Azure Backup がディスク上のブロックを読み込み、変更されたデータのみを格納します (増分バックアップ)。 以下の平均的なスループット値を使用して特定のサイズのディスクをバックアップするために必要な時間を見積もることができます。

    **操作** | **最適なスループット**
    --- | ---
    初回バックアップ | 160 Mbps |
    増分バックアップ | 640 Mbps  <br><br> 差分データがディスク全体に分散している場合、スループットが大幅に低下します。|



### <a name="scheduling-considerations"></a>スケジュールに関する考慮事項

スケジュールのバックアップは、パフォーマンスに影響します。

- すべての VM が同時にバックアップされるようにポリシーを構成した場合、バックアップ プロセスはすべてのディスクを並行にバックアップしようとするため、トラフィックが輻輳します。
- バックアップ トラフィックを減らすには、重複がないよう、異なる VM を一日の異なる時間にバックアップします。


### <a name="time-considerations"></a>時間に関する考慮事項

バックアップ時間のほとんどはデータの読み取りとコピーに費やされますが、VM のバックアップには、他にも必要な合計時間が増える操作があります。

- **バックアップ拡張機能のインストール**:バックアップ拡張機能のインストールまたは更新の所要時間。
- **スナップショットのトリガー**:スナップショットをトリガーするのにかかった時間です。 スナップショットは、スケジュールされたバックアップ時刻の近くでトリガーされます。
- **キューの待機時間**:バックアップ サービスにより複数の顧客ストレージ アカウントからのジョブが同時に処理されるため、スナップショットは Recovery Services コンテナーにすぐにコピーされないことがあります。 負荷のピーク時には、バックアップが処理されるまでに最大 8 時間がかかることがあります。 ただし、毎日のバックアップ ポリシーでは、VM バックアップの合計時間は 24 時間未満になります。
- **初回バックアップ**:増分バックアップには 24 時間未満の合計バックアップ時間が有効ですが、初回バックアップには有効ではないことがあります。 必要な時間はデータのサイズとバックアップが取得された時間に応じて異なります。
- **データ転送時間**:バックアップ サービスが前回のバックアップからの増分変更を計算し、これらの変更をコンテナー ストレージに転送するために必要な時間です。

### <a name="factors-affecting-backup-time"></a>バックアップ時間に影響する要因

バックアップは、スナップショットの作成と、コンテナーへのスナップショットの転送という、2 つのフェーズで構成されています。 Backup サービスはストレージ用に最適化されます。

- スナップショット データをコンテナーに転送するとき、サービスは前のスナップショットからの増分変更のみを転送します。
- 増分変更を特定するため、サービスはブロックのチェックサムを計算します。
    - 変更されたブロックは、コンテナーに送信されるブロックとして識別されます。
    - サービスは識別された各ブロックをさらに詳しく調べて、転送するデータを最小化する可能性を探ります。
    - 変更されたブロックをすべて評価した後、サービスは変更箇所を結合して、コンテナーに送ります。

バックアップ時間に影響を与える状況には次のようなものがあります。


- **既に保護されている VM に新しく追加されたディスクの初回のバックアップ**:VM が増分バックアップ中である場合、新しいディスクを追加すると、バックアップでは、新しいディスクのサイズによっては 1 日の SLA が欠落する可能性があります。
- **フラグメント化されたアプリ**:アプリが不適切に構成されている場合、ストレージに最適でない場合があります。
    - スナップショットに小さい断片化した書き込みが多く含まれる場合、サービスはアプリケーションによって書き込まれたデータの処理に余分な時間を費やします。
    - VM 内部で実行しているアプリケーションについては、アプリケーション書き込みブロックの推奨最小サイズは 8 KB です。 アプリケーションが 8 KB 未満のブロックを使っている場合、バックアップのパフォーマンスに影響があります。
- **オーバー ロードされたストレージ アカウント**:アプリが運用環境で実行されている場合、または 5 ～ 10 以上のディスクが同じストレージ アカウントからホストされている場合、バックアップはスケジュールできます。
- **整合性のチェック (CC) モード**:1TB ディスクよりも大きなディスクの場合、バックアップは次の 2 つの理由であれば CC モードで実行できます。
    - VM 再起動の一環としてマネージド ディスクが移動する。
    - スナップショットをベース BLOB に昇格させる。


## <a name="restore-considerations"></a>復元に関する考慮事項

復元操作は 2 つのメイン タスクで構成されています。選択したストレージ アカウントにコンテナーからデータをコピーすることと仮想マシンを作成することです。 コンテナーからデータをコピーするために必要な時間は、Azure でバックアップが保存されている場所とストレージ アカウントの場所によって決まります。 データのコピーに使用される時間は、次に依存します。

- **キューの待機時間**:サービスは複数のストレージ アカウントからの復元ジョブを同時に処理するため、復元要求はキューに入れられます。
- **データ コピー時間**:データがコンテナーからストレージ アカウントにコピーされます。 復元時間は、Azure Backup サービスが使用する、選択したストレージ アカウントの IOPS とスループットに依存します。 復元処理中のコピー時間を短縮するには、他のアプリケーションの書き込みと読み取りが読み込まれないストレージ アカウントを選びます。

## <a name="best-practices"></a>ベスト プラクティス

VM バックアップを構成するときには、次のプラクティスに従うことをお勧めします。

- 同時に 1 つのコンテナーから 100 を超える VM のバックアップをスケジュールしないでください。
- VM バックアップを非ピーク時にスケジュールします。 こうすれば、バックアップ サービスは IOPS を、ストレージ アカウントからコンテナーへデータを転送するために使用します。
- マネージド ディスクを使用している場合、Azure Backup サービスはストレージ管理を処理します。 非管理対象ディスクをバックアップする場合は、次に従ってください。
    - バックアップ ポリシーを、複数のストレージ アカウントに分散する VM に確実に適用してください。
    - 1 つのストレージ アカウント内で同じバックアップ スケジュールによって保護されるディスクは、20 個以下にしてください。
    - 1 つのストレージ アカウント内に 20 を超えるディスクがある場合は、それらの VM を複数のポリシーに分散させることで、必要な IOPS をバックアップ プロセスの転送フェーズ中に実現できます。
    - プレミアム ストレージで実行されている VM を同じストレージ アカウントに復元しないでください。 復元操作のプロセスがバックアップ操作と重なった場合は、バックアップ用の IOPS が減ります。
    - VM バックアップ スタック V1 の Premium VM バックアップには、Backup がスナップショットをストレージ アカウントにコピーし、ストレージ アカウントからコンテナーにデータを転送できるように、ストレージ アカウントの合計領域の 50% のみを割り当ててください。
- 1 つのコンテナーから VM を復旧するために、同じストレージ アカウントを使用するのではなく、異なるストレージ アカウントを使用することをお勧めします。 これにより、スロットルが回避され、良好なパフォーマンスで 100% 復元に成功します。
- 第 1 層ストレージ レイヤーからの復元は、数時間かかる第 2 層ストレージの復元と比べて数分で完了します。 復元のパフォーマンスを高めるには、[インスタント RP 機能](backup-upgrade-to-vm-backup-stack-v2.md)を使用することをお勧めします。 これは管理対象 Azure VM のみが対象となります。


## <a name="backup-costs"></a>バックアップのコスト

Azure Backup を使用してバックアップされている Azure VM は、[Azure Backup の価格](https://azure.microsoft.com/pricing/details/backup/)の対象になります。

- 課金は、最初のバックアップが正常に完了するまでは開始されません。 この時点では、ストレージと保護するインスタンスの両方に対する課金が開始されます。
- 仮想マシンのコンテナー内に格納されたバックアップ データが存在する限り、課金は継続されます。 仮想マシンの保護を停止しても、仮想マシンのバックアップ データがコンテナーに存在していると、課金は継続します。
- 指定された VM に対する課金は、保護が停止され、かつすべてのバックアップ データが削除されている場合にのみ停止します。
- 保護が停止してアクティブなバックアップ ジョブがないとき、最後に成功した VM バックアップのサイズは、毎月の課金に使用する保護インスタンスのサイズになります。
- 保護されたインスタンスの計算は、仮想マシンの*実際の*サイズ (一時ストレージを除く、仮想マシン内のすべてのデータの合計) に基づきます。
- 価格は、データ ディスクに格納された実際のデータに基づきます。
- VM をバックアップするための価格は、仮想マシンに接続されたデータ ディスクごとのサポートされる最大サイズには基づきません。
- 同様に、バックアップ ストレージの課金は、Azure Backup に格納されているデータ量 (各回復ポイントの実際のデータの合計) に基づきます。

たとえば、最大サイズが各 4 TB のデータ ディスクが 2 台追加で搭載されている A2 標準サイズの仮想マシンがあります。 次の表は、これらの各ディスクに格納されている実際のデータです。

| ディスクの種類 | 最大サイズ | 実際のデータ量 |
| --------- | -------- | ----------- |
| オペレーティング システム ディスク |4095 GB |17 GB |
| ローカル ディスク/一時ディスク |135 GB |5 GB (バックアップに含まれない) |
| データ ディスク 1 |4095 GB |30 GB |
| データ ディスク 2 |4095 GB |0 GB |

- この場合の VM 仮想マシンの実際のサイズは、17 GB + 30 GB + 0 GB = 47 GB です。
- この保護するインスタンスのサイズ (47 GB) が、毎月の課金の基礎になります。
- 仮想マシンのデータ量が大きくなると、課金に使用される保護インスタンスのサイズもそれに応じて変化します。


## <a name="next-steps"></a>次の手順

バックアップ プロセスとパフォーマンスに関する考慮事項を確認した後、以下を実施してください。

- ディスクおよびバックアップ スケジュールの数を試すには、[容量計画に関する Excel スプレッドシート](https://gallery.technet.microsoft.com/Azure-Backup-Storage-a46d7e33) をダウンロードする。
- Azure ストレージの最適化パフォーマンスのためのアプリの調整についての[詳細を確認](../virtual-machines/windows/premium-storage-performance.md)する。 この記事ではプレミアム ストレージが使われていますが、標準ストレージのディスクにも当てはまります。
- VM のサポートと制限、コンテナーの作成、および VM のバックアップの準備を確認することで、バックアップを[開始](backup-azure-arm-vms-prepare.md)する。
