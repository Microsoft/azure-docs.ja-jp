---
title: "Azure RemoteApp のカスタム テンプレート イメージの作成方法 | Microsoft Docs"
description: "Azure RemoteApp のカスタム テンプレート イメージの作成方法について説明します。 このテンプレートは、ハイブリッド コレクションまたはクラウド コレクションで使用できます。"
services: remoteapp
documentationcenter: 
author: msmbaldwin
manager: mbaldwin
editor: 
ms.assetid: b9ec5b51-f7cd-470b-8545-d0fd714c5982
ms.service: remoteapp
ms.workload: compute
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 11/23/2016
ms.author: mbaldwin
translationtype: Human Translation
ms.sourcegitcommit: dcda8b30adde930ab373a087d6955b900365c4cc
ms.openlocfilehash: e28f4004e3cafcfa09309ff0143c83af5fa5493a


---
# <a name="how-to-create-a-custom-template-image-for-azure-remoteapp"></a>Azure RemoteApp のカスタム テンプレート イメージの作成方法
> [!IMPORTANT]
> Azure RemoteApp の提供は終了しました。 詳細については、 [お知らせ](https://go.microsoft.com/fwlink/?linkid=821148) をご覧ください。
> 
> 

Azure RemoteApp では、ユーザーと共有するすべてのプログラムをホスティングするために Windows Server 2012 R2 のテンプレート イメージを使用します。 カスタム RemoteApp テンプレート イメージを作成するには、既存のイメージを使うことも新しく作成することもできます。 

> [!TIP]
> Azure VM からイメージを作成できることをご存知でしたか。 これは本当の話で、イメージをインポートする時間を削減できます。 手順は、 [こちら](remoteapp-image-on-azurevm.md)で確認してください。
> 
> 

Azure RemoteApp で使用するためにアップロードできるイメージの要件は次のとおりです。

* イメージのサイズは MB の倍数にする必要があります。 正確な倍数ではないイメージをアップロードしようとすると、アップロードは失敗します。
* イメージのサイズは 127 GB 未満でなければなりません。
* VHD ファイルにある必要があります。VHDX ファイル (Hyper-V 仮想ハード ドライブ) は現在サポートされていません。
* VHD は、第 2 世代仮想マシンであってはなりません。
* VHD は固定サイズにすることも、動的に拡大する容量可変にすることも可能です。 固定サイズの VHD より Azure へのアップロードの所要時間が短いことから、容量可変の VHD が推奨されます。
* ディスクはマスター ブート レコード (MBR) パーティション分割のスタイルを使用して初期化しなければなりません。 GUID パーティション テーブル (GPT) パーティション分割のスタイルはサポートされていません。
* VHD には Windows Server 2012 R2 の単一インストールが含まれていなければなりません。 複数のボリュームを含むことはできますが、Windows がインストールされるのは 1 ボリュームのみです。
* リモート デスクトップ セッション ホスト (RDSH) ロールとデスクトップ エクスペリエンスの機能がインストール済みでなければなりません。
* リモート デスクトップ接続ブローカーのロールをインストール *しないで* ください。
* 暗号化ファイル システム (EFS) は無効にする必要があります。
* イメージはパラメーター **/oobe /generalize /shutdown** を使用して SYSPREP を実施済みでなければなりません (**/mode:vm** パラメーターは使用しないでください)。
* スナップショット チェーンからの VHD のアップロードはサポートされていません。

**開始する前に**

サービスを作成する前に、以下の操作が必要です。

* [サインアップ](https://azure.microsoft.com/services/remoteapp/) します。
* RemoteApp サービス アカウントとして使用するためのユーザー アカウントを Active Directory に作成します。 ドメインへのマシンの参加のみが実行可能になるように、このアカウントのアクセス許可を制限します。 詳細については、「 [Configure Azure Active Directory for RemoteApp](remoteapp-ad.md) 」を参照してください。
* オンプレミスのネットワークに関する情報、つまり IP アドレス情報と VPN デバイスの詳細情報を収集します。
* [Azure PowerShell](/powershell/azureps-cmdlets-docs) モジュールをインストールします。
* アクセス権を付与するユーザーに関する情報を集めます。 この情報とは、ユーザーの Microsoft アカウントの情報または Active Directory の仕事用アカウントの情報です。

## <a name="create-a-template-image"></a>テンプレート イメージの作成
新しいテンプレート イメージを一から作成する手順の概要を次に示します。

1. Windows Server 2012 R2 Update DVD または ISO イメージを見つけます。
2. VHD ファイルを作成します。
3. Windows Server 2012 R2 をインストールします。
4. リモート デスクトップ セッション ホスト (RDSH) ロールとデスクトップ エクスペリエンスの機能をインストールします。
5. 使用するアプリケーションで必要な追加の機能をインストールします。
6. アプリケーションをインストールし、構成します。 アプリを簡単に共有するには、イメージの **[スタート]** メニューに共有するアプリまたはプログラムを追加します。具体的には、%systemdrive%\ProgramData\Microsoft\Windows\Start Menu\Programs になります。
7. 使用するアプリケーションで必要な追加の Windows 構成を実行します。
8. 暗号化ファイル システム (EFS) を無効にします。
9. **必須:** Windows Update に移動し、すべての重要な更新プログラムをインストールします。
10. イメージを SYSPREP します。

新しいイメージを作成するための詳しい手順は次のとおりです。

1. Windows Server 2012 R2 Update DVD または ISO イメージを見つけます。
2. ディスクの管理を使用して VHD ファイルを作成します。
   
   1. ディスクの管理 (diskmgmt.msc) を起動します。
   2. 40 GB 以上のサイズに動的に拡大する VHD を作成します (Windows、使用するアプリケーション、カスタマイズで必要とされる容量を見積もってください。 RDSH ロールとデスクトップ エクスペリエンスの機能がインストールされた Windows Server では約 10 GB の容量が必要になります)。
      
      1. **[アクション] > [VHD の作成]** をクリックします。
      2. 場所、サイズ、VHD 形式を指定します。 **[容量可変]** を選択後、**[OK]** をクリックします。
      
      実行には数秒かかります。 VHD の作成完了時、ディスクの管理用コンソールにドライブ文字のない新しいディスクと、[初期化されていません] の状態が表示されます。
      
      * (未割り当て領域ではなく) ディスクを右クリックし、次に **[ディスクの初期化]**をクリックします。 パーティション分割のスタイルとして **[MBR]** (マスター ブート レコード) を選択し、次に **[OK]** をクリックします。
      * 新しいボリュームの作成: 未割り当て領域を右クリックし、次に **[新しいシンプル ボリューム]**をクリックします。 ウィザードの既定をそのまま使用できますが、テンプレート イメージのアップロード時に問題が発生する可能性を避けるためにドライブ文字を必ず割り当てるようにしてください。
      * ディスクを右クリックして、 **[VHD の切断]**をクリックします。
3. Windows Server 2012 R2 をインストールします。
   
   1. 新しい仮想マシンを作成します。 Hyper-V マネージャーまたはクライアント Hyper-V で仮想マシンの新規作成ウィザードを使用します。
      1. [世代の指定] ページで、**[第 1 世代]** を選択します。
      2. [仮想ハード ディスクの接続] ページで **[既存の仮想ハード ディスクを使用する]**を選択し、前の手順で作成した VHD を参照します。
      3. [インストール オプション] ページで **[ブート CD/DVD_ROM からオペレーティング システムをインストールする]** を選択し、次に Windows Server 2012 R2 のインストール メディアの格納場所を選択します。
      4. Windows とアプリケーションのインストールに必要な他のオプションをウィザードで選択します。 ウィザードを終了します。
   2. ウィザード終了後、仮想マシンの設定を編集し、仮想プロセッサの数などの Windows やプログラムのインストールに必要な他の変更を実行してから、 **[OK]**をクリックします。
   3. 仮想マシンに接続し、Windows Server 2012 R2 をインストールします。
4. リモート デスクトップ セッション ホスト (RDSH) ロールとデスクトップ エクスペリエンスの機能を次の手順でインストールします。
   1. サーバー マネージャーを起動します。
   2. [ようこそ] 画面上または **[管理]** メニューの **[役割と機能の追加]** をクリックします。
   3. [開始する前に] ページで **[次へ]** をクリックします。
   4. **[役割ベースまたは機能ベースのインストール]** を選択し、**[次へ]** をクリックします。
   5. 一覧からローカル コンピューターを選択し、 **[次へ]**をクリックします。
   6. **[リモート デスクトップ サービス]** を選択し、**[次へ]** をクリックします。
   7. **[ユーザー インターフェイスとインフラストラクチャ]** を展開し、**[デスクトップ エクスペリエンス]** を選択します。
   8. **[機能の追加]** をクリックしてから **[次へ]** をクリックします。
   9. [リモート デスクトップ サービス] ページで **[次へ]**をクリックします。
   10. **[リモート デスクトップ セッション ホスト]**をクリックします。
   11. **[機能の追加]** をクリックしてから **[次へ]** をクリックします。
   12. [インストール オプションの確認] ページで、**[必要に応じて対象サーバーを自動的に再起動する]** を選択し、再起動警告が表示されたら **[はい]** をクリックします。
   13. **[インストール]**をクリックします。 コンピューターが再起動します。
5. .NET Framework 3.5 など、アプリケーションで必要な追加の機能をインストールします。 機能をインストールするには、役割と機能の追加ウィザードを実行してください。
6. RemoteApp を使用して発行するプログラムとアプリケーションをインストールして構成します。

> [!IMPORTANT]
> RemoteApp にイメージがアップロードされる前に、アプリケーションの互換性の問題が検出されるように、アプリケーションのインストール前に RDSH ロールをインストールします。
> 
> アプリケーションのショートカット (**.lnk** ファイル) はすべてのユーザーの **[スタート]** メニューに表示されます (%systemdrive%\ProgramData\Microsoft\Windows\Start Menu\Programs)。 また、**[スタート]** メニューに表示されるアイコンが、ユーザーに表示されるアイコンと一致していることを確認します。 異なる場合は、変更します。 ([スタート] メニューにアプリケーションを追加する必要は "*ありません*" が、追加すると RemoteApp にアプリケーションを発行するのが大幅に簡単になります。 そうしないと、アプリケーションを発行するときに、アプリケーションのインストール パスを提供することが必要になります。)
> 
> 

1. 使用するアプリケーションで必要な追加の Windows 構成を実行します。
2. 暗号化ファイル システム (EFS) を無効にします。 管理者特権のコマンド ウィンドウで、次のコマンドを実行してください。
   
     Fsutil behavior set disableencryption 1
   
   別の方法としては、次の DWORD 値をレジストリに設定または追加できます。
   
     HKLM\System\CurrentControlSet\Control\FileSystem\NtfsDisableEncryption = 1
3. Azure 仮想マシン内にイメージを作成している場合は、後で使用するアップロード スクリプトの動作をブロックする **\%windir%\Panther\Unattend.xml** ファイルの名前を変更します。 このファイルの名前を Unattend.old に変更して、デプロイを元に戻す必要が生じた場合に備えてファイルを温存しておいてください。
4. Windows Update に移動し、すべての重要な更新プログラムをインストールします。 すべての更新プログラムを適用するには、Windows Update を複数回実行することが必要になる場合があります (更新プログラムをインストールするときに、更新内容自体に更新が必要ということもあります)。
5. イメージを SYSPREP します。 管理者特権のコマンド プロンプトで、次のコマンドを実行します。
   
   **C:\Windows\System32\sysprep\sysprep.exe /generalize /oobe /shutdown**
   
   **注:** 仮想マシンであっても SYSPREP コマンドで **/mode:vm** スイッチは使用しないでください。

## <a name="next-steps"></a>次のステップ
これでカスタム テンプレート イメージを作成し終えたので、次にこのイメージを RemoteApp コレクションにアップロードする必要があります。 以下の記事の情報を利用して、コレクションを作成してください。

* [RemoteApp のハイブリッド コレクションの作成方法](remoteapp-create-hybrid-deployment.md)
* [RemoteApp のクラウド コレクションの作成方法](remoteapp-create-cloud-deployment.md)




<!--HONumber=Dec16_HO2-->


