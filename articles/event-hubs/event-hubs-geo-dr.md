---
title: geo ディザスター リカバリー - Azure Event Hubs| Microsoft Docs
description: Azure Event Hubs で地理的リージョンを使用してフェールオーバーとディザスター リカバリーを実行する方法
ms.topic: article
ms.date: 06/23/2020
ms.openlocfilehash: 1807c22645c3246f4cf18d723fc19da475e4d4f4
ms.sourcegitcommit: 62e1884457b64fd798da8ada59dbf623ef27fe97
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/26/2020
ms.locfileid: "88934074"
---
# <a name="azure-event-hubs---geo-disaster-recovery"></a>Azure Event Hubs - geo ディザスター リカバリー 
Azure リージョン全体またはデータ センター全体 ([可用性ゾーン](../availability-zones/az-overview.md)が使用されていない場合) にダウンタイムが発生した場合、別のリージョンまたはデータ センターでデータ処理が続行されることが重要です。 そのため、*geo ディザスター リカバリー*と *geo レプリケーション*は、どの企業にとっても重要な機能です。 Azure Event Hubs では、geo ディザスター リカバリーと geo レプリケーションの両方が名前空間レベルでサポートされています。 

> [!NOTE]
> geo ディザスター リカバリー機能は、[Standard SKU と専用 SKU](https://azure.microsoft.com/pricing/details/event-hubs/) にのみ使用できます。  

## <a name="outages-and-disasters"></a>故障と災害

"故障" と "災害" の違いに注意してください。 "**故障**" とは、Azure Event Hubs が一時的に使用不可能になっていることです。メッセージング ストアなどサービスの一部のコンポーネントや、場合によってはデータセンター全体に影響を与えることがあります。 しかし、問題が解決されると、Event Hubs は再び使用可能になります。 通常、故障によってメッセージなどのデータが失われることはありません。 故障の例として、データセンターでの電源障害があります。 一時的な問題やネットワークの問題によって、接続が短時間失われるだけの故障もあります。 

"*災害*" は、Event Hubs クラスター、Azure リージョン、またはデータ センターの永久または長期間損失として定義されています。 リージョンまたはデータセンターは、再び利用可能になる場合も、ならない場合もあります。また、数時間や数日間の停止になる場合もあります。 このような災害の例としては、火災、洪水、地震があります。 永続的な災害により、メッセージやイベントなどのデータが失われる可能性があります。 ただし、ほとんどの場合、データ センターがバックアップされていればデータが失われることはなく、メッセージを復元できます。

Azure Event Hubs の geo ディザスター リカバリー機能はディザスター リカバリー ソリューションです。 この記事で説明する概念とワークフローは、一時的な故障ではなく、災害のシナリオに適用されます。 Microsoft Azure でのディザスター リカバリーの詳細については、[こちらの記事](/azure/architecture/resiliency/disaster-recovery-azure-applications)をご覧ください。

## <a name="basic-concepts-and-terms"></a>基本的な概念と用語

ディザスター リカバリー機能は、メタデータの災害復旧を実装しており、一次および二次障害復旧の名前空間に依存しています。 

geo ディザスター リカバリー機能は、[Standard SKU と専用 SKU](https://azure.microsoft.com/pricing/details/event-hubs/) にのみ使用できます。 別名を使用して接続を確立するので、接続文字列に変更を加える必要はありません。

この記事では、次の用語を使用します。

-  *エイリアス*: 設定したディザスター リカバリー構成の名前です。 エイリアスは、1 つの不変の完全修飾ドメイン名 (FQDN) の接続文字列を示します。 アプリケーションでは、このエイリアスの接続文字列を使用して名前空間に接続します。 

-  *プライマリ/セカンダリ名前空間*: エイリアスに対応する名前空間です。 プライマリ名前空間が "アクティブ" となり、メッセージを受け取ります (既存の名前空間の場合もあれば、新しい名前空間の場合もあります)。 セカンダリ名前空間は "パッシブ" で、メッセージを受け取りません。 両者間のメタデータは同期しているため、どちらでもアプリケーション コードや接続文字列を変更せずにメッセージをシームレスに受信できます。 確実にアクティブな名前空間にだけメッセージを送信するためには、エイリアスを使用する必要があります。 

-  *Metadata*:名前空間に関連付けられているサービスのエンティティ (イベント ハブ、コンシューマー グループなど) とそのプロパティです。 自動的にレプリケートされるのはエンティティとその設定だけです。 メッセージやイベントはレプリケートされません。 

-  *フェールオーバー*:セカンダリの名前空間をアクティブ化するプロセスです。

## <a name="supported-namespace-pairs"></a>サポートされている名前空間のペア
プライマリ名前空間とセカンダリ名前空間の次の組み合わせがサポートされています。  

| プライマリ名前空間 | セカンダリ名前空間 | サポートされています | 
| ----------------- | -------------------- | ---------- |
| Standard | Standard | はい | 
| Standard | 専用 | はい | 
| 専用 | 専用 | はい | 
| 専用 | Standard | いいえ | 

> [!NOTE]
> 同じ専用クラスター内にある名前空間を組み合わせることはできません。 別々のクラスター内にある名前空間を組み合わせることができます。 

## <a name="setup-and-failover-flow"></a>セットアップとフェールオーバーの流れ

次のセクションでは、フェールオーバー プロセスの概要を示したうえで、最初のフェールオーバーを設定する方法について説明します。 

![1][]

### <a name="setup"></a>セットアップ

まず (新規作成または既存の) プライマリ名前空間と新しいセカンダリ名前空間をペアリングします。 このペアリングによって、接続に使用できる別名が決定されます。 別名を使用するので、接続文字列を変更する必要はありません。 フェールオーバーのペアリングに追加できるのは、新しい名前空間だけです。 最後に、フェールオーバーが必要であるかどうかを検出する監視機構を追加する必要があります。 ほとんどの場合、このサービスは大きなエコシステムの一部分であるため、自動フェールオーバーが実行できることはまれです。フェールオーバーは、他のサブシステムやインフラストラクチャと同期して実行しなければならないケースが多いためです。

### <a name="example"></a>例

このシナリオの一例として、メッセージまたはイベントを出力する販売時点管理 (POS) ソリューションを考えてみましょう。 Event Hubs は、何らかのマッピング (または再フォーマット) ソリューションにそれらのイベントを渡します。マッピングされたデータは、後続の処理のために、そこから別のシステムに転送されます。 このとき、これらすべてのシステムが、同じ Azure リージョン内でホストされている可能性があります。 いつ、どの部分をフェールオーバーするかの判断は、実際のインフラストラクチャにおけるデータのフローによって異なります。 

フェールオーバーは、監視システムを使用して自動化できるほか、独自に構築した監視ソリューションを使用して自動化することもできます。 ただしそのような自動化は、特別な計画と作業が伴い、この記事で取り上げる範囲を超えています。

### <a name="failover-flow"></a>フェールオーバーの流れ

フェールオーバーを開始する場合、次の 2 つのステップが必要となります。

1. 別の故障が発生した場合は、もう一度フェールオーバーしたいと考えます。 そのために、別のパッシブな名前空間を設定して、ペアリングを更新します。 

2. 以前のプライマリ名前空間が再び利用可能になったら、以前のプライマリ名前空間からメッセージをプルします。 以後、通常のメッセージングにその名前空間を geo リカバリーのセットアップ外で使用するか、または、以前のプライマリ名前空間を削除します。

> [!NOTE]
> サポートされるのは、フェール フォワードのセマンティクスだけです。 このシナリオでは、フェールオーバー後、新しい名前空間との間で再度ペアリングを行います。 フェールバックはサポートされません (SQL クラスターでのフェールバックなど)。 

![2][]

## <a name="management"></a>管理

間違ったリージョンをペアリングしたなど、初期設定にミスがあった場合、2 つの名前空間のペアリングはいつでも解除することができます。 ペアリングした名前空間を通常の名前空間として使用する必要がある場合、エイリアスは削除してください。

## <a name="samples"></a>サンプル

[GitHub のサンプル](https://github.com/Azure/azure-event-hubs/tree/master/samples/DotNet/Microsoft.Azure.EventHubs/GeoDRClient)には、フェールオーバーの設定と開始の方法が紹介されています。 このサンプルで紹介されている概念は次のとおりです。

- Azure Resource Manager を Event Hubs で使用するために Azure Active Directory に必要な設定。 
- サンプル コードを実行するために必要な手順。 
- 現在のプライマリ名前空間との間で行う送受信。 

## <a name="considerations"></a>考慮事項

このリリースでは次の考慮事項にご注意ください。

1. 設計上、Event Hubs の geo ディザスター リカバリーではデータがレプリケートされないため、セカンダリ イベント ハブでプライマリ イベント ハブの古いオフセット値を再利用することはできません。 次のいずれかの方法を使用して、イベント レシーバーを再起動することをお勧めします。

- *EventPosition.FromStart()* - セカンダリ イベント ハブのすべてのデータを読み取る場合。
- *EventPosition.FromEnd()* - セカンダリ イベント ハブに接続してからのすべての新しいデータを読み取る場合。
- *EventPosition.FromEnqueuedTime(dateTime)* - 指定した日付と時刻以降にセカンダリ イベント ハブで受信したすべてのデータを読み取る場合。

2. フェールオーバー計画では、時間的要因も考慮する必要があります。 たとえば、接続の喪失時間が 15 ～ 20 分を超えた場合にフェールオーバー開始の判断を下すことが考えられます。 
 
3. レプリケートされるデータが存在しないということは、現在アクティブなセッションがレプリケートされないことを意味します。 また、重複の検出やスケジュールされたメッセージが正しく機能しない可能性があります。 新しいセッションやスケジュールされたメッセージ、新しい重複については正しく機能します。 

4. 複雑な分散インフラストラクチャのフェールオーバーは、少なくとも 1 回は[リハーサル](/azure/architecture/reliability/disaster-recovery#disaster-recovery-plan)を行うようお勧めします。 

5. エンティティの同期には、ある程度時間がかかる場合があります (1 分あたり約 50 ～ 100 エンティティ)。

## <a name="availability-zones"></a>可用性ゾーン 

Event Hubs Standard SKU では、Azure リージョン内に障害から分離された場所を提供する [Availability Zones](../availability-zones/az-overview.md) がサポートされています。 

> [!NOTE]
> Azure Event Hubs Standard に対する Availability Zones のサポートは、可用性ゾーンが存在する [Azure リージョン](../availability-zones/az-region.md)内でのみ利用できます。

Azure Portal を使用して、新しい名前空間でのみ Availability Zones を有効にすることができます。 Event Hubs では、既存の名前空間の移行はサポートされていません。 名前空間でゾーン冗長を有効にした後、それを無効にすることはできません。

![3][]

## <a name="private-endpoints"></a>プライベート エンドポイント
このセクションでは、プライベート エンドポイントを使用する名前空間で geo ディザスター リカバリーを使用する場合の追加の考慮事項について説明します。 一般に Event Hubs でプライベート エンドポイントを使用する方法については、[プライベート エンドポイントの構成](private-link-service.md)に関するページを参照してください。

### <a name="new-pairings"></a>新しいペアリング
プライベート エンドポイントがあるプライマリ名前空間と、プライベート エンドポイントがないセカンダリ名前空間とのペアリングを作成しようとすると、ペアリングは失敗します。 ペアリングは、プライマリとセカンダリの両方の名前空間にプライベート エンドポイントがある場合にのみ成功します。 プライマリおよびセカンダリ名前空間と、プライベート エンドポイントが作成される仮想ネットワークで同じ構成を使用することをお勧めします。  

> [!NOTE]
> プライベート エンドポイントがあるプライマリ名前空間と任意のセカンダリ名前空間を組み合わせようとすると、検証プロセスで、セカンダリ名前空間にプライベート エンドポイントが存在するかどうかのみが確認されます。 エンドポイントが機能するかどうか、またはフェールオーバー後に機能するかどうかは確認されません。 プライベート エンドポイントがあるセカンダリ名前空間が、フェールオーバー後に予期したとおりに確実に機能することをご自身で確認する必要があります。
>
> プライマリ名前空間とセカンダリ名前空間のプライベート エンドポイント構成が同じであることをテストするには、読み取り要求 (例: [イベント ハブの取得](/rest/api/eventhub/get-event-hub)) を仮想ネットワークの外側からセカンダリ名前空間に送信し、サービスからエラー メッセージが返されることを確認します。

### <a name="existing-pairings"></a>既存のペアリング
プライマリ名前空間とセカンダリ名前空間のペアリングが既に存在する場合、プライマリ名前空間でのプライベート エンドポイントの作成は失敗します。 解決するには、まずセカンダリ名前空間にプライベート エンドポイントを作成し、次にプライマリ名前空間用に作成します。

> [!NOTE]
> セカンダリ名前空間に対して許可されるのは読み取り専用アクセスですが、プライベート エンドポイント構成の更新は許可されます。 

### <a name="recommended-configuration"></a>推奨構成
アプリケーションと Event Hubs 名前空間のディザスター リカバリー構成を作成する場合は、アプリケーションのプライマリ インスタンスとセカンダリ インスタンスの両方をホストする仮想ネットワークに対して、プライマリとセカンダリの両方の Event Hubs 名前空間にプライベート エンドポイントを作成する必要があります。 

たとえば、2 つの仮想ネットワークがあるとします。VNET-1、VNET-2 です。また、プライマリ名前空間とセカンダリ名前空間として、EventHubs-Namespace1-Primary、EventHubs-Namespace2-Secondary があるとします。 次の手順を行う必要があります。 

- EventHubs-Namespace1-Primary で、VNET-1 および VNET-2 のサブネットを使用する 2 つのプライベート エンドポイントを作成します。
- EventHubs-Namespace2-Secondary で、VNET-1 と VNET-2 の同じサブネットを使用する 2 つのプライベート エンドポイントを作成します。 

![プライベート エンドポイントと仮想ネットワーク](./media/event-hubs-geo-dr/private-endpoints-virtual-networks.png)

このアプローチの利点は、Event Hubs 名前空間から独立したアプリケーション レイヤーでフェールオーバーが発生するようにできることです。 以下のようなシナリオが考えられます。 

**アプリケーションのみのフェールオーバー:** ここでは、アプリケーションは VNET-1 には存在しませんが、VNET 2 に移行します。 両方のプライベート エンドポイントが、プライマリとセカンダリの両方の名前空間に対して VNET-1 と VNET 2 の両方で構成されているため、アプリケーションは動作します。 

**Event Hubs 名前空間のみのフェールオーバー**: ここでも、プライマリとセカンダリの両方の名前空間に対して、両方の仮想ネットワークで両方のプライベート エンドポイントが構成されているため、アプリケーションは動作します。 

> [!NOTE]
> 仮想ネットワークの geo ディザスター リカバリーに関するガイダンスについては、「[Virtual Network - ビジネス継続性](../virtual-network/virtual-network-disaster-recovery-guidance.md)」を参照してください。
 
## <a name="next-steps"></a>次のステップ

* [GitHub のサンプル](https://github.com/Azure/azure-event-hubs/tree/master/samples/DotNet/Microsoft.Azure.EventHubs/GeoDRClient)で、geo ペアリングを作成してディザスター リカバリー シナリオのフェールオーバーを開始する簡単なワークフローの手順について説明します。
* [REST API リファレンス](/rest/api/eventhub/)で、geo ディザスター リカバリーの構成を実行するための API について説明します。

Event Hubs の詳細については、次のリンクを参照してください。

- Event Hubs の使用
    - [.NET Core](event-hubs-dotnet-standard-getstarted-send.md)
    - [Java](event-hubs-java-get-started-send.md)
    - [Python](event-hubs-python-get-started-send.md)
    - [JavaScript](event-hubs-java-get-started-send.md)
* [Event Hubs の FAQ](event-hubs-faq.md)
* [Event Hubs を使用するサンプル アプリケーション](https://github.com/Azure/azure-event-hubs/tree/master/samples)

[1]: ./media/event-hubs-geo-dr/geo1.png
[2]: ./media/event-hubs-geo-dr/geo2.png
[3]: ./media/event-hubs-geo-dr/eh-az.png
