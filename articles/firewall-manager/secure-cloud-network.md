---
title: チュートリアル:Azure Firewall Manager を使用して仮想ハブのセキュリティを保護する
description: このチュートリアルでは、Azure portal を使用して Azure Firewall Manager で仮想ハブのセキュリティを保護する方法について説明します。
services: firewall-manager
author: vhorne
ms.service: firewall-manager
ms.topic: tutorial
ms.date: 08/28/2020
ms.author: victorh
ms.openlocfilehash: 9da1340d08d4eaab3ba208c667861093ef0f799b
ms.sourcegitcommit: 656c0c38cf550327a9ee10cc936029378bc7b5a2
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/28/2020
ms.locfileid: "89079117"
---
# <a name="tutorial-secure-your-virtual-hub-using-azure-firewall-manager"></a>チュートリアル:Azure Firewall Manager を使用して仮想ハブのセキュリティを保護する

Azure Firewall Manager を使用して、セキュリティ保護付き仮想ハブを作成し、プライベート IP アドレス、Azure PaaS、インターネットに宛てたクラウド ネットワーク トラフィックをセキュリティで保護することができます。 ファイアウォールへのトラフィックのルーティングは自動化されているため、ユーザー定義ルート (UDR) を作成する必要はありません。

![クラウド ネットワークをセキュリティで保護する](media/secure-cloud-network/secure-cloud-network.png)

Firewall Manager では、ハブ仮想ネットワーク アーキテクチャもサポートされます。 セキュリティ保護付き仮想ハブとハブ仮想ネットワーク アーキテクチャの種類の比較については、「[Azure Firewall Manager のアーキテクチャ オプション](vhubs-and-vnets.md)」を参照してください。

このチュートリアルでは、以下の内容を学習します。

> [!div class="checklist"]
> * スポーク仮想ネットワークを作成する
> * セキュリティ保護付き仮想ハブを作成する
> * ハブとスポークの仮想ネットワークを接続する
> * ハブにトラフィックをルーティングする
> * サーバーをデプロイする
> * ファイアウォール ポリシーを作成してハブをセキュリティで保護する
> * ファイアウォールをテストする

## <a name="prerequisites"></a>前提条件

Azure サブスクリプションをお持ちでない場合は、開始する前に [無料アカウント](https://azure.microsoft.com/free/?WT.mc_id=A261C142F) を作成してください。

## <a name="create-a-hub-and-spoke-architecture"></a>ハブとスポークのアーキテクチャを作成する

まず、サーバーを配置できるスポーク仮想ネットワークを作成します。

### <a name="create-two-spoke-virtual-networks-and-subnets"></a>2 つのスポーク仮想ネットワークとサブネットを作成する

2 つの仮想ネットワークにはそれぞれワークロード サーバーがあり、ファイアウォールによって保護されます。

1. Azure portal のホーム ページから **[リソースの作成]** を選択します。
2. **[ネットワーク]** で、 **[仮想ネットワーク]** を選択します。
2. **[サブスクリプション]** で、ご使用のサブスクリプションを選択します。
1. **[リソース グループ]** で、 **[新規作成]** を選択し、名前として「**fw-manager**」と入力して **[OK]** を選びます。
2. **[名前]** に、「**Spoke-01**」と入力します。
3. **[リージョン]** で **[(米国) 米国東部]** を選択します。
4. **次へ:[次へ: IP アドレス]** を選択します。
1. **[アドレス空間]** に「**10.1.0.0/16**」と入力します。
3. **[サブネットの追加]** を選択します。
4. 「**Workload-01-SN**」と入力します。
5. **[サブネット アドレス範囲]** に「**10.1.1.0/24**」と入力します。
6. **[追加]** を選択します。
1. **[確認および作成]** を選択します。
2. **[作成]** を選択します。

この手順を繰り返して、別の同様の仮想ネットワークを作成します。

名前:**Spoke-02**<br>
アドレス空間:**10.2.0.0/16**<br>
サブネット名:**Workload-02-SN**<br>
サブネットのアドレス範囲: **10.2.1.0/24**

### <a name="create-the-secured-virtual-hub"></a>セキュリティ保護付き仮想ハブを作成する

Firewall Manager を使用して、セキュリティ保護付き仮想ハブを作成します。

1. Azure portal のホーム ページで、 **[すべてのサービス]** を選択します。
2. 検索ボックスに「**Firewall Manager**」と入力し、 **[Firewall Manager]** を選択します。
3. **[Firewall Manager]** ページで、 **[セキュリティ保護付き仮想ハブの表示]** を選択します。
4. **[Firewall Manager] | [セキュリティで保護された仮想ハブ]** ページで、 **[セキュリティで保護された仮想ハブの新規作成]** を選択します。
5. **[リソース グループ]** で、 **[fw-manager]** を選択します。
7. **[リージョン]** で、 **[米国東部]** を選択します。
1. **[セキュリティで保護された仮想ハブ名]** には、「**Hub 01**」と入力します。
2. **[ハブ アドレス空間]** に、「**10.0.0.0/16**」と入力します。
3. 新しい vWAN 名として、「**Vwan-01**」と入力します。
4. **[信頼されたセキュリティ パートナーを有効にするために VPN ゲートウェイを含める]** チェック ボックスはオフのままにします。
5. **[Next:Azure Firewall]** を選択します。
6. 既定の **Azure Firewall** が**有効**になっている設定をそのまま使用し、 **[次へ: 信頼されたセキュリティ パートナー]** を選択します。
7. 既定の**信頼されたセキュリティ パートナー**が**無効**になっている設定をそのまま使用し、 **[次へ: 確認と作成]** をクリックします。
8. **［作成］** を選択します デプロイには約 30 分かかります。

これで、ファイアウォールのパブリック IP アドレスを取得できるようになりました。

1. デプロイが完了したら、Azure portal で、 **[すべてのサービス]** を選択します。
1. 「**firewall manager**」と入力し、 **[Firewall Manager]** を選択します。
2. **[セキュリティ保護付き仮想ハブ]** を選択します。
3. **[hub-01]** を選択します。
7. **[パブリック IP 構成]** を選択します。
8. 後で使用するパブリック IP アドレスを書き留めます。

### <a name="connect-the-hub-and-spoke-virtual-networks"></a>ハブとスポークの仮想ネットワークを接続する

これで、ハブとスポークの仮想ネットワークをピアリングできるようになりました。

1. **[fw-manager]** リソース グループを選択してから、 **[Vwan-01]** 仮想 WAN を選びます。
2. **[接続]** で、 **[仮想ネットワーク接続]** を選択します。
3. **[接続の追加]** を選択します。
4. **[接続名]** に、「**hub-spoke-01**」と入力します。
5. **[ハブ]** で、 **[Hub-01]** を選択します。
6. **[リソース グループ]** で、 **[fw-manager]** を選択します。
7. **[仮想ネットワーク]** で、 **[Spoke-01]** を選択します。
8. **［作成］** を選択します

手順を繰り返して、 **[Spoke-02]** 仮想ネットワークを接続します: 接続名 - **hub-spoke-02**

### <a name="configure-the-hub-and-spoke-routing"></a>ハブとスポークのルーティングを構成する

Azure portal から Cloud Shell を開き、次の Azure PowerShell を実行して、必要なハブとスポークのルーティングを構成します。 ピアリングされたスポークおよびブランチ接続では、伝達を **NONE** に設定する必要があります。 こうすることで、スポーク間の Any-to-Any 通信を防ぎ、代わりに既定ルートを使用してトラフィックをファイアウォールにルーティングすることができます。

```azurepowershell
$noneRouteTable = Get-AzVHubRouteTable -ResourceGroupName fw-manager `
                  -HubName hub-01 -Name noneRouteTable
$vnetConns = Get-AzVirtualHubVnetConnection -ResourceGroupName fw-manager `
             -ParentResourceName hub-01

$vnetConn = $vnetConns[0]
$vnetConn.RoutingConfiguration.PropagatedRouteTables.Ids = @($noneRouteTable)
$vnetConn.RoutingConfiguration.PropagatedRouteTables.Labels = @("none")
Update-AzVirtualHubVnetConnection -ResourceGroupName fw-manager `
   -ParentResourceName hub-01 -Name $vnetConn.Name `
   -RoutingConfiguration $vnetConn.RoutingConfiguration

$vnetConn = $vnetConns[1]
$vnetConn.RoutingConfiguration.PropagatedRouteTables.Ids = @($noneRouteTable)
$vnetConn.RoutingConfiguration.PropagatedRouteTables.Labels = @("none")
Update-AzVirtualHubVnetConnection -ResourceGroupName fw-manager `
   -ParentResourceName hub-01 -Name $vnetConn.Name -RoutingConfiguration $vnetConn.RoutingConfiguration
```

## <a name="deploy-the-servers"></a>サーバーをデプロイする

1. Azure portal で、 **[リソースの作成]** を選択します。
2. **[人気順]** の一覧で **[Windows Server 2016 Datacenter]** を選択します。
3. 次の仮想マシンの値を入力します。

   |設定  |値  |
   |---------|---------|
   |Resource group     |**fw-manager**|
   |仮想マシン名     |**Srv-workload-01**|
   |リージョン     |**(米国) 米国東部**|
   |管理者のユーザー名     |ユーザー名を入力します。|
   |Password     |パスワードを入力します。|

4. **[受信ポートの規則]** の **[パブリック受信ポート]** で、 **[なし]** を選択します。
6. 他の既定値をそのまま使用し、 **[次へ:ディスク]** を選択します。
7. ディスクの既定値をそのまま使用し、 **[次へ:ネットワーク]** を選択します。
8. 仮想ネットワークで **[Spoke-01]** を選択し、サブネットで **[Workload-01-SN]** を選択します。
9. **[パブリック IP]** で、 **[なし]** を選択します。
11. 他の既定値をそのまま使用し、 **[次へ:管理]** を選択します。
12. **[オフ]** を選択して、ブート診断を無効にします。 他の既定値をそのまま使用し、 **[確認および作成]** を選択します。
13. 概要ページの設定を確認して、 **[作成]** を選択します。

次の表の情報を使用して、**Srv-Workload-02** という名前の別の仮想マシンを構成します。 残りの構成は、**Srv-workload-01** 仮想マシンと同じです。

|設定  |値  |
|---------|---------|
|仮想ネットワーク|**Spoke-02**|
|Subnet|**Workload-02-SN**|

サーバーがデプロイされたら、サーバー リソースを選択し、 **[ネットワーク]** で、各サーバーのプライベート IP アドレスを書き留めます。

## <a name="create-a-firewall-policy-and-secure-your-hub"></a>ファイアウォール ポリシーを作成してハブをセキュリティで保護する

ファイアウォール ポリシーでは、1 つまたは複数のセキュリティで保護された仮想ハブでトラフィックを転送する規則のコレクションを定義します。 ファイアウォール ポリシーを作成してから、ハブをセキュリティで保護します。

1. Firewall Manager から、 **[Azure Firewall ポリシーの表示]** を選択します。
2. **[Azure ファイアウォール ポリシーの作成]** を選択します。
3. **[ポリシーの詳細]** で、 **[名前]** に「**Policy-01**」と入力し、 **[リージョン]** で **[米国東部]** を選択します。
4. **[Next:DNS Settings (preview)]\(次へ: DNS 設定 (プレビュー)\)** を選択します。
1. **[Next:Rules]\(次へ: 規則\)** を選択します。
2. **[規則]** タブで、 **[規則コレクションの追加]** を選択します。
3. **[規則コレクションの追加]** ページで、 **[名前]** に「**App-RC-01**」と入力します。
4. **[規則コレクションの種類]** で、 **[アプリケーション]** を選択します。
5. **[優先度]** に「**100**」と入力します。
6. **[規則コレクション] アクション**が **[許可]** であることを確認します。
7. 規則の **[名前]** に、「**Allow-msft**」と入力します。
8. **[Source type]\(送信元の種類\)** で、 **[IP アドレス]** を選択します。
9. **[送信元]** に「 **\*** 」と入力します。
10. **[プロトコル]** に、「**http,https**」と入力します。
11. **[送信先の種類]** が **[FQDN]** であることを確認します。
12. **[送信先]** に、「 **\*.microsoft.com**」と入力します。
13. **[追加]** を選択します。

DNAT 規則を追加して、リモート デスクトップを **Srv-Workload-01** 仮想マシンに接続できるようにします。

1. **[規則コレクションの追加]** を選択します。
2. **[名前]** に「**DNAT-rdp**」と入力します。
3. **[規則コレクションの種類]** で、 **[DNAT]** を選択します。
4. **[優先度]** に「**100**」と入力します。
5. 規則の **[名前]** に、「**Allow-rdp**」と入力します。
6. **[Source type]\(送信元の種類\)** で、 **[IP アドレス]** を選択します。
7. **[送信元]** に「 **\*** 」と入力します。
8. **[プロトコル]** で **[TCP]** を選択します。
9. **[宛先ポート]** に「**3389**」と入力します。
10. **[送信先の種類]** で **[IP アドレス]** を選択します。
11. **[宛先]** に、前に書き留めたファイアウォールのパブリック IP アドレスを入力します。
12. **[変換されたアドレス]** に、前に書き留めた **Srv-Workload-01** のプライベート IP アドレスを入力します。
13. **[Translated port] (変換されたポート)** に「**3389**」と入力します。
14. **[追加]** を選択します。

ネットワーク規則を追加して、**Srv-Workload-01** から **Srv-Workload-02** にリモート デスクトップを接続できるようにします。

1. **[規則コレクションの追加]** を選択します。
2. **[名前]** に「**vnet-rdp**」と入力します。
3. **[規則コレクションの種類]** で、 **[ネットワーク]** を選択します。
4. **[優先度]** に「**100**」と入力します。
5. 規則の **[名前]** に、「**Allow-vnet**」と入力します。
6. **[Source type]\(送信元の種類\)** で、 **[IP アドレス]** を選択します。
7. **[送信元]** に「 **\*** 」と入力します。
8. **[プロトコル]** で **[TCP]** を選択します。
9. **[宛先ポート]** に「**3389**」と入力します。
9. **[送信先の種類]** で **[IP アドレス]** を選択します。
10. **[宛先]** に、前に書き留めた **Srv-Workload-02** のプライベート IP アドレスを入力します。
11. **[追加]** を選択します。
1. **[Next:脅威インテリジェンス**] を選択します。
2. **次へ:[次へ: ハブ]** を選択します。
3. **[ハブ]** タブで、 **[Associate virtual hubs]\(仮想ハブの関連付け\)** を選択します。
4. **[Hub-01]** を選択し、 **[追加]** を選択します。
5. **[Review + create]\(レビュー + 作成\)** を選択します。
6. **［作成］** を選択します

これには、完了までに約 5 分以上かかることがあります。

## <a name="route-traffic-to-your-hub"></a>ハブにトラフィックをルーティングする

次に、ファイアウォール経由でネットワーク トラフィックがルーティングされることを確認する必要があります。

1. Firewall Manager から、 **[セキュリティで保護された仮想ハブ]** を選択します。
2. **[Hub-01]** を選択します。
3. **[設定]** の **[セキュリティの構成]** を選択します。
4. **[インターネット トラフィック]** の **[Azure Firewall]** を選択します。
5. **[Private traffic]\(プライベート トラフィック\)** の **[Send via Azure Firewall]\(Azure Firewall 経由で送信\)** を選択します。
10. **[hub-spoke]** 接続に **[インターネット トラフィック]** が **[セキュリティ保護]** として表示されていることを確認します。
11. **[保存]** を選択します。


## <a name="test-your-firewall"></a>ファイアウォールをテストする

ファイアウォール規則をテストするには、**Srv-Workload-01** に NAT 変換されたファイアウォールのパブリック IP アドレスを使用してリモート デスクトップを接続します。 そこから、ブラウザーを使用してアプリケーション規則をテストし、リモート デスクトップを **Srv-Workload-02** に接続してネットワーク規則をテストします。

### <a name="test-the-application-rule"></a>アプリケーション規則をテストする

今度は、ファイアウォール規則をテストして、予期したとおりに動作することを確認します。

1. リモート デスクトップをファイアウォールのパブリック IP アドレスに接続し、サインインします。

3. Internet Explorer を開き、 https://www.microsoft.com を参照します。
4. Internet Explorer のセキュリティ アラートで、 **[OK]**  >  **[閉じる]** の順に選択します。

   Microsoft のホーム ページが表示されるはずです。

5. https://www.google.com を参照します。

   ファイアウォールによってブロックされます。

これで、ファイアウォールのアプリケーション規則が機能していることを確認できました。

* 1 つの許可された FQDN は参照できますが、それ以外は参照できません。

### <a name="test-the-network-rule"></a>ネットワーク 規則をテストする

次に、ネットワーク規則をテストします。

- **Srv-Workload-02** のプライベート IP アドレスへのリモート デスクトップを開きます。

   リモート デスクトップは **Srv-Workload-02** に接続されます。

これで、ファイアウォールのネットワーク規則が機能していることを確認できました。
* リモート デスクトップを別の仮想ネットワークにあるサーバーに接続できます。

## <a name="clean-up-resources"></a>リソースをクリーンアップする

ファイアウォール リソースのテストが完了したら、 **fw-manager** リソース グループを削除して、ファイアウォール関連のすべてのリソースを削除します。

## <a name="next-steps"></a>次のステップ

> [!div class="nextstepaction"]
> [信頼されたセキュリティ パートナーについて学習する](trusted-security-partners.md)
