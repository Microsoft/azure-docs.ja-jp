---
title: "Azure VM (クラシック) での AlwaysOn 可用性グループの構成 | Microsoft Docs"
description: "Azure Virtual Machines で AlwaysOn 可用性グループを作成します。 このチュートリアルでは、スクリプトではなく、主にユーザー インターフェイスとツールを使用します。"
services: virtual-machines-windows
documentationcenter: na
author: MikeRayMSFT
manager: jhubbard
editor: 
tags: azure-service-management
ms.assetid: 8d48a3d2-79f8-4ab0-9327-2f30ee0b2ff1
ms.service: virtual-machines-sql
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 03/17/2017
ms.author: mikeray
translationtype: Human Translation
ms.sourcegitcommit: 4f2230ea0cc5b3e258a1a26a39e99433b04ffe18
ms.openlocfilehash: 0d58355bf4d9cef0a84a6a192dbf019ee5238904
ms.lasthandoff: 03/25/2017


---
# <a name="configure-always-on-availability-group-in-azure-vm-classic"></a>Azure VM (クラシック) での AlwaysOn 可用性グループの構成
> [!div class="op_single_selector"]
> * [クラシック: UI](../classic/portal-sql-alwayson-availability-groups.md)
> * [クラシック: PowerShell](../classic/ps-sql-alwayson-availability-groups.md)
<br/>

> [!IMPORTANT] 
> 最新のデプロイでは、リソース マネージャー モデルを使用することをお勧めします。 Azure には、リソースの作成と操作に関して、 [Resource Manager とクラシック](../../../azure-resource-manager/resource-manager-deployment-model.md)の 2 種類のデプロイメント モデルがあります。 この記事では、クラシック デプロイ モデルの使用方法について説明します。 

Azure Resource Manager モデルでこの作業を行う場合は、[Azure 仮想マシン上の SQL Server Always On 可用性グループ](../sql/virtual-machines-windows-portal-sql-availability-group-overview.md)に関する記事をご覧ください。

このエンド ツー エンドのチュートリアルでは、Azure 仮想マシンで実行されている SQL Server AlwaysOn を使用して可用性グループを実装する方法について説明します。

チュートリアルの最後には、次の要素で構成された SQL Server AlwaysOn ソリューションが Azure で完成します。

* 複数のサブネットから成る仮想ネットワーク (フロントエンドのサブネットとバックエンドのサブネットを含む)
* Active Directory (AD) ドメインを持つドメイン コントローラー
* バックエンド サブネットにデプロイされ、AD ドメインに参加している 2 つの SQL Server VM
* 3 ノードのフェールオーバー クラスター (ノード マジョリティ クォーラム モデル)
* 可用性データベースの 2 つの同期コミット レプリカを含む可用性グループ

このソリューションをグラフィカルに表すと、次の図のようになります。

![Azure での AG 向けテスト ラボ アーキテクチャ](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC791912.png)

これは、考えられる 1 つの構成であることに注意してください。 たとえば、Azure でのコンピューティング時間を節約するために、ドメイン コントローラーを 2 つのノードのクラスターでクォーラム ファイル共有監視として使用することで、2 つのレプリカを持つ可用性グループ用の VM 数を最小限に抑えることができます。 この方法では、上記の構成よりも VM 数が 1 つ減少します。

このチュートリアルでは、次のことを前提としています。

* Azure アカウントを既に所有している。
* GUI を使用して、仮想マシン ギャラリーから従来の SQL Server VM をプロビジョニングする方法を知っている。
* AlwaysOn 可用性グループについて十分に理解している。 詳細については、「 [AlwaysOn 可用性グループ (SQL Server)](https://msdn.microsoft.com/library/hh510230.aspx)」をご覧ください。

> [!NOTE]
> SharePoint での AlwaysOn 可用性グループの使用に関心がある場合は、「 [SQL Server 2012 の AlwaysOn 可用性グループを SharePoint 2013 用に構成する](https://technet.microsoft.com/library/jj715261.aspx)」をご覧ください。
> 
> 

## <a name="create-the-virtual-network-and-domain-controller-server"></a>Virtual Network とドメイン コントローラー サーバーの作成
最初に新しい Azure 試用版アカウントを作成します。 アカウントのセットアップが完了したら、Azure クラシック ポータルのホーム画面が表示されます。

1. 次に示すように、ページの左下隅にある **[新規]** をクリックします。
   
    ![ポータルで [新規] をクリックします](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665511.gif)
2. 次に示すように、**[Network Services]**、**[Virtual Network]**、**[カスタム作成]** の順にクリックします。
   
    ![[仮想ネットワークの作成]](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665512.gif)
3. **[仮想ネットワークの作成]** ダイアログ ボックスの各ページで次の設定を使用して、新しい仮想ネットワークを作成します。 
   
   | ページ | 設定 |
   | --- | --- |
   | Virtual Network Details |**NAME = ContosoNET**<br/>**リージョン = 米国西部** |
   | DNS サーバーと VPN 接続 |なし |
   | Virtual Network アドレス空間 |設定は、下のスクリーンショットをご覧ください。 ![[仮想ネットワークの作成]](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784620.png) |
4. 次に、ドメイン コントローラー (DC) として使用する VM を作成します。 次に示すように、もう一度 **[新規]** をクリックし、**[Compute]**、**[仮想マシン]**、**[ギャラリーから]** の順にクリックします。
   
    ![VM を作成します](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784621.png)
5. **[仮想マシンの作成]** ダイアログ ボックスの各ページで次の設定を使用して、新しい VM を構成します。 
   
   | ページ | 設定 |
   | --- | --- |
   | 仮想マシンのオペレーティング システムの選択 |Windows Server 2012 R2 Datacenter |
   | 仮想マシンの構成 |**[バージョンのリリース日]** = (最新)<br/>**[仮想マシン名]** = ContosoDC<br/>**[階層]** = Standard<br/>**[サイズ]** = A2 (2 コア)<br/>**[新しいユーザー名]** = AzureAdmin<br/>**[パスワード]** = Contoso!000<br/>**[確認]** = Contoso!000 |
   | 仮想マシンの構成 |**[クラウド サービス]** = 新しいクラウド サービスの作成<br/>**[クラウド サービス DNS 名]** = 一意のクラウド サービス名<br/>**[DNS 名]** = 一意の名前 (例: ContosoDC123)<br/>**[リージョン/アフィニティ グループ/仮想ネットワーク]** = ContosoNET<br/>**[仮想ネットワーク サブネット]** = Back(10.10.2.0/24)<br/>**[ストレージ アカウント]**: 自動的に生成されたストレージ アカウントを使用<br/>**[可用性セット]** = (なし) |
   | 仮想マシンのオプション |既定値を使用 |

新しい VM の構成が完了したら、VM がプロビジョニングされるまで待ちます。 このプロセスは完了するまで時間がかかります。Azure クラシック ポータルで **[仮想マシン]** タブをクリックすると、ContosoDC の状態が **[開始中 (プロビジョニング中)]** から **[停止済み]**、**[開始中]**、**[実行中 (プロビジョニング中)]**、最後に **[実行中]** へ変化していくことがわかります。

これで、DC サーバーは正常にプロビジョニングされました。 次に、この DC サーバー上の Active Directory ドメインを構成します。

## <a name="configure-the-domain-controller"></a>ドメイン コントローラーの構成
次の手順では、corp.contoso.com のドメイン コントローラーとして ContosoDC コンピューターを構成します。

1. ポータルで、 **ContosoDC** コンピューターを選択します。 **[ダッシュボード]** タブで、**[接続]** をクリックし、リモート デスクトップ アクセス用の RDP ファイルを開きます。
   
    ![仮想マシンに接続](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784622.png)
2. 構成した管理者アカウント (**\AzureAdmin**) とパスワード (**Contoso!000**) でログインします。
3. 既定では、 **[サーバー マネージャー]** ダッシュボードが表示されます。
4. ダッシュボードの **[役割と機能の追加]** リンクをクリックします。
   
    ![サーバー エクスプローラー、ロールの追加](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784623.png)
5. **[サーバーの役割]** セクションが表示されるまで **[次へ]** を選択します。
6. **[Active Directory Domain Services]** と **[DNS サーバー]** という役割を選択します。 メッセージが表示されたら、これらの役割に必要なその他の機能を追加します。
   
   > [!NOTE]
   > 静的 IP アドレスがないことを示す検証の警告が表示されます。 構成をテストしている場合は、[続行] をクリックします。 運用シナリオの場合は、[PowerShell を使用して、ドメイン コントローラー コンピューターの静的 IP アドレスを設定してください](../../../virtual-network/virtual-networks-reserved-private-ip.md)。
   > 
   > 
   
    ![ロールの追加の図表](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784624.png)
7. **[確認]** セクションが表示されるまで **[次へ]** をクリックします。 **[必要に応じて対象サーバーを自動的に再起動する]** チェック ボックスをオンにします。
8. **[インストール]**をクリックします。
9. 機能のインストールが完了したら、 **[サーバー マネージャー]** ダッシュボードに戻ります。
10. 左側のウィンドウで新しい **[AD DS]** オプションを選択します。
11. 黄色の警告バーにある **[その他]** リンクをクリックします。
    
     ![DNS サーバー VM の AD DS の図表](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784625.png)
12. **[すべてのサーバー タスクの詳細]** ダイアログ ボックスの **[操作]** 列で、**[このサーバーをドメイン コントローラーに昇格する]** をクリックします。
13. **Active Directory ドメイン サービスの構成ウィザード**で、次の値を使用します。
    
    | ページ | 設定 |
    | --- | --- |
    | デプロイ構成 |**[新しいフォレストの追加]** = 選択<br/>**[ルート ドメイン名]** = corp.contoso.com |
    | ドメイン コントローラー オプション |**パスワード** = Contoso!000<br/>**[パスワードの確認]** = Contoso!000 |
14. **[次へ]** をクリックして、ウィザード内の他のページを進めます。 **[前提条件のチェック]** ページで、"**すべての前提条件のチェックに合格しました**" というメッセージが表示されることを確認します。 関連する警告メッセージを確認する必要がありますが、インストールは続行できます。
15. **[インストール]**をクリックします。 **ContosoDC** 仮想マシンは自動的に再起動します。

## <a name="configure-domain-accounts"></a>ドメイン アカウントの構成
次の手順では、後で使用するために Active Directory (AD) アカウントを構成します。

1. **ContosoDC** コンピューターに再度ログインします。
2. **[サーバー マネージャー]** で、**[ツール]** を選択し、**[Active Directory 管理センター]** をクリックします。
   
    ![[Active Directory 管理センター]](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784626.png)
3. **[Active Directory 管理センター]** select **[corp (ローカル)]** を選択します。
4. 右側の **[タスク]** ウィンドウで、**[新規]** を選択し、**[ユーザー]** をクリックします。 次の設定を使用します。
   
   | 設定 | 値 |
   | --- | --- |
   | **名** |[インストール] |
   | **ユーザー SAM アカウント名** |[インストール] |
   | **パスワード** |Contoso!000 |
   | **パスワードの確認** |Contoso!000 |
   | **その他のパスワード オプション** |オン |
   | **パスワードを無期限にする** |オン |
5. **[OK]** をクリックして **Install** ユーザーを作成します。 このアカウントは、フェールオーバー クラスターと可用性グループの構成に使用されます。
6. 同じ手順を使用して、さらに 2 つのユーザー (**CORP\SQLSvc1** と **CORP\SQLSvc2**) を作成します。 これらのアカウントは、SQL Server インスタンスに使用されます。次に、Windows フェールオーバー クラスタリングを構成するために必要なアクセス許可を **CORP\Install** に付与する必要があります。
7. **[Active Directory 管理センター]** で、左側のウィンドウの **[corp (ローカル)]** を選択します。 その後、右側の **[タスク]** ウィンドウで、**[プロパティ]** をクリックします。
   
    ![CORP ユーザー プロパティ](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784627.png)
8. **[拡張機能]** を選択し、**[セキュリティ]** タブの **[詳細設定]** をクリックします。
9. **[corp のセキュリティの詳細設定]** ウィンドウで、 **[追加]**をクリックします。
10. **[プリンシパルの選択]**をクリックします。 次に、「**CORP\Install**」を検索します。 **[OK]**をクリックします。
11. **[すべてのプロパティの読み取り]** アクセス許可と **[コンピューター オブジェクト作成]** アクセス許可を選択します。
    
     ![CORP ユーザー権限](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784628.png)
12. **[OK]** をクリックし、もう一度 **[OK]** をクリックします。 corp のプロパティ ウィンドウを閉じます。

これで Active Directory とユーザー オブジェクトの構成が完了したので、3 つの SQL Server VM を作成してこのドメインに参加させます。

## <a name="create-the-sql-server-vms"></a>SQL Server VM の作成
次に、3 つの VM (クラスター ノードと 2 つの SQL Server VM) を作成します。 各 VM を作成するには、Azure クラシック ポータルに戻り、**[新規]**、**[Compute]**、**[仮想マシン]**、**[ギャラリーから]** の順にクリックします。 その後、次の表のテンプレートを使用すると、VM の作成に役立ちます。

| ページ | VM1 | VM2 | VM3 |
| --- | --- | --- | --- |
| 仮想マシンのオペレーティング システムの選択 |**Windows Server 2012 R2 Datacenter** |**SQL Server 2014 RTM Enterprise** |**SQL Server 2014 RTM Enterprise** |
| 仮想マシンの構成 |**[バージョンのリリース日]** = (最新)<br/>**[仮想マシン名]** = ContosoWSFCNode<br/>**[階層]** = Standard<br/>**[サイズ]** = A2 (2 コア)<br/>**[新しいユーザー名]** = AzureAdmin<br/>**[パスワード]** = Contoso!000<br/>**[確認]** = Contoso!000 |**[バージョンのリリース日]** = (最新)<br/>**[仮想マシン名]** = ContosoSQL1<br/>**[階層]** = Standard<br/>**[サイズ]** = A3 (4 コア)<br/>**[新しいユーザー名]** = AzureAdmin<br/>**[パスワード]** = Contoso!000<br/>**[確認]** = Contoso!000 |**[バージョンのリリース日]** = (最新)<br/>**[仮想マシン名]** = ContosoSQL2<br/>**[階層]** = Standard<br/>**[サイズ]** = A3 (4 コア)<br/>**[新しいユーザー名]** = AzureAdmin<br/>**[パスワード]** = Contoso!000<br/>**[確認]** = Contoso!000 |
| 仮想マシンの構成 |**[クラウド サービス]** = 以前に作成された一意のクラウド サービス DNS 名 (例: ContosoDC123)<br/>**[リージョン/アフィニティ グループ/仮想ネットワーク]** = ContosoNET<br/>**[仮想ネットワーク サブネット]** = Back(10.10.2.0/24)<br/>**[ストレージ アカウント]**: 自動的に生成されたストレージ アカウントを使用<br/>**[可用性セット]** = 可用性セットを作成<br/>**[可用性セット名]** = SQLHADR |**[クラウド サービス]** = 以前に作成された一意のクラウド サービス DNS 名 (例: ContosoDC123)<br/>**[リージョン/アフィニティ グループ/仮想ネットワーク]** = ContosoNET<br/>**[仮想ネットワーク サブネット]** = Back(10.10.2.0/24)<br/>**[ストレージ アカウント]**: 自動的に生成されたストレージ アカウントを使用<br/>**[可用性セット]** = SQLHADR (マシンが作成された後に可用性セットを構成することもできます。 3 つの仮想マシンはすべて SQLHADR 可用性セットに割り当てる必要があります。) |**[クラウド サービス]** = 以前に作成された一意のクラウド サービス DNS 名 (例: ContosoDC123)<br/>**[リージョン/アフィニティ グループ/仮想ネットワーク]** = ContosoNET<br/>**[仮想ネットワーク サブネット]** = Back(10.10.2.0/24)<br/>**[ストレージ アカウント]**: 自動的に生成されたストレージ アカウントを使用<br/>**[可用性セット]** = SQLHADR (マシンが作成された後に可用性セットを構成することもできます。 3 つの仮想マシンはすべて SQLHADR 可用性セットに割り当てる必要があります。) |
| 仮想マシンのオプション |既定値を使用 |既定値を使用 |既定値を使用 |

<br/>

> [!NOTE]
> 前の構成は、Standard レベルの仮想マシンを示唆しています。これは、Basic レベルのマシンでは、後で可用性グループ リスナーを作成するために必要な負荷分散されるエンドポイントがサポートされないためです。 また、ここで示されるマシンのサイズは、Azure VM での可用性グループのテストに対応しています。 運用時のワークロードに対して最適なパフォーマンスを得る方法については、「[Azure Virtual Machines における SQL Server のパフォーマンスのベスト プラクティス](../sql/virtual-machines-windows-sql-performance.md)」の SQL Server マシンのサイズと構成に関する推奨事項を参照してください。
> 
> 

3 つの VM が完全にプロビジョニングされたら、その 3 つの VM を **corp.contoso.com** ドメインに参加させて、それらに対する管理者権限を CORP\Install に付与する必要があります。 この操作を行うには、3 つの VM それぞれで、次の手順を実行します。

1. まず、優先 DNS サーバー アドレスを変更します。 最初に、一覧で VM を選択して **[接続]** クリックすることで、各 VM のリモート デスクトップ (RDP) ファイルをローカル ディレクトリにダウンロードします。 VM を選択するには、次に示すように、選択する行で最初のセル以外の任意の場所をクリックします。
   
    ![RDP ファイルのダウンロード](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC664953.jpg)
2. ダウンロードした RDP ファイルを起動し、構成した管理者アカウント (**BUILTIN\AzureAdmin**) とパスワード (**Contoso!000**) を使用して VM にログインします。
3. ログインすると、 **[サーバー マネージャー]** ダッシュボードが表示されます。 左側のウィンドウで **[ローカル サーバー]** をクリックします。
4. **[IPv4 アドレス (DHCP により割り当て)、IPv6 (有効)]** リンクを選択します。
5. **[ネットワーク接続]** ウィンドウで、ネットワーク アイコンを選択します。
   
    ![VM 優先 DNS サーバーの変更](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784629.png)
6. コマンド バーの **[この接続の設定を変更する]** をクリックします (ウィンドウのサイズによっては、右向き二重矢印をクリックしないと、このコマンドが表示されない場合があります)。
7. **[インターネット プロトコル バージョン 4 (TCP/IPv4)]** を選択し、[プロパティ] をクリックします。
8. [次の DNS サーバーのアドレスを使う] を選択し、**[優先 DNS サーバー]** に「**10.10.2.4**」を指定します。
9. アドレス **10.10.2.4** は、Azure Virtual Network の 10.10.2.0/24 サブネット内の VM に割り当てられているアドレスです。このアドレスが割り当てられている VM が **ContosoDC** です。 **ContosoDC** の IP アドレスを確認するには、次のように、コマンド プロンプトで **nslookup contosodc** を使用します。
   
    ![NSLOOKUP を使用して DC の IP アドレスを検索](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC664954.jpg)
10. **[OK]**、**[閉じる]** の順にクリックして変更を適用します。 これで、VM を **corp.contoso.com**に参加させることができるようになりました。
11. **[ローカル サーバー]** ウィンドウに戻り、**[ワークグループ]** のリンクをクリックします。
12. **[コンピューター名]** セクションで **[変更]** をクリックします。
13. **[ドメイン]** チェック ボックスをオンにし、テキスト ボックスに「**corp.contoso.com**」を入力します。 **[OK]**をクリックします。
14. **[Windows セキュリティ]** ポップアップ ダイアログで、既定のドメイン管理者の資格情報であるアカウント (**CORP\AzureAdmin**) とパスワード (**Contoso!000**) を指定します。
15. "corp.contoso.com ドメインへようこそ" のメッセージが表示されたら、 **[OK]**をクリックします。
16. **[閉じる]** をクリックし、ポップアップ ダイアログの **[今すぐ再起動]** をクリックします。

### <a name="add-the-corpinstall-user-as-an-administrator-on-each-vm"></a>各 VM で Corp \Install ユーザーを管理者として追加する
1. VM が再起動されるまで待った後、RDP ファイルを再び起動し、**BUILTIN\AzureAdmin** アカウントを使用して VM にログインします。
2. **[サーバー マネージャー]** で、**[ツール]** を選択し、**[コンピューターの管理]** をクリックします。
   
    ![[コンピューターの管理]](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784630.png)
3. **[コンピューターの管理]** ウィンドウで、**[ローカル ユーザーとグループ]** を展開し、**[グループ]** を選択します。
4. **[Administrators]** グループをダブルクリックします。
5. **[Administrators のプロパティ]** ダイアログ ボックスで、**[追加]** をクリックします。
6. ユーザーに「**CORP\Install**」を入力し、**[OK]** をクリックします。 資格情報の入力を求められたら、**AzureAdmin** アカウントと **Contoso!000** パスワードを使用します。
7. **[OK]** をクリックして **[管理者のプロパティ]** ダイアログ ボックスを閉じます。

### <a name="add-the-failover-clustering-feature-to-each-vm"></a>各 VM に **フェールオーバー クラスタリング** 機能を追加します。
1. **[サーバー マネージャー]** ダッシュボードの **[役割と機能の追加]** をクリックします。
2. **役割と機能の追加ウィザード**で、**[機能]** ページが表示されるまで **[次へ]** をクリックします。
3. **[フェールオーバー クラスタリング]**を選択します。 メッセージが表示されたら、その他の依存する機能を追加します。
   
    ![フェールオーバー クラスタリング機能を VM に追加](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784631.png)
4. **[次へ]** をクリックして、**[確認]** ページの **[インストール]** をクリックします。
5. **フェールオーバー クラスタリング**機能のインストールが完了したら、**[閉じる]** をクリックします。
6. VM からログアウトします。
7. 3 つのサーバー (**ContosoWSFCNode**、**ContosoSQL1**、**ContosoSQL2**) すべてで、このセクションの手順を繰り返します。

これで SQL Server VM がプロビジョニングされ、実行されている状態になりましたが、これらは SQL Server と共に既定のオプションでインストールされています。

## <a name="create-the-failover-cluster"></a>フェールオーバー クラスターを作成する
このセクションでは、後で作成する可用性グループをホストするフェールオーバー クラスターを作成します。 ここまでに、フェールオーバー クラスター内で使用する 3 つの VM に対して、次の操作を行いました。

* Azure で完全にプロビジョニングする
* VM をドメインに参加させる
* ローカルの Administrators グループに **CORP\Install** を追加する
* フェールオーバー クラスタリング機能を追加する

これらはすべて、フェールオーバー クラスターに参加させるための各 VM の前提条件です。

また、Azure Virtual Network の動作は、オンプレミス ネットワークとは異なることに注意してください。 クラスターは、次の順序で作成する必要があります。

1. ノードのいずれかに単一ノード クラスターを作成します (**ContosoSQL1**)。
2. クラスターの IP アドレスを未使用の IP アドレス (**10.10.2.101**) に変更します。
3. クラスター名をオンラインにします。
4. 他のノード (**ContosoSQL2** と **ContosoWSFCNode**) を追加します。

次の手順に従って、クラスターを完全に構成する上記のタスクを完了してください。

1. **ContosoSQL1** の RDP ファイルを起動し、ドメイン アカウント **CORP\Install** を使用してログインします。
2. **[サーバー マネージャー]** ダッシュボードで、**[ツール]** を選択し、**[フェールオーバー クラスター マネージャー]** をクリックします。
3. 次に示すように、左側のウィンドウで、**[フェールオーバー クラスター マネージャー]** を右クリックし、**[クラスターの作成]** をクリックします。
   
    ![クラスターの作成](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784632.png)
4. クラスターの作成ウィザードの各ページで、次の設定を使用して、単一ノード クラスターを作成します。
   
   | ページ | [設定] |
   | --- | --- |
   | 開始する前に |既定値を使用 |
   | サーバーの選択 |**[サーバー名の入力]** に「**ContosoSQL1**」と入力し、**[追加]** をクリックします。 |
   | 検証の警告 |**[いいえ、このクラスターに Microsoft のサポートは必要ありませんので、検証テストを実行しません。[次へ] をクリックして、クラスターの作成を続行します。]** を選択します。 |
   | クラスター管理用のアクセス ポイント |**[クラスター名]** に「**Cluster1**」と入力します。 |
   | [次へ] |記憶域スペースを使用している場合を除き、既定値を使用します。 この表の次の注を参照してください。 |
   
   > [!WARNING]
   > 複数のディスクを記憶域プールにグループ化する[記憶域スペース](https://technet.microsoft.com/library/hh831739)を使用している場合は、**[確認]** ページの **[使用可能な記憶域をすべてクラスターに追加する]** チェック ボックスをオフにする必要があります。 このチェック ボックスをオフにしないと、クラスタリング処理中に仮想ディスクがデタッチされます。 その結果、記憶域スペースがクラスターから削除され、PowerShell を使用して再アタッチされるまで、仮想ディスクはディスク マネージャーやエクスプローラーにも表示されなくなります。
   > 
   > 
5. 左側のウィンドウで、**[フェールオーバー クラスター マネージャー]** を展開し、**[Cluster1.corp.contoso.com]** をクリックします。
6. 中央のウィンドウで、下方法へスクロールして **[クラスター コア リソース]** セクションを表示し、**[名前: Clutser1]** の詳細を展開します。 **[名前]** と **[IP アドレス]** リソースの両方が **[失敗]** 状態で表示されます。 クラスターにコンピューター自体と同じ IP アドレスが割り当てられていて、アドレスが重複するため、IP アドレス リソースをオンラインにすることができません。
7. 失敗した **IP アドレス** リソースを右クリックし、**[プロパティ]** をクリックします。
   
    ![クラスターのプロパティ](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784633.png)
8. **[静的 IP アドレス]** を選択して、[アドレス] ボックスに「**10.10.2.101**」を指定します。 次に、 **[OK]**をクリックします
9. **[クラスター コア リソース]** セクションで、**[名前: Cluster1]** を右クリックして、**[オンラインにする]** をクリックします。 両方のリソースがオンラインになるまで待ちます。 クラスター名リソースがオンラインになると、新しい AD コンピューター アカウントで DC サーバーが更新されます。 この AD アカウントは、後で可用性グループのクラスター化サービスを実行するときに使用されます。
10. 最後に、残りのノードをクラスターに追加します。 次に示すように、ブラウザー ツリーで **[Cluster1.corp.contoso.com]** を右クリックして、**[ノードの追加]** をクリックします。
    
     ![クラスターにノードを追加](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784634.png)
11. **ノードの追加ウィザード**で、**[次へ]** をクリックします。 **[サーバーの選択]** ページで、**ContosoSQL2** と **ContosoWSFCNode** を一覧に追加します。これには、**[サーバー名の入力]** にサーバー名を入力し、**[追加]** をクリックします。 完了したら、**[次へ]** をクリックします。
12. **[検証の警告]** ページで **[いいえ]** をクリックします (実際の運用時には、検証テストを実施する必要があります)。 次に、 **[次へ]**をクリックします。
13. **[確認]** ページで **[次へ]** をクリックしてノードを追加します。
    
    > [!WARNING]
    > 複数のディスクを記憶域プールにグループ化する [記憶域スペース](https://technet.microsoft.com/library/hh831739)を使用している場合は、 **[使用可能な記憶域をすべてクラスターに追加する]** チェック ボックスをオフにする必要があります。 このチェック ボックスをオフにしないと、クラスタリング処理中に仮想ディスクがデタッチされます。 その結果、記憶域スペースがクラスターから削除され、PowerShell を使用して再アタッチされるまで、仮想ディスクはディスク マネージャーやエクスプローラーにも表示されなくなります。
    > 
    > 
14. ノードがクラスターに追加されたら、 **[完了]**をクリックします。 フェールオーバー クラスター マネージャーでは、クラスターに 3 つのノードがあることが示され、その 3 つのノードが **[ノード]** コンテナーの一覧に表示されます。
15. リモート デスクトップ セッションからログアウトします。

## <a name="prepare-the-sql-server-instances-for-availability-group"></a>可用性グループの SQL Server インスタンスの準備
このセクションでは、**ContosoSQL1** と **contosoSQL2** の両方で、次の操作を行います。

* 既定の SQL Server インスタンスに対する必要なアクセス許可を設定して **NT AUTHORITY\System** のログインを追加する
* 既定の SQL Server インスタンスの sysadmin ロールとして **CORP\Install** を追加する
* ファイアウォールを解放し、SQL Server のリモート アクセスを許可する
* AlwaysOn 可用性グループ機能を有効にする
* SQL Server サービス アカウントを **CORP\SQLSvc1** と **CORP\SQLSvc2** にそれぞれ変更する

上記の操作は、任意の順序で実行できます。 ただし、次の手順はこの順序どおりに実行します。 この手順は、**ContosoSQL1** と **ContosoSQL2** の両方で実行します。

1. VM のリモート デスクトップ セッションからログアウトしていない場合は、今すぐログアウトしてください。
2. **ContosoSQL1** と **ContosoSQL2** の RDP ファイルを起動し、**BUILTIN\AzureAdmin** としてログインします。
3. 最初に、必要なアクセス許可と共に **NT AUTHORITY\System** を SQL Server ログインに追加します。 **SQL Server Management Studio**を起動します。
4. **[接続]** をクリックして、既定の SQL Server インスタンスに接続します。
5. **オブジェクト エクスプローラー**で、**[セキュリティ]**、**[ログイン]** の順に展開します。
6. **[NT AUTHORITY\System]** ログインを右クリックし、**[プロパティ]** をクリックします。
7. ローカル サーバーの **[セキュリティ保護可能なリソース]** ページで、次のアクセス許可の **[許可]** を選択し、**[OK]** をクリックします。
   
   * 可用性グループの変更
   * SQL の接続
   * サーバー状態の表示
8. 次に、既定の SQL Server インスタンスに **sysadmin** ロールとして **CORP\Install** を追加します。 **オブジェクト エクスプローラー**で、**[ログイン]** を右クリックし、**[新しいログイン]** をクリックします。
9. **[ログイン名]** に「**CORP\Install**」と入力します。
10. **[サーバーの役割]** ページで、**[sysadmin]** を選択します。 次に、 **[OK]**をクリックします 作成されたログインは、**オブジェクト エクスプローラー**で **[ログイン]** を展開すると表示されます。
11. 次に、SQL Server のファイアウォール規則を作成します。 **スタート**画面から **[セキュリティが強化された Windows ファイアウォール]** を開きます。
12. 左側のウィンドウで、 **[受信の規則]**を選択します。 右側のウィンドウで、 **[新しい規則]**をクリックします。
13. **[規則の種類]** ページで、**[プログラム]** を選択して **[次へ]** をクリックします。
14. **[プログラム]** ページで、**[このプログラムのパス]** を選択し、テキスト ボックスに「**%ProgramFiles%\Microsoft SQL Server\MSSQL12.MSSQLSERVER\MSSQL\Binn\sqlservr.exe**」と入力します (SQL Server 2012 を使用してこの手順を実行している場合、SQL Server のディレクトリは **MSSQL11.MSSQLSERVER** になります)。 その後、 **[次へ]**をクリックします。
15. **[操作]** ページで、**[接続を許可する]** を選択したまま、**[次へ]** をクリックします。
16. **[プロファイル]** ページで、既定の設定をそのまま使用し、**[次へ]** をクリックします。
17. **[名前]** ページで、**[名前]** ボックスに規則の名前 (**SQL Server (プログラム規則)** など) を指定し、**[完了]** をクリックします。
18. 次に、 **AlwaysOn 可用性グループ** 機能を有効にします。 **スタート**画面から **SQL Server 構成マネージャー**を起動します。
19. ブラウザー ツリーで、**[SQL Server のサービス]** をクリックし、**[SQL Server (MSSQLSERVER)]** サービスを右クリックして、**[プロパティ]** をクリックします。
20. 次に示すように、**[AlwaysOn 高可用性]** タブをクリックし、**[AlwaysOn 可用性グループを有効にする]** をオンにして、**[適用]** をクリックします。 ポップアップ ダイアログで **[OK]** をクリックします。プロパティ ウィンドウはまだ閉じないでください。 サービス アカウントを変更した後に SQL Server サービスを再起動します。
    
     ![AlwaysOn 可用性グループの有効化](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665520.gif)
21. 次に、SQL Server サービス アカウントを変更します。 **[ログオン]** タブをクリックし、**[アカウント名]** に「**CORP\SQLSvc1**」(**ContosoSQL1** の場合) または「**CORP\SQLSvc2**」(**ContosoSQL2** の場合) を入力します。その後、パスワードを入力および確認入力し、**[OK]** をクリックします。
22. ポップアップ ウィンドウで **[はい]** をクリックして、SQL Server サービスを再起動します。 SQL Server サービスが再起動されると、プロパティ ウィンドウで行った変更が有効になります。
23. VM からログアウトします。

## <a name="create-the-availability-group"></a>可用性グループの作成
これで、可用性グループを構成できるようになりました。 この後の操作の概要は以下のとおりです。

* **ContosoSQL1** に新しいデータベース (**MyDB1**) を作成する
* データベースの完全バックアップとトランザクション ログ バックアップの両方を作成する
* **NORECOVERY** オプションを使用して完全バックアップとログ バックアップを **ContosoSQL2** に復元する
* 同期コミット、自動フェールオーバー、読み取り可能なセカンダリのレプリカを含む可用性グループ (**AG1**) を作成する

### <a name="create-the-mydb1-database-on-contososql1"></a>ContosoSQL1 に MyDB1 データベースを作成する
1. **ContosoSQL1** と **ContosoSQL2** のリモート デスクトップ セッションからまだログアウトしていない場合は、今すぐログアウトします。
2. **ContosoSQL1** の RDP ファイルを起動し、**CORP\Install** としてログインします。
3. **エクスプローラー**で、**C:\** ドライブの下に**backup* というディレクトリを作成します。 このディレクトリは、データベースのバックアップと復元に使用します。
4. 次に示すように、新しいディレクトリを右クリックして **[共有]** をポイントし、**[特定のユーザー]** をクリックします。
   
    ![バックアップ フォルダーの作成](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665521.gif)
5. 次のように、**CORP\SQLSvc1** を追加して **[読み取り/書き込み]** アクセス許可を指定し、**CORP\SQLSvc2** を追加して **[読み取り]** アクセス許可を指定した後、**[共有]** をクリックします。 ファイル共有プロセスが完了したら、 **[完了]**をクリックします。
   
    ![バックアップ フォルダーの権限を付与](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665522.gif)
6. 次に、データベースを作成します。 **[スタート]** メニューから **SQL Server Management Studio** を起動し、**[接続]** をクリックして既定の SQL Server インスタンスに接続します。
7. **オブジェクト エクスプローラー**で、**[データベース]** を右クリックし、**[新しいデータベース]** をクリックします。
8. **[データベース名]** に「**MyDB1**」と入力し、**[OK]** をクリックします。

### <a name="take-a-full-backup-of-mydb1-and-restore-it-on-contososql2"></a>MyDB1 の完全バックアップを作成して ContosoSQL2 に復元する
1. 次に、データベースの完全バックアップを作成します。 **オブジェクト エクスプローラー**で、**[データベース]** を展開し、**[MyDB1]** を右クリックして **[タスク]** をポイントし、**[バックアップ]** をクリックします。
2. **[ソース]** セクションで、**[バックアップの種類]** を **[完全]** に設定しておきます。 **[バックアップ先]** セクションで、**[削除]** をクリックして、バックアップ ファイルの既定のファイル パスを削除します。
3. **[バックアップ先]** セクションで、**[追加]** をクリックします。
4. **[ファイル名]** ボックスに「**\\ContosoSQL1\backup\MyDB1.bak**」と入力します。 **[OK]** をクリックし、もう一度 **[OK]** をクリックしてデータベースをバックアップします。 バックアップ操作が完了したら、もう一度 **[OK]** をクリックしてダイアログを閉じます。
5. 次に、データベースのトランザクション ログ バックアップを作成します。 **オブジェクト エクスプローラー**で、**[データベース]** を展開し、**[MyDB1]** を右クリックして **[タスク]** をポイントし、**[バックアップ]** をクリックします。
6. **[バックアップの種類]** で **[トランザクション ログ]** を選択します。 **[バックアップ先]** のファイル パスの設定を、前に指定したパスのままにし、**[OK]** をクリックします。 バックアップ操作が完了したら、もう一度 **[OK]** をクリックします。
7. 次に、 **ContosoSQL2**で完全バックアップとトランザクション ログ バックアップを復元します。 **ContosoSQL2** の RDP ファイルを起動し、**CORP\Install** としてログインします。 **ContosoSQL1** のリモート デスクトップ セッションは、開いたままにします。
8. **[スタート]** メニューから **SQL Server Management Studio** を起動し、**[接続]** をクリックして既定の SQL Server インスタンスに接続します。
9. **オブジェクト エクスプローラー**で、**[データベース]** を右クリックし、**[データベースの復元]** をクリックします。
10. **[ソース]** セクションで **[デバイス]** を選択し、省略記号 (**…**) ボタンをクリックします。 ボタンを選択します。
11. **[バックアップ デバイスの選択]** で、**[追加]** をクリックします。
12. [バックアップ ファイルの場所] に「\\ContosoSQL1\backup」を入力して [更新] をクリックし、[MyDB1.bak] を選択して [OK] をクリックした後、もう一度 [OK] をクリックします。 [復元するバックアップ セット] ウィンドウに完全バックアップとログ バックアップが表示されます。
13. [オプション] ページに移動し、[復旧状態] で [RESTORE WITH NORECOVERY] を選択し、[OK] をクリックしてデータベースを復元します。 復元操作が完了したら、[OK] をクリックします。

### <a name="create-the-availability-group"></a>可用性グループを作成する
1. **ContosoSQL1**のリモート デスクトップ セッションに戻ります。 次に示すように、SSMS の**オブジェクト エクスプローラー**で、**[AlwaysOn 高可用性]** を右クリックし、**[新しい可用性グループ ウィザード]** をクリックします。
   
    ![[新しい可用性グループ ウィザード] の起動](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665523.gif)
2. **[説明]** ページで **[次へ]** をクリックします。 **[可用性グループ名の指定]** ページで、**[可用性グループ名]** に「**AG1**」と入力し、もう一度 **[次へ]** をクリックします。
   
    ![新しい AG ウィザード、AG 名の指定](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665524.gif)
3. **[データベースの選択]** ページで、**[MyDB1]** を選択し、**[次へ]** をクリックします。 対象とするプライマリ レプリカで完全バックアップを少なくとも 1 つは作成しているため、このデータベースは可用性グループの前提条件を満たしています。
   
    ![新しい AG ウィザード、データベースの選択](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665525.gif)
4. **[レプリカの指定]** ページで **[レプリカの追加]** をクリックします。
   
    ![新しい AG ウィザード、レプリカの指定](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665526.gif)
5. **[サーバーに接続]** ダイアログが表示されます。 **[サーバー名]** に「**ContosoSQL2**」と入力し、**[接続]** をクリックします。
   
    ![新しい AG ウィザード、サーバーに接続](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665527.gif)
6. **[レプリカの指定]** ページに戻ると、**[可用性レプリカ]** の一覧に **ContosoSQL2** が表示されていることがわかります。 次に示すようにレプリカを構成します。 構成し終わったら、 **[次へ]**をクリックします。
   
    ![新しい可用性グループ ウィザード、レプリカの指定 (完了)](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665528.gif)
7. **[最初のデータの同期を選択]** ページで、**[結合のみ]** を選択し、**[次へ]** をクリックします。 データの同期は、**ContosoSQL1** で完全バックアップとトランザクション バックアップを作成し、**ContosoSQL2** で復元したときに既に手動で実行しています。 データベースのバックアップの作成操作と復元操作を実行しない代わりに、新しい可用性グループ ウィザードで **[完全]** を選択すると、データの同期を実行させることができます。 ただし、一部の企業で使用されている大規模なデータベースではこの方法はお勧めしません。
   
    ![新しい可用性グループ ウィザード、最初のデータの同期を選択](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665529.gif)
8. **[検証]** ページで **[次へ]** をクリックします。 このページは、次のようになっています。 可用性グループ リスナーを構成していないため、リスナー構成に関する警告が表示されます。 このチュートリアルではリスナーを構成しないため、この警告を無視できます。 このチュートリアルの完了後にリスナーを構成する場合は、「[Azure での AlwaysOn 可用性グループの ILB リスナーの構成](../classic/ps-sql-int-listener.md)」をご覧ください。
   
    ![新しい AG ウィザード、検証](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665530.gif)
9. **[概要]** ページで、**[完了]** をクリックし、新しい可用性グループが構成されるまで待ちます。 **[進行状況]** ページで **[詳細]** をクリックすると、進行状況が詳しく表示されます。 ウィザードが完了したら、**[結果]** ページを調べて、次のように、可用性グループが正常に作成されたことを確認します。その後、**[閉じる]** をクリックしてウィザードを終了します。
   
    ![新しい AG ウィザード、結果](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665531.gif)
10. **オブジェクト エクスプローラー**で、**[AlwaysOn 高可用性]**、**[可用性グループ]** の順に展開します。 このコンテナー内に新しい可用性グループが表示されます。 **[AG1 (プライマリ)]** を右クリックして **[ダッシュボードの表示]** をクリックします。
    
     ![AG ダッシュボードの表示](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665532.gif)
11. **AlwaysOn ダッシュボード** が次のように表示されます。 レプリカ、各レプリカのフェールオーバー モード、および同期の状態を確認できます。
    
     ![AG ダッシュボード](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665533.gif)
12. **[サーバー マネージャー]** に戻り、**[ツール]** を選択し、**[フェールオーバー クラスター マネージャー]** を起動します。
13. **[Cluster1.corp.contoso.com]**、**[サービスとアプリケーション]** の順に展開します。 **[役割]** を選択し、**AG1** 可用性グループの役割が作成されていることに注目します。 リスナーを構成していないため、AG1 には、データベース クライアントが可用性グループに接続するときに使用する IP アドレスがありません。 読み取り/書き込み操作の場合はプライマリ ノードに、読み取り専用クエリの場合はセカンダリ ノードに直接接続できます。
    
     ![フェールオーバー クラスター マネージャー内のAG](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665534.gif)

> [!WARNING]
> フェールオーバー クラスター マネージャーから、可用性グループのフェールオーバーを実行しないでください。 すべてのフェールオーバー操作は、SSMS の **AlwaysOn ダッシュボード** から実行する必要があります。 詳細については、[フェールオーバー クラスター マネージャーと可用性グループの使用に関する制限事項](https://msdn.microsoft.com/library/ff929171.aspx)のページを参照してください。
> 
> 

## <a name="next-steps"></a>次のステップ
これで、Azure に可用性グループを作成して、SQL Server AlwaysOn を正常に実装できました。 この可用性グループのリスナーを構成するには、「 [Azure での AlwaysOn 可用性グループの ILB リスナーの構成](../classic/ps-sql-int-listener.md)」をご覧ください。

Azure での SQL Server の使用に関するその他の情報については、「 [Azure Virtual Machines における SQL Server](../sql/virtual-machines-windows-sql-server-iaas-overview.md)」を参照してください。


