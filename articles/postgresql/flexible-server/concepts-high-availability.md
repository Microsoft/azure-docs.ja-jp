---
title: Azure Database for PostgreSQL - フレキシブル サーバー (プレビュー) でのゾーン冗長の高可用性の概要
description: Azure Database for PostgreSQL - フレキシブル サーバーでのゾーン冗長の高可用性の概念について説明します。
author: sr-msft
ms.author: srranga
ms.service: postgresql
ms.topic: conceptual
ms.date: 09/22/2020
ms.openlocfilehash: c0d9b6042ae695caa73d926653f237b756bf4971
ms.sourcegitcommit: f28ebb95ae9aaaff3f87d8388a09b41e0b3445b5
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/29/2021
ms.locfileid: "94366725"
---
# <a name="high-availability-concepts-in-azure-database-for-postgresql---flexible-server"></a>Azure Database for PostgreSQL - フレキシブル サーバーでの高可用性の概念

> [!IMPORTANT]
> Azure Database for PostgreSQL - フレキシブル サーバーはプレビュー段階です

Azure Database for PostgreSQL - フレキシブル サーバーは、**ゾーン冗長** サーバー デプロイを使用した自動フェールオーバー機能による高可用性構成を提供します。 ゾーン冗長構成でデプロイされた場合、フレキシブル サーバーによって自動的に、スタンバイ レプリカがプロビジョニングされ、別の可用性ゾーンで管理されます。 データは、PostgreSQL ストリーミング レプリケーションを使用して、**同期** モードでスタンバイ レプリカ サーバーにレプリケートされます。 

ゾーン冗長構成では、ユーザーが開始したコンピューティングのスケーリング操作などの計画的なイベント中だけでなく、基になるハードウェアやソフトウェアの障害、ネットワーク障害、可用性ゾーンの障害などの計画外のイベント中にも、データ損失のない自動フェールオーバー機能が有効になります。 

:::image type="content" source="./media/business-continuity/concepts-zone-redundant-high-availability-architecture.png" alt-text="ゾーン冗長の高可用性"::: 

## <a name="zone-redundant-high-availability-architecture"></a>ゾーン冗長の高可用性のアーキテクチャ

プライマリ データベース サーバーをデプロイするリージョンと可用性ゾーンを選択できます。 スタンバイ レプリカ サーバーは、プライマリ サーバーと同じ構成 (コンピューティング レベル、コンピューティング サイズ、ストレージ サイズ、ネットワーク構成を含む) を持つ別の可用性ゾーンにプロビジョニングされます。 トランザクション ログは、PostgreSQL ストリーミング レプリケーションを使用して、同期モードでスタンバイ レプリカにレプリケートされます。 自動バックアップはプライマリ データベース サーバーから定期的に実行されますが、トランザクション ログはスタンバイ レプリカからバックアップ ストレージに継続的にアーカイブされます。 

高可用性構成の正常性は継続的に監視され、ポータル上で報告されます。 ゾーン冗長の高可用性の状態は次のとおりです。

| **状態** | **説明** |
| ------- | ------ |
| <b> 初期化中 | 新しいスタンバイ サーバーの作成中です。 |
| <b> データのレプリケーション | スタンバイが作成された後、そのスタンバイがプライマリに追いついているところです。 |
| <b> 正常 | レプリケーションは安定状態にあり、正常です。 |
| <b> フェールオーバー | データベース サーバーはスタンバイにフェールオーバー中です。 |
| <b> スタンバイの削除中 | スタンバイ サーバーの削除中です。 | 
| <b> 有効ではない | ゾーン冗長の高可用性は有効ではありません。  |

## <a name="steady-state-operations"></a>安定状態の操作

PostgreSQL クライアント アプリケーションは、DB サーバー名を使用してプライマリ サーバーに接続されます。 アプリケーションの読み取りがプライマリ サーバーから直接処理されるのに対して、コミットと書き込みは、データがプライマリ サーバーとスタンバイ レプリカの両方で保持された後にのみアプリケーションに確認されます。 この追加のラウンド トリップ要件のために、アプリケーションで書き込みとコミットの待機時間が長くなる場合があります。 高可用性の正常性はポータルで監視できます。

:::image type="content" source="./media/business-continuity/concepts-high-availability-steady-state.png" alt-text="ゾーン冗長の高可用性 - 安定状態"::: 

1. クライアントがフレキシブル サーバーに接続し、書き込み操作を実行します。
2. 変更はスタンバイ サイトにレプリケートされます。
3. プライマリが受信確認を受信します。
4. 書き込み/コミットが確認されます。

## <a name="failover-process---planned-downtimes"></a>フェールオーバー プロセス - 計画的なダウンタイム

計画的なダウンタイムのイベントには、Azure のスケジュールされた定期的なソフトウェア更新やマイナー バージョンのアップグレードが含まれます。 高可用性で構成されている場合は、アプリケーションが引き続きプライマリ サーバーにアクセスしている間、これらの操作は最初にスタンバイ レプリカに適用されます。 スタンバイ レプリカが更新されると、プライマリ サーバーの接続がドレインされ、スタンバイ レプリカを同じデータベース サーバー名を持つプライマリとしてアクティブ化するフェールオーバーがトリガーされます。 クライアント アプリケーションは、同じデータベース サーバー名を使用して新しいプライマリ サーバーに再接続する必要があり、その後に操作を再開できます。 新しいスタンバイ サーバーは、古いプライマリと同じゾーン内に確立されます。 

他のユーザーが開始した操作 (コンピューティングのスケーリングやストレージのスケーリングなど) の場合、変更は最初にスタンバイで、その後にプライマリで適用されます。 現在、接続はスタンバイにフェールオーバーされないため、プライマリ サーバーで操作が実行されている間はダウンタイムが発生します。

### <a name="reducing-planned-downtime-with-managed-maintenance-window"></a>管理されたメンテナンス期間による計画的なダウンタイムの短縮

 Azure によって開始されるメンテナンス アクティビティは、データベース上のアクティビティが低いと予測される任意の日の 30 分の期間を選択することによってスケジュールできます。 修正プログラムの適用やマイナー バージョンのアップグレードなどの Azure のメンテナンス タスクは、その期間中に実行されます。  高可用性が構成されているフレキシブル サーバーの場合は、これらのメンテナンス アクティビティが最初にスタンバイ レプリカで実行された後、そのスタンバイ レプリカがアクティブ化されます。 その後、新しいスタンバイがプロビジョニングされている間、アプリケーションは新しいプライマリ サーバーに再接続して操作を再開します。

## <a name="failover-process---unplanned-downtimes"></a>フェールオーバー プロセス - 計画外のダウンタイム

計画外の停止には、データベースの可用性に影響を与えるソフトウェアのバグやインフラストラクチャ コンポーネントの障害が含まれます。 監視システムによってサーバーの使用不可状態が検出された場合は、スタンバイ レプリカへのレプリケーションは切断され、スタンバイ レプリカがプライマリ データベース サーバーとしてアクティブ化されます。 クライアントは、同じ接続文字列を使用してそのデータベース サーバーに再接続し、操作を再開できます。 全体的なフェールオーバー時間は 60 ～ 120 秒になると予測されます。 ただし、フェールオーバーの時点でのプライマリ データベース サーバー内のアクティビティによっては (大規模なトランザクションや復旧時間など)、フェールオーバーがそれより長くなることがあります。

:::image type="content" source="./media/business-continuity/concepts-high-availability-failover-state.png" alt-text="ゾーン冗長の高可用性 - フェールオーバー"::: 

1. プライマリ データベース サーバーがダウンし、クライアントがデータベース接続を失います。 
2. スタンバイ サーバーが新しいプライマリ サーバーになるようにアクティブ化されます。 クライアントは、同じ接続文字列を使用して新しいプライマリ サーバーに接続します。 クライアント アプリケーションをプライマリ データベース サーバーと同じゾーン内に配置すると、待機時間が短縮され、パフォーマンスが向上します。
3. スタンバイ サーバーは古いプライマリ サーバーと同じゾーン内に確立され、ストリーミング レプリケーションが開始されます。 
4. 安定状態のレプリケーションが確立されると、データが両方のサイトで保持された後、クライアント アプリケーションのコミットと書き込みが確認されます。

## <a name="point-in-time-restore"></a>ポイントインタイム リストア 

高可用性が構成されているフレキシブル サーバーでは、データをスタンバイ サーバーにリアルタイムにレプリケートして、それを最新の状態に維持します。 プライマリ サーバー上のユーザー エラー (テーブルの誤った削除やデータの間違った更新など) はすべて、スタンバイ レプリカに忠実にレプリケートされます。 そのため、このような論理エラーから回復するためにスタンバイを使用することはできません。 このようなエラーから回復するには、バックアップからポイントインタイム リストアを実行する必要があります。  フレキシブル サーバーのポイントインタイム リストア機能を使用すると、エラーが発生する前の時刻に復元できます。 高可用性が構成されているデータベースの場合は、新しいデータベース サーバーが、ユーザーが指定した名前を持つ単一ゾーンのフレキシブル サーバーとして復元されます。 その後、データベース サーバーからオブジェクトをエクスポートし、それを運用データベース サーバーにインポートできます。 同様に、テストと開発のためにデータベース サーバーを複製したい場合や、その他の目的のために復元したい場合は、ポイントインタイム リストアを実行できます。

## <a name="zone-redundant-high-availability---features"></a>ゾーン冗長の高可用性 - 機能

-   スタンバイ レプリカは、仮想コア、ストレージ、ネットワーク設定 (VNET、ファイアウォール) などを含め、プライマリ サーバーとまったく同じ VM 構成でデプロイされます。

-   既存のデータベース サーバーの高可用性を追加する機能。

-   高可用性を無効にすることによってスタンバイ レプリカを削除する機能。

-   プライマリ データベース サーバーの可用性ゾーンを選択する機能。

-   プライマリとスタンバイの両方のデータベース サーバーを停止、起動、再起動する機能。

-   自動バックアップはプライマリ データベース サーバーから実行され、ゾーン冗長ストレージに格納されます。

-   クライアントは、常にプライマリ データベース サーバーに接続します。

-   静的サーバー パラメーターの変更を取得するためにサーバーを再起動する機能。
  
-   マイナー バージョンのアップグレードなどの定期的なメンテナンス アクティビティは、ダウンタイムを短縮するために最初にスタンバイで実行され、サービスがフェールオーバーされます。  

## <a name="zone-redundant-high-availability---limitations"></a>ゾーン冗長の高可用性 - 制限

-   高可用性は、バースト可能なコンピューティング レベルではサポートされません。
-   高可用性は、複数のゾーンが使用可能なリージョンでのみサポートされます。
-   別の可用性ゾーンへの同期レプリケーションのために、アプリケーションで書き込みとコミットの待機時間が長くなる場合があります。

-   スタンバイ レプリカを読み取りクエリに使用することはできません。

-   プライマリ サーバー上のワークロードとアクティビティによっては、フェールオーバー プロセスにかかる時間が 120 秒を超える場合があります。

-   プライマリ データベース サーバーを再起動すると、スタンバイ レプリカも再起動されます。 

-   追加の読み取りレプリカの構成はサポートされていません。

-   顧客が開始する管理タスクの構成を、管理されたメンテナンス期間中にスケジュールすることはできません。

-   コンピューティングのスケーリングやストレージのスケーリングなどの計画的なイベントは、最初にスタンバイで、その後にプライマリ サーバーで実行されます。 サーバーは、これらの計画的な操作に対してフェールオーバーしません。 

-  論理デコードまたは論理レプリケーションが HA で構成されたフレキシブル サーバーで構成されている場合、スタンバイ サーバーでのフェールオーバー発生時に、論理レプリケーション スロットがスタンバイ サーバーにコピーされることはありません。  

## <a name="next-steps"></a>次のステップ

-   [ビジネス継続性](./concepts-business-continuity.md)について確認する
-   [高可用性を管理する](./how-to-manage-high-availability-portal.md)方法を確認する
-   [バックアップと復旧](./concepts-backup-restore.md)について確認する