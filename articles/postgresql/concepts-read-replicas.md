---
title: 読み取りレプリカ - Azure Database for PostgreSQL - 単一サーバー
description: この記事では、Azure Database for PostgreSQL (単一サーバー) の読み取りレプリカ機能について説明します。
author: rachel-msft
ms.author: raagyema
ms.service: postgresql
ms.topic: conceptual
ms.date: 08/10/2020
ms.openlocfilehash: 608740ea52cf82485bae073d9679107ac52baa28
ms.sourcegitcommit: cd0a1ae644b95dbd3aac4be295eb4ef811be9aaa
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/19/2020
ms.locfileid: "88611128"
---
# <a name="read-replicas-in-azure-database-for-postgresql---single-server"></a>Azure Database for PostgreSQL (単一サーバー) の読み取りレプリカ

読み取りレプリカ機能を使用すると、Azure Database for PostgreSQL サーバーから、読み取り専用サーバーにデータをレプリケートできます。 マスター サーバーから最大 5 つのレプリカにレプリケートできます。 レプリカは、PostgreSQL エンジンのネイティブ レプリケーション テクノロジを使用して非同期的に更新されます。

レプリカは、通常の Azure Database for PostgreSQL サーバーと同様に管理する新しいサーバーです。 読み取りレプリカごとに、仮想コアおよびストレージのプロビジョニング済みコンピューティング (GB/月) に対して課金されます。

[レプリカを作成して管理する](howto-read-replicas-portal.md)方法を参照してください。

## <a name="when-to-use-a-read-replica"></a>読み取りレプリカを使用する場合
読み取りレプリカ機能は、読み取り集中型ワークロードのパフォーマンスとスケールの向上に役立ちます。 書き込みワークロードをマスターに振り向けながら、読み取りワークロードはレプリカに分離することができます。

BI ワークロードおよび分析ワークロードでレポート用のデータ ソースとして使用するのが、読み取りレプリカの一般的なシナリオです。

レプリカは読み取り専用であるため、マスターへの書き込み容量の負担を直接減らすことにはなりません。 この機能は、書き込み集中型ワークロードを対象としていません。

読み取りレプリカ機能は、PostgreSQL の非同期レプリケーションを使用します。 機能は、同期レプリケーション シナリオを目的としていません。 マスターとレプリカの間には測定可能な遅延が発生します。 レプリカ上のデータは、最終的にマスター上のデータと整合します。 この機能は、この遅延に対応できるワークロードに使用してください。

## <a name="cross-region-replication"></a>リージョン間レプリケーション
マスター サーバーとは別のリージョンに読み取りレプリカを作成できます。 リージョン間レプリケーションは、ディザスター リカバリー計画や、データをユーザーの所在地の近くに配置するなどのシナリオに役立ちます。

>[!NOTE]
> Basic レベルのサーバーは、同じリージョンのレプリケーションのみをサポートしています。

任意の [Azure Database for PostgreSQL リージョン](https://azure.microsoft.com/global-infrastructure/services/?products=postgresql)にマスター サーバーを作成できます。 マスター サーバーは、ペアになっているリージョンまたはユニバーサル レプリカ リージョンにレプリカを持つことができます。 次の図は、マスター リージョンに応じて使用できるレプリカ リージョンを示しています。

[ ![読み取りレプリカ リージョン](media/concepts-read-replica/read-replica-regions.png)](media/concepts-read-replica/read-replica-regions.png#lightbox)

### <a name="universal-replica-regions"></a>ユニバーサル レプリカ リージョン
マスター サーバーが配置されている場所に関係なく、次のいずれかのリージョンに読み取りレプリカをいつでも作成できます。 ユニバーサル レプリカ リージョンは次のとおりです。

オーストラリア東部、オーストラリア南東部、米国中部、東アジア、米国東部、米国東部 2、東日本、西日本、韓国中部、韓国南部、米国中北部、北ヨーロッパ、米国中南部、東南アジア、英国南部、英国西部、西ヨーロッパ、米国西部、米国西部 2、米国中西部。

### <a name="paired-regions"></a>ペアになっているリージョン
ユニバーサル レプリカ リージョンに加えて、マスター サーバーの Azure のペアになっているリージョンに読み取りレプリカを作成できます。 リージョンのペアがわからない場合は、[Azure のペアになっているリージョンに関する記事](../best-practices-availability-paired-regions.md)を参照してください。

ディザスター リカバリー計画にリージョン間レプリカを使用している場合、レプリカの作成場所は別のリージョンのいずれか 1 つではなく、ペアになっているリージョンにすることをお勧めします。 ペアになっているリージョンでは、同時更新を避け、物理的な分離とデータの保存に優先順位を付けます。  

考慮すべきいくつかの制限があります。 

* リージョン別の提供状況Azure Database for PostgreSQL は、フランス中部、アラブ首長国連邦北部、およびドイツ中部で利用できます。 ただし、それらのペアになっているリージョンは使用できません。
    
* 一方向のペア:一部の Azure リージョンは一方向にのみペアになっています。 これらのリージョンには、インド西部とブラジル南部が含まれます。 
   これは、インド西部のマスター サーバーでインド南部のレプリカを作成できることを意味します。 ただし、インド南部のマスター サーバーでインド西部のレプリカを作成することはできません。 この理由は、インド西部のセカンダリ リージョンはインド南部ですが、インド南部のセカンダリ リージョンはインド西部ではないためです。


## <a name="create-a-replica"></a>レプリカの作成
レプリカ作成ワークフローを開始すると、空の Azure Database for PostgreSQL サーバーが作成されます。 新しいサーバーには、マスター サーバー上にあったデータが設定されます。 作成時間は、マスター上のデータ量と、最後の週次完全バックアップからの経過時間に依存します。 時間の範囲は、数分から数時間になる可能性があります。

すべてのレプリカでストレージの[自動拡張](concepts-pricing-tiers.md#storage-auto-grow)が有効になっています。 自動拡張機能により、レプリカはレプリケートされるデータに追従していくことができ、ストレージ不足エラーによって発生するレプリケーションの中断が防止されます。

読み取りレプリカ機能では、PostgreSQL の (論理レプリケーションではなく) 物理レプリケーションが使用されます。 レプリケーション スロットを使用したストリーミング レプリケーションが、既定の動作モードです。 必要に応じて、遅れを取り戻すためにログ配布が使用されます。

[Azure portal で読み取りレプリカを作成する](howto-read-replicas-portal.md)方法を確認してください。

## <a name="connect-to-a-replica"></a>レプリカへの接続
作成されたレプリカでは、マスター サーバーのファイアウォール規則または VNet サービス エンドポイントは継承されません。 これらの規則は、レプリカに対して個別に設定する必要があります。

レプリカの管理者アカウントは、マスター サーバーから継承されます。 マスター サーバー上のすべてのユーザー アカウントが、読み取りレプリカにレプリケートされます。 マスター サーバー上で使用可能なユーザー アカウントを使って読み取りレプリカにのみ接続できます。

通常の Azure Database for PostgreSQL サーバーの場合と同じように、レプリカのホスト名と有効なユーザー アカウントを使用して、レプリカに接続できます。 管理ユーザー名が **myadmin** で **my replica** という名前のサーバーの場合は、次の psql を使用してレプリカに接続できます。

```
psql -h myreplica.postgres.database.azure.com -U myadmin@myreplica -d postgres
```

メッセージが表示されたら、ユーザー アカウントのパスワードを入力します。

## <a name="monitor-replication"></a>レプリケーションを監視します
Azure Database for PostgreSQL には、レプリケーションを監視するための 2 つのメトリックがあります。 2 つのメトリックは **[Max Lag Across Replicas]\(レプリカ間の最大ラグ\)** と **[Replica Lag]\(レプリカ間のラグ\)** です。 これらのメソッドを表示する方法については、[読み取りレプリカのハウツー記事](howto-read-replicas-portal.md)の「**レプリカの監視**」セクションを参照してください。

**[Max lag across replicas]\(レプリカ間の最大ラグ\)** メトリックは、マスターと最も遅れているレプリカの間のラグをバイト単位で示します。 このメトリックは、マスター サーバーのみで使用できます。

**[Replica Lag]\(レプリカのラグ\)** メトリックでは最後に再生されたトランザクションからの時間が表示されます。 マスター サーバーでトランザクションが発生していない場合、メトリックにはこのタイム ラグが反映されます。 このメトリックは、レプリカ サーバーのみで使用できます。 レプリカのラグは、`pg_stat_wal_receiver` ビューから計算されます。

```SQL
EXTRACT (EPOCH FROM now() - pg_last_xact_replay_timestamp());
```

レプリカのラグがワークロードに対して許容できない値に達したときに通知されるアラートを設定します。 

さらに分析情報を得るには、マスター サーバーに対して直接クエリを実行して、すべてのレプリカでのバイト単位のレプリケーション ラグを取得します。

PostgreSQL バージョン 10 の場合:

```SQL
select pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) 
AS total_log_delay_in_bytes from pg_stat_replication;
```

PostgreSQL バージョン 9.6 以前の場合:

```SQL
select pg_xlog_location_diff(pg_current_xlog_location(), replay_location) 
AS total_log_delay_in_bytes from pg_stat_replication;
```

> [!NOTE]
> マスター サーバーまたは読み取りレプリカを再起動した場合、再起動して追いつくまでにかかった時間が、Replica Lag (レプリカ ラグ) メトリックに反映されます。

## <a name="stop-replication"></a>レプリケーションの停止
マスターとレプリカの間のレプリケーションを停止できます。 停止操作により、レプリカは再起動され、そのレプリケーション設定が削除されます。 マスター サーバーと読み取りレプリカの間のレプリケーションを停止すると、レプリカがスタンドアロン サーバーになります。 スタンドアロン サーバー内のデータは、レプリケーション停止コマンドが起動された時点でレプリカで使用可能だったデータです。 スタンドアロン サーバーにはマスター サーバーへの変更が反映されなくなっています。

> [!IMPORTANT]
> スタンドアロン サーバーをもう一度レプリカにすることはできません。
> 読み取りレプリカでレプリケーションを停止する前に、レプリカに必要なすべてのデータがあることを確認してください。

レプリケーションを停止すると、レプリカでは以前のマスターと他のレプリカへのリンクがすべて失われます。

[レプリカへのレプリケーションを停止する](howto-read-replicas-portal.md)方法を確認します。

## <a name="failover"></a>[フェールオーバー]
マスター サーバーとレプリカ サーバー間では、自動フェールオーバーは行われません。 

レプリケーションは非同期であるため、マスターとレプリカの間にラグがあります。 ラグは、マスター サーバーで実行されているワークロードの負荷とデータ センター間の待機時間など、さまざまな要因によって影響を受ける可能性があります。 ほとんどの場合、レプリカのラグは数秒から数分の範囲になります。 各レプリカで利用可能な*レプリカのラグ* メトリックを使用して、実際のレプリケーションのラグを追跡できます。 このメトリックでは、最後に再生されたトランザクションからの時間が表示されます。 長期間にわたってレプリカのラグを観察することで、平均ラグを特定することをお勧めします。 予想される範囲外に出た場合に対処できるように、レプリカのラグにアラートを設定できます。

> [!Tip]
> レプリカにフェールオーバーする場合、マスターからレプリカのリンクを解除したときのラグによって、どれだけのデータが失われたかを示します。

レプリカにフェールオーバーすることを決定したら、次の操作を行います。 

1. レプリカへのレプリケーションを停止する<br/>
   この手順では、レプリカ サーバーで書き込みを受け入れられるようにすることが必要です。 このプロセスの一環として、レプリカ サーバーが再起動され、マスターからリンクが解除されます。 レプリケーションの停止を開始すると、通常、バックエンド プロセスは完了するまでに約 2 分かかります。 このアクションの影響を理解するには、この記事の「[レプリケーションの停止](#stop-replication)」セクションを参照してください。
    
2. ご利用のアプリケーションが (以前の) レプリカを指すように設定する<br/>
   各サーバーには一意の接続文字列があります。 マスターではなく、(以前の) レプリカを指定するように、アプリケーションを更新します。
    
ご利用のアプリケーションで読み取りと書き込みが正常に処理されると、フェールオーバーが完了します。 アプリケーションで経験するダウンタイムは、問題を検出し、上記の手順 1 と 2 を完了したタイミングによって異なります。


## <a name="considerations"></a>考慮事項

このセクションでは、読み取りレプリカ機能に関する考慮事項をまとめています。

### <a name="prerequisites"></a>前提条件
読み取りレプリカと[論理デコード](concepts-logical.md)はどちらも、情報を Postgres 書き込み先行ログ (WAL) に依存しています。 これらの 2 つの機能には、Postgres とは異なるレベルのログが必要です。 論理デコードには、読み取りレプリカよりも高いレベルのログが必要です。

適切なレベルのログを構成するには、Azure レプリケーション サポート パラメーターを使用します。 Azure レプリケーション サポートには、次の 3 つの設定オプションがあります。

* **オフ** - 最小限の情報を WAL に格納します。 この設定は、ほとんどの Azure Database for PostgreSQL サーバーでは使用できません。  
* **レプリカ** - **[オフ]** よりも冗長です。 これは、[読み取りレプリカ](concepts-read-replicas.md)を機能させるために必要な最小レベルのログです。 ほとんどのサーバーでは、この設定が既定値です。
* **論理** - **[レプリカ]** よりも冗長です。 これは、論理デコードを機能させるための最小レベルのログです。 読み取りレプリカはこの設定でも機能します。

このパラメーターを変更した後、サーバーを再起動する必要があります。 内部的には、このパラメーターによって、Postgres のパラメーター `wal_level`、`max_replication_slots`、および `max_wal_senders` が設定されます。

### <a name="new-replicas"></a>新しいレプリカ
読み取りレプリカは、新しい Azure Database for PostgreSQL サーバーとして作成されます。 既存のサーバーをレプリカにすることはできません。 別の読み取りレプリカのレプリカを作成することはできません。

### <a name="replica-configuration"></a>レプリカ構成
レプリカは、マスターと同じコンピューティングとストレージの設定を使用して作成されます。 レプリカの作成後、ストレージやバックアップの保持期間など、いくつかの設定を変更できます。

ファイアウォール規則、仮想ネットワーク規則、パラメーター設定は、レプリカの作成後、マスター サーバーからレプリカに継承されることはありません。

### <a name="scaling"></a>Scaling
仮想コアのスケーリングまたは汎用とメモリ最適化の間のスケーリング。
* PostgreSQL では、セカンダリ サーバー上の `max_connections` の設定が、[プライマリ サーバー上の設定以上](https://www.postgresql.org/docs/current/hot-standby.html)であることが要求されます。それ以外の場合、セカンダリ サーバーは起動しません。
* Azure Database for PostgreSQL では、接続にメモリが使用されるため、各サーバーで許可される最大接続数はコンピューティング sku に固定されます。 [max_connections とコンピューティング sku のマッピング](concepts-limits.md)の詳細について確認してください。
* **スケールアップ**: まず、レプリカのコンピューティングをスケールアップしてから、プライマリをスケールアップします。 この順序により、エラーが発生して `max_connections` 要件に違反するのを防ぎます。
* **スケールダウン**: まず、プライマリのコンピューティングをスケールダウンしてから、レプリカをスケールダウンします。 プライマリよりも低いレプリカをスケーリングしようとすると、エラーが発生します。これは `max_connections` 要件に違反するためです。

ストレージのスケーリング:
* すべてのレプリカで、ストレージ全体のレプリカからのレプリケーションの問題を防ぐために、ストレージの自動拡張が有効になっています。 この設定を無効にすることはできません。
* 他のサーバーの場合と同様に、ストレージを手動でスケールアップすることもできます。


### <a name="basic-tier"></a>Basic レベル
Basic レベルのサーバーは、同じリージョンのレプリケーションのみをサポートしています。

### <a name="max_prepared_transactions"></a>max_prepared_transactions
読み取りレプリカの `max_prepared_transactions` パラメーターの値をマスターの値以上にすることが [PostgreSQL では必要](https://www.postgresql.org/docs/current/runtime-config-resource.html#GUC-MAX-PREPARED-TRANSACTIONS)です。そうしないと、レプリカが起動しません。 マスターで `max_prepared_transactions` を変更する場合、まずレプリカで変更します。

### <a name="stopped-replicas"></a>停止されたレプリカ
マスター サーバーと読み取りレプリカの間のレプリケーションを停止した場合、変更を適用するためにレプリカが再起動されます。 停止したレプリカは、読み取りと書き込みの両方を受け入れるスタンドアロン サーバーになります。 スタンドアロン サーバーをもう一度レプリカにすることはできません。

### <a name="deleted-master-and-standalone-servers"></a>削除されたマスターおよびスタンドアロン サーバー
マスター サーバーを削除すると、そのすべての読み取りレプリカがスタンドアロン サーバーになります。 この変更を反映するため、レプリカは再起動されます。

## <a name="next-steps"></a>次のステップ
* [Azure portal で読み取りレプリカを作成および管理する](howto-read-replicas-portal.md)方法を確認する。
* [Azure CLI と REST API で読み取りレプリカの作成と管理](howto-read-replicas-cli.md)を行う方法について確認してください。
