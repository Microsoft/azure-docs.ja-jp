---
title: "アプリを Azure Virtual Network に統合する"
description: "Azure App Service のアプリを新規または既存の Azure 仮想ネットワークに接続する方法を説明します。"
services: app-service
documentationcenter: 
author: ccompy
manager: erikre
editor: cephalin
ms.assetid: 90bc6ec6-133d-4d87-a867-fcf77da75f5a
ms.service: app-service
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 08/23/2017
ms.author: ccompy
ms.translationtype: HT
ms.sourcegitcommit: 5b6c261c3439e33f4d16750e73618c72db4bcd7d
ms.openlocfilehash: 61508f759cad92a8c17d72a5d68fb54994c393bc
ms.contentlocale: ja-jp
ms.lasthandoff: 08/28/2017

---
# <a name="integrate-your-app-with-an-azure-virtual-network"></a>アプリを Azure 仮想ネットワークに統合する
このドキュメントでは、Azure App Service の仮想ネットワーク統合機能について説明し、この機能を [Azure App Service](http://go.microsoft.com/fwlink/?LinkId=529714) でアプリと共にセットアップする方法を示します。 Azure 仮想ネットワーク (VNet) とは、Azure リソースの多くをインターネット以外のルーティング可能なネットワークに配置できる機能です。配置先のネットワークへのアクセスは制御できます。 これらのネットワークは、さまざまな VPN テクノロジを使用して、オンプレミスのネットワークに接続できます。 Azure Virtual Network の詳細については、まず [Azure Virtual Network の概要][VNETOverview]に関するページに記載されている情報をご覧ください。 

Azure App Service には、2 つの形式があります。 

1. すべての価格プランをサポートするマルチテナント システム
2. VNet にデプロイされる App Service Environment (ASE) の Premium 機能 

このドキュメントは、VNet 統合について説明します (App Service 環境については説明しません)。 ASE 機能について詳しく学ぶには、最初にこちらの [App Service 環境の概要][ASEintro]の情報を参照してください。

VNet 統合により、Web アプリから仮想ネットワーク内のリソースにアクセスできるようになるものの、仮想ネットワークからその Web アプリへのプライベート アクセスは付与されません。 プライベート サイト アクセスとは、Azure 仮想ネットワークなどプライベート ネットワークのみからアプリにアクセスできるようにすることです。 プライベート サイトには、内部ロード バランサー (ILB) を使用して ASE が構成されている場合のみアクセスできます。 ILB ASE の使用方法について詳しくは、最初にこちらの [ILB ASE の作成と使用][ILBASE]に関する記事を参照してください。 

VNet 統合を使用する一般的なシナリオは、Azure 仮想ネットワーク内の仮想マシンで実行されているデータベースまたは Web サービスに Web アプリからアクセスできるようにすることです。 VNet 統合を使用すれば、VM 上のアプリケーション用にパブリック エンドポイントを公開せずに済み、インターネット以外のルーティング可能なプライベート アドレスを使用できます。 

以下は、VNet 統合機能の特徴です。

* Standard、Premium または Isolated いずれかの価格プランが必要 
* Classic VNet または Resource Manager VNet に対応 
* TCP と UDP をサポート
* Web アプリ、モバイル アプリ、API アプリに対応
* アプリが一度に接続できるのは 1 つの VNet のみ
* App Service プランでは、最大 5 つの VNet と統合可能 
* App Service プランでは、複数のアプリで同じ VNet を使用可能
* VNet ゲートウェイ上の SLA のため、99.9% の SLA をサポート

以下は、VNet 統合でサポートされていない機能の例です。

* ドライブのマウント
* AD 統合 
* NetBIOS
* プライベート サイトへのアクセス

### <a name="getting-started"></a>使用の開始
ここでは、Web アプリを仮想ネットワークに接続する前に考慮する必要がある点について説明します。

* VNet 統合は、**Standard**、**Premium** または **Isolated**価格プランでのみ、アプリで使用できます。 この機能を有効にした後で、App Service プランをサポートされていない価格プランに変更すると、使用している VNet にアプリから接続できなくなります。 
* ターゲットの仮想ネットワークが既に存在している場合は、そのネットワークで動的ルーティング ゲートウェイによるポイント対サイト VPN が有効になっていないと、アプリに接続できません。 静的ルーティング ゲートウェイが構成されている場合は、ポイント対サイト仮想プライベート ネットワーク (VPN) を有効にすることはできません。
* VNet は、App Service プラン (ASP) と同じサブスクリプションにする必要があります。 
* VNet と統合されるアプリケーションでは、その VNet に対して指定されている DNS を使用します。
* 既定では、統合されるアプリは、VNet で定義されているルートに基づいて、その VNet にのみトラフィックをルーティングします。 

## <a name="enabling-vnet-integration"></a>VNet 統合の有効化
このドキュメントは、主に VNet 統合での Azure Portal の使用について説明します。 PowerShell を使用してアプリで VNet 統合を有効にするには、「[PowerShell を使ってアプリを仮想ネットワークに接続する][IntPowershell]」の指示に従います。

アプリの接続先には、新しい仮想ネットワークまたは既存の仮想ネットワークのオプションがあります。 新しいネットワークを統合の一部として作成すると、VNet が作成されるだけでなく、動的ルーティング ゲートウェイが自動的に事前構成され、ポイント対サイト VPN が有効になります。 

> [!NOTE]
> 新しい仮想ネットワーク統合の構成には、数分かかる場合があります。 
> 
> 

VNet 統合を有効にするには、アプリの [設定] を開き、[ネットワーク] を選択します。 開いた UI では、ネットワークに関する選択肢が 3 つあります。 このガイドでは、VNet 統合のみを取り上げます。ハイブリッド接続と App Service Environment については、このドキュメントの後の部分で説明します。 

アプリの価格プランが適切ではない場合は、この UI を使用して、ご希望の上位の価格プランに変更することができます。

![][1]

### <a name="enabling-vnet-integration-with-a-pre-existing-vnet"></a>既存の VNet での VNet 統合の有効化
VNet 統合 UI では、VNet を一覧から選択することができます。 クラシック VNet については、VNet 名の横に "クラシック" という単語がかっこ付きで示されることから、クラシック VNet であることがわかります。 この一覧は、Resource Manager VNet が先に表示されるように並べ替えられます。 以下に示す画像からは、選択できる VNet は 1 つだけであることがわかります。 VNet が灰色で表示される理由はさまざまです。

* 自分のアカウントからアクセスできる別のサブスクリプションに VNet が含まれている
* VNet でポイント対サイトが有効になっていない
* VNet に動的ルーティング ゲートウェイがない

![][2]

統合を有効にするには、統合先の VNet をクリックします。 VNet の選択後、アプリが自動的に再開されて、変更が有効になります。 

##### <a name="enable-point-to-site-in-a-classic-vnet"></a>クラシック VNet でのポイント対サイトの有効化
VNet にゲートウェイとポイント対サイトのどちらもない場合は、最初にそれらをセットアップする必要があります。 クラシック VNet についてこれを行うには、[Azure Portal][AzurePortal] に移動し、[仮想ネットワーク (クラシック)] の一覧を表示します。 ここで、統合先のネットワークをクリックし、[要点] の下にある [VPN 接続] という大きなボックスをクリックします。 ここから、ポイント対サイト VPN を作成できます。それを通じてゲートウェイを作成することも可能です。 ポイント対サイトを使用してゲートウェイを作成する操作を終えると、約 30 分後にゲートウェイの準備が整います。 

![][8]

##### <a name="enabling-point-to-site-in-a-resource-manager-vnet"></a>Resource Manager VNet でのポイント対サイトの有効化
Resource Manager VNet をゲートウェイとポイント対サイトで構成するには、「[PowerShell を使用した VNet へのポイント対サイト接続の構成][V2VNETP2S]」に従って PowerShell を使用するか、「[Azure Portal を使用した VNet へのポイント対サイト接続の構成][V2VNETPortal]」に従って Azure Portal を使用します。 この機能のための UI はまだ利用できません。 ポイント対サイト構成の場合は証明書を作成する必要がないことに注意してください。 WebApp を VNet に接続すると自動的に構成されます。 

### <a name="creating-a-pre-configured-vnet"></a>事前構成された VNet の作成
ゲートウェイとポイント対サイトが構成された新しい VNet は App Service のネットワーク UI を使って作成できますが、この機能は Resource Manager VNet にしか対応していません。 ゲートウェイとポイント対サイトが構成されたクラシック VNet を作成する場合は、ネットワーク ユーザー インターフェイスから手動で行う必要があります。 

VNet 統合 UI で Resource Manager VNet を作成するには、 **[新しい仮想ネットワークの作成]** を選択して以下の情報を指定します。

* 仮想ネットワーク名
* 仮想ネットワーク アドレス ブロック
* サブネット名
* サブネット アドレス ブロック
* ゲートウェイ アドレス ブロック
* ポイント対サイト アドレス ブロック

この VNet を他の任意のネットワークに接続する場合は、そのネットワークと重複する IP アドレス空間を選択しないようにしてください。 

> [!NOTE]
> ゲートウェイが構成された Resource Manager VNet の作成には、約 30 分かかります。現時点では、この作業によって VNet とアプリが統合されることはありません。 ゲートウェイが構成された VNet の作成後に、アプリの VNet 統合 UI に戻って新しい VNet を選択する必要があります。
> 
> 

![][3]

通常、Azure VNet はプライベート ネットワーク アドレスに作成されます。 既定では、VNet 統合機能は、これらの IP アドレスの範囲を宛先としたすべてのトラフィックを VNet にルーティングします。 プライベート IP アドレスの範囲は次のとおりです。

* 10.0.0.0/8 - これは、10.0.0.0 ～ 10.255.255.255 と同じです。
* 172.16.0.0/12 - これは、172.16.0.0 ～ 172.31.255.255 と同じです。 
* 192.168.0.0/16 - これは、192.168.0.0 ～ 192.168.255.255 と同じです。

VNet アドレス空間は、CIDR 表記法で指定する必要があります。 CIDR 表記法とは、IP アドレスと、ネットワーク マスクを表す整数を使用して、アドレス ブロックを指定する方法です。 10.1.0.0/24 は 256 個のアドレス、10.1.0.0/25 は 128 個のアドレスを使用できると覚えておくと、簡単です。 /32 を含む IPv4 アドレスでは、使用できるアドレスが 1 つになります。 

ここで DNS サーバーの情報を設定すると、その情報は VNet に対して設定されます。 VNet の作成後に、VNet のユーザー操作によりこの情報を編集できます。 VNet の DNS を変更する場合は、ネットワーク同期操作を実行する必要があります。

VNet 統合の UI を使用してクラシック VNet を作成すると、アプリと同じリソース グループに VNet が作成されます。 

## <a name="how-the-system-works"></a>システムの動作
実際には、この機能はポイント対サイト VPN テクノロジを基盤として構築されており、それを通じてアプリは VNet に接続されます。 Azure App Service のアプリはマルチテナントのシステム アーキテクチャとなっており、仮想マシンを使用する場合とは違い、アプリを VNet に直接プロビジョニングできません。 ポイント対サイト テクノロジを基盤として構築することにより、アプリをホストする仮想マシンだけにネットワークでアクセスできるようにしています。 それらのアプリ ホスト上ではネットワークへのアクセスがさらに制限され、アプリは、アクセス先として構成されたネットワークにしかアクセスできません。 

![][4]

仮想ネットワークで DNS サーバーを設定していない場合、アプリは VNet の各リソースにアクセスするために IP アドレスを使用する必要があります。 IP アドレスを使用する場合は、この機能の主なメリットが、プライベート ネットワーク内でプライベート アドレスを使用できる点にあることに注意してください。 いずれかの VM のパブリック IP アドレスを使用するようにアプリをセットアップすると、VNet 統合機能を使用せずに、インターネットを介して通信することになります。

## <a name="managing-the-vnet-integrations"></a>VNet 統合の管理
VNet への接続と、VNet との接続の切断は、アプリ レベルの機能です。 複数のアプリをまたいで VNet 統合に影響する可能性がある操作は、ASP レベルで行われます。 アプリ レベルで表示される UI で、VNet の詳細を確認できます。 それと同じ情報のほとんどは、ASP レベルでも確認できます。 

![][5]

[ネットワーク機能の状態] ページで、アプリが VNet に接続されているかどうかを確認できます。 何らかの理由で VNet ゲートウェイがダウンしている場合は、[接続されていません] と表示されます。 

アプリケーション レベルの VNet 統合の UI では、ASP から得られる詳細情報と同じ情報を確認できるようになりました。 それらの項目を次に示します。

* VNet 名 - このリンクをクリックすると、Azure 仮想ネットワークの UI が開きます。
* 場所 - VNet の場所を表します。 これは別の場所の VNet と統合できます。
* 証明書の状態 - アプリと VNet の間の VPN 接続をセキュリティで保護するために、証明書が使用されています。 これには、証明書が同期されていることを確認するテストの結果が反映されます。
* ゲートウェイの状態 - 何らかの理由でゲートウェイがダウンすると、アプリは VNet 内のリソースにアクセスできなくなります。 
* VNet アドレス空間 - VNet の IP アドレス空間です。 
* ポイント対サイト アドレス空間 - VNet のポイント対サイト IP アドレス空間です。 アプリでは、通信は、このアドレス空間内のいずれかの IP アドレスから発信されているものとして示されます。 
* サイト対サイト アドレス空間 - サイト間 VPN を使用して、VNet をオンプレミスのリソースまたは他の VNet に接続できます。 これを構成してある場合は、その VPN 接続で定義されている IP の範囲がここに表示されます。
* DNS サーバー - VNet で DNS サーバーを構成してある場合は、DNS サーバーがここに一覧表示されます。
* VNet にルーティングされる IP - VNet へのルーティングが定義されている IP アドレスの一覧です。これらのアドレスがここに表示されます。 

VNet 統合のアプリ ビューで実行できる操作は、現在接続されている VNet からアプリを切断する操作のみです。 この操作は、上部にある [切断] をクリックするだけで実行できます。 この操作によって VNet が変更されることはありません。 VNet とその構成 (ゲートウェイなど) は、元の状態のまま維持されます。 後に VNet を削除する必要が生じた場合は、その VNet に含まれるゲートウェイなどのリソースを最初に削除する必要があります。 

App Service プランのビューでは、他にもさまざまな操作を実行できます。 このビューには、アプリからアクセスする場合とは異なる方法でもアクセスできます。 ASP ネットワーク UI にアクセスするには、ASP UI を開いて下へスクロールします。 [ネットワーク機能の状態] という UI の要素が見つかります。 ここに、VNet 統合についての細かい情報が表示されます。 この UI をクリックすると、[ネットワーク機能の状態] という UI が開きます。 [ここをクリックして管理] をクリックすると、この ASP の VNet 統合を一覧表示する UI が開きます。

![][6]

ASP の場所を覚えておくと、統合先の VNet の場所を調べるときに役立ちます。 VNet が別の場所にある場合は、待機時間の問題が発生する可能性がはるかに高くなります。 

[統合した VNet] では、この ASP でアプリが統合された VNET の数と、統合できる VNet の数を確認できます。 

各 VNet の詳細をさらに表示するには、対象の VNet をクリックします。 前に説明した詳細のほか、この ASP でその VNet を使用しているアプリの一覧も表示されます。 

実行できる主な操作は 2 つあります。 1 つ目は、アプリから VNet に向かうトラフィックのルートを追加する操作です。 2 つ目は、証明書とネットワーク情報を同期する操作です。

![][7]

**ルーティング** 前に説明したとおり、VNet に定義されたルートは、アプリから VNet にトラフィックを転送するために使用されます。 ただし、お客様がさらに別の送信トラフィックをアプリから VNet に送信するケースもあるため、この機能が用意されています。 この操作を行った後のトラフィックの動きは、お客様による VNet の構成方法によって変わります。 

**証明書** [証明書の状態] には、App Service によって実行されるチェックの結果が反映されます。このチェックでは、VPN 接続に使用している証明書が現在も有効であるかどうかが検証されます。 VNet 統合が有効になっている状態で、この ASP で任意のアプリからその VNet と初めて統合する場合は、接続のセキュリティを確保するために、証明書の交換が必要となります。 証明書と共に、DNS の構成やルートなど、ネットワークに関するその他の同様の情報を取得できます。
これらの証明書またはネットワーク情報が変更された場合は、[ネットワークの同期] をクリックする必要があります。 **注**: [ネットワークの同期] をクリックすると、アプリと VNet の間の接続が短時間途切れます。 アプリの再起動が行われない場合は、接続が途切れることで、サイトが正常に機能しなくなる可能性があります。 

## <a name="accessing-on-premises-resources"></a>オンプレミスのリソースへのアクセス
VNet 統合機能のメリットの 1 つとして、VNet がオンプレミスのネットワークにサイト間 VPN で接続されている場合に、アプリからオンプレミスのリソースにアクセスできることが挙げられます。 ただし、そのためには、ポイント対サイト IP の範囲へのルートでオンプレミスの VPN ゲートウェイを更新しなければならない場合があります。 サイト間 VPN を初めてセットアップするときには、その構成に使用するスクリプトにより、ポイント対サイト VPN などのルートをセットアップする必要があります。 サイト間 VPN を作成した後にポイント対サイト VPN を追加した場合は、ルートを手動で更新する必要があります。 その詳しい手順はゲートウェイごとに異なるため、ここでは取り上げません。 

> [!NOTE]
> VNet 統合機能では、アプリと ExpressRoute ゲートウェイを使う VNet は統合されません。 ExpressRoute ゲートウェイが[共存モード][VPNERCoex]で構成されている場合であっても、VNet 統合は機能しません。 ExpressRoute 接続を通してリソースにアクセスする必要がある場合は、VNet で実行する [App Service 環境][ASE]を使うことができます。
> 
> 

## <a name="pricing-details"></a>価格の詳細
VNet 統合機能を使用する際には、価格に関して、いくつかの細かな違いに注意する必要があります。 この機能を使用する場合に関係するのは、次の 3 種類の料金です。

* ASP の価格レベルの要件
* データ転送コスト
* VPN Gateway のコスト

アプリでこの機能を使用できるようにするには、アプリを Standard または Premium の App Service プランの対象にする必要があります。 これらのコストの詳細については、「[App Service の価格][ASPricing]」を参照してください。 

ポイント対サイト VPN が処理されるしくみにより、VNet 統合接続を経由する送信データには必ず料金が発生します。これは、VNet が同じデータ センターにある場合でも当てはまります。 発生する料金については、[データ転送の価格の詳細][DataPricing]に関するページを参照してください。 

最後の項目は、VNet ゲートウェイのコストです。 サイト間 VPN など、他の用途でゲートウェイを使う必要がない場合、VNet 統合機能をサポートするためにゲートウェイの料金が発生します。 これらのコストの詳細については、「[VPN Gateway の価格][VNETPricing]」を参照してください。 

## <a name="troubleshooting"></a>トラブルシューティング
この機能は簡単にセットアップできるものの、問題が発生しないわけではありません。 目的のエンドポイントへのアクセスに関して問題が発生した場合は、アプリのコンソールからの接続テストに、いくつかのユーティリティを利用できます。 役に立つ 2 つのコンソール機能があります。 1 つは Kudu コンソールで、もう 1 つは Azure Portal でアクセスできるコンソールです。 アプリから Kudu コンソールにアクセスするには、[ツール]、[Kudu] の順に移動します。 これは [サイト名].scm.azurewebsites.net に移動するのと同じです。 コンソールが開いたら、その [デバッグ] タブに移動します。Azure ポータルにホストされたコンソールにアクセスするには、アプリで [ツール]、[コンソール] の順に移動します。 

#### <a name="tools"></a>ツール
ping、nslookup、tracert の各ツールは、セキュリティの制約により、コンソールから使用することはできません。 それを補うために、2 つの独立したツールが追加されています。 DNS 機能のテスト用に、nameresolver.exe という名前のツールを追加しました。 の構文は次のとおりです。

    nameresolver.exe hostname [optional: DNS Server]

nameresolver を使用すると、アプリが依存しているホスト名を確認できます。 この方法で、DNS の構成に誤りがあるかどうかや、DNS サーバーへのアクセス権がないかどうかをテストできます。

次のツールでは、ホストとポートを組み合わせたものへの TCP 接続をテストすることができます。 このツールは tcpping.exe という名前で、構文は次のとおりです。

    tcpping.exe hostname [optional: port]

tcpping ユーティリティを使用すると、特定のホストとポートにアクセスできるかどうかがわかります。 成功として示されるのは、ホストとポートの組み合わせでリッスンしているアプリケーションがあり、アプリから指定のホストとポートへのネットワーク アクセスがある場合のみです。

#### <a name="debugging-access-to-vnet-hosted-resources"></a>VNet にホストされたリソースへのアクセスのデバッグ
アプリから特定のホストとポートへのアクセスは、さまざまな要因によって妨げられる可能性があります。 ほとんどの場合、次の 3 つのうちのいずれかです。

* **ファイアウォールが邪魔をしている**: ファイアウォールが邪魔をしている場合、TCP タイムアウトが発生します。 この場合は 21 秒です。 tcpping ツールを使用して接続をテストします。 TCP タイムアウトの原因は、ファイアウォール以外にさまざまなことが考えられますが、まずここから始めます。 
* **DNS にアクセスできない**: DNS タイムアウトは、DNS サーバーごとに 3 秒です。 2 つの DNS サーバーがある場合、タイムアウトは 6 秒です。 nameresolver を使用して、DNS が機能しているかどうかを確認します。 VNet の構成に使用されている DNS を使用しなければ nslookup を使用することはできませんのでご注意ください。
* **無効な P2S IP 範囲**: ポイント対サイト IP 範囲は、RFC 1918 プライベート IP 範囲 (10.0.0.0-10.255.255.255 / 172.16.0.0-172.31.255.255 / 192.168.0.0-192.168.255.255) に含まれる必要があります。 範囲で使用される IP がこれら以外の場合は、機能しません。 

以上の内容で問題を解決できない場合は、最初に次のような単純な点を確認してください。 

* ゲートウェイはポータルに稼働中と表示されているか。
* 証明書は同期していると表示されているか。
* 影響を受ける ASP で "ネットワークの同期" を行わずにネットワーク構成が変更されたか。 

ゲートウェイがダウンしている場合は、再起動してください。 証明書が同期されていない場合は、VNet 統合の ASP ビューに移動し、[ネットワークの同期] をクリックします。 VNet の構成が変更された可能性があり、ASP と同期されていないと考えられる場合は、VNet 統合の ASP ビューに移動し、[ネットワークの同期] をクリックします。その際、VNet とアプリの間の接続が短時間途切れることに注意してください。 

これらすべてに問題がない場合は、もう少し詳しく調べる必要があります。

* VNet 統合を使用して同じ VNet 内のリソースにアクセスするアプリが他にないか。 
* アプリのコンソールに移動し、tcpping を使用して VNet 内の他のリソースに到達できるか。 

上記のどちらかに到達できる場合は、その VNet 統合は正常で、問題は別の場所で発生しています。 このような状況になると、ホスト:ポートに到達できない理由を簡単に確認する手段がないため、究明は難しくなります。 以下に原因の例を示します。

* ホスト上で稼働しているファイアウォールが、ポイント対サイト IP の範囲からアプリケーション ポートへのアクセスを妨げている。 サブネットの境界を越えるには、多くの場合パブリック アクセスが必要になります。
* ターゲット ホストがダウンしている
* アプリケーションがダウンしている
* IP またはホスト名が誤っている
* アプリケーションが予期しないポートでリッスンしている。 このことを確認するには、そのホストに移動して、コマンド プロンプトで "netstat -aon" を使用します。 これによって、どのプロセス ID がどのポートでリッスンしているかを確認できます。 
* ネットワーク セキュリティ グループが、ポイント対サイト IP の範囲からアプリケーション ホストとポートへのアクセスをブロックするように構成されている

ポイント対サイト IP の範囲にある IP のうち、どれをアプリが使用するのかはわからないため、IP 範囲全体からのアクセスを許可する必要があります。 

追加のデバッグ手順は次のとおりです。

* VNet 内の別の VM にログオンし、そこからリソースのホスト:ポートへのアクセスを試します。 この目的で使用できる TCP ping ユーティリティもあるほか、必要な場合には telnet も使用できます。 ここでの目的は、他の VM からの接続が正常かどうかを判断することだけです。 
* 別の VM 上で任意のアプリケーションを起動し、アプリのコンソールから、そのホストとポートにアクセスできるかどうかをテストします。

#### <a name="on-premises-resources"></a>オンプレミスのリソース ####
アプリがオンプレミスのリソースにアクセスできない場合は、まず VNet 内のリソースにアクセスできるかどうかを確認してください。 アクセスできる場合は、VNet 内の VM からオンプレミスのアプリケーションへのアクセスを試す必要があります。 telnet または TCP ping ユーティリティを使用できます。 VM がオンプレミスのリソースにアクセスできない場合は、サイト間 VPN 接続が機能していることを確認してください。 機能している場合は、前に説明したのと同じ内容と、オンプレミス ゲートウェイの構成および状態を確認します。 

VNet でホストされている VM はオンプレミス システムに到達でき、アプリは到達できない場合、次のいずれかが原因と考えられます。

* オンプレミスのゲートウェイで、ルートがポイント対サイト IP 範囲で構成されていない。
* ネットワーク セキュリティ グループが、ポイント対サイト IP 範囲へのアクセスをブロックしている。
* オンプレミスのファイアウォールが、ポイント対サイト IP 範囲からのトラフィックをブロックしている。
* VNet 内のユーザー定義ルート (UDR) により、ポイント対サイト ベースのトラフィックがオンプレミス ネットワークに到達できなくなっている。

## <a name="hybrid-connections-and-app-service-environments"></a>ハイブリッド接続と App Service Environment
VNet にホストされているリソースへのアクセスを実現する、3 つの機能があります。 次に例を示します。

* VNet 統合
* Hybrid Connections
* App Service Environment

ハイブリッド接続を利用する場合は、ハイブリッド接続マネージャー (HCM) と呼ばれるリレー エージェントをネットワークにインストールする必要があります。 HCM は、Azure のほか、アプリケーションにも接続できなければなりません。 このソリューションは、インターネットにアクセス可能なエンドポイントが必要ないことから、オンプレミスのネットワークのほか、ホストされたクラウド ネットワークなどのリモート ネットワークで特に効果を発揮します。 HCM は、Windows 上でのみ動作し、最大 5 つのインスタンスを実行して高可用性を実現できます。 ただし、ハイブリッド接続でサポートされるのは TCP だけです。各エンドポイントは、特定のホスト:ポートの組み合わせと一致している必要があります。 

App Service Environment 機能を使用すると、VNet で Azure App Service のインスタンスを実行できます。 そのため、追加の作業を行わなくても、アプリは VNet 内のリソースにアクセスできます。 App Service Environment のその他のメリットとして、最大 14 GB の RAM を備えた Dv2 ベースのワーカーを使用できることなどが挙げられます。 また、ニーズを満たすためにシステムのスケールを変更できるというメリットもあります。 ASP が 20 インスタンスまでに制限されるマルチテナント環境とは異なり、ASE では 100 個まで ASP インスタンスをスケールアップできます。 VNet 統合にはない ASE の特長の 1 つに、App Service Environment が ExpressRoute VPN と共に使用できることがあります。 

共通する利用例はあるものの、これらの機能はいずれも互いに置き換え可能ではありません。 どの機能を使用するかは、ご自分のニーズと結び付いています。 For example:

* 開発者が Azure でサイトを実行して、机の下にあるワークステーション上のデータベースにそのサイトからアクセスできるようにするだけであれば、ハイブリッド接続を使用するのが最も簡単な方法です。 
* 大規模な組織がパブリック クラウドに多数の Web プロパティを配置し、独自のネットワークで管理する必要がある場合は、App Service Environment を使用できます。 
* App Service によってホストされるアプリが数多くあり、VNet 内のリソースにアクセスするだけであれば、VNet 統合をお勧めします。 

こうした使用事例だけでなく、シンプルさに関連する側面にも違いがあります。 VNet が既にオンプレミスのネットワークに接続されている場合は、VNet 統合または App Service Environment を使用すると、オンプレミスのリソースを簡単に利用できます。 一方、VNet がオンプレミスのネットワークに接続されていない場合は、VNet とサイト間 VPN の設定には、HCM をインストールする場合に比べて、はるかに多くのオーバーヘッドが伴います。 

機能だけではなく、価格にも違いがあります。 App Service Environment の機能は、Premium サービスによって提供されますが、その内容には、考えられるほとんどのネットワーク構成と、その他の優れた機能が含まれます。 VNet 統合は Standard または Premium ASP で利用可能であり、マルチテナントの App Service から VNet 内のリソースを安全に利用する場合に最適です。 ハイブリッド接続を利用するには、現時点では BizTalk アカウントが必要です。これには複数の価格レベルが用意されており、無料で開始した後に、必要量に基づいて段階的に上位の価格レベルに移行できます。 ただし、多数のネットワークが存在する環境で運用する場合には、ハイブリッド接続ほど適した機能はありません。ハイブリッド接続では、100 をはるかに超える独立したネットワークのリソースにアクセスすることができます。 

<!--Image references-->
[1]: ./media/web-sites-integrate-with-vnet/vnetint-upgradeplan.png
[2]: ./media/web-sites-integrate-with-vnet/vnetint-existingvnet.png
[3]: ./media/web-sites-integrate-with-vnet/vnetint-createvnet.png
[4]: ./media/web-sites-integrate-with-vnet/vnetint-howitworks.png
[5]: ./media/web-sites-integrate-with-vnet/vnetint-appmanage.png
[6]: ./media/web-sites-integrate-with-vnet/vnetint-aspmanage.png
[7]: ./media/web-sites-integrate-with-vnet/vnetint-aspmanagedetail.png
[8]: ./media/web-sites-integrate-with-vnet/vnetint-vnetp2s.png

<!--Links-->
[VNETOverview]: http://azure.microsoft.com/documentation/articles/virtual-networks-overview/ 
[AzurePortal]: http://portal.azure.com/
[ASPricing]: http://azure.microsoft.com/pricing/details/app-service/
[VNETPricing]: http://azure.microsoft.com/pricing/details/vpn-gateway/
[DataPricing]: http://azure.microsoft.com/pricing/details/data-transfers/
[V2VNETP2S]: http://azure.microsoft.com/documentation/articles/vpn-gateway-howto-point-to-site-rm-ps/
[IntPowershell]: http://azure.microsoft.com/documentation/articles/app-service-vnet-integration-powershell/
[ASEintro]: http://docs.microsoft.com/azure/app-service/app-service-environment/intro
[ILBASE]: http://docs.microsoft.com/azure/app-service/app-service-environment/create-ilb-ase
[V2VNETPortal]: https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal
[VPNERCoex]: http://docs.microsoft.com/en-us/azure/expressroute/expressroute-howto-coexist-resource-manager
[ASE]: http://docs.microsoft.com/azure/app-service/app-service-environment/intro

