---
title: パケット キャプチャを管理する - Azure portal
titleSuffix: Azure Network Watcher
description: Azure portal を使って Network Watcher のパケット キャプチャ機能を管理する方法を説明します。
services: network-watcher
documentationcenter: na
author: damendo
ms.service: network-watcher
ms.devlang: na
ms.topic: how-to
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 09/10/2018
ms.author: damendo
ms.openlocfilehash: 28d5ae1451b97c19576baa3f9760b8f784db3175
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/02/2020
ms.locfileid: "84736732"
---
# <a name="manage-packet-captures-with-azure-network-watcher-using-the-portal"></a>ポータルを使用して Azure Network Watcher でパケット キャプチャを管理する

Network Watcher のパケット キャプチャを使用すると、仮想マシンとの間で送受信されるトラフィックを追跡するキャプチャ セッションを作成できます。 必要なトラフィックのみを確実にキャプチャするためにキャプチャ セッション用のフィルターが用意されています。 パケット キャプチャは、事後と事前、どちらの場合でもネットワークの異常を診断するのに役立ちます。 その他の用途には、ネットワーク統計の収集や、ネットワークへの侵入に関する情報の取得などがあり、クライアントとサーバー間の通信のデバッグなどに役立ちます。 パケット キャプチャをリモートでトリガーできることで、目的の仮想マシンでパケット キャプチャを手動で実行する負担が軽減されて、貴重な時間の節約になります。

この記事では、パケット キャプチャを開始、停止、ダウンロード、および削除することについて説明します。 

## <a name="before-you-begin"></a>開始する前に

パケット キャプチャには、次の送信 TCP 接続が必要です。
- ポート 443 を経由する、選択したストレージ アカウントへの接続
- ポート 80 を経由する 169.254.169.254 への接続
- ポート 8037 を経由する 168.63.129.16 への接続

> [!NOTE]
> 上記の後者の 2 つのケースに示されているポートは、Network Watcher 拡張機能を含むすべての Network Watcher 機能で共通であり、随時変更される可能性があります。


ネットワーク セキュリティ グループが、ネットワーク インターフェイス、またはネットワーク インターフェイスが含まれるサブネットに関連付けられている場合は、前述のポートを許可するルールが存在することを確認します。 同様に、ユーザー定義のトラフィック ルートをネットワークに追加すると、前述の IP とポートに接続できなくなる可能性があります。 それらが到達可能であることを確認してください。 

## <a name="start-a-packet-capture"></a>パケット キャプチャを開始する

1. ブラウザーで [Azure portal](https://portal.azure.com) に移動し、 **[すべてのサービス]** を選択してから、 **[ネットワーク] セクション**で **[Network Watcher]** を選択します。
2. **[ネットワーク診断ツール]** で、 **[Packet capture]\(パケット キャプチャ)** を選択します。 状態を問わず、既存のパケット キャプチャがすべて一覧表示されます。
3. **[追加]** を選択してパケット キャプチャを作成します。 以下のプロパティの値を選択できます。
   - **サブスクリプション**:パケット キャプチャの作成対象となる仮想マシンが属しているサブスクリプション。
   - **[リソース グループ]** :仮想マシンのリソース グループ。
   - **[ターゲット仮想マシン]** : パケット キャプチャの作成対象となる仮想マシン。
   - **[パケット キャプチャ名]** : パケット キャプチャの名前。
   - **[ストレージ アカウント] または [ファイル]** : **[ストレージ アカウント]** 、 **[ファイル]** 、またはその両方を選択します。 **[ファイル]** を選択した場合、キャプチャは仮想マシン内のパスに書き込まれます。
   - **[ローカル ファイル パス]** : パケット キャプチャが保存される仮想マシン上のローカル パス ( *[ファイル]* が選択されている場合にのみ有効)。 このパスは有効なパスである必要があります。 Linux 仮想マシンを使用する予定の場合、パスは */var/captures* で始まる必要があります。
   - **[ストレージ アカウント]** : *[ストレージ アカウント]* を選択した場合は、既存のストレージ アカウントを選択します。 このオプションを使用できるのは**ストレージ**を選択した場合のみです。
   
     > [!NOTE]
     > Premium Storage アカウントは、現在、パケット キャプチャの格納には対応していません。

   - **[1 パケットあたりの最大バイト数]** : 各パケットからキャプチャされるバイト数。 空白のままの場合、すべてのバイトがキャプチャされます。
   - **[1 セッションあたりの最大バイト数]** : キャプチャされる合計バイト数。 この値に達するとパケット キャプチャは停止します。
   - **[制限時間 (秒)]** : パケット キャプチャが停止されるまでの制限時間。 既定値は 18,000 秒です。
   - フィルター処理 (省略可能)。 **[+ フィルターの追加]** を選択します
     - **プロトコル**:パケット キャプチャをフィルター処理するためのプロトコルです。 使用可能な値は、[TCP]、[UDP]、[任意] のいずれかです。
     - **[ローカル IP アドレス]** : ローカル IP アドレスがこの値と一致するパケットを対象に、パケット キャプチャをフィルター処理します。
     - **[ローカル ポート]** : ローカル ポートがこの値と一致するパケットを対象に、パケット キャプチャをフィルター処理します。
     - **[リモート IP アドレス]** : リモート IP アドレスがこの値と一致するパケットを対象に、パケット キャプチャをフィルター処理します。
     - **[リモート ポート]** : リモート ポートがこの値と一致するパケットを対象に、パケット キャプチャをフィルター処理します。
    
     > [!NOTE]
     > ポートと IP アドレスの値には、1 つの値、値の範囲、またはポートの範囲 (80-1024 など) を指定できます。 フィルターは必要なだけ定義することができます。

4. **[OK]** を選択します。

パケット キャプチャに設定した制限時間が経過すると、パケット キャプチャは停止され、確認が可能になります。 パケット キャプチャ セッションは、手動で停止することもできます。

> [!NOTE]
> ポータルは自動で以下を実行します。
>  * リージョンにまだ Network Watcher がない場合、選択した仮想マシンが存在するリージョンと同じリージョン内に Network Watcher を作成します。
>  * まだインストールされていない場合は、仮想マシンに、[Linux](../virtual-machines/linux/extensions-nwa.md) または [Windows](../virtual-machines/windows/extensions-nwa.md) 用の *AzureNetworkWatcherExtension* 仮想マシン拡張機能を追加します。

## <a name="delete-a-packet-capture"></a>パケット キャプチャを削除する

1. パケット キャプチャ ビューで、パケット キャプチャの右側にある **[...]** を選択するか、既存のパケット キャプチャを右クリックし、 **[削除]** を選択します。
2. パケット キャプチャを削除することの確認を求められます。 **[はい]** を選択します。

> [!NOTE]
> パケット キャプチャを削除しても、ストレージ アカウント内または仮想マシン上のキャプチャ ファイルは削除されません。

## <a name="stop-a-packet-capture"></a>パケット キャプチャを停止する

パケット キャプチャ ビューで、パケット キャプチャの右側にある **[...]** を選択するか、既存のパケット キャプチャを右クリックし、 **[停止]** を選択します。

## <a name="download-a-packet-capture"></a>パケット キャプチャをダウンロードする

パケット キャプチャ セッションが完了すると、キャプチャ ファイルは BLOB ストレージまたは仮想マシン上のローカル ファイルにアップロードされます。 パケット キャプチャの保存場所は、パケット キャプチャの作成時に定義されます。 ストレージ アカウントに保存されたキャプチャ ファイルにアクセスする際の便利なツールが Microsoft Azure Storage Explorer です。このツールは[ダウンロード](https://storageexplorer.com/)できます。

ストレージ アカウントが指定されている場合、パケット キャプチャ ファイルは、次の場所にあるストレージ アカウントに保存されます。

```
https://{storageAccountName}.blob.core.windows.net/network-watcher-logs/subscriptions/{subscriptionId}/resourcegroups/{storageAccountResourceGroup}/providers/microsoft.compute/virtualmachines/{VMName}/{year}/{month}/{day}/packetCapture_{creationTime}.cap
```

キャプチャを作成したときに **[ファイル]** を選択した場合、仮想マシンで構成したパスから、ファイルを表示またはダウンロードすることができます。

## <a name="next-steps"></a>次のステップ

- 仮想マシンのアラートを使用してパケット キャプチャを自動化する方法については、[アラートでトリガーされるパケット キャプチャの作成](network-watcher-alert-triggered-packet-capture.md)に関するページを参照してください。
- 仮想マシンで特定のトラフィックの出入りが許可されているかどうかを確認するには、[仮想マシンのネットワーク トラフィック フィルターの問題を診断する](diagnose-vm-network-traffic-filtering-problem.md)ことに関するページを参照してください。
