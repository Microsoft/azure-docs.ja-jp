---
title: 接続モニターを作成する - Azure portal
titleSuffix: Azure Network Watcher
description: この記事では、Azure portal を使用して、接続モニターでモニターを作成する方法について説明します。
services: network-watcher
documentationcenter: na
author: vinigam
ms.service: network-watcher
ms.devlang: na
ms.topic: how-to
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 11/23/2020
ms.author: vinigam
ms.openlocfilehash: edf671c8005fa67f6161f383c503ca278dba3105
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/20/2021
ms.locfileid: "101702166"
---
# <a name="create-a-monitor-in-connection-monitor-by-using-the-azure-portal"></a>Azure portal を使用して接続モニターでモニターを作成する

> [!IMPORTANT]
> 2021 年 7 月 1 日以降、既存のワークスペースに新しいテストを追加したり、Network Performance Monitor で新しいワークスペースを有効にしたりできなくなります。 接続モニター (クラシック) に新しい接続モニターを追加することもできなくなります。 2021 年 7 月 1 日より前に作成されたテストおよび接続モニターは引き続き使用することができます。 現在のワークロードに対するサービスの中断を最小限に抑えるには、2024 年 2 月 29 日より前に、[Network Performance Monitor からテストを移行する](migrate-to-connection-monitor-from-network-performance-monitor.md)か、[接続モニター (クラシック) から Azure Network Watcher の新しい接続モニターに移行](migrate-to-connection-monitor-from-connection-monitor-classic.md)します。

接続モニターを使用して、リソース間の通信を監視する方法について説明します。 この記事では、Azure portal を使用してモニターを作成する方法について説明します。 接続モニターでは、ハイブリッドと Azure クラウドのデプロイがサポートされています。


## <a name="before-you-begin"></a>開始する前に 

接続モニターを使用して作成する接続モニターでは、オンプレミスのマシンと Azure VM の両方をソースとして追加できます。 これらの接続モニターでは、エンドポイントへの接続も監視できます。 エンドポイントは、Azure 上にあっても、他の任意の URL や IP 上にあってもかまいません。

利用を開始するときに役立つ定義を次に示します。

* **接続モニター リソース**。 リージョン固有の Azure リソース。 以下に示すすべてのエンティティは、接続モニター リソースのプロパティです。
* **エンドポイント**。 接続チェックに含まれるソースまたはターゲット。 エンドポイントの例を次に示します。
    * Azure VM。
    * Azure 仮想ネットワーク。
    * Azure サブネット。
    * オンプレミスのエージェント。
    * オンプレミスのサブネット。
    * 複数のサブネットを含むオンプレミスのカスタム ネットワーク。
    * URL と IP。
* **テスト構成**。 テスト用のプロトコル固有の構成。 選択したプロトコルに基づいて、ポート、しきい値、テストの頻度、その他のパラメーターを定義できます。
* **テスト グループ**。 ソース エンドポイント、ターゲット エンドポイント、テスト構成が含まれるグループ。 接続モニターには、複数のテスト グループを含めることができます。
* **Test**。 ソース エンドポイント、ターゲット エンドポイント、テスト構成の組み合わせ。 テストは、監視データを入手できる最も小さいレベルです。 監視データには、失敗したチェックの割合と、ラウンドトリップ時間 (RTT) が含まれます。

:::image type="content" source="./media/connection-monitor-2-preview/cm-tg-2.png" alt-text="接続モニターを示し、テスト グループとテストとの間の関係を定義した図。":::


## <a name="create-a-connection-monitor"></a>接続モニターを作成する

Azure portal を使用して接続モニターでモニターを作成するには:

1. Azure portal のホーム ページで、 **[Network Watcher]** に移動します。
1. 左側のペインの **[監視]** セクションで、 **[接続モニター]** を選択します。

   接続モニターで作成されたすべての接続モニターが表示されます。 従来の接続モニターで作成された接続モニターを表示するには、 **[接続モニター]** タブに移動します。

   :::image type="content" source="./media/connection-monitor-2-preview/cm-resource-view.png" alt-text="接続モニターで作成された接続モニターを示すスクリーンショット。":::
   
    
1. **[接続モニター]** ダッシュボードの左上隅にある **[作成]** を選択します。

   

1. **[基本]** タブで、接続モニターの情報を入力します。 
   * **[接続モニター名]** :接続モニターの名前を入力します。 Azure リソースの標準的な名前付けルールを使用します。
   * **サブスクリプション**:接続モニターのサブスクリプションを選択します。
   * **[リージョン]** :接続モニターのリージョンを選択します。 選択できるのは、このリージョンに作成されたソース VM のみです。
   * **[ワークスペースの構成]** :カスタム ワークスペースまたは既定のワークスペースを選択します。 ワークスペースには監視データが保持されます。
       * 既定のワークスペースを使用するには、チェック ボックスをオンにします。 
       * カスタム ワークスペースを選択するには、チェック ボックスをオフにします。 そして、カスタム ワークスペースのサブスクリプションとリージョンを選択します。 

   :::image type="content" source="./media/connection-monitor-2-preview/create-cm-basics.png" alt-text="接続モニターの [基本] タブを示すスクリーンショット。":::
   
1. タブの下部にある **[次へ: テスト グループ]** を選択します。

1. テスト グループにソース、変換先、テスト構成を追加します。 テスト グループの設定の詳細については、「[接続モニターでテスト グループを作成する](#create-test-groups-in-a-connection-monitor)」を参照してください。 

   :::image type="content" source="./media/connection-monitor-2-preview/create-tg.png" alt-text="接続モニターの [テスト グループ] タブを示すスクリーンショット。":::

1. タブの下部にある **[次へ: アラートの作成]** を選択します。 アラートの作成の詳細については、「[接続モニターでアラートを作成する](#create-alerts-in-connection-monitor)」を参照してください。

   :::image type="content" source="./media/connection-monitor-2-preview/create-alert.png" alt-text="[アラートの作成] タブを示すスクリーンショット。":::

1. タブの下部にある **[次へ: 確認と作成]** をクリックします。

1. 接続モニターを作成する前に、 **[確認と作成]** タブで基本情報とテスト グループを確認します。 接続モニターを編集する必要がある場合は、それぞれのタブに戻ります。 
   :::image type="content" source="./media/connection-monitor-2-preview/review-create-cm.png" alt-text="接続モニターの [確認と作成] タブを示すスクリーンショット。":::
   > [!NOTE] 
   > **[確認と作成]** タブには、接続モニターの段階の間の 1 か月あたりのコストが表示されます。 現在、 **[現在のコスト/月]** 列には料金が表示されません。 接続モニターが一般提供されるようになると、この列に月額料金が表示されます。 
   > 
   > 接続モニターの段階中でも、Log Analytics のインジェスト料金がかかります。

1. 接続モニターを作成する準備ができたら、 **[確認と作成]** タブの下部にある **[作成]** を選択します。

接続モニターにより、接続モニター リソースがバックグラウンドで作成されます。

## <a name="create-test-groups-in-a-connection-monitor"></a>接続モニターでテスト グループを作成する

接続モニターの各テストグループには、ネットワーク パラメーターでテストされるソースとターゲットが含まれています。 それらは、テスト構成でのチェックの失敗率と RTT についてテストされます。

Azure portal において接続モニターでテスト グループを作成するには、次のフィールドの値を指定します。

* **[テスト グループの無効化]** :このチェック ボックスをオンにすると、テスト グループで指定されているすべてのソースとターゲットに対する監視を無効にできます。 既定ではオフになっています。
* **[名前]** :テスト グループの名前を指定します。
* **Sources**:エージェントがインストールされていれば、Azure VM でもオンプレミスのマシンでもソースとして指定できます。 ソース用エージェントのインストールの詳細については、「[監視エージェントをインストールする](./connection-monitor-overview.md#install-monitoring-agents)」を参照してください。
   * Azure エージェントを選択するには、 **[Azure エンドポイント]** タブを選択します。ここでは、接続モニターを作成するときに指定したリージョンにバインドされている VM のみが表示されます。 既定では、VM は属しているサブスクリプションにグループ化されます。 これらのグループは折りたたまれています。 
   
       **サブスクリプション** レベルから次の階層内の他のレベルにドリルダウンできます。

      **サブスクリプション** > **リソース グループ** > **VNET** > **サブネット** > **エージェントがインストールされている VM**

      また、 **[グループ化]** セレクターを変更して、他のレベルからツリーを開始することもできます。 たとえば、仮想ネットワークでグループ化すると、エージェントがインストールされている VM は階層 **VNET** > **サブネット** > **エージェントがインストールされている VM** に表示されます。

       VNET、サブネット、または単一の VM を選択すると、対応するリソース ID がエンドポイントとして設定されます。 既定では、Azure Network Watcher 拡張機能がある、選択した VNET またはサブネット内のすべての VM が監視に関与します。 スコープを減らすには、特定のサブネットまたはエージェントを選択するか、スコープ プロパティの値を変更します。 

      :::image type="content" source="./media/connection-monitor-2-preview/add-azure-sources.png" alt-text="接続モニターの [ソースの追加] ペインと [Azure エンドポイント] タブを示すスクリーンショット。":::

   * オンプレミスのエージェントを選択するには、 **[非 Azure エンドポイント]** タブを選択します。既定では、エージェントはリージョンごとにワークスペースにグループ化されます。 これらのワークスペースのすべてに、Network Performance Monitor が構成されます。 
   
       ワークスペースに Network Performance Monitor ソリューションを追加する必要がある場合は、[Azure Marketplace](https://azuremarketplace.microsoft.com/marketplace/apps/solarwinds.solarwinds-orion-network-performance-monitor?tab=Overview) から入手します。 Network Performance Monitor を追加する方法について詳しくは、「[Azure Monitor での監視ソリューション](../azure-monitor/insights/solutions.md)」をご覧ください。 
   
       **[接続モニターの作成]** の **[基本]** タブでは、既定のリージョンが選択されています。 リージョンを変更する場合、新しいリージョンのワークスペースからエージェントを選択できます。 1 つ以上のエージェントまたはサブネットを選択できます。 **[サブネット]** ビューで、監視する特定の IP を選択できます。 複数のサブネットを追加すると、**OnPremises_Network_1** という名前のカスタムのオンプレミス ネットワークが作成されます。 また、**Group by** セレクターを変更して、エージェントごとにグループ化することもできます。

      :::image type="content" source="./media/connection-monitor-2-preview/add-non-azure-sources.png" alt-text="接続モニターの [ソースの追加] ペインと [Azure 以外のエンドポイント] タブを示すスクリーンショット。":::

   * 最近使用したエンドポイントを選択するには、 **[最近使ったエンドポイント]** タブを使用します。 
   
   * ソースの設定が終わったら、そのタブの下部にある **[完了]** を選択します。 **[テスト グループの作成]** ビューでエンドポイントを選択すれば、エンドポイント名のような基本的なプロパティも編集できます。 

* **宛先**:Azure VM、オンプレミスのマシン、または任意のエンドポイント (パブリック IP、URL、FQDN) をターゲットとして指定すると、それらへの接続を監視できます。 1 つのテスト グループに、Azure VM、オンプレミスのマシン、Office 365 URL、Dynamics 365 URL、カスタム エンドポイントを追加できます。

    * Azure VM をターゲットとして選択するには、 **[Azure エンドポイント]** タブを選択します。既定では、Azure VM は、 **[基本]** タブの **[接続モニターの作成]** で選択したリージョン内のサブスクリプション階層にグループ化されます。リージョンを変更し、新しいリージョンから Azure VM を選択できます。 その後、ソース Azure エンドポイントを設定する場合と同様に、 **[サブスクリプション]** レベルから階層内の他のレベルにドリルダウンできます。

      ソース Azure エンドポイントを設定するときと同じように、VNET、サブネット、または単一の VM を選択できます。 VNET、サブネット、または単一の VM を選択すると、対応するリソース ID がエンドポイントとして設定されます。 既定では、Network Watcher 拡張機能がある、選択した VNET またはサブネット内のすべての VM が監視に関与します。 スコープを減らすには、特定のサブネットまたはエージェントを選択するか、スコープ プロパティの値を変更します。 

      :::image type="content" source="./media/connection-monitor-2-preview/add-azure-dests1.png" alt-text="<[ターゲットの追加] ペインと [Azure エンドポイント] タブを示すスクリーンショット。>":::

      :::image type="content" source="./media/connection-monitor-2-preview/add-azure-dests2.png" alt-text="<[ターゲットの追加] ペインでサブスクリプション レベルが指定されている様子を示すスクリーンショット。>":::
       
    
    * Azure 以外のエージェントをターゲットとして選択するには、 **[Azure 以外のエンドポイント]** タブを選択します。既定では、エージェントはリージョンごとにワークスペースにグループ化されます。 これらのワークスペースのすべてに、Network Performance Monitor が構成されます。 
    
      ワークスペースに Network Performance Monitor ソリューションを追加する必要がある場合は、Azure Marketplace から入手します。 Network Performance Monitor を追加する方法について詳しくは、「[Azure Monitor での監視ソリューション](../azure-monitor/insights/solutions.md)」をご覧ください。 

       **[接続モニターの作成]** の  **[基本]**   タブでは、既定のリージョンが選択されています。 リージョンを変更する場合、新しいリージョンのワークスペースからエージェントを選択できます。 1 つ以上のエージェントまたはサブネットを選択できます。 **[サブネット]** ビューで、監視する特定の IP を選択できます。 複数のサブネットを追加すると、**OnPremises_Network_1** という名前のカスタムのオンプレミス ネットワークが作成されます。  

      :::image type="content" source="./media/connection-monitor-2-preview/add-non-azure-dest.png" alt-text="[ターゲットの追加] ペインと [Azure 以外のエンドポイント] タブを示すスクリーンショット。":::
    
    * ターゲットとしてパブリック エンドポイントを選択するには、 **[外部アドレス]** タブを選択します。エンドポイントの一覧には、Office 365 のテスト URL と Dynamics 365 のテスト URL が含まれ、名前でグループ化されています。 同じ接続モニターの他のテスト グループで作成されたエンドポイントを選択することもできます。 
    
        エンドポイントを追加するには、右上隅の **[エンドポイントの追加]** を選択します。 次に、エンドポイントの名前と、URL、IP、または FQDN を指定します。

       :::image type="content" source="./media/connection-monitor-2-preview/add-endpoints.png" alt-text="接続モニターのターゲットとしてパブリック エンドポイントを追加する場所を示すスクリーンショット。":::

    * 最近使用したエンドポイントを選択するには、 **[最近使用したエンドポイント]**   タブに移動します。
    * ターゲットの選択が終わったら、 **[完了]** を選択します。 **[テスト グループの作成]** ビューでエンドポイントを選択すれば、エンドポイント名のような基本的なプロパティも編集できます。 

* **テスト構成**:1 つまたは複数のテスト構成をテストグループに追加できます。 **[新しい構成]** タブを使用して、新しいテスト構成を作成します。または、 **[既存を使用]** タブから、同じ接続モニターの別のテスト グループのテスト構成を追加します。

    * **テスト構成名**:テスト構成に名前を指定します。
    * **プロトコル**: **[TCP]** 、 **[ICMP]** 、または **[HTTP]** を選択します。 HTTP を HTTPS に変更するには、プロトコルとして **[HTTP]** を、ポートとして **[443]** を選択します。
        * **TCP テスト構成の作成**:このチェック ボックスは、 **[プロトコル]** 一覧で **[HTTP]** を選択した場合にのみ表示されます。 構成の別の場所で指定したのと同じソースおよびターゲットを使用して別のテスト構成を作成するには、このチェック ボックスをオンにします。 新しいテスト構成には、 **\<name of test configuration>_networkTestConfig** という名前が付けられます。
        * **Traceroute の無効化**:このチェック ボックスは、プロトコルが TCP または ICMP の場合に適用されます。 このボックスをオンにすると、ソースでのトポロジとホップバイホップ RTT の検出が停止します。
    * **ターゲット ポート**:任意のターゲット ポートを指定します。
        * **ポートでリッスン**:このチェック ボックスは、プロトコルが TCP の場合に適用されます。 選択した TCP ポートがまだ開いていない場合は、このチェック ボックスをオンにして開きます。 
    * **テスト間隔**:この一覧で、指定したプロトコルとポートでソースがターゲットに ping を実行する頻度を指定します。 30 秒、1 分、5 分、15 分、30 分のいずれかを選択できます。 **[カスタム]** を選択して、30 秒から 30 分までの別の頻度を入力します。 ソースでは、選択した値に基づいて、ターゲットへの接続がテストされます。 たとえば、30 秒を選択すると、少なくとも 30 秒に 1 回、ソースによりターゲットへの接続が確認されます。
    * **成功のしきい値**:以下のネットワーク パラメーターにしきい値を設定できます。
       * **チェックの失敗**:指定した条件で行われるソースによるターゲットへの接続の確認で、失敗してもかまわないチェックの割合を設定します。 TCP または ICMP プロトコルでは、失敗したチェックの割合はパケット損失の割合と同等と考えられます。 HTTP プロトコルでは、この値は応答を受け取らなかった HTTP 要求の割合を表します。
       * **ラウンドトリップ時間**:テスト構成でソースがターゲットに接続するのにかかるラウンドトリップ時間をミリ秒で設定します。
       
   :::image type="content" source="./media/connection-monitor-2-preview/add-test-config.png" alt-text="接続モニターでテスト構成を設定する場所を示すスクリーンショット。":::
       
## <a name="create-alerts-in-connection-monitor"></a>接続モニターでアラートを作成する

テスト構成で設定されたしきい値に基づいて失敗したテストに対してアラートを設定できます。

Azure portal において接続モニターでアラートを作成するには、これらのフィールドの値を指定します。 

- **アラートの作成**:Azure Monitor でメトリック アラートを作成するには、このチェック ボックスをオンにします。 このチェック ボックスをオンにすると、他のフィールドの編集が有効になります。 アラートの追加料金は、[アラートの価格](https://azure.microsoft.com/pricing/details/monitor/)に基づいて適用されます。 

- **スコープ** > **リソース** > **階層**:これらの値は、 **[基本]** タブで指定された値に基づいて自動的に入力されます。

- **条件名**:`Test Result(preview)` メトリックにアラートが作成されます。 接続モニター テストの結果が失敗した場合は、アラート ルールが起動します。 

- **アクション グループ名**:メール アドレスを直接入力することも、アクション グループを使用してアラートを作成することもできます。 メール アドレスを直接入力すると、**NPM Email ActionGroup** という名前のアクション グループが作成されます。 メール ID がそのアクション グループに追加されます。 アクション グループを使用する場合は、以前に作成したアクション グループを選択する必要があります。 アクション グループを作成する方法の詳細については、[Azure portal でのアクション グループの作成](../azure-monitor/alerts/action-groups.md)に関するページを参照してください。 アラートが作成されたら、[アラートを管理する](../azure-monitor/alerts/alerts-metric.md#view-and-manage-with-azure-portal)ことができます。 

- **アラート ルール名**:接続モニターの名前です。

- **作成時にルールを有効にする**:条件に基づいてアラート ルールを有効にするには、このチェック ボックスをオンにします。 ルールを有効にせずに作成する場合は、このチェック ボックスをオフにします。 

:::image type="content" source="./media/connection-monitor-2-preview/create-alert-filled.png" alt-text="接続モニターの [アラートの作成] タブを示すスクリーンショット。":::

## <a name="scale-limits"></a>スケールの上限

接続モニターには、これらのスケール制限があります。

* 1 つのリージョンの 1 つのサブスクリプションあたりの接続モニターの最大数: 100
* 接続モニターあたりのテスト グループの最大数: 20
* 接続モニターあたりのソースとターゲットの最大数: 100
* 接続モニターあたりのテスト構成の最大数: 2 (Azure portal を使用した場合)

## <a name="next-steps"></a>次のステップ

* [監視データを分析してアラートを設定する方法](./connection-monitor-overview.md#analyze-monitoring-data-and-set-alerts)を確認する。
* [ネットワークの問題を診断する方法](./connection-monitor-overview.md#diagnose-issues-in-your-network)を確認する。
