---
title: データ同期の設定
description: このチュートリアルでは、Azure SQL データ同期をセットアップする方法を示します
services: sql-database
ms.service: sql-database
ms.subservice: data-movement
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: stevestein
ms.author: sstein
ms.reviewer: carlrab
ms.date: 01/14/2019
ms.openlocfilehash: 019ddbac1900856666b958d90b4395f25eb5ee84
ms.sourcegitcommit: f4f626d6e92174086c530ed9bf3ccbe058639081
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 12/25/2019
ms.locfileid: "75461558"
---
# <a name="tutorial-set-up-sql-data-sync-between-azure-sql-database-and-sql-server-on-premises"></a>チュートリアル:Azure SQL Database とオンプレミスの SQL Server 間の SQL データ同期を設定する

このチュートリアルでは、Azure SQL Database と SQL Server の両方のインスタンスを含む同期グループを作成することによって Azure SQL データ同期を設定する方法について説明します。 同期グループはカスタム構成され、設定されたスケジュールで同期します。

このチュートリアルは、SQL Database と SQL Server の使用経験があることを前提としています。

SQL データ同期の概要については、[Azure SQL データ同期を使用したクラウドとオンプレミス データベース間でのデータの同期](sql-database-sync-data.md)に関する記事を参照してください。

PowerShell を使用した SQL データ同期の構成方法の例については、[Azure SQL データベース間](scripts/sql-database-sync-data-between-sql-databases.md)または[Azure SQL データベースと SQL Server のオンプレミス データベース間](scripts/sql-database-sync-data-between-azure-onprem.md)の同期方法に関する記事をご覧ください。

> [!IMPORTANT]
> 現時点では、Azure SQL データ同期で Azure SQL Database Managed Instance はサポート**されていません**。

## <a name="create-sync-group"></a>同期グループを作成する

1. [Azure portal](https://portal.azure.com) に移動して、SQL データベースを見つけます。 **SQL データベース**を検索して選択します。

    ![SQL データベースの検索, Microsoft Azure portal](media/sql-database-get-started-sql-data-sync/search-for-sql-databases.png)

1. データ同期のハブ データベースとして使用するデータベースを選択します。

    ![SQL データベースの一覧からの選択, Microsoft Azure portal](media/sql-database-get-started-sql-data-sync/select-sql-database.png)

    > [!NOTE]
    > ハブ データベースは同期トポロジの中心になるエンドポイントであり、1 つの同期グループには複数のデータベース エンドポイントが含まれます。 同期グループ内にエンドポイントがある他のすべてのメンバー データベースが、ハブ データベースと同期します。

1. 選択したデータベースの **[SQL データベース]** メニューで、 **[別のデータベースに同期]** を選択します。

    ![他のデータベースへの同期, SQL データベース, Microsoft Azure portal](media/sql-database-get-started-sql-data-sync/sync-to-other-databases.png)

1. **[別のデータベースに同期]** ページで、 **[新しい同期グループ]** を選択します。 **[新しい同期グループ]** ページが開きます ( **[同期グループの作成] (手順 1)** が強調表示されています)。

   ![手順 1 の設定](media/sql-database-get-started-sql-data-sync/stepone.png)

   **[データ同期グループの作成]** ページで、次の設定を変更します。

   | 設定                        | 説明 |
   | ------------------------------ | ------------------------------------------------- |
   | **同期グループ名** | 新しい同期グループの名前を入力します。 この名前は、データベース自体の名前とは異なります。 |
   | **同期メタデータ データベース** | データベースを作成する (推奨) か、既存のデータベースを使用するかを選択します。<br/><br/>**[新しいデータベース]** を選択した場合は、 **[新しいデータベースの作成]** を選択します。 次に、 **[SQL データベース]** ページで、新しいデータベースの名前を指定して構成し、 **[OK]** を選択します。<br/><br/>**[既存のデータベースを使用する]** を選択した場合は、一覧からデータベースを選択します。 |
   | **自動同期** | **[オン]** または **[オフ]** を選択します。<br/><br/>**[オン]** を選択した場合は、 **[同期の頻度]** セクションで数値を入力し、 **[秒]** 、 **[分]** 、 **[時間]** 、または **[日]** を選択します。 |
   | **競合の解決** | **[Hub win]\(ハブ優先\)** または **[Member win]\(メンバー優先\)** を選択します。<br/><br/>**[Hub win]\(ハブ優先\)** とは、競合が発生した場合、ハブ データベースのデータによって、メンバー データベースの競合するデータが上書きされることを意味します。<br/><br/>**[Member win]\(メンバー優先\)** とは、競合が発生した場合、メンバー データベースのデータによって、ハブ データベースの競合するデータが上書きされることを意味します。 |

   > [!NOTE]
   > Microsoft では、**同期メタデータ データベース**として使用する新しい空のデータベースを作成することをお勧めしています。 データ同期は、このデータベースにテーブルを作成し、頻繁に発生するワークロードを実行します。 このデータベースは選択されたリージョン内のすべての同期グループで**同期メタデータ データベース**して共有され、リージョン内のすべての同期グループと同期エージェントを削除しない限り、データベースを変更することも名前を変更することもできません。

   **[OK]** を選択し、同期グループが作成されてデプロイされるまで待ちます。

## <a name="add-sync-members"></a>同期メンバーを追加する

新しい同期グループが作成されてデプロイされると、 **[新しい同期グループ]** ページで **[同期メンバーの追加] (手順 2)** が強調表示されます。

**[ハブ データベース]** セクションで、ハブ データベースを配置する SQL Database サーバーの既存の資格情報を入力します。 このセクションでは、"*新しい*" 資格情報を入力しないでください。

![手順 2 の設定](media/sql-database-get-started-sql-data-sync/steptwo.png)

### <a name="to-add-an-azure-sql-database"></a>Azure SQL データベースを追加するには

**[メンバー データベース]** セクションで、必要に応じて **[Add an Azure SQL Database]\(Azure SQL Database を追加\)** を選択して、Azure SQL Database を同期グループに追加します。 **[Configure Azure SQL Database]\(Azure SQL Database の構成\)** ページが開きます。

  ![手順 2 - データベースの構成](media/sql-database-get-started-sql-data-sync/steptwo-configure.png)

  **[Configure Azure SQL Database]\(Azure SQL Database の構成\)** ページで、次の設定を変更します。

  | 設定                       | 説明 |
  | ----------------------------- | ------------------------------------------------- |
  | **同期メンバー名** | 新しい同期メンバーの名前を指定します。 この名前は、データベース自体の名前とは異なります。 |
  | **サブスクリプション** | 課金のために関連付ける Azure サブスクリプションを選択します。 |
  | **Azure SQL Server** | 既存の SQL Database サーバーを選択します。 |
  | **Azure SQL Database** | 既存の SQL データベースを選択します。 |
  | **同期方向** | **[双方向の同期]** 、 **[ハブへ]** 、または **[ハブから]** を選択します。 |
  | **[ユーザー名]** と **[パスワード]** | メンバー データベースが配置されている SQL Database サーバー用の既存の資格情報を入力します。 このセクションでは、"*新しい*" 資格情報を入力しないでください。 |

  **[OK]** を選択し、新しい同期メンバーが作成され、デプロイされるまで待ちます。

<a name="add-on-prem"></a>
### <a name="to-add-an-on-premises-sql-server-database"></a>オンプレミスの SQL Server データベースを追加するには

**[メンバー データベース]** セクションで、必要に応じて **[オンプレミス データベースを追加]** を選択して、オンプレミスの SQL Server を同期グループに追加します。 **[オンプレミスの構成]** ページが開き、次の操作を実行できます。

1. **[同期エージェント ゲートウェイの選択]** を選択します。 **[同期エージェントの選択]** ページが開きます。

   ![同期エージェントの作成](media/sql-database-get-started-sql-data-sync/steptwo-agent.png)

1. **[同期エージェントの選択]** ページで、既存のエージェントを使用するか、エージェントを作成するかを選択します。

   **[既存のエージェント]** を選択した場合は、一覧から既存のエージェントを選択します。

   **[新しいエージェントの作成]** を選択した場合は、次の操作を行います。

   1. 表示されているリンクからデータ同期エージェントをダウンロードし、SQL Server が配置されているコンピューターにインストールします。 このエージェントは、[SQL Azure Data Sync Agent](https://www.microsoft.com/download/details.aspx?id=27693) のページから直接ダウンロードすることもできます。

      > [!IMPORTANT]
      > クライアント エージェントがサーバーと通信できるように、ファイアウォールの送信 TCP ポート 1433 を開く必要があります。

   1. エージェントの名前を入力します。

   1. **[Create and Generate Key]\(作成とキーの生成\)** を選択し、エージェント キーをクリップボードにコピーします。

   1. **[OK]** を選択して、 **[同期エージェントの選択]** ページを閉じます。

1. SQL Server コンピューターでクライアント同期エージェント アプリを探して実行します。

   ![データ同期クライアント エージェント アプリ](media/sql-database-get-started-sql-data-sync/datasync-preview-clientagent.png)

    1. 同期エージェント アプリで **[Submit Agent Key]\(エージェント キーの送信\)** を選択します。 **[Sync Metadata Database Configuration]\(同期メタデータ データベースの構成\)** ダイアログ ボックスが開きます。

    1. **[Sync Metadata Database Configuration]\(同期メタデータ データベースの構成\)** ダイアログ ボックスで、Azure Portal からコピーしたエージェント キーを貼り付けます。 また、メタデータ データベースが配置されている Azure SQL Database サーバーの既存の資格情報も指定します。 (メタデータ データベースを作成した場合、このデータベースはハブ データベースと同じサーバー上にあります)。 **[OK]** を選択し、構成が完了するまで待ちます。

        ![エージェント キーとサーバー資格情報の入力](media/sql-database-get-started-sql-data-sync/datasync-preview-agent-enterkey.png)

        > [!NOTE]
        > ファイアウォール エラーが発生する場合は、SQL Server コンピューターからの受信トラフィックを許可するファイアウォール規則を Azure 上に作成する必要があります。 この規則は、ポータルまたは SQL Server Management Studio (SSMS) で手動で作成できます。 SSMS で、名前として <hub_database_name>.database.windows.net を入力することで、Azure 上のハブ データベースに接続します。

    1. **[登録]** を選択して、SQL Server データベースをエージェントに登録します。 **[SQL Server の構成]** ダイアログ ボックスが開きます。

        ![SQL Server データベースの追加と構成](media/sql-database-get-started-sql-data-sync/datasync-preview-agent-adddb.png)

    1. **[SQL Server の構成]** ダイアログ ボックスで、SQL Server 認証と Windows 認証のどちらを使用して接続するかを選択します。 SQL Server 認証を選択した場合は、既存の資格情報を入力します。 SQL Server の名前と、同期するデータベースの名前を指定し、 **[テスト接続]** を選択して設定をテストします。 その後、 **[保存]** を選択します。登録したデータベースが一覧に表示されます。

        ![SQL Server データベースが登録されました](media/sql-database-get-started-sql-data-sync/datasync-preview-agent-dbadded.png)

    1. Client Sync Agent アプリを閉じます。

1. ポータルの **[オンプレミスの構成]** ページで、 **[データベースの選択]** を選択します。

1. **[データベースの選択]** ページの **[メンバー名の同期]** フィールドで、新しい同期メンバーの名前を指定します。 この名前は、データベース自体の名前とは異なります。 一覧からデータベースを選択します。 **[同期方向]** フィールドで、 **[双方向の同期]** 、 **[ハブへ]** 、または **[ハブから]** を選択します。

    ![オンプレミス データベースの選択](media/sql-database-get-started-sql-data-sync/datasync-preview-selectdb.png)

1. **[OK]** を選択して、 **[データベースの選択]** ページを閉じます。 さらに **[OK]** を選択して **[オンプレミスの構成]** ページを閉じ、新しい同期メンバーが作成およびデプロイされるまで待ちます。 最後に、 **[OK]** を選択して **[同期メンバーの選択]** ページを閉じます。

> [!NOTE]
> SQL データ同期およびローカル エージェントに接続するには、*DataSync_Executor* ロールにユーザー名を追加します。 データ同期は、このロールを SQL Server インスタンス上に作成します。

## <a name="configure-sync-group"></a>同期グループを構成する

新しい同期グループ メンバーが作成されてデプロイされると、 **[新しい同期グループ]** ページで **[同期グループの構成] (手順 3)** が強調表示されます。

![手順 3 の設定](media/sql-database-get-started-sql-data-sync/stepthree.png)

1. **[テーブル]** ページで、同期グループ メンバーの一覧からデータベースを選択し、 **[スキーマの更新]** を選択します。

1. 一覧から、同期するテーブルを選択します。既定では、すべての列が選択されているため、同期しない列のチェック ボックスをオフにします。主キー列は、選択されたままにしておいてください。

1. **[保存]** を選択します。

1. 既定では、スケジュールに従うか手動で実行されるまで、データベースは同期されません。 手動による同期を実行するには、Azure portal で SQL データベースに移動し、 **[別のデータベースに同期]** を選択し、同期グループを選択します。 **[データ同期]** ページが開きます。 **[同期]** を選択します。

    ![手動同期](media/sql-database-get-started-sql-data-sync/datasync-sync.png)

## <a name="faq"></a>よく寄せられる質問

**データ同期では、どのくらいの頻度でデータを同期できますか?**

同期の最小間隔は 5 分です。

**SQL データ同期では、テーブル全体が作成されますか?**

同期先データベースに同期スキーマ テーブルがない場合は、ご自分で選択した列を持つテーブルが SQL データ同期によって作成されます。 ただし、以下の理由から、これは完全に忠実なスキーマにはなりません。

- 同期先テーブルには、ご自分で選択した列だけが作成されます。 選択していない列は無視されます。
- 同期先テーブルには、選択した列のインデックスだけが作成されます。 列が選択されていない場合、それらのインデックスは無視されます。
- XML 型の列のインデックスは作成されません。
- CHECK 制約は作成されません。
- 同期元テーブル上のトリガーは作成されません。
- ビューとストアド プロシージャは作成されません。

これらの制限のため、次のことをお勧めします。

- 運用環境では、完全に忠実なスキーマをご自身で作成します。
- サービスを試す場合は、自動プロビジョニング機能を使用します。

**自分で作成していないテーブルがあるのはなぜですか?**

データ同期では、データベース内に変更を追跡するための追加のテーブルが作成されます。 これらを削除しないでください。削除するとデータ同期が動作を停止します。

**同期後にデータは収束しますか?**

必ずしもその必要はありません。 ハブと 3 つのスポーク (A、B、C) を持つ同期グループがあり、同期は ハブから A、ハブから B、ハブから C に対して行われるものとします。ハブから A への同期が実行された "*後*" でデータベース A が変更された場合、その変更は、次の同期タスクが実行されるまで、データベース B またはデータベース C には書き込まれません。

**スキーマの変更を同期グループに反映するにはどうすればよいですか?**

すべてのスキーマの変更を手動で行い、手動で反映してください。

1. ハブおよびすべての同期メンバーに対してスキーマ変更を手動でレプリケートします。
1. 同期スキーマを更新します。

新しいテーブルと列を追加する場合:

新しいテーブルと列は現在の同期に影響しないため、データ同期では、それらが同期スキーマに追加されるまで無視されます。 新しいデータベース オブジェクトを追加する場合は、次のシーケンスに従ってください。

1. 新しいテーブルまたは列を、ハブとすべての同期メンバーに追加します。
1. 新しいテーブルまたは列を、同期スキーマに追加します。
1. 新しいテーブルと列への値の挿入を開始します。

列のデータ型を変更する場合:

既存の列のデータ型を変更した場合、データ同期は新しい値が同期スキーマで定義された元のデータ型に一致する限り動作を続行します。 たとえば、同期元データベース内の型を **int** から **bigint** に変更した場合、**int** データ型としては大きすぎる値を挿入するまで、データ同期は動作を続行します。 変更を完了するには、ハブとすべての同期メンバーに対してスキーマの変更を手動でレプリケートした後、同期スキーマを更新します。

**データ同期でデータベースのエクスポートとインポートを行うにはどうすればよいですか?**

データベースを *.bacpac* ファイルとしてエクスポートし、そのファイルをインポートしてデータベースを作成した後、以下を実行して、新しいデータベースでデータ同期を使用します。

1. [このスクリプト](https://github.com/vitomaz-msft/DataSyncMetadataCleanup/blob/master/Data%20Sync%20complete%20cleanup.sql)を使用して、新しいデータベースでデータ同期オブジェクトと追加のテーブルをクリーンアップします。 このスクリプトは、データベースからすべての必要なデータ同期オブジェクトを削除します。
1. 新しいデータベースで同期グループを再作成します。 古い同期グループが必要ない場合は削除します。

**クライアント エージェントに関する情報はどこで見つけることができますか?**

クライアント エージェントについてよく寄せられる質問については、[エージェントに関する FAQ](sql-database-data-sync-agent.md#agent-faq) のセクションを参照してください。

## <a name="next-steps"></a>次のステップ

おめでとうございます。 SQL データベース インスタンスと SQL Server データベースの両方を含む同期グループを作成しました。

SQL データ同期の詳細については、以下を参照してください。

- [Azure SQL データ同期用の Data Sync Agent](sql-database-data-sync-agent.md)
- [ベスト プラクティス](sql-database-best-practices-data-sync.md)と [SQL データ同期に関する問題をトラブルシューティングする方法](sql-database-troubleshoot-data-sync.md)
- [Azure Monitor ログによる SQL データ同期の監視](sql-database-sync-monitor-oms.md)
- [Transact-SQL を使用した同期スキーマの更新](sql-database-update-sync-schema.md)または [PowerShell](scripts/sql-database-sync-update-schema.md)

SQL Database の詳細については、以下を参照してください。

- [SQL Database の概要](sql-database-technical-overview.md)
- [データベースのライフサイクル管理](https://msdn.microsoft.com/library/jj907294.aspx)
