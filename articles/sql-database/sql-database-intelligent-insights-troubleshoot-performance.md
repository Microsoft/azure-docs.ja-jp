---
title: Intelligent Insights を使用した Azure SQL Database のパフォーマンスに関する問題のトラブルシューティング | Microsoft Docs
description: Intelligent Insights は Azure SQL Database のパフォーマンスに関する問題のトラブルシューティングに役立ちます。
services: sql-database
ms.service: sql-database
ms.subservice: performance
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: danimir
ms.author: danil
ms.reviewer: jrasnik, carlrab
manager: craigg
ms.date: 09/20/2018
ms.openlocfilehash: ad7d56b3a23d163cfbc6c9ca14c2788c5f96486b
ms.sourcegitcommit: 4eeeb520acf8b2419bcc73d8fcc81a075b81663a
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 12/19/2018
ms.locfileid: "53600864"
---
# <a name="troubleshoot-azure-sql-database-performance-issues-with-intelligent-insights"></a>Intelligent Insights を使用した Azure SQL Database のパフォーマンスに関する問題のトラブルシューティング

このページでは、[Intelligent Insights](sql-database-intelligent-insights.md) のデータベース パフォーマンス診断ログによって検出された、Azure SQL Database と Managed Instance のパフォーマンスに関する問題について説明します。 この診断ログ テレメトリを、[Azure Log Analytics](../azure-monitor/insights/azure-sql.md)、[Azure Event Hubs](../azure-monitor/platform/diagnostic-logs-stream-event-hubs.md)、[Azure Storage](sql-database-metrics-diag-logging.md#stream-into-storage)、または DevOps のカスタム アラートおよびレポート機能を提供するサード パーティ製ソリューションにストリーミングできます。

> [!NOTE]
> Intelligent Insights を使った SQL Database のパフォーマンスのトラブルシューティングに関するクイック ガイドについては、このドキュメントの「[推奨されるトラブルシューティングのフロー](sql-database-intelligent-insights-troubleshoot-performance.md#recommended-troubleshooting-flow)」のフローチャートをご覧ください。
>

## <a name="detectable-database-performance-patterns"></a>データベースの検出可能なパフォーマンス パターン

Intelligent Insights を使用すると、クエリ実行の待機時間、エラー、またはタイムアウトに基づいて、SQL Database と Managed Instance データベースのパフォーマンスの問題が自動的に検出されます。 検出されたパフォーマンス パターンは、診断ログに出力されます。 検出可能なパフォーマンス パターンの概要を次の表に示します。

| 検出可能なパフォーマンス パターン | Azure SQL Database とエラスティック プールの説明 | Managed Instance 内のデータベースの説明 |
| :------------------- | ------------------- | ------------------- |
| [リソースの上限に到達](sql-database-intelligent-insights-troubleshoot-performance.md#reaching-resource-limits) | 監視対象サブスクリプションで使用可能なリソース (DTU)、データベース ワーカー スレッド、またはデータベース ログイン セッションの消費量が制限に達しました。 これは SQL データベースのパフォーマンスに影響しています。 | CPU リソースの消費量が Managed Instance の制限に達しそうです。 これは SQL データベースのパフォーマンスに影響しています。 |
| [ワークロードの増加](sql-database-intelligent-insights-troubleshoot-performance.md#workload-increase) | データベースでのワークロードの増加またはワークロードの継続的な蓄積が検出されました。 これは SQL データベースのパフォーマンスに影響しています。 | ワークロードの増加が検出されました。 これは SQL データベースのパフォーマンスに影響しています。 |
| [メモリ不足](sql-database-intelligent-insights-troubleshoot-performance.md#memory-pressure) | メモリ許可を要求した worker は、統計的にかなりの時間、メモリの割り当てを待つ必要があります。 または、メモリ許可を要求した worker が大量に蓄積しています。 これは SQL データベースのパフォーマンスに影響しています。 | メモリ許可を要求した worker は、統計的にかなりの時間、メモリの割り当てを待つ必要があります。 これは SQL データベースのパフォーマンスに影響しています。 |
| [ロック](sql-database-intelligent-insights-troubleshoot-performance.md#locking) | SQL データベースのパフォーマンスに影響を与える、過剰なデータベースのロックが検出されました。 | データベースのパフォーマンスに影響を与える、過剰なデータベースのロックが検出されました。 |
| [MAXDOP の増加](sql-database-intelligent-insights-troubleshoot-performance.md#increased-maxdop) | 並列処理の最大限度オプション (MAXDOP) が変更されて、クエリの実行効率に影響を与えています。 これは SQL データベースのパフォーマンスに影響しています。 | 並列処理の最大限度オプション (MAXDOP) が変更されて、クエリの実行効率に影響を与えています。 これは SQL データベースのパフォーマンスに影響しています。 |
| [ページラッチの競合](sql-database-intelligent-insights-troubleshoot-performance.md#pagelatch-contention) | 複数のスレッドがメモリ内の同じデータ バッファー ページに同時にアクセスしようとしたため、待機時間が延び、ページラッチの競合が発生しています。 これは SQL データベースのパフォーマンスに影響しています。 | 複数のスレッドがメモリ内の同じデータ バッファー ページに同時にアクセスしようとしたため、待機時間が延び、ページラッチの競合が発生しています。 これはデータベースのパフォーマンスに影響しています。 |
| [インデックスの不足](sql-database-intelligent-insights-troubleshoot-performance.md#missing-index) | SQL データベースのパフォーマンスに影響するインデックスの不足が検出されました。 | データベースのパフォーマンスに影響するインデックスの不足が検出されました。 |
| [新しいクエリ](sql-database-intelligent-insights-troubleshoot-performance.md#new-query) | SQL データベースの全体的なパフォーマンスに影響する新しいクエリが検出されました。 | データベースの全体的なパフォーマンスに影響する新しいクエリが検出されました。 |
| [待機の増加の統計](sql-database-intelligent-insights-troubleshoot-performance.md#increased-wait-statistic) | SQL データベースのパフォーマンスに影響するデータベースの待機時間の増加が検出されました。 | データベースのパフォーマンスに影響するデータベースの待機時間の増加が検出されました。 |
| [TempDB の競合](sql-database-intelligent-insights-troubleshoot-performance.md#tempdb-contention) | 複数のスレッドが同じ TempDB リソースにアクセスを試行していることでボトルネックが生じています。 これは SQL データベースのパフォーマンスに影響しています。 | 複数のスレッドが同じ TempDB リソースにアクセスを試行していることでボトルネックが生じています。 これは SQL データベースのパフォーマンスに影響しています。 |
| [エラスティック プールの DTU の不足](sql-database-intelligent-insights-troubleshoot-performance.md#elastic-pool-dtu-shortage) | エラスティック プールで使用できる eDTU が不足し、SQL Database のパフォーマンスに影響を与えています。 | Managed Instance は仮想コア モデルを使用しているので、Managed Instance には使用できません。 |
| [プランの回帰](sql-database-intelligent-insights-troubleshoot-performance.md#plan-regression) | 新しいプラン、または既存プランのワークロードの変更が検出されました。 これは SQL データベースのパフォーマンスに影響しています。 | 新しいプラン、または既存プランのワークロードの変更が検出されました。 これは SQL データベースのパフォーマンスに影響しています。 |
| [データベース スコープの構成値の変更](sql-database-intelligent-insights-troubleshoot-performance.md#database-scoped-configuration-value-change) | データベースのパフォーマンスに影響する SQL データベースの構成の変更が検出されました。 | データベースのパフォーマンスに影響するデータベースの構成の変更が検出されました。 |
| [処理速度が遅いクライアント](sql-database-intelligent-insights-troubleshoot-performance.md#slow-client) | 処理速度が遅いアプリケーション クライアントは、データベースからの出力を適切な速度で処理できません。 これは SQL データベースのパフォーマンスに影響しています。 | 処理速度が遅いアプリケーション クライアントは、データベースからの出力を適切な速度で処理できません。 これは SQL データベースのパフォーマンスに影響しています。 |
| [価格レベルのダウングレード](sql-database-intelligent-insights-troubleshoot-performance.md#pricing-tier-downgrade) | 価格レベルのダウングレード アクションによって、使用できるリソースが減りました。 これは SQL データベースのパフォーマンスに影響しています。 | 価格レベルのダウングレード アクションによって、使用できるリソースが減りました。 これは SQL データベースのパフォーマンスに影響しています。 |

> [!TIP]
> SQL Database のパフォーマンスを継続的に最適化するには、[Azure SQL Database の自動チューニング](https://docs.microsoft.com/azure/sql-database/sql-database-automatic-tuning)を有効にします。 この SQL Database に組み込まれているインテリジェンスの固有機能は、SQL データベースを継続的に監視し、インデックスを自動的に調整して、クエリ実行プランの修正を適用します。
>

次のセクションでは、検出可能なパフォーマンス パターンについてさらに詳しく説明します。

## <a name="reaching-resource-limits"></a>リソースの上限に到達

### <a name="what-is-happening"></a>状況

この検出可能なパフォーマンス パターンは、使用可能なリソースの上限、worker の上限、およびセッションの上限への到達に関連するパフォーマンスの問題を組み合わせたものです。 このパフォーマンスの問題が検出されると、診断ログの説明フィールドに、パフォーマンスの問題がリソース、worker、セッションの上限のいずれに関連しているかが示されます。

SQL Database 上のリソースは、通常、[DTU](https://docs.microsoft.com/azure/sql-database/sql-database-what-is-a-dtu) リソースまたは[仮想コア](https://docs.microsoft.com/azure/sql-database/sql-database-service-tiers-vcore) リソースと呼ばれます。 リソースの上限への到達パターンが認識されるのは、検出されたクエリ パフォーマンスの低下が、測定されるリソース上限のいずれかに到達したことによって生じている場合です。

セッション上限のリソースは、SQL データベースに同時にログインできる数を示します。 このパフォーマンス パターンは、SQL データベースに接続しているアプリケーションが、データベースに同時にログインできる数に到達した場合に認識されます。 データベースで利用できる数よりも多くのセッションをアプリケーションが使用しようとすると、クエリのパフォーマンスが影響を受けます。

利用可能な worker は DTU または仮想コアの使用量としてカウントされないため、worker の上限に到達するということは、リソース上限に到達する中でも特殊な場合です。 データベースで worker の上限に到達すると、リソース固有の待機時間が上昇するため、クエリのパフォーマンス低下につながります。

### <a name="troubleshooting"></a>トラブルシューティング

診断ログには、パフォーマンスとリソース使用率に影響を与えたクエリのクエリ ハッシュが出力されます。 データベースのワークロードを最適化するための出発点として、この情報を使うことができます。 具体的には、インデックスを追加して、パフォーマンスの低下に影響するクエリを最適化できます。 または、より均等にワークロードを分散させることで、アプリケーションを最適化できます。 ワークロードの削減や最適化が難しい場合は、SQL データベース サブスクリプションの価格レベルを上げて、使用可能なリソースの量を増やすことを検討します。

使用可能なセッションの上限に到達した場合は、データベースへのログイン数を減らすことで、アプリケーションを最適化できます。 アプリケーションからデータベースへのログイン数を減らすことができない場合は、データベースの価格レベルを上げることを検討します。 または、データベースを分割して複数のデータベースに移動させ、より均等にワークロードを分散させることができます。

セッションの上限に対応するためのその他の推奨事項については、「[How to deal with the limits of Azure SQL Database maximum logins](https://blogs.technet.microsoft.com/latam/2015/06/01/how-to-deal-with-the-limits-of-azure-sql-database-maximum-logins/)」(Azure SQL Database の最大ログイン数の上限に対応する方法) をご覧ください。 サーバーおよびサブスクリプション レベルの制限については、[論理サーバー上のリソース制限の概要](sql-database-resource-limits-logical-server.md)に関するページをご覧ください。

## <a name="workload-increase"></a>ワークロードの増加

### <a name="what-is-happening"></a>状況

このパフォーマンス パターンは、ワークロードの増加、またはより重大なワークロードの累積によって生じる問題を表します。

いくつかの指標を組み合わせることで検出されます。 測定された基本的な指標によって、過去のワークロード ベースラインとの比較により、ワークロードの増加が検出されます。 その他の形式の検出は、クエリのパフォーマンスに影響を与えるほど大きな、アクティブなワーカー スレッド数の増加の測定に基づいています。

より重大なのは、SQL データベースがワークロードを処理できないことにより、ワークロードが継続的に累積する場合です。 その場合、ワークロードのサイズが増大し続けて、ワークロードの累積状態が発生します。 この状態のため、ワークロードが実行を待機する時間が長くなります。 この状態は、最も重大なデータベース パフォーマンスの問題の 1 つです。 この問題は、中止されたワーカー スレッド数の増加を監視することで検出されます。 

### <a name="troubleshooting"></a>トラブルシューティング

診断ログには、実行回数が増加したクエリの数、およびワークロードの増加に最も影響を与えているクエリのクエリ ハッシュが出力されます。 ワークロードを最適化するための出発点として、この情報を使うことができます。 ワークロード増加の最大の原因として特定されたクエリは、出発点として特に有効です。

データベースにワークロードをより均等に配分することを検討できる場合があります。 インデックスを追加して、パフォーマンスに影響するクエリの最適化を検討します。 また、複数のデータベースにワークロードを分散できる可能性もあります。 これらの解決策が不可能な場合は、SQL データベース サブスクリプションの価格レベルを上げて、使用可能なリソースの量を増やすことを検討します。

## <a name="memory-pressure"></a>メモリ不足

### <a name="what-is-happening"></a>状況

このパフォーマンス パターンは、過去 7 日間のパフォーマンス ベースラインとの比較により、メモリ不足によって生じた現在のデータベース パフォーマンスの低下、またはより重大なメモリの停滞状態を表します。

メモリ不足は、SQL データベースでメモリ許可を要求するワーカー スレッドの数が非常に多いパフォーマンスの状態を表します。 これにより、メモリ使用率が高い状態が発生し、SQL データベースがメモリを要求するすべてのワーカーに効率的にメモリを割り当てることが困難になります。 この問題の最も一般的な理由の 1 つは、SQL データベースが使用できるメモリの量に関連します。 その一方で、ワークロードが増加すると、ワーカー スレッドが増えてメモリ不足が発生します。

より重大なメモリ不足の形態は、メモリ要求が累積した状態です。 このような状況は、メモリ許可を要求しているワーカー スレッドの数の方が、メモリを解放しているクエリより多いことを示します。 また、SQL データベース エンジンが効率的にメモリを割り当てて要求を満たすことができないため、メモリ許可を要求するワーカー スレッド数が増加し続ける (累積状態になる) こともあります。 メモリ累積状態は、データベースのパフォーマンスに関する最も重大な問題の 1 つです。

### <a name="troubleshooting"></a>トラブルシューティング

診断ログには、メモリ使用量が多くなっている最大の要因としてマーク付けされたクラーク (つまりワーカー スレッド) のメモリ オブジェクトの保存詳細と、関連するタイムスタンプが出力されます。 トラブルシューティングのための基準としてこの情報を使うことができます。 

メモリ使用量の多さの要因であるクラークに関連するクエリを、最適化または削除することができます。 また、使う予定のないデータをクエリしていないかどうかを確認できます。 クエリでは常に WHERE 句を使用することをお勧めします。 さらに、データをスキャンするのではなくシークするように、非クラスター化インデックスを作成することをお勧めします。

最適化したり、複数のデータベースに分散させたりすることで、ワークロードを減らすこともできます。 または、ワークロードを複数のデータベースに分散させることができます。 これらの解決策が不可能な場合は、SQL データベース サブスクリプションの価格レベルを上げて、データベースで使用可能なメモリ リソースの量を増やすことを検討します。

トラブルシューティングのその他の提案については、[Memory grants meditation:The mysterious SQL Server memory consumer with many names](https://blogs.msdn.microsoft.com/sqlmeditation/2013/01/01/memory-meditation-the-mysterious-sql-server-memory-consumer-with-many-names/)」(メモリ許可に関する考察: さまざまな名前を持つ、SQL Server の不可解なメモリ コンシューマー) をご覧ください。

## <a name="locking"></a>ロック

### <a name="what-is-happening"></a>状況

このパフォーマンス パターンは、過去 7 日間のパフォーマンス ベースラインとの比較により、データベースの過剰なロックが検出された、現在のデータベース パフォーマンスの低下を表します。 

最新の RDBMS では、マルチスレッド化されたシステムを実装するために、ロックが不可欠です。そこでは、複数の worker を同時に実行し、可能な場合はデータベースでトランザクションを並列処理して、パフォーマンスが最大化されます。 この場合のロックは、1 つのトランザクションのみが必要かつ他のリソースのトランザクションと競合しない行、ページ、表、ファイルに排他的にアクセスできる、組み込みのアクセス メカニズムを指します。 リソースの使用をロックしたトランザクションでリソースの使用が完了すると、これらのリソースのロックが解除されて、他のトランザクションが必要なリソースにアクセスできるようになります。 ロックについて詳しくは、「[データベース エンジンのロック](https://msdn.microsoft.com/library/ms190615.aspx)」をご覧ください。

SQL エンジンで実行されたトランザクションが、使用がロックされたリソースにアクセスするために長時間待機している場合は、この待機時間がワークロード実行のパフォーマンス低下の原因になります。 

### <a name="troubleshooting"></a>トラブルシューティング

診断ログには、トラブルシューティングのときに基本情報として使うことができる、ロックの詳細が出力されます。 報告されたブロッキング クエリ、つまりロックのパフォーマンス低下を引き起こすクエリを分析して、それらを削除できます。 場合によっては、ブロッキング クエリを最適化できることもあります。

問題を緩和する最も簡単で安全な方法は、トランザクションを常に短くして、最もコストの高いクエリのロック フットプリントを低減させることです。 大きい操作のバッチを小さい操作に分割できます。 クエリをできるだけ効率化して、クエリのロック フットプリントを低減させることをお勧めします。 大規模なスキャンは、デッドロックの可能性を高め、データベースの全体のパフォーマンスに悪影響を及ぼすので、減らします。 ロックの原因として特定されたクエリについては、新しいインデックスを作成したり、既存のインデックスに列を追加したりして、テーブル スキャンを回避できます。 

その他の推奨事項については、「[SQL Server でロックのエスカレーションが原因で発生するブロッキング問題を解決する方法](https://support.microsoft.com/help/323630/how-to-resolve-blocking-problems-that-are-caused-by-lock-escalation-in)」をご覧ください。

## <a name="increased-maxdop"></a>MAXDOP の増加

### <a name="what-is-happening"></a>状況

この検出可能なパフォーマンス パターンは、選択されたクエリの実行プランが必要以上に並列処理されている状態を表します。 SQL Database のクエリ オプティマイザーは、可能であればクエリを同時実行して処理を高速化し、ワークロードのパフォーマンスを向上させます。 場合によっては、同じクエリを少数の並列 worker で実行する場合と比較しても、さらには 1 つのワーカー スレッドで実行する場合と比較しても、クエリを並列 worker で処理する方が、相互に結果を同期しマージするための待機に多くの時間を費やすことがあります。

エキスパート システムは、ベースラインの期間と比較して現在のデータベースのパフォーマンスを分析し、 クエリ実行プランが必要以上に並列化されたために、クエリの実行が以前より遅くなったかどうかを判断します。

同じクエリの並列実行に使われる CPU コア数の制御には、SQL Database の MAXDOP サーバー構成オプションが使われます。 

### <a name="troubleshooting"></a>トラブルシューティング

診断ログには、必要以上に並列処理されているために実行時間が増加しているクエリに関連するクエリ ハッシュが出力されます。 また、CXP 待機時間も出力されます。 この時間は、1 つのオーガナイザーまたはコーディネーター スレッド (thread 0) が、結果をマージして先に進む前に、他のすべてのスレッドが終了するのを待機している時間を表します。 さらに、診断ログには、パフォーマンスの低いクエリが実行で待機していた全体の待機時間も出力されます。 トラブルシューティングのための基準としてこの情報を使うことができます。

最初に、複雑なクエリを最適化または単純化します。 長いバッチ ジョブを細かく分割することをお勧めします。 さらに、クエリをサポートするためのインデックスを作成したことを確認します。 また、パフォーマンスが低いことを示すフラグが設定されたクエリに対しては、最大限の並列化 (MAXDOP) を手動で強制することもできます。 T-SQL を使ってこの操作を構成する方法については、「[max degree of parallelism サーバー構成オプションの構成](https://docs.microsoft.com/sql/database-engine/configure-windows/configure-the-max-degree-of-parallelism-server-configuration-option)」をご覧ください。

MAXDOP サーバー構成オプションを既定値のゼロ (0) に設定すると、SQL Database は、使用可能なすべての論理 CPU コアを 1 つのクエリを実行するスレッドの並列処理に使うことができます。 MAXDOP を 1 に設定することは、1 つのクエリ実行に使えるコアが 1 つだけであることを示します。 実際には、これは並列処理がオフであるという意味です。 場合によっては、データベースで使用できるコア数、および診断ログの情報に応じて、MAXDOP オプションを調整し、クエリの並列実行に使用できるコア数をそれぞれのケースで問題を解決できる可能性がある値に設定できます。

## <a name="pagelatch-contention"></a>ページラッチの競合

### <a name="what-is-happening"></a>状況

このパフォーマンス パターンは、過去 7 日間のワークロード ベースラインとの比較により、ページラッチの競合によって、現在のデータベースのワークロード パフォーマンスが低下していることを表します。

ラッチは、マルチスレッドを有効にするために SQL Database によって使われる軽量の同期メカニズムです。 インデックス、データ ページ、その他の内部構造を含むメモリ内構造の一貫性を保証します。

SQL データベースではさまざまな種類のラッチを使うことができます。 単純化のため、バッファー プールのメモリ内ページの保護にはバッファー ラッチが使われます。 バッファー プールにまだ読み込まれていないページの保護には、IO ラッチが使われます。 バッファー プールのページにデータを書き込んだり、ページからデータを読み取ったりする場合、ワーカー スレッドはまずそのページのバッファー ラッチを取得する必要があります。 メモリ内のバッファー プールにまだないページにワーカー スレッドがアクセスを試みると、記憶域から必要な情報を読み込むための IO 要求が生成されます。 このイベント シーケンスは、より重大なパフォーマンスの低下を示します。

ページ ラッチの競合は、複数のスレッドが同じメモリ内の構造で同時にラッチを取得しようとする場合に発生し、クエリ実行の待機時間が増加します。 記憶域からデータにアクセスする必要があるページラッチの IO の競合では、この待機時間がさらに増加します。 これは、ワークロードのパフォーマンスに大きく影響する可能性があります。 ページ ラッチの競合は、スレッドが互いに待機し、複数の CPU システムのリソースにおいて競合する、最も一般的なシナリオです。

### <a name="troubleshooting"></a>トラブルシューティング

診断ログには、ページラッチの競合の詳細が出力されます。 トラブルシューティングのための基準としてこの情報を使うことができます。

ページラッチは SQL Database の内部制御メカニズムであるため、使用のタイミングは自動的に決定されます。 スキーマ デザインを含むアプリケーションの決定は、ラッチの決定論的なビヘイビアーにより、ページラッチの動作に影響を与えます。

ラッチの競合を処理する方法の 1 つは、連続したインデックス キーを連番でないキーに置き換えて、インデックスの範囲に挿入を均等に分散することです。 通常、インデックスの先頭列がワークロードを比例的に配分します。 検討すべきもうひとつの方法は、テーブル パーティションです。 パーティション テーブルの計算列でハッシュ パーティション分割のスキーマを作成することは、ラッチの過剰な競合を軽減するための一般的な方法です。 ページラッチの IO 競合の場合、インデックスの導入がパフォーマンスの問題の軽減に役立ちます。 

詳しくは、「[Diagnose and resolve latch contention on SQL Server](https://download.microsoft.com/download/B/9/E/B9EDF2CD-1DBF-4954-B81E-82522880A2DC/SQLServerLatchContention.pdf)」(SQL Server でのラッチの競合の診断と対応) (PDF をダウンロード) をご覧ください。

## <a name="missing-index"></a>インデックスの不足

### <a name="what-is-happening"></a>状況

このパフォーマンス パターンは、過去 7 日間のベースラインとの比較により、インデックスの不足によって、現在のデータベースのワークロード パフォーマンスが低下していることを表します。

インデックスは、クエリのパフォーマンスを高速化するために使用されます。 アクセスまたはスキャンする必要があるデータセットのページ数を削減して、テーブル データへのすばやいアクセスを提供します。

インデックスの作成がパフォーマンスの向上に役立つと考えられる、パフォーマンス低下の原因となったクエリがこの検出によって特定されます。

### <a name="troubleshooting"></a>トラブルシューティング

診断ログには、ワークロードのパフォーマンスに影響を与えることが認められたクエリのクエリ ハッシュが出力されます。 これらのクエリに対してインデックスを作成できます。 また、クエリを最適化したり、必要ない場合はクエリを削除することもできます。 良好なパフォーマンスのためには、使わないデータはクエリしないことをお勧めします。

> [!TIP]
> SQL Database は組み込みのインテリジェンスによって、データベースに最適なインデックスを自動管理します。
>
> SQL Database のパフォーマンスを継続的に最適化するには、[Azure SQL Database の自動チューニング](sql-database-automatic-tuning.md)を有効にすることをお勧めします。 この SQL Database に組み込まれているインテリジェンスの固有機能は、SQL データベースを継続的に監視し、データベースのインデックスを自動的に調整して作成します。
>

## <a name="new-query"></a>新しいクエリ

### <a name="what-is-happening"></a>状況

このパフォーマンス パターンは、過去 7 日間のパフォーマンス ベースラインとの比較により、パフォーマンスが低く、ワークロードのパフォーマンスに影響を与える新しいクエリが検出されたことを表します。

優れたパフォーマンスのクエリを作成することは、困難なタスクです。 クエリの作成について詳しくは、[クエリの作成](https://msdn.microsoft.com/library/bb264565.aspx)に関するページをご覧ください。 既存のクエリのパフォーマンスを最適化する方法については、「[クエリのチューニング](https://msdn.microsoft.com/library/ms176005.aspx)」をご覧ください。

### <a name="troubleshooting"></a>トラブルシューティング

診断ログには、CPU 使用量が最も高い、最大 2 つの新しいクエリの情報 (クエリ ハッシュを含む) が出力されます。 検出されたクエリはワークロードのパフォーマンスに影響を与えるので、クエリを最適化できます。 使う必要があるデータだけを取得することが、よい方法です。 また、クエリで WHERE 句を使うこともお勧めします。 あるいは、複雑なクエリを単純化し、小さいクエリに分割することもお勧めします。 もう 1 つのよい方法は、大きいバッチ クエリを小さいバッチ クエリに分割することです。 通常、このパフォーマンスの問題を軽減するには、新しいクエリにインデックスを導入することをお勧めします。

[Azure SQL Database Query Performance Insight](sql-database-query-performance.md) を使うことを検討してください。

## <a name="increased-wait-statistic"></a>待機の増加の統計

### <a name="what-is-happening"></a>状況

この検出可能なパフォーマンス パターンは、過去 7 日間のワークロード ベースラインと比較してパフォーマンスの低いクエリが検出された場合の、ワークロードのパフォーマンスの低下を表します。

この場合、システムは他の検出可能な標準パフォーマンス カテゴリの低パフォーマンス クエリを分類することはできませんが、回帰の原因である待機の統計を検出しました。 したがって、それらを "*待機の増加の統計*" のクエリと見なし、回帰の原因である特殊な待機統計も公開されます。 

### <a name="troubleshooting"></a>トラブルシューティング

診断ログには、待機時間の増加の詳細と影響を受けたクエリのクエリ ハッシュに関する情報が出力されます。

システムでパフォーマンスの低いクエリの根本原因を特定できなかったため、診断情報が手動でトラブルシューティングを行うための第一歩として役立ちます。 これらのクエリのパフォーマンスを最適化することができます。 使う必要のあるデータだけをフェッチして単純化し、複雑なクエリは細かく分割することをお勧めします。 

クエリのパフォーマンスの最適化について詳しくは、「[クエリのチューニング](https://msdn.microsoft.com/library/ms176005.aspx)」をご覧ください。

## <a name="tempdb-contention"></a>TempDB の競合

### <a name="what-is-happening"></a>状況

この検出可能なパフォーマンス パターンは、TempDB リソースへのアクセスを試みるスレッドのボトルネックが存在するデータベース パフォーマンスの状態を示します  (この状態は IO に関連していません)。このパフォーマンスの問題の一般的なシナリオは、数百の同時実行クエリのすべてが小さい tempDB テーブルを作成して、使用し、ドロップすることです。 システムは、過去 7 日間のパフォーマンス ベースラインとの比較により、同じ tempDB テーブルを使う同時実行クエリ数の増加において十分に統計上有意であることが認められ、データベースのパフォーマンスに影響を与えていることを検出しました。

### <a name="troubleshooting"></a>トラブルシューティング

診断ログには、tempDB の競合の詳細が出力されます。 トラブルシューティングの出発点としてこの情報を使うことができます。 この種の競合を軽減し、ワークロード全体のスループットを増やすためにできることが 2 つあります。まず、一時テーブルの使用をやめることができます。 また、メモリ最適化テーブルを使うこともできます。 

詳しくは、「[メモリ最適化テーブルの概要](https://docs.microsoft.com/sql/relational-databases/in-memory-oltp/introduction-to-memory-optimized-tables)」をご覧ください。 

## <a name="elastic-pool-dtu-shortage"></a>エラスティック プールの DTU の不足

### <a name="what-is-happening"></a>状況

この検出可能なパフォーマンス パターンは、過去 7 日間のベースラインとの比較により、現在のデータベースのワークロード パフォーマンスが低下していることを示します。 原因は、サブスクリプションのエラスティック プールで使用可能な DTU の不足です。 

SQL Database のリソースは通常 [DTU リソース](sql-database-service-tiers.md#dtu-based-purchasing-model)と呼ばれ、CPU と IO (データおよびトランザクション ログ IO) リソースを組み合わせたメジャーで構成されます。 [Azure エラスティック プールのリソース](sql-database-elastic-pool.md)は、複数のデータベース間でスケーリングのために共有される、使用可能な eDTU リソースのプールとして使用されます。 エラスティック プールで使用可能な eDTU リソースが、プール内のすべてのデータベースのサポートには足りない場合、エラスティック プールの DTU の不足というパフォーマンスの問題がシステムで検出されます。

### <a name="troubleshooting"></a>トラブルシューティング

診断ログには、エラスティック プールに関する情報が出力され、DTU を最も多く消費しているデータベースが一覧表示されるとともに、消費量が最も多いデータベースによるプールの DTU 使用率が提供されます。

このパフォーマンスの状態は、エラスティック プール内で同じプールの eDTU を使用する複数のデータベースに関連しているため、トラブルシューティングの手順では、DTU を最も多く消費するデータベースに注目します。 このようなデータベースでの使用量が最も多いクエリの最適化も含めて、消費量が最も多いデータベースのワークロードを削減できます。 また、使わないデータのクエリを行っていないことを確認できます。 そのほかの方法としては、DTU を最も多く消費するデータベースを使用するアプリケーションの最適化と、複数のデータベース間でのワークロードの再分配があります。

DTU を最も多く消費するデータベースで、現在のワークロードを削除したり最適化したりすることが難しい場合は、エラスティック プールの価格レベルを上げることを検討します。 これにより、エラスティック プールで使用可能な DTU を増やすことができます。

## <a name="plan-regression"></a>プランの回帰

### <a name="what-is-happening"></a>状況

この検出可能なパフォーマンス パターンは、最適化されていないクエリ実行プランを SQL Database が利用している状態を示します。 通常、最適化されていないプランはクエリ実行回数の増加の原因となり、現在およびその他のクエリの待機時間の増加につながります。

SQL データベースでは、クエリ実行コストが最も低いクエリ実行プランが決定されます。 クエリの種類とワークロードが変更されると、既存のプランが効率的ではなくなったり、SQL Database で最適な評価が行われなかったりする場合があります。 修正については、クエリの実行プランは手動で適用できます。

この検出可能なパフォーマンス パターンでは、プラン回帰の 3 つの異なるケース (新しいプランへの回帰、前のプランへの回帰、ワークロードが変更された既存のプランへの回帰) が組み合わされています。 発生した具体的なプラン回帰の種類は、診断ログの "*詳細*" プロパティで提供されます。

新しいプランへの回帰の状態は、前のプランほど効率的ではない、新しいクエリ実行プランの実行が SQL Database で開始されている状態を表します。 前のプランへの回帰の状態は、SQL Database で、新しくより効率的なプランから、新しいプランほど効率的ではない前のプランの使用に切り替わった状態を表します。 ワークロードが変更された既存のプランへの回帰は、前のプランと新しいプランが継続的に交互に行われつつ、パフォーマンスの低いプランへの比重が高まっている状態を表します。

プランの回帰について詳しくは、「[What is plan regression in SQL Server?](https://blogs.msdn.microsoft.com/sqlserverstorageengine/2017/06/09/what-is-plan-regression-in-sql-server/)」(SQL server のプランの回帰とは) をご覧ください。 

### <a name="troubleshooting"></a>トラブルシューティング

診断ログには、クエリ ハッシュ、適切なプランの ID、不適切なプランの ID、およびクエリの ID が出力されます。 トラブルシューティングのための基準としてこの情報を使うことができます。

提供されたクエリ ハッシュを使用して特定できるクエリに対して、どのプランのパフォーマンスが優れているかを分析できます。 クエリに対してパフォーマンスが優れているプランを判断した後、手動で適用できます。 

詳しくは、「[Learn how SQL Server prevents plan regressions](https://blogs.msdn.microsoft.com/sqlserverstorageengine/2017/04/25/you-shall-not-regress-how-sql-server-2017-prevents-plan-regressions/)」(SQL Server がプランの回帰を回避するしくみ) をご覧ください。

> [!TIP]
> SQL Database では組み込みのインテリジェンスによって、データベースに最適なクエリ実行プランを自動管理します。
>
> SQL Database のパフォーマンスを継続的に最適化するには、[Azure SQL Database の自動チューニング](sql-database-automatic-tuning.md)を有効にすることをお勧めします。 この SQL Database に組み込まれているインテリジェンスの固有機能は、SQL データベースを継続的に監視し、自動的に調整を行って、データベースに対するパフォーマンスが最高のクエリ実行プランを作成します。
>

## <a name="database-scoped-configuration-value-change"></a>データベース スコープの構成値の変更

### <a name="what-is-happening"></a>状況

この検出可能なパフォーマンス パターンは、データベース スコープの構成が変更されたことで、過去 7 日間のワークロードの動作と比較して、パフォーマンスの低下が検出された状態を表します。 このパターンは、データベース スコープの構成に加えられた最近の変更が、データベースのパフォーマンスに有益ではないと考えられることを示します。

データベース スコープの構成の変更は、個々のデータベースごとに設定できます。 この構成は、データベースの個々のパフォーマンスを最適化するために、それぞれのケースに応じて使用します。 個別のデータベースごとに、MAXDOP、LEGACY_CARDINALITY_ESTIMATION、PARAMETER_SNIFFING、QUERY_OPTIMIZER_HOTFIXES、CLEAR PROCEDURE_CACHE のオプションを構成できます。

### <a name="troubleshooting"></a>トラブルシューティング

診断ログには、過去 7 日間のワークロードの動作と比較して、パフォーマンスの低下の原因となった、最近加えられたデータベース スコープの構成の変更が出力されます。 構成の変更を前の値に元に戻すことができます。 目的のパフォーマンス レベルに達するまで、値を 1 つずつチューニングすることもできます。 満足のいくパフォーマンスを達成している同様のデータベースから、データベース スコープの構成値をコピーできます。 パフォーマンスのトラブルシューティングが難しい場合は、SQL Database の既定値に戻して、この基準値から微調整を行います。

データベース スコープの構成の最適化と、構成の変更に使用する T-SQL 構文について詳しくは、「[ALTER DATABASE SCOPED CONFIGURATION (Transact-SQL)](https://msdn.microsoft.com/library/mt629158.aspx)」をご覧ください。

## <a name="slow-client"></a>処理速度が低いクライアント

### <a name="what-is-happening"></a>状況

この検出可能なパフォーマンス パターンは、SQL データベースを使っているクライアントが、データベースが結果を送信するのと同じ速度で、データベースからの出力データを処理できない状態を示します。 SQL Database は実行されたクエリの結果をバッファーに格納しないため、速度を下げて、送信されたクエリの出力をクライアントが処理するまで待機してから続行します。 この状態は、SQL データベースからの出力データを使用するクライアントに対して、十分な速度でデータを送信できないネットワークに関連する場合もあります。

過去 7 日間のワークロードの動作と比較して、パフォーマンスの低下が検出された場合にのみ、この状態が生成されます。 このパフォーマンスの問題は、過去のパフォーマンスの動作と比較して、統計的に有意なパフォーマンスの低下が発生している場合にのみ検出されます。

### <a name="troubleshooting"></a>トラブルシューティング

この検出可能なパフォーマンス パターンは、クライアント側の状態を示します。 クライアント側のアプリケーションまたはネットワークでのトラブルシューティングが必要です。 診断ログには、過去 2 時間以内にクライアントによる処理を最も長い時間待機したクエリのクエリ ハッシュと待機時間が出力されます。 トラブルシューティングのための基準としてこの情報を使うことができます。

これらのクエリの使用に関して、アプリケーションのパフォーマンスを最適化できます。 発生する可能性のあるネットワーク待機時間の問題について考えることもできます。 パフォーマンス低下の問題は過去 7 日間のパフォーマンス ベースラインの変化に基づくものだったので、最近のアプリケーションやネットワークの状態の変化によりこのパフォーマンス回帰イベントが発生したどうかを調査することができます。 

## <a name="pricing-tier-downgrade"></a>価格レベルのダウングレード

### <a name="what-is-happening"></a>状況

この検出可能なパフォーマンス パターンは、SQL Database サブスクリプションの価格レベルがダウングレードされたことを示します。 データベースで使用できるリソース (DTU) の減少により、過去 7 日間のベースラインと比較して、現在のデータベースのパフォーマンスが低下していることがシステムで検出されています。

この他に、SQL Database サブスクリプションの価格レベルがダウングレードされた後、短期間内に上位レベルにアップグレードされた可能性もあります。 この一時的なパフォーマンス低下の検出は、診断ログの詳細セクションには価格レベルのダウングレードとアップグレードとして出力されます。

### <a name="troubleshooting"></a>トラブルシューティング

価格レベルを下げたことにより SQL Database で使用できる DTU が減少しても、パフォーマンスに満足している場合は、対応の必要はありません。 価格レベルを下げた後で SQL データベースのパフォーマンスに満足できなくなった場合は、データベースのワークロードを削減するか、価格レベルを上位に引き上げることを検討します。

## <a name="recommended-troubleshooting-flow"></a>推奨されるトラブルシューティングのフロー

 Intelligent Insights を使ったパフォーマンスのトラブルシューティングのお勧めの方法については、フローチャートに従ってください。

Azure SQL Analytics に移動して、Azure Portal から Intelligent Insights にアクセスします。 受信したパフォーマンス アラートを検索して選びます。 検出ページで現在の状況を確認します。 問題の根本原因の解析、クエリ テキスト、クエリの時間の傾向、およびインシデントの展開に関する情報をよく読みます。 パフォーマンスの問題の軽減に関する Intelligent Insights の推奨事項を使って、問題の解決を試みます。 

[![トラブルシューティングのフローチャート](./media/sql-database-intelligent-insights/intelligent-insights-troubleshooting-flowchart.png)](https://github.com/Microsoft/sql-server-samples/blob/master/samples/features/intelligent-insight/Troubleshoot%20Azure%20SQL%20Database%20performance%20issues%20using%20Intelligent%20Insight.pdf)

> [!TIP]
> PDF バージョンをダウンロードするには、フローチャートを選びます。

Intelligent Insights では、パフォーマンスの問題の根本原因の解析に通常 1 時間かかります。 Intelligent Insights で問題を見つけることができず、問題を見つけることが重要であるときは、クエリ データ ストアを使って、手動でパフォーマンスの問題の根本原因を特定します  (通常、これらの問題とは 1 時間以内のものです)。詳しくは、「[クエリのストアを使用した、パフォーマンスの監視](https://docs.microsoft.com/sql/relational-databases/performance/monitoring-performance-by-using-the-query-store)」をご覧ください。

## <a name="next-steps"></a>次の手順
- [Intelligent Insights](sql-database-intelligent-insights.md) の概念の習得。
- [Intelligent Insights Azure SQL Database パフォーマンス診断ログ](sql-database-intelligent-insights-use-diagnostics-log.md)の使用。
- [Azure SQL Analytics を使用した Azure SQL Database](https://docs.microsoft.com/azure/log-analytics/log-analytics-azure-sql) の監視。
- [Azure リソースからのログ データの収集と使用](../azure-monitor/platform/diagnostic-logs-overview.md)の習得。
