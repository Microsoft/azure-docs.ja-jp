---
title: "障害復旧のアプリ設計 - Azure SQL Database | Microsoft Docs"
description: "geo レプリケーションを使った Azure SQL Database 障害復旧用のアプリケーション設計について説明します。"
keywords: "クラウド障害復旧, 障害復旧ソリューション, アプリ データのバックアップ, geo レプリケーション, クラウド ビジネス継続性計画"
services: sql-database
documentationcenter: 
author: anosov1960
manager: jhubbard
editor: monicar
ms.assetid: e8a346ac-dd08-41e7-9685-46cebca04582
ms.service: sql-database
ms.custom: business continuity
ms.devlang: NA
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: data-management
ms.date: 07/20/2016
ms.author: sashan
translationtype: Human Translation
ms.sourcegitcommit: 7e607debe47efb6a22ca6fa47a40554d13d29359
ms.openlocfilehash: dd56a8d1ee428b1845ed80f0b899cc73c2c4b7f6


---
# <a name="application-design-for-cloud-disaster-recovery-using-active-geo-replication-in-sql-database"></a>SQL Database のアクティブ geo レプリケーションを使ったクラウド障害復旧用のアプリケーション設計
> [!NOTE]
> すべてのレベルのすべてのデータベースで [アクティブ geo レプリケーション](sql-database-geo-replication-overview.md) を使用できるようになりました。
>
>

ここでは、SQL Database の [アクティブ geo レプリケーション](sql-database-geo-replication-overview.md) を使用して、リージョンの障害や致命的な停止に対して回復性の高いデータベース アプリケーションを設計する方法について説明します。 ビジネス継続性の計画では、アプリケーションのデプロイ トポロジ、目標とするサービス レベル アグリーメント、トラフィック待機時間、コストを考慮します。 この記事では一般的なアプリケーション パターンを紹介したうえで、それぞれの選択肢の利点とトレードオフについて説明します。 エラスティック プールでのアクティブ geo レプリケーションについては、 [エラスティック プール障害復旧戦略](sql-database-disaster-recovery-strategies-for-applications-with-elastic-pool.md)に関するページを参照してください。

## <a name="design-pattern-1-active-passive-deployment-for-cloud-disaster-recovery-with-a-co-located-database"></a>設計パターン 1: アクティブ/パッシブ デプロイとデータベースの併置によるクラウド障害復旧
この設計パターンは、以下の特性を持ったアプリケーションに最適な選択肢です。

* アクティブ インスタンスが単一の Azure リージョンに存在する。
* データへの読み取り/書き込み (RW) アクセスに強く依存する。
* アプリケーション ロジックとデータベースを異なるリージョンに置いて接続することが、待機時間とトラフィック コストの面から許されない。    

すべてのアプリケーション コンポーネントに障害の影響が波及し、ひとつのまとまりとしてフェールオーバーする必要があるとき、このケースでは地域ごとの障害に対処するようにアプリケーションのデプロイ トポロジを最適化します。 地理的な冗長性を確保するために、アプリケーション ロジックとデータベースの両方が別のリージョンにレプリケートされますが、正常な状況下ではアプリケーション ワークロードの処理にそれらが使用されることはありません。 セカンダリ リージョンにおけるアプリケーションの構成には、セカンダリ データベースへの SQL 接続文字列を使用する必要があります。 [フェールオーバーによるルーティング方法](../traffic-manager/traffic-manager-configure-failover-routing-method.md)を使用するように Traffic Manager を設定します。  

> [!NOTE]
> [Azure traffic manager](../traffic-manager/traffic-manager-overview.md) は、あくまで例として使用しています。 フェールオーバーによるルーティング方法に対応していればどのような負荷分散ソリューションを使用してもかまいません。    
>
>

メイン アプリケーションのインスタンスに加え、T-SQL の読み取り専用 (RO) コマンドを定期的に発行してプライマリ データベースを監視する小さな [worker ロール アプリケーション](../cloud-services/cloud-services-choose-me.md#tellmecs)をデプロイすることを検討してください。 このアプリケーションを使用すると、フェールオーバーを自動的にトリガーすること、アプリケーションの管理コンソールにアラートを発生させること、またはその両方を実行することができます。 リージョン全体が停止しても監視機能に影響が及ばないように、監視アプリケーションのインスタンスをすべてのリージョンにデプロイします。このとき、各インスタンスの接続先は、プライマリ リージョンのプライマリ データベースとローカル リージョンのセカンダリ データベースになります。

> [!NOTE]
> 両方の監視アプリケーションをアクティブにし、プライマリとセカンダリの両方のデータベースをプローブする必要があります。 セカンダリ データベースをプローブすることによってセカンダリ リージョンの障害を検出し、アプリケーションが保護されていない状態のときにアラートを発生させることができます。     
>
>

この構成の機能停止前の状態を示したのが次の図です。

![SQL Database の geo レプリケーションの構成。 Cloud disaster recovery.](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern1-1.png)

プライマリ リージョンの機能が停止すると、プライマリ データベースにアクセスできないことを監視アプリケーションが検出し、アラートを発生させます。 監視プローブが何回失敗したらデータベースの機能停止と見なすかは、アプリケーションの SLA に応じて指定してください。 アプリケーションのエンド ポイントとデータベースの同時フェールオーバーを実現するためには、監視アプリケーションで次の手順を実行する必要があります。

1. [プライマリ エンドポイントの状態を更新](https://msdn.microsoft.com/library/hh758250.aspx) して、エンドポイントのフェールオーバーをトリガーする。
2. セカンダリ データベースを呼び出して、 [データベースのフェールオーバーを開始](sql-database-geo-replication-portal.md)する。

フェールオーバー後は、ユーザー要求がセカンダリ リージョンで処理されますが、その時点でプライマリ データベースはセカンダリ リージョンに切り替わっているため、アプリケーションとデータベースは併置されたままになります。 次の図に、このシナリオを示します。 すべての図において実線はアクティブな接続を、点線は中断状態の接続を、通行止めの標識はアクション トリガーを示しています。

![geo レプリケーション: セカンダリ データベースへのフェールオーバー。 App data backup.](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern1-2.png)

セカンダリ リージョンの機能が停止した場合、プライマリ データベースとセカンダリ データベース間のレプリケーション リンクが中断状態となり、監視アプリケーションは、プライマリ データベースがレプリケーションされていないことを示すアラートを生成します。 この点がアプリケーションのパフォーマンスに影響を及ぼすことはありませんが、レプリケーションされていない状態で運用されることから、両方のリージョンに相次いで障害が発生した場合、リスクは増大します。

> [!NOTE]
> マイクロソフトで推奨しているのは、障害復旧リージョンを&1; つだけ使用したデプロイ構成のみです。 これは、Azure で地理的に割り当てられるリージョンがほとんどの場合&2; つであるためです。 これらの構成で、両方のリージョンの致命的な障害からアプリケーションを保護することはできません。 万一そのような障害が発生した場合は、[geo リストア操作](sql-database-disaster-recovery.md#recover-using-geo-restore)を使って、第&3; のリージョンのデータベースを復元することができます。
>
>

停止していた機能が復旧すると、セカンダリ データベースがプライマリ データベースと自動的に同期されます。 同期対象のデータの量によっては、プライマリのパフォーマンスが同期中やや低下する場合があります。 次の図は、セカンダリ リージョンの機能が停止した場合の例です。

![プライマリと同期されたセカンダリ データベース。 Cloud disaster recovery.](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern1-3.png)

この設計パターンの主な **利点** は次のとおりです。

* SQL 接続文字列が各リージョンへのアプリケーションのデプロイ時に設定され、フェールオーバー後に変化しない。
* アプリケーションとデータベースが常に併置されるので、フェールオーバーがアプリケーションのパフォーマンスに影響することはない。

一方、セカンダリ リージョンの冗長アプリケーション インスタンスが障害復旧にしか使用されないことが最大の **トレードオフ** となります。

## <a name="design-pattern-2-active-active-deployment-for-application-load-balancing"></a>設計パターン 2: アクティブ/アクティブ デプロイによるアプリケーション負荷分散
このクラウド障害復旧は、以下の特性を持ったアプリケーションに最適な選択肢です。

* データベースの書き込みに比べて読み取りの割合が大きい。
* データベース書き込みの待機時間がエンド ユーザーの使用感に影響しない。  
* 読み取り専用ロジックと読み取り/書き込みロジックを異なる接続文字列を使って分離できる。
* 読み取り専用ロジックが、データが直近の更新と完全に同期されていることを前提としない。  

開発するアプリケーションがこれらの特性を満たしている場合、リージョンの異なる複数のアプリケーション インスタンスにエンド ユーザーの接続を負荷分散することによって、パフォーマンスとエンド ユーザーの使用感を高めることができます。 そのためには、アクティブなアプリケーション インスタンスをすべてのリージョンに割り当てたうえで、読み取り/書き込み (RW) ロジックをプライマリ リージョンのプライマリ データベースに接続する必要があります。 読み取り専用 (RO) ロジックは、アプリケーション インスタンスとして同じリージョン内のセカンダリ データベースに接続する必要があります。 Traffic Manager は、[ラウンド ロビンによるルーティング](../traffic-manager/traffic-manager-configure-round-robin-routing-method.md)または[パフォーマンスによるルーティング](../traffic-manager/traffic-manager-configure-performance-routing-method.md)を使用するように設定し、[エンド ポイントの監視](../traffic-manager/traffic-manager-monitoring.md)を各アプリケーション インスタンスに対して有効にします。

パターン 1 と同様の監視アプリケーションをデプロイすることを検討してください。 ただし、パターン 1 とは異なり、この監視アプリケーションでエンド ポイントのフェールオーバーをトリガーする必要はありません。

> [!NOTE]
> このパターンでは複数のセカンダリ データベースを使用していますが、先ほど説明した理由から、フェールオーバーで使用されるセカンダリは&1; つだけです。 このパターンではセカンダリへの読み取り専用アクセスが必要となるため、アクティブ geo レプリケーションが必要です。
>
>

ユーザーの地理的位置に最も近接するアプリケーション インスタンスにユーザーからの接続を誘導するために、Traffic Manager は、パフォーマンスによるルーティングを使用するように設定します。 この構成の機能停止前の状態を示したのが次の図です。
![No outage: Performance routing to nearest application. Geo-Replication.](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern2-1.png)

プライマリ リージョンのデータベース機能の停止が検出された場合、いずれかのセカンダリ リージョンに対してプライマリ データベースのフェールオーバーを開始すると、プライマリ データベースの場所が変わります。 Traffic Manager は、オフラインとなったエンド ポイントをルーティング テーブルから自動的に除外しますが、残っているオンライン インスタンスには、エンド ユーザーのトラフィックをルーティングし続けます。 プライマリ データベースのリージョンが変化したので、接続先となる新しいプライマリに合わせて、すべてのオンライン インスタンスの読み取り/書き込み SQL 接続文字列を変更する必要があります。 この変更は、データベースのフェールオーバーを開始する前に行うことが大切です。 読み取り専用 SQL 接続文字列は常に同じリージョン内のデータベースを指しているので、変更の必要はありません。 フェールオーバーのステップは次のとおりです。  

1. 読み取り/書き込みの SQL 接続文字列を新しいプライマリに合わせて変更する。
2. 指定したセカンダリ データベースを呼び出して、 [データベースのフェールオーバーを開始](sql-database-geo-replication-portal.md)する。

次の図は、フェールオーバー後の新しい構成を示しています。
![Configuration after failover. Cloud disaster recovery.](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern2-2.png)

いずれかのセカンダリ リージョンの機能が停止した場合、Traffic Manager は、そのリージョンのオフライン エンド ポイントをルーティング テーブルから自動的に削除します。 そのリージョンのセカンダリ データベースへのレプリケーション チャンネルが中断状態となります。 残っているリージョンへのユーザー トラフィックが増えるという点で、機能が停止している間はアプリケーションのパフォーマンスに影響が生じます。 停止していた機能が復旧すると、影響のあったリージョンのセカンダリ データベースがプライマリ データベースと直ちに同期されます。 同期対象のデータの量によっては、プライマリのパフォーマンスが同期中やや低下する場合があります。 次の図は、セカンダリ リージョンの&1; つで機能が停止した場合の例です。

![Outage in secondary region. クラウドの障害復旧 - geo レプリケーション。](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern2-3.png)

この設計パターンの主な **利点** は、アプリケーション ワークロードを複数のセカンダリにスケールして最適なエンド ユーザー パフォーマンスを実現できることです。 このオプションの **トレードオフ** は次のとおりです。

* アプリケーション インスタンスとデータベースの間の読み取り/書き込み接続に関して待機時間とコストのばらつきが生じる
* 機能が停止している間、アプリケーションのパフォーマンスが影響を受ける
* データベースのフェールオーバー後、アプリケーションのインスタンスは SQL 接続文字列を動的に変更する必要がある  

> [!NOTE]
> 同様のアプローチで、レポート ジョブ、ビジネス インテリジェンス ツール、バックアップなど特定のワークロードの負荷を軽減することができます。 通常これらのワークロードはデータベースのリソースを著しく消費するため、予測されるワークロードに見合ったパフォーマンス レベルのセカンダリ データベースを&1; つ指定することをお勧めします。
>
>

## <a name="design-pattern-3-active-passive-deployment-for-data-preservation"></a>設計パターン 3: アクティブ/パッシブ デプロイによるデータ保存
この設計パターンは、以下の特性を持ったアプリケーションに最適な選択肢です。

* 少しのデータ損失も多大なビジネス リスクを招く。 データベースのフェールオーバーはあくまで、機能が完全に停止した場合の最終手段。
* しばらくの間アプリケーションを "読み取り専用モード" で動作させることができる。

このパターンでは、アプリケーションが、セカンダリ データベースに接続された時点で読み取り専用モードに切り替わります。 プライマリ リージョンのアプリケーション ロジックは、プライマリ データベースと併置され、読み取り/書き込みモード (RW) で動作します。 一方、セカンダリ リージョンのアプリケーション ロジックはセカンダリ データベースと併置され、読み取り専用モード (RO) で動作できる状態にあります。  Traffic Manager は、[フェールオーバーによるルーティング](../traffic-manager/traffic-manager-configure-failover-routing-method.md)を使用するように設定し、[エンドポイントの監視](../traffic-manager/traffic-manager-monitoring.md)を両方のアプリケーション インスタンスに対して有効にします。

この構成の機能停止前の状態を示したのが次の図です。
![Active-passive deployment before failover. Cloud disaster recovery.](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern3-1.png)

Traffic Manager は、プライマリ リージョンへの接続障害を検出すると、セカンダリ リージョンのアプリケーション インスタンスにユーザー トラフィックを自動的に切り替えます。 このパターンでは、機能停止が検出された後にデータベース フェールオーバーを開始 **しない** ことが大切です。 セカンダリ リージョンのアプリケーションは、セカンダリ データベースを使用して読み取り専用モードで起動、動作します。 これを示したのが次の図です。

![Outage: Application in read-only mode. Cloud disaster recovery.](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern3-2.png)

プライマリ リージョンの停止していた機能が回復すると、プライマリ リージョンの接続の復旧を Traffic Manager が検出し、ユーザー トラフィックをプライマリ リージョンのアプリケーション インスタンスに戻します。 プライマリ リージョンのアプリケーション インスタンスが再開し、プライマリ データベースを使用して読み取り/書き込みモードで動作します。

> [!NOTE]
> このパターンではセカンダリへの読み取り専用アクセスが必要となるため、アクティブ geo レプリケーションが必要です。
>
>

セカンダリ リージョンの機能が停止した場合、Traffic Manager は、プライマリ リージョンのアプリケーション エンド ポイントを "機能低下" として標識し、レプリケーション チャンネルは中断状態となります。 ただし、機能が停止している間もアプリケーションのパフォーマンスは低下しません。 停止していた機能が復旧すると、セカンダリ データベースがプライマリ データベースと直ちに同期されます。 同期対象のデータの量によっては、プライマリのパフォーマンスが同期中やや低下する場合があります。

![Outage: Secondary database. Cloud disaster recovery.](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern3-3.png)

この設計パターンには次のようにいくつかの **利点**があります。

* 一時的な機能停止の間、データ損失を防ぐことができる。
* Traffic Manager によって復旧がトリガーされるため、監視アプリケーションをデプロイする必要がない。
* ダウンタイムを左右するのは、Traffic Manager が接続障害を検出するのにかかる時間のみであり、その時間は設定によって変更可能。

**トレードオフ** は次のとおりです。

* アプリケーションが読み取り専用モードで動作できなければならない。
* 読み取り専用データベースに接続する際、動的に切り替える必要がある。
* 読み取り/書き込み動作を再開するためには、プライマリ リージョンの復旧が必要となるため、完全にデータが利用できるようになるまでには数時間、場合によっては数日かかる可能性もある。

> [!NOTE]
> 万一リージョンのサービス機能が完全に停止した場合は、データベースのフェールオーバーを手動で起動し、データの損失を受け入れる必要があります。 セカンダリ リージョンのアプリケーションが、データベースへの読み取り/書き込みアクセスが可能な状態で動作します。
>
>

## <a name="business-continuity-planning-choose-an-application-design-for-cloud-disaster-recovery"></a>ビジネス継続性計画: クラウド障害復旧用のアプリケーション設計を選択する
実際のクラウド障害復旧戦略では、対象アプリケーションのニーズに合わせて、これらの設計パターンを組み合わせたり拡張したりすることができます。  既に述べたように、選択すべき戦略は、利用者に提供する SLA とアプリケーションのデプロイ トポロジによって異なります。 以下の表では、意思決定の目安として推定データ損失つまり、回復ポイントの目標 (RPO) と推定復旧時間 (ERT) に基づいてそれぞれの選択肢を比較しています。

| パターン | RPO | ERT |
|:--- |:--- |:--- |
| アクティブ/パッシブ デプロイとデータベース併置による障害復旧 |読み取り/書き込みアクセス = 5 秒未満 |障害検出時間 + フェールオーバー API 呼び出し + アプリケーション検証テスト |
| アクティブ/アクティブ デプロイによるアプリケーション負荷分散 |読み取り/書き込みアクセス = 5 秒未満 |障害検出時間 + フェールオーバー API 呼び出し + SQL 接続文字列の変更 + アプリケーション検証テスト |
| アクティブ/パッシブ デプロイによるデータ保存 |読み取り専用アクセス = 5 秒未満、読み取り/書き込みアクセス = 0 |読み取り専用アクセス = 接続障害検出時間 + アプリケーション検証テスト  <br>読み取り/書き込みアクセス = 停止していた機能の回復にかかる時間 |

## <a name="next-steps"></a>次のステップ
* Azure SQL Database 自動バックアップの詳細については、「 [SQL Database automated backups (SQL Database 自動バックアップ)](sql-database-automated-backups.md)
* ビジネス継続性の概要およびシナリオについては、 [ビジネス継続性の概要](sql-database-business-continuity.md)
* 自動バックアップを使用して復旧する方法については、 [サービス主導のバックアップからのデータベース復元](sql-database-recovery-using-backups.md)
* より迅速な復旧オプションについては、 [アクティブ geo レプリケーション](sql-database-geo-replication-overview.md)  
* 自動バックアップを使用したアーカイブについては、 [データベースのコピー](sql-database-copy.md)
* エラスティック プールでのアクティブ geo レプリケーションについては、 [エラスティック プール障害復旧戦略](sql-database-disaster-recovery-strategies-for-applications-with-elastic-pool.md)に関するページを参照してください。



<!--HONumber=Jan17_HO4-->


