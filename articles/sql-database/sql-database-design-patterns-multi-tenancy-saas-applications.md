---
title: "マルチテナント SaaS アプリケーションと Azure SQL Database の設計パターン | Microsoft Docs"
description: "この記事では、クラウド環境で実行されるマルチテナント データベース アプリケーションで考慮する必要がある要件と一般的なデータ アーキテクチャ パターン、およびこれらのパターンに関連するさまざまなトレードオフについて説明します。 また、エラスティック プールとエラスティック ツールを備えた Azure SQL Database を使用して、妥協のない方法でこれらの要件に対応する方法についても説明します。"
keywords: 
services: sql-database
documentationcenter: 
author: srinia
manager: jhubbard
editor: 
ms.assetid: 1dd20c6b-ddbb-40ef-ad34-609d398d008a
ms.service: sql-database
ms.custom: development
ms.devlang: NA
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: sqldb-design
ms.date: 02/01/2017
ms.author: srinia
translationtype: Human Translation
ms.sourcegitcommit: e210fb7ead88a9c7f82a0d0202a1fb31043456e6
ms.openlocfilehash: c30f1d879f46805cf802679613089a16dc47ad40
ms.lasthandoff: 02/16/2017


---
# <a name="design-patterns-for-multitenant-saas-applications-and-azure-sql-database"></a>マルチテナント SaaS アプリケーションと Azure SQL Database の設計パターン
この記事では、クラウド環境で実行されるマルチテナント SaaS (サービスとしてのソフトウェア) データベース アプリケーションの要件と一般的なデータ アーキテクチャ パターンについて説明します。 また、考慮する必要がある要素と、さまざまな設計パターンのトレードオフについても説明します。 Azure SQL Database のエラスティック プールとエラスティック ツールを使用すると、他の目的を損なうことなく、特定の要件を満たすことができます。

開発者は、マルチテナント アプリケーションのデータ層のテナント モデルを設計するときに、長期的な最善の利益に反する選択を行う場合があります。 少なくとも初期の段階では、開発者はテナントの分離やアプリケーションのスケーラビリティよりも、開発の容易さとクラウド サービス プロバイダーのコストの削減の方が重要であると考えます。 この選択は顧客満足度の問題の原因となり、後でコストのかかる軌道修正が発生する可能性もあります。

マルチテナント アプリケーションとは、クラウド環境でホストされ、相互のデータを共有したり表示したりすることのない数百または数千のテナントにサービスの同じセットを提供するアプリケーションです。 一例として、クラウド ホスト環境でテナントにサービスを提供する SaaS アプリケーションがあります。

## <a name="multitenant-applications"></a>マルチテナント アプリケーション
マルチ テナント アプリケーションでは、データとワークロードを簡単にパーティション分割できます。 ほとんどの要求はテナントの境界内で行われるため、たとえば、テナント境界に沿ってデータとワークロードをパーティション分割できます。 この特性はデータとワークロードに固有であり、この記事で説明するアプリケーション パターンが優先されます。

開発者は、次のようなクラウド ベースのアプリケーションの全領域でこの種のアプリケーションを使用します。

* SaaS アプリケーションとしてクラウドに移行されるパートナーのデータベース アプリケーション
* クラウド向けに一から構築された SaaS アプリケーション
* 直接的な顧客向けアプリケーション
* 従業員向けエンタープライズ アプリケーション

クラウド向けに設計された SaaS アプリケーションと、本来はパートナーのデータベース アプリケーションである SaaS アプリケーションは、通常、マルチテナント アプリケーションになります。 これらの SaaS アプリケーションは、特化されたソフトウェア アプリケーションをサービスとしてテナントに提供します。 テナントはアプリケーション サービスにアクセスでき、アプリケーションの一部として保存される関連データの完全な所有権を持ちます。 ただし、SaaS の利点を活用するには、テナントが各自のデータの制御をある程度委ねる必要があります。 テナントは、SaaS サービス プロバイダーを信頼してデータの保護と他のテナントのデータからの分離を任せます。 この種のマルチテナント SaaS アプリケーションの例として、MYOB、SnelStart、Salesforce.com などがあります。 これらの各アプリケーションはテナント境界に沿ってパーティション分割することができ、この記事で説明するアプリケーション設計パターンをサポートします。

顧客または組織内の従業員 (多くの場合、テナントではなくユーザーと呼ばれます) に直接サービスを提供するアプリケーションは、マルチテナント アプリケーション領域の別のカテゴリです。 顧客はサービスにサブスクライブし、サービス プロバイダーが収集して保存しているデータを所有するわけではありません。 サービス プロバイダーが顧客のデータを相互に分離された状態に維持するための要件は、政府によって義務付けられたプライバシー規制ほど厳しいものではありません。 この種の顧客向けマルチテナント アプリケーションの例として、Netflix、Spotify、Xbox LIVE などのメディア コンテンツ プロバイダーがあります。 簡単にパーティション分割できるアプリケーションのその他の例として、顧客向けのインターネット規模のアプリケーションや IoT (モノのインターネット) アプリケーションがあります。これらのアプリケーションでは、それぞれの顧客またはデバイスがパーティションの役割を果たします。 パーティション境界によってユーザーやデバイスを分離できます。

すべてのアプリケーションが、テナント、顧客、ユーザー、デバイスなどの&1; つの特性に沿って簡単にパーティション分割されるわけではありません。 たとえば、複雑な ERP (エンタープライズ リソース プランニング) アプリケーションには、製品、注文、顧客が含まれます。 通常、ERP アプリケーションには、高度に相互接続された数千のテーブルを使用する複雑なスキーマがあります。

すべてのテーブルに適用することができ、アプリケーションのワークロード全体にわたって機能する単一のパーティション分割戦略はありません。 この記事では、データとワークロードを簡単にパーティション分割できるマルチテナント アプリケーションに重点を置いています。

## <a name="multitenant-application-design-trade-offs"></a>マルチテナント アプリケーションの設計上のトレードオフ
通常、マルチテナント アプリケーション開発者が選択する設計パターンは、次の要素の検討に基づいています。

* **テナントの分離**:  開発者は、テナントが他のテナントのデータに望ましくないアクセスを行わないことを保証する必要があります。 この分離要件は、ノイジー ネイバーからの保護、テナントのデータを復元する機能、テナント固有のカスタマイズの実装など、他の特性にも適用されます。
* **クラウド リソースのコスト**:  SaaS アプリケーションにはコスト競争力が必要です。 マルチテナント アプリケーション開発者は、クラウド リソースの使用コスト (ストレージ コストやコンピューティング コストなど) を削減するために最適化を行うことができます。
* **DevOps の容易さ**:  マルチテナント アプリケーション開発者は、分離保護を組み込み、アプリケーションとデータベース スキーマの正常性を管理、監視し、テナントの問題のトラブルシューティングを行う必要があります。 アプリケーションの開発と運用の複雑さは、コストの増加とテナントの満足度の課題に直結します。
* **スケーラビリティ**:  SaaS の運用を成功させるには、テナントとテナントが必要とする容量を徐々に追加できることが不可欠となります。

これらの要素には、それぞれ別の要素とのトレードオフがあります。 最も低コストのクラウド サービスが最も使い勝手のよい開発環境を提供するわけではありません。 開発者は、アプリケーション設計プロセスで、これらの選択肢とそのトレードオフについて、情報に基づく選択を行うことが重要です。

一般的な開発パターンは、複数のテナントを&1; つまたは少数のデータベースにまとめることです。 このアプローチのメリットは、支払が発生するデータベースの数が少ないため、低コストであることと、データベースの数が限られているので作業が比較的単純化されることです。 しかし、時間が経つにつれて、SaaS マルチテナント アプリケーション開発者は、この選択にはテナントの分離とスケーラビリティの点で大きな欠点があることに気付きます。 テナントの分離が重要になった場合、共有ストレージ内のテナント データを未承認のアクセスやノイジー ネイバーから保護するために追加作業が必要になります。 この追加の作業により、開発作業と分離のメンテナンス コストが大幅に増加します。 同様に、テナントを追加する必要がある場合、この設計パターンでは、データベース間でテナント データを再度分散させて、アプリケーションのデータ層を適切にスケーリングするための専門知識が通常は必要になります。  

企業や組織に提供される SaaS マルチテナント アプリケーションでは、多くの場合、テナントの分離は基本要件です。 開発者は、テナントの分離とスケーラビリティよりも、単純さとコスト面での認識されているメリットに惑わされることがあります。 サービスが成長し、テナント分離要件の重要性が高まり、アプリケーション層で対処するようになったときに、このトレードオフは複雑でコストがかかるということが判明する可能性があります。 ただし、直接的な顧客向けサービスを顧客に提供するマルチテナント アプリケーションでは、テナントの分離はクラウド リソースのコストの最適化よりも優先度が低くなります。

## <a name="multitenant-data-models"></a>マルチテナント データ モデル
テナント データを配置するための一般的な設計手法は、図 1 に示す 3 つの異なるモデルに従います。

![マルチテナント アプリケーション データ モデル](./media/sql-database-design-patterns-multi-tenancy-saas-applications/sql-database-multi-tenant-data-models.png)

図 1: マルチテナント データ モデルの一般的な設計手法

* **テナント単位のデータベース**:  各テナントが独自のデータベースを使用します。 テナント固有のすべてのデータがそのテナントのデータベースに配置され、他のテナントとそのデータから分離されます。
* **共有データベース (シャード)**:  複数のテナントが複数のデータベースのいずれかを共有します。 ハッシュ、範囲、リストなどのパーティション分割戦略を使用して、個々のテナント セットが各データベースに割り当てられます。 多くの場合、このデータ分散戦略はシャーディングと呼ばれます。
* **共有データベース (単一)**: 場合によっては大規模な単一のデータベースにすべてのテナントのデータが格納されます。 テナントは、テナント ID 列で区別されます。

> [!NOTE]
> アプリケーション開発者は、テナントをそれぞれ異なるデータベース スキーマに配置し、スキーマ名を使用してテナントを区別することもできます。 通常、このアプローチでは動的 SQL を使用する必要があり、プランのキャッシュの効果が得られないため、お勧めできません。 この記事の残りの部分では、マルチテナント アプリケーションのこのカテゴリの共有テーブル アプローチを中心に説明します。
> 
> 

## <a name="popular-multitenant-data-models"></a>一般的なマルチテナント データ モデル
既に確認したアプリケーションの設計上のトレードオフの観点で、各種マルチテナント データ モデルを評価することが重要です。 図 2 に示すように、次の要素によって、前述の最も一般的な 3 つのマルチテナント データ モデルとデータベースの使用方法を特徴付けることができます。

* **分離**。 テナント間の分離の度合いは、データ モデルが実現するテナントの分離がどの程度であるかを示す尺度となります。
* **クラウド リソースのコスト**:  テナント間でのリスースの共有の量により、クラウド リソースのコストを最適化できます。 リソースは、コンピューティングと記憶域のコストと定義できます。
* **DevOps コスト**:  アプリケーションの開発、デプロイ、管理の容易さによって、SaaS の全体的な運用コストが削減されます。  

図 2 では、Y 軸はテナントの分離レベルを示し、 X 軸はリソースの共有レベルを示しています。 中央にある灰色の斜めの矢印は、DevOps コストの方向 (増加傾向または減少傾向) を示しています。

![一般的なマルチテナント アプリケーション設計パターン](./media/sql-database-design-patterns-multi-tenancy-saas-applications/sql-database-popular-application-patterns.png)

図 2: 一般的なマルチテナント データ モデル

図 2 の右下のクアドラントは、大規模である可能性がある単一の共有データベースと、共有テーブル (または個別のスキーマ) アプローチを使用するアプリケーション パターンを示しています。 このパターンは、すべてのテナントが単一のデータベースで同じデータベース リソース (CPU、メモリ、入出力) を使用するため、リソースの共有に適しています。 ただし、テナントの分離は限られます。 アプリケーション層で、テナントを相互から保護するための追加手順を実行する必要があります。 この追加の手順により、アプリケーションの開発と管理の DevOps コストが大幅に増加する可能性があります。 スケーラビリティは、データベースをホストするハードウェアのスケールによって制限されます。

図 2 の左下のクアドラントは、(通常はハードウェア スケール ユニットが異なる) 複数のデータベースにシャーディングされた複数のテナントを示しています。 各データベースがテナントのサブセットをホストし、他のパターンのスケーラビリティの問題に対処します。 より多くのテナントに対応するためにさらに多くの容量が必要になった場合は、新しいハードウェア スケール ユニットに割り当てられた新しいデータベースにテナントを簡単に配置できます。 ただし、リソースの共有の量は減少します。 同じスケール ユニットに配置されたテナントだけがリソースを共有します。 このアプローチでは、多数のテナントが相互の操作から自動的には保護されずに引き続き併置されるため、テナントの分離はほとんど向上しません。 アプリケーションの複雑性が高いままです。

図 2 の左上のクアドラントは､3 番目のアプローチを示しています。 このアプローチでは、各テナントのデータがテナント独自のデータベースに配置されます。 このアプローチのテナント分離特性は優れていますが、各データベースが専用リソースを使用する場合、リソースの共有が限られます。 すべてのテナントのワークロードを予測できる場合には、これは優れたアプローチです。 テナントのワークロードを予測しにくくなった場合には、プロバイダーはリソースの共有を最適化できません。 予測の困難さは、SaaS アプリケーションではよくあることです。 プロバイダーは需要を満たすために過剰なプロビジョニングを行うか、リソースを減らす必要があります。 どちらの場合も、コストが増加するか、テナントの満足度が低下します。 ソリューションのコスト効率を高めるために、テナント間でのリソースの共有の度合いを高めることが望ましくなります。 データベースの数の増加も、アプリケーションをデプロイして管理する際の DevOps コストを増加させます。 こうした問題はありますが、これがテナントを最適かつ最も簡単に分離できる方法です。

選択する設計パターンには、次の要素も影響します。

* **テナント データの所有権**:  テナントが各自のデータの所有権を保持するアプリケーションでは、テナントごとに&1; つのデータベースを使用するパターンが優先されます。
* **スケール**。 数十万または数百万のテナントを対象とするアプリケーションでは、シャーディングなどのデータベース共有アプローチが優先されます。 分離要件が引き続き課題をもたらす可能性があります。
* **価値およびビジネス モデル**:  アプリケーションのテナントあたりの収益が少ない (1 ドル未満) 場合、分離要件はそれほど重要ではなくなり、共有データベースが理にかなっています。 テナントあたりの収益が数ドル以上の場合は、テナント単位のデータベース モデルの方が適しています。 このモデルでは、開発コストを削減できる可能性があります。

図 2 に示す設計上のトレードオフを考えると、理想的なマルチテナント モデルでは、優れたテナント分離特性とテナント間での最適なリソースの共有を組み込む必要があります。 このモデルは、図 2 の右上のクアドラントに示すカテゴリに適合します。

## <a name="multitenancy-support-in-azure-sql-database"></a>Azure SQL Database でのマルチテナント機能のサポート
Azure SQL Database は、図 2 で概説したマルチテナント アプリケーション パターンをすべてサポートします。 また、エラスティック プールを使用することで、優れたリソース共有とテナント単位のデータベース アプローチの分離のメリットを組み合わせたアプリケーション パターンもサポートされるようになりました (図 3 の右上のクアドラントを参照)。 SQL Database のエラスティック データベース ツールとエラスティック データベース機能により、多数のデータベースを使用するアプリケーションの開発と運用のコスト (図 3 の網かけされた領域) を削減できます。 これらのツールは、複数のデータベースのパターンを使用するアプリケーションの構築と管理に役立ちます。

![Azure SQL Database におけるパターン](./media/sql-database-design-patterns-multi-tenancy-saas-applications/sql-database-patterns-sqldb.png)

図 3: Azure SQL Database におけるマルチテナント アプリケーション パターン

## <a name="database-per-tenant-model-with-elastic-pools-and-tools"></a>エラスティック プールとツールを使用するテナント単位のデータベース モデル
SQL Database のエラスティック プールは、テナントの分離とテナント データベース間でのリソースの共有を組み合わせることで、テナント単位のデータベース アプローチのサポートを強化します。 SQL Database は、マルチテナント アプリケーションを構築する SaaS プロバイダー向けのデータ層ソリューションです。 テナント間で共有するリソースの負担は、アプリケーション層からデータベース サービス層へと移動します。 複数のデータベースにわたる大規模な管理とクエリの複雑さは、エラスティック ジョブ、エラスティック クエリ、エラスティック トランザクション、エラスティック データベース クライアント ライブラリによって単純化されます。

| アプリケーションの要件 | SQL Database の機能 |
| --- | --- |
| テナントの分離とリソースの共有 |[エラスティック プール](sql-database-elastic-pool.md): SQL Database リソースのプールを割り当て、複数のデータベース間でリソースを共有します。 また、個々のデータベースは、テナントのワークロードの変化による容量の需要の急増に対応するために、プールからリソースを必要なだけ取得できます。 必要に応じて、エラスティック プール自体をスケールアップまたはスケールダウンできます。 エラスティック プールにより、プール レベルでの管理、監視、トラブルシューティングも簡単に行うことができます。 |
| データベース間での開発運用の容易さ |[エラスティック プール](sql-database-elastic-pool.md): 前述のとおりです。 |
| [エラスティック クエリ](sql-database-elastic-query-horizontal-partitioning.md): レポート作成やクロステナント分析を行うために複数のデータベースにわたってクエリを実行します。 | |
| [エラスティック ジョブ](sql-database-elastic-jobs-overview.md): 複数のデータベースに対するデータベース メンテナンス操作やデータベース スキーマの変更をパッケージ化し、確実にデプロイします。 | |
| [エラスティック トランザクション](sql-database-elastic-transactions-overview.md): 複数のデータベースに対する変更を、アトミックな分離された方法で処理します。 エラスティック トランザクションは、アプリケーションがいくつかのデータベース操作を "全部かゼロか" で保証する必要がある場合に必要です。 | |
| [エラスティック クライアント ライブラリ](sql-database-elastic-database-client-library.md): データの分散を管理し、テナントをデータベースにマップします。 | |

## <a name="shared-models"></a>共有モデル
前述のように、ほとんどの SaaS プロバイダーで、共有モデル アプローチは、テナントの分離の問題とアプリケーションの開発およびメンテナンスの複雑さに関する問題を引き起こすと考えられます。 ただし、顧客に直接サービスを提供するマルチテナント アプリケーションでは、テナント分離要件は、コストを最小限に抑えることほど優先度が高くない場合があります。 これらのアプリケーションでは、テナントを&1; つ以上のデータベースに高密度でまとめることで、コストを削減できます。 単一のデータベースまたは複数のシャード データベースを使用する共有データベース モデルでは、リソースの共有がさらに効率化され、全体的なコストが削減されます。 Azure SQL Database には、データ層でのセキュリティと大規模な管理を強化するための分離の構築に役立つ機能が用意されています。

| アプリケーションの要件 | SQL Database の機能 |
| --- | --- |
| セキュリティ分離機能 |[行レベルのセキュリティ](https://msdn.microsoft.com/library/dn765131.aspx) |
| [データベース スキーマ](https://msdn.microsoft.com/library/dd207005.aspx) | |
| データベース間での開発運用の容易さ |[エラスティック クエリ](sql-database-elastic-query-horizontal-partitioning.md) |
| [エラスティック ジョブ](sql-database-elastic-jobs-overview.md) | |
| [エラスティック トランザクション](sql-database-elastic-transactions-overview.md) | |
| [エラスティック データベース クライアント ライブラリ](sql-database-elastic-database-client-library.md) | |
| [エラスティック データベースの分割と結合](sql-database-elastic-scale-overview-split-and-merge.md) | |

## <a name="summary"></a>概要
テナント分離要件は、ほとんどの SaaS マルチテナント アプリケーションにとって重要です。 分離を実現する最適な方法は、テナント単位のデータベース アプローチに大きく依存します。 他の&2; つのアプローチでは、分離を実現するために熟練した開発スタッフを必要とする複雑なアプリケーション層への投資が必要ですが、それによりコストとリスクが大幅に増加します。 サービス開発の早い段階で分離要件に対応しなかった場合、最初の&2; つのモデルでは、さらに改良コストがかかる可能性があります。 テナント単位のデータベース モデルに関する主な欠点は、共有の減少と多数のデータベースを管理することによるクラウド リソースのコストの増加と関連しています。 SaaS アプリケーション開発者は、これらのトレードオフを行うときに苦労することも少なくありません。

これらのトレードオフは、ほとんどのクラウド データベース サービス プロバイダーにとって大きな障壁となりますが、Azure SQL Database では、エラスティック プールとエラスティック データベース機能によってこれらの障壁を排除します。 SaaS 開発者は、テナント単位のデータベース モデルの分離特性を組み合わせ、リソースの共有を最適化し、エラスティック プールや関連ツールを使用して多くのデータベースの管理を向上させることができます。

マルチテナント アプリケーション プロバイダーにテナント分離要件がない場合や、テナントを高密度で&1; つのデータベースにまとめることができる場合は、共有データ モデルによって、リソースの共有をさらに効率化し、全体的なコストを削減できます。 Azure SQL Database のエラスティック データベース ツール、シャーディング ライブラリ、セキュリティ機能は、SaaS プロバイダーがマルチテナント アプリケーションを構築し、管理できるよう支援します。

## <a name="next-steps"></a>次のステップ
[エラスティック データベース ツール](sql-database-elastic-scale-get-started.md) を使ってみます。

エラスティック プールを使用して、コスト効率に優れたスケーラブルなデータベース ソリューションを実現するサンプル アプリケーションで、 [Saas のエラスティック プール カスタム ダッシュボード](https://github.com/Microsoft/sql-server-samples/tree/master/samples/manage/azure-sql-db-elastic-pools-custom-dashboard) を作成します。

Azure SQL Database ツールを使用して、 [既存のデータベースを移行し、スケールアウト](sql-database-elastic-convert-to-use-elastic-tools.md)します。

Azure Portal を使ってエラスティック プールを作成するには、「[エラスティック プールの作成](sql-database-elastic-pool-manage-portal.md)」をご覧ください。  

[エラスティック プールを監視および管理する](sql-database-elastic-pool-manage-portal.md)方法を確認します。

## <a name="additional-resources"></a>その他のリソース
* [Azure エラスティック プールの概要](sql-database-elastic-pool.md)
* [Azure SQL Database によるスケールアウト](sql-database-elastic-scale-introduction.md)
* [エラスティック データベース ツールと行レベルのセキュリティを使用したマルチテナント アプリケーション](sql-database-elastic-tools-multi-tenant-row-level-security.md)
* [Azure Active Directory と OpenID Connect を使用したマルチテナント アプリでの認証](../guidance/guidance-multitenant-identity-authenticate.md)
* [Tailspin Surveys アプリケーション](../guidance/guidance-multitenant-identity-tailspin.md)


## <a name="questions-and-feature-requests"></a>質問と機能に関する要望
ご質問がある場合は、 [SQL Database フォーラム](http://social.msdn.microsoft.com/forums/azure/home?forum=ssdsgetstarted)に投稿してください。 機能に関するご要望は、 [SQL Database フィードバック フォーラム](https://feedback.azure.com/forums/217321-sql-database/)までお寄せください。


