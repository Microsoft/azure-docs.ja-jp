---
title: ジョブの自動化
description: ジョブの自動化を使用して、一連の Azure SQL データベース全体に Transact-SQL (T-SQL) スクリプトを実行します。
services: sql-database
ms.service: sql-database
ms.custom: ''
ms.devlang: ''
ms.topic: overview
author: jovanpop-msft
ms.author: jovanpop
ms.reviewer: carlr
ms.date: 02/07/2020
ms.openlocfilehash: 1ffa17bd0e35e3753cde3e915c0ee70d8000147a
ms.sourcegitcommit: cfbea479cc065c6343e10c8b5f09424e9809092e
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/08/2020
ms.locfileid: "77083126"
---
# <a name="automate-management-tasks-using-database-jobs"></a>データベース ジョブを使用して管理タスクを自動化する

Azure SQL Database では、T-SQL クエリを実行してメンテナンス タスクを行うジョブを作成し、スケジュールして、1 つまたは多数のデータベースに対して定期的に実行することができます。 すべてのジョブでは、実行の状態が記録されます。また、エラーが発生した場合に操作が自動で再試行されます。
ジョブの実行場所となるターゲット データベースまたは Azure SQL データベースのグループを定義できるほか、ジョブを実行するスケジュールを定義できます。
ターゲット データベースにログインするタスクはジョブによって処理されます。 Azure SQL データベースのグループ全体に対して実行される Transact-SQL スクリプトの定義、保守、維持も行います。

## <a name="when-to-use-automated-jobs"></a>自動化されたジョブを使用するタイミング

ジョブの自動化を使用できるシナリオをいくつか次に示します。

- 管理タスクの自動化とスケジュール (平日に毎日、業務時間後に実行するなど)
  - スキーマの変更、資格情報の管理、パフォーマンス データの収集、テナント (顧客) テレメトリの収集をデプロイします。
  - 参照データ (全データベースに共通の情報) を更新したり、Azure Blob Storage からデータを読み込んだりします。
  - インデックスを再構築して、クエリのパフォーマンスを向上します。 データベース コレクションを対象として (ピーク外の時間などに) 定期的に実行するジョブを構成します。
  - データベース セットのクエリ結果をリアルタイムで中央のテーブルに収集します。 パフォーマンス クエリを継続的に実行して、その他のタスクの実行をトリガーするように構成できます。
- レポート用データの収集
  - Azure SQL データベースのコレクションから 1 つのテーブルにデータを集約します。
  - 顧客の製品利用統計情報収集など、大規模なデータセット全体に対して、時間がかかるデータ処理クエリを実行します。 結果は 1 つの対象テーブルに収集され、分析に使用されます。
- データの移動
  - お客様のデータベースで行われた変更を他のデータベースにレプリケートしたり、リモート データベースに加えられた更新を収集してデータベースに変更を適用したりするジョブを作成します。
  - SQL Server Integration Services (SSIS) を使用してお客様のデータベースとの間で双方向にデータを読み込むジョブを作成します。

## <a name="overview"></a>概要

Azure SQL Database では、次のジョブ スケジュール テクノロジが利用できます。

- **SQL エージェント ジョブ**: 従来から使われている実績のある SQL Server ジョブ スケジューリング コンポーネントです。Managed Instance で利用できます。 SQL エージェント ジョブは、Azure SQL の単一のデータベースでは利用できません。
- **Elastic Database ジョブ (プレビュー)** : 1 つまたは多数の Azure SQL データベース上でカスタム ジョブを実行するジョブ スケジューリング サービスです。

SQL エージェント (オンプレミスでも SQL Database Managed Instance の一部としても利用可能) と Database Elastic ジョブ エージェント (Azure SQL データベース内の単一のデータベースと SQL Data Warehouse 内のデータベースで利用可能) の間には、いくつかの点で違いがあります。

|  |エラスティック ジョブ  |SQL エージェント |
|---------|---------|---------|
|Scope     |  ジョブ エージェントと同じ Azure クラウド内に存在する任意の数の Azure SQL データベースやデータ ウェアハウス。 SQL Database サーバー、サブスクリプション、またはリージョンが異なっていてもターゲットとすることができます。 <br><br>ターゲット グループを構成するメンバーには、個々のデータベースまたはデータ ウェアハウスのほか、サーバー、プール、またはシャードマップに含まれるすべてのデータベースを指定できます (ジョブの実行時に動的に列挙されます)。 | SQL エージェントと同一の SQL Server インスタンス内の個々のデータベース。 |
|サポートされる API とツール     |  ポータル、PowerShell、T-SQL、Azure Resource Manager      |   T-SQL、SQL Server Management Studio (SSMS)     |

## <a name="sql-agent-jobs"></a>SQL エージェント ジョブ

SQL エージェント ジョブは、お客様のデータベースに対して指定される一連の T-SQL スクリプトです。 ジョブを使用し、1 回または複数回実行してその成否を監視できる管理タスクを定義します。
ジョブは、1 つのローカル サーバーで実行することも、複数のリモート サーバーで実行することもできます。 SQL エージェント ジョブは、Managed Instance サービス内で実行される内部のデータベース エンジン コンポーネントです。
SQL エージェント ジョブには、いくつかの重要な概念があります。

- **ジョブ ステップ**: ジョブ内で実行されるべき 1 つまたは複数のステップのセットです。 ジョブ ステップが成功または失敗した場合に実行されるアクションと再試行方法をジョブ ステップごとに定義することができます。
- **スケジュール**: ジョブを実行すべきタイミングを定義します。
- **通知**: ジョブが完了したときにメール経由でオペレーターに通知するために使用されるルールを定義できます。

### <a name="job-steps"></a>ジョブ ステップ

SQL エージェントのジョブ ステップは、SQL エージェントが実行する必要のある一連のアクションです。 それぞれのステップには、それが成功または失敗した場合に実行される後続のステップ (失敗した場合には再試行回数) があります。
SQL Agent では、さまざまな種類のジョブ ステップを作成できます。たとえば、データベースに対して単一の Transact-SQL バッチを実行する Transact-SQL ジョブ ステップ、カスタム OS スクリプトを実行できる OS コマンドまたは PowerShell のステップ、SSIS ランタイムを使用してデータを読み込める SSIS ジョブ ステップ、お客様のデータベースから他のデータベースに変更を発行できる[レプリケーション](sql-database-managed-instance-transactional-replication.md) ステップがあります。

[トランザクション レプリケーション](sql-database-managed-instance-transactional-replication.md)は、データベース エンジンの機能です。1 つまたは複数のテーブルに対して行われた変更を 1 つのデータベース内で発行したり、それらを一連のサブスクライバー データベースに発行または配布したりすることができます。 変更の発行は、次の種類の SQL エージェント ジョブ ステップを使用して実装されます。

- トランザクション ログ リーダー。
- スナップショット。
- ディストリビューターです。

以下のように、他の種類のジョブ ステップは現在サポートされていません。

- マージ レプリケーション ジョブ ステップはサポートされていません。
- キュー リーダーはサポートされていません。
- Analysis Services はサポートされていません。

### <a name="job-schedules"></a>ジョブ スケジュール

スケジュールによって、ジョブが実行されるタイミングが指定されます。 同じスケジュールで複数のジョブを実行できるほか、同じジョブに複数のスケジュールを適用することもできます。
ジョブが実行されるタイミングに関して、次の条件をスケジュールで定義できます。

- インスタンスが再起動されるたび (または SQL Server エージェントが起動されたとき)。 ジョブは、フェールオーバー後に毎回アクティブ化されます。
- 特定の日時に 1 回。これは、なんらかのジョブを遅延実行する際に便利です。
- 定期的なスケジュール。

> [!Note]
> Managed Instance では現在、インスタンスが "アイドル" のときにジョブを開始することはできません。

### <a name="job-notifications"></a>ジョブの通知

SQL エージェント ジョブでは、ジョブが正常に完了したとき、または失敗したときに通知を受け取ることができます。 通知はメール経由で受け取ることができます。

まず、メール通知の送信に使用されるメール アカウントを設定し、`AzureManagedInstance_dbmail_profile` というメール プロファイルにそのアカウントを割り当てる必要があります (次の例を参照)。

```sql
-- Create a Database Mail account
EXECUTE msdb.dbo.sysmail_add_account_sp
    @account_name = 'SQL Agent Account',
    @description = 'Mail account for Azure SQL Managed Instance SQL Agent system.',
    @email_address = '$(loginEmail)',
    @display_name = 'SQL Agent Account',
    @mailserver_name = '$(mailserver)' ,
    @username = '$(loginEmail)' ,  
    @password = '$(password)' 

-- Create a Database Mail profile
EXECUTE msdb.dbo.sysmail_add_profile_sp
    @profile_name = 'AzureManagedInstance_dbmail_profile',
    @description = 'E-mail profile used for messages sent by Managed Instance SQL Agent.' ;

-- Add the account to the profile
EXECUTE msdb.dbo.sysmail_add_profileaccount_sp
    @profile_name = 'AzureManagedInstance_dbmail_profile',
    @account_name = 'SQL Agent Account',
    @sequence_number = 1;
```

また、Managed Instance でデータベース メールも有効にする必要があります。

```sql
GO
EXEC sp_configure 'show advanced options', 1;  
GO  
RECONFIGURE;  
GO  
EXEC sp_configure 'Database Mail XPs', 1;  
GO  
RECONFIGURE 
```

お客様の SQL エージェント ジョブに関する出来事をオペレーターに通知できます。 1 つまたは複数のマネージド インスタンスを保守するメンテナンス担当者の連絡先情報は、オペレーターが定義します。 オペレーターの責任が 1 人の担当者に割り当てられることもあります。
複数のマネージド インスタンスまたは SQL Server があるシステムでは、オペレーターの責任を多数の担当者で共有することができます。 オペレーターは、セキュリティ情報を持たず、セキュリティ プリンシパルも定義しません。

オペレーターは、SSMS を使用して作成できるほか、次の例のように Transact-SQL スクリプトを使用して作成することができます。

```sql
EXEC msdb.dbo.sp_add_operator 
    @name=N'Mihajlo Pupun', 
        @enabled=1, 
        @email_address=N'mihajlo.pupin@contoso.com'
```

ジョブに対する変更のほか、ジョブが完了、失敗、成功した場合にメール経由で通知されるオペレーターの割り当ては、SSMS または次の Transact-SQL スクリプトを使用して行えます。

```sql
EXEC msdb.dbo.sp_update_job @job_name=N'Load data using SSIS', 
        @notify_level_email=3,                        -- Options are: 1 on succeed, 2 on failure, 3 on complete
        @notify_email_operator_name=N'Mihajlo Pupun'
```

### <a name="sql-agent-job-limitations"></a>SQL エージェント ジョブの制限

Managed Instance では、SQL Server で利用できる一部の SQL エージェント機能がサポートされません。
- SQL エージェントの設定は読み取り専用です。 `sp_set_agent_properties` プロシージャは、マネージド インスタンスではサポートされていません。
- Managed Instance では現在、SQL エージェントの有効化と無効化がサポートされていません。 SQL エージェントは常に実行されています。
- 通知は部分的にサポートされています。
  - ポケットベルはサポートされていません。
  - NetSend はサポートされていません。
  - アラートはサポートされていません。
- プロキシはサポートされていません。
- Eventlog はサポートされていません。

SQL Server エージェントについては、「[SQL Server エージェント](https://docs.microsoft.com/sql/ssms/agent/sql-server-agent)」をご覧ください。

## <a name="elastic-database-jobs-preview"></a>Elastic Database ジョブ (プレビュー)

**Elastic Database ジョブ**は、多数のデータベースを対象に T-SQL スクリプトを並列実行できる機能です。一定のスケジュールに従って実行することも、オンデマンドで実行することもできます。

**ジョブの実行対象とするデータベースの組み合わせは問いません**。個々のデータベースだけでなく、サーバー上のデータベースすべて、エラスティック プール内のデータベースすべて、シャードマップを自由に指定してジョブを実行できます。さらに、特定のデータベースをジョブの対象としたり、逆に対象から除外したりできる柔軟性も備わっています。 **多数のサーバーやプールにまたがるジョブだけでなく、異なるサブスクリプションのデータベースを対象としたジョブの実行も可能です。** 実行時にはサーバーとプールが動的に列挙されるので、実行時にターゲット グループに存在するデータベースに漏れなくジョブを実行できます。

次の図は、種類がさまざまに異なるターゲット グループに対してジョブ エージェントがジョブを実行するようすを示したものです。

![エラスティック ジョブ エージェントの概念モデル](media/elastic-jobs-overview/conceptual-diagram.png)

### <a name="elastic-job-components"></a>エラスティック ジョブのコンポーネント

|コンポーネント  | 説明 (詳しい情報は表の下に記載しています) |
|---------|---------|
|[**エラスティック ジョブ エージェント**](#elastic-job-agent) |  ジョブの実行と管理を目的として作成する Azure リソースです。   |
|[**ジョブ データベース**](#job-database)    |    Azure SQL データベースの一種で、ジョブ エージェントがジョブの関連データや定義などの情報を格納するために使用するものです。      |
|[**ターゲット グループ**](#target-group)      |  ジョブの実行の対象となるサーバー、プール、データベース、シャード マップをまとめたものを指します。       |
|[**ジョブ**](#job)  |  ジョブは処理の 1 単位で、1 つ以上の[ジョブ ステップ](#job-step)から成ります。 ジョブ ステップでは、実行する T-SQL スクリプトのほか、スクリプトの実行に必要な詳細情報を指定します。  |


#### <a name="elastic-job-agent"></a>エラスティック ジョブ エージェント

ジョブを作成、実行、および管理するための Azure リソースを、エラスティック ジョブ エージェントといいます。 エラスティック ジョブ エージェントは、ポータルで作成する Azure リソースです (このほか、[PowerShell](elastic-jobs-powershell.md) と REST による作成もサポートされています)。 

**エラスティック ジョブ エージェント**を作成するには、既存の SQL データベースが必要です。 エージェントはこの既存のデータベースを "[*ジョブ データベース*](#job-database)" として構成することになります。

エラスティック ジョブ エージェントは無料です。 ジョブ データベースについては、SQL データベースと同じ料金が発生します。

#### <a name="job-database"></a>ジョブ データベース

"*ジョブ データベース*" は、ジョブの定義のほか、ジョブの実行状態や実行履歴の追跡に使用するものです。 同時に、エージェントのメタデータ、ログ、結果、およびジョブの定義の保管場所としての役割も果たします。さらに、"*ジョブ データベース*" には、便利なストアド プロシージャや、T-SQL を使ったジョブの作成、実行、管理に役立つデータベース オブジェクトが多数格納されます。

現時点のプレビューでは、エラスティック ジョブ エージェントを作成する際に既存の Azure SQL データベース (S0 以降) が必要になります。

"*ジョブ データベース*" となるデータベースは新しいものでなくてもかまいませんが、データが入っておらず、サービス目標が S0 以上であることが条件となります。 "*ジョブ データベース*" で推奨されるサービス目標は S1 以上ですが、最適な選択はジョブのパフォーマンスに関するニーズ (ジョブ ステップの数、ジョブ ターゲットの数、ジョブの実行頻度) に依存します。 たとえば、10 個未満のデータベースをターゲットとして、1 時間に 2、3 回ジョブを実行するジョブ エージェントであれば、S0 データベースでも十分でしょう。しかし、ジョブを毎分実行するのであれば、S0 データベースでは速度が十分でない可能性があるため、より上のサービス レベルの方が望ましいと考えられます。 

ジョブ データベースに対する操作が予想よりも遅い場合は、Azure portal または [sys.dm_db_resource_stats](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-db-resource-stats-azure-sql-database) DMV を使用して、パフォーマンスが低下している期間に、データベースのパフォーマンスと、ジョブ データベースのリソース使用率を[監視](sql-database-monitor-tune-overview.md#monitor-database-performance)します。 CPU、データ IO、ログ書き込みなどのリソースの使用率が100% に近づいており、パフォーマンス低下の期間と相関している場合は、ジョブ データベースのパフォーマンスが十分に向上するまで、([DTU モデル](sql-database-service-tiers-dtu.md)または[仮想コア モデル](sql-database-service-tiers-vcore.md)) でデータベースをより高いサービス目標に段階的にスケーリングすることを検討してください。


##### <a name="job-database-permissions"></a>ジョブ データベースのアクセス許可

ジョブ エージェントの作成時には、"*ジョブ データベース*" にスキーマとテーブルのほか、*jobs_reader* と呼ばれるロールが作成されます。 このロールには作成時に次のアクセス許可が割り当てられるので、管理者が従来よりも細かくアクセスを制御してジョブを監視できるようになっています。


|ロール名  |"jobs" スキーマのアクセス許可  |"jobs_internal" スキーマのアクセス許可  |
|---------|---------|---------|
|**jobs_reader**     |    SELECT     |    なし     |

> [!IMPORTANT]
> "*ジョブ データベース*" のデータベース管理者としてのアクセス権を付与する際には、セキュリティ面の影響を考慮するようにしてください。 悪意のあるユーザーがジョブを作成または編集できるアクセス権を取得すると、保存されている資格情報を使ってそのユーザーの管理下にあるデータベースに接続するジョブを (新規に、または既存のジョブの編集により) 作成される可能性があります。そのような事態が起これば、悪意のあるユーザーが資格情報のパスワードを自由に設定できる状況が発生しかねません。



#### <a name="target-group"></a>ターゲット グループ

"*ターゲット グループ*" は、ジョブ ステップの実行対象となる一連のデータベースを定義したものです。 ターゲット グループに含めることができるものは次のとおりです (数や組み合わせは問いません)。

- **SQL Database サーバー** - サーバーを指定した場合には、ジョブの実行時点でそのサーバーに存在するデータベースがすべて、グループのメンバーとなります。 ジョブの実行前にグループのメンバーを列挙して更新できるように、マスター データベース資格情報を指定する必要があります。
- **エラスティック プール** - エラスティック プールを指定した場合には、ジョブの実行時点でそのエラスティック プールに存在するデータベースがすべて、グループのメンバーとなります。 サーバーの場合と同じく、ジョブの実行前にグループを更新できるように、マスター データベース資格情報を指定する必要があります。
- **単一のデータベース** - データベースを個別に指定してグループのメンバーとすることができます。
- **シャードマップ** - シャードマップに含まれるデータベースです。

> [!TIP]
> サーバーまたはプールが含まれるターゲット グループの場合には、ジョブの実行時に "*動的列挙*" によりグループ内のデータベースが再評価されます。 動的列挙は、**ジョブの実行時にサーバーまたはプールに存在するデータベース全部に漏れなくジョブを実行**するための処理です。 プールまたはサーバーのメンバーが頻繁に変わるシナリオでは、実行時にデータベースの一覧を再評価することが特に有用です。

プールとデータベースは個別にグループのメンバーとしたり、グループから除外したりできます。 このため、作成するターゲット グループのメンバーとなるデータベースの組み合わせは自由に調節できます。 たとえば、ターゲット グループにサーバーを追加した後で、エラスティック プール内の特定のデータベース (またはプール全体) をグループから除外することができます。

ターゲット グループには、複数のサブスクリプションのデータベースをメンバーに追加できます。また、グループ内のデータベースのリージョンが異なっていても問題ありません。 ただし、ジョブの実行が複数のリージョンにまたがる場合には、実行が同一のリージョン内にとどまる場合よりも待ち時間が長くなる点に注意してください。

次の例は、ジョブ実行時に異なるターゲット グループ定義を動的に列挙して、ジョブを実行するデータベースを決定する方法を示しています。

![ターゲット グループの例](media/elastic-jobs-overview/targetgroup-examples1.png)

**例 1** は、個々 のデータベースの一覧で構成されるターゲット グループを示しています。 このターゲット グループを使用してジョブ ステップを実行すると、ジョブ ステップのアクションがこれらのデータベースのそれぞれで実行されます。<br>
**例 2** は、Azure SQL Server をターゲットとして含むターゲット グループを示しています。 このターゲット グループを使用してジョブ ステップを実行すると、サーバーが動的に列挙され、現在サーバーに入っているデータベースの一覧が判定されます。 ジョブ ステップのアクションは、これらのデータベースのそれぞれで実行されます。<br>
**例 3** は "*例 2*" と似たターゲット グループを示していますが、個々のデータベースが明示的に除外されています。 ジョブ ステップのアクションは、除外されたデータベースでは実行 "*されません*"。<br>
**例 4** は、エラスティック プールをターゲットとして含むターゲット グループを示しています。 "*例 2*" と同様に、プールはジョブ実行時に動的に列挙され、プール内のデータベースの一覧が判定されます。
<br><br>


![ターゲット グループの例](media/elastic-jobs-overview/targetgroup-examples2.png)

**例 5** と**例 6** は、包含ルールと除外ルールを使用して Azure SQL Server、エラスティック プール、およびデータベースを結合できる高度なシナリオを示しています。<br>
**例 7** は、シャード マップ内のシャードをジョブ実行時にも評価できることを示しています。

> [!NOTE]
> ジョブ データベース自体は、ジョブのターゲットにすることができます。 このシナリオでは、ジョブ データベースは他のターゲット データベースと同様に処理されます。 ジョブ ユーザーを作成して、ジョブ データベースに十分なアクセス許可を付与する必要があります。また、ジョブ ユーザーのデータベース スコープの資格情報は、他のターゲット データベースの場合と同様に、ジョブ データベースにも存在する必要があります。
>

#### <a name="job"></a>ジョブ

"*ジョブ*" は処理の 1 単位です。一定のスケジュールに基づいて実行することもあれば、1 回限りのジョブとして実行することもあります。 ジョブは、いくつかの "*ジョブ ステップ*" で構成されます。

##### <a name="job-step"></a>ジョブ ステップ

各ジョブ ステップでは、実行する T-SQL スクリプト、そのスクリプトの対象となるターゲット グループ (複数可)、ジョブ エージェントがターゲット データベースに接続する際に必要になる資格情報の 3 つを指定します。 ジョブ ステップにはそれぞれカスタマイズが可能なタイムアウト値と再試行ポリシーが設定されているほか、オプションで出力パラメーターを指定できます。

#### <a name="job-output"></a>ジョブの出力

それぞれのターゲット データベースに実行したジョブ ステップの結果は詳細が記録されるので、指定したテーブルにスクリプトの出力を取り込むことができます。 ジョブから返されたデータはいずれも、保存先となるデータベースを指定できます。

#### <a name="job-history"></a>ジョブ履歴

ジョブの実行履歴は "*ジョブ データベース*" に格納されます。 記録から 45 日が経過した実行履歴については、システムのクリーンアップ ジョブにより削除されます。 45 日が経過する前に履歴を削除する場合には、"*ジョブ データベース*" で**sp_purge_history** ストアド プロシージャを呼び出してください。

### <a name="agent-performance-capacity-and-limitations"></a>エージェントのパフォーマンス、容量、および制約

エラスティック ジョブでは、実行時間の長いジョブの完了を待っている間に消費する計算リソースを最小限に抑えます。

データベースから成るターゲット グループの大きさと、ジョブについて希望する実行時間 (同時に実行する worker の数) に応じて、エージェントが "*ジョブ データベース*" に要求する計算量とパフォーマンスが変わります (ターゲットとジョブの数が増えるほど、要求される計算量が増大します)。

現時点のプレビュー版では、同時に実行するジョブの上限が 100 件に制限されています。

#### <a name="prevent-jobs-from-reducing-target-database-performance"></a>ジョブを原因とするターゲット データベースのパフォーマンス低下を防ぐ

SQL エラスティック プール内のデータベースにジョブを実行しているときにリソースに対する負荷が大きくなりすぎないようにするために、ジョブを構成して同時にジョブの実行対象とするデータベースの数に制限を設けることができます。

## <a name="next-steps"></a>次のステップ

- [SQL Server エージェントとは](https://docs.microsoft.com/sql/ssms/agent/sql-server-agent) 
- [エラスティック ジョブの作成と管理の方法](elastic-jobs-overview.md) 
- [PowerShell を使用したエラスティック ジョブの作成と管理](elastic-jobs-powershell.md) 
- [Transact-SQL を使用したエラスティック ジョブの作成と管理](elastic-jobs-tsql.md) 
