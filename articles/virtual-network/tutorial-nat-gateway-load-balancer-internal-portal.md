---
title: 'チュートリアル: NAT ゲートウェイと内部ロード バランサーを統合する - Azure portal'
titleSuffix: Virtual Network NAT
description: このチュートリアルでは、Azure portal を使用して Virtual Network NAT ゲートウェイを内部ロード バランサーと統合する方法について説明します。
author: asudbring
ms.author: allensu
ms.service: virtual-network
ms.subservice: nat
ms.topic: tutorial
ms.date: 03/19/2021
ms.custom: template-tutorial
ms.openlocfilehash: f25266f5a969514ca515e8cbbec959404428d6fb
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/19/2021
ms.locfileid: "104670694"
---
# <a name="tutorial-integrate-a-nat-gateway-with-an-internal-load-balancer-using-the-azure-portal"></a>チュートリアル: Azure portal を使用して NAT ゲートウェイと内部ロード バランサーを統合する

このチュートリアルでは、NAT ゲートウェイを内部ロード バランサーと統合する方法について説明します。

既定で、Azure Standard Load Balancer はセキュリティで保護されています。 送信接続は、送信 SNAT (送信元ネットワーク アドレス変換) を有効にすることによって明示的に定義されます。 

SNAT を内部バックエンド プールに対して有効にするには、別のパブリック ロード バランサー、ネットワーク ルーティング、または仮想マシンに定義されているパブリック IP を使用します。

NAT ゲートウェイの統合により、バックエンド プールにパブリック ロード バランサー、ネットワーク ルーティング、または仮想マシンに定義されているパブリック IP をデプロイする必要がなくなります。

このチュートリアルでは、以下の内容を学習します。

> [!div class="checklist"]
> * Azure Load Balancer を作成する
> * Azure Load Balancer のバックエンド プール用に 2 つの仮想マシンを作成する
> * NAT ゲートウェイを作成する
> * ロード バランサーのバックエンド プール内にある仮想マシンの送信接続を検証する

## <a name="prerequisites"></a>前提条件

アクティブなサブスクリプションが含まれる Azure アカウント。 [無料でアカウントを作成できます](https://azure.microsoft.com/free/?WT.mc_id=A261C142F)。

## <a name="create-the-virtual-network"></a>仮想ネットワークの作成

このセクションでは、仮想ネットワークとサブネットを作成します。

1. [Azure portal](https://portal.azure.com) にサインインします。

1. 画面の左上で、 **[リソースの作成] > [ネットワーク] > [仮想ネットワーク]** の順に選択するか、検索ボックスで **Virtual network** を検索します。

2. **［作成］** を選択します 

3. **[仮想ネットワークの作成]** の **[基本]** タブで次の情報を入力または選択します。

    | **設定**          | **Value**                                                           |
    |------------------|-----------------------------------------------------------------|
    | **プロジェクトの詳細**  |                                                                 |
    | サブスクリプション     | Azure サブスクリプションを選択します。                                  |
    | リソース グループ   | **[新規作成]** を選択します。 「**TutorIntLBNAT-rg**」と入力します。 </br> **[OK]** を選択します。 |
    | **インスタンスの詳細** |                                                                 |
    | 名前             | 「**myVNet**」と入力します                                    |
    | リージョン           | **[米国東部]** を選択します。 |

4. **[IP アドレス]** タブを選択するか、ページの下部にある **[Next: IP Addresses]\(次へ: IP アドレス\)** ボタンを選択します。

5. **[IP アドレス]** タブで、次の情報を入力します。

    | 設定            | 値                      |
    |--------------------|----------------------------|
    | IPv4 アドレス空間 | 「**10.1.0.0/16**」と入力します。 |

6. **[サブネット名]** で、 **[default]\(既定\)** という単語を選択します。

7. **[サブネットの編集]** に次の情報を入力します。

    | 設定            | 値                      |
    |--------------------|----------------------------|
    | サブネット名 | 「**myBackendSubnet**」と入力します |
    | サブネットのアドレス範囲 | 「**10.1.0.0/24**」と入力します。 |

8. **[保存]** を選択します。

9. **[セキュリティ]** タブをクリックします。

10. **[BastionHost]** で **[有効にする]** を選択します。 この情報を入力します。

    | 設定            | 値                      |
    |--------------------|----------------------------|
    | 要塞名 | 「**myBastionHost**」と入力します |
    | AzureBastionSubnet のアドレス空間 | 「**10.1.1.0/24**」と入力します |
    | パブリック IP アドレス | **[新規作成]** を選択します。 </br> **[名前]** に「**myBastionIP**」と入力します。 </br> **[OK]** を選択します。 |


11. **[確認と作成]** タブを選択するか、 **[確認と作成]** ボタンを選択します。

12. **［作成］** を選択します

## <a name="create-load-balancer"></a>ロード バランサーの作成

このセクションでは、Standard Azure Load Balancer を作成します。 

1. **[リソースの作成]** を選択します。 

2. 検索ボックスに「**ロード バランサー**」と入力します。 検索結果で **[ロード バランサー]** を選択します。

3. **[ロード バランサー]** ページで、 **[作成]** を選択します。
4. **[ロード バランサーの作成]** ページで、次の情報を入力または選択します。 

    | 設定                 | 値                                              |
    | ---                     | ---                                                |
    | **プロジェクトの詳細** |   |
    | サブスクリプション               | サブスクリプションを選択します。    |    
    | Resource group         | **[TutorIntLBNAT-rg]** を選択します。|
    | **インスタンスの詳細** |    |
    | 名前                   | 「**myLoadBalancer**」と入力します                                   |
    | リージョン         | **[(米国) 米国東部]** を選択します。                                        |
    | Type          | **[内部]** を選択します。                                        |
    | SKU           | 既定値 **[標準]** のままにします。 |
    | **仮想ネットワークを構成する** |    |
    | 仮想ネットワーク | **[myVNet]** を選択します。 |
    | Subnet | **[myBackendSubnet]** を選択します。 |
    | IP アドレスの割り当て | **[動的]** を選択します。 |
    | 可用性ゾーン | 回復性があるロード バランサーを作成するには、 **[ゾーン冗長]** を選択します。 </br> ゾーン間ロード バランサーを作成するには、1、2、3 の中から特定のゾーンを選択します |
    

5. 残りの設定は既定値をそのまま使用し、 **[確認と作成]** を選択します。

6. **[確認および作成]** タブで、 **[作成]** を選択します。

## <a name="create-load-balancer-resources"></a>ロード バランサーのリソースを作成する

このセクションでは、次の構成を行います。

* ロード バランサーのバックエンド アドレス プールの設定。
* 正常性プローブ。
* ロード バランサー規則。

### <a name="create-a-backend-pool"></a>バックエンド プールの作成

バックエンド アドレス プールには、ロード バランサーに接続された仮想 NIC の IP アドレスが含まれています。 

バックエンド アドレス プール **myBackendPool** を作成し、インターネット トラフィックを負荷分散するために仮想マシンを含めます。

1. 左側のメニューで **[すべてのサービス]** 、 **[すべてのリソース]** の順に選択し、リソースの一覧で **[myLoadBalancer]** を選択します。

2. **[設定]** で、 **[バックエンド プール]** 、 **[追加]** の順に選択します。

3. **[バックエンド プールの追加]** ページで、バックエンド プールの名前として「**myBackendPool**」と入力し、 **[追加]** を選択します。

### <a name="create-a-health-probe"></a>正常性プローブの作成

ロード バランサーは、正常性プローブを使用してアプリの状態を監視します。 

正常性プローブは、正常性チェックへの応答に基づいて、ロード バランサーに含める VM を追加したり削除したりします。 

**myHealthProbe** という正常性プローブを作成し、VM の正常性を監視します。

1. 左側のメニューで **[すべてのサービス]** 、 **[すべてのリソース]** の順に選択し、リソースの一覧で **[myLoadBalancer]** を選択します。

2. **[設定]** で、 **[正常性プローブ]** 、 **[追加]** の順に選択します。
    
    | 設定 | 値 |
    | ------- | ----- |
    | 名前 | 「**myHealthProbe**」と入力します。 |
    | Protocol | **[TCP]** を選択します。 |
    | Port | 「**80**」と入力します。|
    | Interval | プローブの試行の **間隔** を示す秒数として、「**15**」を入力します。 |
    | 異常のしきい値 | **異常しきい値** またはプローブの連続する失敗の回数として **[2]** を選択します。この回数を超えると、VM は異常と見なされます。|
   
3. 残りの部分は既定値のままにし、 **[追加]** を選択します。

### <a name="create-a-load-balancer-rule"></a>ロード バランサー規則の作成

ロード バランサー規則の目的は、一連の VM に対するトラフィックの分散方法を定義することです。 着信トラフィック用のフロントエンド IP 構成と、トラフィックを受信するためのバックエンド IP プールを定義します。 送信元と送信先のポートは、この規則で定義します。 

このセクションでは、ロード バランサー規則を作成します。

* 「**myHTTPRule**」という名前を付けます。
* フロントエンドには、「**LoadBalancerFrontEnd**」という名前を付けます。
* **ポート 80** でリッスンします。
* 負荷分散されたトラフィックを、**ポート 80** の **myBackendPool** という名前のバックエンドに送信します。

1. 左側のメニューで **[すべてのサービス]** 、 **[すべてのリソース]** の順に選択し、リソースの一覧で **[myLoadBalancer]** を選択します。

2. **[設定]** で、 **[負荷分散規則]** 、 **[追加]** の順に選択します。

3. 負荷分散規則の構成には、以下の値を使用します。
    
    | 設定 | 値 |
    | ------- | ----- |
    | 名前 | 「**myHTTPRule**」と入力します。 |
    | IP バージョン | **[IPv4]** を選択します |
    | フロントエンド IP アドレス | **[LoadBalancerFrontEnd]** を選択します |
    | Protocol | **[TCP]** を選択します。 |
    | Port | 「**80**」と入力します。|
    | バックエンド ポート | 「**80**」と入力します。 |
    | バックエンド プール | **[myBackendPool]** を選択します。|
    | 正常性プローブ | **[myHealthProbe]** を選択します。 |
    | アイドル タイムアウト (分) | 「**15**」分と入力します。 |
    | TCP リセット | **[Enabled]** を選択します。 |

4. 残りの部分は既定値のままにし、次に **[OK]** を選択します。


## <a name="create-virtual-machines"></a>仮想マシンを作成する

このセクションでは、2 つの異なるゾーン (**ゾーン 1** と **ゾーン 2**) に 2 つの VM (**myVM1** と **myVM2**) を作成します。

これらの VM を、前に作成したロード バランサーのバックエンド プールに追加します。

1. ポータルの左上で、 **[リソースの作成]**  >  **[Compute]**  >  **[仮想マシン]** を選択します。 
   
2. **[仮想マシンの作成]** の **[Basic]** タブに、値を入力するか選択します。

    | 設定 | 値                                          |
    |-----------------------|----------------------------------|
    | **プロジェクトの詳細** |  |
    | サブスクリプション | Azure サブスクリプションを選択します。 |
    | リソース グループ | **[TutorIntLBNAT-rg]** を選択します。 |
    | **インスタンスの詳細** |  |
    | 仮想マシン名 | 「**myVM1**」と入力します |
    | リージョン | **[米国東部]** を選択します。 |
    | 可用性オプション | **[可用性ゾーン]** を選択します |
    | 可用性ゾーン | **[1]** を選択します |
    | Image | **[Windows Server 2019 Datacenter]** を選択します |
    | Azure Spot インスタンス | 既定値をそのまま使用します。 |
    | サイズ | VM サイズを選択するか、既定の設定を使用します |
    | **管理者アカウント** |  |
    | ユーザー名 | ユーザー名を入力します |
    | Password | [パスワード] を入力します |
    | [パスワードの確認入力] | パスワードを再入力します |
    | **受信ポートの規則** |  |
    | パブリック受信ポート | **[なし]** を選択します |

3. **[ネットワーク]** タブまたは **[次へ: ディスク]** を選択してから **[次へ: ネットワーク]** を選択します。
  
4. [ネットワーク] タブで、次を選択または入力します。

    | 設定 | 値 |
    |-|-|
    | **ネットワーク インターフェイス** |  |
    | 仮想ネットワーク | **myVNet** |
    | Subnet | **myBackendSubnet** |
    | パブリック IP | **[なし]** を選択します。 |
    | NIC ネットワーク セキュリティ グループ | **[Advanced] \(詳細設定)** を選択します|
    | ネットワーク セキュリティ グループを構成する | **[新規作成]** を選択します。 </br> **[ネットワーク セキュリティ グループの作成]** で、 **[名前]** に「**myNSG**」と入力します。 </br> **[受信規則]** で、[ **+ 受信規則の追加]** を選択します。 </br> **[宛先ポート範囲]** で、「**80**」と入力します。 </br> **[優先度]** に「**100**」と入力します。 </br> **[名前]** に「**myHTTPRule**」と入力します </br> **[追加]** を選択します。 </br> **[OK]** を選択します。 |
    | **負荷分散**  |
    | この仮想マシンを既存の負荷分散ソリューションの後ろに配置しますか? | チェック ボックスをオンにします。 |
    | **ロード バランサーの設定** |
    | 負荷分散のオプション | **[Azure ロード バランサー]** を選択する |
    | ロード バランサーを選択する | **[myLoadBalancer]** を選択します  |
    | バックエンド プールを選択する | **[myBackendPool]** を選択します |
   
5. **[Review + create]\(レビュー + 作成\)** を選択します。 
  
6. 設定を確認し、 **[作成]** を選択します。

7. 手順 1 から 7 に従って VM を作成します。次の値を使用し、他の設定はすべて **myVM1** と同じにします。

    | 設定 | VM 2 |
    | ------- | ----- |
    | 名前 |  **myVM2** |
    | 可用性ゾーン | **2** |
    | ネットワーク セキュリティ グループ | 既存の **[myNSG]** を選択します| 

## <a name="create-nat-gateway"></a>NAT ゲートウェイの作成

このセクションでは、NAT ゲートウェイを作成し、前に作成した仮想ネットワーク内のサブネットに割り当てます。

1. 画面の左上で、 **[リソースの作成] > [ネットワーク] > [NAT ゲートウェイ]** を選択するか、検索ボックスで "**NAT ゲートウェイ**" を検索します。

2. **［作成］** を選択します 

3. **[ネットワーク アドレス変換 (NAT) ゲートウェイを作成します]** の **[基本]** タブにこの情報を入力または選択します。

    | **設定**          | **Value**                                                           |
    |------------------|-----------------------------------------------------------------|
    | **プロジェクトの詳細**  |                                                                 |
    | サブスクリプション     | Azure サブスクリプションを選択します。                                  |
    | リソース グループ   | **[TutorIntLBNAT-rg]** を選択します。 |
    | **インスタンスの詳細** |                                                                 |
    | 名前             | 「**myNATGateway**」と入力します                                    |
    | リージョン           | **[(米国) 米国東部]** を選択します  |
    | 可用性ゾーン | **[なし]** を選択します。 |
    | アイドル タイムアウト (分) | 「**10**」と入力します。 |

4. **[Outbound IP]\(アウトバウンド IP\)** タブを選択するか、ページの下部にある **[Next: Outbound IP]\(次へ: アウトバウンド IP\)** を選択します。

5. **[Outbound IP]\(アウトバウンド IP\)** タブで、次の情報を入力または選択します。

    | **設定** | **Value** |
    | ----------- | --------- |
    | パブリック IP アドレス | **[Create a new public IP address]\(新しいパブリック IP アドレスを作成する\)** を選択します。 </br> **[名前]** に、「**myPublicIP-NAT**」と入力します。 </br> **[OK]** を選択します。 |

6. **[サブネット]** タブを選択するか、ページの下部にある **[次へ: サブネット]** ボタンを選択します。

7. **[サブネット]** タブで、 **[仮想ネットワーク]** プルダウンから **[myVNet]** を選択します。

8. 「**myBackendSubnet**」の横のチェック ボックスをオンにします。

9. **[Review + create]\(確認と作成\)** タブを選択するか、ページの下部にある青色の **[Review + create]\(確認と作成\)** ボタンを選択します。

10. **［作成］** を選択します

## <a name="test-nat-gateway"></a>NAT ゲートウェイをテストする

このセクションでは、NAT ゲートウェイをテストします。 まず、NAT ゲートウェイのパブリック IP を検出します。 次に、テスト仮想マシンに接続し、NAT ゲートウェイ経由のアウトバウンド接続を確認します。
    
1. **[概要]** 画面で、NAT ゲートウェイのパブリック IP アドレスを見つけます。 左側のメニューで **[すべてのサービス]** 、 **[すべてのリソース]** 、 **[myPublicIP]** の順に選択します。

2. パブリック IP アドレスを書き留めておきます。

    :::image type="content" source="./media/tutorial-nat-gateway-load-balancer-internal-portal/find-public-ip.png" alt-text="NATゲートウェイのパブリック IP アドレス検出のスクリーンショット。" border="true":::

3. 左側のメニューで **[すべてのサービス]** 、 **[すべてのリソース]** の順に選択し、リソースの一覧で **[TutorIntLBNAT-rg]** リソース グループにある **[myVM1]** を選択します。

4. **[概要]** ページで **[接続]** 、 **[要塞]** の順に選択します。

5. 青色の **[Bastion を使用する]** ボタンを選択します。

6. VM 作成時に入力したユーザー名とパスワードを入力します。

7. **myVM1** で **Internet Explorer** 開きます。

8. アドレス バーに「 **https://whatsmyip.com** 」と入力します。

9. 表示された IP アドレスが前の手順でメモしておいた NAT ゲートウェイのアドレスと一致していることを確認します。

    :::image type="content" source="./media/tutorial-nat-gateway-load-balancer-internal-portal/my-ip.png" alt-text="外部送信 IP が表示されている Internet Explorer のスクリーンショット。" border="true":::

## <a name="clean-up-resources"></a>リソースをクリーンアップする

今後このアプリケーションを使う予定がなければ、次の手順を使用して、仮想ネットワーク、仮想マシン、および NAT ゲートウェイを削除します。

1. 左側のメニューから、 **[リソース グループ]** を選択します。

2. **[TutorIntLBNAT-rg]** リソース グループを選択します。

3. **[リソース グループの削除]** を選択します。

4. 「**TutorIntLBNAT-rg**」と入力し、 **[削除]** を選択します。

## <a name="next-steps"></a>次のステップ

Azure Virtual Network NAT の詳細については、以下を参照してください。
> [!div class="nextstepaction"]
> [Virtual Network NAT の概要](nat-overview.md)
