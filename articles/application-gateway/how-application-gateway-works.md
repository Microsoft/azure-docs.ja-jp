---
title: Azure Application Gateway の動作
description: この記事では、アプリケーション ゲートウェイの動作に関する情報を提供します。
services: application-gateway
author: abshamsft
ms.service: application-gateway
ms.topic: article
ms.date: 02/20/2019
ms.author: absha
ms.openlocfilehash: bbaf651233d4cebad3f45e5cf3823bcaf6ce38b6
ms.sourcegitcommit: 9f4eb5a3758f8a1a6a58c33c2806fa2986f702cb
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/03/2019
ms.locfileid: "58905785"
---
# <a name="how-application-gateway-works"></a>アプリケーション ゲートウェイの動作

この記事では、アプリケーション ゲートウェイが受信要求を受け付け、それをバックエンドにルーティングする方法について説明します。

![how-application-gateway-works](./media/how-application-gateway-works/how-application-gateway-works.png)

## <a name="how-a-request-is-accepted"></a>要求が受け付けられる方法

クライアントは、アプリケーション ゲートウェイに要求を送信する前に、ドメイン ネーム システム (DNS) サーバーを使用してアプリケーション ゲートウェイのドメイン名を解決します。 アプリケーション ゲートウェイは azure.com ドメインに存在するため、DNS エントリは Azure によって制御されます。 Azure DNS は、クライアントに IP アドレス (アプリケーション ゲートウェイの*フロントエンド IP アドレス*) を返します。 アプリケーション ゲートウェイは、1 つ以上の*リスナー*で受信トラフィックを受け付けます。 リスナーは、接続要求をチェックする論理エンティティです。 これは、クライアントからアプリケーション ゲートウェイへの接続のためのフロントエンド IP アドレス、プロトコル、およびポート番号を使用して構成されます。 Web アプリケーション ファイアウォール (WAF) が有効になっている場合、アプリケーション ゲートウェイは要求ヘッダーと本文 (存在する場合) を *WAF ルール*に対してチェックして、それが有効な要求であるか (その場合、その要求はバックエンドにルーティングされます)、またはセキュリティの脅威であるか (その場合、その要求はブロックされます) を判定します。  

アプリケーション ゲートウェイは、内部アプリケーション ロード バランサーまたはインターネットに接続するアプリケーション ロード バランサーとして使用できます。 インターネットに接続するアプリケーション ゲートウェイにはパブリック IP アドレスがあります。 インターネットに接続するアプリケーション ゲートウェイの DNS 名は、そのパブリック IP アドレスにパブリックに解決できます。 そのため、インターネットに接続するアプリケーション ゲートウェイは、クライアントからの要求をインターネット経由でルーティングできます。 内部アプリケーション ゲートウェイには、プライベート IP アドレスしかありません。 内部アプリケーション ゲートウェイの DNS 名は、そのプライベート IP アドレスにパブリックに解決できます。 そのため、内部ロード バランサーは、アプリケーション ゲートウェイの VNET にアクセスできるクライアントからの要求しかルーティングできません。 インターネットに接続するアプリケーション ゲートウェイと内部アプリケーション ゲートウェイはどちらも、プライベート IP アドレスを使用して要求をバックエンド サーバーにルーティングします。 そのため、バックエンド サーバーは、内部アプリケーション ゲートウェイまたはインターネットに接続するアプリケーション ゲートウェイからの要求を受信するためにパブリック IP アドレスは必要ありません。

## <a name="how-a-request-is-routed"></a>要求がルーティングされる方法

要求が有効であるとわかった場合 (または WAF が有効になっていない場合) は、要求のルーティング先の*バックエンド プール*を特定するために、*リスナー*に関連付けられた*要求ルーティング規則*が評価されます。 規則は、ポータルにおける表示順に処理されます。 *要求ルーティング規則*の構成に基づいて、アプリケーション ゲートウェイは、リスナー上のすべての要求を特定のバックエンド プールにルーティングするか、URL パスに応じて異なるバックエンド プールにルーティングするか、あるいは別のポートまたは外部サイトに*要求をリダイレクトする*かを判定します。

*バックエンド* *プール*が選択されると、アプリケーション ゲートウェイは、そのプール内に構成されたいずれかの正常なバックエンド サーバー (y.y.y.y) に要求を送信します。 サーバーの正常性は、*正常性プローブ*によって決定されます。 バックエンド プールに複数のサーバーが含まれている場合、アプリケーション ゲートウェイはラウンド ロビン アルゴリズムを使用して、正常なサーバー間で要求をルーティングすることによってサーバー上の要求を負荷分散します。

バックエンド サーバーが特定されると、アプリケーション ゲートウェイは *HTTP 設定*内の構成に基づいて、そのバックエンド サーバーとの新しい TCP セッションを開きます。 *HTTP 設定*は、バックエンド サーバーとの新しいセッションを確立するために必要なプロトコル、ポート、その他のルーティング関連の設定を指定するコンポーネントです。 HTTP 設定で使用されているポートやプロトコルによって、アプリケーション ゲートウェイとバックエンド サーバーの間のトラフィックが暗号化される (それによって、エンド ツー エンドの SSL が達成される) かどうかが決定されます。 元の要求をバックエンド サーバーに送信している間、アプリケーション ゲートウェイは、ホスト名、パス、プロトコルのオーバーライドに関連する HTTP 設定で行われたすべてのカスタム構成 (Cookie ベースのセッション アフィニティの保持、接続のドレイン、バックエンドからのホスト名の選択など) に従います。

内部アプリケーション ゲートウェイには、プライベート IP アドレスしかありません。 内部アプリケーション ゲートウェイの DNS 名は、そのプライベート IP アドレス内部的に解決できます。 そのため、内部ロード バランサーは、アプリケーション ゲートウェイの VNET にアクセスできるクライアントからの要求しかルーティングできません。

内部的に解決できる FQDN またはプライベート IP アドレスがバックエンド プールに含まれている場合、Application Gateway によるバックエンド サーバーへの要求は、そのインスタンスのプライベート IP アドレスを使用してルーティングされます。 外部エンドポイントまたは外部的に解決できる FQDN がバックエンド プールに含まれている場合、Application Gateway によるバックエンド サーバーへの要求は、そのフロントエンドのパブリック IP アドレスを使用してルーティングされます。 DNS 解決は、プライベート DNS ゾーンまたはカスタム DNS サーバー (構成されている場合) に基づいて行われます。または、Azure に指定されている既定の DNS が使用されます。 フロントエンド パブリック IP アドレスをプロビジョニングしていない場合は、送信外部接続に対してフロントエンド パブリック IP アドレスが割り当てられます。

### <a name="modifications-to-the-request"></a>要求への変更

アプリケーション ゲートウェイは、要求をバックエンドに転送する前に、すべての要求に 4 つの追加ヘッダーを挿入します。 これらのヘッダーは、X-forwarded-for、X-forwarded-proto、X-forwarded-port、および X-original-host です。 x-forwarded-for ヘッダーの形式は、IP:ポートのコンマ区切りリストです。 x-forwarded-proto の有効な値は、HTTP または HTTPS です。 x-forwarded-port は、要求がアプリケーション ゲートウェイに到達するポートを指定します。 X-original-host ヘッダーには、到着した要求にあった元のホスト ヘッダーが含まれています。 このヘッダーは、トラフィックがバックエンドにルーティングされる前に受信ホスト ヘッダーが変更される、Azure Web サイト統合などのシナリオで役立ちます。 オプションで、セッション アフィニティが有効になっている場合は、ゲートウェイで管理されるアフィニティ Cookie が挿入されます。 

[HTTP ヘッダーの書き換え](https://docs.microsoft.com/azure/application-gateway/rewrite-http-headers)を使用してヘッダーを変更するようにアプリケーション ゲートウェイをさらに構成するか、またはパス オーバーライド設定を使用して URI パスを変更できます。 ただし、そのように構成されていない限り、すべての受信要求がバックエンドにそのままプロキシ処理されます。


## <a name="next-steps"></a>次の手順

アプリケーション ゲートウェイの動作について学習したら、そのコンポーネントをより詳細に理解するために、[アプリケーション ゲートウェイのコンポーネント](application-gateway-components.md)に関するページを参照してください。
