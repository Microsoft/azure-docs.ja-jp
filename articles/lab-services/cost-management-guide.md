---
title: Azure Lab Services のコスト管理ガイド
description: Lab Services のコストを表示するさまざまな方法について説明します。
author: rbest
ms.author: rbest
ms.date: 08/16/2020
ms.topic: article
ms.openlocfilehash: 0aaa454df05cd8981b314abe238163caced7864c
ms.sourcegitcommit: d661149f8db075800242bef070ea30f82448981e
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/19/2020
ms.locfileid: "88604587"
---
# <a name="cost-management-for-azure-lab-services"></a>Azure Lab Services のコスト管理

コスト管理は、コストの見積もりとコストの分析という 2 つの異なる領域に分類できます。  コストの見積もりは、ラボを設定するときに、ラボの初期構造を予想される予算内に収めるために行われます。  コストの分析は、コストを分析して、翌月の必要なアクションを決定するために、通常、月末に行われます。

## <a name="estimate-the-lab-costs"></a>ラボのコストを見積もる

各ラボ ダッシュボードには、**コストと課金**のセクションがあり、その月のラボのコストの概算見積りが提示されます。  コストの見積もりでは、最大ユーザー数での時間の使用量が、時間ごとの推定コストで要約されています。  最も正確な見積もりを取得するには、[スケジュール](how-to-create-schedules.md)を含めてラボを設定すると、ダッシュボードに推定コストが反映されます。  

この見積もりは、発生しうるすべてのコストではない可能性があり、含まれていないいくつかのリソースがあります。  テンプレートの準備コストは、コストの見積もりには含まれていません。  これは、テンプレートの作成に必要な時間によって大幅に変わる可能性があります。 テンプレートを実行するコストは、1 時間あたりの全体的なラボ コストと同じです。 ギャラリーは複数のラボ間で共有される可能性があるため、[Shared Image Gallery](how-to-use-shared-image-gallery.md) のコストはラボ ダッシュボードには含まれていません。  最後に、ラボの作成者がマシンを起動したときに発生した時間は、この見積もりから除外されます。

> [!div class="mx-imgBorder"]
> ![ダッシュボードのコスト見積もり](./media/cost-management-guide/dashboard-cost-estimation.png)

## <a name="analyze-previous-months-usage"></a>以前の月の使用状況を分析する

コストの分析は、以前の月の使用状況を確認して、ラボの調整の決定に役立てるために行われます。  過去のコストの内訳については、[サブスクリプションのコスト分析](https://docs.microsoft.com/azure/cost-management-billing/costs/quick-acm-cost-analysis)に関するページを参照してください。  Azure portal では、上部の検索フィールドに「サブスクリプション」と入力してから、[サブスクリプション] オプションを選択します。  

> [!div class="mx-imgBorder"]
> ![サブスクリプションの検索](./media/cost-management-guide/subscription-search.png)

確認する特定のサブスクリプションを選択します。

> [!div class="mx-imgBorder"]
> ![サブスクリプションの選択](./media/cost-management-guide/subscription-select.png)

 左側のペインで **[Cost Management]** の下にある [コスト分析] を選択します。

> [!div class="mx-imgBorder"]
> ![サブスクリプションのコスト分析](./media/cost-management-guide/subscription-cost-analysis.png)

このダッシュボードでは、スケジュールに基づいてさまざまな種類のファイルにエクスポートする機能など、詳細なコスト分析を行うことができます。  Cost Management にはさまざまな機能があります。詳細については、[Cost Management の課金の概要](https://docs.microsoft.com/azure/cost-management-billing/cost-management-billing-overview)に関するページを参照してください。

リソースの種類によるフィルター処理: `microsoft.labservices/labaccounts` には、Lab Services に関連付けられているコストのみが表示されます。

## <a name="understand-the-usage"></a>使用状況を理解する

コスト分析のサンプルを次に示します。

> [!div class="mx-imgBorder"]
> ![サブスクリプションのコスト分析](./media/cost-management-guide/cost-analysis.png)

既定で、リソース、リソースの種類、場所、リソース グループ名、タグ、コストという 6 つの列があります。  リソース列には、ラボ アカウント、ラボ名、および VM に関する情報が含まれています。  ラボ アカウント/ラボ名/既定値を含む行は、ラボのコストです。これは、2 行目と 3 行目で確認できます。  使用されている VM には、ラボ アカウント/ラボ名/既定値/VM 名の下にコストがあります。  この例では、両方とも "aaalab / dockerlab" で始まる最初の行と 2 番目の行を足すと、"aaalab" ラボ アカウント内のラボ "dockerlab" の総コストが得られます。

Shared Image Gallery 情報を取得するには、リソースの種類を `Microsoft.Compute/Galleries` に変更します。これにより、イメージ ギャラリーの全体的なコストが得られます。  ギャラリーが格納されている場所によっては、Shared Image Gallery はコストに表示されない可能性があります。

> [!NOTE]
> Shared Image Gallery はラボ アカウントに接続されています。  つまり、複数のラボで同じイメージを使用できます。

## <a name="separating-costs"></a>コストの分離

一部の大学では、さまざまなクラスを分離する方法としてラボ アカウントとリソース グループを使用してきました。  各クラスには、独自のラボ アカウントとリソース グループがあります。 [コスト分析] ペインで、クラスの適切なリソース グループ名を使用してリソース グループ名に基づくフィルターを追加すると、そのクラスのコストのみが表示されます。  これにより、コストを表示するときにさまざまなクラス間のより明確な描写が可能になります。  コスト分析の[スケジュールされたエクスポート](https://docs.microsoft.com/azure/cost-management-billing/costs/tutorial-export-acm-data)機能を使用すると、各クラスのコストを別々のファイルとしてダウンロードできます。

## <a name="managing-costs"></a>コストの管理

クラスの種類によっては、コストを管理して、マシンを使用している学生がいない状態で VM が実行されることを減らす方法があります。

### <a name="maximize-cost-control-with-auto-shutdown-settings"></a>自動シャットダウン設定を使用してコスト管理を最大化する

自動シャットダウンのコスト管理機能を使用すると、ラボ内での仮想マシンの使用時間の無駄を事前に防止できます。 次の 3 つの自動シャットダウンおよび切断機能を組み合わせると、ユーザーが誤って仮想マシンを実行状態のまま放置するケースのほとんどを捕捉できます。

> [!div class="mx-imgBorder"]
> ![サブスクリプションのコスト分析](./media/cost-management-guide/auto-shutdown-disconnect.png)

これらの設定は、ラボ アカウント レベルとラボ レベルの両方で構成できます。 これらの設定がラボ アカウント レベルで有効になっている場合は、そのラボ アカウント内のすべてのラボに適用されます。 すべての新しいラボ アカウントでは、これらの設定が既定で有効になります。 

#### <a name="details-about-auto-shutdown-settings"></a>自動シャットダウン設定の詳細

* OS がアイドル状態と見なした仮想マシンからユーザーを自動的に切断する (Windows のみ)。

    > [!NOTE]
    > この設定は、Windows 仮想マシンでのみ使用できます。

    この設定が有効になっている場合、Windows OS がそのセッションをアイドル状態と見なすと、ユーザーはラボ内のすべてのコンピューター (テンプレート仮想マシンを含む) から切断されます。 [Windows OS のアイドル状態の定義](https://docs.microsoft.com/windows/win32/taskschd/task-idle-conditions#detecting-the-idle-state)では、次の 2 つの条件が使用されます。 

    * ユーザーが不在 – キーボードまたはマウスの入力がない。
    * リソース消費がない – すべてのプロセッサとすべてのディスクが時間の一定の割合 (%) の間アイドル状態であった。

    ユーザーが切断される前に、仮想マシン内に次のようなメッセージが表示されます。 

    > [!div class="mx-imgBorder"]
    > ![サブスクリプションのコスト分析](./media/cost-management-guide/idle-timer-expired.png)
    
    ユーザーが切断されても、仮想マシンは引き続き実行中です。 ユーザーがサインインして仮想マシンに再接続した場合、以前開いていたウィンドウやファイル、または切断の前に保存されていない作業は引き続きそこに存在します。 この状態では、仮想マシンは実行中であるため、引き続きアクティブとしてカウントされ、コストが発生します。 
    
    切断されているアイドル状態の Windows 仮想マシンを自動的にシャットダウンするには、 **[仮想マシンがアイドル状態のときにユーザーを切断する]** と **[ユーザーが切断したときに仮想マシンをシャットダウンする]** の設定の組み合わせを使用します。

    たとえば、これらの設定を次のように構成したとします。
    
    * [仮想マシンがアイドル状態のときにユーザーを切断する] – アイドル状態が検出されてから 15 分後。
    * [ユーザーが切断したときに仮想マシンをシャットダウンする] – ユーザーが切断されてから 5 分後。
    
    Windows 仮想マシンは、ユーザーがその使用を停止してから 20 分後に自動的にシャットダウンされます。 
    
    > [!div class="mx-imgBorder"]
    > ![サブスクリプションのコスト分析](./media/cost-management-guide/vm-idle-diagram.png)
* ユーザーが切断したときに仮想マシンを自動的にシャットダウンする (Windows および Linux)。
    
    この設定では、Windows 仮想マシンと Linux 仮想マシンの両方がサポートされます。 この設定が有効になっている場合は、次の場合に自動シャットダウンが発生します。
    
    * Windows の場合は、リモート デスクトップ (RDP) 接続が切断されている。
    * Linux の場合は、SSH 接続が切断されている。
    
    > [!NOTE]
    > [特定のディストリビューションとバージョンの Linux](https://docs.microsoft.com/azure/virtual-machines/extensions/diagnostics-linux#supported-linux-distributions) のみがサポートされています。
    
    自動シャットダウンの前に、仮想マシンがユーザーの再接続を待つ時間の長さを指定できます。 
* 起動したがユーザーが接続しない仮想マシンを自動的にシャットダウンする。
     
    ラボ内では、ユーザーが仮想マシンを起動したが、それに接続しないことがあります。 次に例を示します。
    
    * ラボ内のスケジュールではクラス セッションのすべての仮想マシンが起動されるが、一部の学生が現れず、自分のコンピューターに接続しない。  
    * ユーザーが仮想マシンを起動したが、接続するのを忘れる。 
    
    [ユーザーが接続していないときに仮想マシンをシャットダウンする] の設定によってこれらのケースがキャッチされ、仮想マシンが自動的にシャットダウンされます。  
    
切断時の VM の自動シャットダウンを構成して有効にする方法については、次の記事を参照してください。

* [ラボ アカウント用に VM の自動シャットダウンを構成する](how-to-configure-lab-accounts.md)
* [ラボの VM の自動シャットダウンを構成する](how-to-enable-shutdown-disconnect.md)

### <a name="quota-vs-scheduled-time"></a>クォータとスケジュールされた時間

[クォータ時間](classroom-labs-concepts.md#quota)と[スケジュールされた時間](classroom-labs-concepts.md#schedules)の違いを理解すると、ラボの所有者は、教授と学生のニーズにより適合するようにラボを構成することができます。  スケジュールされた時間とは、すべての学生の VM が開始されて接続可能になる、設定された時間のことです。  一般的に、スケジュールされた時間は、授業時間のように、1 日のうちの設定された時間に、すべての学生が自分の VM を使用し、教授の指示に従っている状況で使用されます。  欠点は、VM にログインしていない学生がいても、すべての学生の VM が起動され、コストが発生することです。  クォータ時間とは、各学生に割り当てられる時間で、これは各自の判断で使用でき、多くの場合、自主的な研究に使用されます。 VM は、学生が VM を起動するまで起動されません。  

ラボは、クォータ時間、スケジュールされた時間、またはその両方を組み合わせて使用できます。 クラスにスケジュールされた時間が必要ない場合は、VM を最も効果的に使用するために、クォータ時間のみを使用します。

### <a name="scheduled-event---stop-only"></a>スケジュール化されたイベント - 停止のみ

[スケジュール] で、特定の時刻にすべてのマシンを停止する「停止のみ」のイベントの種類を追加できます。  一部のラボ所有者は、毎日午前 0 時に「停止のみ」のイベントを設定して、学生が自分が使用している VM のシャットダウンを忘れたときのコストとクォータ使用量を削減しています。  この種類のイベントの欠点は、学生が VM を使用している場合でも、すべての VM がシャットダウンされることです。

### <a name="other-costs-related-to-labs"></a>ラボに関連するその他のコスト 

Lab Services には含まれないが、ラボ サービスに関連付けることができるコストがあります。  Shared Image Gallery はラボに接続できますが Lab Services のコストの下には表示されず、コストはかかります。  イメージには継承ストレージ コストがあるため、全体的なコストを抑えるためには、使用されていないイメージをすべてギャラリーから削除する必要があります。  ラボは、仮想ネットワーク (VNet) によって他の Azure リソースに接続できます。ラボが削除された場合は、VNet および他のリソースを削除する必要があります。

## <a name="conclusion"></a>まとめ

上記の情報を使用することで、使用コストについて、および提供されているツールを使用して余分なコストを削減する方法について、より深く理解することができます。
