---
title: "Azure CDN ルール エンジンの機能 | Microsoft Docs"
description: "Azure CDN ルール エンジンの一致条件と機能に関するリファレンス ドキュメント。"
services: cdn
documentationcenter: 
author: Lichard
manager: akucer
editor: 
ms.assetid: 669ef140-a6dd-4b62-9b9d-3f375a14215e
ms.service: cdn
ms.workload: media
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 01/23/2017
ms.author: rli
translationtype: Human Translation
ms.sourcegitcommit: dccb945e170bd3e3f23283359db25e574a2d4296
ms.openlocfilehash: 6703247aa8b4a6d53ff22ea2d4f22eb4a746e370
ms.lasthandoff: 01/25/2017


---

# <a name="azure-cdn-rules-engine-features"></a>Azure CDN ルール エンジンの機能
このトピックでは、Azure Content Delivery Network (CDN) [ルール エンジン](cdn-rules-engine.md)で利用できると機能について詳しく説明します。

ルールの&3; 番目の部分は、機能です。 一連の一致条件で要求の種類が識別され、その要求に特定のアクションが適用されるとき、機能によりそのアクションの種類が定義されます。

## <a name="access"></a>Access (アクセス)

以下の機能でコンテンツのアクセスが制御されます。


名前 | 目的
-----|--------
Deny Access (アクセス拒否) | すべての要求を拒否し、「403 Forbidden」応答を返すかどうかを決定します。
Token Auth (トークン認証) | トークン基準の認証を要求に適用するかどうかを決定します。
Token Auth Denial Code (トークン認証拒否コード) | トークン基準の認証により要求が拒否されるとき、ユーザーに返す応答の種類を決定します。
Token Auth Ignore URL Case (トークン認証の URL 大文字/小文字の無視) | トークン基準の認証で URL を比較するとき、大文字と小文字を区別するかどうかを決定します。
Token Auth Parameter (トークン認証パラメーター) | トークン基準の認証のクエリ文字列パラメーターの名前を変更するかどうかを決定します。

### <a name="deny-access"></a>Deny Access (アクセス拒否)
**目的**: すべての要求を拒否し、「403 Forbidden」応答を返すかどうかを決定します。

値 | 結果
------|-------
有効| 一致条件を満たすすべての要求を拒否し、「403 Forbidden」応答を返します。
無効| 既定の動作を復元します。 既定の動作では、返される応答の種類を配信元サーバーが決定できます。

**既定の動作**: Disabled

> [!TIP]
   > この機能の用途の&1; つは、コンテンツへのインライン リンクを使用している HTTP 参照元へのアクセスをブロックするために要求ヘッダーの一致条件に関連付けることです。

### <a name="token-auth"></a>Token Auth (トークン認証)
**目的:** トークン基準の認証を要求に適用するかどうかを決定します。

トークン基準の認証が有効になっている場合は、暗号化されたトークンを提供し、そのトークンで指定されている要件に準拠している要求だけが受け入れられます。

トークン値の暗号化と暗号化解除に使用される暗号化キーは、[Token Auth (トークン認証)] ページの [Primary Key (主キー)] および [Backup Key (バックアップ キー)] オプションによって決まります。 暗号化キーはプラットフォームに固有であることに注意してください。

値 | 結果
------|---------
有効 | 要求されたコンテンツをトークン基準の認証によって保護します。 有効なトークンを提供し、その要件を満たしているクライアントからの要求のみが受け入れられます。 FTP トランザクションはトークン基準の認証から除外されます。
無効| 既定の動作を復元します。 既定の動作では、要求が保護されるかどうかはトークン基準の認証構成によって決まります。

**既定の動作:** Disabled。

###<a name="token-auth-denial-code"></a>Token Auth Denial Code (トークン認証拒否コード)
**目的:** トークン基準の認証により要求が拒否されるとき、ユーザーに返す応答の種類を決定します。

使用可能な応答コードは、次のとおりです。

応答コード|応答名|説明
----------------|-----------|--------
301|Moved Permanently|この状態コードでは、Location ヘッダーで指定された URL に未承認のユーザーがリダイレクトされます。
302|Found|この状態コードでは、Location ヘッダーで指定された URL に未承認のユーザーがリダイレクトされます。 この状態コードは、リダイレクトを実行する業界標準の方法です。
307|Temporary Redirect|この状態コードでは、Location ヘッダーで指定された URL に未承認のユーザーがリダイレクトされます。
401|権限がありません|この状態コードを WWW-Authenticate 応答ヘッダーと組み合わせることにより、認証を求めるプロンプトをユーザーに表示することができます。
403|許可されていません|これは、未認証のユーザーが保護されたコンテンツにアクセスしようとしたときに表示される標準の 403 Forbidden 状態メッセージです。
404|File Not Found|この状態コードは、HTTP クライアントがサーバーと通信できたが要求されたコンテンツは見つからなかったことを示します。

#### <a name="url-redirection"></a>URL Redirection (URL リダイレクト)

この機能では、3xx 状態コードを返すように構成された場合に、ユーザー定義 URL への URL リダイレクトがサポートされます。 このユーザー定義 URL は、次の手順を実行することによって指定できます。

1. Token Auth Denial Code (トークン認証拒否コード) 機能用の 3xx 応答コードを選択します。
2. [Optional Header Name (省略可能なヘッダー名)] オプションから "Location" を選択します。
3. [Optional Header Value (省略可能なヘッダー値)] オプションを目的の URL に設定します。

3xx 状態コード用の URL が定義されていない場合は、3xx 状態コード用の標準の応答ページがユーザーに返されます。

URL リダイレクトは 3xx 応答コードにのみ適用されます。

[Optional Header Value (省略可能なヘッダー値)] オプションでは、英数字、引用符、スペースがサポートされます。

#### <a name="authentication"></a>認証

この機能により、トークン基準の認証によって保護されたコンテンツに関する未承認の要求に応答するときに WWW-Authenticate ヘッダーを含めることが可能になります。 構成で WWW-Authenticate ヘッダーが "basic" に設定されている場合、未承認のユーザーにはアカウントの資格情報を入力するように求められます。

上記の構成は、次の手順を実行することによって実現できます。

1. Token Auth Denial Code (トークン認証拒否コード) 機能用の応答コードとして "401" を選択します。
2. [Optional Header Name (省略可能なヘッダー名)] オプションから "WWW-Authenticate" を選択します。
3. [Optional Header Value (省略可能なヘッダー値)] オプションを "basic" に設定します。

WWW-Authenticate ヘッダーは、401 応答コードでのみ適用されます。

### <a name="token-auth-ignore-url-case"></a>Token Auth Ignore URL Case (トークン認証の URL 大文字/小文字の無視)
**目的:** トークン基準の認証で URL を比較するとき、大文字と小文字を区別するかどうかを決定します。

この機能によって影響を受けるパラメーターは、次のとおりです。

- ec_url_allow
- ec_ref_allow
- ec_ref_deny

有効な値は次のとおりです。

値|結果
---|----
有効|エッジ サーバーで URL がトークン基準の認証パラメーターと比較されるときに、大文字小文字が区別されなくなります。
無効|既定の動作を復元します。 既定の動作では、トークン認証で URL が比較されるときに大文字小文字が区別されます。

**既定の動作:** Disabled。
 
### <a name="token-auth-parameter"></a>Token Auth Parameter (トークン認証パラメーター)
**目的:** トークン基準の認証のクエリ文字列パラメーターの名前を変更するかどうかを決定します。

重要な情報: 

- [Value (値)] オプションにより、トークンを指定するために使用できるクエリ文字列パラメーター名が定義されます。
- [Value (値)] オプションを "ec_token" に設定することはできません。
- [Value (値)] オプションで定義する名前には 
- 有効な URL 文字のみを含めてください。

値|結果
----|----
有効|[Value (値)] オプションにより、トークンを定義するのに使用する必要のあるクエリ文字列パラメーター名が定義されます。
無効|要求 URL でトークンを未定義のクエリ文字列パラメーターとして指定することができます。

**既定の動作:** Disabled。 要求 URL でトークンを未定義のクエリ文字列パラメーターとして指定することができます。

## <a name="caching"></a>Caching (キャッシュ)

以下の機能でコンテンツをキャッシュするタイミングと方法をカスタマイズできます。

名前 | 目的
-----|--------
Bandwidth Parameters (帯域幅パラメーター) | 帯域幅調整パラメーター (すなわち、ec_rate と ec_prebuf) が有効になっているかどうかを決定します。
Bandwidth Throttling (帯域幅調整) | エッジ サーバーからの応答の帯域幅を調整します。
Bypass Cache (キャッシュ バイパス) | 要求がキャッシュ技術を活用できるかどうかを判断します。
Cache-Control Header Treatment (キャッシュ制御ヘッダーの処理) | 外部最長有効期間機能がアクティブになっているとき、エッジ サーバーでキャッシュ制御ヘッダーの生成を制御します。
Cache-Key Query String (キャッシュキー クエリ文字列) | 要求に関連付けられているクエリ文字列パラメーターをキャッシュキーに含めるかどうかを決定します。
Cache-Key Rewrite (キャッシュキー書き換え) | 要求に関連付けられているキャッシュ キーを書き換えます。
Complete Cache Fill (完全キャッシュ入力) | 要求の結果、エッジ サーバーで一部のキャッシュが不足したときの動作を決定します。
Compress File Types (圧縮ファイルの種類) | サーバーで圧縮されるファイル形式を定義します。
Default Internal Max-Age (既定の内部最長有効期間) | エッジ サーバーと配信元サーバーの間のキャッシュ再有効化の既定の最長有効期間を決定します。
Expires Header Treatment (Expires ヘッダーの処理) | 外部最長有効期間機能がアクティブになっているとき、エッジ サーバーで Expires ヘッダーの生成を制御します。
External Max-Age (外部最長有効期間) | ブラウザーとエッジ サーバーの間のキャッシュ再有効化の最長有効期間を決定します。
Force Internal Max-Age (内部最長有効期間の強制) | エッジ サーバーと配信元サーバーの間のキャッシュ再有効化の最長有効期間を決定します。
H.264 Support (HTTP Progressive Download) (H.264 サポート (HTTP プログレッシブ ダウンロード)) | コンテンツのストリーム配信に使用される H.264 ファイル形式の種類を決定します。
Honor No-Cache Request (キャッシュなし要求の許可) | HTTP クライアントのキャッシュなし要求を配信元サーバーに転送するかどうかを決定します。
Ignore Origin No-Cache (配信元のキャッシュなしを無視する) | 配信元サーバーから提供された特定の指令を CDN が無視するかどうかを決定します。
Ignore Unsatisfiable Ranges (満たされない範囲を無視する) | 要求で「416 Requested Range Not Satisfiable」ステータス コードが生成されるとき、クライアントに返される応答を決定します。
Internal Max-Stale (内部 Max-Stale) | エッジ サーバーが配信元サーバーでキャッシュされたアセットを再有効化できないとき、通常の有効期間を過ぎてから、キャッシュされたアセットをエッジ サーバーから提供できる期間を制御します。
Partial Cache Sharing (部分キャッシュ共有) | 部分的にキャッシュされたコンテンツを要求で生成できるかどうかを決定します。
Prevalidate Cached Content (キャッシュされたコンテンツの事前検証) | TTL が期限切れになる前に、キャッシュされたコンテンツに早期検証の資格が与えられるかどうかを決定します。
Refresh Zero-Byte Cache Files (ゼロバイト キャッシュ ファイルの更新) | ゼロバイトのキャッシュ アセットに対する HTTP クライアントの要求をエッジ サーバーが処理する方法を決定します。
Set Cacheable Status Codes (キャッシュ可能ステータス コードの設定) | 結果としてコンテンツがキャッシュされるステータス コードのセットを定義します。
Stale Content Delivery on Error (エラー時の古いコンテンツ配信) | キャッシュ再検証中にエラーが発生したとき、または顧客の配信元サーバーから要求されたコンテンツを取得するとき、期限切れになったキャッシュ済みコンテンツを配信するかどうかを決定します。
Stale While Revalidate (古いキャッシュを返し、同時に再検証) | 古いクライアントを要求元に提供することをエッジ サーバーに許可し、同時に再検証する
Comment (コメント) | Comment (コメント) 機能では、ルール内にメモを追加できます。

###<a name="bandwidth-parameters"></a>Bandwidth Parameters (帯域幅パラメーター)
**目的:** 帯域幅調整パラメーター (つまり、ec_rate と ec_prebuf) が有効になっているかどうかを決定します。

帯域幅調整パラメーターは、クライアントの要求に関するデータ転送率をカスタムの比率に制限するかどうかを決定します。

値|結果
--|--
有効|エッジ サーバーで帯域幅調整要求が受け入れられます。
無効|エッジ サーバーで帯域幅調整要求が無視されます。 要求されたコンテンツは通常どおりに (つまり、帯域幅調整なしで) 提供されます。

**既定の動作:** Enabled。

###<a name="bandwidth-throttling"></a>Bandwidth Throttling (帯域幅調整)
**目的:** エッジ サーバーからの応答の帯域幅を調整します。

帯域幅調整を正しく設定するには、次のオプションの両方を定義する必要があります。

オプション|Description
--|--
Kbytes per second (kb/秒)|このオプションは、応答を提供するために使用できる最大帯域幅 (Kb/秒) に設定します。
Prebuf seconds (Prebuf 秒)|このオプションは、エッジ サーバーが帯域幅の調整前に待機する秒数に設定します。 帯域幅を制限しないこの期間の目的は、メディア プレーヤーで帯域幅調整によって途切れ途切れの再生やバッファリングの問題が発生するのを防ぐことです。

**既定の動作:** Disabled。

###<a name="bypass-cache"></a>Bypass Cache (キャッシュ バイパス)
**目的:** 要求がキャッシュ技術を活用できるかどうかを判断します。

値|結果
--|--
有効|コンテンツが以前にエッジ サーバーでキャッシュされた場合でも、すべての要求が配信元サーバーにフォールスルーされます。
無効|応答ヘッダーで定義されているキャッシュ ポリシーに従い、エッジ サーバーで資産がキャッシュされます。

**既定の動作:**

- **HTTP ラージ:** 無効

<!---
- **ADN:** Enabled
--->

###<a name="cache-control-header-treatment"></a>Cache Control Header Treatment (Cache-Control ヘッダーの処理)
**目的:** External Max-Age (外部最長有効期間) 機能がアクティブになっているとき、エッジ サーバーで Cache-Control ヘッダーの生成を制御します。

この種類の構成を実現する最も簡単な方法は、同じステートメントに External Max-Age (外部最長有効期間) と Cache-Control Header Treatment (Cache-Control ヘッダーの処理) 機能を配置することです。

値|結果
--|--
上書き|次のアクションが行われるようにします。<br/> - 配信元サーバーによって生成された Cache-Control ヘッダーを上書きします。 <br/>- External Max-Age (外部最長有効期間) 機能によって生成された Cache-Control ヘッダーを応答に追加します。
Pass Through (パススルー)|External Max-Age (外部最長有効期間) 機能によって生成された Cache-Control ヘッダーが応答に追加されないようにします。 <br/> 配信元サーバーで Cache-Control ヘッダーが生成された場合は、エンドユーザーにパススルーされます。 <br/> 配信元サーバーで Cache-Control ヘッダーが生成されない場合は、応答ヘッダーに Cache-Control ヘッダーが含まれなくなることがあります。
Add if Missing (ない場合に追加)|Cache-Control ヘッダーが配信元サーバーから受信されなかった場合に、External Max-Age (外部最長有効期間) 機能によって生成された Cache-Control ヘッダーが追加されます。 このオプションは、Cache-Control ヘッダーがすべての資産に割り当てられるようにするのに役立ちます。
Remove| このオプションでは、Cache-Control ヘッダーがヘッダー応答に含まれなくなります。 Cache-Control ヘッダーが既に割り当てられている場合は、ヘッダー応答から取り除かれます。

**既定の動作**: Overwrite。

###<a name="cache-key-query-string"></a>Cache-Key Query String (キャッシュキー クエリ文字列)
**目的:** 要求に関連付けられているクエリ文字列パラメーターをキャッシュキーに含めるかどうかを決定します。

重要な情報: 

- 1 つまたは複数のクエリ文字列パラメーター名を指定します。 各パラメーター名は単一の空白で区切る必要があります。
- この機能は、クエリ文字列パラメーターをキャッシュキーに含めるかどうかを決定します。 各オプションの追加情報は以下のとおりです。

型|説明
--|--
 Include (含める)|  各パラメーターをキャッシュキーに含めることを示します。 この機能で定義されているクエリ文字列パラメーターについて一意の値を含む要求ごとに、一意のキャッシュキーが生成されます。 
 Include All (すべて含める)  |一意のクエリ文字列を含む資産への要求ごとに、一意のキャッシュキーが作成されることを示します。 キャッシュ ヒットの割合が低くなる可能性があるため、この種類の構成は通常は推奨されません。 より多くの要求を処理する必要があるため、配信元サーバーの負荷が増加します。 この構成では、[クエリ文字列のキャッシュ] ページで "unique-cache" と呼ばれるキャッシュ動作が複製されます。 
 Exclude (除外) | 指定したパラメーターのみがキャッシュキーから除外されることを示します。 その他のすべてのクエリ文字列パラメーターはキャッシュキーに含まれます。 
 Exclude All (すべて除外)  |すべてのクエリ文字列パラメーターがキャッシュキーから除外されることを示します。 この構成では、[クエリ文字列のキャッシュ] ページで "standard-cache" と呼ばれる既定のキャッシュ動作が複製されます。 

HTTP ルール エンジンの機能を使用すると、クエリ文字列キャッシュの実装方法をカスタマイズすることができます。 たとえば、クエリ文字列キャッシュが特定の場所またはファイルの種類でのみ実行されるように指定できます。

[クエリ文字列のキャッシュ] ページで "no-cache" と呼ばれるキャッシュ動作を複製したい場合は、URL Query Wildcard (URL クエリ ワイルドカード) 一致条件と Bypass Cache (キャッシュ バイパス) 機能を含むルールを作成する必要があります。 URL クエリ ワイルドカード一致条件はアスタリスク (*) に設定してください。

#### <a name="sample-scenarios"></a>サンプル シナリオ

この機能の使用例を以下に示します。 サンプルの要求と既定のキャッシュキーを下に示します。

- **サンプルの要求:** http://wpc.0001.&lt;Domain&gt;/800001/Origin/folder/asset.htm?sessionid=1234&language=EN&userid=01
- **既定のキャッシュキー:** /800001/Origin/folder/asset.htm

##### <a name="include"></a>Include (含める)

サンプル構成:

- **型:** Include
- **パラメーター:** language

この種類の構成では、次のクエリ文字列パラメーター キャッシュキーが生成されます。

    /800001/Origin/folder/asset.htm?language=EN

##### <a name="include-all"></a>Include All (すべて含める)

サンプル構成:

- **型:** Include All

この種類の構成では、次のクエリ文字列パラメーター キャッシュキーが生成されます。

    /800001/Origin/folder/asset.htm?sessionid=1234&language=EN&userid=01

##### <a name="exclude"></a>Exclude (除外)

サンプル構成:

- **型:** Exclude
- **パラメーター:** sessionid userid

この種類の構成では、次のクエリ文字列パラメーター キャッシュキーが生成されます。

    /800001/Origin/folder/asset.htm?language=EN

##### <a name="exclude-all"></a>Exclude All (すべて除外)

サンプル構成:

- **型:** Exclude All

この種類の構成では、次のクエリ文字列パラメーター キャッシュキーが生成されます。

    /800001/Origin/folder/asset.htm

###<a name="cache-key-rewrite"></a>Cache-Key Rewrite (キャッシュキー書き換え)
**目的:** 要求に関連付けられているキャッシュキーを書き換えます。

キャッシュキーとは、キャッシュの目的で資産を識別する相対パスのことです。 つまり、サーバーは、キャッシュキーによって定義されているパスに従って、資産のキャッシュされたバージョンがないかどうかを確認します。

この機能は、次のオプションの両方を定義することによって構成します。

オプション|説明
--|--
Original Path (元のパス)| キャッシュキーが書き換えられる要求の種類への相対パスを定義します。 相対パスは、ベースとなる配信元のパスを選択してから正規表現パターンを定義することによって定義できます。
New Path (新しいパス)|新しいキャッシュキーの相対パスを定義します。 相対パスは、ベースとなる配信元のパスを選択してから正規表現パターンを定義することによって定義できます。 この相対パスは、HTTP 変数を使用することによって動的に構築することができます
**既定の動作:** 要求のキャッシュキーは要求 URI によって決定されます。

###<a name="complete-cache-fill"></a>Complete Cache Fill (完全キャッシュ入力)
**目的:** 要求の結果、エッジ サーバーで一部のキャッシュが不足したときの動作を決定します。

一部のキャッシュの不足は、資産に関するキャッシュがエッジ サーバーに完全にはダウンロードされなかった状態を示します。 資産が部分的にのみエッジ サーバーでキャッシュされている場合、その資産に関する次の要求は配信元サーバーにもう一度転送されます。
<!---
This feature is not available for the ADN platform. The typical traffic on this platform consists of relatively small assets. The size of the assets served through these platforms helps mitigate the effects of partial cache misses, since the next request will typically result in the asset being cached on that POP.
--->
通常、一部のキャッシュの不足は、ユーザーがダウンロードを中止した後や、HTTP 範囲要求を使用して単独で要求された資産について発生します。 この機能は、ユーザーが最初から最後までダウンロードしないことのある大きい資産 (ビデオなど) の場合に役立ちます。 そのため、この機能は HTTP ラージ プラットフォームでは既定で有効になっています。 その他のすべてのプラットフォームでは無効になっています。

顧客の配信元サーバーの負荷を軽減し、顧客がコンテンツをダウンロードする速度を上げるため、HTTP ラージ プラットフォームでは既定の構成のままにしておくことをお勧めします。

キャッシュ設定を追跡する方法が原因で、この機能を次の一致条件に関連付けることはできません。エッジ CNAME、要求ヘッダーのリテラル、要求ヘッダーのワイルドカード、URL クエリ リテラル、URL クエリ ワイルドカード。

値|結果
--|--
有効|既定の動作を復元します。 既定の動作では、エッジ サーバーで配信元サーバーからの資産のバックグラウンド取得が開始されます。 その後、資産はエッジ サーバーのローカル キャッシュに入れられます。
無効|エッジ サーバーで資産のバックグラウンド取得が実行されないようにします。 これは、そのリージョンからその資産が次に要求されたときに、エッジ サーバーで顧客の配信元サーバーに対してそれが要求されることを意味します。

**既定の動作:** Enabled。

###<a name="compress-file-types"></a>Compress File Types (圧縮ファイルの種類)
**目的:** サーバーで圧縮されるファイル形式を定義します。

ファイル形式はインターネット メディア タイプ (つまり Content-Type) を使用して指定できます。 インターネット メディア タイプは、サーバーが特定の資産のファイル形式を識別できるようにする、プラットフォームに依存しないメタデータです。 一般的なインターネット メディア タイプの一覧を下に示します。

インターネット メディア タイプ|Description
--|--
text/plain|プレーン テキスト ファイル (.txt)
text/html| HTML ファイル
text/css|カスケード スタイル シート (CSS)
application/x-javascript|JavaScript
application/javascript|JavaScript
重要な情報: 

- 複数のインターネット メディア タイプを指定する場合は、単一の空白で区切ります。 
- この機能では、サイズが 1 MB 未満の資産のみが圧縮されます。 これより大きい資産はサーバーで圧縮されません。
- イメージ、ビデオ、オーディオ メディア資産などの特定の種類のコンテンツ (たとえば、JPG、MP3、MP4 など) は既に圧縮されています。 これらの種類の資産をさらに圧縮しても、ファイル サイズが大幅に小さくなることはありません。 そのため、これらの種類の資産では圧縮を有効にしないことをお勧めします。
- アスタリスクなどのワイルドカード文字はサポートされていません。
- ルールにこの機能を追加する前に、このルールの適用先となるプラットフォームの [圧縮] ページで必ず [Compression Disabled (圧縮の無効化)] オプションを設定してください。

###<a name="default-internal-max-age"></a>Default Internal Max-Age (既定の内部最長有効期間)
**目的:** エッジ サーバーと配信元サーバーの間のキャッシュ再有効化の既定の最長有効期間を決定します。 つまり、キャッシュされた資産が配信元サーバーに格納されている資産と一致するかどうかをエッジ サーバーが確認するまでの時間です。

重要な情報: 

- このアクションは、Cache-Control または Expires ヘッダーで最長有効期間が割り当てられていない配信元サーバーからの応答についてのみ実行されます。
- このアクションは、キャッシュ可能と判断された資産については実行されません。
- このアクションは、ブラウザーとエッジ サーバーの間のキャッシュ再有効化には影響しません。 これらの種類の再有効化は、ブラウザーに送信された Cache-Control または Expires ヘッダーによって決定され、External Max-Age (外部最長有効期間) 機能によってカスタマイズできます。
- このアクションの結果は、エッジ サーバーから返される応答ヘッダーとコンテンツに対して目に見える影響はありませんが、エッジ サーバーから配信元サーバーに送信される再有効化トラフィックの量に影響する可能性があります。
- この機能は、次のように構成します。
    - 既定の内部最長有効期間を適用できる状態コードを選択します。
    - 整数値を指定してから、目的の時間単位 (つまり、秒、分、時間など) を選択します。 この値により、既定の内部最長有効期間が定義されます。

- 時間単位を "Off" に設定すると、Cache-Control または Expires ヘッダーで最長有効期間が割り当てられていない要求について、既定の内部最長有効期間である 7 日が割り当てられます。
- キャッシュ設定を追跡する方法が原因で、この機能を次の一致条件に関連付けることはできません。 
    - Edge  
    - Cname (エッジ CNAME)
    - Request Header Literal (要求ヘッダーのリテラル)
    - Request Header Wildcard (要求ヘッダーのワイルドカード)
    - Request Method (要求メソッド)
    - URL Query Literal (URL クエリ リテラル)
    - URL Query Wildcard (URL クエリ ワイルドカード)

**既定値:** 7 日

###<a name="expires-header-treatment"></a>Expires Header Treatment (Expires ヘッダーの処理)
**目的:** External Max-Age (外部最長有効期間) 機能がアクティブになっているとき、エッジ サーバーで Expires ヘッダーの生成を制御します。

この種類の構成を実現する最も簡単な方法は、同じステートメントに External Max-Age (外部最長有効期間) と Expires Header Treatment (Expires ヘッダーの処理) 機能を配置することです。

値|結果
--|--
上書き|次のアクションが行われるようにします。<br/>- 配信元サーバーによって生成された Expires ヘッダーを上書きします。<br/>- External Max-Age (外部最長有効期間) 機能によって生成された Expires ヘッダーを応答に追加します。
Pass Through (パススルー)|External Max-Age (外部最長有効期間) 機能によって生成された Expires ヘッダーが応答に追加されないようにします。 <br/> 配信元サーバーで Expires ヘッダーが生成された場合は、エンドユーザーにパススルーされます。 <br/>配信元サーバーで Expires ヘッダーが生成されない場合は、応答ヘッダーに Expires ヘッダーが含まれなくなることがあります。
Add if Missing (ない場合に追加)| Expires ヘッダーが配信元サーバーから受信されなかった場合に、External Max-Age (外部最長有効期間) 機能によって生成された Expires ヘッダーが追加されます。 このオプションは、Expires ヘッダーがすべての資産に割り当てられるようにするのに役立ちます。
Remove| Expires ヘッダーがヘッダー応答に含まれなくなります。 Expires ヘッダーが既に割り当てられている場合は、ヘッダー応答から取り除かれます。

**既定の動作**: Overwrite

###<a name="external-max-age"></a>External Max-Age (外部最長有効期間)
**目的:** ブラウザーとエッジ サーバーの間のキャッシュ再有効化の最長有効期間を決定します。 つまり、ブラウザーがエッジ サーバーに対して資産の新しいバージョンを確認するまでの時間です。

この機能を有効にすると、エッジ サーバーから Cache-Control:max-age および Expires ヘッダーが生成され、HTTP クライアントに送信されます。 既定では、これらのヘッダーにより、配信元サーバーで作成されたヘッダーが上書きされます。 ただし、この動作は Cache-Control Header Treatment (Cache-Control ヘッダーの処理) および Expires Header Treatment (Expires ヘッダーの処理) 機能を使用して変更することができます。

重要な情報: 

- このアクションは、エッジ サーバーと配信元サーバーの間のキャッシュ再有効化には影響しません。 これらの種類の再有効化は、配信元サーバーから受信された Cache-Control/Expires ヘッダーによって決定され、Default Internal Max-Age (既定の内部最長有効期間) および Force Internal Max-Age (内部最長有効期間の強制) 機能によってカスタマイズできます。
- この機能を構成するには、整数値を指定して目的の時間単位 (つまり、秒、分、時間など) を選択します。
- この機能を負の値に設定すると、エッジ サーバーからブラウザーへの各応答と共に、Cache-Control:no-cache と過去に設定された Expires 時間が送信されます。 応答は HTTP クライアントでキャッシュされませんが、この設定は配信元サーバーからの応答をキャッシュするエッジ サーバーの機能に影響しません。
- 時間単位を "Off" に設定すると、この機能は無効になります。 配信元サーバーの応答と共にキャッシュされる Cache-Control/Expires ヘッダーは、ブラウザーにパススルーされます。

**既定の動作:** Off

###<a name="force-internal-max-age"></a>Force Internal Max-Age (内部最長有効期間の強制)
**目的:** エッジ サーバーと配信元サーバーの間のキャッシュ再有効化の最長有効期間を決定します。 つまり、キャッシュされた資産が配信元サーバーに格納されている資産と一致するかどうかをエッジ サーバーが確認できるまでの時間です。

重要な情報: 

- この機能では、配信元サーバーから生成された Cache-Control または Expires ヘッダーで定義された最長有効期間が上書きされます。
- この機能は、ブラウザーとエッジ サーバーの間のキャッシュ再有効化には影響しません。 これらの種類の再有効化は、ブラウザーに送信された Cache-Control または Expires ヘッダーによって決定されます。
- この機能では、エッジ サーバーから要求元に配信される応答に対して目に見える影響はありません。 ただし、エッジ サーバーから配信元サーバーに送信される再有効化トラフィックの量に影響する可能性があります。
- この機能は、次のように構成します。
    - 内部最長有効期間が適用される状態コードを選択します。
    - 整数値を指定して、目的の時間単位 (つまり、秒、分、時間など) を選択します。 この値により、要求の最長有効期間が定義されます。

- 時間単位を "Off" に設定すると、この機能は無効になります。 内部最長有効期間は、要求された資産に割り当てられません。 元のヘッダーにキャッシュに関する指示が含まれていない場合、資産は Default Internal Max-Age (既定の内部最長有効期間) 機能でアクティブな設定に従ってキャッシュされます。
- キャッシュ設定を追跡する方法が原因で、この機能を次の一致条件に関連付けることはできません。 
    - Edge  
    - Cname (エッジ CNAME)
    - Request Header Literal (要求ヘッダーのリテラル)
    - Request Header Wildcard (要求ヘッダーのワイルドカード)
    - Request Method (要求メソッド)
    - URL Query Literal (URL クエリ リテラル)
    - URL Query Wildcard (URL クエリ ワイルドカード)

**既定の動作:** Off

###<a name="h264-support-http-progressive-download"></a>H.264 Support (HTTP Progressive Download) (H.264 サポート (HTTP プログレッシブ ダウンロード))
**目的:** コンテンツのストリーム配信に使用される H.264 ファイル形式の種類を決定します。

重要な情報: 

- [File Extensions (ファイル拡張子)] オプションで許可される H.264 ファイル名拡張子の空白で区切られたセットを定義します。 [File Extensions (ファイル拡張子)] オプションにより、既定の動作が上書きされます。 このオプションを設定する際は、MP4 と F4V のファイル名拡張子を含めることによってこれらのサポートを維持してください。 
- 各ファイル名拡張子を指定する際は必ずピリオドを含めます (.mp4 .f4v など)。

**既定の動作:** HTTP プログレッシブ ダウンロードでは MP4 と F4V メディアが既定でサポートされます。

###<a name="honor-no-cache-request"></a>Honor no-cache request (キャッシュなし要求の許可)
**目的:** HTTP クライアントのキャッシュなし要求を配信元サーバーに転送するかどうかを決定します。

キャッシュなし要求は、HTTP クライアントが HTTP 要求で Cache-Control:no-cache や Pragma:no-cache ヘッダーを送信するときに発生します。

値|結果
--|--
有効|HTTP クライアントのキャッシュなし要求を配信元サーバーに転送することが可能となり、配信元サーバーは応答ヘッダーと本文をエッジ サーバー経由で HTTP クライアントに戻します。
無効|既定の動作を復元します。 既定の動作では、キャッシュなし要求が配信元サーバーに転送されることが防止されます。

すべての実稼働トラフィックについて、この機能を既定の無効状態のままにしておくことをお勧めします。 そうしないと、配信元サーバーは Web ページの更新時に大量のキャッシュなし要求を誤ってトリガーする可能性があるエンドユーザーや、すべてのビデオ要求で no-cache ヘッダーを送信するように設計された多くの一般的なメディア プレーヤーからシールドされません。 ただし、この機能は、配信元サーバーから最新のコンテンツをオンデマンドでプルできるようにするために、特定の非運用のステージングまたはテスト用のディレクトリに適用するのに役立つ可能性があります。

この機能によって配信元サーバーに転送が許可されている要求についてレポートされるキャッシュの状態は TCP_Client_Refresh_Miss です。 コア レポート モジュールで使用できるキャッシュの状態レポートでは、キャッシュの状態ごとに統計情報が提供されます。 これにより、この機能が原因で配信元サーバーに転送されている要求の数と割合を追跡できます。

**既定の動作:** Disabled。

###<a name="ignore-origin-no-cache"></a>Ignore Origin no-cache (配信元のキャッシュなしを無視する)
**目的:** 配信元サーバーから提供された次のディレクティブを CDN が無視するかどうかを決定します。

- Cache-Control: private
- Cache-Control: no-store
- Cache-Control: no-cache
- Pragma: no-cache

重要な情報: 

- この機能を構成するには、上記のディレクティブが無視される状態コードを空白で区切った一覧を定義します。
- この機能について有効な状態コードのセットは、200、203、300、301、302、305、307、400、401、402、403、404、405、406、407、408、409、410、411、412、413、414、415、416、417、500、501、502、503、504、および 505 です。
- この機能を無効にするには、空白の値を設定します。
- キャッシュ設定を追跡する方法が原因で、この機能を次の一致条件に関連付けることはできません。 
    - Edge  
    - Cname (エッジ CNAME)
    - Request Header Literal (要求ヘッダーのリテラル)
    - Request Header Wildcard (要求ヘッダーのワイルドカード)
    - Request Method (要求メソッド)
    - URL Query Literal (URL クエリ リテラル)
    - URL Query Wildcard (URL クエリ ワイルドカード)

**既定の動作:** 既定の動作では、上記のディレクティブを許可します。

###<a name="ignore-unsatisfiable-ranges"></a>Ignore Unsatisfiable Ranges (満たされない範囲を無視する) 
**目的:** 要求で「416 Requested Range Not Satisfiable」状態コードが生成されるとき、クライアントに返される応答を決定します。

既定では、この状態コードは、エッジ サーバーで指定されたバイト範囲要求を満たすことができず、If-Range 要求ヘッダー フィールドが指定されていないときに返されます。

値|結果
-|-
有効|エッジ サーバーが無効なバイト範囲要求に「416 Requested Range Not Satisfiable」状態コードで応答することを防止します。 代わりに、サーバーは要求された資産を配信し、クライアントに「200 OK」を返します。
無効|既定の動作を復元します。 既定の動作では、「416 Requested Range Not Satisfiable」状態コードを許可します。

**既定の動作:** Disabled。

###<a name="internal-max-stale"></a>Internal Max-Stale (内部 Max-Stale)
**目的:** エッジ サーバーが配信元サーバーでキャッシュされた資産を再有効化できないとき、通常の有効期間を過ぎてから、キャッシュされた資産をエッジ サーバーから提供できる期間を制御します。

通常は、資産の最長有効期間が経過すると、エッジ サーバーは再有効化要求を配信元サーバーに送信します。 配信元サーバーは、「304 Not Modified」で応答して、キャッシュされた資産に関する最新のリースをエッジ サーバーを提供するか、「200 OK」で応答して、キャッシュされた資産の更新されたバージョンをエッジ サーバーに提供します。

エッジ サーバーがこのような再有効化の試行時に配信元サーバーとの接続を確立できない場合は、この Internal Max-Stale (内部 Max-Stale) 機能により、エッジ サーバーが古くなった資産を提供し続けるかどうか、およびその期間が制御されます。

この期間は、失敗した再有効化の発生したときではなく、資産の最長有効期間が経過したときに開始されることに注意してください。 したがって、再有効化が成功しないうちに資産を提供できる最長期間は、最長有効期間と max-stale の組み合わせによって指定された時間です。 たとえば、30 分の最長有効期間と 15 分の max-stale を指定して資産が 9:00 にキャッシュされた場合、再有効化が 9:44 に失敗すると、エンドユーザーはキャッシュされた古い資産を受信しますが、最有効化が 9:46 に失敗すると、エンドユーザーは「504 Gateway Timeout」を受信します。

この機能に関する構成値は、配信元サーバーから受信された Cache-Control:must-revalidate または Cache-Control:proxy-revalidate ヘッダーによって上書きされます。 資産が最初にキャッシュされた配信元サーバーからこれらのヘッダーのいずれかが受信された場合、エッジ サーバーはキャッシュされた古い資産を提供しません。 その場合、資産の最長有効期間が経過したときに配信元との間で再有効化を実行できないと、エッジ サーバーは「504 Gateway Timeout」を返します。

重要な情報: 

- この機能は、次のように構成します。
    - max-stale が適用される状態コードを選択します。
    - 整数値を指定してから、目的の時間単位 (つまり、秒、分、時間など) を選択します。 この値により、適用される内部 max-stale が定義されます。

- 時間単位を "Off" に設定すると、この機能は無効になります。 キャッシュされた資産が通常の有効期限を超えて提供されることはありません。
- キャッシュ設定を追跡する方法が原因で、この機能を次の一致条件に関連付けることはできません。 
    - Edge  
    - Cname (エッジ CNAME)
    - Request Header Literal (要求ヘッダーのリテラル)
    - Request Header Wildcard (要求ヘッダーのワイルドカード)
    - Request Method (要求メソッド)
    - URL Query Literal (URL クエリ リテラル)
    - URL Query Wildcard (URL クエリ ワイルドカード)

**既定の動作:** 2 分

###<a name="partial-cache-sharing"></a>Partial Cache Sharing (部分キャッシュ共有)
**目的:** 部分的にキャッシュされたコンテンツを要求で生成できるかどうかを決定します。

その後は、要求されたコンテンツが完全にキャッシュされるまで、この部分的なキャッシュを使用してそのコンテンツに関する新しい要求を満たすことができます。

値|結果
-|-
有効|部分的にキャッシュされたコンテンツを要求で生成できます。
無効|要求されたコンテンツの完全にキャッシュされたバージョンのみを要求で生成できます。

**既定の動作:** Disabled。

###<a name="prevalidate-cached-content"></a>Prevalidate Cached Content (キャッシュされたコンテンツの事前検証)
**目的:** TTL が期限切れになる前に、キャッシュされたコンテンツに早期再有効化の資格が与えられるかどうかを決定します。

要求されたコンテンツの TTL の有効期限が切れる前に早期再有効化の資格が与えられるまでの時間を定義します。

重要な情報: 

- 時間単位として "Off" を選択すると、キャッシュされたコンテンツの TTL が期限切れになった後で再有効化が実行されます。 時間を指定する必要はなく、指定しても無視されます。

**既定の動作:** Off。 再有効化は、キャッシュされたコンテンツの TTL が期限切れになった後にのみ実行されます。

###<a name="refresh-zero-byte-cache-files"></a>Refresh Zero Byte Cache Files (ゼロバイト キャッシュ ファイルの更新)
**目的:** ゼロバイトのキャッシュ資産に対する HTTP クライアントの要求をエッジ サーバーが処理する方法を決定します。

有効な値は次のとおりです。

値|結果
--|--
有効|エッジ サーバーが資産を配信元サーバーから再取得します。
無効|既定の動作を復元します。 既定の動作では、要求時に有効なキャッシュされた資産が提供されます。
この機能は、正しいキャッシュおよびコンテンツ配信のために必要というわけではありませんが、回避策として役に立つ場合があります。 たとえば、配信元サーバー上の動的コンテンツ ジェネレーターにより、誤って 0 バイトの応答がエッジ サーバーに送信される可能性があります。 通常、これらの種類の応答は、エッジ サーバーによってキャッシュされます。 当該のコンテンツで 0 バイトの応答が有効でないことがわかっている場合は、 

この機能を使用してそれらの種類の資産がクライアントに提供されることを防止できます。

**既定の動作:** Disabled。

###<a name="set-cacheable-status-codes"></a>Set Cacheable Status Codes (キャッシュ可能ステータス コードの設定)
**目的:** 結果としてコンテンツがキャッシュされる状態コードのセットを定義します。

既定では、キャッシュは「200 OK」応答についてのみ有効です。

目的の状態コードを空白で区切ったセットを定義してください。

重要な情報: 

- また、Ignore Origin No-Cache (配信元のキャッシュなしを無視する) 機能を有効にしてください。 この機能が有効でないと、「200 OK」以外の応答はキャッシュされない可能性があります。
- この機能について有効な状態コードのセットは、203、300、301、302、305、307、400、401、402、403、404、405、406、407、408、409、410、411、412、413、414、415、416、417、500、501、502、503、504、および 505 です。
- この機能を使用して、「200 OK」状態コードを生成する応答についてキャッシュを無効にすることはできません。

**既定の動作:** キャッシュは「200 OK」状態コードを生成する応答についてのみ有効です。
###<a name="stale-content-delivery-on-error"></a>Stale Content Delivery on Error (エラー時の古いコンテンツ配信)
**目的:** 

キャッシュ再検証中にエラーが発生したとき、または顧客の配信元サーバーから要求されたコンテンツを取得するとき、期限切れになったキャッシュ済みコンテンツを配信するかどうかを決定します。

値|結果
-|-
有効|配信元サーバーへの接続中にエラーが発生したときに、古いコンテンツが要求元に提供されます。
無効|配信元サーバーのエラーが要求元に転送されます。

**既定の動作:** Disabled

###<a name="stale-while-revalidate"></a>Stale While Revalidate (古いキャッシュを返し、同時に再検証)
**目的:** 再有効化の実行中に古いコンテンツを要求元に提供することをエッジ サーバーに許可することにより、パフォーマンスを改善します。

重要な情報: 

- この機能の動作は、選択した時間単位によって異なります。
    - **時間単位:** 古いコンテンツの配信を許可する期間を指定し、時間単位 (たとえば、秒、分、時間など) を選択します。 この種類の設定により、CDN は次の式に従って、有効化を要求する前にコンテンツを提供できる期間を拡張できます。**TTL** + **Stale While Revalidate Time** 
    - **Off:** "Off" を選択すると、古いコンテンツに関する要求を実行する前に再有効化が要求されます。
        - 期間は適用されず、無視されるため、指定しないでください。

**既定の動作:** Off。 要求されたコンテンツを提供する前に再有効化が実行される必要があります。

###<a name="comment"></a>コメント
**目的:** ルール内にメモを追加できるようにします。

この機能の用途の&1; つは、ルールの一般的な用途や、特定の一致条件や機能がルールに追加された理由に関する追加情報を提供することです。

重要な情報: 

- 最大で 150 文字を指定できます。
- 必ず英数字のみを使用してください。
- この機能は、ルールの動作には影響しません。 将来参照したりルールのトラブルシューティングを行う際に役立つ可能性のある情報の入力場所を提供するだけです。
 
## <a name="headers"></a>headers

以下の機能では、要求または応答のヘッダーを追加、修正、削除できます。

名前 | 目的
-----|--------
Age Response Header (Age 応答ヘッダー) | 要求元に送信する応答に Age 応答ヘッダーを追加するどうかを決定します。
Debug Cache Response Headers (キャッシュ応答ヘッダーのデバッグ) | 要求されたアセットのキャッシュ ポリシーに関する情報を提供する X-EC-Debug 応答ヘッダーを応答に追加できるかどうかを決定します。
Modify Client Request Header (クライアント要求ヘッダーの修正) | 要求のヘッダーを上書き、追加、削除します。
Modify Client Response Header (クライアント応答ヘッダーの修正) | 応答のヘッダーを上書き、追加、削除します。
Set Client IP Custom Header (クライアント IP カスタム ヘッダーの設定) | 要求側クライアントの IP アドレスをカスタム要求ヘッダーとして要求に追加することを許可します。

###<a name="age-response-header"></a>Age Response Header (Age 応答ヘッダー)
**目的**: 要求元に送信する応答に Age 応答ヘッダーを追加するどうかを決定します。
値|結果
--|--
有効 | 要求元に送信する応答に Age 応答ヘッダーが含められます。
無効 | 要求元に送信する応答から Age 応答ヘッダーが除外されます。

**既定の動作**: Disabled。

###<a name="debug-cache-response-headers"></a>Debug Cache Response Headers (キャッシュ応答ヘッダーのデバッグ)
**目的:** 要求された資産のキャッシュ ポリシーに関する情報を提供する X-EC-Debug 応答ヘッダーを応答に追加できるかどうかを決定します。

デバッグ キャッシュ応答ヘッダーは、次の両方に該当する場合に応答に含められます。

- Debug Cache Response Headers (キャッシュ応答ヘッダーのデバッグ) 機能が、目的の要求で有効になっています。
- 上の要求で、応答に含められるデバッグ キャッシュ応答ヘッダーのセットが定義されています。

デバッグ キャッシュ応答ヘッダーは、要求に次のヘッダーと目的のディレクティブを含めることによって要求できます。

X-EC-Debug: _Directive1_,_Directive2_,_DirectiveN_

**例:**

X-EC-Debug: x-ec-cache,x-ec-check-cacheable,x-ec-cache-key,x-ec-cache-state

値|結果
-|-
有効|デバッグ キャッシュ応答ヘッダーに関する要求で、X-EC-Debug ヘッダーを含む応答が返されます。
無効|X-EC-Debug 応答ヘッダーが応答から除外されます。

**既定の動作:** Disabled。

###<a name="modify-client-response-header"></a>Modify Client Response Header (クライアント応答ヘッダーの修正)
**目的:** 各要求には、その要求について説明する[要求ヘッダー]()のセットが含まれています。 この機能により、次のいずれかを実行できます。

- 要求ヘッダーに割り当てられた値を追加または上書きします。 指定された要求ヘッダーが存在しない場合、この機能はその要求ヘッダーを要求に追加します。
- 要求から要求ヘッダーを削除します。

配信元サーバーに転送される要求には、この機能によって行われた変更が反映されます。

要求ヘッダーには、次のアクションのいずれかを実行できます。

オプション|Description|例
-|-|-
追加|指定された値が、既存の要求ヘッダー値の末尾に追加されます。|**要求ヘッダー値 (クライアント):**Value1 <br/> **要求ヘッダー値 (HTTP ルール エンジン):** Value2 <br/>**新しい要求ヘッダー値:** Value1Value2
上書き|要求ヘッダー値が、指定された値に設定されます。|**要求ヘッダー値 (クライアント):**Value1 <br/>**要求ヘッダー値 (HTTP ルール エンジン):** Value2 <br/>**新しい要求ヘッダー値:** Value2 <br/>
削除|指定された要求ヘッダーを削除します。|**要求ヘッダー値 (クライアント):**Value1 <br/> **クライアント要求ヘッダー構成の変更:** 対象の要求ヘッダーを削除します。 <br/>**結果:** 指定された要求ヘッダーは、配信元サーバーに転送されません。

重要な情報: 

- [Name (名前)] オプションで指定されている値が目的の要求ヘッダーと正確に一致することを確認してください。
- ヘッダーを識別する際、大文字小文字は区別されません。 たとえば、Cache-Control ヘッダー名を識別する際は、次のバリエーションのいずれも使用できます。
    - cache-control
    - CACHE-CONTROL
    - cachE-Control
- ヘッダー名を指定する際は、英数字、ハイフン、またはアンダー スコアのみを使用してください。
- ヘッダーを削除すると、そのヘッダーがエッジ サーバーによって配信元サーバーに転送されなくなります。
- 次のヘッダーは予約済みであり、この機能で変更することはできません。
    - forwarded
    - host
    - via
    - 警告
    - x-forwarded-for
    - "x-ec" で始まるすべてのヘッダー名は予約済みです。

###<a name="modify-client-response-header"></a>Modify Client Response Header (クライアント応答ヘッダーの修正)
各応答には、その応答について説明する[応答ヘッダー]()のセットが含まれています。 この機能により、次のいずれかを実行できます。

- 応答ヘッダーに割り当てられた値を追加または上書きします。 指定された要求ヘッダーが存在しない場合、この機能はその要求ヘッダーを応答に追加します。
- 応答から応答ヘッダーを削除します。

既定では、応答ヘッダー値は配信元サーバーとエッジ サーバーによって定義されます。

応答ヘッダーには、次のアクションのいずれかを実行できます。

オプション|Description|例
-|-|-
追加|指定された値が、既存の要求ヘッダー値の末尾に追加されます。|**応答ヘッダー値 (クライアント):** Value1 <br/> **応答ヘッダー値 (HTTP ルール エンジン):** Value2 <br/>**新しい応答ヘッダー値:** Value1Value2
上書き|要求ヘッダー値が、指定された値に設定されます。|**応答ヘッダー値 (クライアント):** Value1 <br/>**応答ヘッダー値 (HTTP ルール エンジン):** Value2 <br/>**新しい応答ヘッダー値:** Value2 <br/>
削除|指定された要求ヘッダーを削除します。|**要求ヘッダー値 (クライアント):** Value1 <br/> **クライアント要求ヘッダーの構成の変更:** 対象の応答ヘッダーを削除します。 <br/>**結果:** 指定された応答ヘッダーは、要求元に転送されません。

重要な情報: 

- [Name (名前)] オプションで指定されている値が目的の応答ヘッダーと正確に一致することを確認してください。 
- ヘッダーを識別する際、大文字小文字は区別されません。 たとえば、Cache-Control ヘッダー名を識別する際は、次のバリエーションのいずれも使用できます。
    - cache-control
    - CACHE-CONTROL
    - cachE-Control
- ヘッダーを削除すると、そのヘッダーが要求元に転送されなくなります。
- 次のヘッダーは予約済みであり、この機能で変更することはできません。
    - accept-encoding
    - age
    - connection
    - content-encoding
    - content-length
    - content-range
    - date
    - server
    - trailer
    - transfer-encoding
    - upgrade
    - vary
    - via
    - 警告
    - "x-ec" で始まるすべてのヘッダー名は予約済みです。

###<a name="set-client-ip-custom-header"></a>Set Client IP Custom Header (クライアント IP カスタム ヘッダーの設定)
**目的:** IP アドレスによって要求元クライアントを識別するカスタム ヘッダーを要求に追加します。

[Header name (ヘッダー名)] オプションにより、クライアントの IP アドレスが格納されるカスタムの要求ヘッダーの名前が定義されます。

この機能により、顧客の配信元サーバーはカスタム要求ヘッダーを通じてクライアントの IP アドレスを知ることができます。 要求がキャッシュから提供された場合、配信元サーバーにクライアントの IP アドレスは通知されません。 したがって、ADN またはキャッシュされない資産ではこの機能を使用することをお勧めします。

指定されたヘッダーの名前が次のいずれとも一致しないことを確認してください。

- 標準的な要求ヘッダー名。 標準的なヘッダー名の一覧は [RFC 2616](http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html) に記載されています。
- 予約済みのヘッダー名:
    - forwarded-for
    - host
    - vary
    - via
    - 警告
    - x-forwarded-for
    - "x-ec" で始まるすべてのヘッダー名は予約済みです。
 
## <a name="logs"></a>ログ

以下の機能では、生ログ ファイルに保存されているデータをカスタマイズできます。

名前 | 目的
-----|--------
Custom Log Field 1 (カスタム ログ フィールド 1) | 生ログ ファイルのカスタム ログ フィールドに割り当てられる形式とコンテンツを決定します。
Log Query String (ログ クエリ文字列) | アクセス ログに URL と共にクエリ文字列を保存するかどうかを決定します。

###<a name="custom-log-field-1"></a>Custom Log Field 1 (カスタム ログ フィールド 1)
**目的:** 生ログ ファイルのカスタム ログ フィールドに割り当てられる形式とコンテンツを決定します。

このカスタム フィールドの主な目的は、ログ ファイルに保存される要求および応答ヘッダー値を決定できるようにすることです。

既定では、カスタム ログ フィールドは "x-ec_custom-1" という名前です。 ただし、このフィールドの名前は [[Raw Log Settings (生ログ設定)] ページ]()からカスタマイズできます。

要求および応答ヘッダーを指定する際に使用する必要がある書式を下に示します。

ヘッダーの種類|形式|例
-|-|-
要求ヘッダー|%{[RequestHeader]()}[i]() | %{Accept-Encoding}i <br/> {Referer}i <br/> %{Authorization}i
応答ヘッダー|%{[ResponseHeader]()}[o]()| %{Age}o <br/> %{Content-Type}o <br/> %{Cookie}o

重要な情報: 

- カスタム ログ フィールドには、ヘッダー フィールドとプレーン テキストの任意の組み合わせを含めることができます。
- このフィールドで有効な文字には、英数字 (つまり 0 ～ 9、a ～ z、A ～ Z)、ハイフン、コロン、セミコロン、アポストロフィ、コンマ、ピリオド、アンダー スコア、等号、かっこ、山かっこ、および空白が含まれます。 パーセント記号と中かっこは、ヘッダー フィールドを指定する際にのみ使用できます。
- 指定された各ヘッダー フィールドのスペルは、目的の要求/応答ヘッダー名と一致する必要があります。
- 複数のヘッダーを指定する場合は、区切り記号を使用して各ヘッダーを示すことをお勧めします。 たとえば、各ヘッダーの省略形を使用することもできます。 サンプル構文を以下に示します。
    - AE: %{Accept-Encoding}i A: %{Authorization}i CT: %{Content-Type}o 

**既定値:** -

###<a name="log-query-string"></a>Log Query String (ログ クエリ文字列)
**目的:** アクセス ログに URL と共にクエリ文字列を保存するかどうかを決定します。

値|結果
-|-
有効|アクセス ログで URL を記録するときにクエリ文字列を保存できるようにします。 URL にクエリ文字列が含まれていない場合、このオプションには効果がありません。
無効|既定の動作を復元します。 既定の動作では、アクセス ログで URL を記録する際にクエリ文字列を無視します。

**既定の動作:** Disabled。

<!---
## Optimize

These features determine whether a request will undergo the optimizations provided by Edge Optimizer.

Name | Purpose
-----|--------
Edge Optimizer | Determines whether Edge Optimizer can be applied to a request.
Edge Optimizer – Instantiate Configuration | Instantiates or activates the Edge Optimizer configuration associated with a site.

###Edge Optimizer
**Purpose:** Determines whether Edge Optimizer can be applied to a request.

If this feature has been enabled, then the following criteria must also be met before the request will be processed by Edge Optimizer:

- The requested content must use an edge CNAME URL.
- The edge CNAME referenced in the URL must correspond to a site whose configuration has been activated in a rule.

This feature requires the ADN platform and the Edge Optimizer feature.

Value|Result
-|-
Enabled|Indicates that the request is eligible for Edge Optimizer processing.
Disabled|Restores the default behavior. The default behavior is to deliver content over the ADN platform without any additional processing.

**Default Behavior:** Disabled
 

###Edge Optimizer - Instantiate Configuration
**Purpose:** Instantiates or activates the Edge Optimizer configuration associated with a site.

This feature requires the ADN platform and the Edge Optimizer feature.

Key information:

- Instantiation of a site configuration is required before requests to the corresponding edge CNAME can be processed by Edge Optimizer.
- This instantiation only needs to be performed a single time per site configuration. A site configuration that has been instantiated will remain in that state until the Edge Optimizer – Instantiate Configuration feature that references it is removed from the rule.
- The instantiation of a site configuration does not mean that all requests to the corresponding edge CNAME will automatically be processed by Edge Optimizer. The Edge Optimizer feature determines whether an individual request will be processed.

If the desired site does not appear in the list, then you should edit its configuration and verify that the Active option has been marked.

**Default Behavior:** Site configurations are inactive by default.
--->

## <a name="origin"></a>Origin (配信元)

以下の機能では、CDN が配信元サーバーと通信する方法を制御できます。

名前 | 目的
-----|--------
Maximum Keep-Alive Requests (最大キープアライブ要求) | キープアライブ接続の最大要求数を定義します。この数に達すると終了となります。
Proxy Special Headers (プロキシーの特殊ヘッダー) | エッジ サーバーから配信元サーバーに転送される CDN 固有要求ヘッダーを定義します。


###<a name="maximum-keep-alive-requests"></a>Maximum Keep-Alive Requests (最大キープアライブ要求)
**目的:** キープアライブ接続の最大要求数を定義します。この数に達すると終了となります。

要求の最大数を低い値に設定することは、パフォーマンスの低下につながる場合があるため、お勧めしません。

重要な情報: 

- この値は整数として指定します。
- 指定する値にコンマやピリオドは含めないでください。

**既定値:** 10,000 件の要求

###<a name="proxy-special-headers"></a>Proxy Special Headers (プロキシーの特殊ヘッダー)
**目的:** エッジ サーバーから配信元サーバーに転送される [CDN 固有要求ヘッダー]()を定義します。

重要な情報: 

- この機能で定義される各 CDN 固有要求ヘッダーは、配信元サーバーに転送されます。
- CDN 固有要求ヘッダーが配信元サーバーに転送されるのを防止するには、そのヘッダーをこの一覧から削除してください。

**既定の動作:** すべての [CDN 固有要求ヘッダー]()が配信元サーバーに転送されます。

## <a name="specialty"></a>Specialty (専門)

以下は、上級ユーザーのみご利用いただける高度な機能です。

名前 | 目的
-----|--------
Cacheable HTTP Methods (キャッシュ可能 HTTP メソッド) | ネットワークでキャッシュ可能な追加 HTTP メソッドのセットを決定します。
Cacheable Request Body Size (キャッシュ可能要求の本文サイズ) | POST 応答でキャッシュ可能かどうかを決定するしきい値を定義します。

###<a name="cacheable-http-methods"></a>Cacheable HTTP Methods (キャッシュ可能 HTTP メソッド)
**目的:** ネットワークでキャッシュ可能な追加 HTTP メソッドのセットを決定します。

重要な情報: 

- この機能では、GET 応答が常にキャッシュされると想定されています。 このため、この機能を設定する際に GET HTTP メソッドは含めないでください。
- この機能では POST HTTP メソッドのみがサポートされます。 POST 応答のキャッシュを有効にするには、この機能を POST に設定します 
- 既定では、本文が 14 Kb 未満の要求のみがキャッシュされます。 Cacheable Request Body Size (キャッシュ可能要求の本文サイズ) 機能を使用すると、最大の要求本文サイズを設定できます。

**既定の動作:** GET 応答のみがキャッシュされます。

###<a name="cacheable-request-body-size"></a>Cacheable Request Body Size (キャッシュ可能要求の本文サイズ)

**目的:** POST 応答がキャッシュ可能かどうかを決定するしきい値を定義します。

このしきい値は、最大の要求本文サイズを指定することによって決定されます。 これより大きい要求本文が含まれる要求はキャッシュされません。

重要な情報: 

- この機能が適用されるのは、POST 応答がキャッシュの対象になっている場合だけです。 POST 要求のキャッシュを有効にするには、Cacheable HTTP Methods (キャッシュ可能 HTTP メソッド) 機能を使用します。
- 要求本文は、次のものについて考慮されます。
    - x-www-form-urlencoded 値
    - 一意キャッシュキーの確認
- 最大の要求本文サイズを大きい値に定義すると、データ配信のパフォーマンスに影響する可能性があります。
    - **推奨される値:** 14 Kb
    - **最小値:** 1 Kb

**既定の動作:** 14 Kb
 
## <a name="url"></a>URL

以下の機能では、要求を別の URL にリダイレクトするか、書き換えることができます。

名前 | 目的
-----|--------
Follow Redirects (リダイレクトのフォロー) | 顧客の配信元サーバーから返される Location (場所) ヘッダーに定義されているホスト名に要求をリダイレクトできるかどうかを決定します。
URL Redirect (URL リダイレクト) | Location (場所) ヘッダー経由で要求をリダイレクトします。
URL Rewrite (URL 書き換え)  | 要求 URL を書き換えます。

###<a name="follow-redirects"></a>Follow Redirects (リダイレクトのフォロー)
**目的:** 顧客の配信元サーバーから返される Location (場所) ヘッダーに定義されているホスト名に要求をリダイレクトできるかどうかを決定します。

重要な情報: 

- 要求は、同じプラットフォームに対応するエッジ CNAME にのみリダイレクトできます。

値|結果
-|-
有効|要求をリダイレクトできます。
無効|要求はリダイレクトされません。

**既定の動作:** Disabled。
###<a name="url-redirect"></a>URL Redirect (URL リダイレクト)
**目的:** Location (場所) ヘッダー経由で要求をリダイレクトします。

この機能の構成では、次のオプションを設定する必要があります。

オプション|Description
-|-
コード|要求元に返される応答コードを選択します。
Source & Pattern (ソースとパターン)| これらの設定により、リダイレクトされる要求の種類を識別する要求 URI のパターンが定義されます。 URL が次の条件の両方を満たす要求だけがリダイレクトされます。 <br/> <br/> **ソース:** (またはコンテンツ アクセス ポイント) 配信元サーバーを識別する相対パスを選択します。 これは、"/XXXX/" セクションとエンドポイント名です。 <br/> **ソース (パターン):** 相対パスによって要求を識別するパターンを定義する必要があります。 この正規表現パターンでは、前に選択されていたコンテンツ アクセス ポイント (上記参照) の直後に始まるパスを定義する必要があります。 <br/> - 上で定義した要求 URI 条件 (つまり、[Source & Pattern (ソースとパターン)]) がこの機能について定義されている一致条件と競合しないことを確認してください。 <br/> - 必ずパターンを指定してください。 パターンとして空白の値を使用すると、選択した配信元サーバー (http://cdn.mydomain.com/ など) のルート フォルダーへの要求のみと一致します。
変換先| 上の要求がリダイレクトされる URL を定義します。 <br/> この URL は、次のものを使用して動的に作成します。 <br/> - 正規表現パターン <br/>- HTTP 変数 <br/> $_n_ を使用して、ソース パターンでキャプチャされた値を変換先パターンに置き換えます (_n_ はキャプチャされた順序で値を識別します)。 たとえば、$1 は、ソース パターンでキャプチャされた最初の値を表し、$2 は&2; 番目の値を表します。 <br/> 
絶対 URL を使用することを強くお勧めします。 相対 URL を使用すると、CDN の URL が無効なパスにリダイレクトされることがあります。

**サンプル シナリオ**

この例では、ベース CDN URL http://marketing.azureedge.net/brochures に解決されるエッジ CNAME URL をリダイレクトする方法について説明します

対象の要求は、ベース エッジ CNAME URL http://cdn.mydomain.com/resources にリダイレクトされます

この URL のリダイレクトは、次の構成によって達成できます。![](./media/cdn-rules-engine-reference/cdn-rules-engine-redirect.png)

**重要なポイント:**

- URL Redirect (URL リダイレクト) 機能では、リダイレクトされる要求 URL が定義されます。 このため、追加の一致条件は必要ありません。 一致条件を [Always (常に)] として定義しましたが、顧客の配信元 "marketing" にある "brochures" フォルダーを指定する要求だけがリダイレクトされます。 
- 一致するすべての要求は、[Destination (送信先)] オプションで定義されているエッジ CNAME URL にリダイレクトされます。 
    - サンプル シナリオ 1: 
        - サンプルの要求 (CDN URL): http://marketing.azureedge.net/brochures/widgets.pdf 
        - 要求 URL (リダイレクト後): http://cdn.mydomain.com/resources/widgets.pdf  
    - サンプル シナリオ 2: 
        - サンプルの要求 (エッジ CNAME URL): http://marketing.mydomain.com/brochures/widgets.pdf 
        - 要求 URL (リダイレクト後): http://cdn.mydomain.com/resources/widgets.pdf サンプル シナリオ
    - サンプル シナリオ 3: 
        - サンプルの要求 (エッジ CNAME URL): http://brochures.mydomain.com/campaignA/final/productC.ppt 
        - 要求 URL (リダイレクト後): http://cdn.mydomain.com/resources/campaignA/final/productC.ppt  
- [Destination (送信先)] オプションでは要求スキーム (%{scheme}) 変数を利用しました。 これにより、リダイレクト後に要求の構成が変更されないことが保証されます。
- 要求からキャプチャされた URL セグメントは、"$1" を使用して新しい URL に追加されます。
 
###<a name="url-rewrite"></a>URL Rewrite (URL 書き換え)
**目的:** 要求 URL を書き換えます。

重要な情報: 

- この機能の構成では、次のオプションを設定する必要があります。

オプション|説明
-|-
 Source & Pattern (ソースとパターン) | これらの設定により、書き換えられる要求の種類を識別する要求 URI のパターンが定義されます。 URL が次の条件の両方を満たす要求だけが書き換えられます。 <br/>     - **ソース (またはコンテンツ アクセス ポイント):** を配信元サーバーを識別する相対パスを選択します。 これは、"/XXXX/" セクションとエンドポイント名です。 <br/> - **ソース (パターン):** 相対パスによって要求を識別するパターンを定義する必要があります。 この正規表現パターンでは、前に選択されていたコンテンツ アクセス ポイント (上記参照) の直後に始まるパスを定義する必要があります。 <br/> 上で定義した要求 URI 条件 (つまり、[Source & Pattern (ソースとパターン)]) がこの機能について定義されている一致条件と競合しないことを確認してください。 必ずパターンを指定してください。 パターンとして空白の値を使用すると、選択した配信元サーバー (http://cdn.mydomain.com/ など) のルート フォルダーへの要求のみと一致します。 
 変換先  |上の要求の書き換えに使用する相対 URL を定義します。 <br/>    1.配信元サーバーを識別するコンテンツ アクセス ポイントを選択します。 <br/>    2.次のものを使用して相対パスを定義します。 <br/>        - 正規表現パターン <br/>        - HTTP 変数 <br/> <br/> $_n_ を使用して、ソース パターンでキャプチャされた値を変換先パターンに置き換えます (_n_ はキャプチャされた順序で値を識別します)。 たとえば、$1 は、ソース パターンでキャプチャされた最初の値を表し、$2 は&2; 番目の値を表します。 
 この機能により、エッジ サーバーは従来のリダイレクトを実行せずに URL を書き換えることができます。 つまり、要求元は、書き換え後の URL を要求した場合と同じ応答コードを受信します。

**ンプル シナリオ 1**

この例では、ベース CDN URL http://marketing.azureedge.net/brochures/ に解決されるエッジ CNAME URL をリダイレクトする方法について説明します

対象の要求は、ベース エッジ CNAME URL: http://MyOrigin.azureedge.net/resources/ にリダイレクトされます

この URL のリダイレクトは、次の構成によって達成できます。![](./media/cdn-rules-engine-reference/cdn-rules-engine-rewrite.png)

**サンプル シナリオ 2**

この例では、正規表現を使用して、エッジ CNAME URL を大文字から小文字にリダイレクトする方法について説明します。

この URL のリダイレクトは、次の構成によって達成できます。![](./media/cdn-rules-engine-reference/cdn-rules-engine-to-lowercase.png)


**重要なポイント:**

- URL Rewrite (URL 書き換え) 機能では、書き換えられる要求 URL が定義されます。 このため、追加の一致条件は必要ありません。 一致条件を [Always (常に)] として定義しましたが、顧客の配信元 "marketing" にある "brochures" フォルダーを指定する要求だけが書き換えられます。

- 要求からキャプチャされた URL セグメントは、"$1" を使用して新しい URL に追加されます。



###<a name="compatibility"></a>互換性

この機能には、要求に適用する前に満たす必要がある一致条件が含まれます。 競合する一致条件が設定されることのないよう、この機能は次の一致条件と互換性がありません。

- AS Number (AS 番号)
- CDN Origin (CDN 配信元)
- Client IP Address (現在の IP アドレス)
- Customer Origin (顧客配信元)
- Request Scheme (要求スキーム)
- URL Path Directory (URL パス ディレクトリ)
- URL Path Extension (URL パス拡張子)
- URL Path Filename (URL パス ファイル名)
- URL Path Literal (URL パス リテラル)
- URL Path Regex (URL パス正規表現)
- URL Path Wildcard (URL パス ワイルドカード)
- URL Query Literal (URL クエリ リテラル)
- URL Query Parameter (URL クエリ パラメーター)
- URL Query Regex (URL クエリ正規表現)
- URL Query Wildcard (URL クエリ ワイルドカード)


## <a name="next-steps"></a>次のステップ
* [ルール エンジンのリファレンス](cdn-rules-engine-reference.md)
* [ルール エンジンの条件式](cdn-rules-engine-reference-conditional-expressions.md)
* [ルール エンジンの一致条件](cdn-rules-engine-reference-match-conditions.md)
* [規則エンジンを使用した既定の HTTP 動作のオーバーライド](cdn-rules-engine.md)
* [Azure CDN の概要](cdn-overview.md)

