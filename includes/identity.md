ID の管理は、オンプレミスの場合と同様にパブリック クラウドでも重要です。 管理を行いやすくするため、Azure では、さまざまなクラウド ID テクノロジがサポートされています。 次のようなオプションがあります。

* Azure Virtual Machines で作成された仮想マシンを使用して、クラウドで Windows Server Active Directory (一般には単に AD と呼ばれます) を実行できます。 このアプローチは、Azure を使用してオンプレミスのデータセンターをクラウドに拡張する場合に効果的です。
* Azure Active Directory を使用すると、ユーザーが [サービスとしてのソフトウェア (SaaS)](https://azure.microsoft.com/overview/what-is-saas/) アプリケーションへのシングル サインオンを利用できるようになります。 たとえば、Microsoft Office 365 ではこのテクノロジが使用されており、Azure やその他のクラウド プラットフォームで実行されるアプリケーションでも使用できます。
* クラウドまたはオンプレミスで実行されるアプリケーションでは、Azure Active Directory Access Control を使用することで、ユーザーが Facebook、Google、マイクロソフト、および他の ID プロバイダーの ID を使用してログインできるようにすることができます。

この記事では、これらの 3 つのオプションすべてについて説明します。

## <a name="table-of-contents"></a>目次
* [VM での Windows Server Active Directory の実行](#adinvm)
* [Azure Active Directory の使用](#ad)
* [Azure Active Directory Access Control の使用](#ac)

## <a name="a-nameadinvmarunning-windows-server-active-directory-in-virtual-machines"></a><a name="adinvm"></a>VM での Windows Server Active Directory の実行
Azure Virtual Machines での Windows Server AD の実行は、オンプレミスでの実行と非常に似ています。 [図 1](#fig1) は、その典型的な例を示しています。

![Azure Active Directory in Virtual Machine](./media/identity/identity_01_ADinVM.png)

<a name="Fig1"></a>図 1: Windows Server Active Directory は、Azure Virtual Network を使用する組織のオンプレミス データセンターに接続された Azure Virtual Machines で実行できる

ここに示す例では、Windows Server AD が、Azure Virtual Machines (プラットフォームの IaaS テクノロジ) を使用して作成された VM で実行されています。 これらの VM と他のいくつかの VM は、Azure Virtual Network を使用するオンプレミスのデータセンターに接続された仮想ネットワークにグループ化されています。 仮想ネットワークは、仮想プライベート ネットワーク (VPN) 接続経由でオンプレミスのネットワークとやり取りするクラウド VM のグループを形成します。 こうすることで、これらの Azure Virtual Machines が、オンプレミスのデータセンターにとって別のサブセットと同じように見なされます。 図が示すように、これらの VM のうち 2 つは Windows Server AD ドメイン コントローラーを実行しています。 仮想ネットワーク内の他の VM は、SharePoint などのアプリケーションを実行したり、開発やテストなど、他の何らかの方法で使用されることがあります。 オンプレミスのデータセンターでは、2 つの Windows Server AD ドメイン コントローラーも実行されています。

クラウドのドメイン コントローラーとオンプレミスで実行されているドメイン コントローラーを接続する複数のオプションが用意されています。

* すべてのドメイン コントローラーを 1 つの Active Directory ドメインの一部とする。
* 同じフォレストの一部であるオンプレミスとクラウドに別箇の AD ドメインを作成する。
* クラウドとオンプレミスに別個の AD フォレストを作成した後、クロスフォレスト信頼または Windows Server Active Directory フェデレーション サービス (AD FS) (Azure の VM でも実行可能) を使用してフォレストを選択する。

どれを選択した場合も、管理者は、オンプレミスのユーザーからの認証要求が、必要なときだけクラウドのドメイン コントローラーに送信されるようにする必要があります。クラウドへのリンクがオンプレミスのネットワークより低速なことが多いためです。 クラウドとオンプレミスのドメイン コントローラーを接続する際に考慮すべき別の要素は、レプリケーションにより生成されるトラフィックです。 クラウドのドメイン コントローラーは、通常独自の AD サイトにあるため、管理者はレプリケーションの頻度をスケジュールできます。 Azure では、Azure データセンターから送信されるトラフィック (到着するバイトではなく) に課金されるため、管理者によるレプリケーションの選択に影響を与える可能性があります。 さらに、Azure では独自のドメイン ネーム システム (DNS) がサポートされますが、このサービスには Active Directory に必要な機能 (動的 DNS や SRV レコードなど) がない点に注目することも重要です。 このため、Azure で Windows Server AD を実行するには、クラウドで独自の DNS サーバーをセットアップする必要があります。

Azure VM で Windows Server AD を実行することは、いくつかの状況で効果的です。 次に例をいくつか示します。

* Azure Virtual Machines を独自のデータセンターの拡張として使用している場合、ローカルのドメイン コントローラーが Windows 統合認証や LDAP クエリなどを処理する必要があるアプリケーションをクラウドで実行することがあります。 たとえば、SharePoint は Active Directory と頻繁にやり取りするため、オンプレミスのディレクトリを使用して Azure で SharePoint ファームを実行することはできますが、クラウドでドメイン コントローラーをセットアップするとパフォーマンスが大幅に向上します (これは必ずしも必須ではない点を理解することは重要ですが、オンプレミスのドメイン コントローラーだけを使用して多数のアプリケーションをクラウドで正常に実行できます)。
* 遠隔地の支社には、独自のドメイン コントローラーを実行するリソースが足りないとします。 今、ユーザーが地球の反対側にあるドメイン コントローラーで認証を行う必要がありますが、ログインが低速です。 近くにあるマイクロソフトのデータセンターにある Azure で Active Directory を実行すると、支社のサーバーを増やさなくてもログインを高速化できます。
* 障害復旧に Azure を使用している組織は、アクティブな VM の小規模なセット (ドメイン コントローラーなど) をクラウドに保持していることがあります。 その場合、必要に応じてこのサイトを拡張し、他の場所で障害が発生したときに引き継ぎを行う準備を整えることができます。

他の可能性もあります。 たとえば、クラウドの Windows Server AD をオンプレミスのデータセンターに接続する必要がないとします。 特定のユーザー セットにサービスを提供する SharePoint ファームを実行する場合 (たとえば、すべてのユーザーがクラウド ベースの ID だけを使用してログインする場合など)、Azure にスタンドアロン フォレストを作成できます。 このテクノロジの利用方法は、目標が何であるかによって決まります  (Azure で Windows Server AD を使用する方法の詳細については、[こちらを参照](http://msdn.microsoft.com/library/windowsazure/jj156090.aspx)してください)。

## <a name="a-nameadausing-azure-active-directory"></a><a name="ad"></a>Azure Active Directory の使用
SaaS アプリケーションが一般的になるにつれて、素朴な疑問が生まれます。このようなクラウド ベースのアプリケーションではどの種類のディレクトリ サービスを使用すべきでしょうか。 この疑問に対するマイクロソフトの答えは、Azure Active Directory です。

このディレクトリ サービスをクラウドで使用するには、主な 2 つのオプションがあります。

* SaaS アプリケーションだけを使用する個人と組織は、唯一のディレクトリ サービスとして Azure Active Directory に依存することができます。
* Windows Server Active Directory を実行する組織は、オンプレミスのディレクトリを Azure Active Directory に接続した後、それを使用して SaaS アプリケーションへのシングル サインオンをユーザーに提供できます。

[図 2](#fig2) は、2 つのうちの最初のオプション (Azure Active Directory だけが必要) を示しています。

![Azure Active Directory in Virtual Machine](./media/identity/identity_02_AD.png)

<a name="fig2"></a>図 2: Azure Active Directory を使用すると、組織のユーザーが SaaS アプリケーション (Office 365 など) へのシングル サインオンを利用できるようになる

図が示すように、Azure AD はマルチテナント サービスです。 つまり、多くの組織を同時にサポートし、各組織のユーザーに関するディレクトリ情報を格納できます。 この例では、組織 A のユーザーが SaaS アプリケーションにアクセスしようとしています。 このアプリケーションは、Office 365 の一部 (SharePoint Online など) である場合も、それ以外のアプリケーションの場合もあります (マイクロソフト以外のアプリケーションでもこのテクノロジを使用できます)。 Azure AD では SAML 2.0 プロトコルがサポートされるため、アプリケーションに必要なのはこの業界標準を使用してやり取りできることだけです (実際、Azure AD を使用するアプリケーションは、Azure データセンターだけではなくどのデータセンターでも実行できます)。

ユーザーが SaaS アプリケーションにアクセスした時点でプロセスが開始されます (ステップ 1)。 このアプリケーションを使用するには、ユーザーが Azure AD により発行されたトークンを提示する必要があります。

このトークンには、ユーザーを識別する情報が含まれており、Azure AD によりデジタル署名されています。 トークンを入手するには、ユーザー名とパスワードを指定することにより、ユーザーが Azure AD で自分自身を認証します (ステップ 2)。 その後、Azure AD により必要なトークンが返されます (ステップ 3)。

次に、このトークンが SaaS アプリケーションに送信され (ステップ 4)、トークンの署名が検証されてその内容が使用されます (ステップ 5)。 通常、アプリケーションはトークンに含まれる ID 情報を使用して、ユーザーがアクセスできる情報を決定しますが、他の方法を使用することもあります。

アプリケーションが、トークンに含まれている情報以外にユーザーの情報を必要とする場合、Azure AD Graph API を使用して Azure AD から直接要求できます (ステップ 6)。 初期バージョンの Azure AD では、ディレクトリ スキーマがかなりシンプルです。ユーザーとグループ、およびそれらの間の関係だけが含まれています。 アプリケーションは、この情報を使用して、ユーザー間の関係を知ることができます。 たとえば、ユーザーがあるデータ チャンクへのアクセスを許可されているかどうかを判断するために、ユーザーのマネージャーがだれであるかをアプリケーションが知る必要があるとします。 これは、Graph API をとおして Azure AD にクエリを実行することで知ることができます。

Graph API は、通常の RESTful プロトコルを使用するため、モバイル デバイスを含むほとんどのクライアントから簡単に使用することができます。 この API では、OData により定義された拡張 (より簡単な方法でクライアントがデータにアクセスできるようにするクエリ言語などが追加されます) もサポートされます  (OData の詳細については、「[Introducing OData (OData の概要)](http://download.microsoft.com/download/E/5/A/E5A59052-EE48-4D64-897B-5F7C608165B8/IntroducingOData.pdf)」を参照してください)。Graph API を使用すると、ユーザー間の関係について知ることができ、アプリケーションは特定の組織の Azure AD スキーマに埋め込まれたソーシャル グラフを認識することができます (Graph API と呼ばれるのはこのためです)。 Azure AD で Graph API 要求を認証するため、アプリケーションは OAuth 2.0 を使用します。

組織が Windows Server Active Directory を使用しておらず (オンプレミスのサーバーやドメインがない)、Azure AD を使用するクラウド アプリケーションのみに依存している場合、このクラウド ディレクトリだけを使用すると、その会社のユーザーがすべてのアプリケーションでシングル サインオンを利用できるようになります。 このシナリオは日々一般的になっていますが、ほとんどの組織は依然として Windows Server Active Directory で作成されたオンプレミスのドメインを使用しています。 [図 3](#fig3) が示すように、Azure AD にはこの場合に役立つ重要な役割もあります。

![仮想マシンでの Azure Active Directory](./media/identity/identity_03_AD.png)
<a id="fig3"></a>図 3: 組織は、Windows Server Active Directory と Azure Active Directory をフェデレーションして、SaaS アプリケーションに対するユーザーのシングル サインオンを有効にできます。

このシナリオでは、組織 B のユーザーが SaaS アプリケーションにアクセスしようとしています。 アクセスする前に、組織のディレクトリ管理者は、AD FS を使用して Azure AD とのフェデレーション関係を確立する必要があります。 さらに、管理者は組織のオンプレミスの Windows Server AD と Azure AD の間にデータ同期を構成する必要もあります。 これにより、ユーザーとグループの情報が、オンプレミスのディレクトリから Azure AD に自動的にコピーされます。 これにより実現することに注目してみましょう。実際には、組織はオンプレミスのディレクトリをクラウドに拡張しようとしています。 Windows Server AD と Azure AD をこの方法で結合すると、組織は、単一のエンティティとして管理できるディレクトリ サービスを手に入れることができますが、引き続きオンプレミスとクラウドの両方を使用し続けることができます。

Azure AD を使用するには、まずユーザーが自身のオンプレミスの Active Directory ドメインに通常どおりログインします (ステップ 1)。 SaaS アプリケーションにアクセスしようとすると (ステップ 2)、フェデレーション処理の結果、Azure AD によりこのアプリケーションのトークンが発行されます (ステップ 3)  (フェデレーションのしくみの詳細については、「[Claims-Based Identity for Windows: Technologies and Scenarios (Windows のクレームベース ID: テクノロジとシナリオ)](http://www.davidchappell.com/writing/white_papers/Claims-Based_Identity_for_Windows_v3.0--Chappell.docx)」を参照してください)。前述のとおり、このトークンにはユーザーを識別する情報が含まれており、Azure AD によりデジタル署名されています。 次に、このトークンが SaaS アプリケーションに送信され (ステップ 4)、トークンの署名が検証されてその内容が使用されます (ステップ 5)。 前のシナリオと同様、SaaS アプリケーションは必要に応じて Graph API を使用してこのユーザーに関する詳細を知ることができます (ステップ 6)。

現在のところ、オンプレミスのWindows Server AD を Azure AD に完全に置き換えることはできません。 既に説明したとおり、クラウド ディレクトリのスキーマの方がかなりシンプルであり、グループ ポリシー、マシンに関する情報の格納機能、LDAP のサポートなどもありません(実際、ユーザーが Azure AD 以外を使用してログインできるように Windows マシンを構成することはできません。 (実際、ユーザーが Azure AD 以外を使用してログインできるように Windows マシンを構成することはできません。これは、サポートされるシナリオではありません)。むしろ、Azure AD の当初の目標は、エンタープライズ ユーザーが別個のログインを維持しなくてもクラウドのアプリケーションにアクセスできるようにすることと、オンプレミスのディレクトリ管理者が、オンプレミスのディレクトリと組織が使用する各 SaaS アプリケーションを手動で同期しなくてもよいようにすることです。 しかし、時間の経過と共に、このクラウド ディレクトリ サービスが広範なシナリオに対応することが期待されます。

## <a name="a-nameacausing-azure-active-directory-access-control"></a><a name="ac"></a>Azure Active Directory Access Control の使用
クラウド ベースの ID テクノロジを使用すると、さまざまな問題を解決できます。 たとえば、Azure Active Directory を使用すると、組織のユーザーが複数の SaaS アプリケーションへのシングル サインオンを利用できるようになります。 しかし、クラウドの ID テクノロジは他の方法でも使用できます。

たとえば、アプリケーションで、ユーザーが複数の *ID プロバイダー (IdP)*により発行されたトークンを使用してログインすると仮定します。 現在、Facebook、Google、マイクロソフトなど、さまざまな ID プロバイダーが存在しており、多くの場合、ユーザーはアプリケーションでこれらの ID のいずれかを使用してサインインできます。 既に存在する ID を使用できるのであれば、アプリケーションでユーザーとパスワードのリストを独自に維持する必要はありません。 既存の ID を受け入れると、ユーザーにとっては覚えるユーザー名とパスワードが 1 つ減り、アプリケーションの作成者にとってはユーザー名とパスワードのリストを独自に維持する必要がなくなるため、物事がシンプルになります。

しかし、どの ID プロバイダーも何らかのトークンを発行していますが、それらのトークンは標準ではありません。各 IdP が独自の形式を使用しています。 さらに、それらのトークンに含まれる情報も標準ではありません。 Facebook、Google、マイクロソフトなどによって発行されたトークンを受け入れようとするアプリケーションは、そのような異なる各形式に対応する独自のコードを記述するという課題に直面します。

しかし、これを回避する方法があります。 代わりに、共通の ID 情報表記法による、単一のトークン形式を生成できる中間機能を作成することができます。 このアプローチにより、1 種類のトークンだけに対応するだけで済み、アプリケーションを作成する開発者の業務がシンプルになります。 Azure Active Directory Access Control はまさにこの役割を果たし、クラウド内で多様なトークンを処理するための中間機能を提供します。 [図 4](#fig4) は、このしくみを示しています。

![仮想マシンでの Azure Active Directory](./media/identity/identity_04_IdentityProviders.png)
<a id="fig4"></a>図 4: Azure Active Directory Access Control では、さまざまな ID プロバイダーによって発行された ID トークンを、アプリケーションが簡単に受け入れられるようになります。

ユーザーがブラウザーからこのアプリケーションにアクセスしようとした時点でプロセスが開始されます。 アプリケーションはそのユーザーが選択した (かつアプリケーションも信頼する) IdP にユーザーをリダイレクトします。 ユーザー名とパスワードの入力などによって、ユーザーがこの IdP で認証されると (ステップ 1)、IdP はそのユーザーに関する情報が入ったトークンを返します (ステップ 2)。

図が示すように、Access Control では、Google、Yahoo、Facebook、マイクロソフト (旧 Windows Live ID)、OpenID プロバイダーによって作成されたアカウントなど、さまざまなクラウド ベースの IdP がサポートされます。 また、Azure Active Directory を使用して作成された ID や、AD FS、Windows Server Active Directory とのフェデレーションによって作成された ID もサポートされます。 目標は、IdP によりクラウドで発行されたかオンプレミスで発行されたかにかかわらず、現在最もよく使用されている ID に対応することです。

ユーザーが選択した IdP による IdP トークンがユーザーのブラウザーにあれば、このトークンが Access Control に送信されます (ステップ 3)。 Access Control はそのトークンを検証し、それが確かに対象の IdP によって発行されたものであることを確認した後、このアプリケーションに対して定義されているルールに従って新しいトークンを作成します。 Azure Active Directory と同様、Access Control はマルチテナント サービスですが、テナントは顧客組織ではなくアプリケーションです。 図が示すように、各アプリケーションは独自の名前空間を取得し、認証などに関するさまざまなルールを定義できます。

これらのルールを使用すると、各アプリケーションの管理者は、さまざまな IdP から発行されたトークンを Access Control トークンに変換するための方法を定義できます。 たとえば、ユーザー名を表記する形式が IdP によって異なる場合、Access Control ルールを使用してこれらすべてを共通のユーザー名形式に変換できます。 次に Access Control はこの新しいトークンをブラウザーに返し (ステップ 4)、ブラウザーがそれをアプリケーションに送信します (ステップ 5)。 アプリケーションはこの Access Control トークンを受け取ると、このトークンが確かに Access Control によって発行されたものであることを確認した後、トークンに格納されている情報を適用します (ステップ 6)。

このプロセスは少し複雑に見えますが、実はアプリケーションの作成者の負担を大幅に軽減します。 アプリケーションは、さまざまな情報が入った多様なトークンを扱うのではなく、使い慣れた情報を含むトークンを 1 つだけ受信することにより、複数の ID プロバイダーから発行された各種の ID を受け入れることができます。 さらに、信頼するさまざまな IdP をアプリケーションごとに設定しなくても、これらの信頼関係が Access Control によって維持されるので、アプリケーションはそれを信頼するだけです。

Access Control は決して、Windows に拘束されているわけではなく、Google および Facebook の ID だけを受け入れる Linux アプリケーションでも同様に利用できます。 Access Control は Azure Active Directory ファミリの一部ですが、前のセクションで説明したものとは完全に別のサービスと考えることができます。 どちらのテクノロジも ID を扱いますが、まったく異なる問題に対処します (ただし、マイクロソフトではこれら 2 つのテクノロジがある時点で統合される予定であると発表しています)。

ID の処理は、ほとんどすべてのアプリケーションにとって重要な機能です。 Access Control の目的は、多様な ID プロバイダーによって発行された ID を受け入れる、アプリケーションを開発者がより簡単に作成できるようにすることです。 マイクロソフトはこのサービスをクラウドに実装することにより、あらゆるプラットフォーム上で実行される任意のアプリケーションから、このサービスを利用できるようにしています。

## <a name="about-the-author"></a>著者について
David Chappell は、カリフォルニア州サンフランシスコに拠点を置く Chappell & Associates [www.davidchappell.com](http://www.davidchappell.com) の社長です。



<!--HONumber=Nov16_HO3-->


